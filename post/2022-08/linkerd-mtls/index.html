<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Using mTLS in Linkerd to protect application communications - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use mTLS in Linkerd to protect application communications." /><meta name="keywords" content="Linkerd, mTLS" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/linkerd-mtls/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Using mTLS in Linkerd to protect application communications" />
<meta property="og:description" content="Learn how to use mTLS in Linkerd to protect application communications." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/linkerd-mtls/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-31T13:29:30+08:00" />
<meta property="article:modified_time" content="2022-08-31T13:29:30+08:00" />

<meta itemprop="name" content="Using mTLS in Linkerd to protect application communications">
<meta itemprop="description" content="Learn how to use mTLS in Linkerd to protect application communications."><meta itemprop="datePublished" content="2022-08-31T13:29:30+08:00" />
<meta itemprop="dateModified" content="2022-08-31T13:29:30+08:00" />
<meta itemprop="wordCount" content="2547">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using mTLS in Linkerd to protect application communications"/>
<meta name="twitter:description" content="Learn how to use mTLS in Linkerd to protect application communications."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Using mTLS in Linkerd to protect application communications</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-31 13:29:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2547 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-mtls">What is mTLS</a></li>
        <li><a href="#mtls-with-linkerd">mTLS with Linkerd</a></li>
        <li><a href="#linkerd-identity-component">Linkerd Identity component</a></li>
        <li><a href="#how-the-linkerd-proxy-obtains-a-certificate">How the Linkerd proxy obtains a certificate</a></li>
        <li><a href="#automatic-rotation-of-controller-plane-tls-credentials">Automatic Rotation of Controller Plane TLS Credentials</a>
          <ul>
            <li><a href="#cert-manager">Cert-manager</a></li>
            <li><a href="#issuing-a-certificate">Issuing a certificate</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Security is a top priority for cloud-native applications, and while security is a very broad topic, Linkerd still has an important role to play: its two-way TLS (mTLS) feature is designed to enable a zero-trust approach to security in Kubernetes. Zero-trust security is an IT security model that requires strict authentication for every person and every device that attempts to access resources on a private network, whether located inside or outside the network boundary.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/31/ced78a61d7634daaa773e44ee50548c2.png" alt="mTLS"></p>
<h2 id="what-is-mtls">What is mTLS</h2>
<p>An increasingly common approach to communications security in cloud environments is the <strong>Zero Trust</strong> approach, and while a comprehensive treatment of zero trust security is beyond the scope of this section, the core goal is to reduce the application&rsquo;s security perimeter to the smallest possible level. For example, instead of putting firewalls around the data center to secure incoming traffic, leaving a &ldquo;soft interior&rdquo; without further authentication, each application in the data center can enforce security at its own boundary. This zero-trust approach is a natural fit for cloud environments where the underlying hardware and network infrastructure is not under your control.</p>
<p>The Linkerd security model enables zero-trust security by providing transparent, two-way TLS communication between services. Two-way TLS (mTLS) is a form of transport security that provides confidentiality and authentication of communications. In other words, not only are communications encrypted, but identities are also authenticated on both ends of the connection (the <strong>bidirectional</strong> component of mTLS differs from the TLS used by browsers in that it only authenticates the server side of the connection. mTLS authenticates both the client and the server). Linkerd&rsquo;s goal is to authenticate and encryption, allowing you to adopt a zero-trust approach to Kubernetes clusters.</p>
<p>Authentication is especially important, and while most people think the value of TLS is in encryption, it is equally important to verify the identity of the entities on both sides of the connection. After all, encryption is only useful if you can trust that the entity on the other side of the communication with you is who they say they are - an encrypted message from a bad actor is still a message from a bad actor.</p>
<p>In Linkerd, identities authenticated by mTLS are associated with Kubernetes ServiceAccounts. This means that Linkerd&rsquo;s mTLS identity system uses the exact same model that Kubernetes uses to establish identity and access control for workloads on a cluster, rather than inventing a new framework.</p>
<h2 id="mtls-with-linkerd">mTLS with Linkerd</h2>
<p>One of Linkerd&rsquo;s design principles is that <strong>complexity is the enemy of security</strong>. The harder it is to configure something, the less likely you are to use it; the more options and settings you have, the more likely you are to accidentally configure it in an insecure way.</p>
<p>By default, Linkerd enables mTLS for all <code>pod-to-pod</code> communication in the grid, and as long as both sides inject a data plane proxy, congratulations: you&rsquo;ve already authenticated encrypted mTLS between services. but we didn&rsquo;t realize it.</p>
<p>There are a few things to keep in mind about Linkerd&rsquo;s ability to automatically add mTLS.</p>
<ul>
<li>
<p>Both endpoints must be in the grid. linkerd needs to handle both client-side and server-side connections to work its mTLS magic.</p>
</li>
<li>
<p>In Linkerd 2.8.1 and earlier, Linkerd could only add mTLS to HTTP and gRPC traffic, and even then it could not perform this operation for certain types of permissions, hosts, or Headers; these restrictions have been removed in Linkerd 2.9, which adds mTLS to all TCP traffic, regardless of the protocol.</p>
</li>
<li>
<p>Connections where the client initiates TLS cannot be mTLSed by Linkerd. instead, Linkerd will treat these connections as TCP traffic. Note that this also means that Linkerd can only provide TCP-level metrics for these connections.</p>
</li>
</ul>
<p>Next let&rsquo;s understand how mTLS works and how to verify that our connection does indeed have mTLS.</p>
<h2 id="linkerd-identity-component">Linkerd Identity component</h2>
<p>The <code>Identity</code> component of the Linkerd control plane was discussed earlier. It plays the role of a CA or Certificate Authority. A Certificate Authority is the entity that issues digital certificates and makes the Identity component the issuer of digital certificates.</p>
<p>Linkerd uses the same &ldquo;type&rdquo; of certificate as the TLS certificate used by the website to authenticate its identity. Unlike websites, these certificates are not validated by third-party entities such as <code>Verisign</code>, as they do not require authentication, and <strong>they are only used by Linkerd agents within a cluster</strong>.</p>
<p>Linkerd&rsquo;s CA (Identity service) is deployed to the cluster as part of the Linkerd control plane. During this deployment, the Linkerd CLI generates a certificate and stores it in a Kubernetes Secret named <code>linkerd-identity-token-XXXXX</code> in the Linkerd namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get secret -n linkerd
</span></span><span class="line"><span class="cl">NAME                                 TYPE                                  DATA   AGE
</span></span><span class="line"><span class="cl">linkerd-identity-issuer              Opaque                                <span class="m">2</span>      11d
</span></span><span class="line"><span class="cl">linkerd-identity-token-nqhbk         kubernetes.io/service-account-token   <span class="m">3</span>      11d
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>By looking at the Secret, we can see a Secret object prefixed with <code>linkerd-identity-token-</code>, which we can export for viewing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get secret -n linkerd linkerd-identity-token-nqhbk -o yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  ca.crt: &lt;ca.crt&gt;
</span></span><span class="line"><span class="cl">  namespace: <span class="nv">bGlua2VyZA</span><span class="o">==</span>
</span></span><span class="line"><span class="cl">  token: &lt;token&gt;
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    kubernetes.io/service-account.name: linkerd-identity
</span></span><span class="line"><span class="cl">    kubernetes.io/service-account.uid: cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907
</span></span><span class="line"><span class="cl">  name: linkerd-identity-token-nqhbk
</span></span><span class="line"><span class="cl">  namespace: linkerd
</span></span><span class="line"><span class="cl">type: kubernetes.io/service-account-token
</span></span></code></pre></td></tr></table>
</div>
</div><p>The field named <code>ca.crt</code> in the data section of the output is the UTF-8 encoded root certificate generated during the Linkerd installation. This certificate is called the &ldquo;trust anchor&rdquo; because it is used as the basis for all certificates issued to the proxy.</p>
<p>The trust anchor is also used to create another certificate and key pair at installation time: the issuer credentials, which are stored in a separate Kubernetes Secret called <code>linkerd-identity-issuer</code>. The issuer credentials are used to issue certificates to the Linkerd proxy, and we can also view the data for that Secret.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get secret -n linkerd linkerd-identity-issuer -o yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  crt.pem: &lt;crt.pem&gt;
</span></span><span class="line"><span class="cl">  key.pem: &lt;key.pem&gt;
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    linkerd.io/control-plane-component: identity
</span></span><span class="line"><span class="cl">    linkerd.io/control-plane-ns: linkerd
</span></span><span class="line"><span class="cl">  name: linkerd-identity-issuer
</span></span><span class="line"><span class="cl">  namespace: linkerd
</span></span><span class="line"><span class="cl">type: Opaque
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next we will learn how to use these keys to issue certificates to the proxy to enable mTLS.</p>
<h2 id="how-the-linkerd-proxy-obtains-a-certificate">How the Linkerd proxy obtains a certificate</h2>
<p>First, when a Pod is injected into the Linkerd agent, the agent sends a certificate signing request (CSR) to Linkerd&rsquo;s identity service. The identity service issues a signed certificate to the agent using the issuer credentials (the scope of the CSR is the Kubernetes ServiceAccount where the Pod is running, so the generated certificate is associated with that ServiceAccount), and the certificate expires after 24 hours. Before the certificate expires, the agent sends a new certificate signing request to the identity service to obtain a new certificate; this process continues throughout the life of the Linkerd agent and is called <strong>Certificate Rotation</strong>, an automated way to minimize the damage caused by compromised certificates: <strong>in the worst case, any compromised certificate can only be used for 24 hours</strong>.</p>
<p>The <code>-linkerd check</code> command has a simple way to ensure that the proxies all have certificates issued by the identity service, and we can check the status of the proxies ourselves by passing the <code>--proxy</code> flag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd check --proxy
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">linkerd-identity
</span></span><span class="line"><span class="cl">----------------
</span></span><span class="line"><span class="cl">√ certificate config is valid
</span></span><span class="line"><span class="cl">√ trust anchors are using supported crypto algorithm
</span></span><span class="line"><span class="cl">√ trust anchors are within their validity period
</span></span><span class="line"><span class="cl">√ trust anchors are valid <span class="k">for</span> at least <span class="m">60</span> days
</span></span><span class="line"><span class="cl">√ issuer cert is using supported crypto algorithm
</span></span><span class="line"><span class="cl">√ issuer cert is within its validity period
</span></span><span class="line"><span class="cl">√ issuer cert is valid <span class="k">for</span> at least <span class="m">60</span> days
</span></span><span class="line"><span class="cl">√ issuer cert is issued by the trust anchor
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">linkerd-identity-data-plane
</span></span><span class="line"><span class="cl">---------------------------
</span></span><span class="line"><span class="cl">√ data plane proxies certificate match CA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status check results are √
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above output includes a <code>linkerd-identity-data-plane</code> section to indicate whether the proxy is using a certificate issued by a trust anchor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">linkerd-identity-data-plane
</span></span><span class="line"><span class="cl">---------------------------
</span></span><span class="line"><span class="cl">√ data plane proxies certificate match CA
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can also enable debug mode in the Linkerd agent and identity service to see the agent send the CSR to the identity service and retrieve the certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get deploy -n linkerd
</span></span><span class="line"><span class="cl">NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">linkerd-destination      1/1     <span class="m">1</span>            <span class="m">1</span>           11d
</span></span><span class="line"><span class="cl">linkerd-identity         1/1     <span class="m">1</span>            <span class="m">1</span>           11d
</span></span><span class="line"><span class="cl">linkerd-proxy-injector   1/1     <span class="m">1</span>            <span class="m">1</span>           11d
</span></span><span class="line"><span class="cl">$ kubectl edit deploy linkerd-identity -n linkerd
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">  spec:
</span></span><span class="line"><span class="cl">    containers:
</span></span><span class="line"><span class="cl">    - args:
</span></span><span class="line"><span class="cl">      - identity
</span></span><span class="line"><span class="cl">      - -log-level<span class="o">=</span>debug  <span class="c1"># debug </span>
</span></span><span class="line"><span class="cl">      - -log-format<span class="o">=</span>plain
</span></span><span class="line"><span class="cl">      - -controller-namespace<span class="o">=</span>linkerd
</span></span><span class="line"><span class="cl">      - -identity-trust-domain<span class="o">=</span>cluster.local
</span></span><span class="line"><span class="cl">      - -identity-issuance-lifetime<span class="o">=</span>24h0m0s
</span></span><span class="line"><span class="cl">      - -identity-clock-skew-allowance<span class="o">=</span>20s
</span></span><span class="line"><span class="cl">      - -identity-scheme<span class="o">=</span>linkerd.io/tls
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the identity service is re-updated, we can observe the log information of the corresponding Pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl logs -f -n linkerd deploy/linkerd-identity -c identity
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command outputs a lot of logs to the console. In the Linkerd identity log output, we can see the output related to <code>Request Body</code> and <code>Response Body</code>, which includes a long UTF-8 encoded data, i.e. <code>CSR</code> and the certificate issued to the proxy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl"><span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-08-30T07:39:17Z&#34;</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Issuer has been updated&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-08-30T07:39:17Z&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;starting admin server on :9990&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-08-30T07:39:17Z&#34;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;starting gRPC server on :8080&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">time</span><span class="o">=</span><span class="s2">&#34;2022-08-30T07:39:17Z&#34;</span> <span class="nv">level</span><span class="o">=</span>debug <span class="nv">msg</span><span class="o">=</span><span class="s2">&#34;Validating token for linkerd-identity.linkerd.serviceaccount.identity.linkerd.cluster.local&#34;</span>
</span></span><span class="line"><span class="cl">I0830 07:39:17.291787       <span class="m">1</span> request.go:1123<span class="o">]</span> Request Body: <span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;TokenReview&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;authentication.k8s.io/v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;creationTimestamp&#34;</span>:null<span class="o">}</span>,<span class="s2">&#34;spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;token&#34;</span>:<span class="s2">&#34;&lt;......&gt;&#34;</span><span class="o">}</span>,<span class="s2">&#34;status&#34;</span>:<span class="o">{</span><span class="s2">&#34;user&#34;</span>:<span class="o">{}}}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">I0830 07:39:17.291969       <span class="m">1</span> round_trippers.go:435<span class="o">]</span> curl -k -v -XPOST  -H <span class="s2">&#34;Accept: application/json, */*&#34;</span> -H <span class="s2">&#34;Content-Type: application/json&#34;</span> -H <span class="s2">&#34;User-Agent: controller/v0.0.0 (linux/amd64) kubernetes/</span><span class="nv">$Format</span><span class="s2">&#34;</span> -H <span class="s2">&#34;Authorization: Bearer &lt;masked&gt;&#34;</span> <span class="s1">&#39;https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews&#39;</span>
</span></span><span class="line"><span class="cl">I0830 07:39:17.293883       <span class="m">1</span> round_trippers.go:454<span class="o">]</span> POST https://10.96.0.1:443/apis/authentication.k8s.io/v1/tokenreviews <span class="m">201</span> Created in <span class="m">1</span> milliseconds
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">I0830 07:39:17.294241       <span class="m">1</span> request.go:1123<span class="o">]</span> Response Body: <span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;TokenReview&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;authentication.k8s.io/v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;creationTimestamp&#34;</span>:null,<span class="s2">&#34;managedFields&#34;</span>:<span class="o">[{</span><span class="s2">&#34;manager&#34;</span>:<span class="s2">&#34;controller&#34;</span>,<span class="s2">&#34;operation&#34;</span>:<span class="s2">&#34;Update&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;authentication.k8s.io/v1&#34;</span>,<span class="s2">&#34;time&#34;</span>:<span class="s2">&#34;2022-08-30T07:39:17Z&#34;</span>,<span class="s2">&#34;fieldsType&#34;</span>:<span class="s2">&#34;FieldsV1&#34;</span>,<span class="s2">&#34;fieldsV1&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;f:token&#34;</span>:<span class="o">{}}}}]}</span>,<span class="s2">&#34;spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;token&#34;</span>:<span class="s2">&#34;&lt;token&gt;&#34;</span><span class="o">}</span>,<span class="s2">&#34;status&#34;</span>:<span class="o">{</span><span class="s2">&#34;authenticated&#34;</span>:true,<span class="s2">&#34;user&#34;</span>:<span class="o">{</span><span class="s2">&#34;username&#34;</span>:<span class="s2">&#34;system:serviceaccount:linkerd:linkerd-identity&#34;</span>,<span class="s2">&#34;uid&#34;</span>:<span class="s2">&#34;cdc3d8fd-0e02-4b17-88ce-d2cc0a9e4907&#34;</span>,<span class="s2">&#34;groups&#34;</span>:<span class="o">[</span><span class="s2">&#34;system:serviceaccounts&#34;</span>,<span class="s2">&#34;system:serviceaccounts:linkerd&#34;</span>,<span class="s2">&#34;system:authenticated&#34;</span><span class="o">]</span>,<span class="s2">&#34;extra&#34;</span>:<span class="o">{</span><span class="s2">&#34;authentication.kubernetes.io/pod-name&#34;</span>:<span class="o">[</span><span class="s2">&#34;linkerd-identity-5d9b874d66-m77ps&#34;</span><span class="o">]</span>,<span class="s2">&#34;authentication.kubernetes.io/pod-uid&#34;</span>:<span class="o">[</span><span class="s2">&#34;2f147d37-1616-487a-b7aa-1805b84c026a&#34;</span><span class="o">]}}</span>,<span class="s2">&#34;audiences&#34;</span>:<span class="o">[</span><span class="s2">&#34;https://kubernetes.default.svc.cluster.local&#34;</span><span class="o">]}}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, let&rsquo;s take a look at the security between the <code>Emojivoto</code> application services. First, we can use the <code>linkerd viz edges</code> command to see how Pods are connected to each other.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz edges po -n emojivoto
</span></span><span class="line"><span class="cl">SRC                           DST                         SRC_NS        DST_NS      SECURED
</span></span><span class="line"><span class="cl">vote-bot-6d7677bb68-jvxsg     web-5f86686c4d-58p7k        emojivoto     emojivoto   √
</span></span><span class="line"><span class="cl">web-5f86686c4d-58p7k          emoji-696d9d8f95-5vn9w      emojivoto     emojivoto   √
</span></span><span class="line"><span class="cl">web-5f86686c4d-58p7k          voting-ff4c54b8d-xhjv7      emojivoto     emojivoto   √
</span></span><span class="line"><span class="cl">prometheus-7bbc4d8c5b-5rc8r   emoji-696d9d8f95-5vn9w      linkerd-viz   emojivoto   √
</span></span><span class="line"><span class="cl">prometheus-7bbc4d8c5b-5rc8r   vote-bot-6d7677bb68-jvxsg   linkerd-viz   emojivoto   √
</span></span><span class="line"><span class="cl">prometheus-7bbc4d8c5b-5rc8r   voting-ff4c54b8d-xhjv7      linkerd-viz   emojivoto   √
</span></span><span class="line"><span class="cl">prometheus-7bbc4d8c5b-5rc8r   web-5f86686c4d-58p7k        linkerd-viz   emojivoto   √
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that the output above contains a column <code>SECURED</code> at the end, indicating whether it is a secure connection or not, and the following values are all <code>√</code>, indicating a secure connection.</p>
<p>We then use the <code>linkerd viz tap</code> command again to capture the live traffic, and the output also contains a tag value of <code>tls=true</code>, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz tap deploy web -n emojivoto
</span></span><span class="line"><span class="cl">req <span class="nv">id</span><span class="o">=</span>0:0 <span class="nv">proxy</span><span class="o">=</span>in  <span class="nv">src</span><span class="o">=</span>10.244.1.165:47130 <span class="nv">dst</span><span class="o">=</span>10.244.1.176:8080 <span class="nv">tls</span><span class="o">=</span><span class="nb">true</span> :method<span class="o">=</span>GET :authority<span class="o">=</span>web-svc.emojivoto:80 :path<span class="o">=</span>/api/list
</span></span><span class="line"><span class="cl">req <span class="nv">id</span><span class="o">=</span>0:1 <span class="nv">proxy</span><span class="o">=</span>out <span class="nv">src</span><span class="o">=</span>10.244.1.176:42096 <span class="nv">dst</span><span class="o">=</span>10.244.1.188:8080 <span class="nv">tls</span><span class="o">=</span><span class="nb">true</span> :method<span class="o">=</span>POST :authority<span class="o">=</span>emoji-svc.emojivoto:8080 :path<span class="o">=</span>/emojivoto.v1.EmojiService/ListAll
</span></span><span class="line"><span class="cl">rsp <span class="nv">id</span><span class="o">=</span>0:1 <span class="nv">proxy</span><span class="o">=</span>out <span class="nv">src</span><span class="o">=</span>10.244.1.176:42096 <span class="nv">dst</span><span class="o">=</span>10.244.1.188:8080 <span class="nv">tls</span><span class="o">=</span><span class="nb">true</span> :status<span class="o">=</span><span class="m">200</span> <span class="nv">latency</span><span class="o">=</span>2731µs
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point we understand how Linkerd&rsquo;s Identity component issues certificates to Linkerd proxies in the data plane, and how Linkerd&rsquo;s mTLS implementation in the proxy uses these certificates to encrypt communication and authenticate both parties.</p>
<h2 id="automatic-rotation-of-controller-plane-tls-credentials">Automatic Rotation of Controller Plane TLS Credentials</h2>
<p>Linkerd&rsquo;s automatic mTLS feature uses a set of TLS credentials to generate TLS certificates for the agent: a trust anchor, issuer certificate, and private key. While Linkerd automatically rotates TLS certificates for data plane agents every 24 hours, it does not rotate the TLS credentials used to issue these certificates. Next, let&rsquo;s learn how to use <code>Cert-manager</code> to automatically rotate issuer certificates and private keys.</p>
<h3 id="cert-manager">Cert-manager</h3>
<p><code>Cert-manager</code> is a very popular cloud-native certificate management tool. <code>Cert-manager</code> adds certificates and certificate authorities to Kubernetes clusters as CRD resource types, simplifying the process of obtaining, renewing, and using these certificates. It can issue certificates from a variety of supported sources, including <code>Let's Encrypt</code>, <code>HashiCorp Vault</code>, and <code>Venafi</code>, as well as private PKI&rsquo;s. It will ensure that certificates are valid and up-to-date, and attempt to update them at the configured time before they expire.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/31/383808706aa24f04968b624f491a6ba0.png" alt="Cert-manager"></p>
<p>The installation of <code>Cert-manager</code> is also very simple and can be done in one click directly using the official resource list file provided as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>By default, related resources are installed into a namespace named <code>cert-manager</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n cert-manager
</span></span><span class="line"><span class="cl">NAME                                      READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">cert-manager-55649d64b4-kdcfk             1/1     Running   <span class="m">0</span>          43s
</span></span><span class="line"><span class="cl">cert-manager-cainjector-666db4777-cp2dn   1/1     Running   <span class="m">0</span>          43s
</span></span><span class="line"><span class="cl">cert-manager-webhook-6466bc8f4-5lvw5      1/1     Running   <span class="m">0</span>          43s
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="issuing-a-certificate">Issuing a certificate</h3>
<p>Next we use the <code>step</code> tool to create a signed key pair and store it in a Secret object in Kubernetes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ step certificate create root.linkerd.cluster.local ca.crt ca.key <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --profile root-ca --no-password --insecure
</span></span><span class="line"><span class="cl">Your certificate has been saved in ca.crt.
</span></span><span class="line"><span class="cl">Your private key has been saved in ca.key.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then save the generated <code>ca.crt</code> and <code>ca.key</code> to the Secret object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl create secret tls linkerd-trust-anchor --cert<span class="o">=</span>ca.crt --key<span class="o">=</span>ca.key -n
</span></span><span class="line"><span class="cl">secret/linkerd-trust-anchor created
</span></span></code></pre></td></tr></table>
</div>
</div><p>With Secret, we can create an <code>Issuer</code> resource that references the key&rsquo;s certificate authority.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: cert-manager.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Issuer
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: linkerd-trust-anchor
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: linkerd
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  ca:
</span></span></span><span class="line"><span class="cl"><span class="s">    secretName: linkerd-trust-anchor
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ kubectl get issuer -n linkerd
</span></span><span class="line"><span class="cl">NAME                   READY   AGE
</span></span><span class="line"><span class="cl">linkerd-trust-anchor   True    84s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we can issue certificates and write them to a Secret object. Finally, we can create a cert-manager &ldquo;Certificate&rdquo; resource that uses this Issuer to generate the required certificates.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: cert-manager.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Certificate
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: linkerd-identity-issuer
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: linkerd
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  secretName: linkerd-identity-issuer
</span></span></span><span class="line"><span class="cl"><span class="s">  duration: 48h
</span></span></span><span class="line"><span class="cl"><span class="s">  renewBefore: 25h
</span></span></span><span class="line"><span class="cl"><span class="s">  issuerRef:
</span></span></span><span class="line"><span class="cl"><span class="s">    name: linkerd-trust-anchor
</span></span></span><span class="line"><span class="cl"><span class="s">    kind: Issuer
</span></span></span><span class="line"><span class="cl"><span class="s">  commonName: identity.linkerd.cluster.local
</span></span></span><span class="line"><span class="cl"><span class="s">  dnsNames:
</span></span></span><span class="line"><span class="cl"><span class="s">  - identity.linkerd.cluster.local
</span></span></span><span class="line"><span class="cl"><span class="s">  isCA: true
</span></span></span><span class="line"><span class="cl"><span class="s">  privateKey:
</span></span></span><span class="line"><span class="cl"><span class="s">    algorithm: ECDSA
</span></span></span><span class="line"><span class="cl"><span class="s">  usages:
</span></span></span><span class="line"><span class="cl"><span class="s">  - cert sign
</span></span></span><span class="line"><span class="cl"><span class="s">  - crl sign
</span></span></span><span class="line"><span class="cl"><span class="s">  - server auth
</span></span></span><span class="line"><span class="cl"><span class="s">  - client auth
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">$ kubectl get certificate -n linkerd
</span></span><span class="line"><span class="cl">NAME                      READY   SECRET                    AGE
</span></span><span class="line"><span class="cl">linkerd-identity-issuer   True    linkerd-identity-issuer   17s
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the resource manifest file above, <code>duration</code> instructs cert-manager to treat the certificate as valid for 48 hours, while <code>renewBefore</code> instructs cert-manager to attempt to issue a new certificate 25 hours before the current certificate expires.</p>
<p>At this point, cert-manager can now use this certificate resource to obtain TLS credentials, which will be stored in a Secret named <code>linkerd-identity-issuer</code>. To verify your newly issued certificate, we can run the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">$ kubectl get secret linkerd-identity-issuer -o yaml -n linkerd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ca.crt</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;ca.crt&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">crt.pem</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;crt.pem&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">key.pem</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;key.pem&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls.crt</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;tls.crt&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls.key</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;tls.key&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">linkerd-identity-issuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">linkerd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now we just need to inform Linkerd to use these credentials. Since we are installing via the <code>linkerd</code> command line tool, the Linkerd control plane will by default be installed via the <code>--identity-external-issuer</code> flag, which instructs Linkerd to read the credentials from the <code>linkerd-identity-issuer</code> Secret. Whenever the <code>certificate</code> and <code>key</code> stored in the Secret are updated, the identity service will automatically detect this change and reload the new credentials.</p>
<p>This sets up automatic rotation of Linkerd control plane TLS credentials, and if you want to monitor the update process, you can check the <code>IssuerUpdated</code> event issued by the service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get events --field-selector <span class="nv">reason</span><span class="o">=</span>IssuerUpdated -n linkerd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LAST SEEN   TYPE     REASON          OBJECT                        MESSAGE
</span></span><span class="line"><span class="cl">2m37s       Normal   IssuerUpdated   deployment/linkerd-identity   Updated identity issuer
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the <code>Updated identity issuer</code> has been executed.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/waitgroup/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Evolution of WaitGroup in golang</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/retry/">
            <span class="next-text nav-default">Implementation of retry mechanism</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
