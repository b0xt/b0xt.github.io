<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Compiling Rust projects with Nix - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to compile Rust projects using Nix" /><meta name="keywords" content="rust, Nix" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/rust-nix/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Compiling Rust projects with Nix" />
<meta property="og:description" content="Learn how to compile Rust projects using Nix" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/rust-nix/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-03T13:22:52+08:00" />
<meta property="article:modified_time" content="2022-08-03T13:22:52+08:00" />

<meta itemprop="name" content="Compiling Rust projects with Nix">
<meta itemprop="description" content="Learn how to compile Rust projects using Nix"><meta itemprop="datePublished" content="2022-08-03T13:22:52+08:00" />
<meta itemprop="dateModified" content="2022-08-03T13:22:52+08:00" />
<meta itemprop="wordCount" content="1809">
<meta itemprop="keywords" content="rust," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compiling Rust projects with Nix"/>
<meta name="twitter:description" content="Learn how to compile Rust projects using Nix"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Compiling Rust projects with Nix</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-03 13:22:52 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1809 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#cargo2nix">cargo2nix</a>
          <ul>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#usage">Usage</a></li>
            <li><a href="#principle">Principle</a></li>
          </ul>
        </li>
        <li><a href="#crane">crane</a>
          <ul>
            <li><a href="#installation-1">Installation</a></li>
            <li><a href="#usage-1">Usage</a></li>
            <li><a href="#principle-1">Principle</a></li>
          </ul>
        </li>
        <li><a href="#crate2nix">crate2nix</a>
          <ul>
            <li><a href="#installation-2">Installation</a></li>
            <li><a href="#usage-2">Usage</a></li>
            <li><a href="#principle-2">Principle</a></li>
          </ul>
        </li>
        <li><a href="#naersk">naersk</a>
          <ul>
            <li><a href="#installation-3">Installation</a></li>
            <li><a href="#usage-3">Usage</a></li>
            <li><a href="#principle-3">Principle</a></li>
          </ul>
        </li>
        <li><a href="#nocargo">nocargo</a>
          <ul>
            <li><a href="#usage-4">Usage</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Rust projects are generally managed with Cargo, but it has the disadvantage of having to recompile all dependencies once per project, taking up a lot of hard disk space, and not being able to share the build cache across projects. After some research, there are several Nix-based Rust build tools:</p>
<ul>
<li>cargo2nix: <a href="https://github.com/cargo2nix/cargo2nix">https://github.com/cargo2nix/cargo2nix</a></li>
<li>carnix: no longer updated</li>
<li>crane: <a href="https://github.com/ipetkov/crane">https://github.com/ipetkov/crane</a></li>
<li>crate2nix: <a href="https://github.com/kolloch/crate2nix">https://github.com/kolloch/crate2nix</a></li>
<li>naersk: <a href="https://github.com/nix-community/naersk">https://github.com/nix-community/naersk</a></li>
<li>nocargo: <a href="https://github.com/oxalica/nocargo">https://github.com/oxalica/nocargo</a></li>
</ul>
<p>I&rsquo;ll try out each of these tools below.</p>
<p>Some of the commands that appear below are referenced in the documentation for the corresponding project.</p>
<h2 id="cargo2nix">cargo2nix</h2>
<ul>
<li>Development Shell - knowing all the dependencies means easy creation of complete shells. Run nix develop or direnv allow in this repo and see!</li>
<li>Caching - CI &amp; CD pipelines move faster when purity guarantees allow skipping more work!</li>
<li>Reproducibility - Pure builds. Access to all of nixpkgs for repeatable environment setup across multiple distributions and platforms</li>
</ul>
<h3 id="installation">Installation</h3>
<p>cargo2nix provides flakes support and does not need to be installed separately.</p>
<h3 id="usage">Usage</h3>
<p>cargo2nix is relatively easy to run, just run <code>nix run</code> directly using the flakes feature.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix run github:cargo2nix/cargo2nix
</span></span></code></pre></td></tr></table>
</div>
</div><p>It generates a Cargo.nix file, and you need to write a <code>flake.nix</code> to use with it, here is <code>jiegec/webhookd</code> as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cargo2nix</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:cargo2nix/cargo2nix/release-0.11.0&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;cargo2nix/flake-utils&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;cargo2nix/nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputs</span>: <span class="nc">with</span><span class="w"> </span><span class="n">inputs</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">eachDefaultSystem</span><span class="w"> </span><span class="p">(</span><span class="n">system</span>:
</span></span><span class="line"><span class="cl">      <span class="nc">let</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pkgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">nixpkgs</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">inherit</span><span class="w"> </span><span class="n">system</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">overlays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">cargo2nix</span><span class="p">.</span><span class="n">overlays</span><span class="p">.</span><span class="n">default</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">rustPkgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pkgs</span><span class="p">.</span><span class="n">rustBuilder</span><span class="p">.</span><span class="n">makePackageSet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">rustVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;1.61.0&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">packageFun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">nix</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">in</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">webhookd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rustPkgs</span><span class="p">.</span><span class="n">workspace</span><span class="p">.</span><span class="n">webhookd</span><span class="w"> </span><span class="p">{}).</span><span class="n">bin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packages</span><span class="p">.</span><span class="n">webhookd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then compile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git add .
</span></span><span class="line"><span class="cl">$ nix build
</span></span><span class="line"><span class="cl">$ ./result-bin/bin/webhookd --version
</span></span><span class="line"><span class="cl">webhookd 0.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="principle">Principle</h3>
<p>cargo2nix parses Cargo.lock, generates Cargo.nix file, and finally wraps it into flake.nix.</p>
<h2 id="crane">crane</h2>
<ul>
<li>Source fetching: automatically done using a Cargo.lock file</li>
<li>Incremental: build your workspace dependencies just once, then quickly lint, build, and test changes to your project without slowing down</li>
<li>Composable: split builds and tests into granular steps. Gate CI without burdening downstream consumers building from source.</li>
</ul>
<h3 id="installation-1">Installation</h3>
<p>crane does not need to be installed, just use flakes.</p>
<h3 id="usage-1">Usage</h3>
<p>When using crane, write <code>flake.nix</code> directly in the project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">crane</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:ipetkov/crane&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">crane</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:numtide/flake-utils&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nixpkgs</span><span class="p">,</span><span class="w"> </span><span class="n">crane</span><span class="p">,</span><span class="w"> </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">eachDefaultSystem</span><span class="w"> </span><span class="p">(</span><span class="n">system</span>: <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">packages</span><span class="p">.</span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crane</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="cp">$</span><span class="p">{</span><span class="n">system</span><span class="p">}.</span><span class="n">buildPackage</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="p">.;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This works without the need to use the tool to generate the corresponding Cargo.nix from Cargo.lock.</p>
<p>However, since webhookd relies on the native library, you will need to add the native dependencies manually.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:NixOS/nixpkgs/nixpkgs-unstable&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">crane</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:ipetkov/crane&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">crane</span><span class="p">.</span><span class="n">inputs</span><span class="p">.</span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:numtide/flake-utils&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nixpkgs</span><span class="p">,</span><span class="w"> </span><span class="n">crane</span><span class="p">,</span><span class="w"> </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">eachDefaultSystem</span><span class="w"> </span><span class="p">(</span><span class="n">system</span>:
</span></span><span class="line"><span class="cl">      <span class="nc">let</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">pkgs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">nixpkgs</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">inherit</span><span class="w"> </span><span class="n">system</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">in</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">packages</span><span class="p">.</span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crane</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="cp">$</span><span class="p">{</span><span class="n">system</span><span class="p">}.</span><span class="n">buildPackage</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="p">.;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">buildInputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">pkgs</span><span class="p">;</span><span class="w"> </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">libiconv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">darwin</span><span class="p">.</span><span class="n">apple_sdk</span><span class="p">.</span><span class="n">frameworks</span><span class="p">.</span><span class="n">Security</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nix build
</span></span><span class="line"><span class="cl">$ ./result/bin/webhookd --version
</span></span><span class="line"><span class="cl">webhookd 0.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="principle-1">Principle</h3>
<p>crane does an incremental compilation by downloading all the dependencies and building them once with cargo, and then building the resulting target directory as <code>target.tar.zst</code>, and then adding the project source code again. However, its purpose is not quite the same as other projects, and it does not take into account cross-project dependency caching.</p>
<h2 id="crate2nix">crate2nix</h2>
<ul>
<li>Same dependency tree as cargo: It uses cargo_metadata to obtain the dependency tree from cargo. Therefore, it will use the exact same library versions as cargo and respect any locked down version in Cargo.lock.</li>
<li>Smart caching: It uses smart crate by crate caching so that nix rebuilds exactly the crates that need to be rebuilt. Compare that to docker layers…</li>
<li>Nix ecosystem goodness: You can use all things that make the nix/NixOS ecosystem great, e.g. distributed/remote builds, build minimal docker images, deploy your binary as a service to the cloud with NixOps, …</li>
<li>Out of the box support for libraries with non-rust dependencies: It builds on top of the buildRustCrate function from NixOS so that native dependencies of many rust libraries are already correctly fetched when needed. If your library with native dependencies is not yet supported, you can customize defaultCrateOverrides / crateOverrides, see below.</li>
<li>Easy to understand nix template: The actual nix code is generated via templates/build.nix.tera so you can fix/improve the nix code without knowing rust if all the data is already there.</li>
</ul>
<h3 id="installation-2">Installation</h3>
<p>First install crate2nix, since its stable version 0.10.0 is already last year&rsquo;s version, I directly used the master branch. If you are installing directly, you can use the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix-env -i -f ht
</span></span></code></pre></td></tr></table>
</div>
</div><p>But I am managing it with flakes + home-manager, so here is how I actually configured it.</p>
<ol>
<li>add crate2nix to flake.nix to inputs and set <code>crate2nix.flake = false</code></li>
<li>pass crate2nix from inputs to the actual home manager configuration, then add <code>callPackage crate2nix {}</code> to <code>home.packages</code></li>
</ol>
<h3 id="usage-2">Usage</h3>
<p>Next, find a Rust project and run <code>crate2nix generate</code> in it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ crate2nix generate
</span></span><span class="line"><span class="cl">Generated ./Cargo.nix successfully.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix build -f Cargo.nix rootCrate.build
</span></span></code></pre></td></tr></table>
</div>
</div><p>The result of the compilation can be seen under <code>result/bin</code>.</p>
<p>I compiled <code>jiegec/webhookd</code> and got an error during the compilation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;   <span class="o">=</span> note: ld: framework not found Security
</span></span><span class="line"><span class="cl">&gt;           clang-11: error: linker <span class="nb">command</span> failed with <span class="nb">exit</span> code <span class="m">1</span> <span class="o">(</span>use -v to see invocation<span class="o">)</span>
</span></span><span class="line"><span class="cl">&gt;
</span></span><span class="line"><span class="cl">&gt;
</span></span><span class="line"><span class="cl">&gt; error: aborting due to previous error
</span></span></code></pre></td></tr></table>
</div>
</div><p>The previous cargo2nix did not have this problem, supposedly because cargo2nix introduced the Security dependency for us, see <a href="https://github.com/cargo2nix/cargo2nix/blob/9c3b846c727300f8146f20f01c5387b398d1e0e4/overlay/overrides.nix">overrides.nix</a>.</p>
<p>According to the crate2nix documentation, additional native dependencies need to be added.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="p">{</span><span class="w"> </span><span class="n">pkgs</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="o">&lt;</span><span class="n">nixpkgs</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">let</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">generatedBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">nix</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inherit</span><span class="w"> </span><span class="n">pkgs</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">defaultCrateOverrides</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">pkgs</span><span class="p">;</span><span class="w"> </span><span class="n">defaultCrateOverrides</span><span class="w"> </span><span class="c1">// {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">      </span><span class="n">webhookd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attrs</span>: <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">buildInputs</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">lib</span><span class="p">.</span><span class="n">optionals</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">stdenv</span><span class="p">.</span><span class="n">isDarwin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="n">darwin</span><span class="p">.</span><span class="n">apple_sdk</span><span class="p">.</span><span class="n">frameworks</span><span class="p">.</span><span class="n">Security</span><span class="w"> </span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">in</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">generatedBuild</span><span class="p">.</span><span class="n">rootCrate</span><span class="p">.</span><span class="n">build</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nix build -f default.nix
</span></span><span class="line"><span class="cl">$ ./result/bin/webhookd --version
</span></span><span class="line"><span class="cl">webhookd 0.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>This will work fine.</p>
<h3 id="principle-2">Principle</h3>
<p>The principle is to use the <code>cargo_metadata</code> library to get the information of each crate from Cargo.lock and then translate it to <code>Cargo.nix</code>, after which nix compiles the contents of each crate. So at first, you still need to create a project with Cargo, add dependencies, and generate <code>Cargo.lock</code>; then you can use <code>crate2nix generate</code> to synchronize the dependency information to the <code>Cargo.nix</code> file, and build it without Cargo&rsquo;s participation, directly rustc.</p>
<h2 id="naersk">naersk</h2>
<h3 id="installation-3">Installation</h3>
<p>Requires installation of <a href="https://github.com/nmattia/niv">niv</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix-env -iA nixpkgs.niv
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="usage-3">Usage</h3>
<p>In the project directory, first import naersk with <code>niv</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">niv init
</span></span><span class="line"><span class="cl">niv add nix-community/naersk
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then write a <code>default.nix</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="k">let</span>
</span></span><span class="line"><span class="cl">  <span class="n">pkgs</span> <span class="o">=</span> <span class="kn">import</span> <span class="sr">&lt;nixpkgs&gt;</span> <span class="p">{</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="n">sources</span> <span class="o">=</span> <span class="kn">import</span> <span class="sr">./nix/sources.nix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">naersk</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">callPackage</span> <span class="n">sources</span><span class="o">.</span><span class="n">naersk</span> <span class="p">{</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">in</span>
</span></span><span class="line"><span class="cl"><span class="n">naersk</span><span class="o">.</span><span class="n">buildPackage</span> <span class="sr">./.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nix build -f default.nix
</span></span><span class="line"><span class="cl">$ ./result/bin/webhookd --version
</span></span><span class="line"><span class="cl">webhookd 0.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="principle-3">Principle</h3>
<p>The principle of naersk is similar to crane: download all the dependencies, create a project with only dependencies, then precompile with cargo, compile the target directory into <code>target.tar.zst</code>; then compile the whole project based on the precompiled results.</p>
<h2 id="nocargo">nocargo</h2>
<ul>
<li>No IFDs (import-from-derivation). See meme.</li>
<li>No cargo dependency during building. Only rustc.</li>
<li>No need for hash prefetching or code generation1.</li>
<li>Crate level caching, globally shared.</li>
<li>nixpkgs integration for non-Rust dependencies.</li>
</ul>
<p>The README also mentions a comparison of nocargo, cargo2nix, naersk and buildRustPackage.</p>
<h3 id="usage-4">Usage</h3>
<p>nocargo is currently <a href="https://github.com/oxalica/nocargo/blob/90a6d0e8dcfc2205fa69423d42bff6fd1b997121/flake.nix#L13">only supported on x86_64-linux platforms</a>.</p>
<p>In a Cargo project, run the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nix run github:oxalica/nocargo init
</span></span></code></pre></td></tr></table>
</div>
</div><p>It generates the <code>flake.nix</code> file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl">#<span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">usages</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">nocargo</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//github.com/oxalica/nocargo#readme
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;Rust package webhookd&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:NixOS/nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:numtide/flake-utils&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nocargo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:oxalica/nocargo&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">inputs</span><span class="p">.</span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>#<span class="w"> </span><span class="n">inputs</span><span class="p">.</span><span class="n">registry</span><span class="o">-</span><span class="n">crates</span><span class="o">-</span><span class="n">io</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;registry-crates-io&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>#<span class="w"> </span><span class="n">Optionally</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="kr">override</span><span class="w"> </span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">cutting</span><span class="o">-</span><span class="n">edge</span><span class="w"> </span><span class="n">packages</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>#<span class="w"> </span><span class="n">registry</span><span class="o">-</span><span class="n">crates</span><span class="o">-</span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:rust-lang/crates.io-index&#34;</span><span class="p">;</span><span class="w"> </span><span class="n">flake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">nixpkgs</span><span class="p">,</span><span class="w"> </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">,</span><span class="w"> </span><span class="n">nocargo</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="o">@</span><span class="n">inputs</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">eachSystem</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s">&#34;x86_64-linux&#34;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">system</span>:
</span></span><span class="line"><span class="cl">      <span class="nc">let</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nocargo</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="cp">$</span><span class="p">{</span><span class="n">system</span><span class="p">}.</span><span class="n">mkRustPackageOrWorkspace</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="p">.;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">in</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packages</span><span class="p">.</span><span class="n">webhookd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">webhookd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="n">release</span><span class="p">.</span><span class="n">webhookd</span><span class="p">.</span><span class="n">bin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">webhookd</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">webhookd</span><span class="p">.</span><span class="n">bin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git add .
</span></span><span class="line"><span class="cl">$ nix build
</span></span></code></pre></td></tr></table>
</div>
</div><p>A compile error occurs, indicating that the crates.io index version is not up to date.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">error: Package bytes doesn&#39;t have version 1.2.0 in index. Available versions: 0.0.1 0.1.0 0.1.1 0.1.2 0.2.0 0.2.1 0.2.10 0.2.11 0.2.2 0.2.3 0.2.4 0.2.5 0.2.6 0.2.7 0.2.8 0.2.9 0.3.0 0.4.0 0.4.1 0.4.10 0.4.11 0.4.12 0.4.2 0.4.3 0.4.4 0.4.5 0.4.6 0.4.7 0.4.8 0.4.9 0.5.0 0.5.1 0.5.2 0.5.3 0.5.4 0.5.5 0.5.6 0.6.0 1.0.0 1.0.1 1.1.0
</span></span><span class="line"><span class="cl">(use &#39;--show-trace&#39; to show detailed location information)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Follow the instructions in <code>flake.nix</code> to use the latest crates.io index.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl">#<span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">usages</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">nocargo</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">https</span>:<span class="c1">//github.com/oxalica/nocargo#readme
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;Rust package webhookd&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:NixOS/nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:numtide/flake-utils&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nocargo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:oxalica/nocargo&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">inputs</span><span class="p">.</span><span class="n">nixpkgs</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;nixpkgs&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">inputs</span><span class="p">.</span><span class="n">registry</span><span class="o">-</span><span class="n">crates</span><span class="o">-</span><span class="n">io</span><span class="p">.</span><span class="n">follows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;registry-crates-io&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>#<span class="w"> </span><span class="n">Optionally</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="kr">override</span><span class="w"> </span><span class="n">crates</span><span class="p">.</span><span class="n">io</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">cutting</span><span class="o">-</span><span class="n">edge</span><span class="w"> </span><span class="n">packages</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">registry</span><span class="o">-</span><span class="n">crates</span><span class="o">-</span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;github:rust-lang/crates.io-index&#34;</span><span class="p">;</span><span class="w"> </span><span class="n">flake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">nixpkgs</span><span class="p">,</span><span class="w"> </span><span class="n">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">,</span><span class="w"> </span><span class="n">nocargo</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="o">@</span><span class="n">inputs</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">flake</span><span class="o">-</span><span class="n">utils</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="n">eachSystem</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s">&#34;x86_64-linux&#34;</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">system</span>:
</span></span><span class="line"><span class="cl">      <span class="nc">let</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nocargo</span><span class="p">.</span><span class="n">lib</span><span class="p">.</span><span class="cp">$</span><span class="p">{</span><span class="n">system</span><span class="p">}.</span><span class="n">mkRustPackageOrWorkspace</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="p">.;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">in</span><span class="w"> </span><span class="n">rec</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">packages</span><span class="p">.</span><span class="n">webhookd</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">webhookd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="n">release</span><span class="p">.</span><span class="n">webhookd</span><span class="p">.</span><span class="n">bin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">webhookd</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ws</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">webhookd</span><span class="p">.</span><span class="n">bin</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Continue building and you&rsquo;re done.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nix build
</span></span><span class="line"><span class="cl">• Updated input <span class="s1">&#39;nocargo/registry-crates-io&#39;</span>:
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;github:rust-lang/crates.io-index/1ce12a7e3367a2a673f91f07ab7cc505a0b8f069&#39;</span> <span class="o">(</span>2022-07-17<span class="o">)</span>
</span></span><span class="line"><span class="cl">  → follows <span class="s1">&#39;registry-crates-io&#39;</span>
</span></span><span class="line"><span class="cl">• Added input <span class="s1">&#39;registry-crates-io&#39;</span>:
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;github:rust-lang/crates.io-index/627caba32f416e706bf3f2ceac55230ec79710c5&#39;</span> <span class="o">(</span>2022-08-02<span class="o">)</span>
</span></span><span class="line"><span class="cl">$ ./result/bin/webhookd --version
</span></span><span class="line"><span class="cl">webhookd 0.2.1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>As you can see, the different tools above use different approaches, if you want to compare.</p>
<ul>
<li>Nix drv granularity: per dependency (cargo2nix, crate2nix, nocargo), all dependencies (crane, naersk). The advantage of the former is that the dependencies will be shared across projects and further can be passed to the binary cache.</li>
<li>Whether to generate nix files with full dependency information: yes (cargo2nix, crate2nix), no (crane, naersk, nocargo). If generated, the information in Cargo.lock and Cargo.nix in the repository is duplicated, so if Cargo.lock is modified, you need to resync Cargo.nix.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/rust/">rust</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/hot-reload-config/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to implement hot reload config</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/go-2-executable/">
            <span class="next-text nav-default">From .go text files to executable files</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
