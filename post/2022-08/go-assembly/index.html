<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go Assembly Overview - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn Go Assembly." /><meta name="keywords" content="golang, Assembly" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/go-assembly/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Go Assembly Overview" />
<meta property="og:description" content="Learn Go Assembly." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/go-assembly/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-02T13:09:51+08:00" />
<meta property="article:modified_time" content="2022-08-02T13:09:51+08:00" />

<meta itemprop="name" content="Go Assembly Overview">
<meta itemprop="description" content="Learn Go Assembly."><meta itemprop="datePublished" content="2022-08-02T13:09:51+08:00" />
<meta itemprop="dateModified" content="2022-08-02T13:09:51+08:00" />
<meta itemprop="wordCount" content="2129">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go Assembly Overview"/>
<meta name="twitter:description" content="Learn Go Assembly."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go Assembly Overview</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-02 13:09:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2129 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#direction">Direction</a></li>
        <li><a href="#stack-push-and-pop">Stack push and pop</a></li>
        <li><a href="#data-copy">Data Copy</a></li>
        <li><a href="#operation-commands">Operation commands</a></li>
        <li><a href="#jump-instructions">Jump Instructions</a></li>
        <li><a href="#constant-definition">Constant definition</a></li>
        <li><a href="#variable-declarations">Variable declarations</a></li>
        <li><a href="#gos-registers">Go&rsquo;s registers</a>
          <ul>
            <li><a href="#pseudo-pc-registers">Pseudo PC registers</a></li>
            <li><a href="#pseudo-sb-register">Pseudo SB register</a></li>
            <li><a href="#bp-register">BP register</a></li>
            <li><a href="#sp-register">SP register</a></li>
            <li><a href="#pseudo-fp-registers">Pseudo FP registers</a></li>
            <li><a href="#general-purpose-registers">General Purpose Registers</a></li>
            <li><a href="#mmx-registers">MMX registers</a></li>
            <li><a href="#tls-pseudo-registers">TLS pseudo-registers</a></li>
          </ul>
        </li>
        <li><a href="#frequently-asked-questions">Frequently Asked Questions</a>
          <ul>
            <li><a href="#1-how-can-i-view-the-go-assembly-code">1. How can I view the Go assembly code?</a></li>
            <li><a href="#2-what-do-framesize-and-argsize-mean-when-they-are-specified-in-an-assembly-function">2. What do framesize and argsize mean when they are specified in an assembly function?</a></li>
            <li><a href="#3-how-to-distinguish-between-true-and-false-registers">3. How to distinguish between true and false registers?</a></li>
            <li><a href="#4-the-relationship-between-fp-and-sp-registers-in-amd64-environment">4. The relationship between FP and SP registers in AMD64 environment?</a></li>
            <li><a href="#5-what-happens-to-the-stack-frame-during-the-function-call">5. What happens to the stack frame during the function call?</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="direction">Direction</h2>
<p>The plan9 assembly operand direction is the opposite of the intel assembly direction, plan9 is <code>left to right</code> and intel is <code>right to left</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// plan9 
</span></span><span class="line"><span class="cl">MOVQ $123, AX
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// intel
</span></span><span class="line"><span class="cl">MOV RAX, 123
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="stack-push-and-pop">Stack push and pop</h2>
<p>In plan9, there is no PUSH POP instruction for stack operation, but SUB and ADD respectively.</p>
<p>SP is the top of stack pointer, which corresponds to BP bottom of stack pointer, usually only need to operate SP pointer to complete push and pop operations, so BP pointer is not used much.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">SUBQ $0x18, SP // Subtract the SP and put it on the stack
</span></span><span class="line"><span class="cl">ADDQ $0x18, SP // Add to SP, out of stack
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="data-copy">Data Copy</h2>
<p>The commands starting with MOV are used to move data, and the amount of data that can be moved at one time varies with the variety of commands provided.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">MOVB $1, DI      // MOVB can move 1 byte at a time
</span></span><span class="line"><span class="cl">MOVW $0x10, BX   // MOVW can move 2 bytes at a time
</span></span><span class="line"><span class="cl">MOVD $1, DX      // MOVD can move 4 bytes at a time
</span></span><span class="line"><span class="cl">MOVQ $-10, AX    // MOVQ can move 8 bytes at a time
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="operation-commands">Operation commands</h2>
<ul>
<li>ADD to add</li>
<li>SUB to subtract</li>
<li>IMUL for multiplication</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">ADDQ AX, BX      // BX += AX
</span></span><span class="line"><span class="cl">SUBQ AX, BX      // BX -= AX
</span></span><span class="line"><span class="cl">IMULQ AX, BX     // BX *= AX
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="jump-instructions">Jump Instructions</h2>
<p>The jump instruction is the key to switch the flow of program execution.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// unconditional jumping
</span></span><span class="line"><span class="cl">JMP label // jump to label can jump to the same function within the label position (commonly used)
</span></span><span class="line"><span class="cl">JMP addr // jump to address, which can be the address in the code, but in practice this doesn&#39;t happen by hand
</span></span><span class="line"><span class="cl">JMP 2(PC) // jump n lines forward/backward based on current PC
</span></span><span class="line"><span class="cl">JMP -2(PC) // same as above
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Conditional jump
</span></span><span class="line"><span class="cl">JNZ target // jump if zero flag has been set
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="constant-definition">Constant definition</h2>
<p>plan9 assembly uses num to represent constants, which can be negative, the default is <code>decimal</code> and can be used in the form of 0x123 for <code>hexadecimal</code></p>
<h2 id="variable-declarations">Variable declarations</h2>
<p>Variables in assembly are generally read-only values stored in .rodata or .data segments. This corresponds to global const and var variables/constants that have been initialized at the application level.</p>
<ul>
<li>
<p>DATA can declare and initialize a variable</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DATA symbol+offset(SB)/width,value
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above statement initializes the symbol+offset(SB) data in width bytes, assigning it to value.(SB operations are all incremental)</p>
</li>
<li>
<p>GLOBL declares a global variable</p>
<p>If under Go package, GLOBL can export the DATA initialized variables for external use</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GLOBL runtime·tlsoffset(SB), NOPTR, $4
</span></span><span class="line"><span class="cl">// Declare a global variable tlsoffset, 4 byte, with no DATA part because its value is 0.
</span></span><span class="line"><span class="cl">// NOPTR means that there is no pointer in the data of this variable and the GC does not need to scan it.
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="gos-registers">Go&rsquo;s registers</h2>
<p>Go assembly introduces 4 pseudo-registers PC, FP, SP, SB to simplify the writing of assembly code, plus other general registers which are the Go assembly language&rsquo;s re-abstraction of the CPU.</p>
<p>Take AMD64 environment as an example, the purpose of each register is explained</p>
<h3 id="pseudo-pc-registers">Pseudo PC registers</h3>
<ul>
<li>Meaning: Alias of IP register, pointing to instruction address</li>
<li>Purpose: Used to indicate the address of the next instruction (logical address, i.e., offset), normally, the system instructs to add 1 to it, when encountering transfer instructions, such as JMP, CALL, LOOP, etc., the system will save the jump to the instruction address in the PC</li>
<li>Frequency of use: Except for individual jumps, handwritten code deals with PC registers less often</li>
</ul>
<h3 id="pseudo-sb-register">Pseudo SB register</h3>
<ul>
<li>Meaning: can be interpreted as raw memory, pointing to the global symbol table</li>
<li>Usage: Generally used to declare functions or global variables</li>
<li>Usage: foo(SB) means use foo to represent an address in memory. foo(SB) can be used to define global functions and data. foo&lt;&gt;(SB) means foo is only visible in the current file, similar to the effect of static in C. In addition, you can add an offset to the reference, for example, foo+4(SB) means the address of foo+4bytes</li>
<li>Frequency of use: commonly used</li>
</ul>
<h3 id="bp-register">BP register</h3>
<ul>
<li>Meaning: indicates the <code>start stack base</code> of the function call stack (the direction of the stack is from large to small, the true SP indicates the top of the stack), and records the <code>end position</code> of the current function stack frame</li>
<li>Usage: Store the stack base address before entering the function, and use with true SP to maintain the function call stack relationship</li>
<li>Use.
<ul>
<li>Function call-related instructions implicitly affect the value of BP</li>
<li>The BP register on the X86 platform is usually used to indicate the starting position of the function stack, and is only used as an indicator.</li>
<li>But some debug tools may use this register to find function parameters, local variables, etc.</li>
<li>So on amd64 platform, compiler will insert 8 byte after return address to place caller BP register</li>
</ul>
</li>
<li>If you need to maintain the call stack manually, you need to use the BP register and split the call stack manually.</li>
</ul>
<h3 id="sp-register">SP register</h3>
<ul>
<li>Meaning.
<ul>
<li><code>True SP register</code> indicates the <code>end stack top</code> of the function call stack (the direction of the stack is from largest to smallest, BP indicates the bottom of the stack), and records the <code>end position</code> of the current function stack frame.</li>
<li><code>Pseudo-SP register</code> indicates the <code>highest start address</code> of the local variable.</li>
</ul>
</li>
<li>Uses.
<ul>
<li>True SP is generally used for stack allocation, stack release, etc.</li>
<li>Pseudo-SP is generally used to locate local variables.</li>
</ul>
</li>
<li>Pseudo-SP use.
<ul>
<li>Pseudo SP starts at the high address of the local variable, so you need to use <code>negative offset</code> when using it.</li>
<li>Used by symbol+offset(SP), the legal value of offset is [-framesize, 0)</li>
<li>For example, b-8(SP) means that the local variable b is at the 8th byte of the pseudo-SP</li>
</ul>
</li>
<li>Use of true SP.
<ul>
<li>True SP starts at the low address of the function stack frame, and the compiler adds or subtracts the SP pointer to achieve stack allocation and stack release</li>
<li>Stack allocation and release are allocated in a single addition and subtraction operation</li>
</ul>
</li>
<li>Frequency of use: both true and false SP are commonly used (the compiler eventually generates true SP)</li>
</ul>
<h3 id="pseudo-fp-registers">Pseudo FP registers</h3>
<ul>
<li>Meaning: <code>compiler</code> maintains on-stack parameter pointers based on FP offsets, identifying parameters</li>
<li>Use: Generally used to identify and access the arguments and return values of a function</li>
<li>Usage: To access the arguments of a specific function, the compiler forces that the FP must be accessed using the <code>identifier prefix</code>, e.g. foo+0(FP) for the first argument of foo, foo+8(FP) for the second argument, and 64-bit systems with offsets to access more arguments</li>
<li>Relationship to pseudo-SP registers:
<ul>
<li>Pseudo FP is the base address for accessing incoming and outgoing parameters, usually addressed by <code>positive offsets</code>.</li>
<li>Pseudo SP is the base address for accessing local variables, usually addressed by `negative offset</li>
</ul>
</li>
<li>Frequency of use: commonly used</li>
</ul>
<h3 id="general-purpose-registers">General Purpose Registers</h3>
<ul>
<li>AX, BX, CX, DX, DI, SI, R8-R15</li>
</ul>
<h3 id="mmx-registers">MMX registers</h3>
<ul>
<li>R0-R7 are not general-purpose registers, they are only exclusive to the MMX instruction introduced from X87 onwards</li>
</ul>
<h3 id="tls-pseudo-registers">TLS pseudo-registers</h3>
<ul>
<li>This register stores the address of the current goroutine g structure</li>
</ul>
<h2 id="frequently-asked-questions">Frequently Asked Questions</h2>
<h3 id="1-how-can-i-view-the-go-assembly-code">1. How can I view the Go assembly code?</h3>
<p>For those who want to learn Go assembly language, we can look through the Go source code, which has a lot of assembly examples in practice. In addition, we can also analyze the compiled code of our Go programs through disassembly and other means to understand some underlying mechanisms and principles.</p>
<p>Here are some commands to get the compiled code.</p>
<ul>
<li>
<p>Compile output</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// -N Disable optimization
</span></span></span><span class="line"><span class="cl"><span class="c1">// -l disables inlining
</span></span></span><span class="line"><span class="cl"><span class="c1">// -S Output assembly code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">build</span> <span class="o">-</span><span class="nx">gcflags</span><span class="p">=</span><span class="err">&#39;</span><span class="o">-</span><span class="nx">N</span> <span class="o">-</span><span class="nx">l</span> <span class="o">-</span><span class="nx">S</span><span class="err">&#39;</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Equivalent to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">tool</span> <span class="nx">compile</span> <span class="o">-</span><span class="nx">N</span> <span class="o">-</span><span class="nx">l</span> <span class="o">-</span><span class="nx">S</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Disassembly</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Compile to main.o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">tool</span> <span class="nx">compile</span> <span class="o">-</span><span class="nx">N</span> <span class="o">-</span><span class="nx">l</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Disassembly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">go</span> <span class="nx">tool</span> <span class="nx">objdump</span> <span class="o">-</span><span class="nx">S</span> <span class="nx">main</span><span class="p">.</span><span class="nx">o</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>SSA analysis</p>
<p>The SSA analysis generates an ssa.html page, which can be opened to see the whole process of compiling a Go program, the last step being the assembly instructions we want.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">GOSSAFUNC=&#34;main&#34; go build main.go
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="2-what-do-framesize-and-argsize-mean-when-they-are-specified-in-an-assembly-function">2. What do framesize and argsize mean when they are specified in an assembly function?</h3>
<ul>
<li>framesize means the entire stack frame size of the function
<ul>
<li>including local variables as callee</li>
<li>including the return value argument as caller</li>
<li>including input arguments as caller</li>
<li>does not include parent caller BP</li>
<li>does not include the return address function return address</li>
</ul>
</li>
<li>argsize indicates the size of the space allocated for the function input and return values as a caller
<ul>
<li>When there is a NOSPLIT marker, the size of the input arguments and return value can be omitted</li>
<li>can be omitted because the compiler can derive the size of function arguments from the Go language function declaration</li>
</ul>
</li>
<li>If framesize is greater than 0 and framepointer enabled, the BP register is also stacked, and the true SP register is offset down by framesize bytes to allocate stack space</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/9249a0c139414a78a212134ff5bc1b8b.png" alt="assembly"></p>
<h3 id="3-how-to-distinguish-between-true-and-false-registers">3. How to distinguish between true and false registers?</h3>
<ul>
<li>Pseudo registers generally need an identifier and offset as prefix, if there is no <code>identifier prefix</code>, they are true registers</li>
<li>(SP), +8(SP) are true SP registers without an identifier prefix, while a(SP), b-8(SP) are pseudo SP registers with an identifier prefix</li>
</ul>
<h3 id="4-the-relationship-between-fp-and-sp-registers-in-amd64-environment">4. The relationship between FP and SP registers in AMD64 environment?</h3>
<ul>
<li>
<p>Scenario</p>
<ul>
<li>We assume the scenario is when caller calls callee, framesize is greater than 0, and BP registers are stacked</li>
<li>We restrict NOSPLIT to not allow leaf function stack splitting</li>
<li>caller&rsquo;s FP pointer is at the high address above, and callee&rsquo;s true and false SPs are at the low address, spanning both caller and callee functions</li>
</ul>
</li>
<li>
<p>Relationship</p>
<ul>
<li>pseudo FP = true SP + framesize + 16
<ul>
<li>arg0+0(FP) = 0(SP) + framesize + 16</li>
<li>Note: The 16 bytes here store the 8-byte parent caller BP, and the 8-byte return address, respectively</li>
</ul>
</li>
<li>Pseudo-SP = true SP + framesize
<ul>
<li>Description: The pseudo-SP is pointing to a location below the low address of the BP</li>
</ul>
</li>
<li>pseudo FP = pseudo SP + 16</li>
</ul>
</li>
<li>
<p>Caution</p>
<ul>
<li>Pseudo SP and pseudo FP registers are calculated based on the true SP, which is convenient for quick operation.</li>
<li>When the true SP register is modified, the pseudo SP and pseudo FP registers will be moved in the same way.</li>
<li>Therefore, it is better not to modify the true SP and leave it to the compiler.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/8564a2601def4d97b6661a674e9cb67d.png" alt="Function call stack frame"></p>
</li>
</ul>
<h3 id="5-what-happens-to-the-stack-frame-during-the-function-call">5. What happens to the stack frame during the function call?</h3>
<ul>
<li>Execution of the CALL instruction, the caller
<ul>
<li>return address after a stacked function call return address (addr of the subsequent instruction of the caller executed after callee returns to the caller)</li>
<li>Jump to the address of the instruction pointed to by the PC register</li>
</ul>
</li>
<li>Allocate the callee stack frame
<ul>
<li>At the head of the function call, the compiler inserts 3 instructions
<ul>
<li>The first one: <code>SUBQ $16, SP</code> allocates the stack frame of callee, moving sp down 16 bytes, which is the top of the stack of <code>callee</code>.</li>
<li>Second: <code>MOVQ BP, 8(SP)</code> Back up the caller&rsquo;s BP stack base below the return address (at the low address)</li>
<li>Third: <code>LEAQ 8(SP), BP</code> points the BP register to callee&rsquo;s stack base (for 0x48(SP), this location is <code>callee's stack base</code>)</li>
</ul>
</li>
</ul>
</li>
<li>Execute the instructions that follow the TEXT segment of the callee function.</li>
<li>Restore the caller&rsquo;s stack frame
<ul>
<li>Before the function returns, you need to restore the caller&rsquo;s stack frame, the compiler will insert 2 instructions to the end of the `function
<ul>
<li>The first one: <code>MOVQ 8(SP), BP</code> restores the BP stack base address of the caller</li>
<li>The second instruction: <code>ADDQ $16, SP</code> frees up the stack space of callee, and the SP register is naturally restored to the original position of caller</li>
</ul>
</li>
</ul>
</li>
<li>Execute the RET instruction and return
<ul>
<li>Return address out of the stack return address</li>
<li>PC register jumps to return address</li>
<li>Execute the instruction at return address, and caller resumes execution</li>
</ul>
</li>
</ul>
<h2 id="summary">Summary</h2>
<p>In Go&rsquo;s assembly, there are many unique <code>pseudo-registers</code> to help users quickly locate the corresponding hardware registers, global variables, functions, concurrent procedures, etc., which is really convenient. On the other hand, if you don&rsquo;t understand the mechanism and stack layout of these pseudo-registers in Go, you will have a hard time.</p>
<p>For writing and learning Go assembly, many register operations are transparent, and we should focus on the layout of return parameters, input parameters, and local variables on the stack frame in function calls. The compiled assembly instructions will also be converted to true SP registers, and there are no pseudo registers.</p>
<p>The others, pseudo PC, pseudo SB registers, pseudo TLS registers, etc., can be understood as long as they exist. bp registers, although they have a low presence, are still useful for understanding the layout of function stacks.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/go-mod-gitlab/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go mod add gitlab private repository</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/docker-file/">
            <span class="next-text nav-default">Customizing images with Dockerfile</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
