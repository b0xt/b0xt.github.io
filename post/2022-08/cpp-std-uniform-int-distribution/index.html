<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Talk about the principle and optimization of std::uniform_int_distribution - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn about the principles and optimizations of std::uniform_int_distribution." /><meta name="keywords" content="c&#43;&#43;, std::uniform_int_distribution" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/cpp-std-uniform-int-distribution/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Talk about the principle and optimization of std::uniform_int_distribution" />
<meta property="og:description" content="Learn about the principles and optimizations of std::uniform_int_distribution." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/cpp-std-uniform-int-distribution/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-16T12:11:02+08:00" />
<meta property="article:modified_time" content="2022-08-16T12:11:02+08:00" />

<meta itemprop="name" content="Talk about the principle and optimization of std::uniform_int_distribution">
<meta itemprop="description" content="Learn about the principles and optimizations of std::uniform_int_distribution."><meta itemprop="datePublished" content="2022-08-16T12:11:02+08:00" />
<meta itemprop="dateModified" content="2022-08-16T12:11:02+08:00" />
<meta itemprop="wordCount" content="1653">
<meta itemprop="keywords" content="cpp," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Talk about the principle and optimization of std::uniform_int_distribution"/>
<meta name="twitter:description" content="Learn about the principles and optimizations of std::uniform_int_distribution."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Talk about the principle and optimization of std::uniform_int_distribution</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-16 12:11:02 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1653 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#specifications-and-design-considerations">Specifications and Design Considerations</a></li>
        <li><a href="#openbsd-algorithms">OpenBSD Algorithms</a></li>
        <li><a href="#openjdk-algorithm">OpenJDK Algorithm</a></li>
        <li><a href="#daniel-lemires-algorithm">Daniel Lemire&rsquo;s Algorithm</a></li>
        <li><a href="#summary">Summary</a></li>
        <li><a href="#reference">Reference</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Normally, the Pseudo Random Number Generator generates integers in the interval <code>[0, 2^N)</code>. Each integer in this interval has an equal chance of being generated. However, the random numbers we need usually belong to a smaller interval (e.g., the dice simulator needs random numbers in the interval <code>[1, 6]</code>), so we must use <code>std::uniform_int_distribution</code> to map <code>[0, 2^N)</code> to the interval <code>[min, max]</code>. This article follows Daniel Lemire&rsquo;s paper <a href="https://arxiv.org/abs/1805.10941">Fast Random Integer Generation in an Interval</a> and introduces several different mapping methods in order.</p>
<h2 id="specifications-and-design-considerations">Specifications and Design Considerations</h2>
<p>The specification of <code>std::uniform_int_distribution</code> is that given a random number generator that generates <code>[0, 2^N)</code> interval integers, it generates an integer between <code>[min, max]</code>. The mapping of the interval <code>[0, 2^N)</code> to the interval <code>[min, max]</code> must ensure that the probability of each integer in each <code>[min, max]</code> interval is equal.</p>
<p>During the calculation <code>std::uniform_int_distribution</code> can discard the random numbers previously provided by the random number generator and extract the new random numbers from the random number generator again. For example, if the random number generator can produce <code>[0, 2^32)</code> integers, and the value domain of <code>std::uniform_int_distribution</code> is <code>[1, 6]</code>, a simple implementation would be to discard all random numbers that do not belong to the <code>[1, 6]</code> region. However, a good mapping should avoid rounding random numbers as much as possible; after all, pseudo-random number generators also require computation time. The Entropy Pool-based pseudohash generator has to wait for the operating system to collect enough Entropy.</p>
<p>Another consideration is the computation needed for the mapping itself. Some numerical simulators require a large number of random numbers, so the mapping must be as fast as possible. The last two algorithms in this paper are different ways to save the residual operator (Modulo, <code>%</code>).</p>
<h2 id="openbsd-algorithms">OpenBSD Algorithms</h2>
<p>The concept of the first algorithm is very simple: let <code>s</code> be <code>max - min + 1</code>, segment <code>[0, 2^N)</code> by <code>s</code> from the back, and if the random number belongs to these segments, we pass back <code>x % s</code>. If the length of the first paragraph is less than <code>s</code>, we discard the random numbers in that interval. Also, to calculate <code>2^64 % s</code> using <code>uint64_t</code>, a constant equation is used here: <code>2^64 % s == (2^64 - s) % s</code>. The complete code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">uniform_int_distribution_openbsd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">uniform_int_distribution_openbsd</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">min</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">min_value</span><span class="p">(</span><span class="n">min</span><span class="p">),</span> <span class="n">s</span><span class="p">(</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">UniformRandomBitGenerator</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">UniformRandomBitGenerator</span> <span class="o">&amp;</span><span class="n">urbg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2^64 % s = (2^64 - s) % s = uint64_t(-s) % s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint64_t</span> <span class="n">discard_bound</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">urbg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">discard_bound</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">x</span> <span class="o">=</span> <span class="n">urbg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="n">s</span> <span class="o">+</span> <span class="n">min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the random number generation interval is <code>[0, 2^3)</code> and the value domain you want to map is <code>[0, 2]</code>, the resultant comparison table is as follows.</p>
<table>
<thead>
<tr>
<th>x</th>
<th>results</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Discard</td>
</tr>
<tr>
<td>1</td>
<td>Discard</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>0</td>
</tr>
<tr>
<td>7</td>
<td>1</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Note: The author of the paper, Daniel, refers to this algorithm as the OpenBSD algorithm because he can find it in the OpenBSD source code library. Although I did not look for an earlier source, I think there is an earlier implementation.</p>
</blockquote>
<h2 id="openjdk-algorithm">OpenJDK Algorithm</h2>
<p>The second algorithm is the algorithm in OpenJDK. It also segments the <code>[0, 2^N)</code> interval in <code>s</code> units. The difference is that it starts from the front. If the random number belongs to the last group, we discard the random number. Unlike the first algorithm, this method uses <code>x - (x % s) &gt; 2^N - s</code> as the last group. The idea is that <code>x % s</code> is the operator that must be used to calculate the result. We can get the beginning of each segment by <code>x - (x % s)</code>. If the beginning is larger than <code>2^N - s</code>, the segment does not have the full <code>[0, s)</code> interval, so the random number is discarded.</p>
<p>The advantage of this algorithm is that if <code>s</code> is small enough with respect to <code>2^N</code>, there is a good chance that this algorithm does not need to enter the loop, and only a remainder operator is needed. The drawback of this algorithm is that in the worst case this algorithm may require &ldquo;multiple&rdquo; remainder operators, and the number of remainder operators is not a constant. In contrast, the OpenBSD algorithm at the beginning of this paper guarantees that only two remainder operators are always needed in the worst case.</p>
<p>The complete code of the OpenJDK algorithm is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">uniform_int_distribution_openjdk</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">uniform_int_distribution_openjdk</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">min</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">min_value</span><span class="p">(</span><span class="n">min</span><span class="p">),</span> <span class="n">s</span><span class="p">(</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">UniformRandomBitGenerator</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">UniformRandomBitGenerator</span> <span class="o">&amp;</span><span class="n">urbg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">urbg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// 2^64 - s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">x</span> <span class="o">=</span> <span class="n">urbg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">r</span> <span class="o">=</span> <span class="n">x</span> <span class="o">%</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span> <span class="o">+</span> <span class="n">min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the random number generation interval is <code>[0, 2^3)</code> and the value domain you want to map is <code>[0, 2]</code>, the resultant comparison table is as follows.</p>
<table>
<thead>
<tr>
<th>x</th>
<th>r</th>
<th>x - r</th>
<th>results</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>0</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>0</td>
<td>3</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>0</td>
<td>6</td>
<td>Discard</td>
</tr>
<tr>
<td>7</td>
<td>1</td>
<td>6</td>
<td>Discard</td>
</tr>
</tbody>
</table>
<h2 id="daniel-lemires-algorithm">Daniel Lemire&rsquo;s Algorithm</h2>
<p>Finally, the algorithm proposed by the author of the paper, Daniel Lemire, takes a different approach by mapping <code>[0, 2^N)</code> to <code>[0, s * 2^N)</code> using 128-bit integer multiplication, and then dividing the 128-bit integer into an upper half (i.e., dividing by <code>2^64</code>) and a lower half (i.e., taking the remainder of <code>2^64</code>). The upper half will be between <code>[0, s)</code> and will be the return value if other conditions are met. If the lower half is smaller than <code>s</code> we have to make additional judgments.</p>
<p>This method divides <code>[0, 2^N)</code> into <code>s</code> intervals. If <code>s</code> can divide <code>2^N</code>, each interval will have <code>floor(2^N / s)</code> values. If it is not divisible, the first <code>2^N % s</code> interval will be divided by 1 more value. If we discard the first number of each interval, we can compare the relationship between the lower half and <code>2^N % s</code>. If the bottom half is smaller than <code>2^N % s</code>, the random number belongs to the first number of the first <code>2^N % s</code> interval and is therefore discarded.</p>
<p>Also, since <code>2^N % s &lt; s</code>, we can start with <code>lower &lt; s</code> as a fast filter. The remainder operator is executed only when <code>lower &lt; s</code>. As with the OpenBSD algorithm, the result of this remainder operator can be reused, so the Daniel Lemire algorithm will only use one remainder operator in the worst case.</p>
<p>But this algorithm raises the question: Is 128-bit integer multiplication better? As of this writing 128-bit integer multiplication is not a standard built-in integer type in C/C++; the GCC or Clang compilers each define 128-bit integers. We can do 128-bit integer multiplication with <code>__uint128_t</code>. Many 64-bit computer architectures (e.g., x86-64, aarch64, riscv64) define instructions to calculate the upper half of the result of multiplication (e.g., <code>mulh</code>), so in practice 128-bit integer multiplication is faster than remainder operators.</p>
<p>The complete program code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">uniform_int_distribution_lemire</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">uniform_int_distribution_lemire</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">min</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">min_value</span><span class="p">(</span><span class="n">min</span><span class="p">),</span> <span class="n">s</span><span class="p">(</span><span class="n">max</span> <span class="o">-</span> <span class="n">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">UniformRandomBitGenerator</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint64_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">UniformRandomBitGenerator</span> <span class="o">&amp;</span><span class="n">urbg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">x</span> <span class="o">=</span> <span class="n">urbg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">__uint128_t</span> <span class="n">m</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">__uint128_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">lower</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// (2^64 - s) % s = (2^64 - s) % s = uint64_t(-s) % s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">uint64_t</span> <span class="n">discard_bound</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="n">discard_bound</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span> <span class="o">=</span> <span class="n">urbg</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">__uint128_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lower</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint64_t</span> <span class="n">upper</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">upper</span> <span class="o">+</span> <span class="n">min_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the random number generation interval is <code>[0, 2^3)</code> and the value domain you want to map is <code>[0, 2]</code>, the resultant comparison table is as follows.</p>
<table>
<thead>
<tr>
<th>x</th>
<th>x*s</th>
<th>upper</th>
<th>lower</th>
<th>results</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>Discard</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
<td>0</td>
<td>3</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>6</td>
<td>0</td>
<td>6</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>9</td>
<td>1</td>
<td>1</td>
<td>Discard</td>
</tr>
<tr>
<td>4</td>
<td>12</td>
<td>1</td>
<td>4</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>15</td>
<td>1</td>
<td>7</td>
<td>1</td>
</tr>
<tr>
<td>6</td>
<td>18</td>
<td>2</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>21</td>
<td>2</td>
<td>5</td>
<td>2</td>
</tr>
</tbody>
</table>
<h2 id="summary">Summary</h2>
<p>The motivation for writing this article was my dissatisfaction with the <a href="https://abseil.io/docs/cpp/guides/random">Abseil random number library</a>. <strong>The Abseil random number library deliberately messes up the random number seeds, so that the same program, the same random number seeds, will generate different random number sequences each time it is executed</strong>. The authors of the Abseil random number library explicitly state that they do not provide any API to turn off this behavior because if they don&rsquo;t mess with random seeds, users of the library will start relying on specific sequences, which will make it impossible to improve the random number library. Because I just want fixed sequences, and that makes me very unhappy. However, after some research, I realized that the C++ standard does not require the result of <code>std::uniform_int_distribution</code> either. Then I found Daniel Lemire&rsquo;s paper and saw the various optimizations. My opinion about Abseil&rsquo;s random number library changed from dissatisfaction to approval. I think this &ldquo;not specifying the result, but only the nature of the result&rdquo; API design is very special, so I spent some time to document the idea.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://zh-blog.logan.tw/2022/08/14/cxx-std-uniform-int-distribution/">https://zh-blog.logan.tw/2022/08/14/cxx-std-uniform-int-distribution/</a></li>
<li>Daniel Lemire, <a href="https://arxiv.org/abs/1805.10941">Fast Random Integer Generation in an Interval</a></li>
<li><a href="https://abseil.io/docs/cpp/guides/random">The Abseil Random Library</a>, Stability of Generated Sequences</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cpp/">cpp</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/lsm-tree-leveldb/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Principle and Implementation of LSM-Tree and LevelDB </span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/go-k8s-operators-part1/">
            <span class="next-text nav-default">Developing Kubernetes Operators with Go: Basic Architecture</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
