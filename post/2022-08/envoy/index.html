<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Knowledge about Envoy - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article documents the knowledge about Envoy." /><meta name="keywords" content="Envoy" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/envoy/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Knowledge about Envoy" />
<meta property="og:description" content="This article documents the knowledge about Envoy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/envoy/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-29T13:12:43+08:00" />
<meta property="article:modified_time" content="2022-08-29T13:12:43+08:00" />

<meta itemprop="name" content="Knowledge about Envoy">
<meta itemprop="description" content="This article documents the knowledge about Envoy."><meta itemprop="datePublished" content="2022-08-29T13:12:43+08:00" />
<meta itemprop="dateModified" content="2022-08-29T13:12:43+08:00" />
<meta itemprop="wordCount" content="4691">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Knowledge about Envoy"/>
<meta name="twitter:description" content="This article documents the knowledge about Envoy."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Knowledge about Envoy</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-29 13:12:43 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4691 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#development-environment-build">Development environment build</a>
          <ul>
            <li><a href="#basic-tools-download">Basic Tools Download</a></li>
          </ul>
        </li>
        <li><a href="#integrating-clion">Integrating Clion</a>
          <ul>
            <li><a href="#converting-bazel-to-cmake">Converting Bazel to Cmake</a></li>
            <li><a href="#development-environment-build-reference">Development environment build reference</a></li>
          </ul>
        </li>
        <li><a href="#envoy-foundation">Envoy Foundation</a>
          <ul>
            <li><a href="#libevent">Libevent</a></li>
            <li><a href="#libevent-in-envoy">Libevent in Envoy</a></li>
            <li><a href="#threading-model">Threading model</a></li>
          </ul>
        </li>
        <li><a href="#chain-in-envoy">Chain in Envoy</a>
          <ul>
            <li><a href="#request-handling-chain">Request handling chain</a></li>
            <li><a href="#response-data-processing-link">Response data processing link</a></li>
          </ul>
        </li>
        <li><a href="#envoy-extend">Envoy Extend</a></li>
        <li><a href="#envoy-admin">Envoy Admin</a></li>
        <li><a href="#envoy-dynamic-manager">Envoy Dynamic Manager</a>
          <ul>
            <li><a href="#lds">LDS</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/17503c5ad2f34de89b38bf4a514c9d90.png" alt="Envoy"></p>
<h2 id="development-environment-build">Development environment build</h2>
<p>Development based on Ubuntu 18.04.</p>
<h3 id="basic-tools-download">Basic Tools Download</h3>
<h4 id="install-bazel">Install Bazel</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo wget -O /usr/local/bin/bazel https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64
</span></span><span class="line"><span class="cl">sudo chmod +x /usr/local/bin/bazel
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="install-base-dependencies">Install base dependencies</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt-get install libtool cmake automake autoconf make ninja-build curl unzip virtualenv
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="clang-build-environment-optional">Clang build environment (optional)</h4>
<p>Download and install from <a href="http://releases.llvm.org/download.html">llvm</a>, version 9.0 is more compatible.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">bazel/setup_clang.sh &lt;PATH_TO_EXTRACTED_CLANG_LLVM&gt;
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;build --config=clang&#34;</span> &gt;&gt; user.bazelrc
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="building-debug-versions-with-bazel">Building DEBUG versions with bazel</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">bazel build -c dbg --spawn_strategy<span class="o">=</span>standalone  //source/exe:envoy-static
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="integrating-clion">Integrating Clion</h2>
<h3 id="converting-bazel-to-cmake">Converting Bazel to Cmake</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://github.com/lizan/bazel-cmakelists.git &lt;PATH&gt;
</span></span><span class="line"><span class="cl">&lt;bazel-cmakelists dir&gt;/bazel-cmakelists --targets //source/exe:envoy-static //test/...
</span></span><span class="line"><span class="cl"><span class="c1"># If you don&#39;t need to build you can</span>
</span></span><span class="line"><span class="cl">&lt;bazel-cmakelists dir&gt;/bazel-cmakelists --targets //source/exe:envoy-static //test/... --skip_build
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Just open Clion and import the Cmake project, Clion&rsquo;s <code>Bazel plugin</code> does not work well against Envoy.</li>
<li>Just set it to Debug start.</li>
</ul>
<h3 id="development-environment-build-reference">Development environment build reference</h3>
<ul>
<li><a href="https://github.com/envoyproxy/envoy/blob/master/bazel/README.md">Building Envoy with Bazel</a></li>
<li><a href="https://github.com/envoyproxy/envoy/issues/6297">How to set up develop environment on mac using clion or vs code #6297</a></li>
</ul>
<h2 id="envoy-foundation">Envoy Foundation</h2>
<h3 id="libevent">Libevent</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Envoy is an L7 proxy and communication bus designed <span class="k">for</span> large modern service oriented architectures. The project was born out of the belief.
</span></span></code></pre></td></tr></table>
</div>
</div><p>As described in the official website, Envoy is a high-performance proxy service software, supporting L4 and L7 proxy capabilities. But Envoy is not a product that completely repeats the wheel, Envoy&rsquo;s underlying network part of interaction with the operating system is <a href="https://libevent.org/">libevent</a>.</p>
<p>libevent is a lightweight network <strong>event</strong> library that provides the ability to handle callbacks for events such as reading and writing to the underlying socket.</p>
<p>The export function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">MESSAGE</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;Hello, World!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="mi">9995</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">listener_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">evconnlistener</span> <span class="o">*</span><span class="p">,</span> <span class="n">evutil_socket_t</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">socklen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_writecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">conn_eventcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">signal_cb</span><span class="p">(</span><span class="n">evutil_socket_t</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">evconnlistener</span> <span class="o">*</span><span class="n">listener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">signal_event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">WSADATA</span> <span class="n">wsa_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">WSAStartup</span><span class="p">(</span><span class="mh">0x0201</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsa_data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">base</span> <span class="o">=</span> <span class="n">event_base_new</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Could not initialize libevent!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sin</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sin</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">listener</span> <span class="o">=</span> <span class="n">evconnlistener_new_bind</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">listener_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="n">LEV_OPT_REUSEABLE</span><span class="o">|</span><span class="n">LEV_OPT_CLOSE_ON_FREE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="k">sizeof</span><span class="p">(</span><span class="n">sin</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Could not create a listener!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">signal_event</span> <span class="o">=</span> <span class="n">evsignal_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_event</span> <span class="o">||</span> <span class="n">event_add</span><span class="p">(</span><span class="n">signal_event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Could not create/add a signal event!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">event_base_dispatch</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">evconnlistener_free</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">event_free</span><span class="p">(</span><span class="n">signal_event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">event_base_free</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;done</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">listener_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">evconnlistener</span> <span class="o">*</span><span class="n">listener</span><span class="p">,</span> <span class="n">evutil_socket_t</span> <span class="n">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">socklen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">bev</span> <span class="o">=</span> <span class="n">bufferevent_socket_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">BEV_OPT_CLOSE_ON_FREE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Error constructing bufferevent!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">event_base_loopbreak</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">bufferevent_setcb</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">conn_writecb</span><span class="p">,</span> <span class="n">conn_eventcb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">bufferevent_enable</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_WRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">bufferevent_disable</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_READ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">bufferevent_write</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">MESSAGE</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">MESSAGE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">conn_writecb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">evbuffer</span> <span class="o">*</span><span class="n">output</span> <span class="o">=</span> <span class="n">bufferevent_get_output</span><span class="p">(</span><span class="n">bev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">evbuffer_get_length</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;flushed answer</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">bufferevent_free</span><span class="p">(</span><span class="n">bev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">conn_eventcb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">events</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">BEV_EVENT_EOF</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Connection closed.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">BEV_EVENT_ERROR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Got an error on the connection: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		    <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span><span class="cm">/*XXX win32*/</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* None of the other events can happen here, since we haven&#39;t enabled
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * timeouts */</span>
</span></span><span class="line"><span class="cl">	<span class="n">bufferevent_free</span><span class="p">(</span><span class="n">bev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">signal_cb</span><span class="p">(</span><span class="n">evutil_socket_t</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">short</span> <span class="n">events</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">delay</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Caught an interrupt signal; exiting cleanly in two seconds.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">event_base_loopexit</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the above, we can naturally understand that we handle the four events lister/read/write/signal for listening.</p>
<h3 id="libevent-in-envoy">Libevent in Envoy</h3>
<p>Continuing from the above, the positioning of libevent in Envoy is also on the bottom side, and the packets obtained by different events will be truly twisted to Envoy&rsquo;s internal system for processing, let&rsquo;s take a common example of reading. But before we talk about this, let&rsquo;s take a look at the entry definition of Envoy&rsquo;s code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Envoy</span><span class="o">::</span><span class="n">MainCommon</span><span class="o">&gt;</span> <span class="n">main_common</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_common</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Envoy</span><span class="o">::</span><span class="n">MainCommon</span><span class="o">&gt;</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Envoy</span><span class="o">::</span><span class="n">NoServingException</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Envoy</span><span class="o">::</span><span class="n">MalformedArgvException</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Envoy</span><span class="o">::</span><span class="n">EnvoyException</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">main_common</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">()</span> <span class="o">?</span> <span class="nl">EXIT_SUCCESS</span> <span class="p">:</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Leaving aside the system-compatible code, we can find that, like most system designs, we have a bottom-level design called <code>MainCommon</code>, which allows us to locate the real startup location through a big type jump.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">InstanceImpl</span><span class="o">::</span><span class="n">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// RunHelper exists primarily to facilitate how we respond to early shutdown during
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// startup (see RunHelperTest in server_test.cc).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="k">auto</span> <span class="n">run_helper</span> <span class="o">=</span> <span class="n">RunHelper</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">options_</span><span class="p">,</span> <span class="o">*</span><span class="n">dispatcher_</span><span class="p">,</span> <span class="n">clusterManager</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">access_log_manager_</span><span class="p">,</span> <span class="n">init_manager_</span><span class="p">,</span> <span class="n">overloadManager</span><span class="p">(),</span> <span class="p">[</span><span class="n">this</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">notifyCallbacksForStage</span><span class="p">(</span><span class="n">Stage</span><span class="o">::</span><span class="n">PostInit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">startWorkers</span><span class="p">();</span> <span class="c1">// ➁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Run the main dispatch loop waiting to exit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&#34;starting main dispatch loop&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">watchdog</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">guard_dog_</span><span class="o">-&gt;</span><span class="n">createWatchDog</span><span class="p">(</span><span class="n">api_</span><span class="o">-&gt;</span><span class="n">threadFactory</span><span class="p">().</span><span class="n">currentThreadId</span><span class="p">(),</span> <span class="s">&#34;main_thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">watchdog</span><span class="o">-&gt;</span><span class="n">startWatchdog</span><span class="p">(</span><span class="o">*</span><span class="n">dispatcher_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">dispatcher_</span><span class="o">-&gt;</span><span class="n">post</span><span class="p">([</span><span class="n">this</span><span class="p">]</span> <span class="p">{</span> <span class="n">notifyCallbacksForStage</span><span class="p">(</span><span class="n">Stage</span><span class="o">::</span><span class="n">Startup</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">dispatcher_</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">Dispatcher</span><span class="o">::</span><span class="n">RunType</span><span class="o">::</span><span class="n">Block</span><span class="p">);</span> <span class="err">➀</span>
</span></span><span class="line"><span class="cl">  <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&#34;main dispatch loop exited&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">guard_dog_</span><span class="o">-&gt;</span><span class="n">stopWatching</span><span class="p">(</span><span class="n">watchdog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">watchdog</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">terminate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ignoring the code around ➀, we actually find that our final main loop is here. After a lot of jumping around, we finally peel back the layers and see the Libevent part. Referring to the thread pattern at ➁.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LibeventScheduler</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="n">Dispatcher</span><span class="o">::</span><span class="n">RunType</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="n">Dispatcher</span><span class="o">::</span><span class="n">RunType</span><span class="o">::</span><span class="nl">NonBlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="n">EVLOOP_NONBLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="n">Dispatcher</span><span class="o">::</span><span class="n">RunType</span><span class="o">::</span><span class="nl">Block</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The default flags have &#39;block&#39; behavior. See
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// http://www.wangafu.net/~nickm/libevent-book/Ref3_eventloop.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="n">Dispatcher</span><span class="o">::</span><span class="n">RunType</span><span class="o">::</span><span class="nl">RunUntilExit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span> <span class="o">=</span> <span class="n">EVLOOP_NO_EXIT_ON_EMPTY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">event_base_loop</span><span class="p">(</span><span class="n">libevent_</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">flag</span><span class="p">);</span> <span class="err">➀</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The ➀ processing just happens to be the Loop loop for the Libevent we eventually built.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">event_base_loop</span><span class="p">(</span><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The event_base will only stop working when there are no registered events inside it. The next step is to find out when and where we created the various events for the event_base?</p>
<p>Not surprisingly, after some careful investigation, we can find the logic for listening to the port in ListenerImpl::setupServerSocket.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ListenerImpl</span><span class="o">::</span><span class="n">setupServerSocket</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">DispatcherImpl</span><span class="o">&amp;</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">Socket</span><span class="o">&amp;</span> <span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">listener_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">evconnlistener_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dispatcher</span><span class="p">.</span><span class="n">base</span><span class="p">(),</span> <span class="n">listenCallback</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">ioHandle</span><span class="p">().</span><span class="n">fd</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is different from Netty and other network frameworks, Libevent is a global event listener library, he can listen to different ports, recall, Socket is not distinguished as <code>Server Socket</code> and <code>Client Socket</code>, exactly, what is done here, is to create a <code>Server Socket</code> and listen to its listenCallback, which is the event when a new connection is created.</p>
<p>In the <code>ListenCallback</code> function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ListenerImpl</span><span class="o">::</span><span class="n">listenCallback</span><span class="p">(</span><span class="n">evconnlistener</span><span class="o">*</span><span class="p">,</span> <span class="n">evutil_socket_t</span> <span class="n">fd</span><span class="p">,</span> <span class="n">sockaddr</span><span class="o">*</span> <span class="n">remote_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                  <span class="kt">int</span> <span class="n">remote_addr_len</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ListenerImpl</span><span class="o">*</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">ListenerImpl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Create the IoSocketHandleImpl for the fd here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">IoHandlePtr</span> <span class="n">io_handle</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">IoSocketHandleImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Get the local address from the new socket if the listener is listening on IP ANY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// (e.g., 0.0.0.0 for IPv4) (local_address_ is nullptr in this case).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="n">Address</span><span class="o">::</span><span class="n">InstanceConstSharedPtr</span><span class="o">&amp;</span> <span class="n">local_address</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">listener</span><span class="o">-&gt;</span><span class="n">local_address_</span> <span class="o">?</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="nl">local_address_</span>
</span></span><span class="line"><span class="cl">                               <span class="p">:</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">getLocalAddress</span><span class="p">(</span><span class="n">io_handle</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">listener</span><span class="o">-&gt;</span><span class="n">cb_</span><span class="p">.</span><span class="n">onAccept</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">AcceptedSocketImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">io_handle</span><span class="p">),</span> <span class="n">local_address</span><span class="p">,</span> <span class="n">remote_address</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the last line it is clear that when our <code>ServerSocket</code> gets a new client connection it will pass the file handle <code>fd</code>.</p>
<blockquote>
<p>Editor&rsquo;s note: The idea here is that everything is a file, and Libevent&rsquo;s Read callback is not used here, so this FD is already passed to Envoy&rsquo;s system when it is created here.</p>
</blockquote>
<p>When we look further, the logic of the callback function here when we are actually receiving a network request is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ConnectionHandlerImpl</span><span class="o">::</span><span class="n">ActiveTcpListener</span><span class="o">::</span><span class="n">onAcceptWorker</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Network</span><span class="o">::</span><span class="n">ConnectionSocketPtr</span><span class="o">&amp;&amp;</span> <span class="n">socket</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">hand_off_restored_destination_connections</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">rebalanced</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">active_socket</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">ActiveTcpSocket</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                                         <span class="n">hand_off_restored_destination_connections</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Create and run the filters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">config_</span><span class="p">.</span><span class="n">filterChainFactory</span><span class="p">().</span><span class="n">createListenerFilterChain</span><span class="p">(</span><span class="o">*</span><span class="n">active_socket</span><span class="p">);</span> <span class="err">➀</span>
</span></span><span class="line"><span class="cl">  <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">continueFilterChain</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Move active_socket to the sockets_ list if filter iteration needs to continue later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Otherwise we let active_socket be destructed when it goes out of scope.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">iter_</span> <span class="o">!=</span> <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">accept_filters_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">startTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">active_socket</span><span class="o">-&gt;</span><span class="n">moveIntoListBack</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">active_socket</span><span class="p">),</span> <span class="n">sockets_</span><span class="p">);</span> <span class="err">➁</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>➀ FilterChain is created here for the socket.
➁ Press the socket into the queue to be processed, from here we can venture to assume that for the Socket that has established a connection with the server, Envoy will use a thread management similar to the Reactor pattern of the Netty type. That is, the receiving thread is the Listener, and the real Worker will get the working Socket from the List here.</p>
<p>Additional information:</p>
<ul>
<li><a href="https://gist.github.com/fxsjy/0170293e75eb53bbf007">libevent multithread worker example</a></li>
</ul>
<p>After another series of operations, we come to the place where we create a new connection (actually, it&rsquo;s more like assigning a new connection) ConnectionHandlerImpl::ActiveTcpListener::newConnection.</p>
<p>But here we still can&rsquo;t find the logic of Read, so we start Debug and we set a breakpoint at the read data <strong>ConnectionImpl::onRead</strong>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/cc9995a3987d4cf6a469f77c3c436847.png" alt="debug"></p>
<p>We still find that the starting point is still event_base_loop, so our question naturally becomes, where exactly is the event registered, because we know that the registration in is event_base object, we look by way of usage and find a suspicious point <strong>FileEventImpl:: assignEvents</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">FileEventImpl</span><span class="o">::</span><span class="n">assignEvents</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">events</span><span class="p">,</span> <span class="n">event_base</span><span class="o">*</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ASSERT</span><span class="p">(</span><span class="n">base</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">event_assign</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;</span><span class="n">raw_event_</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">fd_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">EV_PERSIST</span> <span class="o">|</span> <span class="p">(</span><span class="n">trigger_</span> <span class="o">==</span> <span class="n">FileTriggerType</span><span class="o">::</span><span class="n">Level</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">EV_ET</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">FileReadyType</span><span class="o">::</span><span class="n">Read</span> <span class="o">?</span> <span class="nl">EV_READ</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">FileReadyType</span><span class="o">::</span><span class="n">Write</span> <span class="o">?</span> <span class="nl">EV_WRITE</span> <span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">FileReadyType</span><span class="o">::</span><span class="n">Closed</span> <span class="o">?</span> <span class="nl">EV_CLOSED</span> <span class="p">:</span> <span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">[](</span><span class="n">evutil_socket_t</span><span class="p">,</span> <span class="kt">short</span> <span class="n">what</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span><span class="o">*</span> <span class="n">event</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">FileEventImpl</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ... skip something
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It looks like the event assignment is made here, we set a breakpoint and run it again. From the stack of calls, we can clearly see that</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/4d01cfdfa8d9424aa4003da92cbd79e4.png" alt="DEBUG"></p>
<p>In <code>OnAccpet</code> -&gt; <code>newConnection</code> -&gt; <code>AssignEvents</code> such a logic, just because the stack of the whole process is too deep for us to easily discover, the registration of events is created when the socket of the client is created. The rest of the registration logic is in the libevent section, so we won&rsquo;t go deeper.</p>
<h3 id="threading-model">Threading model</h3>
<p>First you can read the <a href="https://blog.envoyproxy.io/envoy-threading-model-a8d44b922310">Envoy threading model</a></p>
<p>In <code>Envoy</code> <code>Libevent</code> acts as a lower-level lib dependency, just like Tomcat when we write SpringWeb, for <code>Socket</code> events such as reads and writes are delegated to <code>Libevnet</code>. The first step is to create a Listen event for our Event_base. After that, when the connection is established, Envoy adds the listen for the Read/Write events of the socket.</p>
<blockquote>
<p>In fact, if you set a breakpoint at AssginEvents and then restart, the first event registered is for the read event of the configuration file (for hot update configuration), followed by the event registration of DNS, after which we start the Envoy service, and after that, we have to initialize the various Listener in the configuration file, but it is worth noting that LibeventScheduler::run is present in every Worker.</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/ba63b9fb602249c59f867baa4c59846c.png" alt="Envoy"></p>
<p>Unlike the processing of <code>Netty</code>, the Listener here is also distributed among all Threads. That is, when a new request is received, one of the workers is randomly selected for processing.</p>
<h2 id="chain-in-envoy">Chain in Envoy</h2>
<p>In the above, we already know that in the <code>Listen</code> event created by <code>ClientSocket</code>, we registered the <code>Read/Write</code> event of this <code>Socket</code> to <code>Event_Base</code>, and in the registered event, we easily locate <code>ConnectionImpl::onRead</code> This is where the read logic is.</p>
<h3 id="request-handling-chain">Request handling chain</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ConnectionImpl</span><span class="o">::</span><span class="n">onRead</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">read_buffer_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_enabled_</span> <span class="o">||</span> <span class="n">inDelayedClose</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">ASSERT</span><span class="p">(</span><span class="n">ioHandle</span><span class="p">().</span><span class="n">isOpen</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">read_buffer_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">read_end_stream_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">filter_manager_</span><span class="p">.</span><span class="n">onRead</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the last line, we get to the beginning of the entire process processing <code>FilterManager</code> to start the processing logic. In the next few jumps, we find out where the core of the processing logic lies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">FilterManagerImpl</span><span class="o">::</span><span class="n">onContinueReading</span><span class="p">(</span><span class="n">ActiveReadFilter</span><span class="o">*</span> <span class="n">filter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">ActiveReadFilterPtr</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">connection_</span><span class="p">.</span><span class="n">streamInfo</span><span class="p">().</span><span class="n">addBytesReceived</span><span class="p">(</span><span class="n">buffer_source</span><span class="p">.</span><span class="n">getReadBuffer</span><span class="p">().</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span> <span class="o">=</span> <span class="n">upstream_filters_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;</span> <span class="n">entry</span> <span class="o">!=</span> <span class="n">upstream_filters_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">initialized_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">FilterStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">filter_</span><span class="o">-&gt;</span><span class="n">onNewConnection</span><span class="p">();</span> <span class="err">➀</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span> <span class="o">||</span> <span class="n">connection_</span><span class="p">.</span><span class="n">state</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Connection</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">Open</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">StreamBuffer</span> <span class="n">read_buffer</span> <span class="o">=</span> <span class="n">buffer_source</span><span class="p">.</span><span class="n">getReadBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">read_buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">read_buffer</span><span class="p">.</span><span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">FilterStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">filter_</span><span class="o">-&gt;</span><span class="n">onData</span><span class="p">(</span><span class="n">read_buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">read_buffer</span><span class="p">.</span><span class="n">end_stream</span><span class="p">);</span> <span class="err">➁</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span> <span class="o">||</span> <span class="n">connection_</span><span class="p">.</span><span class="n">state</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Connection</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">Open</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>➀ For Envoy, it also specifies a series of abstract qualifications for the Fitler. For example, <code>Network::ReadFilter</code> defines a series of ReadFilter dummy functions, and we can see that at the first Filter, we call onNewConnection Here is necessarily a lifecycle callback function, as for the specifics we need to check the specific implementation class to determine.</p>
<p>➁ From here we find the logic of the real read data. From here because the focus of this article is on the processing of the Http protocol, we here at ReadFilter will also look at <code>Http::ConnectionManagerImpl</code> the implementation mechanism of this class.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">etwork</span><span class="o">::</span><span class="n">FilterStatus</span> <span class="n">ConnectionManagerImpl</span><span class="o">::</span><span class="n">onData</span><span class="p">(</span><span class="n">Buffer</span><span class="o">::</span><span class="n">Instance</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">redispatch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">redispatch</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">codec_</span><span class="o">-&gt;</span><span class="n">dispatch</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="c1">//将此数据分发出去
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">codec_</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">Protocol</span><span class="o">::</span><span class="n">Http2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">read_callbacks_</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">().</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">Network</span><span class="o">::</span><span class="n">Connection</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">Open</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">streams_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">redispatch</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">streams_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">streams_</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">state_</span><span class="p">.</span><span class="n">remote_complete_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">read_callbacks_</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">().</span><span class="n">readDisable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">redispatch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_callbacks_</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">().</span><span class="n">streamInfo</span><span class="p">().</span><span class="n">protocol</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">read_callbacks_</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">().</span><span class="n">streamInfo</span><span class="p">().</span><span class="n">protocol</span><span class="p">(</span><span class="n">codec_</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span><span class="p">;</span>  <span class="c1">// return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the process of implementation here, we at least found that envoy&rsquo;s Filter is not like Java&rsquo;s Fitler which is called layer by layer, each layer will only do its own thing, because from the code, we can find these because if the normal processing process, we should go through all the Fitler, so based on this logic, we can tell that in this <code>s</code> logic, we should just decode the HTTP, however, in the actual breakpoint, there is actually an optimization in this codec that when we Pase the HTTP request, the logic will be processed directly here, specifically jumping to the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ServerConnectionImpl</span><span class="o">::</span><span class="n">onMessageComplete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">active_request_</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">active_request</span> <span class="o">=</span> <span class="n">active_request_</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">active_request</span><span class="p">.</span><span class="n">remote_complete_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">deferred_end_stream_headers_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">active_request</span><span class="p">.</span><span class="n">request_decoder_</span><span class="o">-&gt;</span><span class="n">decodeHeaders</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">absl</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">RequestHeaderMapPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">headers_or_trailers_</span><span class="p">)),</span> <span class="nb">true</span><span class="p">);</span> <span class="err">➀</span>
</span></span><span class="line"><span class="cl">      <span class="n">deferred_end_stream_headers_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">processing_trailers_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">active_request</span><span class="p">.</span><span class="n">request_decoder_</span><span class="o">-&gt;</span><span class="n">decodeTrailers</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">absl</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">RequestTrailerMapPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">headers_or_trailers_</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Buffer</span><span class="o">::</span><span class="n">OwnedImpl</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">active_request</span><span class="p">.</span><span class="n">request_decoder_</span><span class="o">-&gt;</span><span class="n">decodeData</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Reset to ensure no information from one requests persists to the next.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">headers_or_trailers_</span><span class="p">.</span><span class="n">emplace</span><span class="o">&lt;</span><span class="n">RequestHeaderMapPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">http_parser_pause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser_</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At ➀ you will enter the Route stage (in fact, I think the design here is not very clear, resulting in having to resort to Debug tools during the reading process), where you finally enter the <code>ConfigImpl::route</code> logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">RouteConstSharedPtr</span> <span class="n">RouteMatcher</span><span class="o">::</span><span class="n">route</span><span class="p">(</span><span class="k">const</span> <span class="n">Http</span><span class="o">::</span><span class="n">RequestHeaderMap</span><span class="o">&amp;</span> <span class="n">headers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">const</span> <span class="n">StreamInfo</span><span class="o">::</span><span class="n">StreamInfo</span><span class="o">&amp;</span> <span class="n">stream_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="kt">uint64_t</span> <span class="n">random_value</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">VirtualHostImpl</span><span class="o">*</span> <span class="n">virtual_host</span> <span class="o">=</span> <span class="n">findVirtualHost</span><span class="p">(</span><span class="n">headers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">virtual_host</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">virtual_host</span><span class="o">-&gt;</span><span class="n">getRouteFromEntries</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">stream_info</span><span class="p">,</span> <span class="n">random_value</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next step in the processing logic is determined by whether or not the hit Route is returned. In the logic that follows, we follow the breakpoint to the</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ConnectionManagerImpl</span><span class="o">::</span><span class="n">ActiveStream</span><span class="o">::</span><span class="n">decodeHeaders</span><span class="p">(</span><span class="n">RequestHeaderMapPtr</span><span class="o">&amp;&amp;</span> <span class="n">headers</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// omit....
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">decodeHeaders</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="o">*</span><span class="n">request_headers_</span><span class="p">,</span> <span class="n">end_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Reset it here for both global and overridden cases.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">resetIdleTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>ConnectionManagerImpl::ActiveStream::decodeHeaders</code> code there is a lot of logic to deal with httpheader, here we do not expand, we enter, the most important decodeHeaders function to continue our exploration, in the logic here, we can find Here a very complex logic processing, we slowly look at.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Http</span><span class="o">::</span><span class="n">FilterHeadersStatus</span> <span class="n">Filter</span><span class="o">::</span><span class="n">decodeHeaders</span><span class="p">(</span><span class="n">Http</span><span class="o">::</span><span class="n">RequestHeaderMap</span><span class="o">&amp;</span> <span class="n">headers</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Determine if Route is owned or not, if not it is directly Return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">route_</span> <span class="o">=</span> <span class="n">callbacks_</span><span class="o">-&gt;</span><span class="n">route</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">route_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">config_</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">no_route_</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ENVOY_STREAM_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&#34;no cluster match for URL &#39;{}&#39;&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">callbacks_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">headers</span><span class="p">.</span><span class="n">Path</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">().</span><span class="n">getStringView</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">callbacks_</span><span class="o">-&gt;</span><span class="n">streamInfo</span><span class="p">().</span><span class="n">setResponseFlag</span><span class="p">(</span><span class="n">StreamInfo</span><span class="o">::</span><span class="n">ResponseFlag</span><span class="o">::</span><span class="n">NoRouteFound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">callbacks_</span><span class="o">-&gt;</span><span class="n">sendLocalReply</span><span class="p">(</span><span class="n">Http</span><span class="o">::</span><span class="n">Code</span><span class="o">::</span><span class="n">NotFound</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">modify_headers</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">nullopt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">StreamInfo</span><span class="o">::</span><span class="n">ResponseCodeDetails</span><span class="o">::</span><span class="n">get</span><span class="p">().</span><span class="n">RouteNotFound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Http</span><span class="o">::</span><span class="n">FilterHeadersStatus</span><span class="o">::</span><span class="n">StopIteration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Find the routing object for this request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">route_entry_</span> <span class="o">=</span> <span class="n">route_</span><span class="o">-&gt;</span><span class="n">routeEntry</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// Get the configured Cluster, which is actually the address of the target
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">cluster_</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Get a connection from upstream in order to get the host
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">upstream_http_protocol_options</span> <span class="o">=</span> <span class="n">cluster_</span><span class="o">-&gt;</span><span class="n">upstreamHttpProtocolOptions</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">Http</span><span class="o">::</span><span class="n">ConnectionPool</span><span class="o">::</span><span class="n">Instance</span><span class="o">*</span> <span class="n">http_pool</span> <span class="o">=</span> <span class="n">getHttpConnPool</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">Upstream</span><span class="o">::</span><span class="n">HostDescriptionConstSharedPtr</span> <span class="n">host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ENVOY_STREAM_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&#34;router decoding headers:</span><span class="se">\n</span><span class="s">{}&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">callbacks_</span><span class="p">,</span> <span class="n">headers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Push the data to be processed onto the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">modify_headers_</span> <span class="o">=</span> <span class="n">modify_headers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">UpstreamRequestPtr</span> <span class="n">upstream_request</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">UpstreamRequest</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">HttpConnPool</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">http_pool</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">upstream_request</span><span class="o">-&gt;</span><span class="n">moveIntoList</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">upstream_request</span><span class="p">),</span> <span class="n">upstream_requests_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">upstream_requests_</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">encodeHeaders</span><span class="p">(</span><span class="n">end_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">onRequestComplete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Http</span><span class="o">::</span><span class="n">FilterHeadersStatus</span><span class="o">::</span><span class="n">StopIteration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>upstream_requests_.front()-&gt;encodeHeaders(end_stream)</code>, there is a different step</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UpstreamRequest</span><span class="o">::</span><span class="n">encodeHeaders</span><span class="p">(</span><span class="kt">bool</span> <span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">encode_complete_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">encode_complete_</span> <span class="o">=</span> <span class="n">end_stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">conn_pool_</span><span class="o">-&gt;</span><span class="n">newStream</span><span class="p">(</span><span class="n">this</span><span class="p">);</span> <span class="err">➀</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>➀ Here we create a downstream connection. as we explore deeper into our code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">ConnPoolImplBase</span><span class="o">::</span><span class="n">ActiveClient</span><span class="o">::</span><span class="n">ActiveClient</span><span class="p">(</span><span class="n">ConnPoolImplBase</span><span class="o">&amp;</span> <span class="n">parent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="kt">uint64_t</span> <span class="n">lifetime_request_limit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="kt">uint64_t</span> <span class="n">concurrent_request_limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">parent_</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span> <span class="n">remaining_requests_</span><span class="p">(</span><span class="n">translateZeroToUnlimited</span><span class="p">(</span><span class="n">lifetime_request_limit</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">concurrent_request_limit_</span><span class="p">(</span><span class="n">translateZeroToUnlimited</span><span class="p">(</span><span class="n">concurrent_request_limit</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">      <span class="n">connect_timer_</span><span class="p">(</span><span class="n">parent_</span><span class="p">.</span><span class="n">dispatcher_</span><span class="p">.</span><span class="n">createTimer</span><span class="p">([</span><span class="n">this</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span> <span class="n">onConnectTimeout</span><span class="p">();</span> <span class="p">}))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Upstream</span><span class="o">::</span><span class="n">Host</span><span class="o">::</span><span class="n">CreateConnectionData</span> <span class="n">data</span> <span class="o">=</span> <span class="n">parent_</span><span class="p">.</span><span class="n">host_</span><span class="o">-&gt;</span><span class="n">createConnection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">parent_</span><span class="p">.</span><span class="n">dispatcher_</span><span class="p">,</span> <span class="n">parent_</span><span class="p">.</span><span class="n">socket_options_</span><span class="p">,</span> <span class="n">parent_</span><span class="p">.</span><span class="n">transport_socket_options_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">real_host_description_</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">host_description_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">codec_client_</span> <span class="o">=</span> <span class="n">parent_</span><span class="p">.</span><span class="n">createCodecClient</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">codec_client_</span><span class="o">-&gt;</span><span class="n">addConnectionCallbacks</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">conn_connect_ms_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Stats</span><span class="o">::</span><span class="n">HistogramCompletableTimespanImpl</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">parent_</span><span class="p">.</span><span class="n">host_</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">().</span><span class="n">stats</span><span class="p">().</span><span class="n">upstream_cx_connect_ms_</span><span class="p">,</span> <span class="n">parent_</span><span class="p">.</span><span class="n">dispatcher_</span><span class="p">.</span><span class="n">timeSource</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">conn_length_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Stats</span><span class="o">::</span><span class="n">HistogramCompletableTimespanImpl</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">parent_</span><span class="p">.</span><span class="n">host_</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">().</span><span class="n">stats</span><span class="p">().</span><span class="n">upstream_cx_length_ms_</span><span class="p">,</span> <span class="n">parent_</span><span class="p">.</span><span class="n">dispatcher_</span><span class="p">.</span><span class="n">timeSource</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">connect_timer_</span><span class="o">-&gt;</span><span class="n">enableTimer</span><span class="p">(</span><span class="n">parent_</span><span class="p">.</span><span class="n">host_</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">().</span><span class="n">connectTimeout</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see here that I&rsquo;m actually going to create a downstream connection. But we know that for a high-performance WebServer, we can&rsquo;t Blocking for downstream access, so our common processing capability should be to hang the downstream request after it is established, and we wait for the return of the downstream before processing it, so later we can find that</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">ConnectionImpl</span><span class="o">::</span><span class="n">ConnectionImpl</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">Dispatcher</span><span class="o">&amp;</span> <span class="n">dispatcher</span><span class="p">,</span> <span class="n">ConnectionSocketPtr</span><span class="o">&amp;&amp;</span> <span class="n">socket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">TransportSocketPtr</span><span class="o">&amp;&amp;</span> <span class="n">transport_socket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">StreamInfo</span><span class="o">::</span><span class="n">StreamInfo</span><span class="o">&amp;</span> <span class="n">stream_info</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">connected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">ConnectionImplBase</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">next_global_id_</span><span class="o">++</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// We never ask for both early close and read at the same time. If we are reading, we want to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// consume all available data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">file_event_</span> <span class="o">=</span> <span class="n">dispatcher_</span><span class="p">.</span><span class="n">createFileEvent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">ioHandle</span><span class="p">().</span><span class="n">fd</span><span class="p">(),</span> <span class="p">[</span><span class="n">this</span><span class="p">](</span><span class="kt">uint32_t</span> <span class="n">events</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span> <span class="n">onFileEvent</span><span class="p">(</span><span class="n">events</span><span class="p">);</span> <span class="p">},</span> <span class="n">trigger</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">Event</span><span class="o">::</span><span class="n">FileReadyType</span><span class="o">::</span><span class="n">Read</span> <span class="o">|</span> <span class="n">Event</span><span class="o">::</span><span class="n">FileReadyType</span><span class="o">::</span><span class="n">Write</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">transport_socket_</span><span class="o">-&gt;</span><span class="n">setTransportSocketCallbacks</span><span class="p">(</span><span class="o">*</span><span class="n">this</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we create the downstream link, we register the <code>Read</code> and <code>Write</code> events of the downstream reply data to the <code>Event_Base</code> of the current <code>Worker</code> thread. Let&rsquo;s take a look at the whole flow of the first half here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">// ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Up to the above, we have gone through most of the process from receiving the request to creating the request to the downstream, after which there are some other transactional ones that need to be handled, such as response timeout, etc. Without going too deep, we move to the next link: the response data processing link.</p>
<h3 id="response-data-processing-link">Response data processing link</h3>
<p>For the response data, we also know that after we finish the execution, we load the subsequent read and write events to BackendSteam into <code>EventBase</code> Let&rsquo;s see how the subsequent data is handled, the entrance is still the <code>OnRead()</code> function, and the logic after that is similar to the previous one, until <code>FilterManagerImpl:: onRead</code> is called after the specific implementation class is <code>CodecClient</code> will be relatively simple after all, because the response body we do not need to do any more routing settings and other operations, and then when we finish reading, we enter the <code>ConnectionImpl::onMessageCompleteBase</code> function, and enter the end of the process. Let&rsquo;s see how we respond to the initial caller when we&rsquo;ve finished reading all the data from the response stream. Then it goes to <code>ClientConnectionImpl::onMessageComplete</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ClientConnectionImpl</span><span class="o">::</span><span class="n">onMessageComplete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ENVOY_CONN_LOG</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s">&#34;message complete&#34;</span><span class="p">,</span> <span class="n">connection_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pending_response_</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// 当We only process when we have a pending Responses
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">connection_</span><span class="p">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">Network</span><span class="o">::</span><span class="n">Connection</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">Open</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">connection_</span><span class="p">.</span><span class="n">readEnabled</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">connection_</span><span class="p">.</span><span class="n">readDisable</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span> <span class="c1">// Let the connection disable reads because it is going to write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">deferred_end_stream_headers_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">response</span><span class="p">.</span><span class="n">decoder_</span><span class="o">-&gt;</span><span class="n">decodeHeaders</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">absl</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">ResponseHeaderMapPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">headers_or_trailers_</span><span class="p">)),</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">deferred_end_stream_headers_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">processing_trailers_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">response</span><span class="p">.</span><span class="n">decoder_</span><span class="o">-&gt;</span><span class="n">decodeTrailers</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">absl</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">ResponseTrailerMapPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">headers_or_trailers_</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Buffer</span><span class="o">::</span><span class="n">OwnedImpl</span> <span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">response</span><span class="p">.</span><span class="n">decoder_</span><span class="o">-&gt;</span><span class="n">decodeData</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="c1">//Write data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Reset to ensure no information from one requests persists to the next.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pending_response_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">headers_or_trailers_</span><span class="p">.</span><span class="n">emplace</span><span class="o">&lt;</span><span class="n">ResponseHeaderMapPtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>During the response, <code>decodeData</code> is called and eventually returns to <code>ConnectionMangerImpl</code>, and then in a series of operations, we come to the place where we finally write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ConnectionImpl</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">Buffer</span><span class="o">::</span><span class="n">Instance</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">end_stream</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">through_filter_chain</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">end_stream</span> <span class="o">||</span> <span class="n">enable_half_close_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">write_end_stream_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ASSERT</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">end_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">through_filter_chain</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_write_buffer_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_write_end_stream_</span> <span class="o">=</span> <span class="n">end_stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FilterStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">filter_manager_</span><span class="p">.</span><span class="n">onWrite</span><span class="p">();</span> <span class="c1">// ➀ 这里进入了写入流的 FilterChain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">current_write_buffer_</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">FilterStatus</span><span class="o">::</span><span class="n">StopIteration</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 值得注意的是这里是可以提前终结
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">write_end_stream_</span> <span class="o">=</span> <span class="n">end_stream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">end_stream</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ENVOY_CONN_LOG</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s">&#34;writing {} bytes, end_stream {}&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">(),</span> <span class="n">end_stream</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_buffer_</span><span class="o">-&gt;</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="c1">// ➁ 将数据流写入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connecting_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">ASSERT</span><span class="p">(</span><span class="n">file_event_</span> <span class="o">!=</span> <span class="n">nullptr</span><span class="p">,</span> <span class="s">&#34;ConnectionImpl file event was unexpectedly reset&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">file_event_</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">(</span><span class="n">Event</span><span class="o">::</span><span class="n">FileReadyType</span><span class="o">::</span><span class="n">Write</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After all our data has been written, we enter the final <code>Cleanup</code> process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ConnectionImpl</span><span class="o">::</span><span class="n">closeSocket</span><span class="p">(</span><span class="n">ConnectionEvent</span> <span class="n">close_type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="n">ENVOY_CONN_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&#34;closing socket: {}&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">close_type</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">transport_socket_</span><span class="o">-&gt;</span><span class="n">closeSocket</span><span class="p">(</span><span class="n">close_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Drain input and output buffers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">updateReadBufferStats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">updateWriteBufferStats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">write_buffer_</span><span class="o">-&gt;</span><span class="n">drain</span><span class="p">(</span><span class="n">write_buffer_</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">connection_stats_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">file_event_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">socket_</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">raiseEvent</span><span class="p">(</span><span class="n">close_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is the end of a paragraph, we will organize the whole process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">// ...
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="envoy-extend">Envoy Extend</h2>
<p>From the analysis above, we have sort of read through the main implementation part of the code, leaving us to look at the part of Envoy that sets aside extensions for us. <a href="https://www.envoyproxy.io/docs/envoy/v1.14.1/extending/extending">Extending Envoy for custom use cases</a>, from the configuration file, we can also get some inspiration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">static_resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">listeners</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">listener_0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">address: 127.0.0.1, port_value</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">filter_chains</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.filters.network.http_connection_manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">typed_config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">&#34;@type&#34;: </span><span class="l">type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">stat_prefix</span><span class="p">:</span><span class="w"> </span><span class="l">ingress_http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">codec_type</span><span class="p">:</span><span class="w"> </span><span class="l">AUTO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">route_config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">virtual_hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local_service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="nt">domains</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;*&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/&#34;</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="nt">route</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l">some_service }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">http_filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.filters.http.router</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We can find that the most important part for Envoy is FilterChains, although we have not written CPP, but from the similarity of ideas, we should be able to expand the implementation of Filter, and then registered to this FilterChians, fortunately for the official, provide a more detailed <a href="https://github.com/envoyproxy/envoy-filter-example">DEMO</a>. As you can see from it, our core is to inherit the Interface of the Fitler that is already there and then implement it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">namespace</span> <span class="n">Envoy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">namespace</span> <span class="n">Filter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Implementation of a basic echo filter.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">class</span> <span class="nl">Echo2</span> <span class="p">:</span> <span class="n">public</span> <span class="n">Network</span><span class="o">::</span><span class="n">ReadFilter</span><span class="p">,</span> <span class="n">Logger</span><span class="o">::</span><span class="n">Loggable</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">filter</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">public</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Network::ReadFilter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span> <span class="n">onData</span><span class="p">(</span><span class="n">Buffer</span><span class="o">::</span><span class="n">Instance</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">end_stream</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span> <span class="n">onNewConnection</span><span class="p">()</span> <span class="n">override</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Network</span><span class="o">::</span><span class="n">FilterStatus</span><span class="o">::</span><span class="n">Continue</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initializeReadFilterCallbacks</span><span class="p">(</span><span class="n">Network</span><span class="o">::</span><span class="n">ReadFilterCallbacks</span><span class="o">&amp;</span> <span class="n">callbacks</span><span class="p">)</span> <span class="n">override</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">read_callbacks_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">callbacks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">private</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">Network</span><span class="o">::</span><span class="n">ReadFilterCallbacks</span><span class="o">*</span> <span class="n">read_callbacks_</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">// namespace Filter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="c1">// namespace Envoy
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>It is also relatively easy to use.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">static_resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster_0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">connect_timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0.</span><span class="l">25s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">load_assignment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="l">cluster_0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">lb_endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">socket_address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="nt">port_value</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>But behind the scenes, how does the mechanism of this work? We still need to come from the source code. The existing <code>Extensions</code> implementation can be found here <a href="https://github.com/envoyproxy/envoy/tree/v1.14.1/source/extensions">extensions</a></p>
<p>From the code above, we can easily locate the logic to initialize the <code>FilterChain</code> at <code>ListenerImpl::createNetworkFilterChain</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">ListenerImpl</span><span class="o">::</span><span class="n">createNetworkFilterChain</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Network</span><span class="o">::</span><span class="n">Connection</span><span class="o">&amp;</span> <span class="n">connection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Network</span><span class="o">::</span><span class="n">FilterFactoryCb</span><span class="o">&gt;&amp;</span> <span class="n">filter_factories</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Configuration</span><span class="o">::</span><span class="n">FilterChainUtility</span><span class="o">::</span><span class="n">buildFilterChain</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">filter_factories</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, it is a very standard factory pattern. Depending on the factory, we will create different Filter instances, and after the creation, if it is ReaderFliter, it will be directly added to the bottom of upsteam, and if it is WriterFliter, it will be added to the bottom of downsteam. The code is also relatively simple, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">FilterManagerImpl</span><span class="o">::</span><span class="n">addReadFilter</span><span class="p">(</span><span class="n">ReadFilterSharedPtr</span> <span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ASSERT</span><span class="p">(</span><span class="n">connection_</span><span class="p">.</span><span class="n">state</span><span class="p">()</span> <span class="o">==</span> <span class="n">Connection</span><span class="o">::</span><span class="n">State</span><span class="o">::</span><span class="n">Open</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">ActiveReadFilterPtr</span> <span class="nf">new_filter</span><span class="p">(</span><span class="n">new</span> <span class="n">ActiveReadFilter</span><span class="p">{</span><span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">filter</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">filter</span><span class="o">-&gt;</span><span class="n">initializeReadFilterCallbacks</span><span class="p">(</span><span class="o">*</span><span class="n">new_filter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">new_filter</span><span class="o">-&gt;</span><span class="n">moveIntoListBack</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_filter</span><span class="p">),</span> <span class="n">upstream_filters_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then the problem becomes our <code>Filter_Factory</code> from which we find two implementations from the virtual table <code>Admin</code> &amp; <code>Impl</code>, if you have read the official website documentation you should be able to guess that the <code>Admin</code> implementation is based on dynamic requests. I&rsquo;d better restart and trace the process from the beginning. Initializing FilterFactory can be located at the earliest to <code>ListenerManagerImpl::addOrUpdateListener</code> and the profile hierarchy is similar, we create Listerner from the first, in the process of creating <code>Listener</code> we create <code>FilterChain</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">filter_chain_manager_</span><span class="p">.</span><span class="n">addFilterChain</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">filter_chains</span><span class="p">(),</span> <span class="n">builder</span><span class="p">,</span> <span class="n">filter_chain_manager_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">FilterChainManagerImpl</span><span class="o">::</span><span class="n">addFilterChain</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">absl</span><span class="o">::</span><span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">listener</span><span class="o">::</span><span class="n">v3</span><span class="o">::</span><span class="n">FilterChain</span><span class="o">*</span> <span class="k">const</span><span class="o">&gt;</span> <span class="n">filter_chain_span</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">FilterChainFactoryBuilder</span><span class="o">&amp;</span> <span class="n">filter_chain_factory_builder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">FilterChainFactoryContextCreator</span><span class="o">&amp;</span> <span class="n">context_creator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Cleanup</span> <span class="n">cleanup</span><span class="p">([</span><span class="n">this</span><span class="p">]()</span> <span class="p">{</span> <span class="n">origin_</span> <span class="o">=</span> <span class="n">absl</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">envoy</span><span class="o">::</span><span class="n">config</span><span class="o">::</span><span class="n">listener</span><span class="o">::</span><span class="n">v3</span><span class="o">::</span><span class="n">FilterChainMatch</span><span class="p">,</span> <span class="n">MessageUtil</span><span class="p">,</span> <span class="n">MessageUtil</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="n">filter_chains</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">new_filter_chain_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">filter_chain</span> <span class="p">:</span> <span class="n">filter_chain_span</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">filter_chain_match</span> <span class="o">=</span> <span class="n">filter_chain</span><span class="o">-&gt;</span><span class="n">filter_chain_match</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter_chain_match</span><span class="p">.</span><span class="n">address_suffix</span><span class="p">().</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">has_suffix_len</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw</span> <span class="n">EnvoyException</span><span class="p">(</span><span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;error adding listener &#39;{}&#39;: contains filter chains with &#34;</span>
</span></span><span class="line"><span class="cl">                                       <span class="s">&#34;unimplemented fields&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">address_</span><span class="o">-&gt;</span><span class="n">asString</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">filter_chains</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">filter_chain_match</span><span class="p">)</span> <span class="o">!=</span> <span class="n">filter_chains</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw</span> <span class="n">EnvoyException</span><span class="p">(</span><span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;error adding listener &#39;{}&#39;: multiple filter chains with &#34;</span>
</span></span><span class="line"><span class="cl">                                       <span class="s">&#34;the same matching rules are defined&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">address_</span><span class="o">-&gt;</span><span class="n">asString</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">filter_chains</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">filter_chain_match</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Validate IP addresses.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">destination_ips</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">destination_ips</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">filter_chain_match</span><span class="p">.</span><span class="n">prefix_ranges</span><span class="p">().</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">destination_ip</span> <span class="p">:</span> <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">prefix_ranges</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cidr_range</span> <span class="o">=</span> <span class="n">Network</span><span class="o">::</span><span class="n">Address</span><span class="o">::</span><span class="n">CidrRange</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">destination_ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">destination_ips</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cidr_range</span><span class="p">.</span><span class="n">asString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">source_ips</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">source_ips</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">filter_chain_match</span><span class="p">.</span><span class="n">source_prefix_ranges</span><span class="p">().</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">source_ip</span> <span class="p">:</span> <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">source_prefix_ranges</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cidr_range</span> <span class="o">=</span> <span class="n">Network</span><span class="o">::</span><span class="n">Address</span><span class="o">::</span><span class="n">CidrRange</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">source_ip</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">source_ips</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cidr_range</span><span class="p">.</span><span class="n">asString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Reject partial wildcards, we don&#39;t match on them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">server_name</span> <span class="p">:</span> <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">server_names</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">server_name</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="o">!</span><span class="n">FilterChainManagerImpl</span><span class="o">::</span><span class="n">isWildcardServerName</span><span class="p">(</span><span class="n">server_name</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">EnvoyException</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;error adding listener &#39;{}&#39;: partial wildcards are not supported in &#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">server_names</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">address_</span><span class="o">-&gt;</span><span class="n">asString</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Reuse created filter chain if possible.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// FilterChainManager maintains the lifetime of FilterChainFactoryContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ListenerImpl maintains the dependencies of FilterChainFactoryContext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">filter_chain_impl</span> <span class="o">=</span> <span class="n">findExistingFilterChain</span><span class="p">(</span><span class="o">*</span><span class="n">filter_chain</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">filter_chain_impl</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">filter_chain_impl</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">filter_chain_factory_builder</span><span class="p">.</span><span class="n">buildFilterChain</span><span class="p">(</span><span class="o">*</span><span class="n">filter_chain</span><span class="p">,</span> <span class="n">context_creator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">new_filter_chain_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">addFilterChainForDestinationPorts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">destination_ports_map_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">PROTOBUF_GET_WRAPPED_OR_DEFAULT</span><span class="p">(</span><span class="n">filter_chain_match</span><span class="p">,</span> <span class="n">destination_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">destination_ips</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">server_names</span><span class="p">(),</span> <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">transport_protocol</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">application_protocols</span><span class="p">(),</span> <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">source_type</span><span class="p">(),</span> <span class="n">source_ips</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">filter_chain_match</span><span class="p">.</span><span class="n">source_ports</span><span class="p">(),</span> <span class="n">filter_chain_impl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fc_contexts_</span><span class="p">[</span><span class="o">*</span><span class="n">filter_chain</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_chain_impl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">convertIPsToTries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">ENVOY_LOG</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&#34;new fc_contexts has {} filter chains, including {} newly built&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">fc_contexts_</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">new_filter_chain_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="envoy-admin">Envoy Admin</h2>
<p>When we build the Example, there is a paragraph.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">admin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">access_log_path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp/admin_access.log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">socket_address</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">address: 127.0.0.1, port_value</span><span class="p">:</span><span class="w"> </span><span class="m">9901</span><span class="w"> </span>}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>is the administrative port for Enovy. It mainly provides a series of statistics, etc. See <a href="https://www.envoyproxy.io/docs/envoy/v1.14.1/operations/admin">Envoy-Admin</a> for details</p>
<h2 id="envoy-dynamic-manager">Envoy Dynamic Manager</h2>
<p>We analyzed the simple process of reading from a file, but for a full-fledged gateway, the type of dynamically loaded data is indispensable, so Envoy also provides several capabilities to dynamically obtain configurations, such as <code>LDS</code>, <code>XDS</code>, etc.</p>
<h3 id="lds">LDS</h3>
<blockquote>
<p>The listener discovery service (LDS) is an optional API that Envoy will call to dynamically fetch listeners. Envoy will reconcile the API response and add, modify, or remove known listeners depending on what is required.</p>
</blockquote>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/temporal/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Temporal: Microservice workflow orchestration using a familiar programming language</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/isito-vm-health-check/">
            <span class="next-text nav-default">Isito Virtual Machine Health Check</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
