<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Why floating-point arithmetic is inaccurate - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the reasons why floating-point operations are inaccurate." /><meta name="keywords" content="floating-point arithmetic, inaccurate" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/floating-point-inaccurate/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Why floating-point arithmetic is inaccurate" />
<meta property="og:description" content="Explore the reasons why floating-point operations are inaccurate." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/floating-point-inaccurate/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-01T09:52:51+08:00" />
<meta property="article:modified_time" content="2022-08-01T09:52:51+08:00" />

<meta itemprop="name" content="Why floating-point arithmetic is inaccurate">
<meta itemprop="description" content="Explore the reasons why floating-point operations are inaccurate."><meta itemprop="datePublished" content="2022-08-01T09:52:51+08:00" />
<meta itemprop="dateModified" content="2022-08-01T09:52:51+08:00" />
<meta itemprop="wordCount" content="1434">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Why floating-point arithmetic is inaccurate"/>
<meta name="twitter:description" content="Explore the reasons why floating-point operations are inaccurate."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Why floating-point arithmetic is inaccurate</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-01 09:52:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1434 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#verify">Verify</a></li>
        <li><a href="#verify-a-little-deeper">Verify a little deeper</a></li>
        <li><a href="#the-principle-of-floating-point-numbers">The Principle of Floating Point Numbers</a></li>
        <li><a href="#in-depth-understanding-of-floating-point-representation">In-depth understanding of floating-point representation</a></li>
        <li><a href="#subtraction-of-floating-point-numbers">Subtraction of floating point numbers</a></li>
        <li><a href="#reasons-for-accuracy-problems">Reasons for accuracy problems</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="verify">Verify</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="mf">0.3</span><span class="o">-</span><span class="mf">0.2</span>
</span></span><span class="line"><span class="cl"><span class="mf">0.09999999999999998</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;&gt;&gt;</span> <span class="mf">0.2</span><span class="o">-</span><span class="mf">0.1</span>
</span></span><span class="line"><span class="cl"><span class="mf">0.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="verify-a-little-deeper">Verify a little deeper</h2>
<p>First write the tool. Write a function to display 64-bit 8-byte binary data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">byte2bin</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">o</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">g</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">g</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">        <span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">08b</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">byte2bin</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">01100001 01100010 01100011 01100100 01100101 01100110 01100111 01101000
</span></span><span class="line"><span class="cl">01101001 01101010 01101011 01101100 01101101 01101110 01101111 01110000
</span></span><span class="line"><span class="cl">01110001 01110010 01110011 01110100 01110101 01110110 01110111 01111000
</span></span><span class="line"><span class="cl">01111001 01111010
</span></span></code></pre></td></tr></table>
</div>
</div><p>The data is then converted to binary data, paying attention to the byte order (Endianness).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">byte2bin</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;h&#39;</span><span class="p">,</span> <span class="mi">16385</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">byte2bin</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;h&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">16383</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">01000000 00000001
</span></span><span class="line"><span class="cl">11000000 00000001
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, verify again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_double</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">byte2bin</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;d&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl"><span class="n">show_double</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">b</span> <span class="o">=</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl"><span class="n">show_double</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="o">-</span><span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="n">show_double</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="mf">0.3</span>
</span></span><span class="line"><span class="cl"><span class="n">show_double</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">e</span> <span class="o">=</span> <span class="n">d</span><span class="o">-</span><span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="n">show_double</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="n">a</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0.1
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span><span class="line"><span class="cl">0.2
</span></span><span class="line"><span class="cl">00111111 11001001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span><span class="line"><span class="cl">0.1
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span><span class="line"><span class="cl">True
</span></span><span class="line"><span class="cl">0.3
</span></span><span class="line"><span class="cl">00111111 11010011 00110011 00110011 00110011 00110011 00110011 00110011
</span></span><span class="line"><span class="cl">0.09999999999999998
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011000
</span></span><span class="line"><span class="cl">False
</span></span></code></pre></td></tr></table>
</div>
</div><p>As can be seen, the result of 0.2-0.1 is binary indistinguishable from 0.1. the result of 0.3-0.2 is binary significantly different from 0.1. the end of 0.1 is 1010 and the result of 0.3-0.2 is 1000.</p>
<h2 id="the-principle-of-floating-point-numbers">The Principle of Floating Point Numbers</h2>
<p>Binary floating point numbers are related to decimal decimals in the same way that binary integers are related to decimal integers.</p>
<ul>
<li>In the integer representation system, the leftmost digit indicates the size of the number from 0-9, and when the concept of &ldquo;10&rdquo; is needed, 0-9 is actually written second from the left to indicate how many &ldquo;10s&rdquo; there are. And so on.</li>
<li>In the decimal representation system, the rightmost digit indicates how many &ldquo;1‚ÅÑ10&rdquo; there are. And so on.</li>
</ul>
<p>Why do we express it this way? Because in this way, &ldquo;shift operation&rdquo; and &ldquo;multiply by 10&rdquo; are linked. Also, addition and subtraction can be done in bits.</p>
<ul>
<li>
<p>909*10 = 9090</p>
</li>
<li>
<p>909 shifted one place to the left = 1010</p>
</li>
<li>
<p>909+101 = 1010, specifically (9+1), (0+0), (9+1), and finally rounding from right to left</p>
</li>
<li>
<p>90.9*10 = 909</p>
</li>
<li>
<p>90.9 + 99.99 = 190.89, specifically (9 + 9), (0 + 9), decimal point, (9 + 9), (0 + 9), and finally right-to-left rounding</p>
</li>
<li>
<p>There is nothing special about adding decimal numbers and adding integers except that the decimal places are aligned</p>
</li>
<li>
<p>expression of <code>90.9 + 99.99 = 190.89</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">90.90
</span></span><span class="line"><span class="cl">99.99
</span></span><span class="line"><span class="cl">------
</span></span><span class="line"><span class="cl">190.89
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>Similarly, binary integers and floating point numbers have the same pattern.</p>
<ul>
<li>
<p>0b101*0b10 = 0b1010</p>
</li>
<li>
<p>0b101 shifted one place left = 0b1010</p>
</li>
<li>
<p>0b101+0b11 = 0b1000, the specific operation is (1+0), (0+1), (1+1), and finally rounded from right to left</p>
</li>
<li>
<p>0b101.101*0b10 = 0b1011.01. Note that 0b101.101 is not a qualified representation in computers, but the reader should be able to understand its meaning</p>
</li>
<li>
<p>0b101.101 + 0b110.11 = 0b1100.011</p>
</li>
<li>
<p>The above equation may not be very good, so let&rsquo;s switch back to decimal and see. 5.625 + 6.75 = 12.375, which is exactly right.</p>
</li>
<li>
<p>expression of <code>0b101.101+0b110.11 = 0b1100.011</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0b101.101
</span></span><span class="line"><span class="cl">0b110.110
</span></span><span class="line"><span class="cl">----------
</span></span><span class="line"><span class="cl">0b1100.011
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="in-depth-understanding-of-floating-point-representation">In-depth understanding of floating-point representation</h2>
<p>Please see for yourself <a href="https://zh.m.wikipedia.org/zh/IEEE_754">here</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">scale_ieee754d</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># https://zh.m.wikipedia.org/zh/IEEE_754</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_double</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">scale_ieee754d</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">byte2bin</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;d&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output is as follows (the equality judgment is omitted).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0.1
</span></span><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span><span class="line"><span class="cl">0.2
</span></span><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 11001001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span><span class="line"><span class="cl">0.1
</span></span><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span><span class="line"><span class="cl">0.3
</span></span><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 11010011 00110011 00110011 00110011 00110011 00110011 00110011
</span></span><span class="line"><span class="cl">0.09999999999999998
</span></span><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011000
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the trailing part of 0.2 and 0.1 are strictly the same, and the only difference between them is the exponent part. 0.3 is completely different from both.</p>
<h2 id="subtraction-of-floating-point-numbers">Subtraction of floating point numbers</h2>
<p>First of all it is still necessary to have a tool function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">str2bin</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">b</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;0b&#39;</span><span class="o">+</span><span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;d&#39;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;Q&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">str2bin</span><span class="p">(</span><span class="s1">&#39;00111111 11010011 00110011 00110011 00110011 00110011 00110011 00110011&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We then look at 0.3-0.2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 11010011 00110011 00110011 00110011 00110011 00110011 00110011
</span></span><span class="line"><span class="cl">00111111 11001001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span></code></pre></td></tr></table>
</div>
</div><p>These two numbers can be reversed and dropped back into str2bin to verify that they are correct.</p>
<p>The first step is to return to the complete form. The so-called &ldquo;complete form&rdquo; is because the first digit is 1 in the statute form, so we need to make up the 1 before the operation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeee fffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 1101 10011 00110011 00110011 00110011 00110011 00110011 00110011
</span></span><span class="line"><span class="cl">00111111 1100 11001 10011001 10011001 10011001 10011001 10011001 10011010
</span></span></code></pre></td></tr></table>
</div>
</div><p>Step 2 alignment. The exponential part of 0.3 is a little larger than 0.2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeee fffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffff
</span></span><span class="line"><span class="cl">00111111 1101 10011 00110011 00110011 00110011 00110011 00110011 00110011
</span></span><span class="line"><span class="cl">00111111 1101 01100 11001100 11001100 11001100 11001100 11001100 110011010
</span></span></code></pre></td></tr></table>
</div>
</div><p>The third step is the subtraction of the trailing part.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeee fffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffff
</span></span><span class="line"><span class="cl">00111111 1101 10011 00110011 00110011 00110011 00110011 00110011 00110011
</span></span><span class="line"><span class="cl">00111111 1101 01100 11001100 11001100 11001100 11001100 11001100 110011010
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">00111111 1101 00110 01100110 01100110 01100110 01100110 01100110 011001100
</span></span></code></pre></td></tr></table>
</div>
</div><p>The fourth step is to raise the alignment. Because the highest bit of the result of the operation is not 1, so it needs to be aligned by raising the bit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeee fffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffff
</span></span><span class="line"><span class="cl">00111111 1101 00110 01100110 01100110 01100110 01100110 01100110 011001100
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">seeeeeee eeee fff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffff
</span></span><span class="line"><span class="cl">00111111 1011 110 01100110 01100110 01100110 01100110 01100110 011001100
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the fifth step, the regression form is replaced by omitting the highest 1 and adding 0 at the end.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeee fff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffff
</span></span><span class="line"><span class="cl">00111111 1011 110 01100110 01100110 01100110 01100110 01100110 011001100
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">seeeeeee eeee ff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffff
</span></span><span class="line"><span class="cl">00111111 1011 10 01100110 01100110 01100110 01100110 01100110 011001100
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">seeeeeee eeee ffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffff
</span></span><span class="line"><span class="cl">00111111 1011 1001 10011001 10011001 10011001 10011001 10011001 10011000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below, we move down the calculation of 0.3-0.2 above and compare it with the result just calculated manually.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">seeeeeee eeeeffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011000
</span></span><span class="line"><span class="cl">-----------------------------------------------------------------------
</span></span><span class="line"><span class="cl">00111111 10111001 10011001 10011001 10011001 10011001 10011001 10011000
</span></span></code></pre></td></tr></table>
</div>
</div><p>Exactly the same.</p>
<h2 id="reasons-for-accuracy-problems">Reasons for accuracy problems</h2>
<p>First of all, we see that after the above subtraction operation is done, the 0 at the end of the last is filled in. That is, the precision of the final data is not enough to fill the effective trailing space.</p>
<p>This is because in floating point mode, the data only provides the &ldquo;most significant part&rdquo; of the data. The general logic is that when a data has 200 bits, it does not matter if the last bit is 0 or 5. As long as the first 190 bits are correct.</p>
<p>In this case, it is easy to get a &ldquo;precision deficient&rdquo; difference by subtracting two large numbers that are close together. For example.</p>
<ul>
<li><code>10000002.0-1000000001.0 = 1.0</code>, which is easy to understand.</li>
<li><code>10000000002.0-10000000001.0 = 1.0</code>, also very understandable.</li>
<li><code>100000000000000000002.0-100000000000000000001.0 = 2.0</code>, which is completely incomprehensible.</li>
</ul>
<p>In fact, using floating-point numbers for computation, as long as there are enough zeros in front, the last subtle data part (none of which need to be decimal) must be a problem.</p>
<h2 id="conclusion">Conclusion</h2>
<ol>
<li>the results of floating-point operations, to determine the equal when you use the &ldquo;difference between the two less than one top value&rdquo; approach.</li>
<li>When it comes to money, please use decimal.</li>
</ol>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/go-rpc-frameworks/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">2022 Go Ecosystem rpc Framework Benchmark</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/rust-pin-advanced/">
            <span class="next-text nav-default">Rust Pin Advanced</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
