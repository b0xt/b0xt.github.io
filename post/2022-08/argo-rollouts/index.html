<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Implementing Progressive Release with Argo Rollouts - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Argo Rollouts to implement progressive releases." /><meta name="keywords" content="Argo Rollouts, Progressive Release" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/argo-rollouts/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Implementing Progressive Release with Argo Rollouts" />
<meta property="og:description" content="Learn how to use Argo Rollouts to implement progressive releases." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/argo-rollouts/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-22T09:28:51+08:00" />
<meta property="article:modified_time" content="2022-08-22T09:28:51+08:00" />

<meta itemprop="name" content="Implementing Progressive Release with Argo Rollouts">
<meta itemprop="description" content="Learn how to use Argo Rollouts to implement progressive releases."><meta itemprop="datePublished" content="2022-08-22T09:28:51+08:00" />
<meta itemprop="dateModified" content="2022-08-22T09:28:51+08:00" />
<meta itemprop="wordCount" content="4944">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementing Progressive Release with Argo Rollouts"/>
<meta name="twitter:description" content="Learn how to use Argo Rollouts to implement progressive releases."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Implementing Progressive Release with Argo Rollouts</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-22 09:28:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4944 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#implementation-principle">Implementation Principle</a></li>
        <li><a href="#related-concepts">Related Concepts</a>
          <ul>
            <li><a href="#rollout">Rollout</a></li>
            <li><a href="#progressive-delivery">Progressive Delivery</a></li>
            <li><a href="#deployment-strategies">Deployment Strategies</a></li>
          </ul>
        </li>
        <li><a href="#architecture">Architecture</a>
          <ul>
            <li><a href="#rollout-controller">Rollout Controller</a></li>
            <li><a href="#rollout-resources">Rollout Resources</a></li>
            <li><a href="#old-and-new-versions-of-replicasets">Old and new versions of ReplicaSets</a></li>
            <li><a href="#ingressservice">Ingress/Service</a></li>
            <li><a href="#analysis-and-analysisrun">Analysis and AnalysisRun</a></li>
            <li><a href="#metric-providers">Metric Providers</a></li>
            <li><a href="#cli-and-ui">CLI and UI</a></li>
          </ul>
        </li>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#usage">Usage</a>
          <ul>
            <li><a href="#1-deploying-rollout">1. Deploying Rollout</a></li>
            <li><a href="#2-update-rollout">2. Update Rollout</a></li>
            <li><a href="#3-promote-rollout">3. Promote Rollout</a></li>
            <li><a href="#4-interrupting-rollout">4. Interrupting Rollout</a></li>
          </ul>
        </li>
        <li><a href="#dashboard">Dashboard</a></li>
        <li><a href="#analysis-and-progressive-interaction">Analysis and Progressive Interaction</a>
          <ul>
            <li><a href="#background-analytics">Background Analytics</a></li>
            <li><a href="#inline-analysis">Inline Analysis</a></li>
            <li><a href="#multiple-templates-for-analysis">Multiple templates for analysis</a></li>
            <li><a href="#analysis-template-parameters">Analysis Template Parameters</a></li>
            <li><a href="#bluegreen-pre-release-analysis">BlueGreen Pre-Release Analysis</a></li>
            <li><a href="#bluegreen-post-release-analysis">BlueGreen Post-Release Analysis</a></li>
            <li><a href="#failure-condition">Failure Condition</a></li>
            <li><a href="#fruitless-runs">Fruitless runs</a></li>
            <li><a href="#delaying-analysis-runs">Delaying analysis runs</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://github.com/openkruise/rollouts">Argo Rollouts</a> is a Kubernetes Operator implementation that provides more advanced deployment capabilities for Kubernetes, such as Bluegreen, Canary, Canary Analytics, Experimentation, and Progressive Delivery capabilities. Enables automated, GitOps-based incremental delivery for cloud-native applications and services.</p>
<p>The following features are supported.</p>
<ul>
<li>Bluegreen update strategy</li>
<li>Canary update policies</li>
<li>More fine-grained, weighted traffic splitting</li>
<li>Automatic rollback</li>
<li>Manual judgment</li>
<li>Customizable metric queries and business KPI analysis</li>
<li>Ingress controller integration: NGINX, ALB</li>
<li>Service Grid Integration: Istio, Linkerd, SMI</li>
<li>Metrics metrics integration: Prometheus, Wavefront, Kayenta, Web, Kubernetes Jobs, Datadog, New Relic</li>
</ul>
<h2 id="implementation-principle">Implementation Principle</h2>
<p>Similar to the Deployment object, the Argo Rollouts controller will manage the creation, scaling and deletion of ReplicaSets, which are defined by <code>spec.template</code> in the Rollout resource, using the same pod template as the Deployment object.</p>
<p>When <code>spec.template</code> is changed, this signals to the Argo Rollouts controller that a new ReplicaSet will be introduced, and the controller will use the strategy in the <code>spec.strategy</code> field to determine how the rollout from the old ReplicaSet to the new ReplicaSet will occur. Once this new ReplicaSet is scaled up (optionally via an Analysis), the controller will mark it as <code>stable</code>.</p>
<p>If another change occurs during the transition of the <code>spec.template</code> from the stable ReplicaSet to the new ReplicaSet (i.e., the application version is changed during the release process), then the previous new ReplicaSet will be scaled down and the controller will attempt to release the ReplicasSet that reflects the updated <code>spec.template</code> field.</p>
<h2 id="related-concepts">Related Concepts</h2>
<p>Before we continue let&rsquo;s understand some basic concepts.</p>
<h3 id="rollout">Rollout</h3>
<p>Rollout is a Kubernetes CRD resource that is the equivalent of a Kubernetes Deployment object and is designed to replace the Deployment object in cases where more advanced deployment or incremental delivery capabilities are needed, Rollout provides features that Kubernetes Deployment does not Rollout provides functionality that Kubernetes Deployment does not.</p>
<ul>
<li>Blue-Green Deployment</li>
<li>Canary deployments</li>
<li>Integration with Ingress Controller and Service Grid for advanced traffic routing</li>
<li>Integration with metrics providers for Bluegreen and Canary analytics</li>
<li>Automated publishing or rollback based on successful or failed metrics</li>
</ul>
<h3 id="progressive-delivery">Progressive Delivery</h3>
<p>Progressive release is the process of releasing product updates in a controlled and incremental manner, thereby reducing the risk of release, often combining automation and metrics analysis to drive automatic upgrade or rollback of updates.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/88ab19c00be643f39d21e45c36146db5.png" alt="Progressive Delivery"></p>
<p>Progressive delivery is often described as the evolution of continuous delivery, extending the speed benefits in CI/CD to the deployment process. By limiting new releases to a subset of users, the correct behavior is observed and analyzed, and then more traffic is gradually added while continuously verifying its correctness.</p>
<h3 id="deployment-strategies">Deployment Strategies</h3>
<p>While the industry uses consistent terminology to describe various deployment strategies, the implementation of these strategies often varies from tool to tool, and to clarify how Argo Rollouts behaves, here is a description of the various deployment strategy implementations provided by Argo Rollouts.</p>
<ul>
<li>
<p><strong>RollingUpdate</strong>: Slowly replaces old versions with new ones, which are slowly scaled down as they become available to maintain the total number of applications. This is the default policy for Deployment objects.</p>
</li>
<li>
<p><strong>Recreate</strong>: Recreate removes the old version of the application before starting the new version, which ensures that both versions of the application never run at the same time, but there is downtime during deployment.</p>
</li>
<li>
<p><strong>Blue-Green</strong>: A Blue-Green release (sometimes called Red-Black) means that both the old and new versions of the application are deployed at the same time, during which only the old version of the application receives production traffic, which allows developers to test against the new version before switching live traffic to the new version.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/c18947e3494c4490b24a8d24b81fffe5.png" alt="Blue-Green release"></p>
</li>
<li>
<p><strong>Canary</strong>: Canary releases refer to exposing a portion of users to a new version of the application, while making the rest of the traffic available to the old version, which can gradually replace the old version once the new version is verified to be correct.Ingress controllers and service grids, such as NGINX Ingress and Istio, can make the traffic splitting model of Canary more sophisticated than native (for example, implementing very fine-grained traffic splitting, or splitting based on HTTP headers).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/faaacaaef21047ef96fae0a2239730c9.png" alt="Canary releases"></p>
<p>The above chart shows a canary with two phases (10% and 33% of traffic into the new version), by using Argo Rollouts we can define the exact number of phases and percentage of traffic based on actual usage.</p>
</li>
</ul>
<h2 id="architecture">Architecture</h2>
<p>The following shows all the components of Deployment managed by Argo Rollouts.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/c9c372f340c343209868f59fd80eed15.png" alt="all the components of Deployment managed by Argo Rollouts"></p>
<h3 id="rollout-controller">Rollout Controller</h3>
<p>This is the main controller that monitors the events of the cluster and reacts when changes are made to the Rollout type of resources. The controller will read all the details of the rollout and keep the cluster in the same state as described in the rollout definition.</p>
<p>Note that Argo Rollouts will not tamper with or respond to any changes that occur on normal Deployment resources, which means you can install Argo Rollouts in a cluster that uses other methods of deploying applications.</p>
<h3 id="rollout-resources">Rollout Resources</h3>
<p>A Rollout resource is a custom Kubernetes resource introduced and managed by Argo Rollouts that is largely compatible with the native Kubernetes Deployment resource, but has additional fields to control more advanced deployment methods such as canary and blue/green deployments.</p>
<p>The Argo Rollouts controller will only react to changes in the Rollout resource and will not do anything to the normal Deployment resource, so if you want to manage your Deployment with Argo Rollouts, you will need to migrate your Deployment to Rollouts.</p>
<h3 id="old-and-new-versions-of-replicasets">Old and new versions of ReplicaSets</h3>
<p>These are examples of standard Kubernetes ReplicaSet resources, Argo Rollouts adds some additional metadata to them to keep track of the different versions belonging to the application.</p>
<p>Note also that ReplicaSets participating in Rollout are completely managed automatically by the controller and you should not tamper with them using external tools.</p>
<h3 id="ingressservice">Ingress/Service</h3>
<p>After a user&rsquo;s traffic enters the cluster and is redirected to the appropriate version, Argo Rollouts uses standard Kubernetes Service resources, but with some additional metadata.</p>
<p>Argo Rollouts is very flexible in terms of network configuration, starting with the ability to use different services during a Rollout that are only available for newer versions, only for older versions, or both. For Canary deployments in particular, Argo Rollouts supports multiple service grids and Ingress solutions for splitting traffic by a specific percentage, rather than a simple configuration based on the number of Pods.</p>
<h3 id="analysis-and-analysisrun">Analysis and AnalysisRun</h3>
<p><code>Analysis</code> is a custom Kubernetes resource that connects a Rollout to a metrics provider and defines specific thresholds for certain metrics that will determine whether the Rollout is successful or not. For each Analysis, you can define one or more metric queries and their expected results, and the Rollout will continue to operate if the metric query works, roll back automatically if the metric shows a failure, or suspend the release if the metric cannot provide a success/failure answer.</p>
<p>Analysis is just a template for which metrics to query. The actual result attached to a Rollout is the <code>AnalysisRun</code> custom resource, which allows you to define Analysis on a specific Rollout or globally on a cluster for multiple Rollouts to share.</p>
<p>Note that using Analysis and metrics in a Rollout is completely optional, and you can manually pause and facilitate releases or use other external methods via the API or CLI. You don&rsquo;t need to use only Argo Rollouts&rsquo; Metrics solution, you can also mix automatic (i.e. Analysis-based) and manual steps in Rollout.</p>
<p>In addition to metrics, you can also determine the success of a release by running a Kubernetes Job or running a webhook.</p>
<h3 id="metric-providers">Metric Providers</h3>
<p>Argo Rollouts includes native integrations with several popular metric providers that you can use in your Analysis resources to automatically boost or roll back releases.</p>
<h3 id="cli-and-ui">CLI and UI</h3>
<p>Rollout can also be viewed and managed using the Argo Rollouts CLI or the integrated UI, both of which are optional.</p>
<h2 id="installation">Installation</h2>
<p>Install Argo Rollouts directly using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl create namespace argo-rollouts
</span></span><span class="line"><span class="cl">$ kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/download/v1.2.2/install.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here a namespace named <code>argo-rollouts</code> is created and the Argo Rollouts controller runs underneath.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n argo-rollouts
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">argo-rollouts-845b79ff9-crx9v    1/1     Running   <span class="m">0</span>          58s
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition, we can install a kubectl plugin, which is very handy for command line management and visualization of releases. Use curl to install the Argo Rollouts kubectl plugin.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># https://github.91chi.fun/https://github.com//argoproj/argo-rollouts/releases/download/v1.2.2/kubectl-argo-rollouts-linux-amd64</span>
</span></span><span class="line"><span class="cl">$ curl -LO https://github.com/argoproj/argo-rollouts/releases/download/v1.2.2/kubectl-argo-rollouts-linux-amd64
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then grant executable permissions to the <code>kubectl-argo-rollouts</code> binary.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ chmod +x ./kubectl-argo-rollouts-linux-amd64
</span></span></code></pre></td></tr></table>
</div>
</div><p>Move the binary to the bottom of your PATH path.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ sudo mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
</span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command to verify that the plugin is installed successfully.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts version
</span></span><span class="line"><span class="cl">kubectl-argo-rollouts: v1.2.2+22aff27
</span></span><span class="line"><span class="cl">  BuildDate: 2022-07-26T17:24:43Z
</span></span><span class="line"><span class="cl">  GitCommit: 22aff273bf95646e0cd02555fbe7d2da0f903316
</span></span><span class="line"><span class="cl">  GitTreeState: clean
</span></span><span class="line"><span class="cl">  GoVersion: go1.17.6
</span></span><span class="line"><span class="cl">  Compiler: gc
</span></span><span class="line"><span class="cl">  Platform: linux/amd64
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="usage">Usage</h2>
<p>Next we will demonstrate the various features of Rollouts by illustrating a few simple examples of deployment, upgrade, release, and interruption of Rollouts.</p>
<h3 id="1-deploying-rollout">1. Deploying Rollout</h3>
<p>First we deploy a Rollout resource and a Kubernetes Service object for that resource. The Rollout in our example here uses a canary update strategy, sending 20% of the traffic to the canary, then manually releasing it, and then gradually and automatically increasing the traffic for the remainder of the upgrade, as illustrated by the Rollout to describe this strategy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># basic-rollout.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rollouts-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 定义5个副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 定义升级策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w"> </span><span class="c"># 金丝雀发布</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w"> </span><span class="c"># 发布的节奏</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{}<span class="w"> </span><span class="c"># 会一直暂停</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span>}<span class="w"> </span><span class="c"># 暂停10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 下面部分其实是和 Deployment 兼容的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rollouts-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rollouts-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rollouts-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj/rollouts-demo:blue</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">32Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>It also includes a Service resource object as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># basic-service.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rollouts-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rollouts-demo</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Create the two resource objects above directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f basic-rollout.yaml
</span></span><span class="line"><span class="cl">$ kubectl apply -f basic-service.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Any initial creation of Rollout will immediately expand the copy to 100% (skipping any canary upgrade steps, analysis, etc&hellip;) because no upgrade has occurred yet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -l <span class="nv">app</span><span class="o">=</span>rollouts-demo
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">rollouts-demo-687d76d795-6ppnh   1/1     Running   <span class="m">0</span>          53s
</span></span><span class="line"><span class="cl">rollouts-demo-687d76d795-8swrk   1/1     Running   <span class="m">0</span>          53s
</span></span><span class="line"><span class="cl">rollouts-demo-687d76d795-fnt2w   1/1     Running   <span class="m">0</span>          53s
</span></span><span class="line"><span class="cl">rollouts-demo-687d76d795-mtvtw   1/1     Running   <span class="m">0</span>          53s
</span></span><span class="line"><span class="cl">rollouts-demo-687d76d795-sh56l   1/1     Running   <span class="m">0</span>          53s
</span></span></code></pre></td></tr></table>
</div>
</div><p>The kubectl plugin for Argo Rollouts allows us to visualize the Rollout and related resource objects and show real-time status changes. To watch the Rollout during deployment, you can run the plugin&rsquo;s <code>get rollout --watch</code> command, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts get rollout rollouts-demo --watch
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/995f7263fba54e1fa5a2d9819bdd3a00.png" alt="get rollout &amp;ndash;watch"></p>
<h3 id="2-update-rollout">2. Update Rollout</h3>
<p>Now that the above deployment is complete, it&rsquo;s time to perform an update. Similar to Deployment, any changes to the Pod template fields will result in a new version (i.e. ReplicaSet) being deployed, updating Rollout is usually done by modifying the version of the container image and then executing <code>kubectl apply</code>, for convenience the rollouts plugin also provides a separate <code>set image</code> command. For example, here we run the command shown below to update the above Rollout with the <code>yellow</code> version of the container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts <span class="nb">set</span> image rollouts-demo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  rollouts-demo<span class="o">=</span>argoproj/rollouts-demo:yellow
</span></span><span class="line"><span class="cl">rollout <span class="s2">&#34;rollouts-demo&#34;</span> image updated
</span></span></code></pre></td></tr></table>
</div>
</div><p>During a rollout update, the controller will go through the steps defined in the Rollout Update Policy. This example rollout sets a 20% traffic weight for the canary and keeps the rollout paused until the user cancels or facilitates the release. After updating the image, the rollout is observed again until it reaches the paused state.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts get rollout rollouts-demo --watch
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/f74d57b620b3462389602f1e2490a445.png" alt="get rollout &amp;ndash;watch"></p>
<p>When the demo rollout reaches step 2, we can see from the plugin that the rollout is paused and now 1 of the 5 copies is running the new version of the pod, while the remaining 4 are still running the old version, which corresponds to the 20% canary weight defined in the <code>setWeight: 20</code> step.</p>
<h3 id="3-promote-rollout">3. Promote Rollout</h3>
<p>After the update above, Rollout is now in a paused state and when a Rollout reaches a paused step with no duration, it will remain in a paused state until it is resumed/lifted. To manually switch a Rollout to the next step, run the plugin&rsquo;s <code>promotion</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts promote rollouts-demo
</span></span><span class="line"><span class="cl">rollout <span class="s1">&#39;rollouts-demo&#39;</span> promoted
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the switchover Rollout will continue with the remaining steps. In our example, the remaining steps are fully automated, so Rollout will eventually complete the steps until it has fully transitioned to the new version. Watch Rollout again until it has completed all the steps.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts get rollout rollouts-demo --watch
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/1086c1537870471fa015e0d658dd1648.png" alt="get rollout &amp;ndash;watch"></p>
<blockquote>
<p>The promote command also supports skipping all remaining steps and analysis with the <code>--full</code> flag.</p>
</blockquote>
<p>You can see that the <code>stable</code> version has been switched to the <code>revision:2</code> ReplicaSet. Rollout will fall back to the <code>stable</code> version whenever it is updated, either automatically by a failed canary analysis, or manually by the user.</p>
<h3 id="4-interrupting-rollout">4. Interrupting Rollout</h3>
<p>Next, let&rsquo;s see how to manually abort a rollout during an update. First, use the <code>set image</code> command to deploy a new <code>red</code> version of the container and wait for the rollout to reach the pause step again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts <span class="nb">set</span> image rollouts-demo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  rollouts-demo<span class="o">=</span>argoproj/rollouts-demo:red
</span></span><span class="line"><span class="cl">rollout <span class="s2">&#34;rollouts-demo&#34;</span> image updated
</span></span></code></pre></td></tr></table>
</div>
</div><p>This time we will abort the update instead of switching the rollout to the next step, so that it goes back to the <code>stable</code> version, which also provides an <code>abort</code> command to manually abort the rollout at any point during the update.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts abort rollouts-demo
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the rollout is aborted, it expands the <code>stable</code> version of the ReplicaSet (in this case the <code>yellow</code> version) and shrinks any other versions. Although the stable version of the ReplicaSet may be running and healthy, the entire Rollout is still considered degraded because the desired version (the <code>red</code> version) is not the one that is actually running.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/de5b44e78c874f98be68f647580f5283.png" alt="get rollout &amp;ndash;watch"></p>
<p>In order for Rollout to be considered healthy again and not a faulty version, it is necessary to change the desired state back to the previous stable version. In our case, we can simply re-run the <code>set image</code> command using the previous <code>yellow</code> image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl argo rollouts <span class="nb">set</span> image rollouts-demo <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  rollouts-demo<span class="o">=</span>argoproj/rollouts-demo:yellow
</span></span></code></pre></td></tr></table>
</div>
</div><p>After running this command, you can see that Rollout immediately changes to the health state, and there is no dynamics regarding the creation of new ReplicaSets.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/bad9be8b6fbc4fb083dfda16797648ab.png" alt="get rollout &amp;ndash;watch"></p>
<p>When Rollout has not yet reached the expected state (e.g., it has been aborted, or is in the process of being updated) and the stable version of the resource list is reapplied, Rollout detects that this is a rollback, not an update, and will quickly deploy the stable ReplicaSet by skipping the analysis and steps.</p>
<p>The Rollout in the example above does not use an Ingress controller or service grid to control traffic. Instead, it uses the normal Kubernetes Service to implement approximate canary weighting, based on the ratio of the number of old and new replicas. So, this Rollout has the limitation that it can only achieve a minimum weighting of 20% by extending one of the 5 pods to run the new version. To achieve a more granular canary, this would require an Ingress controller or service grid.</p>
<h2 id="dashboard">Dashboard</h2>
<p>The Argo Rollouts Kubectl plugin can provide a local Dashboard to visualize your Rollouts.</p>
<p>To start this Dashboard, run the <code>kubectl argo rollouts dashboard</code> command in the namespace containing the Rollouts resource object, and then just access <code>localhost:3100</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/92cbd7f35b7b4128a02dda27c11bd832.png" alt="Dashboard"></p>
<p>Click Rollout to proceed to the detail page, where you can see the configuration information of Rollout and also perform some common operations such as restart, reboot, interrupt, etc. directly on the UI interface.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/c58c4e621358478282aca7def38d4e52.png" alt="Dashboard"></p>
<h2 id="analysis-and-progressive-interaction">Analysis and Progressive Interaction</h2>
<p>Argo Rollouts provides several ways to perform Analysis to drive incremental delivery, starting with an understanding of several CRD resources.</p>
<ul>
<li><code>Rollout</code>: Rollout is a direct replacement for the Deployment resource that provides additional blueGreen and canary update policies that create AnalysisRuns and Experiments that can advance updates, or abort updates, during updates.</li>
<li><code>AnalysisTemplate</code>: AnalysisTemplate is a template that defines how to perform a canary analysis, such as the metrics it should perform, the frequency, and the values that are considered successes or failures, AnalysisTemplate can be parameterized with input values.</li>
<li><code>ClusterAnalysisTemplate</code>: ClusterAnalysisTemplate is similar to AnalysisTemplate, but it is global in scope and it can be used by any Rollout across the cluster.</li>
<li><code>AnalysisRun</code>: AnalysisRun is an instantiation of AnalysisTemplate. analysisRun is like Job, they eventually complete, the completed run is considered successful, failed or indeterminate, and the result of the run affects whether the Rollout&rsquo;s update continues, aborts or pauses respectively.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/22/46464eece6ed47a8b076b76427ead68d.png" alt="Argo Rollouts"></p>
<h3 id="background-analytics">Background Analytics</h3>
<p>Analytics can run in the background while Canary is performing its deployment steps.</p>
<p>The following example gradually increases the Canary weight by 20% every 10 minutes until it reaches 100%. In the background, <code>AnalysisRun</code> is started based on an <code>AnalysisTemplate</code> named <code>success-rate</code>, and the <code>success-rate</code> template queries the Prometheus server to measure HTTP success at 5-minute intervals/samples, which has no end time and continues until it stops or fails. If the measured metric is less than 95% and there are three such measurements, the analysis is considered to have failed. A failed analysis causes the Rollout to stop, sets the Canary weight back to zero, and the Rollout is considered degraded. Otherwise, if the Rollout completes all of its Canary steps, the rollout is considered successful and the controller will stop running the analysis.</p>
<p>The Rollout resource object as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">startingStep</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 延迟开始分析，到第3步开始</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook-svc.default.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">10m }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">10m }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">10m }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">10m }</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Above we referenced a template for <code>success-rate</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AnalysisTemplate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># NOTE: prometheus queries return results in the form of a vector.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># So it is common to access the index 0 of the returned array to obtain the value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 0.95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">failureLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;,response_code!~&#34;5.*&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            )) /
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            ))</span><span class="w">            
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="inline-analysis">Inline Analysis</h3>
<p>Analysis can also be executed as an inline &ldquo;analysis&rdquo; step, when analysis is performed &ldquo;inline&rdquo;, starting AnalysisRun when it reaches that step and preventing it from advancing until the run is complete. The success or failure of the analysis run determines whether the deployment continues to the next step or aborts the deployment altogether.</p>
<p>In the example shown below we set the Canary weight to 20%, pause for 5 minutes, and then run the analysis. If the analysis is successful, the rollout continues, otherwise it is aborted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">5m }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook-svc.default.svc.cluster.local</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In the above object we have inlined analysis as a step in the Rollout step, and the analysis template <code>success-rate</code> is executed when 20% of the traffic is paused for 5 minutes.</p>
<p>Here the AnalysisTemplate is the same as the backend analysis example above, but since no interval is specified, the analysis will be executed in a single measurement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AnalysisTemplate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 0.95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://prometheus.example.com:{{args.prometheus-port}}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;,response_code!~&#34;5.*&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            )) /
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            ))</span><span class="w">            
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In addition, we can specify the count and interval fields so that multiple measurements can be taken over a long period of time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 0.95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">count</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="multiple-templates-for-analysis">Multiple templates for analysis</h3>
<p>Rollout can reference multiple AnalysisTemplates when building an AnalysisRun. this allows us to compose analysis from multiple AnalysisTemplates, if multiple templates are referenced then the controller will merge them together and the controller will combine the metrics and args fields from all the templates.</p>
<p>This is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">error-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook-svc.default.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AnalysisTemplate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 0.95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">failureLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;,response_code!~&#34;5.*&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            )) /
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            ))</span><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AnalysisTemplate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">error-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">error-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &lt;= 0.95</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">failureLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;,response_code=~&#34;5.*&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            )) /
</span></span></span><span class="line"><span class="cl"><span class="sd">            sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">              istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">            ))</span><span class="w">            
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>When the analysis is performed, the controller will merge the <code>success-rate</code> and <code>error-rate</code> templates above into an <code>AnalysisRun</code> object.</p>
<p>Note that the controller will make an error when merging the templates if</p>
<ul>
<li>Multiple metrics in the template have the same name</li>
<li>two parameters with the same name both have values</li>
</ul>
<h3 id="analysis-template-parameters">Analysis Template Parameters</h3>
<p>AnalysisTemplates can declare a set of parameters that can be passed by Rollouts. These parameters can then be used as in the metrics configuration and are instantiated when AnalysisRun is created, with parameter placeholders defined as <code>{{ args.&lt;name&gt; }}</code>, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">AnalysisTemplate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">args-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># required</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stable-hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">latest-hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># optional</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">http://example/measure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># from secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">token-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">apiToken</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webmetric</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result == &#39;true&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># placeholders are resolved when an AnalysisRun is created</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ args.api-url }}?service={{ args.service-name }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">headers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">Authorization</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Bearer {{ args.api-token }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">jsonPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{$.results.ok}&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>When creating an AnalysisRun, the parameters defined in the Rollout are merged with those of the AnalysisTemplate, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">args-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># required value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook-svc.default.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># override default value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-url</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">http://other-api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># pod template hash from the stable ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">stable-hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">podTemplateHashValue</span><span class="p">:</span><span class="w"> </span><span class="l">Stable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># pod template hash from the latest ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">latest-hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">podTemplateHashValue</span><span class="p">:</span><span class="w"> </span><span class="l">Latest</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In addition, analysis parameters also support <code>valueFrom</code>, which is used to read meta data and pass it to AnalysisTemplate as a parameter, as in the example below, which references the env and region tags in the meta data and passes them to AnalysisTemplate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">appType</span><span class="p">:</span><span class="w"> </span><span class="l">demo-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">buildType</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">us-west-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">args-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">env</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.labels[&#39;env&#39;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># region where this app is deployed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">region</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.labels[&#39;region&#39;]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bluegreen-pre-release-analysis">BlueGreen Pre-Release Analysis</h3>
<p>A Rollout using the BlueGreen policy can start an AnalysisRun before switching traffic to a new version using a pre-release. the success or failure of the analysis run determines whether the Rollout switches traffic, or aborts the Rollout altogether, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">blueGreen</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">activeService</span><span class="p">:</span><span class="w"> </span><span class="l">active-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">previewService</span><span class="p">:</span><span class="w"> </span><span class="l">preview-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prePromotionAnalysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">smoke-tests</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">preview-svc.default.svc.cluster.local</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In our example above, once the new ReplicaSet is fully available, Rollout will create a pre-released AnalysisRun and Rollout will not switch the traffic to the new version, but will wait until the analysis run completes successfully.</p>
<p>Note: If the <code>autoPromotionSeconds</code> field is specified and Rollout has waited <code>auto promotion seconds</code>, Rollout will mark the AnalysisRun as successful and automatically switch the traffic to the new version. If the AnalysisRun completes before then, Rollout will not create another AnalysisRun and will wait the remaining time for <code>autoPromotionSeconds</code>.</p>
<h3 id="bluegreen-post-release-analysis">BlueGreen Post-Release Analysis</h3>
<p>Rollout using the BlueGreen policy can also use post-release analysis after traffic has been switched to a new version. If the post-release analysis fails or there is an error, Rollout goes into abort and switches the traffic back to the previous stable ReplicaSet. When the post-analysis is successful, Rollout is considered fully released and the new ReplicaSet is marked as stable, and then the old ReplicaSet is scaled down based on <code>scaleDownDelaySeconds</code> (default is 30 seconds) to scale down.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">blueGreen</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">activeService</span><span class="p">:</span><span class="w"> </span><span class="l">active-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">previewService</span><span class="p">:</span><span class="w"> </span><span class="l">preview-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scaleDownDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w"> </span><span class="c"># 10 minutes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postPromotionAnalysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">smoke-tests</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">service-name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">preview-svc.default.svc.cluster.local</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="failure-condition">Failure Condition</h3>
<p><code>failureCondition</code> can be used to configure the analysis to fail. The following example continuously polls the Prometheus server every 5 minutes to get the total number of errors, and if 10 or more errors are encountered, the analysis is considered to have failed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">total-errors</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          sum(irate(
</span></span></span><span class="line"><span class="cl"><span class="sd">            istio_requests_total{reporter=&#34;source&#34;,destination_service=~&#34;{{args.service-name}}&#34;,response_code~&#34;5.*&#34;}[5m]
</span></span></span><span class="line"><span class="cl"><span class="sd">          ))</span><span class="w">          
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fruitless-runs">Fruitless runs</h3>
<p>Analyzing run j results can also be considered indeterminate, which indicates that the run neither succeeds nor fails. A run with no results causes the release to pause at the current step. This requires manual intervention to resume the run, or to suspend it. When an indicator does not define a success or failure condition, the analysis run may become an example of a no-result run.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-query</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Also uncertain analysis runs can occur when both success and failure conditions are specified, but the measured values do not satisfy either condition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 0.90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">failureCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &lt; 0.50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>One scenario for uncertain analysis runs is to enable Argo Rollouts to automatically perform analysis runs and collect measurements, but still allow us to make a judgment call to determine if the measurements are acceptable and decide to continue or abort.</p>
<h3 id="delaying-analysis-runs">Delaying analysis runs</h3>
<p>Analysis runs can be delayed for specific metrics if the analysis run does not need to start immediately (i.e., to give the metric provider time to collect the canary version of the metric). Each metric can be configured to have a different delay, and in addition to the delay for a specific metric, releases with background analysis can delay the creation of an analysis run until a certain step is reached</p>
<p>Delaying a specified analysis metric as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Do not start this analysis until 5 minutes after the analysis run starts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">initialDelay</span><span class="p">:</span><span class="w"> </span><span class="l">5m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">successCondition</span><span class="p">:</span><span class="w"> </span><span class="l">result[0] &gt;= 0.90</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">provider</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prometheus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">http://prometheus.example.com:9090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Delay the start of the background analysis run until step 3 (set weight 40%).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rollout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">guestbook</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">canary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">analysis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">templateName</span><span class="p">:</span><span class="w"> </span><span class="l">success-rate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">startingStep</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">10m }</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">setWeight</span><span class="p">:</span><span class="w"> </span><span class="m">40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">pause</span><span class="p">:</span><span class="w"> </span>{<span class="w"> </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">10m }</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In addition, the OpenKurise project has recently launched a similar progressive release tool, <code>Kruise Rollouts</code>, for those interested in learning more about it at <a href="https://github.com/openkruise/rollouts">https://github.com/openkruise/rollouts</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/go-1-19/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A few notable changes in Go 1.19</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/docker-health/">
            <span class="next-text nav-default">Health check for docker containers</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
