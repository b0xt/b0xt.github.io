<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Hashcorp Vault Basic Tutorial - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore how to use Hashcorp Vault to manage large amounts of Secret information." /><meta name="keywords" content="Hashcorp Vault" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/hashcorp-vault/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Hashcorp Vault Basic Tutorial" />
<meta property="og:description" content="Explore how to use Hashcorp Vault to manage large amounts of Secret information." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/hashcorp-vault/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-02T10:28:28+08:00" />
<meta property="article:modified_time" content="2022-08-02T10:28:28+08:00" />

<meta itemprop="name" content="Hashcorp Vault Basic Tutorial">
<meta itemprop="description" content="Explore how to use Hashcorp Vault to manage large amounts of Secret information."><meta itemprop="datePublished" content="2022-08-02T10:28:28+08:00" />
<meta itemprop="dateModified" content="2022-08-02T10:28:28+08:00" />
<meta itemprop="wordCount" content="2857">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hashcorp Vault Basic Tutorial"/>
<meta name="twitter:description" content="Explore how to use Hashcorp Vault to manage large amounts of Secret information."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Hashcorp Vault Basic Tutorial</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-02 10:28:28 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2857 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#0x01-vault-fundamentals">0x01 Vault Fundamentals</a>
          <ul>
            <li><a href="#vaults-data-flow">Vault&rsquo;s data flow</a></li>
          </ul>
        </li>
        <li><a href="#0x02-the-main-operation-flow-of-vault">0x02 The main operation flow of Vault</a>
          <ul>
            <li><a href="#step1-data-storage-and-encryptiondecryption">Step1: Data Storage and Encryption/Decryption</a></li>
            <li><a href="#step2-authentication--permissions-management">Step2: Authentication &amp;&amp; Permissions Management</a></li>
            <li><a href="#step3-secret-engine-important">Step3: Secret Engine (important)</a></li>
          </ul>
        </li>
        <li><a href="#0x03-vault-details">0x03 Vault Details</a>
          <ul>
            <li><a href="#shamir-key-sharing-algorithm-shamir-secret-sharing">Shamir key sharing algorithm (shamir secret sharing)</a></li>
          </ul>
        </li>
        <li><a href="#0x04-basic-functions-of-vault">0x04 Basic functions of Vault</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>How do we manage the large amount of Secret information in our work? (For example, my project involves the storage of secret keys and passwords for OpenSSH, as well as the regular rotation and external invocation of this)</p>
<ul>
<li>Solidified in a configuration file, stored in a server file or Database</li>
<li>stored as code on a <code>git</code> private repository, with strict access rights to the repository</li>
<li>Hosted on a public cloud service as a KMS (Key Management Service, mostly cloud services)</li>
<li>Challenges from the cloud: <code>Unlocking the Cloud Operating Model</code> (<a href="https://www.hashicorp.com/cloud-operating-model">https://www.hashicorp.com/cloud-operating-model</a>)</li>
</ul>
<p>The generic cryptographic repository we need to implement needs to satisfy the following characteristics.</p>
<ul>
<li>Cryptographic storage (taking into account complexity)</li>
<li>Generic, reducing the workload of manual Secret modification, i.e. providing RestfulAPI</li>
<li>Permission control</li>
</ul>
<p>In this article, we would like to introduce Vault, an open source Secret management tool (password, token, private key and certificate, etc.), which is an excellent application practice for managing passwords and secret keys in code (to prevent plaintext leakage). In addition, KMS (Key Management Service, cloud services mostly) is also a better Secret management practice. vault project source code here (<a href="https://github.com/hashicorp/vault">https://github.com/hashicorp/vault</a>)</p>
<p>For such products, the following points need to be focused on.</p>
<ol>
<li>the way the Secret is stored, the supported storage backend</li>
<li>the encryption method and algorithm of the Secret</li>
<li>the system&rsquo;s permission control, permission allocation (which people / clients can access which machine Secret)</li>
<li>the system&rsquo;s authentication method, the client uses what way to access RestfulAPI</li>
<li>the system&rsquo;s Secret storage method and expiration mechanism</li>
<li>how to ensure the high availability of the system</li>
<li>the QPS and concurrency performance of the system&rsquo;s external interface</li>
</ol>
<h2 id="0x01-vault-fundamentals">0x01 Vault Fundamentals</h2>
<p>This subsection refers to the <code>official documentation</code> (<a href="https://www.vaultproject.io/docs/internals/architecture">https://www.vaultproject.io/docs/internals/architecture</a>). The basic application scenario of vault is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/dbdcbabf10f7426a9da0c1604b272c78.png" alt="Vault"></p>
<p>Vault is generally used in the following scenarios:</p>
<ol>
<li>system users (such as operations and maintenance colleagues) write Secret data to Vault via <code>HTTP-Vault-API</code>, Vault command line tools, etc.</li>
<li>Vault then stores the encrypted data to the backend</li>
<li>external users (e.g. developers, scripts or applications) use <code>HTTP-Vault-API</code>, Vault command-line tools, etc. to get the Secret data associated with their own accounts only, which involves the fine-grained permissions management of Valut</li>
</ol>
<p>The vault architecture is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/5c906a0528604ea0a07ca06d6ad97ac0.png" alt="vault architecture"></p>
<p>As you can see from the architecture diagram, Vault is divided into three parts: Storage Backend, Barrier and HTTP API. The Barrier ensures that only encrypted data is written to the Storage Backend, and that encrypted data is verified and decrypted as it is read out through the Barrier.</p>
<p>The functions of the other major components are as follows.</p>
<ul>
<li><code>HTTP(s) API</code>:</li>
<li><code>Storage backend</code>.</li>
<li><code>Token Store</code>.</li>
<li><code>Auth Method</code>.</li>
<li><code>Core</code>: responsible for processing requests and response logs from the Audit brok, sending requests to all configured Audit devices</li>
<li><code>Policy store</code>: responsible for managing and storing ACL Policies, with <code>Core</code> performing the ACL Policy checks</li>
</ul>
<h3 id="vaults-data-flow">Vault&rsquo;s data flow</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/af68f994f0644e27888dbb80fcddd6cb.png" alt="Vault&amp;rsquo;s data flow"></p>
<h2 id="0x02-the-main-operation-flow-of-vault">0x02 The main operation flow of Vault</h2>
<h3 id="step1-data-storage-and-encryptiondecryption">Step1: Data Storage and Encryption/Decryption</h3>
<p>Understand a few terms.</p>
<ol>
<li>
<p>Storage Backend: Vault does not store data itself, it needs to be configured with a Storage Backend. Storage Backend is not trusted and is only used to store encrypted data.</p>
</li>
<li>
<p>Initialaztion: Vault needs to be initialized when it is first started, this step generates an Encryption key to encrypt the data, and the encrypted data can only be saved to Storage Backend.</p>
</li>
<li>
<p>Unseal: After the Vault starts, it will enter the Sealed state because the Encryption Key is not known, and no operation can be performed until it is unsealed; the Encryption Key is protected by the Master key, and the Master key must be provided to complete the Unseal operation</p>
</li>
</ol>
<p>The relationship between Master key and Encryption Key is shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/509d63e254774170a7832b091569352a.png" alt="The main operation flow of Vault"></p>
<h3 id="step2-authentication--permissions-management">Step2: Authentication &amp;&amp; Permissions Management</h3>
<p>After the Unseal operation is completed, the Vault can process client requests. The first time a client connects to the Vault, they need to complete authentication. Client authentication methods are as follows</p>
<ul>
<li>Suitable for users: User name/password, LDAP authentication, etc. The user must be granted appropriate permissions to access the Vault.</li>
<li>Suitable for applications: Public/Private keys, Tokens or Jwt Token, etc.</li>
</ul>
<p>This general flow is as follows.</p>
<ol>
<li>The client initiates an authentication request, which flows through the <code>Core</code> module and into <code>Auth methods</code>, which determines whether the request is valid and returns a list of associated policies (Policies). After the authentication is completed with <code>Auth methods</code> and the checked association policies match the authorization, the <code>Token Store</code> generates and manages a new Token, which is returned to the client for subsequent requests. Note that this token also has a Lease term (expiration date), and the Token is associated with a Policy that will be used to verify the request&rsquo;s authority.</li>
<li>After the request is validated, it is routed to the <code>Secret engine</code> module. If the <code>Secret engine</code> returns a Secret (automatically generated by Vault), <code>Core</code> registers it with the <code>Expiration manager</code> and appends a <code>lease ID</code> to it. If the client allows the lease to expire, the <code>Expiration manager</code> will automatically revoke the Secret Token.</li>
</ol>
<h3 id="step3-secret-engine-important">Step3: Secret Engine (important)</h3>
<p>The <code>Secret Engine</code> is the component of the Vault system that saves, generates or encrypts data. The <code>Secret Engine</code> is like a virtual file system, all <code>read</code>/<code>write</code>/<code>delete</code>/<code>list</code> operations are performed under it, and then the <code>Secret Engine</code> can decide for itself how to respond to requests. From the code design point of view, <code>Secret Engine</code> is an abstraction that provides a unified interface to the upper layer (caller), such as physical file system, database, etc., which can be used to add, delete, change and check these operations. Commonly used Engines are as follows.</p>
<ul>
<li><code>kv</code>: key-value storage. Can be seen as an encrypted Redis, simply store / read some static configuration / data</li>
<li><code>Transit Secrets Engine</code>: Provides encryption-as-a-service function, only responsible for encryption and decryption, not storage. The main application scenario is to provide App encrypted and decrypted data, but the data is still stored in MySQL and other databases</li>
<li>Certificate Management: The most common scenario is to store the root certificate (root) in Vault, and the business certificate is issued through this Engine</li>
</ul>
<p>You can see which <code>Secret Engine</code>s are currently enabled in the Vault with the command <code>vault secrets list</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault secrets enable -path=secret_bifrost kv</span>
</span></span><span class="line"><span class="cl">Success! Enabled the kv secrets engine at: secret_bifrost/
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault secrets list</span>
</span></span><span class="line"><span class="cl">Path               Type         Accessor              Description
</span></span><span class="line"><span class="cl">----               ----         --------              -----------
</span></span><span class="line"><span class="cl">cubbyhole/         cubbyhole    cubbyhole_e86bac2b    per-token private secret storage
</span></span><span class="line"><span class="cl">identity/          identity     identity_19b16864     identity store
</span></span><span class="line"><span class="cl">kv/                kv           kv_988a3c7e           n/a
</span></span><span class="line"><span class="cl">secret/            kv           kv_4a27cb62           n/a
</span></span><span class="line"><span class="cl">secret_bifrost/    kv           kv_0b5b6ac3           n/a
</span></span><span class="line"><span class="cl">sys/               system       system_8d02021f       system endpoints used <span class="k">for</span> control, policy and debugging
</span></span><span class="line"><span class="cl">vault/             kv           kv_e26a68a4           n/a
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output of the command shows that there are <code>4</code> engines of type <code>kv</code> (key-value pair encrypted storage), loaded on the <code>kv/</code>, <code>secret/</code>, <code>secret_bifrost/</code> and <code>vault/</code> paths; the other engines are supported internally by Vault. You can read and write to the specified paths because they are supported by the <code>Secret Engine</code>; unloaded paths cannot be accessed (an error will be reported), and you cannot open the same paths at the same time.</p>
<p>In addition, the same <code>Secret Engine</code> can be loaded under different paths (multiple instances of a single <code>Secret Engine</code> class), and the data under each path is independent of each other.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/5a415f4ab3984171b66086e1b16e5596.png" alt="Secret Engine"></p>
<h2 id="0x03-vault-details">0x03 Vault Details</h2>
<p>This section describes some details of the Vault implementation.</p>
<h3 id="shamir-key-sharing-algorithm-shamir-secret-sharing">Shamir key sharing algorithm (shamir secret sharing)</h3>
<p>The implementation of Shamir algorithm is given in Vault. The basic idea of this key sharing algorithm is that the distributor decomposes the secret Secret into <code>n</code> secret holders by a secret polynomial, where any secret at least <code>k</code> can be recovered, i.e., a secret cannot be kept by a single holder, but must be kept by multiple holders and can be recovered only when multiple holders are present at the same time. the secret can be recovered.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/b3d3e80c38cd468d993c6846be2bdd67.png" alt="shamir secret sharing"></p>
<h4 id="vault-authentication-methods">Vault Authentication Methods</h4>
<p>Vault supports the following authentication mechanisms.</p>
<ol>
<li>
<p>Token method Token is a built-in authentication method in Vault, which is loaded at startup and cannot be disabled. For example, <code>Root Token</code> is output when the server is initialized, and the user who logs in with <code>Root Token</code> has the highest access rights to the system. In Vault, Token is an inheritable tree structure, and this <code>&lt;inheritance&gt;</code> has two meanings.</p>
<ul>
<li>The user holding the Token creates a new Token (<code>Child Token</code>), and by default the <code>Child Token</code> has the same permissions as the parent Token (if specific permissions are required)</li>
<li>When a Token is revoked, the <code>Child Token</code> it created, and the <code>Child Token</code> of the <code>Child Token</code> (etc.) are deleted together, which is easy to understand from a tree perspective</li>
</ul>
</li>
<li>
<p>AppRole method AppRole is a more secure authentication method provided by Vault for App applications, and is recommended. The general process of using AppRole is as follows (From official website).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#1. Create a read-only policy file template readonly</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># cat readonly</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Read-only permission on secrets stored at &#39;secret/data/mysql/webapp&#39;</span>
</span></span><span class="line"><span class="cl">path <span class="s2">&#34;secret/data/mysql/webapp&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="nv">capabilities</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;read&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">#2. Load policy</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># vault policy write readonly readonly&lt;br&gt;</span>
</span></span><span class="line"><span class="cl">Success! Uploaded policy: <span class="nb">readonly</span>
</span></span><span class="line"><span class="cl"><span class="c1">#3. Create a token with TTL</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># vault write auth/approle/role/readonly token_policies=&#34;readonly&#34; token_ttl=1h token_max_ttl=4h</span>
</span></span><span class="line"><span class="cl">Success! Data written to: auth/approle/role/readonly
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#4. View readonly&#39;s authentication information</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1">#  vault read auth/approle/role/readonly</span>
</span></span><span class="line"><span class="cl">Key                        Value
</span></span><span class="line"><span class="cl">---                        -----
</span></span><span class="line"><span class="cl">bind_secret_id             <span class="nb">true</span> local_secret_ids           <span class="nb">false</span> secret_id_bound_cidrs      &lt;nil&gt;
</span></span><span class="line"><span class="cl">secret_id_num_uses         <span class="m">0</span>
</span></span><span class="line"><span class="cl">secret_id_ttl              0s
</span></span><span class="line"><span class="cl">token_bound_cidrs          <span class="o">[]</span>
</span></span><span class="line"><span class="cl">token_explicit_max_ttl     0s
</span></span><span class="line"><span class="cl">token_max_ttl              4h
</span></span><span class="line"><span class="cl">token_no_default_policy    <span class="nb">false</span> token_num_uses             <span class="m">0</span>
</span></span><span class="line"><span class="cl">token_period               0s
</span></span><span class="line"><span class="cl">token_policies             <span class="o">[</span>readonly<span class="o">]</span>
</span></span><span class="line"><span class="cl">token_ttl                  1h
</span></span><span class="line"><span class="cl">token_type                 default
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#5. Check rold-id，vault read auth/approle/role/readonly/role-id</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># vault read auth/approle/role/readonly/role-id</span>
</span></span><span class="line"><span class="cl">Key        Value
</span></span><span class="line"><span class="cl">---        -----
</span></span><span class="line"><span class="cl">role_id    12afcbf7-33c9-d86f-e678-dc2beeb3fabd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#6. Check secret-id</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># vault write -force auth/approle/role/readonly/secret-id</span>
</span></span><span class="line"><span class="cl">Key                   Value
</span></span><span class="line"><span class="cl">---                   -----
</span></span><span class="line"><span class="cl">secret_id             7c9e58d5-8af2-176b-8fbc-572db2f8c872
</span></span><span class="line"><span class="cl">secret_id_accessor    ff5c6dca-7b5c-587d-41e2-adaae932a669
</span></span><span class="line"><span class="cl">secret_id_ttl         0s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#7. Exchange token according to role-id and secret-id</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1">#  vault write auth/approle/login role_id=&#34;12afcbf7-33c9-d86f-e678-dc2beeb3fabd&#34;   secret_id=&#34;7c9e58d5-8af2-176b-8fbc-572db2f8c872&#34;</span>
</span></span><span class="line"><span class="cl">Key                     Value
</span></span><span class="line"><span class="cl">---                     -----
</span></span><span class="line"><span class="cl">token                   s.qIcsK6N6lm4TffWWcRIRfRSQ
</span></span><span class="line"><span class="cl">token_accessor          hDt3u9o9hjfHZwQ7Zisun7Vw
</span></span><span class="line"><span class="cl">token_duration          1h
</span></span><span class="line"><span class="cl">token_renewable         <span class="nb">true</span> token_policies          <span class="o">[</span><span class="s2">&#34;default&#34;</span> <span class="s2">&#34;readonly&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">identity_policies       <span class="o">[]</span>
</span></span><span class="line"><span class="cl">policies                <span class="o">[</span><span class="s2">&#34;default&#34;</span> <span class="s2">&#34;readonly&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">token_meta_role_name    <span class="nb">readonly</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#8. Apply the new token to access the cluster</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># export VAULT_TOKEN=s.qIcsK6N6lm4TffWWcRIRfRSQ</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault kv get secret/data/mysql/webapp</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span> <span class="nv">Data</span> <span class="o">==</span>
</span></span><span class="line"><span class="cl">Key    Value
</span></span><span class="line"><span class="cl">---    -----
</span></span><span class="line"><span class="cl">a      <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#9. ultra-authorized access failure (unable to write)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1">#  vault kv put secret/data/mysql/webapp key=abcd</span>
</span></span><span class="line"><span class="cl">Error making API request.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/secret/data/mysql/webapp
</span></span><span class="line"><span class="cl">Code: 403. Errors:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* permission denied
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#9. Access failure after Token expiration</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos /vault<span class="o">]</span><span class="c1"># vault kv get secret/data/mysql/webapp</span>
</span></span><span class="line"><span class="cl">Error making API request.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/secret/data/mysql/webapp
</span></span><span class="line"><span class="cl">Code: 403. Errors:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* permission denied
</span></span></code></pre></td></tr></table>
</div>
</div><p>From an implementation perspective, <code>role-id</code> and <code>secret-id</code> are equivalent to the application&rsquo;s username and password, but in reality they are not.</p>
<p>Vault wants to use this design to solve the <code>Secret Zero</code> problem.</p>
</li>
<li>
<p>The Token method is easy to use, but it is designed to support its own operation and is not very secure. For real user/machine authentication scenarios, Vault officially recommends using other more mature mechanisms such as LDAP, Github, AppRole authentication methods.</p>
</li>
</ol>
<h4 id="storage">Storage</h4>
<p>Vault supports a variety of storage backends: <code>https://github.com/hashicorp/vault/tree/master/plugins/database</code>, production architecture backends are deployed using the <code>HA</code> method, such as consul/etcd/mysql clusters, etc.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/02/b7f1ee5de5ea49ca8bb02d22614791ad.png" alt="Storage"></p>
<ul>
<li>mysql: <a href="https://github.com/hashicorp/vault/blob/master/plugins/database/mysql/mysql.go">https://github.com/hashicorp/vault/blob/master/plugins/database/mysql/mysql.go</a></li>
</ul>
<h2 id="0x04-basic-functions-of-vault">0x04 Basic functions of Vault</h2>
<ol>
<li>
<p>Configure Mysql as the storage backend and start Vault</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># cat vault.hcl</span>
</span></span><span class="line"><span class="cl"><span class="nv">disable_mlock</span>  <span class="o">=</span> <span class="nb">true</span> <span class="nv">ui</span><span class="o">=</span><span class="nb">true</span> storage <span class="s2">&#34;mysql&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">address</span> <span class="o">=</span> <span class="s2">&#34;127.0.0.1:3306&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">username</span> <span class="o">=</span> <span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">password</span> <span class="o">=</span> <span class="s2">&#34;xxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">database</span> <span class="o">=</span> <span class="s2">&#34;vault&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">table</span> <span class="o">=</span> <span class="s2">&#34;vault&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">listener <span class="s2">&#34;tcp&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="nv">address</span>     <span class="o">=</span> <span class="s2">&#34;127.0.0.1:8200&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">tls_disable</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault server -config=vault.hcl</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>initialize vault, get <code>5</code> sub-secret keys and <code>root Token</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault operator init</span>
</span></span><span class="line"><span class="cl">2021-08-20T21:34:41.973+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: security barrier not initialized
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.002+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: security barrier initialized: <span class="nv">stored</span><span class="o">=</span><span class="m">1</span> <span class="nv">shares</span><span class="o">=</span><span class="m">5</span> <span class="nv">threshold</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.031+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: post-unseal setup starting
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.060+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: loaded wrapping token key
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.060+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: successfully setup plugin catalog: plugin-directory<span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.060+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: no mounts<span class="p">;</span> adding default mount table
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.080+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted backend: <span class="nv">type</span><span class="o">=</span>cubbyhole <span class="nv">path</span><span class="o">=</span>cubbyhole/
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.081+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted backend: <span class="nv">type</span><span class="o">=</span>system <span class="nv">path</span><span class="o">=</span>sys/
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.081+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: successfully mounted backend: <span class="nv">type</span><span class="o">=</span>identity <span class="nv">path</span><span class="o">=</span>identity/
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.136+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: successfully enabled credential backend: <span class="nv">type</span><span class="o">=</span>token <span class="nv">path</span><span class="o">=</span>token/
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.137+0800 <span class="o">[</span>INFO<span class="o">]</span>  rollback: starting rollback manager
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.137+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: restoring leases
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.138+0800 <span class="o">[</span>INFO<span class="o">]</span>  expiration: lease restore <span class="nb">complete</span> 2021-08-20T21:34:42.163+0800 <span class="o">[</span>INFO<span class="o">]</span>  identity: entities restored
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.164+0800 <span class="o">[</span>INFO<span class="o">]</span>  identity: groups restored
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.165+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: usage gauge collection is disabled
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.174+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: post-unseal setup <span class="nb">complete</span> 2021-08-20T21:34:42.200+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: root token generated
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.200+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: pre-seal teardown starting
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.200+0800 <span class="o">[</span>INFO<span class="o">]</span>  rollback: stopping rollback manager
</span></span><span class="line"><span class="cl">2021-08-20T21:34:42.200+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: pre-seal teardown <span class="nb">complete</span> Unseal Key 1: xxx1
</span></span><span class="line"><span class="cl">Unseal Key 2: xxx2
</span></span><span class="line"><span class="cl">Unseal Key 3: xxx3
</span></span><span class="line"><span class="cl">Unseal Key 4: xxx4
</span></span><span class="line"><span class="cl">Unseal Key 5: xxx5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Initial Root Token: xxx-root-token
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Unblock vault, view unblock status</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault operator unseal xxx1</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault operator unseal xxx2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault operator unseal xxx3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault status</span>
</span></span><span class="line"><span class="cl">Key                Value
</span></span><span class="line"><span class="cl">---                -----
</span></span><span class="line"><span class="cl">Seal Type          shamir
</span></span><span class="line"><span class="cl">Initialized        <span class="nb">true</span> Sealed             <span class="nb">true</span> Total Shares       <span class="m">5</span>
</span></span><span class="line"><span class="cl">Threshold          <span class="m">3</span>
</span></span><span class="line"><span class="cl">Unseal Progress    2/3
</span></span><span class="line"><span class="cl">Unseal Nonce       95ba53e7-63e2-c998-e1b8-4df4bba20ea3
</span></span><span class="line"><span class="cl">Version            1.8.1
</span></span><span class="line"><span class="cl">Storage Type       mysql
</span></span><span class="line"><span class="cl">HA Enabled         <span class="nb">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Login with <code>root Token</code> (first time)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault login root-token</span>
</span></span><span class="line"><span class="cl">Success! You are now authenticated. The token information displayed below
</span></span><span class="line"><span class="cl">is already stored in the token helper. You <span class="k">do</span> NOT need to run <span class="s2">&#34;vault login&#34;</span>
</span></span><span class="line"><span class="cl">again. Future Vault requests will automatically use this token.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Key                  Value
</span></span><span class="line"><span class="cl">---                  -----
</span></span><span class="line"><span class="cl">token                xxx
</span></span><span class="line"><span class="cl">token_accessor       xxx
</span></span><span class="line"><span class="cl">token_duration       ∞
</span></span><span class="line"><span class="cl">token_renewable      <span class="nb">false</span> token_policies       <span class="o">[</span><span class="s2">&#34;root&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">identity_policies    <span class="o">[]</span>
</span></span><span class="line"><span class="cl">policies             <span class="o">[</span><span class="s2">&#34;root&#34;</span><span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Open vault component to test write / read / token generation etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault secrets enable kv</span>
</span></span><span class="line"><span class="cl">2021-08-20T21:44:37.837+0800 <span class="o">[</span>INFO<span class="o">]</span>  core: successful mount: <span class="nv">namespace</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">path</span><span class="o">=</span>kv/ <span class="nv">type</span><span class="o">=</span>kv
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault kv put kv/test api_key=abc1234 api_secret=1a2b3c4d^C</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault kv get kv/test</span>
</span></span><span class="line"><span class="cl"><span class="o">=======</span> <span class="nv">Data</span> <span class="o">=======</span>
</span></span><span class="line"><span class="cl">Key           Value
</span></span><span class="line"><span class="cl">---           -----
</span></span><span class="line"><span class="cl">api_key       abc1234
</span></span><span class="line"><span class="cl">api_secret    1a2b3c4d
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault token create -ttl 1h</span>
</span></span><span class="line"><span class="cl">Key                  Value
</span></span><span class="line"><span class="cl">---                  -----
</span></span><span class="line"><span class="cl">token                s.6sfhKw2J2dFfNSMdIyWQGqiS
</span></span><span class="line"><span class="cl">token_accessor       o8MjM5SuLewdJk0WSZ0oPPrF
</span></span><span class="line"><span class="cl">token_duration       1h
</span></span><span class="line"><span class="cl">token_renewable      <span class="nb">true</span> token_policies       <span class="o">[</span><span class="s2">&#34;root&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">identity_policies    <span class="o">[]</span>
</span></span><span class="line"><span class="cl">policies             <span class="o">[</span><span class="s2">&#34;root&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># export VAULT_TOKEN=s.6sfhKw2J2dFfNSMdIyWQGqiS</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault kv get kv/test</span>
</span></span><span class="line"><span class="cl"><span class="o">=======</span> <span class="nv">Data</span> <span class="o">=======</span>
</span></span><span class="line"><span class="cl">Key           Value
</span></span><span class="line"><span class="cl">---           -----
</span></span><span class="line"><span class="cl">api_key       abc1234
</span></span><span class="line"><span class="cl">api_secret    1a2b3c4d
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create token based on policy template Create read-only policy <code>test-read-policy</code> under <code>kv/test</code> paths</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># cat limit-token.hcl</span>
</span></span><span class="line"><span class="cl">path <span class="s2">&#34;kv/test&#34;</span><span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="nv">capabilities</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;read&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault policy write test-read-policy ./limit-token.hcl</span>
</span></span><span class="line"><span class="cl">Success! Uploaded policy: test-read-policy
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create token based on policy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault token create -policy=test-read-policy</span>
</span></span><span class="line"><span class="cl">Key                  Value
</span></span><span class="line"><span class="cl">---                  -----
</span></span><span class="line"><span class="cl">token                s.NMD47aWmzSUWC1bAqalQCWYw
</span></span><span class="line"><span class="cl">token_accessor       gi6WVfxwJnGqMXhDVoJXI5AU
</span></span><span class="line"><span class="cl">token_duration       768h
</span></span><span class="line"><span class="cl">token_renewable      <span class="nb">true</span> token_policies       <span class="o">[</span><span class="s2">&#34;default&#34;</span> <span class="s2">&#34;test-read-policy&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">identity_policies    <span class="o">[]</span>
</span></span><span class="line"><span class="cl">policies             <span class="o">[</span><span class="s2">&#34;default&#34;</span> <span class="s2">&#34;test-read-policy&#34;</span><span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Test the operation of the token, read-only, write error, in accordance with the established policy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># export VAULT_TOKEN=s.NMD47aWmzSUWC1bAqalQCWYw</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault kv get kv/test</span>
</span></span><span class="line"><span class="cl"><span class="o">=======</span> <span class="nv">Data</span> <span class="o">=======</span>
</span></span><span class="line"><span class="cl">Key           Value
</span></span><span class="line"><span class="cl">---           -----
</span></span><span class="line"><span class="cl">api_key       abc1234
</span></span><span class="line"><span class="cl">api_secret    1a2b3c4d5e6f
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault kv put  kv/test api_key=foo api_secret=bar</span>
</span></span><span class="line"><span class="cl">Error writing data to kv/test: Error making API request.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">URL: PUT http://127.0.0.1:8200/v1/kv/test
</span></span><span class="line"><span class="cl">Code: 403. Errors:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* <span class="m">1</span> error occurred:
</span></span><span class="line"><span class="cl">        * permission denied
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>View and close Secret engine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault secrets list</span>
</span></span><span class="line"><span class="cl">Path          Type         Accessor              Description
</span></span><span class="line"><span class="cl">----          ----         --------              -----------
</span></span><span class="line"><span class="cl">cubbyhole/    cubbyhole    cubbyhole_e86bac2b    per-token private secret storage
</span></span><span class="line"><span class="cl">identity/     identity     identity_19b16864     identity store
</span></span><span class="line"><span class="cl">kv/           kv           kv_988a3c7e           n/a
</span></span><span class="line"><span class="cl">secret/       kv           kv_a1c65202           n/a
</span></span><span class="line"><span class="cl">sys/          system       system_8d02021f       system endpoints used <span class="k">for</span> control, policy and debugging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault secrets disable secret/ #关闭 secret/</span>
</span></span><span class="line"><span class="cl">Success! Disabled the secrets engine <span class="o">(</span><span class="k">if</span> it existed<span class="o">)</span> at: secret/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~/vault<span class="o">]</span><span class="c1"># vault secrets list</span>
</span></span><span class="line"><span class="cl">Path          Type         Accessor              Description
</span></span><span class="line"><span class="cl">----          ----         --------              -----------
</span></span><span class="line"><span class="cl">cubbyhole/    cubbyhole    cubbyhole_e86bac2b    per-token private secret storage
</span></span><span class="line"><span class="cl">identity/     identity     identity_19b16864     identity store
</span></span><span class="line"><span class="cl">kv/           kv           kv_988a3c7e           n/a
</span></span><span class="line"><span class="cl">sys/          system       system_8d02021f       system endpoints used <span class="k">for</span> control, policy and debugging
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Turn on V2&rsquo;s Secret Engine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~<span class="o">]</span><span class="c1"># vault secrets enable -path=secretv2 -version=2 kv</span>
</span></span><span class="line"><span class="cl">Success! Enabled the kv secrets engine at: secretv2/
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM_120_245_centos ~<span class="o">]</span><span class="c1"># vault secrets list</span>
</span></span><span class="line"><span class="cl">Path               Type         Accessor              Description
</span></span><span class="line"><span class="cl">----               ----         --------              -----------
</span></span><span class="line"><span class="cl">bifrost_vault/     kv           kv_962069cd           n/a
</span></span><span class="line"><span class="cl">cubbyhole/         cubbyhole    cubbyhole_e86bac2b    per-token private secret storage
</span></span><span class="line"><span class="cl">identity/          identity     identity_19b16864     identity store
</span></span><span class="line"><span class="cl">kv/                kv           kv_988a3c7e           n/a
</span></span><span class="line"><span class="cl">secret/            kv           kv_4a27cb62           n/a
</span></span><span class="line"><span class="cl">secret_bifrost/    kv           kv_0b5b6ac3           n/a
</span></span><span class="line"><span class="cl">secretv2/          kv           kv_6e9e3b5b           n/a
</span></span><span class="line"><span class="cl">sys/               system       system_8d02021f       system endpoints used <span class="k">for</span> control, policy and debugging
</span></span><span class="line"><span class="cl">vault/             kv           kv_e26a68a4           n/a
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>More use can be found in the official documentation: <a href="https://learn.hashicorp.com">https://learn.hashicorp.com</a> to learn more.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/docker-file/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Customizing images with Dockerfile</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/c-emscripten-webassembly/">
            <span class="next-text nav-default">Write your own WebAssembly modules using C and Emscripten</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
