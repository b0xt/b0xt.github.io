<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Linkerd implements timeouts and retries via ServiceProfile - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to implement Linkerd&#39;s timeouts and retries through ServiceProfile" /><meta name="keywords" content="ServiceProfile, Linkerd, timeouts, retries" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/linkerd-timeout-retry/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Linkerd implements timeouts and retries via ServiceProfile" />
<meta property="og:description" content="Learn how to implement Linkerd&#39;s timeouts and retries through ServiceProfile" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/linkerd-timeout-retry/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-29T12:14:44+08:00" />
<meta property="article:modified_time" content="2022-08-29T12:14:44+08:00" />

<meta itemprop="name" content="Linkerd implements timeouts and retries via ServiceProfile">
<meta itemprop="description" content="Learn how to implement Linkerd&#39;s timeouts and retries through ServiceProfile"><meta itemprop="datePublished" content="2022-08-29T12:14:44+08:00" />
<meta itemprop="dateModified" content="2022-08-29T12:14:44+08:00" />
<meta itemprop="wordCount" content="5704">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linkerd implements timeouts and retries via ServiceProfile"/>
<meta name="twitter:description" content="Learn how to implement Linkerd&#39;s timeouts and retries through ServiceProfile"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Linkerd implements timeouts and retries via ServiceProfile</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-29 12:14:44 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 5704 words </span>
          <span class="more-meta"> 27 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#generating-a-service-profile">Generating a service profile</a></li>
        <li><a href="#view-per-route-metrics-in-linkerd-dashboard">View Per-Route Metrics in Linkerd Dashboard</a></li>
        <li><a href="#viewing-per-route-metrics-via-linkerd-cli">Viewing Per-Route Metrics via Linkerd CLI</a></li>
        <li><a href="#retries-and-timeouts">Retries and Timeouts</a>
          <ul>
            <li><a href="#using-per-route-metrics-to-determine-when-to-retry-and-timeout">Using Per-Route Metrics to Determine When to Retry and Timeout</a></li>
            <li><a href="#configuring-retries">Configuring Retries</a></li>
            <li><a href="#configuring-timeouts">Configuring Timeouts</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/f0c7eb85dfbd4c4a94ae2b4328c35516.png" alt="k8s"></p>
<p>One of the most important problems that Linkerd Service Mesh solves is observability: providing a detailed view of service behavior, Linkerd&rsquo;s value proposition for observability is that it can provide golden metrics for your HTTP and gRPC services that are executed automatically, without code changes or developer involvement.</p>
<p>Out of the box, Linkerd provides these metrics on a per-service basis: all requests across services, regardless of what those requests are. However, sometimes it is necessary to get more granular metrics. For example, for the Emoji microservice in the <code>Emojivoto</code> application earlier, the metrics reported by Linkerd as seen in the previous section are aggregated across all endpoints of that service. Under real-world scenarios, we may also want to see the success rate or latency of specific endpoints, for example, one endpoint may be particularly critical to the service, or particularly slow.</p>
<p>To solve this problem, Linkerd uses the concept of a service profile, which is an optional configuration that informs Linkerd about the different types of requests for a service, categorized by their routes. A route is simply an endpoint (for gRPC) or an HTTP verb and endpoint (for HTTP).</p>
<p>Service profiles allow Linkerd to provide per-route (pre-route) for services instead of per-service metrics, and in later sections we will also see that service profiles allow Linkerd to perform configurations such as retries and timeouts on services, but for now let&rsquo;s just focus on metrics.</p>
<p>It is also important to note that service profiles are not simply required for a service to run with Linkerd, they are optional configuration bits that enable more advanced behavior of Linkerd, and they are one of the few examples of Linkerd using Kubernetes CRD. Next we will still illustrate the use of service profiles with the <code>Emojivoto</code> application.</p>
<h2 id="generating-a-service-profile">Generating a service profile</h2>
<p>Linkerd&rsquo;s service profile is implemented by instantiating a Kubernetes CRD named <code>ServiceProfile</code>. The <code>ServiceProfile</code> will enumerate the routes that Linkerd expects for that service.</p>
<p>We can create <code>ServiceProfiles</code> manually, but they can also be generated automatically. the Linkerd CLI has a <code>profile</code> command that can generate service profiles in a few different ways. One of the most common ways is to generate them from the service&rsquo;s existing resources, such as the <code>OpenAPI/Swagger</code> specification or <code>protobuf</code> files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd profile -h
</span></span><span class="line"><span class="cl">Output service profile config <span class="k">for</span> Kubernetes.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  linkerd profile <span class="o">[</span>flags<span class="o">]</span> <span class="o">(</span>--template <span class="p">|</span> --open-api file <span class="p">|</span> --proto file<span class="o">)</span> <span class="o">(</span>SERVICE<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Examples:
</span></span><span class="line"><span class="cl">  <span class="c1"># Output a basic template to apply after modification.</span>
</span></span><span class="line"><span class="cl">  linkerd profile -n emojivoto --template web-svc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Generate a profile from an OpenAPI specification.</span>
</span></span><span class="line"><span class="cl">  linkerd profile -n emojivoto --open-api web-svc.swagger web-svc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Generate a profile from a protobuf definition.</span>
</span></span><span class="line"><span class="cl">  linkerd profile -n emojivoto --proto Voting.proto vote-svc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flags:
</span></span><span class="line"><span class="cl">  -h, --help               <span class="nb">help</span> <span class="k">for</span> profile
</span></span><span class="line"><span class="cl">      --ignore-cluster     Output a service profile through offline generation
</span></span><span class="line"><span class="cl">  -n, --namespace string   Namespace of the service
</span></span><span class="line"><span class="cl">      --open-api string    Output a service profile based on the given OpenAPI spec file
</span></span><span class="line"><span class="cl">      --proto string       Output a service profile based on the given Protobuf spec file
</span></span><span class="line"><span class="cl">      --template           Output a service profile template
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Global Flags:
</span></span><span class="line"><span class="cl">      --api-addr string            Override kubeconfig and communicate directly with the control plane at host:port <span class="o">(</span>mostly <span class="k">for</span> testing<span class="o">)</span>
</span></span><span class="line"><span class="cl">      --as string                  Username to impersonate <span class="k">for</span> Kubernetes operations
</span></span><span class="line"><span class="cl">      --as-group stringArray       Group to impersonate <span class="k">for</span> Kubernetes operations
</span></span><span class="line"><span class="cl">      --cni-namespace string       Namespace in which the Linkerd CNI plugin is installed <span class="o">(</span>default <span class="s2">&#34;linkerd-cni&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      --context string             Name of the kubeconfig context to use
</span></span><span class="line"><span class="cl">      --kubeconfig string          Path to the kubeconfig file to use <span class="k">for</span> CLI requests
</span></span><span class="line"><span class="cl">  -L, --linkerd-namespace string   Namespace in which Linkerd is installed <span class="o">(</span><span class="nv">$LINKERD_NAMESPACE</span><span class="o">)</span> <span class="o">(</span>default <span class="s2">&#34;linkerd&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">      --verbose                    Turn on debug logging
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above help command output lists the flags that can be used to generate YAML for a <code>ServiceProfile</code> resource, and you can see that one of them is the <code>-open-api</code> flag, which instructs the <code>ServiceProfile</code> resource to generate a service profile from the specified <code>OpenAPI</code> or <code>Swagger</code> document, and the <code>--proto</code> flag to indicate that the service profile will be generated from the specified <code>Protobuf</code> file.</p>
<p>The web service for <code>Emojivoto</code> has a simple Swagger specification file that reads as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># web.swagger</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">openapi</span><span class="p">:</span><span class="w"> </span><span class="m">3.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">/api/list</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">get</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">/api/vote</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">get</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now we can use the above specification file to generate a ServiceProfile object with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd profile -n emojivoto --open-api web.swagger web-svc &gt; web-sp.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command will output the <code>ServiceProfile</code> resource manifest file for service <code>web-svc</code>. Note that just like the <code>linkerd install</code> command, the <code>linkerd profile</code> command only generates YAML, which does not apply YAML to the cluster, so we redirect the output to the <code>web-sp.yaml</code> file, which corresponds to the following generated file contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">linkerd.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceProfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web-svc.emojivoto.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">emojivoto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/vote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/vote</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The resource manifest file above is a typical way of declaring a <code>ServiceProfile</code> object, <code>spec.routes</code> is used to declare all routing rules, each route contains a <code>name</code> and <code>condition</code> attribute.</p>
<ul>
<li><code>name</code> is used to indicate the name of the route for display use.</li>
<li><code>condition</code> is used to describe the specification of the route. The <code>condition</code> generated in the above example has two fields.
<ul>
<li><code>method</code>: the HTTP method that matches the request.</li>
<li><code>pathRegex</code>: the regular expression used to match the path. In our example, these are exact match rules, but usually these are regular expressions.</li>
</ul>
</li>
</ul>
<p>In addition to the service configuration files that can be generated via <code>OpenAPI</code>, they can also be generated via <code>Protobuf</code>. The gRPC protocol uses protobuf to encode and decode requests and responses, which means that each gRPC service also has a protobuf definition.</p>
<p>The Voting microservice for the <code>Emojivoto</code> application contains a protobuf definition, the contents of which are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-proto" data-lang="proto"><span class="line"><span class="cl"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">option</span> <span class="n">go_package</span> <span class="o">=</span> <span class="s">&#34;github.com/buoyantio/emojivoto/proto&#34;</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kn">package</span> <span class="nn">emojivoto</span><span class="o">.</span><span class="n">v1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">VotingResult</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="kt">string</span> <span class="n">Shortcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="kt">int32</span> <span class="n">Votes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">VoteRequest</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">VoteResponse</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">ResultsRequest</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">message</span> <span class="nc">ResultsResponse</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="k">repeated</span> <span class="n">VotingResult</span> <span class="n">results</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="kd">service</span> <span class="n">VotingService</span> <span class="p">{</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="k">rpc</span> <span class="n">VotePoop</span> <span class="p">(</span><span class="n">VoteRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">VoteResponse</span><span class="p">);</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="k">rpc</span> <span class="n">VoteJoy</span> <span class="p">(</span><span class="n">VoteRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">VoteResponse</span><span class="p">);</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="k">rpc</span> <span class="n">VoteSunglasses</span> <span class="p">(</span><span class="n">VoteRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">VoteResponse</span><span class="p">);</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>    <span class="o">......</span><span class="n">Omit</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">content</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">}</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Also now we can use the <code>linkerd profile</code> command to generate the corresponding <code>ServiceProfile</code> object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd profile -n emojivoto --proto Voting.proto voting-svc &gt; voting-sp.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output of this command will be much more than the output of the previous command because the <code>Voting.proto</code> file defines more routes. We can look at the <code>voting-sp.yaml</code> file and compare it with the <code>ServiceProfile</code> resource created above.</p>
<p>There is also another way to dynamically generate <code>ServiceProfile</code>, where Linkerd can monitor live requests coming in during a specified time period and collect routing data from them. This is a very powerful feature for cluster administrators who are not aware of the internal routing provided by the service, as Linkerd takes care of processing the requests and writing them to a file, the underlying principle of this feature is the <code>Tap</code> feature for watching requests in real time mentioned in the previous section.</p>
<p>Now, let&rsquo;s use the <code>linkerd profile</code> command to monitor the <code>emoji</code> service for 10 seconds and redirect the output to a file. As with all the commands we learned earlier, the output will be printed to the terminal and this command will redirect the output to a file, so we only have to run the command (and wait 10 seconds) once.</p>
<p>The Linkerd Viz extension also has its own profile subcommand that can be used in conjunction with the <code>Tap</code> function to generate service profiles from live traffic! As shown in the command below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto &gt; emoji-sp.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>When requests are sent to the <code>emoji</code> service, these routes are collected via the <code>Tap</code> function. We can also use the <code>Emoji.proto</code> file to generate a service profile and then compare the definitions of the <code>ServiceProfile</code> resources created with the <code>-proto</code> and <code>-tap</code> flags.</p>
<p>The contents of the generated <code>ServiceProfile</code> resource manifest file are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># emoji-sp.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">linkerd.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceProfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">emoji-svc.emojivoto.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">emojivoto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">POST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/emojivoto\.v1\.EmojiService/FindByShortcode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POST /emojivoto.v1.EmojiService/FindByShortcode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">POST</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/emojivoto\.v1\.EmojiService/ListAll</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POST /emojivoto.v1.EmojiService/ListAll</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>If you need to write a service profile manually, the <code>-linkerd profile</code> command has a <code>-template</code> flag that generates a scaffold for the <code>ServiceProfile</code> resource, which can then be updated with your service&rsquo;s details.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd profile --template -n emojivoto emoji-svc
</span></span><span class="line"><span class="cl"><span class="c1">### ServiceProfile for emoji-svc.emojivoto ###</span>
</span></span><span class="line"><span class="cl">apiVersion: linkerd.io/v1alpha2
</span></span><span class="line"><span class="cl">kind: ServiceProfile
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: emoji-svc.emojivoto.svc.cluster.local
</span></span><span class="line"><span class="cl">  namespace: emojivoto
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  <span class="c1"># A service profile defines a list of routes.  Linkerd can aggregate metrics</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># like request volume, latency, and success rate by route.</span>
</span></span><span class="line"><span class="cl">  routes:
</span></span><span class="line"><span class="cl">  - name: <span class="s1">&#39;/authors/{id}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Each route must define a condition.  All requests that match the</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># condition will be counted as belonging to that route.  If a request</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># matches more than one route, the first match wins.</span>
</span></span><span class="line"><span class="cl">    condition:
</span></span><span class="line"><span class="cl">      <span class="c1"># The simplest condition is a path regular expression.</span>
</span></span><span class="line"><span class="cl">      pathRegex: <span class="s1">&#39;/authors/\d+&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># This is a condition that checks the request method.</span>
</span></span><span class="line"><span class="cl">      method: POST
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># If more than one condition field is set, all of them must be satisfied.</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># This is equivalent to using the &#39;all&#39; condition:</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># all:</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># - pathRegex: &#39;/authors/\d+&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># - method: POST</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># Conditions can be combined using &#39;all&#39;, &#39;any&#39;, and &#39;not&#39;.</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># any:</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># - all:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - method: POST</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - pathRegex: &#39;/authors/\d+&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># - all:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - not:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#       method: DELETE</span>
</span></span><span class="line"><span class="cl">      <span class="c1">#   - pathRegex: /info.txt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># A route may be marked as retryable.  This indicates that requests to this</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># route are always safe to retry and will cause the proxy to retry failed</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># requests on this route whenever possible.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># isRetryable: true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># A route may optionally define a list of response classes which describe</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># how responses from this route will be classified.</span>
</span></span><span class="line"><span class="cl">    responseClasses:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Each response class must define a condition.  All responses from this</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># route that match the condition will be classified as this response class.</span>
</span></span><span class="line"><span class="cl">    - condition:
</span></span><span class="line"><span class="cl">        <span class="c1"># The simplest condition is a HTTP status code range.</span>
</span></span><span class="line"><span class="cl">        status:
</span></span><span class="line"><span class="cl">          min: <span class="m">500</span>
</span></span><span class="line"><span class="cl">          max: <span class="m">599</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Specifying only one of min or max matches just that one status code.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># status:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   min: 404 # This matches 404s only.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Conditions can be combined using &#39;all&#39;, &#39;any&#39;, and &#39;not&#39;.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># all:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># - status:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     min: 500</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     max: 599</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># - not:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     status:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#       min: 503</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># The response class defines whether responses should be counted as</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># successes or failures.</span>
</span></span><span class="line"><span class="cl">      isFailure: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># A route can define a request timeout.  Any requests to this route that</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># exceed the timeout will be canceled.  If unspecified, the default timeout</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># is &#39;10s&#39; (ten seconds).</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># timeout: 250ms</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># A service profile can also define a retry budget.  This specifies the</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># maximum total number of retries that should be sent to this service as a</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># ratio of the original request volume.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># retryBudget:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   The retryRatio is the maximum ratio of retries requests to original</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   requests.  A retryRatio of 0.2 means that retries may add at most an</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   additional 20% to the request load.</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   retryRatio: 0.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">#   This is an allowance of retries per second in addition to those allowed</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   by the retryRatio.  This allows retries to be performed, when the request</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   rate is very low.</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   minRetriesPerSecond: 10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">#   This duration indicates for how long requests should be considered for the</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   purposes of calculating the retryRatio.  A higher value considers a larger</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   window and therefore allows burstier retries.</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#   ttl: 10s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command will output the fields containing the <code>ServiceProfile</code> resources and a detailed description of each field, or if you need a quick reference to the <code>ServiceProfile</code> definition, you can use the <code>--template</code> flag!</p>
<p>At this point we understand how to generate the <code>ServiceProfile</code> resource manifest file, next let&rsquo;s look at the metrics data for each route defined in the service profile.</p>
<h2 id="view-per-route-metrics-in-linkerd-dashboard">View Per-Route Metrics in Linkerd Dashboard</h2>
<p>Above we learned how to use the <code>linkerd profile</code> command to generate a <code>ServiceProfile</code> resource manifest file, now let&rsquo;s rerun the generate command and apply the generated <code>ServiceProfile</code> object directly to the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd profile -n emojivoto --open-api web.swagger web-svc <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">serviceprofile.linkerd.io/web-svc.emojivoto.svc.cluster.local created
</span></span><span class="line"><span class="cl">$ linkerd profile -n emojivoto --proto Voting.proto voting-svc <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">serviceprofile.linkerd.io/voting-svc.emojivoto.svc.cluster.local created
</span></span><span class="line"><span class="cl">$ linkerd viz profile emoji-svc --tap deploy/emoji --tap-duration 10s -n emojivoto <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">serviceprofile.linkerd.io/emoji-svc.emojivoto.svc.cluster.local created
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the above command has run successfully, let&rsquo;s open the Linkerd dashboard to see the metrics, and we&rsquo;ll start by navigating to Web Deployment to see the metrics for each route.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/6ae722af633b4d2bb6e12ccdf427c52d.png" alt="Routing Metrics in Linkerd Dashboard"></p>
<p>From the above figure, we can see that under the <code>ROUTE METRICS</code> tab there are two more routes than the default <code>[DEFAULT]</code> route, which are the two routes we generated from the <code>web.swagger</code> file with the <code>linkerd profile --open-api</code> command. Each metric data for both routes. Before deploying the <code>ServiceProfile</code> object, we could only see the aggregated metrics for the web service, after deployment we can now see that the <code>/api/list</code> route is 100% successful and the <code>/api/vote</code> route has some errors.</p>
<p>Again before the service profile we only knew that the web service was returning errors, now we have errors coming from the <code>/api/vote</code> route, and the additional <code>[DEFAULT]</code> default route indicates the route Linkerd uses when there is no route in the service profile to match the request, and it will catch any traffic observed before the <code>ServiceProfile</code>. any traffic observed before <code>ServiceProfile</code>.</p>
<p>Now let&rsquo;s go to the other service profile, where the <code>Voting</code> service is more representative because it contains a lot of routes. On the Linkerd Dashboard page go to Voting Deployment on the <code>emojivoto</code> namespace and switch to the <code>ROUTE METRICS</code> tab. We will have a very large number of routes under this service, the web service above we know that the <code>/api/vote</code> route has a success rate of less than 100%, each route information in all voting services may provide related error messages, since there are so many routes, we can directly sort them in ascending order by the <code>Success Rate</code> column, normally you can See that the <code>VoteDoughnut</code> route has a success rate of 0.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/cf974e4c04104dffbd64bebb6fb3bd3e.png" alt="Voting Service Routing"></p>
<h2 id="viewing-per-route-metrics-via-linkerd-cli">Viewing Per-Route Metrics via Linkerd CLI</h2>
<p>We&rsquo;ve already learned how to view per-route metrics for services in the <code>Emojivoto</code> application via the Dashboard, so let&rsquo;s try using the CLI tool to view per-route metrics.</p>
<p>The <code>linkerd viz routes</code> command uses the same metrics as the Dashboard, so let&rsquo;s take a look at using the Linkerd CLI to view the routes for the <code>emoji</code> service, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz routes deploy/emoji -n emojivoto
</span></span><span class="line"><span class="cl">ROUTE                                               SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span class="line"><span class="cl">POST /emojivoto.v1.EmojiService/FindByShortcode   emoji-svc   100.00%   1.0rps           1ms           1ms           1ms
</span></span><span class="line"><span class="cl">POST /emojivoto.v1.EmojiService/ListAll           emoji-svc   100.00%   1.0rps           1ms           1ms           1ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEFAULT<span class="o">]</span>                                         emoji-svc         -        -             -             -             -
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that both routes defined for the <code>emoji</code> service were successful and processed the request within 1ms, which shows that these routes are healthy. Note also our default route, marked as <code>[DEFAULT]</code>, again this is the route Linkerd uses when there is no route in the service profile that matches the request.</p>
<p>Now we use the <code>linkerd viz routes</code> command in the same way to see the routes for the voting and web services, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz routes deploy/web -n emojivoto
</span></span><span class="line"><span class="cl">ROUTE           SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span class="line"><span class="cl">GET /api/list   web-svc   100.00%   1.0rps           1ms           1ms           1ms
</span></span><span class="line"><span class="cl">GET /api/vote   web-svc    88.33%   1.0rps           2ms           7ms           9ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEFAULT<span class="o">]</span>       web-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl">$ linkerd viz routes deploy/voting -n emojivoto
</span></span><span class="line"><span class="cl">ROUTE                             SERVICE   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span class="line"><span class="cl">Results                        voting-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl">Vote100                        voting-svc   100.00%   0.0rps           1ms           1ms           1ms
</span></span><span class="line"><span class="cl">VoteBacon                      voting-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl">VoteBalloon                    voting-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output of the voting service is long because it has many routes, so you can find <code>VoteDoughnut</code> routes with the <code>grep</code> command: <code>linkerd viz routes deploy/voting -n emojivoto | grep VoteDoughnut</code> (or you can use the <code>-o json</code> flag and tools like <code>jq</code> to parse the output).</p>
<p>At this point we&rsquo;ve learned about Linkerd&rsquo;s service profile functionality, and for now we&rsquo;ll focus on the observability features of the service profile, where we can look at the golden metrics of each route we learned about earlier. Next we will dive further into <code>ServiceProfile</code> and explore Linkerd&rsquo;s retry and timeout features.</p>
<h2 id="retries-and-timeouts">Retries and Timeouts</h2>
<p>Next, we&rsquo;ll look at how to configure timeouts and retries using <code>ServiceProfile</code>. Linkerd can ensure reliability through traffic splitting, load balancing, retries and timeouts, each of which plays an important role in improving the overall reliability of the system.</p>
<p>But what kind of reliability do these features actually add? It comes down to the fact that Linkerd can help prevent transient failures. If the service shuts down completely, or always returns a failure, or always hangs, then no amount of retries or load balancing will help. But if an instance of the service goes down, or if the potential problem is only temporary, then that&rsquo;s when Linkerd can come in handy, and these partial, temporary failures are the most frequent problems with distributed systems!</p>
<p>Here are two important things to understand when it comes to Linkerd&rsquo;s core reliability features of load balancing, retries, and timeouts (traffic segmentation, also a reliability feature, but a little less so, which we&rsquo;ll address in a later section).</p>
<ol>
<li>all of these techniques occur on the client side: the agent making the call is the agent performing these functions, not the server-side agent. If your server is on the grid, but your client is not, then these features will not be enabled in the calls between the two!</li>
<li>These three features work best together. Without retries, timeouts are of little value; and without load balancing, retries are almost worthless.</li>
</ol>
<p>We can start by understanding load balancing, Linkerd automatically load balances requests between possible destinations, note the word <strong>request</strong> - unlike quad or <code>TCP load balancing</code>, which balances connections, Linkerd will establish connections to the set of possible endpoints and balance requests between all these connections. This allows for more granular control of traffic and, in the background, Linkerd&rsquo;s approach is very sophisticated, using techniques such as <strong>Exponentially Weighted Moving Average of Server Latency (EWMA)</strong> to optimize where requests go; pool connections across endpoints where possible; and automatically escalate HTTP/1.1 traffic to HTTP/2 connections between proxies. However, from our perspective, there is no configuration, just the knowledge that <strong>Linkerd automatically balances requests across its endpoints</strong> .</p>
<p>Next, look at timeouts, which are a way to set a maximum time on a route. Let&rsquo;s say you have a route named <code>getValue()</code> on your service, and the performance of <code>getValue()</code> is unpredictable: most of the time <code>getValue()</code> will return within 10 milliseconds, but sometimes it takes 10 minutes to return, perhaps because of lock contention on some contested resource. If there is no timeout, calling <code>getValue()</code> will take anywhere between 10 milliseconds and 10 minutes, but if a timeout of 500 milliseconds is set, then <code>getValue()</code> will take up to 500 milliseconds.</p>
<p>Adding a timeout can be used as a mechanism to limit the system&rsquo;s worst-case latency by allowing the caller of <code>getValue()</code> to have more predictable performance and not take up resources waiting for a 10-minute long call to return. Second, and more importantly, the timeout can be combined with retry and load balancing to automatically resend the request to a different instance of the service. If <code>getValue()</code> is slow on instance A, it may be fast on instance B or C, and even multiple retries will be far less than waiting 10 minutes.</p>
<p>So let&rsquo;s look at retry, which is when Linkerd automatically retries a request. In what scenarios would this be useful? Again due to some temporary errors: if a specific route on a specific instance returns an error and simply retrying the request may result in a successful response, it is of course important to realize that simply retrying the request does not guarantee a successful response. If the underlying errors are not temporary, or if Linkerd is unable to retry, then the application will still need to handle them.</p>
<p>In practice, implementing retries can be cumbersome. There is also a risk that taking it for granted may add additional load to the system, a load that may make things worse. One common failure scenario is the <strong>retry storm</strong>: a transient failure in service A triggers retries by B on its requests; these retries cause A to overload, which means that B starts a failed request; this triggers retries by its caller C on B, which then causes B to overload, and so on. This is especially true for systems that allow you to configure the maximum number of retries per request: a maximum of 3 retries per request may not sound like a problem, but in the worst case it will increase the load by 300%.</p>
<p>Linkerd minimizes the possibility of retry storms by setting parameters for retries using a <strong>retry budget</strong> rather than a per-request limit. The retry budget is a percentage of the total number of requests that can be retried, and Linkerd&rsquo;s default behavior is to allow 20% (200) retries for failed requests, plus an additional 10 requests per second. For example, if the original request load is 1000 requests per second, then Linkerd will allow 210 requests per second to be retried. When the budget is exhausted, Linkerd will not retry the request, but will return a 504 error to the client.</p>
<p>In summary: load balancing, retries, and timeouts are all designed to protect application reliability in the event of partial, temporary failures and to prevent those failures from escalating into global outages. But they are not a panacea, and we must still be able to handle errors in our applications.</p>
<h3 id="using-per-route-metrics-to-determine-when-to-retry-and-timeout">Using Per-Route Metrics to Determine When to Retry and Timeout</h3>
<p>We learned above about the reasons for using retries and timeouts in Linkerd, so let&rsquo;s build on the observability features we learned about earlier and use metrics to make decisions about applying retries and timeouts.</p>
<p>First, we&rsquo;ll look at the statistics of all Deployments in the <code>emojivoto</code> namespace, and then we&rsquo;ll dive into unhealthy services. This is done directly using the <code>linkerd viz stat</code> command, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz stat deploy -n emojivoto
</span></span><span class="line"><span class="cl">NAME       MESHED   SUCCESS      RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99   TCP_CONN
</span></span><span class="line"><span class="cl">emoji         1/1   100.00%   2.3rps           1ms           1ms           4ms          <span class="m">3</span>
</span></span><span class="line"><span class="cl">vote-bot      1/1   100.00%   0.3rps           1ms           2ms           2ms          <span class="m">1</span>
</span></span><span class="line"><span class="cl">voting        1/1    87.01%   1.3rps           1ms           7ms           9ms          <span class="m">3</span>
</span></span><span class="line"><span class="cl">web           1/1    91.91%   2.3rps           1ms          10ms          28ms          <span class="m">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>stat</code> command shows us the golden metrics, including success rate and latency, and we can notice that the success rate of the voting and web services is below 100%, and next we can use the <code>linkerd viz edges</code> command to understand the relationship between the services.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz edges deploy -n emojivoto
</span></span><span class="line"><span class="cl">SRC          DST        SRC_NS        DST_NS      SECURED
</span></span><span class="line"><span class="cl">vote-bot     web        emojivoto     emojivoto   √
</span></span><span class="line"><span class="cl">web          emoji      emojivoto     emojivoto   √
</span></span><span class="line"><span class="cl">web          voting     emojivoto     emojivoto   √
</span></span><span class="line"><span class="cl">prometheus   emoji      linkerd-viz   emojivoto   √
</span></span><span class="line"><span class="cl">prometheus   vote-bot   linkerd-viz   emojivoto   √
</span></span><span class="line"><span class="cl">prometheus   voting     linkerd-viz   emojivoto   √
</span></span><span class="line"><span class="cl">prometheus   web        linkerd-viz   emojivoto   √
</span></span></code></pre></td></tr></table>
</div>
</div><p>Of course, you can also use the Linkerd Dashboard to see the octopus diagram to understand the relationship between services.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/ab45440e97794422a1ab23393fb61d2a.png" alt="octopus diagram"></p>
<p>From the above results, we can see that the Pods in the web service are calling the Pods of the voting service, so we can guess that the voting service is causing the errors in the web service, but of course this is not the end of the story. We have metrics for each route and should be able to see exactly which routes have a success rate of less than 100%, so you can find out what the voting service&rsquo;s route metrics are by using the <code>linkerd viz routes</code> command, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz routes deploy/voting -n emojivoto
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">VoteDog                        voting-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl">VoteDoughnut                   voting-svc     0.00%   0.1rps           1ms           1ms           1ms
</span></span><span class="line"><span class="cl">VoteFax                        voting-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl">VoteFire                       voting-svc   100.00%   0.0rps           1ms           1ms           1ms
</span></span><span class="line"><span class="cl">VoteFlightDeparture            voting-svc         -        -             -             -             -
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can also view the <code>ROUTE METRICS</code> information for the voting service through the Linkerd Dashboard, as shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/29/daaf9e3912794996a7c37b4eb47a2f34.png" alt="Linkerd Dashboard"></p>
<p>We can finally pinpoint <code>VoteDoughnut</code> as the route where the request failed. Now we not only know that an error occurred between the web service and the voting service, but we also know that an error occurred with the <code>VoteDoughnut</code> route. Next we can use retries to try to resolve the error and also ask the developer to debug the code.</p>
<h3 id="configuring-retries">Configuring Retries</h3>
<p>Before we start configuring retries for <code>VotingDoughnut</code> routing, we must first take a closer look at the web and voting service metrics, as this will help us really understand if applying retries will solve the problem. Here we will only use the Linkerd CLI because it can show us the actual and valid request volume and success rates by using the <code>-o wide</code> flag. The Linkerd dashboard will show the overall success rate and RPS, but not the actual and valid metrics. The difference between actual and valid metrics is as follows.</p>
<ul>
<li>Actual values are from the perspective of the server receiving the request</li>
<li>Valid values are from the point of view of the client sending the request</li>
</ul>
<p>In the absence of retries and timeouts, obviously the two figures are the same. However, once retries or timeouts are configured, they may not be the same. For example, a retry can make the actual RPS higher than the valid RPS, because from the server&rsquo;s perspective, the retry is another request, but from the client&rsquo;s perspective, it is the same request. Retries can make the actual success rate lower than the effective success rate because the failed retry call also occurs on the server but is not exposed to the client. And a timeout may have the opposite effect: depending on the exact return time, a timeout request that eventually returns successfully may make the actual success rate higher than the valid success rate, because the server sees it as a success, while the client only sees a failure.</p>
<p>The overall point is that Linkerd&rsquo;s actual and valid metrics may differ in the case of retries or timeouts, but the actual number represents the actual hit to the server, while the valid number represents that the client effectively got a response to its request after Linkerd&rsquo;s reliability logic had done its job.</p>
<p>For example, we check the routing metrics of the vote-bot service with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -owide
</span></span><span class="line"><span class="cl">ROUTE           SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span class="line"><span class="cl">GET /api/list   web-svc             100.00%          1.0rps          100.00%       1.0rps           1ms           2ms           2ms
</span></span><span class="line"><span class="cl">GET /api/vote   web-svc              86.21%          1.0rps           86.21%       1.0rps           2ms           7ms          10ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEFAULT<span class="o">]</span>       web-svc                   -               -                -            -             -             -             -
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the above command we added a <code>-o wide</code> flag so that the output will contain both actual and valid success and RPS metrics. Looking at the vote-bot service, the effective success rate and actual success rate for the <code>/api/vote</code> route for the web service are both below 100%, because we do not have retries configured yet. And we can&rsquo;t assume that all requests are retryable; retry requests are very specific to Linkerd.</p>
<ul>
<li>
<p>Right now, requests using the HTTP POST method are not retryable in Linkerd. Because POST requests almost always contain data in the request <code>body</code>, retrying the request means that the proxy must store that data in memory. Therefore, to keep memory usage to a minimum, the proxy does not store POST request <code>bodies</code> and they cannot be retried.</p>
</li>
<li>
<p>As we mentioned earlier, Linkerd only treats the <code>5XX</code> status code in the response as an error, while both <code>2XX</code> and <code>4XX</code> are recognized as success status codes. The <code>4XX</code> status code indicates that the server looked but could not find the resource, which is correct server behavior, while the <code>5XX</code> status code indicates that the server encountered an error while processing the request, which is incorrect behavior.</p>
</li>
</ul>
<p>Now let&rsquo;s verify what we have learned by adding a retry function to the <code>/api/vote</code> route of the web service. Let&rsquo;s look at the <code>ServiceProfile</code> object of the web service again, which looks like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># web-sp.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">linkerd.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceProfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web-svc.emojivoto.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">emojivoto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/vote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/vote</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Next we add an attribute <code>isRetryable: true</code> to the route <code>/api/vote</code>, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># web-sp-with-retry.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># ......</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/vote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/vote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">isRetryable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Reapply the <code>ServiceProfile</code> object after updating.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f web-sp-with-retry.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>After application we can observe the change in the routing metrics of the vote-bot service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide
</span></span><span class="line"><span class="cl">Every 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide                   MBP2022.local: Sun Aug <span class="m">28</span> 17:41:37 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ROUTE           SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span class="line"><span class="cl">GET /api/list   web-svc             100.00%          1.0rps          100.00%       1.0rps           2ms           8ms          10ms
</span></span><span class="line"><span class="cl">GET /api/vote   web-svc              85.00%          1.0rps           16.50%       5.0rps           4ms         255ms         290ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEFAULT<span class="o">]</span>       web-svc                   -               -                -            -             -             -             -
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the actual success rate becomes very low, because the retry result may still be wrong. We mentioned above that Linkerd&rsquo;s retry behavior is configured by the retry budget, and that when <code>isRetryable: true</code> is configured, the default retry budget rules are applied, and the following YAML fragment of the <code>ServiceProfile</code> resource shows the <code>retryBudget</code> object configuration with default values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">retryBudget</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">retryRatio</span><span class="p">:</span><span class="w"> </span><span class="m">0.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minRetriesPerSecond</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>where the <code>retryBudget</code> parameter is with three main fields.</p>
<ul>
<li><code>retryRatio</code>: the retry rate, which indicates the maximum ratio of retry requests to original requests. A <code>retryRatio</code> of 0.2 means that retry will increase the request load by up to 20%.</li>
<li><code>minRetriesPerSecond</code>: this is the number of retries per second allowed in addition to those allowed by <code>retryRatio</code> (this allows retries when the request rate is very low), default is 10 RPS.</li>
<li><code>ttl</code>: indicates how long requests should be considered when calculating the retry rate, a larger value will consider a larger window and therefore allow more retries. The default is 10 seconds.</li>
</ul>
<h3 id="configuring-timeouts">Configuring Timeouts</h3>
<p>In addition to the retry and retry budget, Linkerd also provides a timeout feature that allows you to ensure that requests for a given route never exceed a specified amount of time.</p>
<p>To illustrate this, let&rsquo;s take a fresh look at each of the routing metrics for the web and voting services.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide
</span></span><span class="line"><span class="cl">$ linkerd viz routes deploy/web -n emojivoto --to deploy/voting -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have already learned that the delay between web and voting is close to 1ms. To demonstrate the timeout, we set the <code>/api/vote</code> route timeout to 0.5ms, so that basically it will not be able to meet the requirements and timeout will occur, Linkerd will send the error to the client, and the success rate will become 0.</p>
<p>Modify the <code>ServiceProfile</code> object of the web service and add the <code>timeout</code> property, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># web-sp-with-timeout.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">linkerd.io/v1alpha2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceProfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web-svc.emojivoto.svc.cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">emojivoto</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">condition</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pathRegex</span><span class="p">:</span><span class="w"> </span><span class="l">/api/vote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GET /api/vote</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0.</span><span class="l">5ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">isRetryable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After applying the above object, both the valid and actual success rates of the service drop to 0, because <code>/api/vote</code> times out within 0.5ms, so the success rate becomes 0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ watch linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide
</span></span><span class="line"><span class="cl">Every 2.0s: linkerd viz routes deploy/vote-bot -n emojivoto --to deploy/web -o wide                   MBP2022.local: Sun Aug <span class="m">28</span> 19:12:15 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ROUTE           SERVICE   EFFECTIVE_SUCCESS   EFFECTIVE_RPS   ACTUAL_SUCCESS   ACTUAL_RPS   LATENCY_P50   LATENCY_P95   LATENCY_P99
</span></span><span class="line"><span class="cl">GET /api/list   web-svc             100.00%          1.0rps          100.00%       1.0rps           2ms           2ms           2ms
</span></span><span class="line"><span class="cl">GET /api/vote   web-svc               0.00%          1.0rps            0.00%       0.0rps           0ms           0ms           0ms
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEFAULT<span class="o">]</span>       web-svc                   -               -                -            -             -             -             -
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point we understand the use of retries and timeouts in Linkerd, which are part of Linkerd&rsquo;s overall policy to increase reliability in the event of a transient failure. We decide when and how to configure retries and timeouts by using per-route metrics in the service profile, and Linkerd parameters its retries with a retry budget to avoid &ldquo;retry storms&rdquo; where the agent will stop sending requests to the service when the retry budget is exhausted to avoid overloading the service and potentially affecting the rest of the application.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/isito-vm-health-check/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Isito Virtual Machine Health Check</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/cpp-prop-reflect/">
            <span class="next-text nav-default">Property Reflection in C&#43;&#43;</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
