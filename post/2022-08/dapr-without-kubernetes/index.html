<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to play Dapr without Kubernetes? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Exploring solutions for deploying Dapr without Kubernetes." /><meta name="keywords" content="without Kubernetes, Dapr" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/dapr-without-kubernetes/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How to play Dapr without Kubernetes?" />
<meta property="og:description" content="Exploring solutions for deploying Dapr without Kubernetes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/dapr-without-kubernetes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-17T11:32:19+08:00" />
<meta property="article:modified_time" content="2022-08-17T11:32:19+08:00" />

<meta itemprop="name" content="How to play Dapr without Kubernetes?">
<meta itemprop="description" content="Exploring solutions for deploying Dapr without Kubernetes."><meta itemprop="datePublished" content="2022-08-17T11:32:19+08:00" />
<meta itemprop="dateModified" content="2022-08-17T11:32:19+08:00" />
<meta itemprop="wordCount" content="2737">
<meta itemprop="keywords" content="devops," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to play Dapr without Kubernetes?"/>
<meta name="twitter:description" content="Exploring solutions for deploying Dapr without Kubernetes."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to play Dapr without Kubernetes?</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-17 11:32:19 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2737 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-nameresolution-component">1. NameResolution Component</a></li>
        <li><a href="#2-resolver">2. Resolver</a></li>
        <li><a href="#3-simulating-service-registration-and-load-balancing">3. Simulating Service Registration and Load Balancing</a></li>
        <li><a href="#4-customizing-the-nameresolution-component">4. Customizing the NameResolution component</a></li>
        <li><a href="#5-registering-a-custom-nameresolution-component">5. Registering a Custom NameResolution Component</a></li>
        <li><a href="#6-compile-and-deploy-daprdexe">6. Compile and deploy daprd.exe</a></li>
        <li><a href="#7-configuring-svcreg">7. Configuring svcreg</a></li>
        <li><a href="#8-testing-the-effects">8. Testing the Effects</a></li>
        <li><a href="#reference">Reference</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Dapr is designed as an enterprise-class microservices programming platform for developers that is independent of specific technology platforms and can run &ldquo;anywhere&rdquo;. Dapr itself does not provide an &ldquo;infrastructure&rdquo;, but rather uses its own extensions to adapt to specific deployment environments. In its current state, a true native Dapr application can only be deployed in a K8S environment if you wish to take it into production. While Dapr also provides support for Hashicorp Consul, there does not appear to be a stable version available.</p>
<p>Kubernetes is not &ldquo;standard&rdquo; for many companies, and for some reason they may have a homegrown microservices or elastic cloud platform that may be more valuable for Dapr to adapt to. We&rsquo;ve done some feasibility studies on this over the past two weeks and found that it&rsquo;s really not that hard, so we&rsquo;ll go over the general solution with a very simple example.</p>
<h2 id="1-nameresolution-component">1. NameResolution Component</h2>
<p>Although Dapr provides a series of programming models, such as service invocation, publish-subscribe and actor models, the one that is widely used should be service invocation. We know that service invocation in microservice environment needs to solve the problems of service registration and discovery, load balancing, elastic scaling, etc. In fact, Dapr does not do anything in this area, as mentioned above, Dapr itself does not provide the infrastructure, it leaves these functions to specific deployment platforms (such as K8S) to solve. The only component in Dapr related to this is a simple NameResolution component.</p>
<p>From a deployment point of view, all the functionality of Dapr is embodied in the Sidecar paired with the application. All we need to do when making a service call is to specify the ID (AppID) of the target application where the service is located. Service requests (HTTP or gRPC) are routed from the application to the sidecar, which &ldquo;routes&rdquo; the request to the appropriate node. If deployed on a Kubernetes cluster, the addressing of service requests is no longer an issue if the target service&rsquo;s identity and other relevant metadata (namespace, cluster domain, etc.) are specified. In fact, the NameResolution component embodies the &ldquo;resolution&rdquo; for &ldquo;Name&rdquo; that solves the problem of converting, for example, the Dapr application-specific identifier AppID into a deployment environment-based application identifier. environment-based application identity. From the code provided by dapr, it currently registers 3 types of NameResolution components as follows.</p>
<ul>
<li>mdns: uses mDNS (Multicast DNS) for service registration and discovery, which is the type used by default if not explicitly configured. Since mDNS is only a type of DNS implemented using broadcast communication in small-scale networks, it is not suitable for formal generation environments at all.</li>
<li>kubernetes: Adapted to Kubernetes name resolution, currently offering a stable version.</li>
<li>consul: Name resolution for HashiCorp Consul, currently the latest version is Alpha.</li>
</ul>
<h2 id="2-resolver">2. Resolver</h2>
<p>A registered NameResolution component is intended to provide a Resolver object, which is represented by the following interface. As shown in the following code snippet, the Resolver interface provides two methods. The Init method is called when the application is started and carries as parameters Metadata related to the current application instance (including the application identity and port, as well as Sidecar&rsquo;s HTTP and gRPC ports, etc.) and the configuration for the current NameResolution component configuration for the current NameResolution component. For each service call, information about the target application identity and namespace is encapsulated by Sidecar into a ResolveRequest interface, and the ReolveID method of the Resolver object is invoked with the most parameters, resulting in a representation that matches the current deployment environment and is used to leverage the full target service call with the infrastructure This identifier is used to leverage the full target service invocation with the infrastructure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">nameresolution</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Resolver</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Init</span><span class="p">(</span><span class="nx">metadata</span> <span class="nx">Metadata</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ResolveID</span><span class="p">(</span><span class="nx">req</span> <span class="nx">ResolveRequest</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Metadata</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Properties</span>    <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;properties&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Configuration</span> <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ResolveRequest</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ID</span>        <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Namespace</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Port</span>      <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Data</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-simulating-service-registration-and-load-balancing">3. Simulating Service Registration and Load Balancing</h2>
<p>Assuming we have a private microservices platform that implements basic service registration, load balancing, and even elastic scaling, if we want to use Dapr on this platform, we just need to provide a corresponding Resolver object using a custom NameResolution component. We use an ASP.NET Core MVC application to simulate the microservices platform we wish to adapt to, as follows: The HomeController maintains a list of applications and endpoints (IP+port) using the static field _applications. For a service call against an application, we implement simple load balancing by polling the corresponding endpoint. For ease of description, we will refer to the application as &ldquo;ServiceRegistry&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span><span class="o">:</span> <span class="n">Controller</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">readonly</span> <span class="n">ConcurrentDictionary</span><span class="o">&lt;</span><span class="n">string</span><span class="o">,</span> <span class="n">EndpointCollection</span><span class="o">&gt;</span> <span class="n">_applications</span> <span class="o">=</span> <span class="k">new</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">[</span><span class="n">HttpPost</span><span class="o">(</span><span class="s">&#34;/register&#34;</span><span class="o">)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IActionResult</span> <span class="nf">Register</span><span class="o">([</span><span class="n">FromBody</span><span class="o">]</span> <span class="n">RegisterRequest</span> <span class="n">request</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span> <span class="n">appId</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">Id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span> <span class="n">endpoints</span> <span class="o">=</span> <span class="n">_applications</span><span class="o">.</span><span class="na">TryGetValue</span><span class="o">(</span><span class="n">appId</span><span class="o">,</span> <span class="n">out</span> <span class="n">var</span> <span class="n">value</span><span class="o">)</span> <span class="o">?</span> <span class="n">value</span> <span class="o">:</span> <span class="n">_applications</span><span class="o">[</span><span class="n">appId</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">endpoints</span><span class="o">.</span><span class="na">TryAdd</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">HostAddress</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">Port</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="o">.</span><span class="na">WriteLine</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;Register {request.Id} =&gt;{request.HostAddress}:{request.Port}&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Ok</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">[</span><span class="n">HttpPost</span><span class="o">(</span><span class="s">&#34;/resolve&#34;</span><span class="o">)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IActionResult</span> <span class="nf">Resolve</span><span class="o">([</span><span class="n">FromBody</span><span class="o">]</span> <span class="n">ResolveRequest</span> <span class="n">request</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">_applications</span><span class="o">.</span><span class="na">TryGetValue</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">out</span> <span class="n">var</span> <span class="n">endpoints</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">endpoints</span><span class="o">.</span><span class="na">TryGet</span><span class="o">(</span><span class="n">out</span> <span class="n">var</span> <span class="n">endpoint</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="o">.</span><span class="na">WriteLine</span><span class="o">(</span><span class="n">$</span><span class="s">&#34;Resolve app {request.ID} =&gt;{endpoint}&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Content</span><span class="o">(</span><span class="n">endpoint</span><span class="o">!);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">NotFound</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EndpointCollection</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">readonly</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">_endpoints</span> <span class="o">=</span> <span class="k">new</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">_index</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">readonly</span> <span class="n">object</span> <span class="n">_lock</span> <span class="o">=</span> <span class="k">new</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">bool</span> <span class="nf">TryAdd</span><span class="o">(</span><span class="n">string</span> <span class="n">ipAddress</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span> <span class="o">(</span><span class="n">_lock</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">var</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">$</span><span class="s">&#34;{ipAddress}:{port}&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">_endpoints</span><span class="o">.</span><span class="na">Contains</span><span class="o">(</span><span class="n">endpoint</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">_endpoints</span><span class="o">.</span><span class="na">Add</span><span class="o">(</span><span class="n">endpoint</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">bool</span> <span class="nf">TryGet</span><span class="o">(</span><span class="n">out</span> <span class="n">string</span><span class="o">?</span> <span class="n">endpoint</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lock</span> <span class="o">(</span><span class="n">_lock</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">_endpoints</span><span class="o">.</span><span class="na">Count</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">endpoint</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">_index</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">_index</span> <span class="o">&gt;=</span> <span class="n">_endpoints</span><span class="o">.</span><span class="na">Count</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_index</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">_endpoints</span><span class="o">[</span><span class="n">_index</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The HomeController provides two Action methods, the Register method is used to register the application and is called by the Init method of the custom Resolver. The other method, Resolve, is used to complete the process of getting a specific endpoint based on the requested application representation, and is called by the ResolveID method of the custom Resolver. The parameter types of these two methods, RegisterRequest and ResolveRequest, are defined as follows, with the latter having the same definition as the interface of the same name given earlier. Both Actions output the appropriate text in the console showing the registered application information and the resolved endpoint.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegisterRequest</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">string</span> <span class="n">Id</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="n">set</span><span class="o">;</span> <span class="o">}</span> <span class="o">=</span> <span class="k">default</span><span class="o">!;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">string</span> <span class="n">HostAddress</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="n">set</span><span class="o">;</span> <span class="o">}</span> <span class="o">=</span> <span class="k">default</span><span class="o">!;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Port</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="n">set</span><span class="o">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResolveRequest</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">string</span> <span class="n">ID</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="n">set</span><span class="o">;</span> <span class="o">}</span> <span class="o">=</span> <span class="k">default</span><span class="o">!;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">string</span><span class="o">?</span> <span class="n">Namespace</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="n">set</span><span class="o">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="n">Port</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">string</span><span class="o">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">Data</span> <span class="o">{</span> <span class="n">get</span><span class="o">;</span> <span class="o">}</span> <span class="o">=</span> <span class="k">new</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-customizing-the-nameresolution-component">4. Customizing the NameResolution component</h2>
<p>Since Dapr does not support dynamic registration of components, we have to pull down its source code, modify it, and recompile it. There are two git operations involved here, dapr and components-contrib, the former for the core runtime and the latter for the community-driven contributed components. We put the cloned source code in the same directory.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/17/6c997c1e1d4f4ea88907b58d06e6f23c.png" alt="dapr and components-contrib"></p>
<p>We named our custom NameResolution component &ldquo;svcreg&rdquo; (meaning service registration), so we created a directory of the same name in the components-contrib/nameresolution directory (In this directory we will see the definition of several NameResolution components mentioned above) and defined the component code in the svcreg.go file in that directory. The complete definition of the NameResolution component is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">svcreg</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;bytes&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;encoding/json&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;errors&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;io/ioutil&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/dapr/components-contrib/nameresolution&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;github.com/dapr/kit/logger&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Resolver</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">logger</span>           <span class="nx">logger</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl"> <span class="nx">registerEndpoint</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"> <span class="nx">resolveEndpoint</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">RegisterRequest</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">Id</span><span class="p">,</span> <span class="nx">HostAddress</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"> <span class="nx">Port</span>            <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">resolver</span> <span class="o">*</span><span class="nx">Resolver</span><span class="p">)</span> <span class="nf">Init</span><span class="p">(</span><span class="nx">metadata</span> <span class="nx">nameresolution</span><span class="p">.</span><span class="nx">Metadata</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kd">var</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">appId</span><span class="p">,</span> <span class="nx">hostAddress</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"> <span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// Extracts register &amp; resolve endpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="nx">dic</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Configuration</span><span class="p">.(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{}]</span><span class="kd">interface</span><span class="p">{});</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">endpoint</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">dic</span><span class="p">[</span><span class="s">&#34;endpointAddress&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resolver</span><span class="p">.</span><span class="nx">registerEndpoint</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/register&#34;</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resolver</span><span class="p">.</span><span class="nx">resolveEndpoint</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/resolve&#34;</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">endpoint</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;service registry endpoint is not configured&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// Extracts AppID, HostAddress and Port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="nx">props</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">Properties</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">appId</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">nameresolution</span><span class="p">.</span><span class="nx">AppID</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;AppId does not exist in the name resolution metadata&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">hostAddress</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">nameresolution</span><span class="p">.</span><span class="nx">HostAddress</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;HostAddress does not exist in the name resolution metadata&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">p</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">props</span><span class="p">[</span><span class="nx">nameresolution</span><span class="p">.</span><span class="nx">DaprPort</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;DaprPort does not exist in the name resolution metadata&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">port</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;DaprPort is invalid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// Register service (application)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">var</span> <span class="nx">request</span> <span class="p">=</span> <span class="nx">RegisterRequest</span><span class="p">{</span><span class="nx">appId</span><span class="p">,</span> <span class="nx">hostAddress</span><span class="p">,</span> <span class="nx">port</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">payload</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;fail to marshal register request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">registerEndpoint</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resolver</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;App &#39;%s (%s:%d)&#39; is successfully registered.&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Id</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">HostAddress</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">resolver</span> <span class="o">*</span><span class="nx">Resolver</span><span class="p">)</span> <span class="nf">ResolveID</span><span class="p">(</span><span class="nx">req</span> <span class="nx">nameresolution</span><span class="p">.</span><span class="nx">ResolveRequest</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// Invoke resolve service and get resolved target app&#39;s endpoint (&#34;{ip}:{port}&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">resolveEndpoint</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">defer</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewResolver</span><span class="p">(</span><span class="nx">logger</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="o">*</span><span class="nx">Resolver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Resolver</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">logger</span><span class="p">:</span> <span class="nx">logger</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As shown in the code snippet above, we define the core Resolver structure, which has a logger field for logging and two additional fields registerEndpoint and resolveEndpoint, representing the URLs of the two APIs provided by ServiceRegistry, respectively. In the Init method implemented for the Resolver structure, we extract the configuration from the metadata as parameters, and further extract the address of the ServiceRegistry from the configuration and add the routing paths &ldquo;/register&rdquo; and &quot; /resolve&quot; to initialize the registerEndpoint and resolveEndpoint fields of the Resolver structure. Next, we extract the AppID, IP address and internal gRPC port number (through which the external application calls the Sidecar of the current application) from the metadata, which are encapsulated into the RegisterRequest structure and serialized into JSON strings, and used as input to call the corresponding Web API to complete the corresponding service registration.</p>
<p>In the ResolveID implementation, we directly serialize the ResolveRequest structure as a parameter into JSON and call the Resolve API. the string carried in the body of the response is the endpoint (IP+Port) parsed for the target application, which we directly use as the return value of ResolveID.</p>
<h2 id="5-registering-a-custom-nameresolution-component">5. Registering a Custom NameResolution Component</h2>
<p>The custom NameResolution component needs to be explicitly registered to the executable daprd representing Sidecar, and the source file where the entry program is located is dapr/cmd/daprd/main.go. We first import the package where svcreg is located as follows.</p>
<p>&ldquo;github.com/dapr/components-contrib/nameresolution/svcreg&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">// Name resolutions.
</span></span><span class="line"><span class="cl">nr &#34;github.com/dapr/components-contrib/nameresolution&#34;
</span></span><span class="line"><span class="cl">nr_consul &#34;github.com/dapr/components-contrib/nameresolution/consul&#34;
</span></span><span class="line"><span class="cl">nr_kubernetes &#34;github.com/dapr/components-contrib/nameresolution/kubernetes&#34;
</span></span><span class="line"><span class="cl">nr_mdns &#34;github.com/dapr/components-contrib/nameresolution/mdns&#34;
</span></span><span class="line"><span class="cl">nr_svcreg &#34;github.com/dapr/components-contrib/nameresolution/svcreg&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the main function, we find the part of the code used to register the NameResolution component and just follow the instructions for registering the svcreg as we did for the other NameResolution components. The NewResolver function used to provide the Resolver in the registration code is defined in the svcreg.go file above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">runtime</span><span class="p">.</span><span class="nf">WithNameResolutions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="nx">nr_loader</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;svcreg&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">nr</span><span class="p">.</span><span class="nx">Resolver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">nr_svcreg</span><span class="p">.</span><span class="nf">NewResolver</span><span class="p">(</span><span class="nx">logContrib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}),</span>
</span></span><span class="line"><span class="cl"> <span class="nx">nr_loader</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;mdns&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">nr</span><span class="p">.</span><span class="nx">Resolver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">nr_mdns</span><span class="p">.</span><span class="nf">NewResolver</span><span class="p">(</span><span class="nx">logContrib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}),</span>
</span></span><span class="line"><span class="cl"> <span class="nx">nr_loader</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;kubernetes&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">nr</span><span class="p">.</span><span class="nx">Resolver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">nr_kubernetes</span><span class="p">.</span><span class="nf">NewResolver</span><span class="p">(</span><span class="nx">logContrib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}),</span>
</span></span><span class="line"><span class="cl"> <span class="nx">nr_loader</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;consul&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">nr</span><span class="p">.</span><span class="nx">Resolver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">nr_consul</span><span class="p">.</span><span class="nf">NewResolver</span><span class="p">(</span><span class="nx">logContrib</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}),</span>
</span></span><span class="line"><span class="cl"><span class="p">),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-compile-and-deploy-daprdexe">6. Compile and deploy daprd.exe</h2>
<p>So far, all the programming work has been done, next we need to recompile daprd.exe which represents Sidecar.</p>
<p>As you can see from the code snippet above, the package paths of dapr are prefixed with &ldquo;github.com/dapr&rdquo;, so we need to modify the go.mod file (dapr/go.mod) to redirect the dependency paths to the local directory, so we added the paths for so we add a replacement rule for &ldquo;github.com/dapr/components-contrib&rdquo; as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mod" data-lang="mod"><span class="line"><span class="cl"><span class="n">replace</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="n">go</span><span class="p">.</span><span class="n">opentelemetry</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">otel</span> <span class="o">=&gt;</span> <span class="n">go</span><span class="p">.</span><span class="n">opentelemetry</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">otel</span> <span class="n">v0</span><span class="p">.</span><span class="mf">20.0</span>
</span></span><span class="line"><span class="cl"> <span class="n">gopkg</span><span class="p">.</span><span class="n">in</span><span class="o">/</span><span class="n">couchbaselabs</span><span class="o">/</span><span class="n">gocbconnstr</span><span class="p">.</span><span class="n">v1</span> <span class="o">=&gt;</span> <span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">couchbaselabs</span><span class="o">/</span><span class="n">gocbconnstr</span> <span class="n">v1</span><span class="p">.</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl"> <span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">client</span> <span class="o">=&gt;</span> <span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">client</span><span class="o">/</span><span class="n">go</span> <span class="n">v0</span><span class="p">.</span><span class="mf">0.0</span><span class="o">-</span><span class="mi">20190928040339</span><span class="o">-</span><span class="n">c757968c4c36</span>
</span></span><span class="line"><span class="cl"> <span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">dapr</span><span class="o">/</span><span class="n">components</span><span class="o">-</span><span class="n">contrib</span> <span class="o">=&gt;</span> <span class="p">..</span><span class="o">/</span><span class="n">components</span><span class="o">-</span><span class="n">contrib</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After switching the current directory to &ldquo;dapr/cmd/daprd/&rdquo;, executing &ldquo;go build&rdquo; from the command line will generate a daprd.exe executable file in the current directory. Now we need to use this new daprd.exe to replace the current one, which is located in the <code>%userprofile%.dapr\bin</code> directory.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/17/ba76eb0a868a4cdb94e97bfd046bfcf3.png" alt="cmd"></p>
<h2 id="7-configuring-svcreg">7. Configuring svcreg</h2>
<p>As we have already mentioned, Dapr uses the mDNS-based NameResolution component by default (for which the registered name is &ldquo;mdns&rdquo;). To enable our custom component &ldquo;svcreg&rdquo;, we need to modify Dapr&rsquo;s configuration file (%userprofile%.dapr\config.yaml). As shown in the following code snippet, we not only set the name of the used component to &ldquo;svcreg&rdquo; (the name provided when registering the NameResolution component in dapr/cmd/daprd/main.go), but also set the URL of the service registration API (<code>http://127.0.0.1:3721</code>) in the configuration (the URL extracted by the Init method of Resolver is from here).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">dapr.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Configuration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daprConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nameResolution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;svcreg&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">configuration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">endpointAddress</span><span class="p">:</span><span class="w"> </span><span class="l">http://127.0.0.1:3721</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tracing</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">samplingRate</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zipkin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">endpointAddress</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:9411/api/v2/spans</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="8-testing-the-effects">8. Testing the Effects</h2>
<p>We now write a Dapr application to verify that the custom NameResolution component works. We use the example of a service call provided in ASP.NET Core 6 Framework Revealed Example Demo [03]: Dapr First Experience. App2, defined as follows, is an ASP.NET Core application that uses routing to provide APIs for addition, subtraction, multiplication, and division operations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">Shared</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="n">WebApplication</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">app</span><span class="p">.</span><span class="n">MapPost</span><span class="p">(</span><span class="s">&#34;{method}&#34;</span><span class="p">,</span> <span class="n">Calculate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="s">&#34;http://localhost:9999&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">static</span> <span class="n">IResult</span> <span class="n">Calculate</span><span class="p">(</span><span class="kt">string</span> <span class="n">method</span><span class="p">,</span> <span class="p">[</span><span class="n">FromBody</span><span class="p">]</span> <span class="n">Input</span> <span class="n">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">method</span><span class="p">.</span><span class="n">ToLower</span><span class="p">()</span> <span class="k">switch</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;add&#34;</span> <span class="p">=&gt;</span> <span class="n">input</span><span class="p">.</span><span class="n">X</span> <span class="p">+</span> <span class="n">input</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;sub&#34;</span> <span class="p">=&gt;</span> <span class="n">input</span><span class="p">.</span><span class="n">X</span> <span class="p">-</span> <span class="n">input</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;mul&#34;</span> <span class="p">=&gt;</span> <span class="n">input</span><span class="p">.</span><span class="n">X</span> <span class="p">*</span> <span class="n">input</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s">&#34;div&#34;</span> <span class="p">=&gt;</span> <span class="n">input</span><span class="p">.</span><span class="n">X</span> <span class="p">/</span> <span class="n">input</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">_</span> <span class="p">=&gt;</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidOperationException</span><span class="p">(</span><span class="s">$&#34;Invalid method {method}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="p">};</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">Results</span><span class="p">.</span><span class="n">Json</span><span class="p">(</span><span class="k">new</span> <span class="n">Output</span> <span class="p">{</span> <span class="n">Result</span> <span class="p">=</span> <span class="n">result</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Input</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">int</span> <span class="n">X</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">int</span> <span class="n">Y</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Output</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">int</span>   <span class="n">Result</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">DateTimeOffset</span>  <span class="n">Timestamp</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>App1 with the following definition is a console application that calls the four APIs of the appeal using the Dapr client SDK.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">Dapr.Client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="k">using</span> <span class="nn">Shared</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">HttpClient</span> <span class="n">client</span> <span class="p">=</span> <span class="n">DaprClient</span><span class="p">.</span><span class="n">CreateInvokeHttpClient</span><span class="p">(</span><span class="n">appId</span><span class="p">:</span> <span class="s">&#34;app2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="kt">var</span> <span class="n">input</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Input</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">await</span> <span class="n">InvokeAsync</span><span class="p">(</span><span class="s">&#34;add&#34;</span><span class="p">,</span> <span class="s">&#34;+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">await</span> <span class="n">InvokeAsync</span><span class="p">(</span><span class="s">&#34;sub&#34;</span><span class="p">,</span> <span class="s">&#34;-&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">await</span> <span class="n">InvokeAsync</span><span class="p">(</span><span class="s">&#34;mul&#34;</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">await</span> <span class="n">InvokeAsync</span><span class="p">(</span><span class="s">&#34;div&#34;</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">async</span> <span class="n">Task</span> <span class="n">InvokeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">method</span><span class="p">,</span> <span class="kt">string</span> <span class="n">@operator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">PostAsync</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">JsonContent</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">input</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="kt">var</span> <span class="n">output</span> <span class="p">=</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadFromJsonAsync</span><span class="p">&lt;</span><span class="n">Output</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">     <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span> <span class="s">$&#34;{input.X} {@operator} {input.Y} = {output.Result} ({output.Timestamp})&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After starting the ServiceRegistry, we start App2 and the console will elaborate the following output. As you can see from the name of the NameResolution component in the output, our custom svcreg is being used.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/17/9ccd65bbc51f4171943e03b9a46e3990.png" alt="NameResolution component in the output"></p>
<p>Since the Resolver&rsquo;s Init method is called when the application is started to register, this is also reflected in the output of the ServiceRegistry as shown below. You can see that the AppID of the registered instance is &ldquo;app2&rdquo; and the corresponding endpoint is &ldquo;10.181.22.4:60840&rdquo;.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/17/b676efb040724f85b260e0749585547a.png" alt="corresponding endpoint"></p>
<p>Then we start App1 again, and the output shown below indicates that all four service calls completed successfully.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/17/dac2563c483c416bb3d6dcbdce3866cf.png" alt="four service calls completed successfully"></p>
<p>The application instance of the launched App1 is also registered in the ServiceRegistry. Four service calls result in four calls to the Resolver&rsquo;s ResolveID method, which is also reflected in the output of the ServiceRegistry.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/17/169c016b66e043c49a963c63d097d140.png" alt="output of the ServiceRegistry"></p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://www.cnblogs.com/artech/p/dapr-custom-name-resolution.html">https://www.cnblogs.com/artech/p/dapr-custom-name-resolution.html</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/devops/">devops</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/distributed-consensus-algorithms-and-dataconsistency/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Talking about distributed consensus algorithms and data consistency</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/postgres-snapshot/">
            <span class="next-text nav-default">Snapshot in Postgres</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
