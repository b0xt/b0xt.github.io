<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>JavaScript ESM is great, but it might not be so great right now - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article documents the process of trying to use esm." /><meta name="keywords" content="javascript ESM" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/js-esm/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="JavaScript ESM is great, but it might not be so great right now" />
<meta property="og:description" content="This article documents the process of trying to use esm." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/js-esm/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-14T09:42:53+08:00" />
<meta property="article:modified_time" content="2022-08-14T09:42:53+08:00" />

<meta itemprop="name" content="JavaScript ESM is great, but it might not be so great right now">
<meta itemprop="description" content="This article documents the process of trying to use esm."><meta itemprop="datePublished" content="2022-08-14T09:42:53+08:00" />
<meta itemprop="dateModified" content="2022-08-14T09:42:53+08:00" />
<meta itemprop="wordCount" content="1911">
<meta itemprop="keywords" content="javascript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JavaScript ESM is great, but it might not be so great right now"/>
<meta name="twitter:description" content="This article documents the process of trying to use esm."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">JavaScript ESM is great, but it might not be so great right now</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-14 09:42:53 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1911 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preface">Preface</a></li>
        <li><a href="#objectives">Objectives</a></li>
        <li><a href="#modify-package-declaration">Modify package declaration</a></li>
        <li><a href="#typescript-support">TypeScript support</a></li>
        <li><a href="#jestwallaby-support">jest/wallaby support</a></li>
        <li><a href="#nodejs-support">nodejs support</a>
          <ul>
            <li><a href="#importing-cjs-only-modules">Importing cjs only modules</a></li>
            <li><a href="#using-__dirname">Using <code>__dirname</code></a></li>
          </ul>
        </li>
        <li><a href="#lib-maintenance-and-usage">lib maintenance and usage</a>
          <ul>
            <li><a href="#new-esm-and-cjs-dual-package-support-configuration">New esm and cjs dual package support configuration</a></li>
          </ul>
        </li>
        <li><a href="#esbuild-support">esbuild support</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="preface">Preface</h2>
<p>As many front-end developers probably know, more than a year since sindresorhus published <a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c">the esm only manifesto</a> last year, many projects have started to move to esm only, i.e., esm only and not cjs, in order to force the whole ecosystem to migrate to esm only faster.</p>
<p>Some popular projects already do this</p>
<ul>
<li>thousands of npm packages maintained by sindresorhus</li>
<li>node-fetch</li>
<li>remark series</li>
<li>more.</li>
</ul>
<p>They claim: you can still use the existing version without upgrading to the latest version, and that major version updates will not affect you. What are the facts?</p>
<p>I&rsquo;ve had a few problems before with not being able to use esm only packages, whenever I tried to try esm only, there were always a few more problems, the most painful being that some packages were esm only and others were cjs only, always having to choose to drop one side. fuck esm only. the main problems were some cjs only packages, and packages that had to be compatible with typescript/jest/ts-jest/wallaby does not support esm properly. of course, I can choose to look for alternatives to esm only packages, such as globby =&gt; fast-glob, remark =&gt; markdown-it, node-fetch =&gt; node-fetch@2, and lodash-es =&gt; lodash, but this is not a permanent option after all, not to mention that some packages are hard to actually find replacements for, such as the remark family.</p>
<p>So, what are the problems with using older versions of packages?
The main problem is that it is hard to find the correct version. Of course, if you are using a relatively independent package, such as node-fetch, you can just use the v2 version. But if you are using a project like vuepress/remark where monorepo contains many small packages, you will have a hard time finding the correct version of each subproject.</p>
<p>I recently had to do some conversions from markdown and manipulate ast to html when I was working on the epub generator, so I used remark again and decided to really try using esm. here are some of the steps I tried.</p>
<h2 id="objectives">Objectives</h2>
<p>There are several issues that must be addressed to use esm, otherwise it is not possible to use it in a production environment</p>
<ul>
<li>typescript support - basically all web projects use ts and it is unacceptable not to support it</li>
<li>jest support - also a heavily used testing tool
<ul>
<li>wallaby support - a paid WYSIWYG testing tool</li>
</ul>
</li>
<li>Allow references to cjs modules - requires support for existing packages</li>
<li>Dual module packages can still support both esm/cjs projects - requires support for cjs project references</li>
<li>Support for unpackaged modules - some private modules in monorepo will not bundle</li>
<li>esbuild support - esbuild is becoming a lib bundle standard</li>
</ul>
<h2 id="modify-package-declaration">Modify package declaration</h2>
<p>The first step is to modify the module type of the package, modify <code>&quot;type&quot;: &quot;module&quot;</code> to declare the package as esm, all js code will run as esm module by default.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;module&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="typescript-support">TypeScript support</h2>
<p>NodeNext is supported since ts4.7, so you need to change tsconfig.json.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;compilerOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;module&#34;</span><span class="p">:</span> <span class="s2">&#34;ESNext&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;moduleResolution&#34;</span><span class="p">:</span> <span class="s2">&#34;NodeNext&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Also, importing other ts files within ts files must use the .js suffix.</p>
<p>This is a strange restriction, see <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-7.html#type-in-packagejson-and-new-extensions">ts 4.7 release documentation</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">helper</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;./foo.js&#34;</span><span class="p">;</span> <span class="c1">// works in ESM &amp; CJS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">helper</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Does it seem strange, but it&rsquo;s the only way to write it now, and typescript will even prompt for it.</p>
<h2 id="jestwallaby-support">jest/wallaby support</h2>
<p>For example, run the following code using the <code>pnpm jest src/lodash.test.ts</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">uniq</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;lodash-es&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">it</span><span class="p">(</span><span class="s2">&#34;uniq&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">uniq</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>An error occurred</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Jest encountered an unexpected token
</span></span></code></pre></td></tr></table>
</div>
</div><p>Experimental esm support is supported from jest 28 onwards, and wallaby/ts-jest are also supported by configuration, which can be handled by following the steps below.</p>
<ol>
<li>
<p>Configuring ts-jest</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;jest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;preset&#34;</span><span class="p">:</span> <span class="s2">&#34;ts-jest/presets/default-esm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;globals&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ts-jest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;useESM&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;moduleNameMapper&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;^(\\.{1,2}/.*)\\.js$&#34;</span><span class="p">:</span> <span class="s2">&#34;$1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;testMatch&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;&lt;rootDir&gt;/src/**/__tests__/*.test.ts&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>change the command to <code>node --experimental-vm-modules node_modules/jest/bin/jest.js src/lodash.test.ts</code></p>
</li>
<li>
<p>Configure wallaby (This is where you can run the test files in the <code>__tests__</code> directory, oddly enough.)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;wallaby&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;env&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;runner&#34;</span><span class="p">:</span> <span class="s2">&#34;--experimental-vm-modules&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Since the esm import is static, you also need to uninstall <code>@types/jest</code> and use the <code>@jest/globals</code> package to import functions needed for testing, such as <code>it/expect/describe/beforeEach</code> and so on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">it</span><span class="p">,</span> <span class="nx">expect</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;@jest/globals&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">it</span><span class="p">(</span><span class="s2">&#34;basic&#34;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">expect</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="nodejs-support">nodejs support</h2>
<p>nodejs has been supporting esm since 14, but the migration has not been smooth until now at 18, mainly due to the following issues.</p>
<h3 id="importing-cjs-only-modules">Importing cjs only modules</h3>
<p>Unfortunately, a large number of existing packages are for cjs only modules and it is not possible to migrate them anytime soon, and the interoperability between esm and cjs in nodejs is not very good, so it needs to be handled. Here is an example of fs-extra.</p>
<p>This is how it would normally be written before.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">readdir</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;fs-extra&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">readdir</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>An error occurs when running with tsx <code>SyntaxError: The requested module 'fs-extra' does not provide an export named 'readdir'</code>, this seems to be a known error, refer to: <a href="https://github.com/esbuild-kit/tsx/issues/38">https://github.com/esbuild-kit/tsx/issues/38</a></p>
<p>Now it needs to be modified as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">fsExtra</span> <span class="kr">from</span> <span class="s2">&#34;fs-extra&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">fsExtra</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Or modify it to the following code. Run with <code>ts-node --esm &lt;file&gt;</code> (this is not supported by tsx).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">fsExtra</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s2">&#34;fs-extra&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">await</span> <span class="nx">fsExtra</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="using-__dirname">Using <code>__dirname</code></h3>
<p>Yes, you read that right, under the esm module <code>__dirname</code> is no longer available, it is replaced by <code>import.meta.url</code>, in short, it is now used in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">fileURLToPath</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;url&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">__filename</span> <span class="o">=</span> <span class="nx">fileURLToPath</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">__dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Refer to the article <a href="https://flaviocopes.com/fix-dirname-not-defined-es-module-scope/">https://flaviocopes.com/fix-dirname-not-defined-es-module-scope/</a>, and later, when we talk about esbuild, we will talk about how to handle <code>import.meta.url</code> in the cjs bundle (which is not supported in cjs, again, it&rsquo;s a choice between (which is not supported in cjs and is again an option).</p>
<h2 id="lib-maintenance-and-usage">lib maintenance and usage</h2>
<h3 id="new-esm-and-cjs-dual-package-support-configuration">New esm and cjs dual package support configuration</h3>
<p>Previously, we differentiated modules by the main/module field.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;dist/index.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;module&#34;</span><span class="p">:</span> <span class="s2">&#34;dist/index.esm.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="s2">&#34;dist/index.d.ts&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, an exception occurs when referencing in an esm project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">SyntaxError: The requested module &#39;cjs-and-esm-lib&#39; does not provide an export named &#39;hello&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The esm project does not recognize this, it has a new exports field, so you need to add (note that the main field still needs to remain compatible with older node versions) the exports field.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exports&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;.&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;import&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist/index.esm.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;require&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist/index.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;types&#34;</span><span class="p">:</span> <span class="s2">&#34;./dist/index.d.ts&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Refer to this answer: <a href="https://stackoverflow.com/a/70020984">https://stackoverflow.com/a/7002098</a></p>
<h2 id="esbuild-support">esbuild support</h2>
<p>I thought esbuild would be easy because it inherently supports esm, but I actually ran into quite a few problems.</p>
<p>Binding the following code to cjs gives an error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="nx">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">fileURLToPath</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;url&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">fsExtra</span> <span class="nx">from</span> <span class="s2">&#34;fs-extra&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">readdir</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">fsExtra</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">__filename</span> <span class="o">=</span> <span class="nx">fileURLToPath</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">__dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">readdir</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">esbuild src/bin.ts --platform<span class="o">=</span>node --outfile<span class="o">=</span>dist/bin.esm.js --bundle --sourcemap --format<span class="o">=</span>esm
</span></span><span class="line"><span class="cl">esbuild src/bin.ts --platform<span class="o">=</span>node --outfile<span class="o">=</span>dist/bin.js --bundle --sourcemap --format<span class="o">=</span>cjs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Error</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[ERROR] Top-level await is currently not supported with the &#34;cjs&#34; output format
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here, because cjs cannot contain top-level await, it is modified as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="nx">from</span> <span class="s2">&#34;path&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">fileURLToPath</span> <span class="p">}</span> <span class="nx">from</span> <span class="s2">&#34;url&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">fsExtra</span> <span class="nx">from</span> <span class="s2">&#34;fs-extra&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">readdir</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">fsExtra</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">__filename</span> <span class="o">=</span> <span class="nx">fileURLToPath</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">__dirname</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">readdir</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is no problem with the bundle, but it runs with errors.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">node</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">bin</span><span class="p">.</span><span class="nx">js</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>First is the first mistake.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">var <span class="nv">import_path</span> <span class="o">=</span> __toESM<span class="o">(</span>require<span class="o">(</span><span class="s2">&#34;path&#34;</span><span class="o">)</span>, 1<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  ^
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ReferenceError: require is not defined in ES module scope, you can use import instead
</span></span><span class="line"><span class="cl">This file is being treated as an ES module because it has a <span class="s1">&#39;.js&#39;</span> file extension and <span class="s1">&#39;esm-demo\packages\esm-include-cjs-lib\package.json&#39;</span> contains <span class="s2">&#34;type&#34;</span>: <span class="s2">&#34;module&#34;</span>. To
</span></span><span class="line"><span class="cl">treat it as a CommonJS script, rename it to use the <span class="s1">&#39;.cjs&#39;</span> file extension.
</span></span></code></pre></td></tr></table>
</div>
</div><p>It says this is an esm package and the default code is the esm module, if you want it to be executed as a cjs module, you need to change it to the cjs suffix.</p>
<p>Modify the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">esbuild src/bin.ts --platform<span class="o">=</span>node --outfile<span class="o">=</span>dist/bin.cjs --bundle --sourcemap --format<span class="o">=</span>cjs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then there was a second error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">TypeError <span class="o">[</span>ERR_INVALID_ARG_TYPE<span class="o">]</span>: The <span class="s2">&#34;path&#34;</span> argument must be of <span class="nb">type</span> string or an instance of URL. Received undefined
</span></span></code></pre></td></tr></table>
</div>
</div><p>Related Codes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// src/bin.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">import_path</span> <span class="o">=</span> <span class="nx">__toESM</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">import_url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;url&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">import_fs_extra</span> <span class="o">=</span> <span class="nx">__toESM</span><span class="p">(</span><span class="nx">require_lib</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">import_meta</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">{</span> <span class="nx">readdir</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">import_fs_extra</span><span class="p">.</span><span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">__filename</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">import_url</span><span class="p">.</span><span class="nx">fileURLToPath</span><span class="p">)(</span><span class="nx">import_meta</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> <span class="c1">// 这里是关键，因为 import.meta.url 在 cjs 代码中是空的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">__dirname</span> <span class="o">=</span> <span class="nx">import_path</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">readdir</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>According to <a href="https://github.com/evanw/esbuild/issues/1492#issuecomment-893144483">the author&rsquo;s answer in this issue</a>, modify the command as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">esbuild src/bin.ts --platform<span class="o">=</span>node --outfile<span class="o">=</span>dist/bin.cjs --inject:./import-meta-url.js --define:import.meta.url<span class="o">=</span>import_meta_url --bundle --sourcemap --format<span class="o">=</span>cjs
</span></span></code></pre></td></tr></table>
</div>
</div><p>Unfortunately, this is not in effect and the bundle&rsquo;s code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// import-meta-url.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">import_meta_url2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;url&#34;</span><span class="p">).</span><span class="nx">pathToFileURL</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">import_meta_url2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// src/bin.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">import_path</span> <span class="o">=</span> <span class="nx">__toESM</span><span class="p">(</span><span class="nx">require</span><span class="p">(</span><span class="s2">&#34;path&#34;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">import_url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&#34;url&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">__filename2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">import_url</span><span class="p">.</span><span class="nx">fileURLToPath</span><span class="p">)(</span><span class="nx">import_meta_url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">__dirname</span> <span class="o">=</span> <span class="nx">import_path</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">__filename2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">})();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can clearly see that the variable name of the injected script is changed from <code>import_meta_url</code> =&gt; <code>import_meta_url2</code>, which is oddly problematic.</p>
<p>Maybe replace <code>--inject</code> =&gt; <code>--banner</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">esbuild src/bin.ts --platform<span class="o">=</span>node --outfile<span class="o">=</span>dist/bin.cjs --define:import.meta.url<span class="o">=</span>import_meta_url --bundle --sourcemap --banner:js<span class="o">=</span><span class="s2">&#34;var import_meta_url = require(&#39;url&#39;).pathToFileURL(__filename)&#34;</span> --format<span class="o">=</span>cjs
</span></span></code></pre></td></tr></table>
</div>
</div><p>This takes effect.</p>
<p>What about running the esm bundle?</p>
<p>It also gives an error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">throw new Error<span class="o">(</span><span class="s1">&#39;Dynamic require of &#34;&#39;</span> + x + <span class="s1">&#39;&#34; is not supported&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Error: Dynamic require of <span class="s2">&#34;fs&#34;</span> is not supported
</span></span></code></pre></td></tr></table>
</div>
</div><p>Modify the command according to the solution <a href="https://github.com/evanw/esbuild/issues/1921#issuecomment-1152991694">here</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">esbuild src/bin.ts --platform<span class="o">=</span>node --outfile<span class="o">=</span>dist/bin.esm.js --bundle --sourcemap --banner:js<span class="o">=</span><span class="s2">&#34;import { createRequire } from &#39;module&#39;;const require = createRequire(import.meta.url);&#34;</span> --format<span class="o">=</span>esm
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, the code after the bundle can finally run.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Maybe esm only looks good, and tree shaking looks like a great idea, but right now, it&rsquo;s not even really available in production. This includes a number of important projects that have not been migrated, including react/vscode/electron/vite and so on. In fact, many people (including me) have used esm modules to write code before this, except that the final bundle product might be cjs, e.g. iife in the browser, cjs in nodejs, but the vast majority of application-level developers don&rsquo;t care about that, only the lib maintainers do, and esm only shifts the complexity of using packages The complexity of using packages is also transferred to the user, and there is no real available solution for referencing esm only packages in cjs. The esm only movement is more of an orgy in the web front-end community than a project like esbuild/vite that solves a real problem.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/javascript/">javascript</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/distributed-lock/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Talking about distributed lock implementation</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/go-map/">
            <span class="next-text nav-default">Map In Golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
