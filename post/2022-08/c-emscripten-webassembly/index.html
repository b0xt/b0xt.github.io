<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Write your own WebAssembly modules using C and Emscripten - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to write your own WebAssembly modules using C and Emscripten." /><meta name="keywords" content="Webassembly, Emscripten, c" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/c-emscripten-webassembly/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Write your own WebAssembly modules using C and Emscripten" />
<meta property="og:description" content="Learn how to write your own WebAssembly modules using C and Emscripten." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/c-emscripten-webassembly/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-01T13:16:55+08:00" />
<meta property="article:modified_time" content="2022-08-01T13:16:55+08:00" />

<meta itemprop="name" content="Write your own WebAssembly modules using C and Emscripten">
<meta itemprop="description" content="Learn how to write your own WebAssembly modules using C and Emscripten."><meta itemprop="datePublished" content="2022-08-01T13:16:55+08:00" />
<meta itemprop="dateModified" content="2022-08-01T13:16:55+08:00" />
<meta itemprop="wordCount" content="2934">
<meta itemprop="keywords" content="Webassembly," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Write your own WebAssembly modules using C and Emscripten"/>
<meta name="twitter:description" content="Learn how to write your own WebAssembly modules using C and Emscripten."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Write your own WebAssembly modules using C and Emscripten</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-01 13:16:55 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2934 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#start-by-running-a-simple-module">Start by running a simple module</a></li>
        <li><a href="#using-external-functions-memory-and-pointers">Using external functions, memory and pointers</a></li>
        <li><a href="#an-example-of-using-webassembly-to-increase-performance-to-30x">An example of using WebAssembly to increase performance to 30x</a></li>
        <li><a href="#extra-simd-support-for-webassembly">Extra: SIMD Support for WebAssembly</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Like JavaScript, WebAssembly is a programming language that can be run in a browser, but it is more equivalent to assembly language. wasm files consist of binary <a href="https://pengowray.github.io/wasm-ops/">bytecode</a> (which can also be converted to an assembly-language-like text format for viewing) and can be <strong>generated from C/C++, Rust, and other compiled and executed programming languages</strong>. Of course, WebAssembly is also cross-platform, and compiled wasm files can be run in browsers on different platforms.</p>
<p>The best feature of WebAssembly is its high performance compared to interpreted JS, and even the ability to port projects written in other languages to run in the browser by compiling to wasm. Almost everyone with a computer-related education has learned C. Writing a simple wasm module in C to improve the performance of your front-end code is not a high barrier and it&rsquo;s fun.</p>
<h2 id="start-by-running-a-simple-module">Start by running a simple module</h2>
<p>To compile C/C++ code into wasm modules, we need to prepare the <a href="https://emscripten.org/docs/getting_started/downloads.html">Emscripten</a> environment.</p>
<blockquote>
<p>Even Windows users can install it directly from inside WSL.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://github.com/emscripten-core/emsdk.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> emsdk
</span></span><span class="line"><span class="cl">git pull
</span></span><span class="line"><span class="cl">./emsdk install latest
</span></span><span class="line"><span class="cl">./emsdk activate latest
</span></span><span class="line"><span class="cl"><span class="c1"># You will have to execute the following line every time you open the shell</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If you don&#39;t want to do it manually every time, you can write it in .bashrc</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> ./emsdk_env.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>The WebAssembly runtime environment itself can only perform computational tasks, and when loading the wasm module it needs to import an object containing JS functions, memory areas, and other properties. Emscripten is not only for compiling C/C++ code to generate wasm, but also for generating a bunch of JS &ldquo;glue code&rdquo; to connect the browser to the WebAssembly runtime environment, to implement those standard libraries of C/C++, and to handle memory allocation, input and output, etc.</p>
<p>The <a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/C_to_wasm#%E7%94%9F%E6%88%90_HTML_%E5%92%8C_JavaScript">tutorial on MDN</a> gives an example of compiling a wasm file from Hello world with the corresponding glue code and HTML file. However, the glue code is much bigger than the wasm file itself &hellip;&hellip; which is not good if the module is simple. The good thing is that Emscripten supports the compilation option <code>-s SIDE_MODULE=1</code> to make the compiled wasm file as <a href="https://github.com/emscripten-core/emscripten/wiki/WebAssembly-Standalone#create-a-dynamic-library">a separate dynamic library</a>, so you don&rsquo;t need that bunch of glue code, but you need to interact with the JS part yourself. The various standard library functions used need to be implemented in C/C++ (<code>memset</code>, <code>memcpy</code> and <code>strlen</code> can be directly copied from <a href="https://github.com/emscripten-core/emscripten/tree/main/system/lib/libc">Emscripten&rsquo;s implementation</a>), or imported into the wasm module after being implemented in JS by manipulating memory areas.</p>
<p>According to <a href="https://github.com/emscripten-core/emscripten/blob/aa66f92b790c8d319d1599d44657a6305bf74a8a/src/settings.js#L953">Emscripten</a>, <code>SIDE_MODULE</code> can be set to 1 or 2, the difference is that the former will export all functions in the C/C++ code, the latter will trim out the unused code, then you need to <code>#include &lt;emscripten/emscripten.h&gt;</code> and manually prefix the functions to be exported with <code>EMSCRIPTEN_KEEPALIVE</code>.</p>
<p>Start with a simple module that calculates the multiplication of two numbers. Since this is just a library, the main function is not needed and even if it is written it will not be executed automatically when loaded.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">EMSCRIPTEN_KEEPALIVE</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">multiply</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Compile, <code>-O3</code> means use the highest speed compilation optimization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">emcc</span> <span class="n">multiply</span><span class="p">.</span><span class="n">c</span> <span class="o">-</span><span class="n">O3</span> <span class="o">-</span><span class="n">s</span> <span class="n">SIDE_MODULE</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">o</span> <span class="n">multiply</span><span class="p">.</span><span class="n">wasm</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can also use <code>-Oz</code> to indicate a compilation optimization that makes the compiled file size smaller, but of course it will run much slower.</p>
<p>Use the following JS code to load in HTML (currently <code>importObject</code> can be omitted).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmModule</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;multiply.wasm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">buffer</span> <span class="p">=&gt;</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">module</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming"><code>WebAssembly.installStreaming</code></a> is cleaner to load, but requires the correct MIME type <code>application/wasm</code> to be provided.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmModule</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiateStreaming</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;multiply.wasm&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">importObject</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Also, both of the above writeups load the module asynchronously, because loading large modules synchronously can block for a long time (Chrome even has its own rule that synchronously loaded modules cannot exceed 4 KB). If the module is small enough to load in negligible time, and you need to use it in synchronous code, you can write the binary data of the module in <code>Uint8Array</code> format (though it is recommended to convert from Base64 strings for shorter code) to JS code and load it in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// You can reuse m when creating wasmModule later, no need to reload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([...]));</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmModule</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">importObject</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>WebAssembly is also strongly typed (32/64 bit integers/floating point numbers), so in this example if you use decimals you will be automatically type converted and will not get the correct result, and you also need to pay attention to the overflow problem.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/01/940f9a09f8ec49f18cfe308bf5610ef0.png" alt="WebAssembly"></p>
<p>Here is the corresponding &ldquo;assembly code&rdquo;, <code>$multiply</code> is the above multiplication function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">(</span><span class="nx">module</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">type</span> <span class="nx">$t0</span> <span class="p">(</span><span class="nx">func</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">type</span> <span class="nx">$t1</span> <span class="p">(</span><span class="nx">func</span> <span class="p">(</span><span class="nx">param</span> <span class="nx">i32</span> <span class="nx">i32</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">i32</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">func</span> <span class="nx">$__wasm_apply_relocs</span> <span class="p">(</span><span class="nx">type</span> <span class="nx">$t0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nop</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">func</span> <span class="nx">$multiply</span> <span class="p">(</span><span class="nx">type</span> <span class="nx">$t1</span><span class="p">)</span> <span class="p">(</span><span class="nx">param</span> <span class="nx">$p0</span> <span class="nx">i32</span><span class="p">)</span> <span class="p">(</span><span class="nx">param</span> <span class="nx">$p1</span> <span class="nx">i32</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">i32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$p0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$p1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i32</span><span class="p">.</span><span class="nx">mul</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">global</span> <span class="nx">$__dso_handle</span> <span class="nx">i32</span> <span class="p">(</span><span class="nx">i32</span><span class="p">.</span><span class="kr">const</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;__wasm_apply_relocs&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$__wasm_apply_relocs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;multiply&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$multiply</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;__dso_handle&#34;</span> <span class="p">(</span><span class="nx">global</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;__post_instantiate&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$__wasm_apply_relocs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Using the VSCode extension <a href="https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm">WebAssembly</a> you can display open wasm files in text format and convert between the two formats. between the two formats.</p>
</blockquote>
<h2 id="using-external-functions-memory-and-pointers">Using external functions, memory and pointers</h2>
<p>The next step is to do something that beginners of every programming language love to do: output a Hello world.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">hello_world</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;Hello world!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;WebAssembly模块测试&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Compile &hellip;&hellip; Wait a minute, since it is compiled to WebAssembly, where do I find the standard library <code>stdio.h</code> and this <code>puts</code>? Look at the text format code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">(</span><span class="nx">module</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">type</span> <span class="nx">$t0</span> <span class="p">(</span><span class="nx">func</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">type</span> <span class="nx">$t1</span> <span class="p">(</span><span class="nx">func</span> <span class="p">(</span><span class="nx">param</span> <span class="nx">i32</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">i32</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">import</span> <span class="s2">&#34;env&#34;</span> <span class="s2">&#34;puts&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">puts</span> <span class="p">(</span><span class="nx">type</span> <span class="nx">$t1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">import</span> <span class="s2">&#34;env&#34;</span> <span class="s2">&#34;__memory_base&#34;</span> <span class="p">(</span><span class="nx">global</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">__memory_base</span> <span class="nx">i32</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">import</span> <span class="s2">&#34;env&#34;</span> <span class="s2">&#34;memory&#34;</span> <span class="p">(</span><span class="nx">memory</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">memory</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">func</span> <span class="nx">$__wasm_apply_relocs</span> <span class="p">(</span><span class="nx">type</span> <span class="nx">$t0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nop</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">func</span> <span class="nx">$hello_world</span> <span class="p">(</span><span class="nx">type</span> <span class="nx">$t0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">local</span> <span class="nx">$l0</span> <span class="nx">i32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">global</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">__memory_base</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local</span><span class="p">.</span><span class="nx">tee</span> <span class="nx">$l0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">call</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">puts</span>
</span></span><span class="line"><span class="cl">    <span class="nx">drop</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$l0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i32</span><span class="p">.</span><span class="kr">const</span> <span class="mi">13</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i32</span><span class="p">.</span><span class="nx">add</span>
</span></span><span class="line"><span class="cl">    <span class="nx">call</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">puts</span>
</span></span><span class="line"><span class="cl">    <span class="nx">drop</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">global</span> <span class="nx">$__dso_handle</span> <span class="nx">i32</span> <span class="p">(</span><span class="nx">i32</span><span class="p">.</span><span class="kr">const</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;__wasm_apply_relocs&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$__wasm_apply_relocs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;hello_world&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$hello_world</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;__dso_handle&#34;</span> <span class="p">(</span><span class="nx">global</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kr">export</span> <span class="s2">&#34;__post_instantiate&#34;</span> <span class="p">(</span><span class="nx">func</span> <span class="nx">$__wasm_apply_relocs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nx">data</span> <span class="nx">$d0</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$env</span><span class="p">.</span><span class="nx">__memory_base</span><span class="p">)</span> <span class="s2">&#34;Hello world!\00WebAssembly\e6\a8\a1\e5\9d\97\e6\b5\8b\e8\af\95\00&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>puts</code> is something you need to import from JS. You can actually leave <code>#include &lt;stdio.h&gt;</code> out of the C code and just declare it with <code>int puts(const char *str);</code>.</p>
<p>The strings are all written into a single data segment (the Chinese part uses the same UTF-8 encoding as the source code). When loading the wasm module, you need to provide an area of memory to hold this data from an offset position.</p>
<p>Here we start by using <code>console.log</code> instead of <code>puts</code> and create a <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory"><code>WebAssembly.Memory</code></a> as a memory area, which is passed to the wasm module to be loaded via an object (i.e. <code>importObject</code> above).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmMemory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span><span class="p">({</span> <span class="nx">initial</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">wasmMemory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmModule</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;hello-world.wasm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">buffer</span> <span class="p">=&gt;</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">module</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">puts</span><span class="o">:</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">memory</span><span class="o">:</span> <span class="nx">wasmMemory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">__memory_base</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WebAssembly.Memory</code> is a block of memory for wasm modules, allocated in 64 KB &ldquo;pages&rdquo; as a base unit, and can be dynamically expanded after creation. It can be read and written to in JS using <code>TypedArray</code>.</p>
<p>Try loading and executing.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/01/107580dacc794c9daa0ac96488496f31.png" alt="WebAssembly"></p>
<p>The string is written to a location in memory starting at <code>__memory_base</code>, and as in C, the argument to the call to <code>puts</code> (actually <code>console.log</code>) is a pointer to the start of the string (the array index). If you implement a <code>puts</code> yourself, you can output the string to the console (or to the innerText of some DOM on the page).</p>
<blockquote>
<p>By the way, there is a library called <a href="https://github.com/locutusjs/locutus">Locutus</a> that tries to use JS to implement standard libraries for other languages, although there are not many implementations for C &hellip;&hellip;</p>
<p>For example, to implement <code>sprintf</code> or <code>printf</code>, see <a href="https://github.com/locutusjs/locutus/blob/master/src/c/stdio/sprintf.js">here</a>.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmMemory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span><span class="p">({</span> <span class="nx">initial</span><span class="o">:</span> <span class="mi">1</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">wasmMemory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">wasmModule</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">&#39;hello-world.wasm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">arrayBuffer</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">buffer</span> <span class="p">=&gt;</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">module</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Decode the data between the start of the pointer and the next 0x00 in UTF-8, and then output it with console.log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">puts</span><span class="o">:</span> <span class="nx">ptr</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="k">new</span> <span class="nx">TextDecoder</span><span class="p">).</span><span class="nx">decode</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">wasmBuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">ptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">wasmBuffer</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">e</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">ptr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">memory</span><span class="o">:</span> <span class="nx">wasmMemory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">__memory_base</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/01/30909d7eb82541d8a0ff792086e57918.png" alt="WebAssembly"></p>
<p>Try to change the data of the first cell in memory to <code>0x41</code> (that is, the letter A), call the function again, and you will see that the output has changed accordingly. Of course, in practice, if you need to write data to memory, you have to reserve memory space according to <code>__memory_base</code> and the size of the data segment in your code to avoid overwriting the data used inside the wasm module.</p>
<p>If you need to use local variables in your code, common sense tells you that these variables are stored on the stack, and the compiled wasm will require the introduction of <code>__stack_pointer</code> to set the stack pointer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">__stack_pointer</span><span class="o">:</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Global</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">mutable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;i32&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="mh">0x1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Like the real CPU, the stack pointer extends to the lower address, so we get a simple process address space model like this: <code>| read-only data | &lt;- stack | heap -&gt; |</code>, which is starting to get a bit involved in operating system knowledge &hellip;&hellip;</p>
<p>Now that we mention the heap, can we use <code>malloc</code> and <code>free</code> to dynamically allocate memory on the heap? However, even without performance considerations, a full memory allocator is very complex and not usable in the case of such simple modules compiled as <code>SIDE_MODULE</code>, and will not be covered in depth here. The &ldquo;Building an allocator&rdquo; section of <a href="https://surma.dev/things/c-to-webassembly/">this article</a> suggests a simple alternative: the allocated memory address is simply the starting address of the heap The allocated memory addresses are simply accumulated from the start of the heap, and as for <code>free</code>? Just leave it empty.</p>
<h2 id="an-example-of-using-webassembly-to-increase-performance-to-30x">An example of using WebAssembly to increase performance to 30x</h2>
<p>The next step is to use a real-world example to demonstrate the superior performance of WebAssembly compared to JS for computationally intensive tasks. I tried to implement <a href="https://zh.wikipedia.org/wiki/RC4">RC4 encryption and decryption algorithm</a> in WebAssembly and JS respectively, why did I use RC4 as an example?</p>
<ul>
<li>Encryption and decryption involve a lot of computational operations</li>
<li>RC4 is a short algorithm, and encryption and decryption are the same set of algorithms, so it is easy to implement.</li>
<li>RC4 is a stream cipher, which does not require much plaintext and key length, and does not need to handle different working modes like packet ciphers, so it is easy to use</li>
<li>has some practicality (although the security of RC4 is now more limited &hellip;&hellip;)</li>
</ul>
<p>Here is the pseudo-code from Wikipedia.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="n">from</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">255</span>
</span></span><span class="line"><span class="cl">    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:=</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="n">endfor</span>
</span></span><span class="line"><span class="cl"><span class="nl">j</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nl">j</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="n">mod</span> <span class="n">keylength</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="n">swap</span> <span class="n">values</span> <span class="n">of</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">and</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">endfor</span>
</span></span><span class="line"><span class="cl"><span class="nl">i</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">j</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="nl">GeneratingOutput</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nl">i</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">mod</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="nl">j</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">mod</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">    <span class="n">swap</span> <span class="n">values</span> <span class="n">of</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">and</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nl">k</span> <span class="p">:</span><span class="o">=</span> <span class="n">inputByte</span> <span class="o">^</span> <span class="n">S</span><span class="p">[(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="n">K</span>
</span></span><span class="line"><span class="cl"><span class="n">endwhile</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Follow the pseudo-code and use JS to implement it again (the implementation was verified to be completely correct, the verification process is omitted).</p>
<p>Implementation using JS.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param {Uint8Array} key
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param {Uint8Array} input
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @returns {Uint8Array}
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">jsRc4</span> <span class="o">=</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">keyLength</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">inputLength</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sbox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">j</span> <span class="o">=</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">key</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">keyLength</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">sbox</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">inputLength</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">inputLength</span><span class="p">;</span> <span class="o">++</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">j</span> <span class="o">=</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">sbox</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">        <span class="nx">output</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">^</span> <span class="nx">sbox</span><span class="p">[(</span><span class="nx">sbox</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">sbox</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then ported to C.</p>
<p>Implementation using C language, and associated JS glue code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sbox</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">rc4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keyLength</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inputLength</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// j = (j + sbox[i] + key[i % keyLength]) &amp; 0xFF;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">j</span> <span class="o">+=</span> <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">keyLength</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">sbox</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">inputLength</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// j = (j + sbox[i]) &amp; 0xFF;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">j</span> <span class="o">+=</span> <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbox</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">sbox</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">input</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">^=</span> <span class="n">sbox</span><span class="p">[(</span><span class="n">sbox</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sbox</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The test is to use <del>KB random key</del> to encrypt 4KB, 8KB &hellip;&hellip;128MB of the same random data using two implementations, and compare the execution times.</p>
<p>I realized after the test that I don&rsquo;t need such a long key &hellip;&hellip; <strong>more than the first 256 bytes is meaningless</strong>, but it doesn&rsquo;t affect the test results, so I won&rsquo;t retest it!</p>
<p>Test Code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">inputLength</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inputLength</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">rc4Key</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="nx">map</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">rc4Input</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">inputLength</span><span class="p">).</span><span class="nx">map</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">256</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="s1">&#39;wasm-start&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">wasmEncrypted</span> <span class="o">=</span> <span class="nx">wasmRc4</span><span class="p">(</span><span class="nx">rc4Key</span><span class="p">,</span> <span class="nx">rc4Input</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="s1">&#39;wasm-end&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="s1">&#39;js-start&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">jsEncrypted</span> <span class="o">=</span> <span class="nx">jsRc4</span><span class="p">(</span><span class="nx">rc4Key</span><span class="p">,</span> <span class="nx">rc4Input</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">mark</span><span class="p">(</span><span class="s1">&#39;js-end&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span><span class="s1">&#39;wasm&#39;</span><span class="p">,</span> <span class="s1">&#39;wasm-start&#39;</span><span class="p">,</span> <span class="s1">&#39;wasm-end&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">measure</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;js-start&#39;</span><span class="p">,</span> <span class="s1">&#39;js-end&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">inputLength</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wasmEncrypted</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">jsEncrypted</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="k">throw</span> <span class="s1">&#39;Not equal&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">length</span><span class="o">:</span> <span class="nx">inputLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wasmTime</span><span class="o">:</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">getEntriesByName</span><span class="p">(</span><span class="s1">&#39;wasm&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">jsTime</span><span class="o">:</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">getEntriesByName</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">clearMarks</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">performance</span><span class="p">.</span><span class="nx">clearMeasures</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">acc</span><span class="p">,</span> <span class="nx">cur</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">acc</span><span class="p">)</span> <span class="nx">acc</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">cur</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">acc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">length</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wasmTime</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">jsTime</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">results</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">r</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nx">wasmSpeed</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">r</span><span class="p">.</span><span class="nx">wasmTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nx">jsSpeed</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">r</span><span class="p">.</span><span class="nx">jsTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nx">ratio</span> <span class="o">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">wasmSpeed</span> <span class="o">/</span> <span class="nx">r</span><span class="p">.</span><span class="nx">jsSpeed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As for the test results, &hellip;&hellip; was first tested on my daily Firefox, and the performance was directly improved by 8x!</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/01/d4d8140b7ea14cf9bc4f8e2a8ba8ff79.png" alt="Firefox"></p>
<p>Then there are the test results on Chrome. Even against Chrome, which uses the most powerful V8 engine, WebAssembly still has a performance advantage of 2x (although the speed is similar to that of Firefox &hellip;&hellip;)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/01/2b2ab27b411e403fb9c725eb7d3c837b.png" alt="Chrome"></p>
<p>As for the title, 30x&hellip;&hellip; is measured in the old Edge that has been abandoned, but the execution speed of both WebAssembly and JS is much worse than the other two.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/01/e779c33a60d94131a418772c9348e31f.png" alt="Edge"></p>
<p>You can also try it for yourself <a href="https://jsbin.com/taxocoripu/edit?html,output">here</a> ~ (wasm file is already embedded as a Data URL)</p>
<p>The conclusion is obvious, WebAssembly&rsquo;s performance is much higher than JS. And if you don&rsquo;t write the function name clearly, it&rsquo;s hard to see the RC4 algorithm directly against its &ldquo;assembly code&rdquo;, so it might be a good idea to put some key operations into the wasm module to prevent the front-end code from being reversed?</p>
<p>Even if you&rsquo;re not familiar with C and Emscripten&rsquo;s set of tools, there are tools like <a href="https://github.com/ballercat/walt">Walt</a> and <a href="https://github.com/AssemblyScript/">AssemblyScript</a> on GitHub assemblyscript) to write wasm modules directly using TypeScript syntax, so try that later!</p>
<h2 id="extra-simd-support-for-webassembly">Extra: SIMD Support for WebAssembly</h2>
<p>The WebAssembly standard has a <a href="https://github.com/WebAssembly/simd">proposal for a SIMD instruction set</a>, and recently the major browsers and the JS engine for Node.js have finally <a href="https://github.com/">implemented support for SIMD</a> WebAssembly/simd/blob/main/proposals/simd/ImplementationStatus.md). In theory, using SIMD could further increase the execution speed of wasm (although this doesn&rsquo;t seem to be the case in the simple tests I&rsquo;ve done &hellip;&hellip;)</p>
<p>Referring to <a href="https://github.com/GoogleChromeLabs/wasm-feature-detect">GoogleChromeLabs/wasm-feature-detect</a>, SIMD support can be tested with the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">11</span><span class="p">]));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>According to the <a href="https://emscripten.org/docs/porting/simd.html">Emscripten documentation</a>, compiling with the parameter <code>-msimd128</code> allows you to use SIMD optimization directly at compile time.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/webassembly/">Webassembly</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/hashcorp-vault/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Hashcorp Vault Basic Tutorial</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/py9/">
            <span class="next-text nav-default">What does Python 3.9 bring?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
