<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Developing Kubernetes Operators with Go: Basic Architecture - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to develop Kubernetes Operators using Go." /><meta name="keywords" content="Golang, Kubernetes Operators" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-08/go-k8s-operators-part1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Developing Kubernetes Operators with Go: Basic Architecture" />
<meta property="og:description" content="Learn how to develop Kubernetes Operators using Go." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-08/go-k8s-operators-part1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-16T11:08:08+08:00" />
<meta property="article:modified_time" content="2022-08-16T11:08:08+08:00" />

<meta itemprop="name" content="Developing Kubernetes Operators with Go: Basic Architecture">
<meta itemprop="description" content="Learn how to develop Kubernetes Operators using Go."><meta itemprop="datePublished" content="2022-08-16T11:08:08+08:00" />
<meta itemprop="dateModified" content="2022-08-16T11:08:08+08:00" />
<meta itemprop="wordCount" content="6071">
<meta itemprop="keywords" content="golang,Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Developing Kubernetes Operators with Go: Basic Architecture"/>
<meta name="twitter:description" content="Learn how to develop Kubernetes Operators using Go."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Developing Kubernetes Operators with Go: Basic Architecture</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-16 11:08:08 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 6071 words </span>
          <span class="more-meta"> 29 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-advantages-of-operator">1. Advantages of Operator</a></li>
        <li><a href="#2-introduction-to-kubernetes-resource-resource-type-api-and-controller">2. Introduction to Kubernetes resource, resource type, API and controller</a></li>
        <li><a href="#3-operator-pattern--operation-object-crd--control-logic-controller">3. Operator pattern = operation object (CRD) + control logic (controller)</a></li>
        <li><a href="#4-developing-a-webserver-operator-with-kubebuilder">4. Developing a webserver operator with kubebuilder</a>
          <ul>
            <li><a href="#1-installing-kubebuilder">1. Installing kubebuilder</a></li>
            <li><a href="#2-creating-the-webserver-operator-project">2. Creating the webserver-operator project</a></li>
            <li><a href="#3-creating-the-api-and-generating-the-initial-crd">3. Creating the API and generating the initial CRD</a></li>
            <li><a href="#4-the-basic-structure-of-the-webserver-operator">4. The basic structure of the webserver-operator</a></li>
            <li><a href="#5-adding-fields-to-the-crd-spec-fields">5. Adding fields to the CRD spec (fields)</a></li>
            <li><a href="#6-modify-roleyaml">6. Modify role.yaml</a></li>
            <li><a href="#7-implementing-the-controllers-reconcile-coordination-logic">7. Implementing the controller&rsquo;s Reconcile (coordination) logic</a></li>
            <li><a href="#8-building-the-controller-image">8. Building the controller image</a></li>
            <li><a href="#9-deploying-the-controller">9. Deploying the controller</a></li>
            <li><a href="#10-creating-the-webserver-cr">10. Creating the WebServer CR</a></li>
            <li><a href="#11-scaling-changing-versions-and-service-self-healing">11. Scaling, Changing Versions, and Service Self-Healing</a></li>
          </ul>
        </li>
        <li><a href="#5-summary">5. Summary</a></li>
        <li><a href="#6-reference">6. Reference</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/c70a0e1d0c77471e9e705a817cc25b0f.png" alt="Developing Kubernetes Operators with Go"></p>
<blockquote>
<p>Image credit from &ldquo;Kubernetes Operators Explained</p>
</blockquote>
<p>A few years ago, I called Kubernetes the de facto standard for service orchestration and container scheduling, and today K8s is the unchallenged &ldquo;kingpin&rdquo; of the space. However, while Kubernetes has evolved to become very complex today, the original data model, application model and scaling approach of Kubernetes is still valid. And <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">application models and scaling methods like Operator</a> are becoming increasingly popular with developers and operators.</p>
<p>We have stateful backend services inside our platform. Deployment and maintenance of stateful services is the specialty of k8s operators, so it&rsquo;s time to look at operator.</p>
<p>Study the operator now.</p>
<h2 id="1-advantages-of-operator">1. Advantages of Operator</h2>
<p><a href="https://web.archive.org/web/20170129131616/https://coreos.com/blog/introducing-operators.html">The concept of the kubernetes operator originally came from CoreOS</a>, a container technology company acquired by Red Hat.</p>
<p>CoreOS introduced the operator concept along with the first reference implementations of the operator: the <a href="https://web.archive.org/web/20170224100544/https://coreos.com/blog/introducing-the-etcd-operator.html">etcd operator</a> and the <a href="https://web.archive.org/web/20170224101137/https://coreos.com/blog/the-prometheus-operator.html">prometheus operator</a>.</p>
<blockquote>
<p>Note: <a href="https://etcd.io/">etcd</a> was released as open source by CoreOS in 2013; <a href="https://prometheus.io/">prometheus</a>, the first time-series data storage and monitoring system for cloud-native services, was released as open source by SoundCloud in 2012.</p>
</blockquote>
<p>Here is CoreOS&rsquo;s interpretation of the concept of Operator: Operator represents in software the human knowledge of operations and maintenance through which an application can be reliably managed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/c51076d7348c485db6abfe32eb9e537b.png" alt="CoreOS interpretation of operator"></p>
<blockquote>
<p>Screenshot from the official CoreOS blog archive</p>
</blockquote>
<p>The original purpose of Operator was to free up operations staff, and today Operator is becoming increasingly popular with cloud-native operations developers.</p>
<p>So what are the benefits of Operator? The following diagram compares the benefits of using Operator with those of not using it.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/89175ac5bd494750b10f25f77f7bf8ce.png" alt="using Operator with those of not using it"></p>
<p>This diagram gives you an idea of the benefits of operators, even if you don&rsquo;t know much about them.</p>
<p>We can see that with operator, a simple command is all that is needed to scale a stateful application (in this case, scale-out operations, but also other &ldquo;complex&rdquo; operations for stateful applications such as version upgrades). Ops doesn&rsquo;t need to know how scaling works inside k8s for stateful applications.</p>
<p>In the absence of an operator, Ops needs to have a deep knowledge of the steps of stateful application scaling, and execute the commands in a sequence one by one and check the command response, and retry in case of failure until the scaling succeeds.</p>
<p>We see operator as an experienced operator built into k8s, monitoring the state of the target object at all times, keeping the complexity to itself, giving the operator a simple interface to interact with, and at the same time operator reduces the probability of operational errors caused by the operator for personal reasons.</p>
<p>However, although operator is good, but the development threshold is not low. The development threshold is reflected in at least the following aspects.</p>
<ul>
<li>The understanding of the operator concept is based on the understanding of k8s, which has become increasingly complex since it was open sourced in 2014, and requires some time investment to understand.</li>
<li>Hand-jobbing operator from scratch is very verbose, almost no one does it, most developers go to learn the corresponding development framework and tools, such as: <a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>, <a href="https://sdk.operatorframework.io/">operator framework sdk</a>, etc..</li>
<li>There are also high and low levels of operator capability, and the operator framework proposes a CAPABILITY MODEL containing * five levels of operator capability, see the following figure. Developing operators with high capability levels using Go requires a deep understanding of <a href="https://github.com/kubernetes/client-go">client-go</a>, the API in the official kubernetes go client library.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/b104c9e781f04ffc9841bbea3e91055b.png" alt="Operator Capability Model"></p>
<blockquote>
<p>Screenshot from operator framework official website</p>
</blockquote>
<p>Of course, among these thresholds, understanding the concept of operator is both the foundation and the prerequisite, and understanding operator in turn presupposes a deep understanding of many concepts of kubernetes, especially resource, resource type, API, controller, and the relationship between them. Let&rsquo;s take a quick look at these concepts.</p>
<h2 id="2-introduction-to-kubernetes-resource-resource-type-api-and-controller">2. Introduction to Kubernetes resource, resource type, API and controller</h2>
<p>Kubernetes has evolved to the point where its essence has become apparent.</p>
<ul>
<li>Kubernetes is a &ldquo;database&rdquo; (the data is actually stored persistently in etcd).</li>
<li>Its API is a &ldquo;sql statement&rdquo;.</li>
<li>The API is designed in a resource-based Restful style, with the resource type being the endpoint of the API.</li>
<li>Each type of resource (i.e. Resource Type) is a &ldquo;table&rdquo;, and the spec of the Resource Type corresponds to the &ldquo;table structure&rdquo; information (schema).</li>
<li>A row in each &ldquo;table&rdquo; is a resource, i.e., an instance of the Resource Type corresponding to that table.</li>
<li>Kubernetes has many built-in &ldquo;tables&rdquo;, such as Pod, Deployment, DaemonSet, ReplicaSet, etc.</li>
</ul>
<p>The following is a schematic representation of the relationship between the Kubernetes API and RESOURCE.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/430aa92c0c314631bec2f9f25caa0f7d.png" alt="Diagram of the relationship between the Kubernetes API and resource"></p>
<p>We see that there are two types of resource types, one namespace-related (namespace-scoped), and we manipulate instances of such resource types by means of an API of the following form.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">VERB /apis/GROUP/VERSION/namespaces/NAMESPACE/RESOURCETYPE - Manipulate a collection of resource instances in a resouce <span class="nb">type</span> under a specific namespace
</span></span><span class="line"><span class="cl">VERB /apis/GROUP/VERSION/namespaces/NAMESPACE/RESOURCETYPE/NAME - Operate on a specific resource instance of a resource <span class="nb">type</span> under a specific namespace
</span></span></code></pre></td></tr></table>
</div>
</div><p>The other class is namespace-independent, i.e., cluster-scoped, and we operate on instances of this type of resource type through the following form of API.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">VERB /apis/GROUP/VERSION/RESOURCETYPE - Manipulating a collection of resource instances in a resouce <span class="nb">type</span>
</span></span><span class="line"><span class="cl">VERB /apis/GROUP/VERSION/RESOURCETYPE/NAME - Manipulate a specific resource instance in the resource <span class="nb">type</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We know that Kubernetes is not really just a &ldquo;database&rdquo;, it is a platform standard for service orchestration and container scheduling, and its basic scheduling unit is a Pod (also a resource type), which is a collection of containers. How are Pods created, updated and deleted? This can&rsquo;t be done without a controller. <strong>Each type of resource type has its own controller</strong> . Take the resource type pod as an example, its controller is an instance of ReplicasSet.</p>
<p>The operating logic of the controller is shown in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/d856ce62d35641e98e2fa7808ea6492f.png" alt="Controller operation logic"></p>
<blockquote>
<p>Quoted from the article &ldquo;Kubernetes Operators Explained</p>
</blockquote>
<p>Once the controller starts, it will try to get the current state of the resource and compare it with the desired state (spec) of the resource stored in k8s, and if it does not match, the controller will call the corresponding API to adjust it and try to make the current state to agree with the desired state. This reconciliation process is called <strong>reconciliation</strong>, and the pseudo-code logic of the reconciliation process is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">desired</span> <span class="o">:=</span> <span class="nf">getDesiredState</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">current</span> <span class="o">:=</span> <span class="nf">getCurrentState</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">makeChanges</span><span class="p">(</span><span class="nx">desired</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: There is a concept of object in k8s? So what is an object? It is similar to the Java Object base class or the Object superclass in Ruby. Not only is the instance resource of a resource type an (is-a)object, but the resource type itself is also an object, which is an instance of the kubernetes concept.</p>
</blockquote>
<p>With the above initial understanding of these concepts of k8s, let&rsquo;s understand what Operator really is!</p>
<h2 id="3-operator-pattern--operation-object-crd--control-logic-controller">3. Operator pattern = operation object (CRD) + control logic (controller)</h2>
<p>If the operations and maintenance personnel face these built-in resource type (such as deployment, pod, etc.), which is the second case in the previous &ldquo;using operator vs. not using operator&rdquo; comparison chart, the operations and maintenance personnel will face a very complex situation, and operation The operation will be very complicated and error-prone.</p>
<p>So how do we customize the resource type if we don&rsquo;t face the built-in resource type, Kubernetes provides Custom Resource Definition, CRD (when coreos first introduced the operator concept, crd was formerly known as Third Party Resource, TPR) can be used to customize the resource type.</p>
<p>According to our understanding of resource type, defining a CRD is equivalent to creating a new &ldquo;table&rdquo; (resource type), and once the CRD is created, k8s will automatically generate an API endpoint for us corresponding to the CRD, and we can manipulate it through yaml or API. We can manipulate this &ldquo;table&rdquo; through yaml or API. We can &ldquo;insert&rdquo; data into the &ldquo;table&rdquo;, i.e., create a Custom Resource (CR) based on the CRD, which is like creating a Deployment instance and inserting data into the Deployment &ldquo;table&rdquo;.</p>
<p>Like the native built-in resource type, it is not enough to have a CR that stores the state of the object, the native resource type has a corresponding controller responsible for coordinating the creation, scaling and deletion of instances. CR also needs such a &ldquo;coordinator&rdquo;. That is, we also need to define a controller to listen to the CR state and manage the creation, scaling, and deletion of CRs, as well as to keep the desired state (spec) consistent with the current state (current state). This controller is no longer an instance of the native Resource type, but a controller for the <strong>CRD-oriented instance CR</strong>.</p>
<p>With a custom operation object type (CRD) and a controller oriented to instances of the operation object type, we packaged it into a concept: the &ldquo;Operator pattern&rdquo;. The controller in the operator pattern is also called operator, and it is the controller in the The main body of the cluster that performs maintenance operations on CRs.</p>
<h2 id="4-developing-a-webserver-operator-with-kubebuilder">4. Developing a webserver operator with kubebuilder</h2>
<blockquote>
<p>Assumptions: At this point, your local development environment has everything you need to access your experimental k8s environment, and you can manipulate k8s at will through the kubectl tool.</p>
</blockquote>
<p><strong>A more in-depth explanation of the concept is not as helpful as a real-world experience to understand the concept</strong>, we will develop a simple Operator.</p>
<p>As mentioned before, operator development is very verbose, so the community provides development tools and frameworks to help developers simplify the development process, and the current mainstream includes operator framework sdk and kubebuilder. The former is a set of tools open-sourced and maintained by redhat, supporting operator development using go, ansible, and helm (of which only go can develop operators up to capability level 5, while the other two cannot); and kubebuilder is an operator development tool maintained by the official sig (special interest group) of kubernetes. Currently, when developing operators based on the operator framework sdk and go, the operator sdk also uses kubebuilder at the bottom, so here we will directly use kubebuilder to develop operators.</p>
<p><strong>A more in-depth explanation of the concept is not as helpful as a real-world experience to understand the concept</strong>, we will develop a simple Operator.</p>
<p>As mentioned before, operator development is very verbose, so the community provides development tools and frameworks to help developers simplify the development process, and the current mainstream includes operator framework sdk and kubebuilder. The former is a set of tools open-sourced and maintained by redhat, which supports operator development using go, ansible, and helm (of which only go can develop operators up to capability level 5, while the other two cannot); and kubebuilder is an operator development tool maintained by the official sig (interest group) of kubernetes. Currently, when developing operators based on the operator framework sdk and go, the operator sdk also uses kubebuilder at the bottom, so here we will directly use kubebuilder to develop operators.</p>
<p>According to the operator capability model, our operator is almost at this level of level 2. We define a resource type of a webserver, which represents an nginx-based webserver cluster, and our operator supports the creation of webserver examples (an nginx cluster), support for nginx cluster scaling, and support for version upgrades of nginx in the cluster.</p>
<p>Let&rsquo;s use kubebuilder to implement this operator!</p>
<h3 id="1-installing-kubebuilder">1. Installing kubebuilder</h3>
<p>Here we use the source code build method to install, and the steps are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$git</span> clone git@github.com:kubernetes-sigs/kubebuilder.git
</span></span><span class="line"><span class="cl"><span class="nv">$cd</span> kubebuilder
</span></span><span class="line"><span class="cl"><span class="nv">$make</span>
</span></span><span class="line"><span class="cl"><span class="nv">$cd</span> bin
</span></span><span class="line"><span class="cl">$./kubebuilder version
</span></span><span class="line"><span class="cl">Version: main.version<span class="o">{</span>KubeBuilderVersion:<span class="s2">&#34;v3.5.0-101-g5c949c2e&#34;</span>,
</span></span><span class="line"><span class="cl">KubernetesVendor:<span class="s2">&#34;unknown&#34;</span>,
</span></span><span class="line"><span class="cl">GitCommit:<span class="s2">&#34;5c949c2e50ca8eec80d64878b88e1b2ee30bf0bc&#34;</span>,
</span></span><span class="line"><span class="cl">BuildDate:<span class="s2">&#34;2022-08-06T09:12:50Z&#34;</span>, GoOs:<span class="s2">&#34;linux&#34;</span>, GoArch:<span class="s2">&#34;amd64&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then just copy bin/kubebuilder to one of the paths in your PATH environment variable.</p>
<h3 id="2-creating-the-webserver-operator-project">2. Creating the webserver-operator project</h3>
<p>Next, we can use kubebuilder to create the webserver-operator project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$mkdir</span> webserver-operator
</span></span><span class="line"><span class="cl"><span class="nv">$cd</span> webserver-operator
</span></span><span class="line"><span class="cl"><span class="nv">$kubebuilder</span> init  --repo github.com/bigwhite/webserver-operator --project-name webserver-operator
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Writing kustomize manifests <span class="k">for</span> you to edit...
</span></span><span class="line"><span class="cl">Writing scaffold <span class="k">for</span> you to edit...
</span></span><span class="line"><span class="cl">Get controller runtime:
</span></span><span class="line"><span class="cl">$ go get sigs.k8s.io/controller-runtime@v0.12.2
</span></span><span class="line"><span class="cl">go: downloading k8s.io/client-go v0.24.2
</span></span><span class="line"><span class="cl">go: downloading k8s.io/component-base v0.24.2
</span></span><span class="line"><span class="cl">Update dependencies:
</span></span><span class="line"><span class="cl">$ go mod tidy
</span></span><span class="line"><span class="cl">Next: define a resource with:
</span></span><span class="line"><span class="cl">kubebuilder create api
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: -repo specifies the module root path in go.mod, you can define your own module root path.</p>
</blockquote>
<h3 id="3-creating-the-api-and-generating-the-initial-crd">3. Creating the API and generating the initial CRD</h3>
<p>The Operator consists of a CRD and a controller. Here we create our own CRD, i.e., a custom resource type, which is the endpoint of the API, and we use the following kubebuilder create command to complete this step.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubebuilder</span> create api --version v1 --kind WebServer
</span></span><span class="line"><span class="cl">Create Resource <span class="o">[</span>y/n<span class="o">]</span>
</span></span><span class="line"><span class="cl">y
</span></span><span class="line"><span class="cl">Create Controller <span class="o">[</span>y/n<span class="o">]</span>
</span></span><span class="line"><span class="cl">y
</span></span><span class="line"><span class="cl">Writing kustomize manifests <span class="k">for</span> you to edit...
</span></span><span class="line"><span class="cl">Writing scaffold <span class="k">for</span> you to edit...
</span></span><span class="line"><span class="cl">api/v1/webserver_types.go
</span></span><span class="line"><span class="cl">controllers/webserver_controller.go
</span></span><span class="line"><span class="cl">Update dependencies:
</span></span><span class="line"><span class="cl">$ go mod tidy
</span></span><span class="line"><span class="cl">Running make:
</span></span><span class="line"><span class="cl">$ make generate
</span></span><span class="line"><span class="cl">mkdir -p /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin
</span></span><span class="line"><span class="cl"><span class="nb">test</span> -s /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen <span class="o">||</span> <span class="nv">GOBIN</span><span class="o">=</span>/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.9.2
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen object:headerFile<span class="o">=</span><span class="s2">&#34;hack/boilerplate.go.txt&#34;</span> <span class="nv">paths</span><span class="o">=</span><span class="s2">&#34;./...&#34;</span>
</span></span><span class="line"><span class="cl">Next: implement your new API and generate the manifests <span class="o">(</span>e.g. CRDs,CRs<span class="o">)</span> with:
</span></span><span class="line"><span class="cl">$ make manifests
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, we execute make manifests to generate the yaml file corresponding to the final CRD.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$make</span> manifests
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen rbac:roleName<span class="o">=</span>manager-role crd webhook <span class="nv">paths</span><span class="o">=</span><span class="s2">&#34;./...&#34;</span> output:crd:artifacts:config<span class="o">=</span>config/crd/bases
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this moment, the directory file layout of the entire project is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$tree</span> -F .
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── api/
</span></span><span class="line"><span class="cl">│   └── v1/
</span></span><span class="line"><span class="cl">│       ├── groupversion_info.go
</span></span><span class="line"><span class="cl">│       ├── webserver_types.go
</span></span><span class="line"><span class="cl">│       └── zz_generated.deepcopy.go
</span></span><span class="line"><span class="cl">├── bin/
</span></span><span class="line"><span class="cl">│   └── controller-gen*
</span></span><span class="line"><span class="cl">├── config/
</span></span><span class="line"><span class="cl">│   ├── crd/
</span></span><span class="line"><span class="cl">│   │   ├── bases/
</span></span><span class="line"><span class="cl">│   │   │   └── my.domain_webservers.yaml
</span></span><span class="line"><span class="cl">│   │   ├── kustomization.yaml
</span></span><span class="line"><span class="cl">│   │   ├── kustomizeconfig.yaml
</span></span><span class="line"><span class="cl">│   │   └── patches/
</span></span><span class="line"><span class="cl">│   │       ├── cainjection_in_webservers.yaml
</span></span><span class="line"><span class="cl">│   │       └── webhook_in_webservers.yaml
</span></span><span class="line"><span class="cl">│   ├── default/
</span></span><span class="line"><span class="cl">│   │   ├── kustomization.yaml
</span></span><span class="line"><span class="cl">│   │   ├── manager_auth_proxy_patch.yaml
</span></span><span class="line"><span class="cl">│   │   └── manager_config_patch.yaml
</span></span><span class="line"><span class="cl">│   ├── manager/
</span></span><span class="line"><span class="cl">│   │   ├── controller_manager_config.yaml
</span></span><span class="line"><span class="cl">│   │   ├── kustomization.yaml
</span></span><span class="line"><span class="cl">│   │   └── manager.yaml
</span></span><span class="line"><span class="cl">│   ├── prometheus/
</span></span><span class="line"><span class="cl">│   │   ├── kustomization.yaml
</span></span><span class="line"><span class="cl">│   │   └── monitor.yaml
</span></span><span class="line"><span class="cl">│   ├── rbac/
</span></span><span class="line"><span class="cl">│   │   ├── auth_proxy_client_clusterrole.yaml
</span></span><span class="line"><span class="cl">│   │   ├── auth_proxy_role_binding.yaml
</span></span><span class="line"><span class="cl">│   │   ├── auth_proxy_role.yaml
</span></span><span class="line"><span class="cl">│   │   ├── auth_proxy_service.yaml
</span></span><span class="line"><span class="cl">│   │   ├── kustomization.yaml
</span></span><span class="line"><span class="cl">│   │   ├── leader_election_role_binding.yaml
</span></span><span class="line"><span class="cl">│   │   ├── leader_election_role.yaml
</span></span><span class="line"><span class="cl">│   │   ├── role_binding.yaml
</span></span><span class="line"><span class="cl">│   │   ├── role.yaml
</span></span><span class="line"><span class="cl">│   │   ├── service_account.yaml
</span></span><span class="line"><span class="cl">│   │   ├── webserver_editor_role.yaml
</span></span><span class="line"><span class="cl">│   │   └── webserver_viewer_role.yaml
</span></span><span class="line"><span class="cl">│   └── samples/
</span></span><span class="line"><span class="cl">│       └── _v1_webserver.yaml
</span></span><span class="line"><span class="cl">├── controllers/
</span></span><span class="line"><span class="cl">│   ├── suite_test.go
</span></span><span class="line"><span class="cl">│   └── webserver_controller.go
</span></span><span class="line"><span class="cl">├── Dockerfile
</span></span><span class="line"><span class="cl">├── go.mod
</span></span><span class="line"><span class="cl">├── go.sum
</span></span><span class="line"><span class="cl">├── hack/
</span></span><span class="line"><span class="cl">│   └── boilerplate.go.txt
</span></span><span class="line"><span class="cl">├── main.go
</span></span><span class="line"><span class="cl">├── Makefile
</span></span><span class="line"><span class="cl">├── PROJECT
</span></span><span class="line"><span class="cl">└── README.md
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">14</span> directories, <span class="m">40</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4-the-basic-structure-of-the-webserver-operator">4. The basic structure of the webserver-operator</h3>
<p>Ignoring things like leader election, auth_proxy, etc. that we don&rsquo;t care about this time, I&rsquo;ve organized the main parts of this operator example into the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/1975a95e58a243fc84e1b7b2150fce99.png" alt="The basic structure of the webserver-operator"></p>
<p>The parts of the diagram are the basic structure of the <strong>operator</strong> generated using kubebuilder.</p>
<p>The webserver operator consists mainly of a CRD and a controller.</p>
<ul>
<li>
<p>CRD</p>
<p>The box in the lower left corner of the diagram is the CRD yaml file generated above: config/crd/bases/my.domain_webservers.yaml. CRD is closely related to api/v1/webserver_types.go. We define spec related fields for CRD in api/v1/webserver_types.go, after that make manifests command can parse the changes in webserver_types.go and update the CRD yaml file.</p>
</li>
<li>
<p>controller</p>
<p>The right part of the diagram shows that the controller itself is deployed as a deployment running in the k8s cluster, which monitors the running state of the CRD&rsquo;s instance CR and checks in the Reconcile method whether the expected state is consistent with the current state, and if not, performs the relevant action.</p>
</li>
<li>
<p>Other</p>
<p>The top left corner of the figure is about the controller&rsquo;s permission settings. The controller accesses the k8s API server through serviceaccount, and sets the controller&rsquo;s role and permission through role.yaml and role_binding.yaml.</p>
</li>
</ul>
<h3 id="5-adding-fields-to-the-crd-spec-fields">5. Adding fields to the CRD spec (fields)</h3>
<p>In order to achieve the functional goals of the webserver operator, we need to add some status fields to the CRD spec. As mentioned before, the CRD is synchronized with the webserver_types.go file in the api, so we just need to modify the webserver_types.go file. We add Replicas and Image fields to the WebServerSpec structure, which are used to indicate the number of copies of the webserver instance and the container image used, respectively.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// api/v1/webserver_types.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// WebServerSpec defines the desired state of WebServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">WebServerSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The number of replicas that the webserver should have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Replicas</span> <span class="kt">int</span> <span class="s">`json:&#34;replicas,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The container image of the webserver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Image</span> <span class="kt">string</span> <span class="s">`json:&#34;image,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Foo is an example field of WebServer. Edit webserver_types.go to remove/update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Foo</span> <span class="kt">string</span> <span class="s">`json:&#34;foo,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After saving the changes, <strong>execute make manifests</strong> to regenerate config/crd/bases/my.domain_webservers.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">$cat my.domain_webservers.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apiextensions.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CustomResourceDefinition</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller-gen.kubebuilder.io/version</span><span class="p">:</span><span class="w"> </span><span class="l">v0.9.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webservers.my.domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">my.domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">names</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">WebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listKind</span><span class="p">:</span><span class="w"> </span><span class="l">WebServerList</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l">webservers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l">webserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l">Namespaced</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">versions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">openAPIV3Schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">WebServer is the Schema for the webservers API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;APIVersion defines the versioned schema of this representation
</span></span></span><span class="line"><span class="cl"><span class="s1">              of an object. Servers should convert recognized schemas to the latest
</span></span></span><span class="line"><span class="cl"><span class="s1">              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">kind</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Kind is a string value representing the REST resource this
</span></span></span><span class="line"><span class="cl"><span class="s1">              object represents. Servers may infer this from the endpoint the client
</span></span></span><span class="line"><span class="cl"><span class="s1">              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">WebServerSpec defines the desired state of WebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">properties</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">foo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Foo is an example field of WebServer. Edit webserver_types.go</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="l">to remove/update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">The container image of the webserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">string</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">replicas</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">The number of replicas that the webserver should have</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">integer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">WebServerStatus defines the observed state of WebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">object</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">subresources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Once the CRD is defined, we can install it into k8s.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$make</span> install
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen rbac:roleName<span class="o">=</span>manager-role crd webhook <span class="nv">paths</span><span class="o">=</span><span class="s2">&#34;./...&#34;</span> output:crd:artifacts:config<span class="o">=</span>config/crd/bases
</span></span><span class="line"><span class="cl"><span class="nb">test</span> -s /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/kustomize <span class="o">||</span> <span class="o">{</span> curl -s <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh&#34;</span> <span class="p">|</span> bash -s -- 3.8.7 /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>Version:kustomize/v3.8.7 GitCommit:ad092cc7a91c07fdf63a2e4b7f13fa588a39af4f BuildDate:2020-11-11T23:14:14Z GoOs:linux GoArch:amd64<span class="o">}</span>
</span></span><span class="line"><span class="cl">kustomize installed to /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/kustomize
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/kustomize build config/crd <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/webservers.my.domain created
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check the installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> get crd<span class="p">|</span>grep webservers
</span></span><span class="line"><span class="cl">webservers.my.domain                                             2022-08-06T21:55:45Z
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="6-modify-roleyaml">6. Modify role.yaml</h3>
<p>Before we start the controller development, let&rsquo;s &ldquo;pave the way&rdquo; for the subsequent operation of the controller, i.e., set the appropriate permissions.</p>
<p>We will create the corresponding deployments and services for the CRD instance in the controller, which requires the controller to have the permission to operate the deployments and services, so we need to modify role.yaml to add service account: controller-manager to manipulate deployments and services.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">// config/rbac/role.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">manager-role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">my.domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">webservers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">create</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">delete</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">patch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">my.domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">webservers/finalizers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">my.domain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">webservers/status</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">patch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">apps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">deployments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">create</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">delete</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">patch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">apps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">services</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">create</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">delete</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">patch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The modified role.yaml will be placed here first and then deployed to k8s together with the controller.</p>
<h3 id="7-implementing-the-controllers-reconcile-coordination-logic">7. Implementing the controller&rsquo;s Reconcile (coordination) logic</h3>
<p>kubebuilder builds the code framework of the controller for us, we just need to implement the Reconcile method of WebServerReconciler in controllers/webserver_controller.go. Here is a simple flowchart of Reconcile, it is much easier to understand the code with this diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/08/16/f2d322555ded44dd97df6ce1ecc66033.png" alt="kubebuilder builds the code framework of the controller for us"></p>
<p>The following is the code for the corresponding Reconcile method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// controllers/webserver_controller.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">WebServerReconciler</span><span class="p">)</span> <span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">WithValues</span><span class="p">(</span><span class="s">&#34;Webserver&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">instance</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">mydomainv1</span><span class="p">.</span><span class="nx">WebServer</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Request object not found, could have been deleted after reconcile request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Return and don&#39;t requeue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Webserver resource not found. Ignoring since object must be deleted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Error reading the object - requeue the request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to get Webserver&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if the webserver deployment already exists, if not, create a new one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">found</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">},</span> <span class="nx">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Define a new deployment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">dep</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">deploymentForWebserver</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Creating a new Deployment&#34;</span><span class="p">,</span> <span class="s">&#34;Deployment.Namespace&#34;</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Deployment.Name&#34;</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">dep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to create new Deployment&#34;</span><span class="p">,</span> <span class="s">&#34;Deployment.Namespace&#34;</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Deployment.Name&#34;</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Deployment created successfully - return and requeue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to get Deployment&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ensure the deployment replicas and image are the same as the spec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">replicas</span> <span class="kt">int32</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">image</span> <span class="o">:=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Image</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">needUpd</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">*</span><span class="nx">found</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span> <span class="o">!=</span> <span class="nx">replicas</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Deployment spec.replicas change&#34;</span><span class="p">,</span> <span class="s">&#34;from&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">found</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">,</span> <span class="s">&#34;to&#34;</span><span class="p">,</span> <span class="nx">replicas</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">found</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">replicas</span>
</span></span><span class="line"><span class="cl">        <span class="nx">needUpd</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="nx">found</span><span class="p">).</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Template</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Image</span> <span class="o">!=</span> <span class="nx">image</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Deployment spec.template.spec.container[0].image change&#34;</span><span class="p">,</span> <span class="s">&#34;from&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">found</span><span class="p">).</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Template</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Image</span><span class="p">,</span> <span class="s">&#34;to&#34;</span><span class="p">,</span> <span class="nx">image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">found</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Template</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Image</span> <span class="p">=</span> <span class="nx">image</span>
</span></span><span class="line"><span class="cl">        <span class="nx">needUpd</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">needUpd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to update Deployment&#34;</span><span class="p">,</span> <span class="s">&#34;Deployment.Namespace&#34;</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Deployment.Name&#34;</span><span class="p">,</span> <span class="nx">found</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Spec updated - return and requeue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if the webserver service already exists, if not, create a new one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">foundService</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Service</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s">&#34;-service&#34;</span><span class="p">,</span> <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">},</span> <span class="nx">foundService</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Define a new service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">srv</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">serviceForWebserver</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Creating a new Service&#34;</span><span class="p">,</span> <span class="s">&#34;Service.Namespace&#34;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Service.Name&#34;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to create new Servie&#34;</span><span class="p">,</span> <span class="s">&#34;Service.Namespace&#34;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="s">&#34;Service.Name&#34;</span><span class="p">,</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Service created successfully - return and requeue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">Requeue</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to get Service&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Tbd: Ensure the service state is the same as the spec, your homework
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// reconcile webserver operator in again 10 seconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{</span><span class="nx">RequeueAfter</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">10</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here you may find: The original CRD controller eventually translates CR into k8s native Resource, such as service, deployment, etc. The state changes of CR (such as here replicas, images, etc.) are eventually converted into a native resource such as deployment. This is the essence of operator! Understanding this layer, operator is no longer an inaccessible concept for everyone.</p>
<p>Some people may also find that the above flowchart does not seem to consider the operation of deployment and service when the CR instance is deleted, which is true. But for a 7×24 service running in the background, we are more concerned about its changes, scaling, upgrades and other operations, deletion is the lowest priority requirements.</p>
<h3 id="8-building-the-controller-image">8. Building the controller image</h3>
<p>After the controller code is written, we will build the controller image, which we know from the previous article is actually a pod running in k8s under deployment.</p>
<p>We need to build its image and deploy it to k8s via deployment.</p>
<p>The operator project created by kubebuilder contains the Makefile, and the controller image can be built by make docker-build. docker-build uses the golang builder image to build the controller source code, but if you don&rsquo;t modify the Docker-build uses the golang builder image to build the controller source code, but without a slight modification to the Dockerfile, you will have a hard time compiling over it, because the default GOPROXY is not accessible in China. The easiest way to modify here is to use vendor build, and here is the modified Dockerfile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="c"># Build the manager binary</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> golang:1.18 as builder</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> GOPROXY https://goproxy.cn<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /workspace</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Copy the Go Modules manifests</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.mod go.mod<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.sum go.sum<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> vendor/ vendor/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># cache deps before building and copying source so that we don&#39;t need to re-download as much</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># and so that source changes don&#39;t invalidate our downloaded layer</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">#RUN go mod download</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Copy the go source</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> main.go main.go<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> api/ api/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> controllers/ controllers/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Build</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -mod<span class="o">=</span>vendor -a -o manager main.go<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Use distroless as minimal base image to package the manager binary</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Refer to https://github.com/GoogleContainerTools/distroless for more details</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">#FROM gcr.io/distroless/static:nonroot</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> katanomi/distroless-static:nonroot</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /workspace/manager .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">USER</span><span class="s"> 65532:65532</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;/manager&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The following are the steps of the build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$go</span> mod vendor
</span></span><span class="line"><span class="cl"><span class="nv">$make</span> docker-build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">test</span> -s /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen <span class="o">||</span> <span class="nv">GOBIN</span><span class="o">=</span>/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.9.2
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen rbac:roleName<span class="o">=</span>manager-role crd webhook <span class="nv">paths</span><span class="o">=</span><span class="s2">&#34;./...&#34;</span> output:crd:artifacts:config<span class="o">=</span>config/crd/bases
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen object:headerFile<span class="o">=</span><span class="s2">&#34;hack/boilerplate.go.txt&#34;</span> <span class="nv">paths</span><span class="o">=</span><span class="s2">&#34;./...&#34;</span>
</span></span><span class="line"><span class="cl">go fmt ./...
</span></span><span class="line"><span class="cl">go vet ./...
</span></span><span class="line"><span class="cl"><span class="nv">KUBEBUILDER_ASSETS</span><span class="o">=</span><span class="s2">&#34;/home/tonybai/.local/share/kubebuilder-envtest/k8s/1.24.2-linux-amd64&#34;</span> go <span class="nb">test</span> ./... -coverprofile cover.out
</span></span><span class="line"><span class="cl">?       github.com/bigwhite/webserver-operator    <span class="o">[</span>no <span class="nb">test</span> files<span class="o">]</span>
</span></span><span class="line"><span class="cl">?       github.com/bigwhite/webserver-operator/api/v1    <span class="o">[</span>no <span class="nb">test</span> files<span class="o">]</span>
</span></span><span class="line"><span class="cl">ok      github.com/bigwhite/webserver-operator/controllers    4.530s    coverage: 0.0% of statements
</span></span><span class="line"><span class="cl">docker build -t bigwhite/webserver-controller:latest .
</span></span><span class="line"><span class="cl">Sending build context to Docker daemon  47.51MB
</span></span><span class="line"><span class="cl">Step 1/15 : FROM golang:1.18 as builder
</span></span><span class="line"><span class="cl"> ---&gt; 2d952adaec1e
</span></span><span class="line"><span class="cl">Step 2/15 : ENV GOPROXY https://goproxy.cn
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; db2b06a078e3
</span></span><span class="line"><span class="cl">Step 3/15 : WORKDIR /workspace
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; cc3c613c19c6
</span></span><span class="line"><span class="cl">Step 4/15 : COPY go.mod go.mod
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; 5fa5c0d89350
</span></span><span class="line"><span class="cl">Step 5/15 : COPY go.sum go.sum
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; 71669cd0fe8e
</span></span><span class="line"><span class="cl">Step 6/15 : COPY vendor/ vendor/
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; 502b280a0e67
</span></span><span class="line"><span class="cl">Step 7/15 : COPY main.go main.go
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; 0c59a69091bb
</span></span><span class="line"><span class="cl">Step 8/15 : COPY api/ api/
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; 2b81131c681f
</span></span><span class="line"><span class="cl">Step 9/15 : COPY controllers/ controllers/
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; e3fd48c88ccb
</span></span><span class="line"><span class="cl">Step 10/15 : RUN <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -mod<span class="o">=</span>vendor -a -o manager main.go
</span></span><span class="line"><span class="cl"> ---&gt; Using cache
</span></span><span class="line"><span class="cl"> ---&gt; 548ac10321a2
</span></span><span class="line"><span class="cl">Step 11/15 : FROM katanomi/distroless-static:nonroot
</span></span><span class="line"><span class="cl"> ---&gt; 421f180b71d8
</span></span><span class="line"><span class="cl">Step 12/15 : WORKDIR /
</span></span><span class="line"><span class="cl"> ---&gt; Running in ea7cb03027c0
</span></span><span class="line"><span class="cl">Removing intermediate container ea7cb03027c0
</span></span><span class="line"><span class="cl"> ---&gt; 9d3c0ea19c3b
</span></span><span class="line"><span class="cl">Step 13/15 : COPY --from<span class="o">=</span>builder /workspace/manager .
</span></span><span class="line"><span class="cl"> ---&gt; a4387fe33ab7
</span></span><span class="line"><span class="cl">Step 14/15 : USER 65532:65532
</span></span><span class="line"><span class="cl"> ---&gt; Running in 739a32d251b6
</span></span><span class="line"><span class="cl">Removing intermediate container 739a32d251b6
</span></span><span class="line"><span class="cl"> ---&gt; 52ae8742f9c5
</span></span><span class="line"><span class="cl">Step 15/15 : ENTRYPOINT <span class="o">[</span><span class="s2">&#34;/manager&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"> ---&gt; Running in 897893b0c9df
</span></span><span class="line"><span class="cl">Removing intermediate container 897893b0c9df
</span></span><span class="line"><span class="cl"> ---&gt; e375cc2adb08
</span></span><span class="line"><span class="cl">Successfully built e375cc2adb08
</span></span><span class="line"><span class="cl">Successfully tagged bigwhite/webserver-controller:latest
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: Before executing the make command, change the initial value of the IMG variable in the Makefile to IMG ? = bigwhite/webserver-controller:latest</p>
</blockquote>
<p>After a successful build, execute make docker-push to push the image to the image repository (the public repository provided by docker is used here).</p>
<h3 id="9-deploying-the-controller">9. Deploying the controller</h3>
<p>We have already installed the CRD into k8s by make install, next we deploy the controller to k8s and our operator is deployed. Execute make deploy to achieve deployment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$make</span> deploy
</span></span><span class="line"><span class="cl"><span class="nb">test</span> -s /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen <span class="o">||</span> <span class="nv">GOBIN</span><span class="o">=</span>/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.9.2
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/controller-gen rbac:roleName<span class="o">=</span>manager-role crd webhook <span class="nv">paths</span><span class="o">=</span><span class="s2">&#34;./...&#34;</span> output:crd:artifacts:config<span class="o">=</span>config/crd/bases
</span></span><span class="line"><span class="cl"><span class="nb">test</span> -s /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/kustomize <span class="o">||</span> <span class="o">{</span> curl -s <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh&#34;</span> <span class="p">|</span> bash -s -- 3.8.7 /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> config/manager <span class="o">&amp;&amp;</span> /home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/kustomize edit <span class="nb">set</span> image <span class="nv">controller</span><span class="o">=</span>bigwhite/webserver-controller:latest
</span></span><span class="line"><span class="cl">/home/tonybai/test/go/operator/kubebuilder/webserver-operator/bin/kustomize build config/default <span class="p">|</span> kubectl apply -f -
</span></span><span class="line"><span class="cl">namespace/webserver-operator-system created
</span></span><span class="line"><span class="cl">customresourcedefinition.apiextensions.k8s.io/webservers.my.domain unchanged
</span></span><span class="line"><span class="cl">serviceaccount/webserver-operator-controller-manager created
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/webserver-operator-leader-election-role created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/webserver-operator-manager-role created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/webserver-operator-metrics-reader created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/webserver-operator-proxy-role created
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/webserver-operator-leader-election-rolebinding created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/webserver-operator-manager-rolebinding created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/webserver-operator-proxy-rolebinding created
</span></span><span class="line"><span class="cl">configmap/webserver-operator-manager-config created
</span></span><span class="line"><span class="cl">service/webserver-operator-controller-manager-metrics-service created
</span></span><span class="line"><span class="cl">deployment.apps/webserver-operator-controller-manager created
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see that deploy not only installs controller, serviceaccount, role, rolebinding, it also creates namespace and also installs crd all over again. In other words, deploy is a complete operator installation command.</p>
<blockquote>
<p>Note: Use make undeploy to completely uninstall operator-related resources.</p>
</blockquote>
<p>We use kubectl logs to view the controller&rsquo;s operational logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> logs -f deployment.apps/webserver-operator-controller-manager -n webserver-operator-system
</span></span><span class="line"><span class="cl">1.6600280818476188e+09    INFO    controller-runtime.metrics    Metrics server is starting to listen    <span class="o">{</span><span class="s2">&#34;addr&#34;</span>: <span class="s2">&#34;127.0.0.1:8080&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">1.6600280818478029e+09    INFO    setup    starting manager
</span></span><span class="line"><span class="cl">1.6600280818480284e+09    INFO    Starting server    <span class="o">{</span><span class="s2">&#34;path&#34;</span>: <span class="s2">&#34;/metrics&#34;</span>, <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;metrics&#34;</span>, <span class="s2">&#34;addr&#34;</span>: <span class="s2">&#34;127.0.0.1:8080&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">1.660028081848097e+09    INFO    Starting server    <span class="o">{</span><span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;health probe&#34;</span>, <span class="s2">&#34;addr&#34;</span>: <span class="s2">&#34;[::]:8081&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">I0809 06:54:41.848093       <span class="m">1</span> leaderelection.go:248<span class="o">]</span> attempting to acquire leader lease webserver-operator-system/63e5a746.my.domain...
</span></span><span class="line"><span class="cl">I0809 06:54:57.072336       <span class="m">1</span> leaderelection.go:258<span class="o">]</span> successfully acquired lease webserver-operator-system/63e5a746.my.domain
</span></span><span class="line"><span class="cl">1.6600280970724037e+09    DEBUG    events    Normal    <span class="o">{</span><span class="s2">&#34;object&#34;</span>: <span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Lease&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;webserver-operator-system&#34;</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;63e5a746.my.domain&#34;</span>,<span class="s2">&#34;uid&#34;</span>:<span class="s2">&#34;e05aaeb5-4a3a-4272-b036-80d61f0b6788&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;coordination.k8s.io/v1&#34;</span>,<span class="s2">&#34;resourceVersion&#34;</span>:<span class="s2">&#34;5238800&#34;</span><span class="o">}</span>, <span class="s2">&#34;reason&#34;</span>: <span class="s2">&#34;LeaderElection&#34;</span>, <span class="s2">&#34;message&#34;</span>: <span class="s2">&#34;webserver-operator-controller-manager-6f45bc88f7-ptxlc_0e960015-9fbe-466d-a6b1-ff31af63a797 became leader&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">1.6600280970724993e+09    INFO    Starting EventSource    <span class="o">{</span><span class="s2">&#34;controller&#34;</span>: <span class="s2">&#34;webserver&#34;</span>, <span class="s2">&#34;controllerGroup&#34;</span>: <span class="s2">&#34;my.domain&#34;</span>, <span class="s2">&#34;controllerKind&#34;</span>: <span class="s2">&#34;WebServer&#34;</span>, <span class="s2">&#34;source&#34;</span>: <span class="s2">&#34;kind source: *v1.WebServer&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">1.6600280970725305e+09    INFO    Starting Controller    <span class="o">{</span><span class="s2">&#34;controller&#34;</span>: <span class="s2">&#34;webserver&#34;</span>, <span class="s2">&#34;controllerGroup&#34;</span>: <span class="s2">&#34;my.domain&#34;</span>, <span class="s2">&#34;controllerKind&#34;</span>: <span class="s2">&#34;WebServer&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">1.660028097173026e+09    INFO    Starting workers    <span class="o">{</span><span class="s2">&#34;controller&#34;</span>: <span class="s2">&#34;webserver&#34;</span>, <span class="s2">&#34;controllerGroup&#34;</span>: <span class="s2">&#34;my.domain&#34;</span>, <span class="s2">&#34;controllerKind&#34;</span>: <span class="s2">&#34;WebServer&#34;</span>, <span class="s2">&#34;worker count&#34;</span>: 1<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the controller has been successfully started and is waiting for a WebServer CR related event (e.g. creation). Let&rsquo;s create a WebServer CR!</p>
<h3 id="10-creating-the-webserver-cr">10. Creating the WebServer CR</h3>
<p>There is a CR sample in the webserver-operator project, located under config/samples, which we modify to add the fields we added in the spec.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">// config/samples/_v1_webserver.yaml </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">my.domain/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">WebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webserver-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># TODO(user): Add fields here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.23.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We create this WebServer CR via kubectl.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$cd</span> config/samples
</span></span><span class="line"><span class="cl"><span class="nv">$kubectl</span> apply -f _v1_webserver.yaml
</span></span><span class="line"><span class="cl">webserver.my.domain/webserver-sample created
</span></span></code></pre></td></tr></table>
</div>
</div><p>Observe the controller&rsquo;s log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1.6602084232243123e+09  INFO    controllers.WebServer   Creating a new Deployment   <span class="o">{</span><span class="s2">&#34;Webserver&#34;</span>: <span class="s2">&#34;default/webserver-sample&#34;</span>, <span class="s2">&#34;Deployment.Namespace&#34;</span>: <span class="s2">&#34;default&#34;</span>, <span class="s2">&#34;Deployment.Name&#34;</span>: <span class="s2">&#34;webserver-sample&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">1.6602084233446114e+09  INFO    controllers.WebServer   Creating a new Service  <span class="o">{</span><span class="s2">&#34;Webserver&#34;</span>: <span class="s2">&#34;default/webserver-sample&#34;</span>, <span class="s2">&#34;Service.Namespace&#34;</span>: <span class="s2">&#34;default&#34;</span>, <span class="s2">&#34;Service.Name&#34;</span>: <span class="s2">&#34;webserver-sample-service&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see that when the CR is created, the controller listens to the relevant events and creates the corresponding Deployment and service, so let&rsquo;s take a look at the Deployment, the three Pods and the service created for the CR.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> get service
</span></span><span class="line"><span class="cl">NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">kubernetes                 ClusterIP   172.26.0.1     &lt;none&gt;        443/TCP        22d
</span></span><span class="line"><span class="cl">webserver-sample-service   NodePort    172.26.173.0   &lt;none&gt;        80:30010/TCP   2m58s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$kubectl</span> get deployment
</span></span><span class="line"><span class="cl">NAME               READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">webserver-sample   3/3     <span class="m">3</span>            <span class="m">3</span>           4m44s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$kubectl</span> get pods
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-8gq2h   1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-vk6gw   1/1     Running   <span class="m">0</span>          4m52s
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-xgrgb   1/1     Running   <span class="m">0</span>          4m52s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s request the service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$curl</span> http://192.168.10.182:30010
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The service returns a response as expected!</p>
<h3 id="11-scaling-changing-versions-and-service-self-healing">11. Scaling, Changing Versions, and Service Self-Healing</h3>
<p>Next, let&rsquo;s do some common O&amp;M operations on CR.</p>
<ul>
<li>
<p>Number of copies changed from 3 to 4</p>
<p>We change the replicas of CR from 3 to 4 and do an extension operation on the container instance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">// config/samples/_v1_webserver.yaml </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">my.domain/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">WebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">webserver-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># TODO(user): Add fields here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.23.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then make it effective by kubectl apply.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> apply -f _v1_webserver.yaml
</span></span><span class="line"><span class="cl">webserver.my.domain/webserver-sample configured
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the above command is executed, we observe the controller log of operator as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1.660208962767797e+09   INFO    controllers.WebServer   Deployment spec.replicas change <span class="o">{</span><span class="s2">&#34;Webserver&#34;</span>: <span class="s2">&#34;default/webserver-sample&#34;</span>, <span class="s2">&#34;from&#34;</span>: 3, <span class="s2">&#34;to&#34;</span>: 4<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Later, check the number of pods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> get pods
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-8gq2h   1/1     Running   <span class="m">0</span>          9m41s
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-v9gvg   1/1     Running   <span class="m">0</span>          42s
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-vk6gw   1/1     Running   <span class="m">0</span>          9m41s
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-xgrgb   1/1     Running   <span class="m">0</span>          9m41s
</span></span></code></pre></td></tr></table>
</div>
</div><p>The number of webserver pod copies was successfully expanded from 3 to 4.</p>
</li>
<li>
<p>Changing the webserver image version</p>
<p>We change the version of the CR image from nginx:1.23.1 to nginx:1.23.0 and then execute kubectl apply to make it work.</p>
<p>We check the response log of the controller as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">1.6602090494113188e+09  INFO    controllers.WebServer   Deployment spec.template.spec.container[0].image change {&#34;Webserver&#34;: &#34;default/webserver-sample&#34;, &#34;from&#34;: &#34;nginx:1.23.1&#34;, &#34;to&#34;: &#34;nginx:1.23.0&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The controller updates the deployment, causing a rolling upgrade of the pods under its jurisdiction.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> get pods
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-8gq2h   1/1     Running             <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-vk6gw   1/1     Running             <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">webserver-sample-bc698b9fb-xgrgb   1/1     Running             <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">webserver-sample-ffcf549ff-g6whk   0/1     ContainerCreating   <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">webserver-sample-ffcf549ff-ngjz6   0/1     ContainerCreating   <span class="m">0</span>          12s
</span></span></code></pre></td></tr></table>
</div>
</div><p>After waiting patiently for a short while, the final pod list is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> get pods
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">webserver-sample-ffcf549ff-g6whk   1/1     Running   <span class="m">0</span>          6m22s
</span></span><span class="line"><span class="cl">webserver-sample-ffcf549ff-m6z24   1/1     Running   <span class="m">0</span>          3m12s
</span></span><span class="line"><span class="cl">webserver-sample-ffcf549ff-ngjz6   1/1     Running   <span class="m">0</span>          6m22s
</span></span><span class="line"><span class="cl">webserver-sample-ffcf549ff-t7gvc   1/1     Running   <span class="m">0</span>          4m16s
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>service self-healing: restore the service that was undeleted</p>
<p>Let&rsquo;s do a &ldquo;mistake&rdquo; and remove the webserver-sample-service to see if the controller can help the service heal itself.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$kubectl</span> delete service/webserver-sample-service
</span></span><span class="line"><span class="cl">service <span class="s2">&#34;webserver-sample-service&#34;</span> deleted
</span></span></code></pre></td></tr></table>
</div>
</div><p>View controller logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1.6602096994710526e+09  INFO    controllers.WebServer   Creating a new Service  <span class="o">{</span><span class="s2">&#34;Webserver&#34;</span>: <span class="s2">&#34;default/webserver-sample&#34;</span>, <span class="s2">&#34;Service.Namespace&#34;</span>: <span class="s2">&#34;default&#34;</span>, <span class="s2">&#34;Service.Name&#34;</span>: <span class="s2">&#34;webserver-sample-service&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see that the controller detected the status of the service being deleted and rebuilt a new service!</p>
<p>Request the newly created service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://192.168.10.182:30010
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;Welcome to nginx!&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;style&gt;
</span></span><span class="line"><span class="cl">html <span class="o">{</span> color-scheme: light dark<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">body <span class="o">{</span> width: 35em<span class="p">;</span> margin: <span class="m">0</span> auto<span class="p">;</span>
</span></span><span class="line"><span class="cl">font-family: Tahoma, Verdana, Arial, sans-serif<span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/style&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;For online documentation and support please refer to
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl">&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;p&gt;&lt;em&gt;Thank you <span class="k">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the service has finished healing itself with the help of the controller!</p>
</li>
</ul>
<h2 id="5-summary">5. Summary</h2>
<p>In this article, we have introduced the concept and advantages of Kubernetes Operator, and developed a level 2 operator based on kubebuilder, which is still a long way from perfection.</p>
<p>I believe that after reading this article, you will have a clear understanding of the operator, especially its basic structure, and will be able to develop a simple operator!</p>
<p>The source code for this article can be downloaded from <a href="https://github.com/bigwhite/experiments/tree/master/webserver-operator">here</a>.</p>
<h2 id="6-reference">6. Reference</h2>
<ul>
<li><a href="https://tonybai.com/2022/08/15/developing-kubernetes-operators-in-go-part1/">https://tonybai.com/2022/08/15/developing-kubernetes-operators-in-go-part1/</a></li>
<li><a href="https://developers.redhat.com/articles/2021/06/11/kubernetes-operators-101-part-1-overview-and-key-features">kubernetes operator 101, Part 1: Overview and key features</a></li>
<li><a href="https://developers.redhat.com/articles/2021/06/22/kubernetes-operators-101-part-2-how-operators-work">Kubernetes Operators 101, Part 2: How operators work</a></li>
<li><a href="https://developers.redhat.com/blog/2020/04/28/operator-sdk-build-kubernetes-operators-and-deploy-them-on-openshift">Operator SDK: Build Kubernetes Operators</a></li>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">kubernetes doc: Custom Resources</a></li>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/">kubernetes doc: Operator pattern</a></li>
<li><a href="https://kubernetes.io/docs/reference/using-api/api-concepts/">kubernetes doc: API concepts</a></li>
<li><a href="https://web.archive.org/web/20170129131616/https://coreos.com/blog/introducing-operators.html">Introducing Operators: Putting Operational Knowledge into Software</a></li>
<li><a href="https://github.com/cncf/tag-app-delivery/blob/main/operator-whitepaper/v1/Operator-WhitePaper_v1-0.md">CNCF Operator White Paper v1.0</a></li>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/best-practices-for-building-kubernetes-operators-and-stateful-apps">Best practices for building Kubernetes Operators and stateful apps</a></li>
<li><a href="https://docs.bitnami.com/tutorials/a-deep-dive-into-kubernetes-controllers">A deep dive into Kubernetes controllers</a></li>
<li><a href="https://blog.container-solutions.com/kubernetes-operators-explained">Kubernetes Operators Explained</a></li>
<li><a href="https://book.douban.com/subject/34796009/">Books: Kubernetes Operator</a></li>
<li><a href="https://book.douban.com/subject/35498478/">Books: Programming Kubernetes</a></li>
<li><a href="https://cloud.redhat.com/blog/operator-sdk-reaches-v1.0">Operator SDK Reaches v1.0</a></li>
<li><a href="https://github.com/operator-framework/operator-sdk/issues/1758">What is the difference between kubebuilder and operator-sdk</a></li>
<li><a href="https://www.infoq.com/articles/kubernetes-operators-in-depth/">Kubernetes Operators in Depth</a></li>
<li><a href="https://developer.ibm.com/learningpaths/kubernetes-operators/">Get started using Kubernetes Operators</a></li>
<li><a href="https://developer.ibm.com/learningpaths/kubernetes-operators/operators-extend-kubernetes/">Use Kubernetes operators to extend Kubernetes&rsquo; functionality</a></li>
<li><a href="https://github.com/operator-framework/operator-sdk-samples/tree/master/go/memcached-operator">memcached operator</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-08/cpp-std-uniform-int-distribution/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Talk about the principle and optimization of std::uniform_int_distribution</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-08/linux-virtual-memory/">
            <span class="next-text nav-default">Virtual memory in Linux systems</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
