<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Golang&#39;s memory allocation - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn Golang&#39;s memory allocation algorithm and the detailed allocation process." /><meta name="keywords" content="golang, Memory Allocation" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/golang-memory-allocation/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Golang&#39;s memory allocation" />
<meta property="og:description" content="Learn Golang&#39;s memory allocation algorithm and the detailed allocation process." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/golang-memory-allocation/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-02T10:30:56+08:00" />
<meta property="article:modified_time" content="2022-04-02T10:30:56+08:00" />

<meta itemprop="name" content="Golang&#39;s memory allocation">
<meta itemprop="description" content="Learn Golang&#39;s memory allocation algorithm and the detailed allocation process."><meta itemprop="datePublished" content="2022-04-02T10:30:56+08:00" />
<meta itemprop="dateModified" content="2022-04-02T10:30:56+08:00" />
<meta itemprop="wordCount" content="2638">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang&#39;s memory allocation"/>
<meta name="twitter:description" content="Learn Golang&#39;s memory allocation algorithm and the detailed allocation process."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Golang&#39;s memory allocation</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-02 10:30:56 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2638 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#basic-concepts">Basic Concepts</a></li>
        <li><a href="#memory-management-unit">Memory management unit</a></li>
        <li><a href="#memory-management-components">Memory Management Components</a></li>
        <li><a href="#mcache">mcache</a></li>
        <li><a href="#mcentral">mcentral</a></li>
        <li><a href="#mheap">mheap</a></li>
        <li><a href="#allocation-process">Allocation process</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The Go language has a built-in runtime (that is, runtime) that abandons the traditional way of allocating memory in favor of autonomous management. This allows for autonomous implementation of better memory usage patterns, such as memory pooling, pre-allocation, etc. This way, you don&rsquo;t need to make a system call for every memory allocation.</p>
<p>The Golang runtime memory allocation algorithm is derived from Google&rsquo;s TCMalloc algorithm for C. The core idea is to reduce the granularity of locks by dividing memory into multiple levels of management. It manages the available heap memory in a two-level allocation: each thread maintains a separate memory pool of its own and allocates memory from that pool first, and only applies to the global memory pool when the pool is insufficient to avoid frequent competition between different threads for the global memory pool.</p>
<h2 id="basic-concepts">Basic Concepts</h2>
<p>When Go starts a program, it first requests a block of memory from the operating system (note that this is still just a virtual address space and does not actually allocate memory), cuts it into small chunks and then manages it itself.</p>
<p>The requested memory block is allocated three areas, 512MB, 16GB, and 512GB in size on the X64.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/b0d27cd3a00e41358abdae0b3a6b6833.png" alt="memory areas"></p>
<p>The <code>arena</code> is what we call the heap area. Go dynamically allocates memory in this area, which divides the memory into <code>8KB</code> sized pages, some of which are combined and called <code>mspan</code>.</p>
<p>The <code>bitmap area</code> identifies which addresses in the <code>arena</code> area hold objects, and uses the <code>4bit</code> flag bit to indicate whether the object contains pointer, <code>GC</code> tag information. One <code>byte</code> size of memory in <code>bitmap</code> corresponds to 4 pointer size (8B pointer size) of memory in the <code>arena</code> area, so the size of <code>bitmap</code> area is <code>512GB/(4*8B)=16GB</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/45680ea227144012acaccb33270257d8.png" alt="bitmap area"></p>
<p>From the above figure, you can actually see that the high address part of the bitmap points to the low address part of the arena area, which means that the address of the bitmap grows from the high address to the low address.</p>
<p>The <code>spans area</code> holds the pointers to the <code>mspan</code> (that is, the basic unit of memory management combined with some pages of the <code>arena</code> partition, which will be discussed later), and each pointer corresponds to a page, so the size of the <code>spans</code> area is <code>512GB/8KB*8B=512MB</code>. Dividing by 8KB is to calculate the number of pages in the <code>arena</code> area, and multiplying by 8 is to calculate the size of all the pointers in the <code>spans</code> area. When creating an <code>mspan</code>, the corresponding <code>spans</code> area is filled by page, and when recycling the <code>object</code>, the <code>mspan</code> it belongs to can be easily found based on its address.</p>
<h2 id="memory-management-unit">Memory management unit</h2>
<p><code>mspan</code>: The basic memory management unit in Go, a large block of memory consisting of a contiguous <code>8KB</code> page. Note that a page here is not the same thing as an OS page, which is typically several times the size of an OS page. In a nutshell: <code>mspan</code> is a Doubly linked list containing the starting address, the <code>mspan</code> specification, the number of pages, etc.</p>
<p>Each <code>mspan</code> is divided into several <code>objects</code> according to the size of its own property <code>Size Class</code>, and each <code>object</code> can store one object. A bitmap is used to mark the <code>objects</code> that are not yet used. The property <code>Size Class</code> determines the size of the <code>object</code>, and <code>mspan</code> will only be assigned to objects that are close to the size of the <code>object</code>, but, of course, smaller than the size of the <code>object</code>. There is another concept: <code>Span Class</code>, which has a similar meaning to <code>Size Class</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Size_Class</span> <span class="o">=</span> <span class="n">Span_Class</span> <span class="o">/</span> <span class="mi">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is because there are actually two <code>mspan</code>s per <code>Size Class</code>, which means there are two <code>Span Class</code>s. One of them is allocated to objects that contain pointers, and the other one is allocated to objects that do not contain pointers. This will bring benefits to the garbage collection mechanism, which will be discussed in a later article.</p>
<p>As shown below, <code>mspan</code> consists of a set of consecutive pages divided into <code>objects</code> of a certain size.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/706ad6e9711945fcb140e049cb936ee7.png" alt="mspan"></p>
<p>Go1.9.2 <code>mspan</code> of <code>Size Class</code> has 67 kinds, each <code>mspan</code> partitioned object size is a multiple of 8*2n, this is written dead in the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// path: /usr/local/go/src/runtime/sizeclasses.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">_NumSizeClasses</span> <span class="p">=</span> <span class="mi">67</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">class_to_size</span> <span class="p">=</span> <span class="p">[</span><span class="nx">_NumSizeClasses</span><span class="p">]</span><span class="kt">uint16</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">352</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span> <span class="mi">416</span><span class="p">,</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">704</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">896</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1152</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1408</span><span class="p">,</span> <span class="mi">1536</span><span class="p">,</span><span class="mi">1792</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">2304</span><span class="p">,</span> <span class="mi">2688</span><span class="p">,</span> <span class="mi">3072</span><span class="p">,</span> <span class="mi">3200</span><span class="p">,</span> <span class="mi">3456</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">4864</span><span class="p">,</span> <span class="mi">5376</span><span class="p">,</span> <span class="mi">6144</span><span class="p">,</span> <span class="mi">6528</span><span class="p">,</span> <span class="mi">6784</span><span class="p">,</span> <span class="mi">6912</span><span class="p">,</span> <span class="mi">8192</span><span class="p">,</span> <span class="mi">9472</span><span class="p">,</span> <span class="mi">9728</span><span class="p">,</span> <span class="mi">10240</span><span class="p">,</span> <span class="mi">10880</span><span class="p">,</span> <span class="mi">12288</span><span class="p">,</span> <span class="mi">13568</span><span class="p">,</span> <span class="mi">14336</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="mi">18432</span><span class="p">,</span> <span class="mi">19072</span><span class="p">,</span> <span class="mi">20480</span><span class="p">,</span> <span class="mi">21760</span><span class="p">,</span> <span class="mi">24576</span><span class="p">,</span> <span class="mi">27264</span><span class="p">,</span> <span class="mi">28672</span><span class="p">,</span> <span class="mi">32768</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>According to the <code>Size Class</code> of <code>mspan</code>, you can get the size of the <code>object</code> it divides. For example, if <code>Size Class</code> is equal to 3, <code>object</code> size is 32B. An object of size 32B can store objects in the size range of 17B to 32B. For tiny objects (less than 16B), the allocator will merge them and allocate several objects into the same <code>object</code>.</p>
<p>The maximum number in the array is 32768, that is, 32KB, more than this size is a large object, it will be treated specially, this will be introduced later. By the way, a type <code>Size Class</code> of 0 indicates a large object, which is actually allocated directly from heap memory, while small objects are allocated through <code>mspan</code>.</p>
<p>For mspan, its <code>Size Class</code> determines the number of pages it can be allocated, which is also written dead in the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// path: /usr/local/go/src/runtime/sizeclasses.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">_NumSizeClasses</span> <span class="p">=</span> <span class="mi">67</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">class_to_allocnpages</span> <span class="p">=</span> <span class="p">[</span><span class="nx">_NumSizeClasses</span><span class="p">]</span><span class="kt">uint8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For example, when we want to request a <code>mspan</code> of <code>object</code> size <code>32B</code>, the corresponding index in class_to_size is 3, and the index 3 corresponds to the number of pages in the <code>class_to_allocnpages</code> array is 1.</p>
<p><code>mspan</code> structure definition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// path: /usr/local/go/src/runtime/mheap.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">mspan</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//linked list 前向指针，用于将span链接起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next</span> <span class="o">*</span><span class="nx">mspan</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">//linked list 前向指针，用于将span链接起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">prev</span> <span class="o">*</span><span class="nx">mspan</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 起始地址，也即所管理页的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">startAddr</span> <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 管理的页数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">npages</span> <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 块个数，表示有多少个块可供分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nelems</span> <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//分配位图，每一位代表一个块是否已分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">allocBits</span> <span class="o">*</span><span class="nx">gcBits</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 已分配块的个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">allocCount</span> <span class="kt">uint16</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// class表中的class ID，和Size Classs相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">spanclass</span> <span class="nx">spanClass</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// class表中的对象大小，也即块大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elemsize</span> <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s put <code>mspan</code> into a larger perspective.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/1208c5a7bb274d1d8af4300a6d264305.png" alt="mspan"></p>
<p>The above figure shows that there are two <code>S</code>s pointing to the same <code>mspan</code>, because the <code>P</code> to which these two <code>S</code>s point belongs to the same <code>mspan</code>. So, the <code>S</code> pointing to it can be quickly found by the address on the <code>arena</code>, and the <code>mspan</code> can be found by the <code>S</code>, recalling what we said earlier about each pointer to the <code>mspan</code> area corresponding to a page.</p>
<p>Assuming that the <code>Size Class</code> of the first <code>mspan</code> on the far left is equal to 10, according to the <code>class_to_size</code> array, the <code>object</code> size of this <code>msapn</code> partition is 144B, and the number of objects that can be allocated is <code>8KB/144B=56.89</code>, rounded up to 56, so there will be some memory wasted. Go&rsquo;s source code has the size of all <code>mspan</code> wasted memory of <code>Size Class</code>; then according to the <code>class_to_allocnpages</code> array, we get this <code>mspan</code> consists of only 1 <code>page</code>; suppose this <code>mspan</code> is allocated to pointerless objects, then <code>spanClass</code> is equal to 20.</p>
<p><code>startAddr</code> points directly to a location in the <code>arena</code> region, indicating the starting address of this <code>mspan</code>, <code>allocBits</code> points to a bitmap, each representing whether a block has been allocated or not, and <code>allocCount</code> indicates the total number of objects allocated.</p>
<p>Thus, the parameters of each field of the first <code>mspan</code> from the left are as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/fdf566a7d0074909a23c7aa40dccba30.png" alt="mspan"></p>
<h2 id="memory-management-components">Memory Management Components</h2>
<p>Memory allocation is done by the memory allocator. The allocator consists of 3 components: <code>mcache</code> , <code>mcentral</code> , <code>mheap</code> .</p>
<h2 id="mcache">mcache</h2>
<p><code>mcache</code> : Each worker thread is bound to an mcache, which locally caches available <code>mspan</code> resources so that they can be allocated directly to Goroutines, as there is no competition from multiple Goroutines, so no lock resources are consumed.</p>
<p>Structure definition of <code>mcache</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//path: /usr/local/go/src/runtime/mcache.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">mcache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alloc</span> <span class="p">[</span><span class="nx">numSpanClasses</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">numSpanClasses</span> <span class="p">=</span> <span class="nx">_NumSizeClasses</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>mcache</code> uses <code>Span Classes</code> as an index to manage multiple <code>mspan</code> for allocation, and it contains all sizes of <code>mspan</code>. It is twice as large as <code>_NumSizeClasses</code>, which is <code>67*2=134</code>. Why there is a twofold relationship, as we mentioned earlier: to speed up memory reclamation afterwards, half of the objects allocated in <code>mspan</code> in the array do not contain pointers, and the other half contain pointers.</p>
<p>The <code>mspan</code> of a pointerless object is garbage collected without further scanning for references to other active objects. More on this in a later garbage collection article, but this time we&rsquo;ll stop here.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/15f3e764c0ee4f03bea4b1163a4c6ca4.png" alt="mspan"></p>
<p><code>mcache</code> is initialized without any <code>mspan</code> resources and is dynamically requested from <code>mcentral</code> during use and cached afterwards. When the object is less than or equal to 32KB in size, <code>mcache</code> is allocated using the corresponding size of <code>mspan</code>.</p>
<h2 id="mcentral">mcentral</h2>
<p><code>mcentral</code>: Provides a sliced <code>mspan</code> resource for all <code>mcache</code>. Each <code>central</code> holds a global <code>mspan</code> list of a specific size, both allocated and unallocated. Each <code>mcentral</code> corresponds to one type of <code>mspan</code>, and the type of <code>mspan</code> causes it to divide <code>object</code>s of different sizes. When there is no suitable (i.e., specific size) <code>mspan</code> in the worker thread&rsquo;s <code>mcache</code>, it is fetched from <code>mcentral</code>.</p>
<p><code>mcentral</code> is shared by all worker threads, and there is competition from multiple Goroutines, so it consumes lock resources. Structure definition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//path: /usr/local/go/src/runtime/mcentral.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">mcentral</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 互斥锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lock</span> <span class="nx">mutex</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 规格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sizeclass</span> <span class="kt">int32</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 尚有空闲object的mspan linked list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nonempty</span> <span class="nx">mSpanList</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 没有空闲object的mspan linked list，或者是已被mcache取走的msapn linked list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">empty</span> <span class="nx">mSpanList</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 已累计分配的对象个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmalloc</span> <span class="kt">uint64</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/ae7033545f074c05820347d585ef635b.png" alt="mcentral"></p>
<p><code>empty</code> means that all the <code>mspan</code> in this linked list are either allocated <code>object</code> or <code>mspan</code> that have already been taken by <code>cache</code>, and this <code>mspan</code> is exclusive to that worker thread. And <code>nonempty</code> indicates a list of <code>mspan</code>s that have free objects. Each <code>central</code> structure is maintained in <code>mheap</code>.</p>
<p>To briefly explain the flow of <code>mcache</code> fetching and returning <code>mspan</code> from <code>mcentral</code>.</p>
<ul>
<li>Get Locks; finds an available <code>mspan</code> from the <code>nonempty</code> linked list; removes it from the <code>nonempty</code> linked list; adds the retrieved <code>mspan</code> to the <code>empty</code> linked list; returns the <code>mspan</code> to the worker thread; unlocks it.</li>
<li>Return lock; remove <code>mspan</code> from the <code>empty</code> linked list; add <code>mspan</code> to the <code>nonempty</code> linked list; unlock.</li>
</ul>
<h2 id="mheap">mheap</h2>
<p><code>mheap</code>: Represents all the heap space held by the Go program, which uses a global object <code>_mheap</code> of <code>mheap</code> to manage heap memory.</p>
<p>When <code>mcentral</code> does not have a free <code>mspan</code>, it requests it from <code>mheap</code>. And when <code>mheap</code> runs out of resources, it requests new memory from the OS. <code>mheap</code> is mainly used for memory allocation for large objects and for managing uncut <code>mspan</code>, which is used to cut <code>mcentral</code> into smaller objects.</p>
<p>Also we see that <code>mheap</code> contains <code>mcentral</code> of all sizes, so when an <code>mcache</code> requests <code>mspan</code> from <code>mcentral</code>, it only needs to use a lock in the separate <code>mcentral</code> and does not affect requests for <code>mspan</code> of other sizes.</p>
<p><code>mheap</code> structure definition.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//path: /usr/local/go/src/runtime/mheap.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">mheap</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lock</span> <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// spans: 指向mspans区域，用于映射mspan和page的关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">spans</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mspan</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 指向bitmap首地址，bitmap是从高地址向低地址增长的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bitmap</span> <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 指示arena区首地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arena_start</span> <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 指示arena区已使用地址位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arena_used</span>  <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 指示arena区末地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arena_end</span>   <span class="kt">uintptr</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">central</span> <span class="p">[</span><span class="mi">67</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mcentral</span> <span class="nx">mcentral</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pad</span> <span class="p">[</span><span class="nx">sys</span><span class="p">.</span><span class="nx">CacheLineSize</span> <span class="o">-</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">mcentral</span><span class="p">{})</span><span class="o">%</span><span class="nx">sys</span><span class="p">.</span><span class="nx">CacheLineSize</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/02/52230a9a4e3f47ad9a593da2668593f8.png" alt="mheap"></p>
<p>Above we see that the bitmap and arena_start point to the same address. This is because the address of the bitmap grows from high to low, so they point to the same memory location.</p>
<h2 id="allocation-process">Allocation process</h2>
<p>Whether a variable is allocated on the stack or on the heap is determined by the result of the escape analysis. Usually, the compiler prefers to allocate variables on the stack because it has less overhead, and the most extreme is &ldquo;zero garbage&rdquo;, where all variables are allocated on the stack so that there is no memory fragmentation, garbage collection, or anything like that.</p>
<p>Go&rsquo;s memory allocator allocates objects in three categories based on their size: small objects (less than or equal to 16B), general objects (greater than 16B, less than or equal to 32KB), and large objects (greater than 32KB).</p>
<p>The general allocation process.</p>
<ul>
<li>32KB objects are allocated directly from the mheap.</li>
<li>&lt;=16B objects allocated using the tiny allocator of mcache.</li>
<li>objects of [16B,32KB], first calculate the specification size of the object, and then allocate it using the mspan of the corresponding specification size in the mcache.</li>
<li>If mcache does not have mspan of the corresponding specification size, apply to mcentral</li>
<li>If mcentral does not have an mspan of the corresponding specification size, apply to mheap</li>
<li>If there is no mspan of the appropriate size in mheap either, apply to the operating system</li>
</ul>
<h2 id="summary">Summary</h2>
<ul>
<li>Go requests a large chunk of memory from the operating system at program startup and manages it on its own afterwards.</li>
<li>The basic unit of Go memory management is the mspan, which consists of several pages, each mspan can allocate a specific size of object.</li>
<li>mcache, mcentral, and mheap are the three major components of Go memory management in a hierarchy. mcache manages the mspan that threads cache locally; mcentral manages the global mspan for use by all threads; and mheap manages all of Go&rsquo;s dynamically allocated memory.</li>
<li>Very small objects are allocated in an object to save resources and use tiny allocator to allocate memory; generally small objects are allocated memory by mspan; and large objects are allocated memory directly by mheap.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/go-channel-principle/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Principle of Go channel</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/golang-escape-analysis/">
            <span class="next-text nav-default">Golang Escape Analysis</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
