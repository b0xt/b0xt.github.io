<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>SSL Performance Testing for Nginx - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore SSL performance tests for Nginx." /><meta name="keywords" content="nginx, Ssl, Performance Testing" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/nginx-ssl-test/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="SSL Performance Testing for Nginx" />
<meta property="og:description" content="Explore SSL performance tests for Nginx." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/nginx-ssl-test/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-06T09:36:37+08:00" />
<meta property="article:modified_time" content="2022-04-06T09:36:37+08:00" />

<meta itemprop="name" content="SSL Performance Testing for Nginx">
<meta itemprop="description" content="Explore SSL performance tests for Nginx."><meta itemprop="datePublished" content="2022-04-06T09:36:37+08:00" />
<meta itemprop="dateModified" content="2022-04-06T09:36:37+08:00" />
<meta itemprop="wordCount" content="4601">
<meta itemprop="keywords" content="nginx," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SSL Performance Testing for Nginx"/>
<meta name="twitter:description" content="Explore SSL performance tests for Nginx."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">SSL Performance Testing for Nginx</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-06 09:36:37 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4601 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#performance-testing-methodology">Performance Testing Methodology</a>
          <ul>
            <li><a href="#proactive-testing">Proactive Testing</a></li>
            <li><a href="#example">Example</a></li>
            <li><a href="#some-suggestions">Some Suggestions</a></li>
          </ul>
        </li>
        <li><a href="#key-configuration-sorting">Key configuration sorting</a>
          <ul>
            <li><a href="#ssl-new-connection">SSL new connection</a></li>
            <li><a href="#throughput">Throughput</a></li>
            <li><a href="#maximum-concurrency">Maximum concurrency</a></li>
            <li><a href="#configuration-details">Configuration details</a></li>
            <li><a href="#nginx-configuration">Nginx Configuration</a></li>
            <li><a href="#kernel-parameters-and-network-configuration">Kernel parameters and network configuration</a></li>
            <li><a href="#nic-queuing-and-irq">NIC Queuing and irq</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Although the title says SSL performance testing, it doesn&rsquo;t really matter if it&rsquo;s SSL or not, it&rsquo;s just that the configuration of the test is different. We should focus more on the general principles of performance testing than on the testing methodology of a specific metric. The specific test metrics may vary with the test business and test environment, but the core test methodology is the same.</p>
<p>Since I am familiar with SSL performance testing, I will share the three main metrics of SSL performance testing: new connections per second, maximum throughput, and maximum number of connections.</p>
<h2 id="performance-testing-methodology">Performance Testing Methodology</h2>
<h3 id="proactive-testing">Proactive Testing</h3>
<p>This is at the top of the list because it is so important.</p>
<p>Proactive testing, as opposed to reactive testing. Most people do performance testing by running a command or script and then reading the results and that&rsquo;s it. This type of testing is typically reactive testing.</p>
<blockquote>
<p>Passive testing: You want to test A, but you actually test B and end up with the conclusion that you tested C.</p>
</blockquote>
<p>Passive testing often leads to all kinds of problems, drawing wrong conclusions based on wrong results, and then making wrong judgments and choices. What&rsquo;s worse is that the testers themselves don&rsquo;t realize it.</p>
<p>Proactive testing can help you test exactly what you really want and understand the results correctly. The little extra effort you put in at the beginning can save you much more time and even money later.</p>
<p>So what is considered active testing? Ask yourself the following two questions.</p>
<ol>
<li>can you confirm that what you are testing is the real test target?</li>
<li>Can you explain the results of the test, i.e. what is the bottleneck?</li>
</ol>
<p>So proactive testing is not a matter of running a command and then everything is fine and you can go have coffee, but you need to analyze before, during and after the test. And proactive testing is usually not done at once. Depending on the test situation, you may need to make continuous adjustments to the test environment, test tools, etc.</p>
<ul>
<li><strong>Pre-test</strong>:
<ul>
<li>Clarify what you are testing, i.e., what exactly you are testing. This is critical. You must clearly know what you are testing in order to adopt a reasonable configuration and make the right analysis judgment. All the later configuration modifications and analysis adjustments serve this testing goal: to make the test value as close to the ideal value as possible.</li>
<li>You need to understand your test tool and know how it works. Usually the testing tools we use are open source, and you can analyze them with the help of the source code.</li>
<li>You need to analyze the configuration in advance, including your test environment, test objects, test tools, etc.</li>
<li>Even if you analyze the configuration in advance, there may still be some missing or unknown, especially when you have little experience. That&rsquo;s okay, because we are proactive testing, the problems will be exposed and discovered later in the test, and then you can break them one by one.</li>
</ul>
</li>
<li><strong>In testing</strong>:
<ul>
<li>Use other tools to confirm that you are testing the real target</li>
<li>Analyze system conditions (e.g. CPU, memory, I/O, sockets, etc.) with the help of other tools to identify the real bottlenecks.</li>
<li>If you find that what you are testing is not the real target, adjust it and start again.</li>
<li>If the bottleneck is not as expected, you need to analyze and confirm the reason, and then restart the test after adjustment.</li>
</ul>
</li>
<li><strong>After testing</strong>:
<ul>
<li>Eventually you confirm that you have tested the real target and got a test value that can be reasonably interpreted. At this point it&rsquo;s not as simple as recording this one value; a single number is meaningless; it&rsquo;s only meaningful when augmented by your particular test environment, test configuration, and the evidence provided by other observation tools. So these are all part of the test results and need to be recorded and saved together.</li>
<li>Attempt to perform optimization, which currently may require you to have sufficient knowledge of the test system or test objects.</li>
</ul>
</li>
</ul>
<h3 id="example">Example</h3>
<p>Let&rsquo;s take the SSL new connection count test as an example and briefly describe the idea.</p>
<ul>
<li>
<p><strong>Pre-test</strong>:</p>
<ul>
<li>Determine the test object, because it is to measure the TPS of SSL new connections, so you need to make sure that the CPU is mainly consumed in the process of complete SSL handshake. In other words, tcp cannot be the bottleneck, no session reuse, http cannot be a long connection, the smaller the CPU consumption of the http layer business, etc.</li>
<li>After investigation and research, we decided to use wrk as the test tool.</li>
<li>Understand how its test model looks like and what each option represents.</li>
<li>Modify the Nginx configuration to ensure that it is the correct target for testing. Because there are so many indicator items that affect performance, it is recommended that you can consider them in layers: nginx core, tcp layer, ssl layer, http layer, etc. The resource limit class is usually configured at the system level and at the process level, with the process level not exceeding the system. Nginx is configured at the process level, so you need to make sure that the system one is set large enough.</li>
<li>Since SSL new connections also involve TCP new connections, the kernel network related parameters also need to be looked at, especially those related to the TCP build and break phases, such as backlog and timewait.</li>
<li>As traffic increases, soft disruptions and NICs may become bottlenecks and need to be configured accordingly.</li>
</ul>
</li>
<li>
<p><strong>Under test</strong>:</p>
<ul>
<li>The confirmation test by packet capture is SSL New Connection. If you are lazy and ignore this step, you may not find out that it is actually reusing sessions by default. Or the two-way authentication test becomes a one-way authentication, or it gets stuck on tcp connection establishment, etc.</li>
<li>By observing the system conditions (CPU, memory, IO, sockets, etc.) through tools, you may find that the TPS does not go up to a certain value, while the CPU is not full. At this point, you need to use various tools to analyze and troubleshoot, and the reasons may be various. It may be that your worker&rsquo;s maximum number of connections is set too small, the backlog may be set too small, the client pressure may not be enough, there may be a 100 megabit switch in the network, or the timewait may be the reason, if there is a backend may also be the backend to the bottleneck.</li>
<li>After locating the problem and adjusting accordingly then retesting, you may find new problems and bottlenecks and just keep optimizing and iterating. Eventually you may find that the CPU on the server side is full, which is expected since the SSL handshake is a CPU-intensive operation. If you can, it is best to do a sampling of the system to see where the CPU is being consumed in the flame chart and if there are any anomalies.</li>
</ul>
</li>
<li>
<p><strong>Post-test</strong>:</p>
<ul>
<li>After several tuning attempts, you finally think the test value is close enough to the real value. This test value, along with the test environment, test configuration, and observed evidence, make up the final test result.</li>
</ul>
</li>
</ul>
<h3 id="some-suggestions">Some Suggestions</h3>
<p>Some common suggestions are given next. Following these suggestions may seem to increase the workload, but in fact will eventually improve your efficiency, reduce the possibility of errors and detours, and also facilitate subsequent reproduction and look-back, and save a lot of repetitive work the next time you conduct similar tests.</p>
<ul>
<li>Record in as much detail as possible
<ul>
<li>Record hardware and software configurations</li>
<li>Save and organize test results</li>
<li>Write down command line calls to avoid manual input each time</li>
<li>Record queries and researched documents and urls, etc.</li>
</ul>
</li>
<li>Automate repetitive tasks
<ul>
<li>Automate as many test tasks as possible to reduce both the possibility of errors and the testing burden</li>
</ul>
</li>
<li>Try to use low overhead tools
<ul>
<li>Make our test values closer to the real values</li>
</ul>
</li>
<li>Use multiple tools
<ul>
<li>May need to use multiple tools for cross-validation when necessary to rule out problems with the tools themselves</li>
</ul>
</li>
<li>Define baselines and targets
<ul>
<li>A single value usually doesn&rsquo;t mean much, not knowing if it&rsquo;s good or bad, no comparison is harmless</li>
</ul>
</li>
<li>Separate the problem, compare, and control variables
<ul>
<li>This is the basic idea of locating the problem</li>
</ul>
</li>
<li>You need to re-run the full test after doing the optimization
<ul>
<li>Because of uncertainty about whether it will negatively affect other projects</li>
</ul>
</li>
</ul>
<h2 id="key-configuration-sorting">Key configuration sorting</h2>
<p>Let&rsquo;s start with the key configurations in general</p>
<h3 id="ssl-new-connection">SSL new connection</h3>
<h4 id="server-side-tuning">Server-side tuning</h4>
<ol>
<li>
<p>nginx configuration</p>
<ul>
<li>cpu affinity</li>
<li>file handle restrictions</li>
<li>backlog, reuseport, deferred</li>
<li>tcp_nopush/tcp_nodelay</li>
<li>SSL full handshake, no session reuse, HTTP short connections</li>
</ul>
</li>
<li>
<p>kernel parameters (mainly backlog, timewait, file handle restrictions)</p>
</li>
<li>
<p>irq binding</p>
</li>
</ol>
<h4 id="client-side-tuning">Client-side tuning</h4>
<ol>
<li>kernel parameters (major timewait, file handle limits, ports)</li>
<li>irq binding</li>
<li>configure multiple ip addresses (as needed, such as insufficient number of ports or load balancing needs)</li>
</ol>
<h3 id="throughput">Throughput</h3>
<p>Just need to make slight adjustment on the basis of SSL new connection</p>
<ol>
<li>change the server side to http long connection, long connection timeout time is set large</li>
<li>client request also change to long connection, request 1MB large file</li>
</ol>
<h3 id="maximum-concurrency">Maximum concurrency</h3>
<p>The maximum concurrency is mainly memory related and limited by the total memory of the machine. If you want the maximum concurrency to be as high as possible, you need to reduce the size of the various buffers and set the timeouts to be larger, because the maximum concurrency usually takes a long time to test.</p>
<ol>
<li>http long connection</li>
<li>increase worker_connections to the target value</li>
<li>each timeout time is set large (recv/send)</li>
<li>each buffer is set small (tcp/ssl/http)</li>
<li>long client connections, requesting small files, limiting the pressure to a small value (you can use wrk2&rsquo;s <code>-R</code> option)</li>
</ol>
<p>The next sections are described in detail, and the related configuration files and scripts etc. can be found in the Git repository <a href="https://github.com/catbro666/ssl-perf-test">ssl-perf-test</a>.</p>
<p><strong>It is important to remind</strong> that the configuration of the test is not set in stone, but needs to be reasonably configured on the basis of understanding the meaning of the configuration and combining it with your own testing needs.</p>
<h3 id="configuration-details">Configuration details</h3>
<h3 id="nginx-configuration">Nginx Configuration</h3>
<p>The following is the main configuration nginx-tps.conf for testing new SSL connections.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">worker_priority</span> <span class="s">-1·0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">worker_processes</span> <span class="s">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">worker_cpu_affinity</span> <span class="s">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">worker_rlimit_nofile</span> <span class="mi">1000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">error_log</span> <span class="s">logs/error.log</span> <span class="s">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">master_process</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">events</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">use</span> <span class="s">epoll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">worker_connections</span> <span class="mi">8192</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">multi_accept</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">accept_mutex</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">http</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#ssl_buffer_size 65536;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">reuseport</span> <span class="s">backlog=131072</span> <span class="s">deferred</span> <span class="s">so_keepalive=off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">keepalive_requests</span>  <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">keepalive_timeout</span>  <span class="s">0s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">tcp_nopush</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">tcp_nodelay</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">lingering_close</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">lingering_time</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">ssl_session_cache</span>   <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#ssl_session_cache    shared:SSL:1m;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">ssl_session_timeout</span>  <span class="mi">5m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">ssl_session_tickets</span> <span class="no">off</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">ssl_certificate</span> <span class="s">xxx.pem</span>
</span></span><span class="line"><span class="cl">        <span class="s">ssl_certificate_key</span> <span class="s">xxx.key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">ssl_verify_client</span> <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#ssl_verify_client off;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">ssl_prefer_server_ciphers</span>   <span class="no">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#proxy_cache cache_zone | off;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=cache_zone:10m;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">root</span>   <span class="s">html</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="main">main</h4>
<ul>
<li>worker_processes, generally set to auto, will automatically be set according to the number of CPU cores on the system</li>
<li>worker_cpu_affinity, generally auto will do, it will automatically bind one core per process</li>
<li>worker_rlimit_nofile, set the maximum number of files the process can open, the bottom is set to RLIMIT_NOFILE, can not exceed the hard nofile</li>
<li>worker_priority, set the priority of the process, similar to what the nice command does, the smaller the value the higher the priority.</li>
<li>error_log, the log configuration is also listed in the note is to remind you not to forget to modify</li>
</ul>
<h4 id="event">event</h4>
<ul>
<li>worker_connections, the number of process connections must be sufficient, but do not set it to a very large value, because the memory of these connections is allocated at startup and may lead to a lack of memory. Also mention that this is the number of connections for the entire worker, including downstream and upstream.</li>
<li>multi_accept, by default, when closed, the process accepts one connection at a time; when open, the process accepts all connections that are ready at once. This configuration needs to be chosen based on the specific test scenario, and is generally left off by default.</li>
<li>Accept_mutex, when open, each worker takes turns receiving new connections, when closed, all workers are notified of new connections (the so-called swarm effect). If the number of new connections is small, it can waste system resources. Note that when using reuseport there is no need for this configuration, because the kernel has already done the load balancing. Whether this configuration is turned on or not needs to be determined based on actual load conditions.</li>
</ul>
<h4 id="http">http</h4>
<ul>
<li>access_log, logging is generally selected off for performance testing</li>
<li>listenlisten, which has many additional parameters and can be configured with some socket options
<ul>
<li>reuseport, corresponding to the <code>SO_REUSEPORT</code> option, where multiple worker processes create independent listening sockets, allowing the kernel to load balance the connected connections between worker processes.</li>
<li>deferred, corresponding to <code>TCP_DEFER_ACCEPT</code> option, can defer the connection ready time, only when receiving application data from the client can accept, can slightly reduce the server side overhead.</li>
<li>backlog, set the listen full connection queue size, cannot exceed the system <code>net.core.somaxconn</code> limit. This needs to be large enough, otherwise it will affect the speed of new connections.</li>
</ul>
</li>
<li>keepalive_requests/keepalive_time, which set the maximum number of requests and timeout time for http long connections respectively, and choose whether to start them according to the actual test index.</li>
<li>sendfile, whether or not to use the sendfile() system call, you can directly send the file in the kernel, no need to go to the user state to transfer the first hand</li>
<li>tcp_nopush, turn this on only when sendfile is used, corresponds to <code>TCP_CORK</code> option on Linux, the response header and the beginning of the file are sent in one packet, the file is sent in a full packet to improve network efficiency.</li>
<li>tcp_nodelay, corresponding to <code>TCP_NODELAY</code> option, this option is for Nagle algorithm (before the sent data is acknowledged, save the new small data first and wait until a full MSS is made up or an acknowledgement is received from the other side before sending).</li>
<li>linger_close/linger_time/linger_timeout, these control whether to wait and process additional data before closing the server-side connection, and how long to wait.</li>
<li>ssl_session_cache/ssl_session_timeout/ssl_session_tickets, which control whether SSL session reuse is enabled and the timeout, as determined by test metrics</li>
<li>ssl_verify_client/ssl_client_certificate, whether to perform SSL two-way authentication, depending on the test requirements</li>
<li>ssl_buffer_size, the size of SSL buffer when sending data, we know the larger the data block length, the faster the symmetric encryption, so this default value is larger. However, if you are concerned about the first byte arrival time, it is better to change this configuration to a smaller one.</li>
<li>proxy_cache/proxy_cache_path, static files using cache can improve performance</li>
<li>client and proxy buffer, depending on the application data and the actual network conditions, client and proxy buffer related configuration may also affect the performance.</li>
</ul>
<h3 id="kernel-parameters-and-network-configuration">Kernel parameters and network configuration</h3>
<p>The kernel has a lot of network and tcp related parameters, the most important ones for our tests are backlog, timeout, file handle and port. I generally modify these parameters as follows. If your tests have other needs or encounter other bottlenecks, you can add and modify them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>./store.sh
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">600</span>            &gt; /proc/sys/net/core/netdev_budget
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">128</span>            &gt; /proc/sys/net/core/dev_weight
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">0</span>              &gt; /proc/sys/net/ipv4/tcp_fin_timeout
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">0</span>              &gt; /proc/sys/net/ipv4/tcp_tw_reuse
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">0</span>              &gt; /proc/sys/net/ipv4/tcp_max_tw_buckets
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">1025</span> <span class="m">65535</span>     &gt; /proc/sys/net/ipv4/ip_local_port_range
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">131072</span>         &gt; /proc/sys/net/core/somaxconn
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">262144</span>         &gt; /proc/sys/net/ipv4/tcp_max_orphans
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">262144</span>         &gt; /proc/sys/net/core/netdev_max_backlog
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">262144</span>         &gt; /proc/sys/net/ipv4/tcp_max_syn_backlog
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">4000000</span>        &gt; /proc/sys/fs/nr_open
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">8000000</span>        &gt; /proc/sys/fs/file-max
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">0</span>              &gt; /proc/sys/net/ipv4/tcp_abort_on_overflow
</span></span></code></pre></td></tr></table>
</div>
</div><p>In order to restore the system configuration after testing, it is recommended to save the original configuration before modifying it. I have written a simple script in tune.sh that will automatically execute store.sh to save the configuration you are going to modify in recover.sh, and execute recover.sh to restore the original configuration after the test is completed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在测试前修改配置，tune.sh中会自动调用store.sh保存</span>
</span></span><span class="line"><span class="cl">./tune.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在测试后恢复原先配置</span>
</span></span><span class="line"><span class="cl">./recover.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that the client and server-side concern parameters are not exactly the same, for example, the server side generally does not require the number of ports, the client does not require the backlog. In general, it is not a big problem to change all of them directly for convenience.</p>
<h4 id="client-virtual-ip">Client virtual ip</h4>
<p>Sometimes the client may need more than one ip address for testing, the following script setip.sh sets the corresponding number of ip addresses on a NIC according to the number of CPU cores of the test machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># Sets multiple IPs on a device</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the number of IPs is same as the number of CPU cores</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Note the netmask 24 bits, and the IP is started from</span>
</span></span><span class="line"><span class="cl"><span class="c1"># xxx.xxx.xxx.100 by default.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example: ./setip.sh eth0 192.169.100 100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">abort<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -lt <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    abort <span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> dev network [startip]
</span></span></span><span class="line"><span class="cl"><span class="s2">Example: ./setip.sh eth0 192.169.100 100&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">dev</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl"><span class="nv">net</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -gt <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">startip</span><span class="o">=</span><span class="nv">$3</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">startip</span><span class="o">=</span><span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ip link show <span class="nv">$dev</span> &gt; /dev/null
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    abort <span class="s2">&#34;device </span><span class="nv">$dev</span><span class="s2"> not existed!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">cpu_num</span><span class="o">=</span><span class="k">$(</span>cat /proc/cpuinfo <span class="p">|</span>grep processor <span class="p">|</span>wc -l<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="k">$(</span>seq <span class="nv">$startip</span> <span class="sb">`</span>expr <span class="nv">$cpu_num</span> + <span class="nv">$startip</span> - 1<span class="sb">`</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">        ifconfig <span class="nv">$dev</span>:<span class="nv">$i</span> <span class="nv">$net</span>.<span class="nv">$i</span>/24 up
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Deleting IPs can be done with the corresponding script delip.sh.</p>
<h4 id="client-testing-scripts">Client testing scripts</h4>
<p>The client here uses wrk2, and several simple scripts are written to facilitate testing. test-tps.sh is used to test new connections, test-tpt.sh is used to test throughput, test-max.sh is used to test maximum concurrent connections, and test-rps.sh is used to test HTTP services with long connections. The following are scripts for new connections, and several others are similar.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1"># 新建连接 TPS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">server</span><span class="o">=</span>192.168.100.20:55555
</span></span><span class="line"><span class="cl"><span class="nv">net</span><span class="o">=</span>192.168.100
</span></span><span class="line"><span class="cl"><span class="nv">startip</span><span class="o">=</span><span class="m">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">cpu_num</span><span class="o">=</span><span class="k">$(</span>cat /proc/cpuinfo <span class="p">|</span>grep processor <span class="p">|</span>wc -l<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">cpu_num</span><span class="o">=</span><span class="k">$((</span><span class="nv">$cpu_num</span> <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">0</span> <span class="nv">$cpu_num</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="c1"># specify separate IP for each process</span>
</span></span><span class="line"><span class="cl">    taskset -c <span class="nv">$i</span> ./wrk2 -t <span class="m">1</span> -c <span class="m">10</span> -d 30s --timeout 15s -b <span class="nv">$net</span>.<span class="sb">`</span>expr <span class="nv">$i</span> + <span class="nv">$startip</span><span class="sb">`</span> -H <span class="s1">&#39;Connection: close&#39;</span> --clientcert sm2-user.pem --clientkey sm2-user.key --protocol gmvpn --cipher ECC-SM4-SM3 -R <span class="m">1000</span> https://<span class="nv">$server</span>/0kb <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># use single IP</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#taskset -c $i ./wrk2 -t 1 -c 10 -d 30s --timeout 15s -H &#39;Connection: close&#39; --clientcert sm2-user.pem --clientkey sm2-user.key --protocol gmvpn --cipher ECC-SM4-SM3 -R 1000 https://$server/0kb &amp;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To maximize client performance, we used taskset to bind each wrk2 process to a separate CPU to reduce the overhead from context switching. However, this prints a test result for each wrk2 instance, which is not convenient for viewing and counting, so a script test.sh was written to automatically calculate the sum.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Calculates the sum of the wrk results</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Example: ./test-sum.sh tps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nv">test</span><span class="o">=</span>tps
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">test</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./test-<span class="nv">$test</span>.sh <span class="p">|</span> grep <span class="s2">&#34;Requests/sec&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;BEGIN {sum=0} {sum+=$2} END{print sum}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The usage is as follows, just specify the specific test (tps|tpt|max|rps) in the parameter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./test.sh tps
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="server-side-nic-bonding">Server-side NIC bonding</h4>
<p>Sometimes the traffic on a single NIC reaches a bottleneck and it may be necessary to bond multiple NICs to double the traffic. The following script binds 4 NICs, eth2, eth3, eth4, eth5, to bond0.</p>
<p>Here both server and client are set to mode 0, i.e. roundrobin mode load balancing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">modprobe bonding
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#mode: 0 balance-rr, 1 active-backup, 2 balance-xor, 3broadcast</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 4 802.3ad, 5balance-tlb, 6 balance-alb</span>
</span></span><span class="line"><span class="cl">ip link add bond0 <span class="nb">type</span> bond mode <span class="m">0</span> miimon <span class="m">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ifconfig eth2 down
</span></span><span class="line"><span class="cl">ifconfig eth3 down
</span></span><span class="line"><span class="cl">ifconfig eth4 down
</span></span><span class="line"><span class="cl">ifconfig eth5 down
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo ip link <span class="nb">set</span> eth2 master bond0
</span></span><span class="line"><span class="cl">sudo ip link <span class="nb">set</span> eth3 master bond0
</span></span><span class="line"><span class="cl">sudo ip link <span class="nb">set</span> eth4 master bond0
</span></span><span class="line"><span class="cl">sudo ip link <span class="nb">set</span> eth5 master bond0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ifconfig bond0 192.168.200.10/24
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># delete bond0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ip link delete bond0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For bonding you can refer to <a href="https://wiki.linuxfoundation.org/networking/bonding">here</a>.</p>
<h3 id="nic-queuing-and-irq">NIC Queuing and irq</h3>
<p>In practical testing, you may find that the si on some individual CPUs is particularly high and becomes a performance bottleneck. This is when you need to allocate the NIC queue to different CPU cores for soft interrupt handling. If the client encounters a similar problem, then a similar operation is required.</p>
<p>To facilitate testing, I wrote a script irqbind.sh to automatically perform the binding of NIC interrupt numbers and RPS settings, which is used as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl">$ ./irqbind.sh eth0
</span></span><span class="line"><span class="cl"><span class="c1"># 设置</span>
</span></span><span class="line"><span class="cl">$ ./irqbind.sh eth0 <span class="nb">set</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following describes the process of doing the setup manually to get an idea of the operation in the script.</p>
<h4 id="nic-interrupt-number-binding-to-cpu">NIC interrupt number binding to CPU</h4>
<p>The irqbalance service can bind the interrupt number for you, but it changes dynamically. If you are not satisfied with the effect of irqbalance, or want to bind it statically, you can also do it manually by yourself. The operation steps are as follows.</p>
<ul>
<li>
<p><code>cat /proc/interrupts</code> Check the interrupt number of the corresponding NIC. 218-249 below is the interrupt number corresponding to eth11, the NIC with 32 queues</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">218:   17094773          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         14         22          0          0          0          0      12697          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-0
</span></span><span class="line"><span class="cl">219:       3119   13271410          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-1
</span></span><span class="line"><span class="cl">220:       2385          0   13265837          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-2
</span></span><span class="line"><span class="cl">221:         23          0          0   13290114          0          0          0          0          0          0          0          0       2064          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-3
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">245:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5       2000    6603326          0          0          0          0          0          0          0     149556          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-27
</span></span><span class="line"><span class="cl">246:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5    6869437          0          0       2000  IR-PCI-MSI-edge      eth11-TxRx-28
</span></span><span class="line"><span class="cl">247:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5          0          0    6846871       2000          0  IR-PCI-MSI-edge      eth11-TxRx-29
</span></span><span class="line"><span class="cl">248:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5          0          0          0       2000    6937093          0  IR-PCI-MSI-edge      eth11-TxRx-30
</span></span><span class="line"><span class="cl">249:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5          0          0          0       2000          0          0    6837127  IR-PCI-MSI-edge      eth11-TxRx-31
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Next, bind the interrupt number to the CPU core</p>
<p>In the example, interrupt number 218 is bound to CPU number 1, and so on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">echo</span> <span class="m">00000001</span> &gt; /proc/irq/218/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000002</span> &gt; /proc/irq/219/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000004</span> &gt; /proc/irq/220/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000008</span> &gt; /proc/irq/221/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000010</span> &gt; /proc/irq/222/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000020</span> &gt; /proc/irq/223/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000040</span> &gt; /proc/irq/224/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">00000080</span> &gt; /proc/irq/225/smp_affinity
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">01000000</span> &gt; /proc/irq/242/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">02000000</span> &gt; /proc/irq/243/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">04000000</span> &gt; /proc/irq/244/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">08000000</span> &gt; /proc/irq/245/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">10000000</span> &gt; /proc/irq/246/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">20000000</span> &gt; /proc/irq/247/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">40000000</span> &gt; /proc/irq/248/smp_affinity
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="m">80000000</span> &gt; /proc/irq/249/smp_affinity
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="rps">RPS</h4>
<p>Sometimes your NIC does not support multiple queues, or the number of queues is less than the number of CPU cores, or the number of RX queues in the NIC&rsquo;s Indirection Table is less than the number of CPU cores, so you need to use the kernel&rsquo;s <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">RPS/RFS mechanism</a> to reallocate at the software level. For example, in the following example, the maximum number of RX queues in the NIC&rsquo;s indirect table is only 16.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ethtool --show-rxfh-indir enp7s0f0</span>
</span></span><span class="line"><span class="cl">RX flow <span class="nb">hash</span> indirection table <span class="k">for</span> enp7s0f0 with <span class="m">56</span> RX ring<span class="o">(</span>s<span class="o">)</span>:
</span></span><span class="line"><span class="cl">    0:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">    8:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">   16:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">   24:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">   32:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">   40:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">   48:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">   56:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">   64:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">   72:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">   80:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">   88:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">   96:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">  104:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">  112:      <span class="m">0</span>     <span class="m">1</span>     <span class="m">2</span>     <span class="m">3</span>     <span class="m">4</span>     <span class="m">5</span>     <span class="m">6</span>     <span class="m">7</span>
</span></span><span class="line"><span class="cl">  120:      <span class="m">8</span>     <span class="m">9</span>    <span class="m">10</span>    <span class="m">11</span>    <span class="m">12</span>    <span class="m">13</span>    <span class="m">14</span>    <span class="m">15</span>
</span></span><span class="line"><span class="cl">RSS <span class="nb">hash</span> key:
</span></span><span class="line"><span class="cl">fb:db:6a:ad:9d:49:5f:c7:d1:d9:d0:c8:bd:4c:e9:f3:60:c6:34:1e:09:c5:7f:f5:ae:bf:62:38:ca:83:a5:a2:40:c2:59:4b:32:92:6b:5b
</span></span><span class="line"><span class="cl">RSS <span class="nb">hash</span> <span class="k">function</span>:
</span></span><span class="line"><span class="cl">    toeplitz: on
</span></span><span class="line"><span class="cl">    xor: off
</span></span><span class="line"><span class="cl">    crc32: off
</span></span></code></pre></td></tr></table>
</div>
</div><p>Setting to a value greater than 16 will fail.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ethtool --set-rxfh-indir enp7s0f0 equal 56</span>
</span></span><span class="line"><span class="cl">Cannot <span class="nb">set</span> RX flow <span class="nb">hash</span> configuration: Invalid argument
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, the 16 rx queues can be redistributed to the 56 cores using RPS.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">echo</span> 010001,00010001 &gt; /sys/class/net/enp7s0f0/queues/rx-0/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 020002,00020002 &gt; /sys/class/net/enp7s0f0/queues/rx-1/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 040004,00040004 &gt; /sys/class/net/enp7s0f0/queues/rx-2/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 080008,00080008 &gt; /sys/class/net/enp7s0f0/queues/rx-3/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 100010,00100010 &gt; /sys/class/net/enp7s0f0/queues/rx-4/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 200020,00200020 &gt; /sys/class/net/enp7s0f0/queues/rx-5/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 400040,00400040 &gt; /sys/class/net/enp7s0f0/queues/rx-6/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 800080,00800080 &gt; /sys/class/net/enp7s0f0/queues/rx-7/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 000100,01000100 &gt; /sys/class/net/enp7s0f0/queues/rx-8/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 000200,02000200 &gt; /sys/class/net/enp7s0f0/queues/rx-9/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 000400,04000400 &gt; /sys/class/net/enp7s0f0/queues/rx-10/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 000800,08000800 &gt; /sys/class/net/enp7s0f0/queues/rx-11/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 001000,10001000 &gt; /sys/class/net/enp7s0f0/queues/rx-12/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 002000,20002000 &gt; /sys/class/net/enp7s0f0/queues/rx-13/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 004000,40004000 &gt; /sys/class/net/enp7s0f0/queues/rx-14/rps_cpus
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> 008000,80008000 &gt; /sys/class/net/enp7s0f0/queues/rx-15/rps_cpus
</span></span></code></pre></td></tr></table>
</div>
</div><p>The diagram nicely depicts what happened above.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/06/1eebb3be80824e31bc75b1114ff31921.png" alt="diagram"></p>
<p>The NIC receives packets to multiple queues, then binds the queue interrupt number to the CPU core, and if the CPU is not fully utilized, assigns it to another CPU core again with the help of RPS. Each CPU core has a ksoftirqd working on it. SO_REUSEPORT solves the socket contention problem, each process has a separate socket, and by default it does a hash of the data stream (source and destination ip port numbers) to choose the socket to send it to. but there is actually a bit of competition in this place, the same The Linux kernel has supported SO_ATTACH_REUSEPORT_CBPF/EBPF since version 4.5, which allows you to select a socket based on the core number to eliminate the competition here in softirq, with the CPU affinity binding of the process to maximize the performance. However, Nginx does not currently support this option.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/nginx/">nginx</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/golang-supply-chain/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How does Go respond to supply chain attacks?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/k8s-pod-security-policies/">
            <span class="next-text nav-default">Enabling Pod Security Policies for Kubernetes Clustering</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
