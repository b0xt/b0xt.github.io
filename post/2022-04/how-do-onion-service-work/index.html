<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How Do Onion Service Work? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how the Tor Onion service works." /><meta name="keywords" content="onion" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/how-do-onion-service-work/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="How Do Onion Service Work?" />
<meta property="og:description" content="Learn how the Tor Onion service works." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/how-do-onion-service-work/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-09T13:28:42+08:00" />
<meta property="article:modified_time" content="2022-04-09T13:28:42+08:00" />

<meta itemprop="name" content="How Do Onion Service Work?">
<meta itemprop="description" content="Learn how the Tor Onion service works."><meta itemprop="datePublished" content="2022-04-09T13:28:42+08:00" />
<meta itemprop="dateModified" content="2022-04-09T13:28:42+08:00" />
<meta itemprop="wordCount" content="696">
<meta itemprop="keywords" content="onion," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How Do Onion Service Work?"/>
<meta name="twitter:description" content="Learn how the Tor Onion service works."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How Do Onion Service Work?</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-09 13:28:42 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 696 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#communication-flow">Communication flow</a>
          <ul>
            <li><a href="#step-1-the-server-side-sets-up-its-own-introductory-node">Step 1: The server side sets up its own introductory node</a></li>
            <li><a href="#step-2-the-server-side-exposes-its-own-information">Step 2: The server side exposes its own information</a></li>
            <li><a href="#step-3-client-gets-list-of-introductory-nodes">Step 3: Client gets list of introductory nodes</a></li>
            <li><a href="#step-4-client-selects-a-rendezvous-node">Step 4: Client selects a rendezvous node</a></li>
            <li><a href="#step-5-the-client-introduces-itself-to-the-server">Step 5: The client introduces itself to the server</a></li>
            <li><a href="#step-6-server-side-and-client-side-rendezvous">Step 6: Server-side and client-side rendezvous</a></li>
          </ul>
        </li>
        <li><a href="#security">Security</a></li>
        <li><a href="#reference">Reference</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="communication-flow">Communication flow</h2>
<p>The communication to be described here is the process by which a user connects to the Onion service through the tor browser.</p>
<p>For ease of expression, Alice is used here to denote the client and Bob to denote the server.</p>
<h3 id="step-1-the-server-side-sets-up-its-own-introductory-node">Step 1: The server side sets up its own introductory node</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/57fcb517467f4ec39422e1845ae09f7b.png" alt="server side sets up its own introductory node"></p>
<p>The server uses introduction points to forward the introduction messages from the client in order not to reveal its IP.</p>
<p>First, Bob selects a few nodes from the tor relay node list to be his introduction nodes, and then establishes long-term circuits with them.</p>
<p>The long connections here are established through the tor network, so they are anonymous and the introductory nodes do not know Bob&rsquo;s IP.</p>
<p>At the same time, Bob will send an authentication key to the introductory node, and when a client connects to the introductory node, it will be able to determine whether the connection is to Bob by this key.</p>
<h3 id="step-2-the-server-side-exposes-its-own-information">Step 2: The server side exposes its own information</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/6910e52e4c2f4c66a209c3ef41bdd233.png" alt="server side exposes its own information"></p>
<p>Bob generates a description message (onion service descriptor), which stores a list of introductory nodes, including the ip of the introductory node and the corresponding authentication key.</p>
<p>Bob then signs the message with his private key and publishes the message to Tor&rsquo;s DHT.</p>
<p>After this step, the tor client can retrieve the message from the DHT with a certain key to find Bob&rsquo;s introductory node.</p>
<h3 id="step-3-client-gets-list-of-introductory-nodes">Step 3: Client gets list of introductory nodes</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/4d54736d2b384b0f8db2c7dfabbf2f18.png" alt="Step 3: Client gets list of introductory nodes"></p>
<p>Alice (the client) knows from some sources that Bob has an onion service and knows the onion domain name of this service, e.g., xyz.onion, and Alice wants to access Bob.</p>
<p>First, she requests the information corresponding to that domain name from the DHT network, which is the description message posted by Bob in step 2.</p>
<p>After getting the message, Alice verifies its signature. The public key of Bob used for verification is actually encoded in the domain name xyz.onion, and Alice can decode it from the domain name.</p>
<p>The message is OK, Alice parses the list of Bob&rsquo;s introduction nodes from the message, and selects one of the introduction nodes, where Alice will introduce herself to Bob.</p>
<h3 id="step-4-client-selects-a-rendezvous-node">Step 4: Client selects a rendezvous node</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/9559eb499ead45a0b06e820672110d15.png" alt="Step 4: Client selects a rendezvous node"></p>
<p>Alice selects a node from the tor relay node list as the rendezvous point, and then establishes a connection to the rendezvous node (RP) via tor.</p>
<p>At the same time, Alice sends a one-time secret to the rendezvous node, which will be used during the round.</p>
<h3 id="step-5-the-client-introduces-itself-to-the-server">Step 5: The client introduces itself to the server</h3>
<p>Alice generates a message containing the rendezvous node and the one-time secret, and then encrypts the message with Bob&rsquo;s public key.</p>
<p>Alice connects to one of Bob&rsquo;s introduction nodes via the Tor network and has that introduction node forward the encrypted message to Bob.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/bd6269b0dc734f8ab4929328023c2e76.png" alt="Step 5: The client introduces itself to the server"></p>
<h3 id="step-6-server-side-and-client-side-rendezvous">Step 6: Server-side and client-side rendezvous</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/047dadf2bacd4b3685324051a30b6078.png" alt="Step 6: Server-side and client-side rendezvous"></p>
<p>At this point, Bob has received the message forwarded by the introduction node, knows that Alice wants to visit himself, and knows the information of the rendezvous node.</p>
<p>Bob connects to the rendezvous node through the Tor network, and then sends the one-time password received to the rendezvous node, from which the rendezvous node knows that Bob is trying to communicate with Alice, so that it can relay Alice&rsquo;s messages to Bob.</p>
<h2 id="security">Security</h2>
<p>The client and the server end up communicating through the rendezvous node, and they each connect to the rendezvous node separately through the tor network, thus ensuring both the client&rsquo;s invisibility and the server&rsquo;s non-exposure.</p>
<p>All the communication in the above process is established using the tor network, including the communication between the server and the introduction node, the communication between the client and the introduction node, the communication between the client and the rendezvous node, and the communication between the server and the rendezvous node.</p>
<p>Therefore, normally the tor client communicates with the onion service after 6 transit times, including 3 times for the client to connect to the rendezvous node and 3 times for the server to connect to the rendezvous node.</p>
<p>If the tor client accesses a service other than the onion service, then the communication process is not the same as above, and there are only 3 transitions.</p>
<h2 id="reference">Reference</h2>
<p><a href="https://community.torproject.org/onion-services/overview/">https://community.torproject.org/onion-services/overview/</a></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/onion/">onion</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/linux-suid/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Learning the SUID mechanism in Linux</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/ipfs/">
            <span class="next-text nav-default">IPFS Beginner&#39;s Manual</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
