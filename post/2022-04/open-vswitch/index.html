<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Open vSwitch - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the architecture of Open vSwitch, how it works, and how to install and use it." /><meta name="keywords" content="Open vSwitch" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/open-vswitch/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Open vSwitch" />
<meta property="og:description" content="Learn the architecture of Open vSwitch, how it works, and how to install and use it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/open-vswitch/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-22T09:34:53+08:00" />
<meta property="article:modified_time" content="2022-04-22T09:34:53+08:00" />

<meta itemprop="name" content="Open vSwitch">
<meta itemprop="description" content="Learn the architecture of Open vSwitch, how it works, and how to install and use it."><meta itemprop="datePublished" content="2022-04-22T09:34:53+08:00" />
<meta itemprop="dateModified" content="2022-04-22T09:34:53+08:00" />
<meta itemprop="wordCount" content="8498">
<meta itemprop="keywords" content="open vswitch," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Open vSwitch"/>
<meta name="twitter:description" content="Learn the architecture of Open vSwitch, how it works, and how to install and use it."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Open vSwitch</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-22 09:34:53 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 8498 words </span>
          <span class="more-meta"> 17 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#system-architecture">System Architecture</a>
          <ul>
            <li><a href="#ovsdb">ovsdb</a></li>
            <li><a href="#ovs-vswitchd">ovs-vswitchd</a></li>
            <li><a href="#datapatch">datapatch</a></li>
          </ul>
        </li>
        <li><a href="#how-it-works">How it works</a></li>
        <li><a href="#command-line-tools">Command line tools</a></li>
        <li><a href="#installation-and-deployment">Installation and Deployment</a></li>
        <li><a href="#ovs-db">ovs-db</a></li>
        <li><a href="#operational-objects-of-open-vswitch">Operational Objects of Open vSwitch</a>
          <ul>
            <li><a href="#manager">Manager</a></li>
            <li><a href="#ssl">SSL</a></li>
            <li><a href="#bridge">Bridge</a></li>
            <li><a href="#controller">Controller</a></li>
            <li><a href="#mirror">Mirror</a></li>
            <li><a href="#port-and-interface">Port and Interface</a></li>
            <li><a href="#tunnel">Tunnel</a></li>
            <li><a href="#flow-tables">Flow Tables</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Open vSwitch is an open source implementation of virtual switches. Widely used in the cloud computing industry to provide network administrators with visibility and control of traffic between and within virtual cloud hosts, Open vSwitch is designed to solve network problems with a virtualization solution that works with controller software to enable distributed virtual switching technology. This means that the switch and controller software can create clustered network configurations across multiple servers, eliminating the need for separate network configurations on each cloud host and physical host. This switch also supports VLAN trunking, visibility through NetFlow, sFlow and RSPAN, and management through the OpenFlow protocol. It also has several other features: strict flow control, which is enabled by the OpenFlow switch protocol; and remote management capabilities, which enable more control through network policies.</p>
<p>In terms of Flow controllers or management tools for virtual switches, OvS requires the use of third-party controllers or management tools to implement complex forwarding policies. For example, if OvS supports the OpenFlow protocol, we can use any controller that supports the OpenFlow protocol to remotely manage OvS. However, this does not mean that OvS must have a controller to work. Without an external controller attached, OvS itself can rely on MAC address learning for Layer 2 packet forwarding functions, just like Linux Bridge.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/d077a0751a5f49b3b8c43e3aea439c19.png" alt="Open vSwitch"></p>
<p>In short, Open vSwitch, the open OpenFlow switch, is capable of product-level quality, meaning it can be deployed for use in a number of production environments. It supports not only basic Layer 2 switching, but also standard management machine interfaces and protocols (e.g. NetFlow, sFlow, SPAN, RSAPN, CLI, LACP, 802.1ag), which can be well integrated with SDN systems.</p>
<p><strong>List of Open vSwitch features</strong>.</p>
<ul>
<li>Support for enabling internal VM communications to be monitored via NetFlow, sFlow, IPFIX, SPAN, RSPAN and GRE-tunneled mirrors.</li>
<li>Support for the LACP (IEEE 802.1AX-2008, multi-port binding) protocol.</li>
<li>Support for the standard 802.1Q VLAN model as well as Trunk mode.</li>
<li>Support for BFD and 802.1ag link status monitoring.</li>
<li>Support for STP (IEEE 802.1D-1998).</li>
<li>Support for fine-grained QoS.</li>
<li>Support for HFSC system-level traffic control queues.</li>
<li>Support traffic control policy for per-VM NIC traffic.</li>
<li>Support for multi-port binding based on source MAC load balancing mode, primary and secondary mode, and L4 hash mode.</li>
<li>Support for OpenFlow protocol (including many virtualization enhancements).</li>
<li>Support for IPV6</li>
<li>Support for multiple tunneling protocols (GRE, VXLAN, IPsec, GRE and VXLAN over IPsec)</li>
<li>Support for remote configuration via C or Python interfaces.</li>
<li>Support for kernel-state and user-state forwarding engine settings.</li>
<li>Support for send cache engines for multi-list forwarding.</li>
<li>Support for forwarding layer abstraction for easy orientation to new software or hardware platforms.</li>
</ul>
<h2 id="system-architecture">System Architecture</h2>
<p>OvS consists of three main components.</p>
<ul>
<li>The main user space components are ovsdb-server and ovs-vswitchd</li>
<li>The kernel space consists of the datapath kernel module</li>
<li>The top Controller represents the OpenFlow controller, which is connected to OvS through the OpenFlow protocol</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/d0edaaf0eb49477fb044935b9abd76b8.png" alt="OpenFlow"></p>
<ul>
<li>ovs-vswitchd: The main module that implements kernel datapath upcall processing and ofproto table lookup, as well as the dpdk datapath handler.</li>
<li>ovsdb-server: database server, using the currently accepted ovsdb protocol.</li>
<li>ovs-vsctl: bridge, interface creation, deletion, setup, query, etc.</li>
<li>ovs-dpctl: configuration of vswitch kernel module</li>
<li>ovs-appctl: send command messages to ovs-vswithchd, check the status of different modules</li>
<li>ovs-ofctl: send down flow table information. This command can configure other openflow switches (with openflow protocol)</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/631e4ff2332541729b82b6a8dac61960.png" alt="openflow protocol"></p>
<h3 id="ovsdb">ovsdb</h3>
<p>ovsdb is an OvS lightweight database service that stores configuration information for the entire OvS, including interfaces, switch contents, VLANs, virtual switch creation, NIC additions, and other information and operations, all stored by ovsdb in a conf.db file (JSON format) and served via db.sock. vswitchd works based on the configuration information in the database.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovsdb-server /etc/openvswitch/conf.db 
</span></span><span class="line"><span class="cl">    -vconsole:emer -vsyslog:err 
</span></span><span class="line"><span class="cl">    -vfile:info 
</span></span><span class="line"><span class="cl">    --remote<span class="o">=</span>punix:/var/run/openvswitch/db.sock 
</span></span><span class="line"><span class="cl">    --private-key<span class="o">=</span>db:Open_vSwitch,SSL,private_key 
</span></span><span class="line"><span class="cl">    --certificate<span class="o">=</span>db:Open_vSwitch,SSL,certificate 
</span></span><span class="line"><span class="cl">    --bootstrap-ca-cert<span class="o">=</span>db:Open_vSwitch,SSL,ca_cert --no-chdir 
</span></span><span class="line"><span class="cl">    --log-file<span class="o">=</span>/var/log/openvswitch/ovsdb-server.log 
</span></span><span class="line"><span class="cl">    --pidfile<span class="o">=</span>/var/run/openvswitch/ovsdb-server.pid
</span></span><span class="line"><span class="cl">    --detach 
</span></span><span class="line"><span class="cl">    --monitor
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>/etc/openvswitch/conf.db</code> : is the database file location, ovsdb-server needs this file to start, you can use <code>ovsdb-tool create</code> command to create and initialize this database file.</li>
<li><code>--remote=punix:/var/run/openvswitch/db.sock</code> : implements a Unix Sockets connection through which the OvS master process ovs-vswitchd or other command tool (e.g. ovsdb-client) manages ovsdb.</li>
<li><code>/var/log/openvswitch/ovsdb-server.log</code> : The runtime log file of ovsdb-server.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/75905d9e094f4624a47f1b2be0bd949f.png" alt="ovs"></p>
<h3 id="ovs-vswitchd">ovs-vswitchd</h3>
<p>ovs-vswitchd is essentially a daemon, the core component of OvS. ovs-vswitchd and Datapath work together to implement Flow-based Switching for OvS.</p>
<ul>
<li>Can communicate with OpenFlow controllers via the OpenFlow protocol</li>
<li>Communicates with the ovsdb-server database service using the ovsdb protocol</li>
<li>Uses netlink and Datapath kernel modules to communicate.</li>
</ul>
<p>ovs-vswitchd supports multiple independent Datapaths. ovs-vswitchd requires the Datapath kernel module to be loaded for proper operation. ovs-vswitchd reads the configuration information from ovsdb-server at startup and then automatically configures the Datapaths and OvS Switches&rsquo; When the configuration content in ovsdb is modified, ovs-vswitched automatically updates its configuration to keep the data synchronized. ovs-vswitchd can also obtain flow table entries from the OpenFlow controller. ovs-vswitchd can also obtain flow table entries from the OpenFlow controller.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovs-vswitchd unix:/var/run/openvswitch/db.sock 
</span></span><span class="line"><span class="cl">    -vconsole:emer 
</span></span><span class="line"><span class="cl">    -vsyslog:err 
</span></span><span class="line"><span class="cl">    -vfile:info 
</span></span><span class="line"><span class="cl">    --mlockall 
</span></span><span class="line"><span class="cl">    --no-chdir 
</span></span><span class="line"><span class="cl">    --log-file<span class="o">=</span>/var/log/openvswitch/ovs-vswitchd.log 
</span></span><span class="line"><span class="cl">    --pidfile<span class="o">=</span>/var/run/openvswitch/ovs-vswitchd.pid 
</span></span><span class="line"><span class="cl">    --detach 
</span></span><span class="line"><span class="cl">    --monitor
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/bc46462c6dda443f9152c8cda61d13d9.png" alt="open vswitchd"></p>
<h3 id="datapatch">datapatch</h3>
<p>In the semantics of OpenFlow Switch rules, a technical term called Datapath is given to switches, or bridges. open vSwitch&rsquo;s kernel module <code>openvswitch.ko</code> implements multiple Datapaths, each of which can have multiple Ports. Datapath listens to the NIC interface devices, matches the packets in the flow table, and returns the corresponding Actions to Datapath as a description of the data processing behavior after finding the matching flow table entry. The kernel module information of Datapath is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># modinfo openvswitch</span>
</span></span><span class="line"><span class="cl">filename:       /lib/modules/3.10.0-327.el7.x86_64/kernel/net/openvswitch/openvswitch.ko
</span></span><span class="line"><span class="cl">license:        GPL
</span></span><span class="line"><span class="cl">description:    Open vSwitch switching datapath
</span></span><span class="line"><span class="cl">rhelversion:    7.2
</span></span><span class="line"><span class="cl">srcversion:     F75F2B83324DCC665887FD5
</span></span><span class="line"><span class="cl">depends:        libcrc32c
</span></span><span class="line"><span class="cl">intree:         Y
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>More information on Datapath can be found at <a href="https://benpfaff.org/papers/ovs.pdf">The Design and Implementation of Open vSwitch</a>.</p>
<h2 id="how-it-works">How it works</h2>
<p>The Bridge processes data frames according to the following rules.</p>
<ul>
<li>A frame received on a Port does not send this frame to this Port again.</li>
<li>Incoming frames learn their Source MAC address.</li>
<li>If the frame is a multicast or broadcast packet (determined by the Layer 2 MAC address) it is forwarded to all ports except the receiving port, and if the upper layer protocol is interested, it is also passed to the upper layer for processing.</li>
<li>If the address of the data frame cannot be found in the CAM (MAC-Port Mapping) table, it is forwarded to all ports outside the receiving port.</li>
<li>If it can be found in the CAM table, it is forwarded to the corresponding Port, or not sent if both sending and receiving are the same Port.</li>
<li>The bridge works in promiscuous mode, and data frames with all MAC addresses can pass through.</li>
</ul>
<p>The user space ovs-vswitchd and the kernel module Datapath determine the forwarding of packets as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/0389040385ac485c8e51b8dbb2e500af.png" alt="architecture"></p>
<ul>
<li>The kernel-state Datapath listens for incoming packets from the interface device.</li>
<li>If Datapath does not find a matching flow table entry in the kernel-state flow table cache, it passes (upcalls) the packet to the user-state ovs-vswitchd daemon for processing.</li>
<li>(Optional) User-state ovs-vswitchd has full flow table entries and communicates with the OpenFlow controller or the ovs-ofctl command-line tool via the OpenFlow protocol, mainly to receive flow table entries from the OpenFlow controller&rsquo;s southbound interface. Or, depending on the flow table entry settings, ovs-vswitchd may send network packets to the OpenFlow controller for processing as Packet-In messages.</li>
<li>ovs-vswitchd updates the kernel-state Flow Table upon receiving a message from the OpenFlow controller or the ovs-ofctl command-line tool. Alternatively, based on the locality principle, the user-state ovs-vswitchd injects into the Flow Table the flow table entries that were not cached by the Datapath that was just executed.</li>
<li>ovs-vswitchd reinjects the packets into Datapath after matching the Flow Table entries.</li>
<li>Datapath accesses the Flow Table again to get the flow table entries for matching.</li>
<li>Finally, the network packet is forwarded or dropped by Datapath based on the Flow Table entry Actions.</li>
</ul>
<p>The above, Datapath and ovs-vswitchd interworking contains two ways of handling network packets.</p>
<ul>
<li><strong>Fast Path</strong> : After Datapatch is loaded into the kernel, it registers a hook function on the NIC, which is called whenever a network packet arrives at the NIC, starts unpacking the network packet layer by layer (MAC layer, IP layer, TCP layer, etc.), then matches it with a flow table entry, and if a matching flow table entry is found then the network packet is processed according to the established policy (e.g. Modify MAC, modify IP, modify TCP port, which NIC to send it from, etc.), and then send the network packet from the NIC. This process is all done in the kernel, so it is very fast and is called Fast Path.</li>
<li><strong>Slow Path</strong>: The kernel state is not allocated much memory, so the kernel state can save very few stream table entries, and often the old ones are discarded when new stream table entries arrive. If you cannot find a stream table entry in the kernel state, you need to look it up in the user state. Network packets are sent to ovs-vswitchd via netlink (a mechanism for interaction between the kernel state and the user state). ovs-vswitchd has a listening thread, and when it finds a network packet from the kernel state, it enters its own processing and reinjects the network packet into Datapath again. Obviously, processing in the user state is relatively slow, so the value is called Slow Path.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/0389040385ac485c8e51b8dbb2e500af.png" alt="Fast Path/Slow Path"></p>
<p>In the user state ovs-vswtichd does not need to skimp on memory, it contains all the flow table entries that may have been issued by the OpenFlow controller via the OpenFlow protocol or set by the OvS command line tool ovs-ofctl. ovs-vswtichd will match network packet information layer by layer until it finds a flow table entry for processing. If none is found, the default stream table entry is usually used, such as dropping the packet.</p>
<p>When a stream table entry is finally matched, it is sent down to the kernel via the netlink protocol based on the &ldquo;locality principle (local data is accessed frequently over time, which is the basis of cache design)&rdquo;, and when the policy is sent down to the kernel, if the kernel does not have enough memory space, it will starts eliminating some of the old policies. This ensures that the next network packet of the same type can be matched directly from the kernel, thus speeding up execution. Due to the proximate effect, the next network packet should most likely be able to match this policy. For example, if a file is transferred, a steady stream of network packets of the same type will arrive.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/547c05d8ca9648d9a21844a1d426a5ca.png" alt="open vswitch"></p>
<h2 id="command-line-tools">Command line tools</h2>
<ul>
<li><strong>ovs-vsctl</strong> : Used to manage the configuration information of ovs-vswitchd.</li>
<li><strong>ovs-ofctl</strong> : Used to manage the flow table information of OvS.</li>
<li><strong>ovs-pki</strong> : Used to manage the TSL communication framework between OvS and OpenFlow Controller.</li>
<li><strong>ovs-dpctl</strong> : Used to manage Datapath, such as viewing Datapath information.</li>
<li><strong>ovs-appctl</strong> : Application layer command set, e.g. simulate packets for testing OvS Switch data forwarding flow.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/8fb733a75b6f427089f406c7e39be207.png" alt="open vswitch"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看 OvS Log 级别</span>
</span></span><span class="line"><span class="cl">ovs-appctl vlog/list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 Log 级别</span>
</span></span><span class="line"><span class="cl">ovs-appctl vlog/set <span class="o">{</span>module name<span class="o">}</span>:<span class="o">{</span>console, syslog, file<span class="o">}</span>:<span class="o">{</span>off, emer, err, warn, info, dbg<span class="o">}</span>
</span></span><span class="line"><span class="cl">ovs-appctl vlog/set stp:file:dbg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 OvS 版本</span>
</span></span><span class="line"><span class="cl">ovs-ofctl -V
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查询指令历史记录</span>
</span></span><span class="line"><span class="cl">ovsdb-tool show-log <span class="o">[</span>-mmm<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 OpenFlow 网络端口编号</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port &lt;bridge&gt; &lt;interface&gt; -- <span class="nb">set</span> Interface &lt;interface&gt; <span class="nv">ofport_request</span><span class="o">=</span><span class="m">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 Interface 类型为 internal</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> Interface &lt;interface&gt; <span class="nv">type</span><span class="o">=</span>internal
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 开启指定 Bridge 的 STP</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> bridge &lt;bridge&gt; <span class="nv">stp_enable</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 关闭指定 Bridge 的 STP</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> bridge &lt;bridge&gt; <span class="nv">stp_enable</span><span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查询指定 Bridge 的 STP 的配置信息</span>
</span></span><span class="line"><span class="cl">ovs-vsctl get bridge &lt;bridge&gt; stp_enable
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置指定 Bridge 的 STP Priority</span>
</span></span><span class="line"><span class="cl">ovs−vsctl <span class="nb">set</span> bridge &lt;bridge&gt; other_config:stp-priority<span class="o">=</span>0x7800
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置指定 Bridge 的 STP Cost</span>
</span></span><span class="line"><span class="cl">ovs−vsctl <span class="nb">set</span> bridge &lt;bridge&gt; other_config:stp-path-cost<span class="o">=</span><span class="m">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="installation-and-deployment">Installation and Deployment</h2>
<p><strong>OS</strong> : CentOS7</p>
<p><strong>Step1</strong>. Shut down SELinux, otherwise ovsdb-server Manager will not work properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># setenforce 0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat /etc/selinux/config | grep -v ^#</span>
</span></span><span class="line"><span class="cl"><span class="nv">SELINUX</span><span class="o">=</span>disabled
</span></span><span class="line"><span class="cl"><span class="nv">SELINUXTYPE</span><span class="o">=</span>targeted
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Step 2</strong>. yum install</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">yum install openvswitch openvswitch-test
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Step 3</strong>. Start the service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">systemctl <span class="nb">enable</span> openvswitch
</span></span><span class="line"><span class="cl">systemctl start openvswitch
</span></span><span class="line"><span class="cl">systemctl status openvswitch
</span></span></code></pre></td></tr></table>
</div>
</div><p>View the current version of OvS:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>View a list of OvS service processes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovsdb-server /etc/openvswitch/conf.db 
</span></span><span class="line"><span class="cl">    -vconsole:emer -vsyslog:err 
</span></span><span class="line"><span class="cl">    -vfile:info 
</span></span><span class="line"><span class="cl">    --remote<span class="o">=</span>punix:/var/run/openvswitch/db.sock 
</span></span><span class="line"><span class="cl">    --private-key<span class="o">=</span>db:Open_vSwitch,SSL,private_key 
</span></span><span class="line"><span class="cl">    --certificate<span class="o">=</span>db:Open_vSwitch,SSL,certificate 
</span></span><span class="line"><span class="cl">    --bootstrap-ca-cert<span class="o">=</span>db:Open_vSwitch,SSL,ca_cert --no-chdir 
</span></span><span class="line"><span class="cl">    --log-file<span class="o">=</span>/var/log/openvswitch/ovsdb-server.log 
</span></span><span class="line"><span class="cl">    --pidfile<span class="o">=</span>/var/run/openvswitch/ovsdb-server.pid
</span></span><span class="line"><span class="cl">    --detach 
</span></span><span class="line"><span class="cl">    --monitor
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ovs-vswitchd unix:/var/run/openvswitch/db.sock 
</span></span><span class="line"><span class="cl">    -vconsole:emer 
</span></span><span class="line"><span class="cl">    -vsyslog:err 
</span></span><span class="line"><span class="cl">    -vfile:info 
</span></span><span class="line"><span class="cl">    --mlockall 
</span></span><span class="line"><span class="cl">    --no-chdir 
</span></span><span class="line"><span class="cl">    --log-file<span class="o">=</span>/var/log/openvswitch/ovs-vswitchd.log 
</span></span><span class="line"><span class="cl">    --pidfile<span class="o">=</span>/var/run/openvswitch/ovs-vswitchd.pid 
</span></span><span class="line"><span class="cl">    --detach 
</span></span><span class="line"><span class="cl">    --monitor
</span></span></code></pre></td></tr></table>
</div>
</div><p>To view the loaded kernel modules.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># lsmod | grep openvswitch</span>
</span></span><span class="line"><span class="cl">openvswitch            <span class="m">70743</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">vxlan                  <span class="m">37584</span>  <span class="m">1</span> openvswitch
</span></span><span class="line"><span class="cl">gre                    <span class="m">13808</span>  <span class="m">1</span> openvswitch
</span></span><span class="line"><span class="cl">libcrc32c              <span class="m">12644</span>  <span class="m">2</span> xfs,openvswitch
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ovs-db">ovs-db</h2>
<p>The carrier of ovs-db on the operating system is the JSON file /etc/openvswitch/conf.db, whose contents can be viewed by executing the command <code>ovsdb-client dump</code>, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovsdb-client dump</span>
</span></span><span class="line"><span class="cl">Bridge table
</span></span><span class="line"><span class="cl">_uuid controller datapath_id datapath_type external_ids fail_mode flood_vlans flow_tables ipfix mirrors name netflow other_config ports protocols sflow status stp_enable
</span></span><span class="line"><span class="cl">----- ---------- ----------- ------------- ------------ --------- ----------- ----------- ----- ------- ---- ------- ------------ ----- --------- ----- ------ ----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Controller table
</span></span><span class="line"><span class="cl">_uuid connection_mode controller_burst_limit controller_rate_limit enable_async_messages external_ids inactivity_probe is_connected local_gateway local_ip local_netmask max_backoff other_config role status target
</span></span><span class="line"><span class="cl">----- --------------- ---------------------- --------------------- --------------------- ------------ ---------------- ------------ ------------- -------- ------------- ----------- ------------ ---- ------ ------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flow_Sample_Collector_Set table
</span></span><span class="line"><span class="cl">_uuid bridge external_ids id ipfix
</span></span><span class="line"><span class="cl">----- ------ ------------ -- -----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flow_Table table
</span></span><span class="line"><span class="cl">_uuid flow_limit groups name overflow_policy
</span></span><span class="line"><span class="cl">----- ---------- ------ ---- ---------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IPFIX table
</span></span><span class="line"><span class="cl">_uuid cache_active_timeout cache_max_flows external_ids obs_domain_id obs_point_id sampling targets
</span></span><span class="line"><span class="cl">----- -------------------- --------------- ------------ ------------- ------------ -------- -------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Interface table
</span></span><span class="line"><span class="cl">_uuid admin_state bfd bfd_status cfm_fault cfm_fault_status cfm_health cfm_mpid cfm_remote_mpids cfm_remote_opstate duplex external_ids ifindex ingress_policing_burst ingress_policing_rate lacp_current link_resets link_speed link_state mac mac_in_use mtu name ofport ofport_request options other_config statistics status <span class="nb">type</span>
</span></span><span class="line"><span class="cl">----- ----------- --- ---------- --------- ---------------- ---------- -------- ---------------- ------------------ ------ ------------ ------- ---------------------- --------------------- ------------ ----------- ---------- ---------- --- ---------- --- ---- ------ -------------- ------- ------------ ---------- ------ ----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Manager table
</span></span><span class="line"><span class="cl">_uuid connection_mode external_ids inactivity_probe is_connected max_backoff other_config status target
</span></span><span class="line"><span class="cl">----- --------------- ------------ ---------------- ------------ ----------- ------------ ------ ------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mirror table
</span></span><span class="line"><span class="cl">_uuid external_ids name output_port output_vlan select_all select_dst_port select_src_port select_vlan statistics
</span></span><span class="line"><span class="cl">----- ------------ ---- ----------- ----------- ---------- --------------- --------------- ----------- ----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NetFlow table
</span></span><span class="line"><span class="cl">_uuid active_timeout add_id_to_interface engine_id engine_type external_ids targets
</span></span><span class="line"><span class="cl">----- -------------- ------------------- --------- ----------- ------------ -------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Open_vSwitch table
</span></span><span class="line"><span class="cl">_uuid                                bridges cur_cfg db_version external_ids                                       manager_options next_cfg other_config ovs_version ssl statistics system_type system_version
</span></span><span class="line"><span class="cl">------------------------------------ ------- ------- ---------- -------------------------------------------------- --------------- -------- ------------ ----------- --- ---------- ----------- --------------
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f <span class="o">[]</span>      <span class="m">0</span>       <span class="s2">&#34;7.3.0&#34;</span>    <span class="o">{</span>system-id<span class="o">=</span><span class="s2">&#34;257b9b47-87e7-4404-9af8-37f98b04f2bd&#34;</span><span class="o">}</span> <span class="o">[]</span>              <span class="m">0</span>        <span class="o">{}</span>           <span class="s2">&#34;2.0.0&#34;</span>     <span class="o">[]</span>  <span class="o">{}</span>         unknown     unknown       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Port table
</span></span><span class="line"><span class="cl">_uuid bond_downdelay bond_fake_iface bond_mode bond_updelay external_ids fake_bridge interfaces lacp mac name other_config qos statistics status tag trunks vlan_mode
</span></span><span class="line"><span class="cl">----- -------------- --------------- --------- ------------ ------------ ----------- ---------- ---- --- ---- ------------ --- ---------- ------ --- ------ ---------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">QoS table
</span></span><span class="line"><span class="cl">_uuid external_ids other_config queues <span class="nb">type</span>
</span></span><span class="line"><span class="cl">----- ------------ ------------ ------ ----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Queue table
</span></span><span class="line"><span class="cl">_uuid dscp external_ids other_config
</span></span><span class="line"><span class="cl">----- ---- ------------ ------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SSL table
</span></span><span class="line"><span class="cl">_uuid bootstrap_ca_cert ca_cert certificate external_ids private_key
</span></span><span class="line"><span class="cl">----- ----------------- ------- ----------- ------------ -----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sFlow table
</span></span><span class="line"><span class="cl">_uuid agent external_ids header polling sampling targets
</span></span><span class="line"><span class="cl">----- ----- ------------ ------ ------- -------- -------
</span></span></code></pre></td></tr></table>
</div>
</div><p>The use of graphical tools allows for a more user-friendly view of.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/bf0b8977413943d2a58d94abd7b3844f.png" alt="ovs-db"></p>
<p>The relationship between the database tables is shown in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/d874e22a9b0b4f6d87bf77e126b714dc.png" alt="relationship between the database tables"></p>
<p>The Open_vSwitch table is the root of the OvS DB.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/1fbd8ece097f462e895356ad112c0c99.png" alt="Open_vSwitch">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/d60474c76df5434c984326eb1fbf3c23.png" alt="Open_vSwitch"></p>
<p>It has the following table structure, which records the configuration information of ovs-vswitchd, e.g.</p>
<ul>
<li>Configuration of the Bridge device</li>
<li>The configuration of the OvS itself
<ul>
<li>other_config:stats-update-interval: the interval to write statistics to the database</li>
<li>other_config:flow-restore-wait: for hot-upgrade, if True then no packets are processed. The general procedure is: first stop ovs-vswitchd, then set this value to True, then start ovs-vswitchd, which does not process any packets, then use ovs-ofctl to restore the flow table to a correct state, and finally set this value to False to start processing packets.</li>
<li>other_config:flow-limit: Specify the number of flow entries in the Flow Table</li>
<li>other_config:n-handler-threads: the number of threads used to process the new Flow</li>
<li>other_config:n-revalidator-threads: the number of threads used to validate the Flow</li>
<li>other_config:enable-statistics: whether to count the following items
<ul>
<li>statistics:cpu: statistics on the number of CPUs, threads</li>
<li>statistics:load_average: system load</li>
<li>statistics:memory: total RAM, Swap</li>
<li>statistics:process_NAME: statistics memory size, cpu time, etc. (with NAME replaced by a process name)</li>
<li>statistics:file_systems: mount point, size, used</li>
</ul>
</li>
<li>client request id: cur_cfg and next_cfg, when a Client finishes modifying the database, next_cfg adds 1, then wait for OvS to apply the changes, when the application is finished, cur_cfg adds 1, at this time cur_cfg equals next_cfg. This configuration is obviously there to ensure consistency for highly concurrent requests.</li>
<li>The configuration for ovsdb-server points to the Manager table, ovs-vswitchd as one of the Clients of ovsdb-server, and the Manager configures the DB Connection field.</li>
<li>Configuration of the SSL DB Connection: points to the SSL table, which mainly configures the path to the private key, certificate, etc. files needed for SSL secure communication.</li>
</ul>
</li>
</ul>
<h2 id="operational-objects-of-open-vswitch">Operational Objects of Open vSwitch</h2>
<p>The database structure is a mapping of a software&rsquo;s resource model design, and the following is an overview of the characteristics and roles of each resource object based on the resource model of OvS.</p>
<h3 id="manager">Manager</h3>
<p>The Manager object is used to configure the connection of ovsdb-server so that Clients (e.g. ovs-vswitchd, ovs-vsctl, host) can perform DB operations on ovsdb-server remotely. server is the RPC interface for ovs-db to provide management. The manager_options field in the Open_vSwitch table is loaded as the listening port.</p>
<p>The table structure of Manager</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/1fd7fe41079b4e8abf7485a6ca4d9c7f.png" alt="The table structure of Manager"></p>
<p>The most important field is <strong>target</strong>, which records information about the ovsdb-server&rsquo;s listening parameters.</p>
<ul>
<li>Active database connection methods.
<ul>
<li><code>ssl:ip[:port]</code> : listens on the Port of the specified Remote IP, protocol is SSL</li>
<li><code>tcp:ip[:port]</code> : Listens on the Port of the specified Remote IP, protocol is TCP</li>
<li><code>unix:FILE</code> : Unix domain socket named FILE</li>
</ul>
</li>
<li>Passive database connection methods:
<ul>
<li><code>pssl:[port][:ip]</code> : Listens on the specified Port of the local IP, protocol is SSL</li>
<li><code>ptcp:[port][:ip]</code> : Listens on the specified Port of the local IP, protocol is TCP</li>
</ul>
</li>
</ul>
<p>Set by the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovs-vsctl set-manager TARGET...      <span class="c1"># set the list of managers to TARGET...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Active Listener</span>
</span></span><span class="line"><span class="cl">ovs-vsctl set-manager tcp:1.2.3.4:6640
</span></span><span class="line"><span class="cl"><span class="c1"># Passive Listener </span>
</span></span><span class="line"><span class="cl">ovs-vsctl set-manager ptcp:6640
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE</strong>: TCP-based DB Connection that allows ovs-vsctl to control ovsdb-server even on remote machines.</p>
<h4 id="configuring-manager-ovs-db-connection">Configuring Manager OvS DB Connection</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl set-manager ptcp:8881</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;ptcp:8881&#34;</span>
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovsdb-client dump</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Manager table
</span></span><span class="line"><span class="cl">_uuid                                connection_mode external_ids inactivity_probe is_connected max_backoff other_config status                                                               target
</span></span><span class="line"><span class="cl">------------------------------------ --------------- ------------ ---------------- ------------ ----------- ------------ -------------------------------------------------------------------- -----------
</span></span><span class="line"><span class="cl">84f0a33c-a798-40fc-a285-ed4d83121d3e <span class="o">[]</span>              <span class="o">{}</span>           <span class="o">[]</span>               <span class="nb">false</span>        <span class="o">[]</span>          <span class="o">{}</span>           <span class="o">{</span><span class="nv">bound_port</span><span class="o">=</span><span class="s2">&#34;8881&#34;</span>, <span class="nv">sec_since_connect</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>, <span class="nv">sec_since_disconnect</span><span class="o">=</span><span class="s2">&#34;0&#34;</span><span class="o">}</span> <span class="s2">&#34;ptcp:8881&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check that the Port is turned on properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># netstat -lpntu | grep 8881</span>
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:8881            0.0.0.0:*               LISTEN      3024/ovsdb-server
</span></span></code></pre></td></tr></table>
</div>
</div><p>To perform a connection from a remote computer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl --db=tcp:192.168.1.109:8881 show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;ptcp:8881&#34;</span>
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE</strong> : Note the firewall interference factor.</p>
<h3 id="ssl">SSL</h3>
<p>If the Open vSwitch is configured to connect to the OpenFlow controller over the network (between ovs-vswitchd and ovs-controller), then it is recommended that you use OpenSSL to build secure network communications. Bidirectional SSL ensures the integrity and and security of the OpenFlow connection to each other.</p>
<p>To establish an SSL connection, you first need to obtain the relevant CA certificates and record these certificates in the SSL table. When you start ovsdb-server, you can use the option <code>-private-key=db:Open_vSwitch,SSL,private_key --certificate=db:Open_vSwitch,SSL,certificate --bootstrap-ca-cert =db:Open_vSwitch,SSL,ca_cert</code> to specify that these parameters are applied.</p>
<p><strong>SSL Table Structure</strong>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/5ec54955efaa473d90a29fd05f6a3cfc.png" alt="SSL Table Structure"></p>
<p><strong>SSL Table Properties</strong> :</p>
<ul>
<li>private_key: private key</li>
<li>ca_cert: CA root certificate</li>
<li>bootstrap_ca_cert (Boolean): If True, the latest CA certificate is obtained from the Controller every time ovsdb-server is started. Otherwise, the old CA certificate will continue to be used.</li>
<li>certificate: the certificate issued by CA</li>
</ul>
<p>The public key of the host (client) is included in the certificate issued by CA, and then signed by the private key of the CA center, which guarantees that the certificate is legitimate. In order to verify the CA signature, the public key of CA is also needed and put into the CA certificate pointed to by ca_cert. The CA&rsquo;s own public key also needs to be guaranteed by the CA with higher signature or the CA (root CA) itself.</p>
<p><strong>SSL verification process</strong>:</p>
<ol>
<li>
<p>client holds CA root certificate (ca_cert) and verifies it with CA private key (CA root certificate is self-issued by CA through its own private key), if the verification is successful, it means the CA is the root CA and can guarantee itself.</p>
</li>
<li>
<p>the client holds the certificate (certificate, containing the client&rsquo;s public key) issued by the CA and verifies it with the CA root certificate (the certificate issued by the CA can be unlocked with the CA&rsquo;s private key), and returns the client&rsquo;s public key if the verification is successful.</p>
</li>
<li>
<p>the client holds its own private key and verifies it with the client&rsquo;s public key unlocked by the CA, and if the verification is successful, the client is guaranteed by the CA.</p>
</li>
<li>
<p>The client establishes an SSL connection with the server.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/c5d6a04d86964a388e7542092d14b39b.png" alt="SSL verification process"></p>
</li>
<li>
<p>In short, the client needs to ensure that it has its own private key, a CA-issued certificate, and a CA root certificate in order to complete SSL authentication.</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查询 SSL 连接</span>
</span></span><span class="line"><span class="cl">ovs-vsctl get-ssl
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 SSL 证书</span>
</span></span><span class="line"><span class="cl">ovs-vsctl set-ssl sc-privkey.pem sc-cert.pem cacert.pem
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 SSL 连接</span>
</span></span><span class="line"><span class="cl">ovs-vsctl del-ssl
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="configuring-ssl-connection">Configuring SSL Connection</h4>
<p><strong>Self-issuing CA Root Certificate</strong>:</p>
<ul>
<li>Step 1. Generate the RSA private key for the CA root certificate</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir ~/OVS_CA
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ~/OVS_CA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl genrsa -out caprivate.key <span class="m">1024</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Step 2. generate the signing request (CSR) for the CA root certificate</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">openssl req -key caprivate.key -new -subj <span class="s2">&#34;/C=CN/ST=CN/L=CN/O=CN/CN=fanguiju@163.com&#34;</span> -out cacertificate.req
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Step 3. issue your own CA root certificate (with the CA&rsquo;s public key included)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">openssl x509 -req -in cacertificate.req -signkey caprivate.key -out cacertificate.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>PS</strong> : Self-issued, i.e., you guarantee yourself and issue your own CSR with your own private key, so it is also called a root certificate.</p>
<p><strong>Issuance of client certificate</strong>.</p>
<ul>
<li>Step 1. Generate the client private key</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir ~/ClientCerts
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ~/ClientCerts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl genrsa -out cliu8private.key <span class="m">1024</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Step 2. generating client-side signature requests</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">openssl req -key cliu8private.key -new -subj <span class="s2">&#34;/C=CN/ST=CN/L=CN/O=CN/CN=cliu8@163.com&#34;</span> -out cliu8certificate.req
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Step 3. CA center issues client certificate (CA center guarantees the client)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cp ~/OVS_CA/caprivate.key ~/OVS_CA/cacertificate.pem ~/ClientCerts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl x509 -req -in cliu8certificate.req -CA cacertificate.pem -CAkey caprivate.key -out cliu8certificate.pem -CAcreateserial
</span></span><span class="line"><span class="cl"><span class="m">123</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Configuring the SSL Connection</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovs-vsctl del-manager
</span></span><span class="line"><span class="cl">ovs-vsctl set-manager pssl:8881
</span></span><span class="line"><span class="cl">ovs-vsctl set-ssl /root/ClientCerts/cliu8private.key /root/ClientCerts/cliu8certificate.pem /root/OVS_CA/cacertificate.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE</strong> : set-ssl must specify the absolute path, otherwise the certificate file will not be loaded correctly.</p>
<p><strong>VIEW MODIFY</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost newcerts<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;pssl:8881&#34;</span>
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovsdb-client dump</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">SSL table
</span></span><span class="line"><span class="cl">_uuid                                bootstrap_ca_cert ca_cert                          certificate                              external_ids private_key
</span></span><span class="line"><span class="cl">------------------------------------ ----------------- -------------------------------- ---------------------------------------- ------------ ------------------------------------
</span></span><span class="line"><span class="cl">f8d8f0f5-f87b-430b-9d48-123a74a6804f <span class="nb">false</span>             <span class="s2">&#34;/root/OVS_CA/cacertificate.pem&#34;</span> <span class="s2">&#34;/root/ClientCerts/cliu8certificate.pem&#34;</span> <span class="o">{}</span>           <span class="s2">&#34;/root/ClientCerts/cliu8private.key&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Authentication</strong>.</p>
<ul>
<li>At this point, if you do not enter the PKI configuration, you will not be able to pass SSL authentication</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl --db=ssl:192.168.1.109:8881 show</span>
</span></span><span class="line"><span class="cl">2019-02-23T06:46:26Z<span class="p">|</span>00001<span class="p">|</span>stream_ssl<span class="p">|</span>ERR<span class="p">|</span>Private key must be configured to use SSL
</span></span><span class="line"><span class="cl">2019-02-23T06:46:26Z<span class="p">|</span>00002<span class="p">|</span>stream_ssl<span class="p">|</span>ERR<span class="p">|</span>Certificate must be configured to use SSL
</span></span><span class="line"><span class="cl">2019-02-23T06:46:26Z<span class="p">|</span>00003<span class="p">|</span>stream_ssl<span class="p">|</span>ERR<span class="p">|</span>CA certificate must be configured to use SSL
</span></span><span class="line"><span class="cl">2019-02-23T06:46:26Z<span class="p">|</span>00004<span class="p">|</span>reconnect<span class="p">|</span>WARN<span class="p">|</span>ssl:192.168.1.109:8881: connection attempt failed <span class="o">(</span>Protocol not available<span class="o">)</span>
</span></span><span class="line"><span class="cl">ovs-vsctl: ssl:192.168.1.109:8881: database connection failed <span class="o">(</span>Protocol not available<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Copy copies of cliu8private.key, cliu8certificate.pem, and cacertificate.pem to the client</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">scp cliu8private.key cliu8certificate.pem cacertificate.pem root@192.168.1.110:~/certs
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Request an SSL connection on the client side</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost certs<span class="o">]</span><span class="c1">#  ovs-vsctl --db=ssl:192.168.1.109:8881 --private-key=cliu8private.key --certificate=cliu8certificate.pem --ca-cert=cacertificate.pem show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;pssl:8881&#34;</span>
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE</strong> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PKI configuration <span class="o">(</span>required to use SSL<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  -p, --private-key<span class="o">=</span>FILE  file with private key
</span></span><span class="line"><span class="cl">  -c, --certificate<span class="o">=</span>FILE  file with certificate <span class="k">for</span> private key
</span></span><span class="line"><span class="cl">  -C, --ca-cert<span class="o">=</span>FILE      file with peer CA certificate
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bridge">Bridge</h3>
<p>Bridge means bridge, but in Linux semantics Bridge has the same meaning as Ethernet switch and is the core object of Open vSwitch. The following is a list of common OvS Bridge operations.</p>
<h4 id="bridge-common-operation-commands">Bridge Common Operation Commands</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Bridge commands:
</span></span><span class="line"><span class="cl">  add-br BRIDGE               create a new bridge named BRIDGE
</span></span><span class="line"><span class="cl">  add-br BRIDGE PARENT VLAN   create new fake BRIDGE in PARENT on VLAN
</span></span><span class="line"><span class="cl">  del-br BRIDGE               delete BRIDGE and all of its ports
</span></span><span class="line"><span class="cl">  list-br                     print the names of all the bridges
</span></span><span class="line"><span class="cl">  br-exists BRIDGE            <span class="nb">exit</span> <span class="m">2</span> <span class="k">if</span> BRIDGE does not exist
</span></span><span class="line"><span class="cl">  br-to-vlan BRIDGE           print the VLAN which BRIDGE is on
</span></span><span class="line"><span class="cl">  br-to-parent BRIDGE         print the parent of BRIDGE
</span></span><span class="line"><span class="cl">  br-set-external-id BRIDGE KEY VALUE  <span class="nb">set</span> KEY on BRIDGE to VALUE
</span></span><span class="line"><span class="cl">  br-set-external-id BRIDGE KEY  <span class="nb">unset</span> KEY on BRIDGE
</span></span><span class="line"><span class="cl">  br-get-external-id BRIDGE KEY  print value of KEY on BRIDGE
</span></span><span class="line"><span class="cl">  br-get-external-id BRIDGE  list key-value pairs on BRIDGE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Bridge 管理操作</span>
</span></span><span class="line"><span class="cl">ovs-vsctl show
</span></span><span class="line"><span class="cl">ovs-vsctl add-br &lt;bridge&gt;
</span></span><span class="line"><span class="cl">ovs-vsctl del-br &lt;bridge&gt;
</span></span><span class="line"><span class="cl">ovs-vsctl --if-exists del-br &lt;bridge&gt;
</span></span><span class="line"><span class="cl">ovs-vsctl add-port &lt;bridge&gt; &lt;port&gt;<span class="p">|</span>&lt;interface&gt;
</span></span><span class="line"><span class="cl">ovs-vsctl del-port &lt;bridge&gt; &lt;port&gt;<span class="p">|</span>&lt;interface&gt;
</span></span><span class="line"><span class="cl">ovs-vsctl list &lt;bridge&gt;<span class="p">|</span>&lt;port&gt;<span class="p">|</span>&lt;interface&gt;
</span></span><span class="line"><span class="cl">ovs-vsctl list bridge &lt;bridge&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 创建 Bridge 的同时为 Bridge 添加 Port/Interface</span>
</span></span><span class="line"><span class="cl">ovs−vsctl add−br &lt;bridge&gt; -- add−port &lt;bridge&gt; &lt;port&gt;<span class="p">|</span>&lt;interface&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/30adc865c1a14fb5931571232ab80307.png" alt="Bridge"></p>
<ul>
<li>Creating a virtual switch.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl add-br ubuntu_br</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;ptcp:8881&#34;</span>
</span></span><span class="line"><span class="cl">    Bridge ubuntu_br
</span></span><span class="line"><span class="cl">        Port ubuntu_br
</span></span><span class="line"><span class="cl">            Interface ubuntu_br
</span></span><span class="line"><span class="cl">                type: internal
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Creating a virtual &ldquo;netline&rdquo; (VETH pair).</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ip link add first_br type veth peer name first_if</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ip link add second_br type veth peer name second_if</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ip link add third_br type veth peer name third_if</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>View newly created devices.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ip l</span>
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">2: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast state UP mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 00:0c:29:a2:2e:a4 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">3: ovs-system: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether f6:66:5f:f9:ba:17 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">4: ubuntu_br: &lt;BROADCAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UNKNOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 46:ca:9f:ed:0b:46 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">5: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 52:54:00:69:fc:47 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">6: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu <span class="m">1500</span> qdisc pfifo_fast master virbr0 state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 52:54:00:69:fc:47 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">7: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast master virbr0 state UNKNOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether fe:54:00:b8:9a:cf brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">8: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast master virbr0 state UNKNOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether fe:54:00:43:07:06 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">9: vnet2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast master virbr0 state UNKNOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether fe:54:00:ce:e6:40 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">10: first_if@first_br: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 46:df:83:a6:66:bc brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">11: first_br@file_if: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 72:90:6d:0d:4b:e0 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">12: second_if@second_br: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 6a:68:8f:38:86:a2 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">13: second_br@second_if: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 86:8d:e3:32:03:b4 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">14: third_if@third_br: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 5e:72:4c:9b:4d:18 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">15: third_br@third_if: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span class="m">1500</span> qdisc noop state DOWN mode DEFAULT qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether a2:cf:5f:72:da:23 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Connecting one end of the virtual &ldquo;network cable&rdquo; to the virtual switch.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl add-port ubuntu_br first_br</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl add-port ubuntu_br second_br</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl add-port ubuntu_br third_br</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;ptcp:8881&#34;</span>
</span></span><span class="line"><span class="cl">    Bridge ubuntu_br
</span></span><span class="line"><span class="cl">        Port ubuntu_br
</span></span><span class="line"><span class="cl">            Interface ubuntu_br
</span></span><span class="line"><span class="cl">                type: internal
</span></span><span class="line"><span class="cl">        Port first_br
</span></span><span class="line"><span class="cl">            Interface first_br
</span></span><span class="line"><span class="cl">        Port second_br
</span></span><span class="line"><span class="cl">            Interface second_br
</span></span><span class="line"><span class="cl">        Port third_br
</span></span><span class="line"><span class="cl">            Interface third_br
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>NOTE: The eponymous Port of Bridge ubuntu_br is generally the management port of the Bridge, analogous to the management port of a physical switch, for which an IP address is generally configured.</p>
<h3 id="controller">Controller</h3>
<p>OvS is an OpenFlow Switch implementation, which can unify the management of all distributed Bridges through OpenFlow Controlle. The so-called &ldquo;management&rdquo; is actually the management of the Bridge&rsquo;s Flow Table. The core of <strong>SDN Controller is to control the issuance of policies and use them to make decisions about the flow of data</strong> .</p>
<p><strong>Controller has two types</strong>.</p>
<ul>
<li><strong>Primary Controller</strong>: Really controls the Bridge&rsquo;s Flow Table. The Bridge maintains a connection to the Controller, and if the connection fails or is disconnected, it depends on the Bridge&rsquo;s Fail Mode to handle it. A Bridge can connect to multiple Controllers, but the collaboration between Controllers needs to be done by the Controllers themselves.</li>
<li><strong>Service Controller</strong>: Used only for Support, occasional operation, Maintain use, Bridge&rsquo;s Fail Mode will not work if Connection is disconnected from Bridge.</li>
</ul>
<p><strong>OvS provides the following two Fail Modes</strong> for the Bridge.</p>
<ul>
<li><strong>Secure</strong>: After disconnecting, the Bridge tries to reconnect to the Controller until it succeeds, and does not maintain its own Flow Table.</li>
<li><strong>Standalone</strong>: If the Bridge fails to connect to the Controller after three attempts, it will create and maintain its own independent Flow Table.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查询 Bridge 的 Fail Mode</span>
</span></span><span class="line"><span class="cl">ovs-vsctl get-fail-mode ovs-br
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 Bridge 的 Fail Mode</span>
</span></span><span class="line"><span class="cl">ovs-vsctl set-fail-mode ovs-br standalone
</span></span><span class="line"><span class="cl">ovs-vsctl set-fail-mode ovs-br secure
</span></span><span class="line"><span class="cl"><span class="c1"># 移除 Bridge 的 Fail Mode</span>
</span></span><span class="line"><span class="cl">ovs-vsctl del-fail-mode ovs-br
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看 Bridge 和 Controller 的连接模式</span>
</span></span><span class="line"><span class="cl">ovs-vsctl get controller ovs-br connection-mode
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 Out-of-band 连接模式</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> controller ovs-br connection-mode<span class="o">=</span>out-of-band
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 In-band (default) 连接模式</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> controller ovs-br connection-mode<span class="o">=</span>in-band
</span></span><span class="line"><span class="cl"><span class="c1"># 移除 hidden flow</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> bridge br0 other-config:disable-in-band<span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Controller table structure</strong>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/7ebf5069a4fc4120a80ea32bddbad106.png" alt="Controller table structure"></p>
<h4 id="controller-common-commands">Controller Common Commands</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 设置 Controller</span>
</span></span><span class="line"><span class="cl">ovs-vsctl set-controller &lt;bridge&gt; tcp:&lt;controller_ip&gt;:6633
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 Multi Controller</span>
</span></span><span class="line"><span class="cl">ovs-vsctl set-controller &lt;bridge&gt; tcp:&lt;controller_ip1&gt;:6633 tcp:&lt;controller_ip2&gt;:6633
</span></span><span class="line"><span class="cl"><span class="c1"># 获取 Bridge 的 Controller</span>
</span></span><span class="line"><span class="cl">ovs-vsctl get-controller &lt;bridge&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 移除 Controller</span>
</span></span><span class="line"><span class="cl">ovs-vsctl del-controller &lt;bridge&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="install-floodlight">Install Floodlight</h4>
<p>There are various types of OpenFlow Controllers, such as OpenDaylight, etc. A detailed list can be found at <a href="http://groups.geni.net/geni/wiki/OpenFlow/Controllers">OpenFlow Controllers in GENI</a>&quot;. This article takes Floodlight as an example to feel the controller&rsquo;s flow control function for Bridge.</p>
<p>Official website: <a href="http://www.projectfloodlight.org/getting-started/">http://www.projectfloodlight.org/getting-started/</a>
Official deployment manual: <a href="https://floodlight.atlassian.net/wiki/spaces/floodlightcontroller/pages/1343544/Installation+Guide">https://floodlight.atlassian.net/wiki/spaces/floodlightcontroller/pages/1343544/Installation+Guide</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/38d23c3e62744d03a20ceb9f05dde012.png" alt="Install Floodlight"></p>
<p><strong>Installing Floodlight</strong> ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone git://github.com/floodlight/floodlight.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> floodlight/
</span></span><span class="line"><span class="cl">git submodule init
</span></span><span class="line"><span class="cl">git submodule update
</span></span><span class="line"><span class="cl">ant
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo mkdir /var/lib/floodlight
</span></span><span class="line"><span class="cl">sudo mkdir /var/log/floodlight
</span></span><span class="line"><span class="cl">sudo chmod <span class="m">777</span> /var/lib/floodlight
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE</strong> : Tag version 1.2 is used here</p>
<p><strong>Running Floodlight in the Terminal</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nohup java -jar ~/floodlight/target/floodlight.jar &gt; /var/log/floodlight/floodlight.log 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Check the Controller&rsquo;s listening port</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat /var/log/floodlight/floodlight.log | grep &#34;Listening for switch connections&#34;</span>
</span></span><span class="line"><span class="cl">09:28:16.102 INFO <span class="o">[</span>n.f.c.i.OFSwitchManager:main<span class="o">]</span> Listening <span class="k">for</span> switch connections on /0.0.0.0:6653
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># netstat -lpntu | grep 6653</span>
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::6653                 :::*                    LISTEN      20159/java
</span></span></code></pre></td></tr></table>
</div>
</div><p>NOTE: Floodlight will get the Bridge connection by listening to <code>/0.0.0.0:6653</code> socket.</p>
<p><strong>Connecting Bridge to Controller</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost floodlight-1.2<span class="o">]</span><span class="c1"># ovs-vsctl set-controller ubuntu_br tcp:192.168.1.109:6653</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost floodlight-1.2<span class="o">]</span><span class="c1"># ovs-vsctl show</span>
</span></span><span class="line"><span class="cl">2028eafc-e1db-4ea8-b0fc-30a21fdaca0f
</span></span><span class="line"><span class="cl">    Manager <span class="s2">&#34;ptcp:8881&#34;</span>
</span></span><span class="line"><span class="cl">    Bridge ubuntu_br
</span></span><span class="line"><span class="cl">        Controller <span class="s2">&#34;tcp:192.168.1.109:6633&#34;</span>
</span></span><span class="line"><span class="cl">        Port ubuntu_br
</span></span><span class="line"><span class="cl">            Interface ubuntu_br
</span></span><span class="line"><span class="cl">                type: internal
</span></span><span class="line"><span class="cl">        Port third_br
</span></span><span class="line"><span class="cl">            Interface third_br
</span></span><span class="line"><span class="cl">        Port first_br
</span></span><span class="line"><span class="cl">            Interface first_br
</span></span><span class="line"><span class="cl">        Port second_br
</span></span><span class="line"><span class="cl">            Interface second_br
</span></span><span class="line"><span class="cl">    ovs_version: <span class="s2">&#34;2.0.0&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>NOTE: Once the Bridge is connected to the Controller, the Controller can collect, send and manage information about the Bridge (e.g. Flow Table).</p>
<p><strong>Access to Web GUI</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">http://192.168.1.109:8080/ui/index.html
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="connecting-kvm-virtual-machines-to-the-ovs-bridge">Connecting KVM Virtual Machines to the OvS Bridge</h4>
<p><strong>Plugging three KVM virtual machines into the Bridge</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># virsh domiflist VM1</span>
</span></span><span class="line"><span class="cl">Interface  Type       Source     Model       MAC
</span></span><span class="line"><span class="cl">-------------------------------------------------------
</span></span><span class="line"><span class="cl">macvtap1   direct     ubuntu_br  rtl8139     52:54:00:b8:9a:cf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># virsh domiflist VM2</span>
</span></span><span class="line"><span class="cl">Interface  Type       Source     Model       MAC
</span></span><span class="line"><span class="cl">-------------------------------------------------------
</span></span><span class="line"><span class="cl">macvtap0   direct     ubuntu_br  rtl8139     52:54:00:43:07:06
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># virsh domiflist VM3</span>
</span></span><span class="line"><span class="cl">Interface  Type       Source     Model       MAC
</span></span><span class="line"><span class="cl">-------------------------------------------------------
</span></span><span class="line"><span class="cl">macvtap2   direct     ubuntu_br  rtl8139     52:54:00:ce:e6:40
</span></span><span class="line"><span class="cl"><span class="m">1234567891011121314</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>NOTE</strong> : VM1, 2 and 3 are all connected to the same Bridge, so as long as all three have the IP address of the network segment, they can communicate.</p>
<p><strong>Check the Floodlight Dashboard</strong>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/30a296e8025e41758a205a11ce25c7e4.png" alt="Check the Floodlight Dashboard"></p>
<p>Wait for a period of time and Floodlight will collect the Bridges on the host, Hosts on the Bridge, IP/MAC addresses of the Hosts, etc.</p>
<h4 id="floodlight-controller-common-commands">Floodlight Controller Common Commands</h4>
<p>The Floodlight Dashboard is basically a display only, so most of the operations still need to be done through the command line.</p>
<ul>
<li>Request the DPID of all Switches on this Controller</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://localhost:8080/wm/core/controller/switches/json
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>View stream table entries</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://localhost:8080/wm/staticflowentrypusher/list/all/json
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>View the flow table entries for the specified Switch</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://192.168.1.109:8080/wm/core/switch/00:00:46:ca:9f:ed:0b:46/flow/json
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Add static flow table entries</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -d <span class="s1">&#39;{&#34;switch&#34;: &#34;00:00:00:00:00:00:00:01&#34;, &#34;name&#34;:&#34;flow-mod-1&#34;, &#34;cookie&#34;:&#34;0&#34;, &#34;priority&#34;:&#34;32768&#34;, &#34;ingress-port&#34;:&#34;1&#34;, &#34;active&#34;:&#34;true&#34;, &#34;actions&#34;:&#34;output=2&#34;}&#39;</span> http://localhost:8080/wm/staticflowentrypusher/json
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Static flow tables that allow only 10.0.0.101 and 10.0.0.103 to ping each other</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># VM1</span>
</span></span><span class="line"><span class="cl">curl -d <span class="s1">&#39;{&#34;switch&#34;: &#34;00:00:46:ca:9f:ed:0b:46&#34;, &#34;name&#34;:&#34;static-flow2&#34;, &#34;cookie&#34;:&#34;0&#34;, &#34;priority&#34;:&#34;32768&#34;, &#34;src-mac&#34;:&#34;52:54:00:b8:9a:cf&#34;,&#34;active&#34;:&#34;true&#34;, &#34;actions&#34;:&#34;output=10&#34;}&#39;</span>  http://localhost:8080/wm/staticflowentrypusher/json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># VM3</span>
</span></span><span class="line"><span class="cl">curl -d <span class="s1">&#39;{&#34;switch&#34;: &#34;00:00:46:ca:9f:ed:0b:46&#34;, &#34;name&#34;:&#34;static-flow1&#34;, &#34;cookie&#34;:&#34;0&#34;, &#34;priority&#34;:&#34;32768&#34;, &#34;src-mac&#34;:&#34;52:54:00:ce:e6:40&#34;,&#34;active&#34;:&#34;true&#34;, &#34;actions&#34;:&#34;output=12&#34;}&#39;</span>  http://localhost:8080/wm/staticflowentrypusher/json
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Delete the specified flow table</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X DELETE -d <span class="s1">&#39;{&#34;name&#34;:&#34;flow-mod-1&#34;}&#39;</span> http://localhost:8080/wm/staticflowentrypusher/json
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Delete all flow tables for a given Switch</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl http://localhost:8080/wm/staticflowentrypusher /clear/&lt;dpid&gt;/json
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mirror">Mirror</h3>
<p>The function of Mirror is to configure a Bridge to send certain packets with certain conditions to the specified Mirrored Ports.</p>
<p>The packet conditions are the following.</p>
<ul>
<li>select_all</li>
<li>select_dst_port</li>
<li>select_src_port</li>
<li>select_vlan</li>
</ul>
<p>The designated purpose Ports are either.</p>
<ul>
<li>output_port (SPAN Switched Port ANalyzer)</li>
<li>output_vlan (RSPAN Remote Switched Port ANalyzer)</li>
</ul>
<h4 id="span">SPAN</h4>
<p><strong>Source (SPAN) port</strong> - A port that is monitored with use of the SPAN feature.
<strong>Destination (SPAN) port</strong> - A port that monitors source ports, usually where a network analyzer is connected.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/5bac11f599af4629a9cd18b8d458026e.png" alt="SPAN"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovs-vsctl add-br ovs-br
</span></span><span class="line"><span class="cl">ovs-vsctl add-port ovs-br eth0
</span></span><span class="line"><span class="cl">ovs-vsctl add-port ovs-br eth1
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 SPAN Mirrors，将 ovs-br 上 add-port {eth0,eth1} Mirror 至 tap0</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port ovs-br tap0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     -- --id<span class="o">=</span>@p get port tap0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     -- --id<span class="o">=</span>@m create mirror <span class="nv">name</span><span class="o">=</span>m0 <span class="k">select</span>-all<span class="o">=</span><span class="nb">true</span> output-port<span class="o">=</span>@p <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>     -- <span class="nb">set</span> bridge ovs-br <span class="nv">mirrors</span><span class="o">=</span>@m
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 SPAN Mirrors</span>
</span></span><span class="line"><span class="cl">ovs-vsctl clear bridge ovs-br mirrors
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="rspan">RSPAN</h4>
<ul>
<li>The monitored traffic is not sent to a specified port, but Flooded to a specified VLAN</li>
<li>The listening port does not have to be on the local Switch, it can be on any Switch in the specified VLAN</li>
<li>S1 is a source switch</li>
<li>S2 and S3 are intermediate switches</li>
<li>S4 and S5 are destination switches.</li>
<li>learning is disabled to enable flooding</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/5b66f91c8a024345965916234be810d0.png" alt="RSPAN"></p>
<h3 id="port-and-interface">Port and Interface</h3>
<p>A Port is a port of a Bridge, and each Port belongs to a Bridge, while an Interface is a network interface device connected to a Port and is actually responsible for receiving and sending packets. Normally, Port and Interface have a one-to-one relationship, but when Port is configured in bond mode, Port:Interface is a 1:N relationship.</p>
<p><strong>Port has the following 3 types</strong>.</p>
<ul>
<li><strong>Normal</strong>: You can mount an existing NIC (physical or virtual) from HostOS to the Bridge, and OvS will generate a Port with the same name on the Bridge to handle the packets to and from this NIC. Note that networks mounted to the Bridge do not support the assignment of IP addresses.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 将物理网卡接口 eth1 加入 Bridge br-ext</span>
</span></span><span class="line"><span class="cl"><span class="c1"># br-ex 会自动创建同名的 Port eth1</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port br-ext eth1
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Internal</strong> : is a virtual NIC interface created internally by OvS. Whenever an Internal type Port is created, OvS automatically creates an internal Interface with the same name on HostOS and mounts it to the Port. Only the Internal type Interface device supports configuring IP address information.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 创建一个 Port p0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@ovs ~<span class="o">]</span><span class="c1"># ovs-vsctl add-port ovs-switch p0 -- set Interface p0 ofport_request=100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设定 Port p0 的 Interface p0 为 Internal 类型</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@ovs ~<span class="o">]</span><span class="c1"># ovs-vsctl set Interface p0 type=internal</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># OvS 自动创建 Interface p0 设备</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@ovs ~<span class="o">]</span><span class="c1"># ip a</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">5: p0: &lt;BROADCAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UNKNOWN qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 5a:d7:49:85:d9:da brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet6 fe80::58d7:49ff:fe85:d9da/64 scope link
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Patch</strong>: When there are multiple OvS Bridges on HostOS, you can connect two Bridges together using Patch Port (Virtual Wire Port).Patch Port always comes in pairs, connected to two bridges, and packets received from one Patch Port will be forwarded to the other Patch Port. Similar to the VETH Pair in Linux, two bridges connected with a Patch Port are no different from one.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovs-vsctl add-br br0
</span></span><span class="line"><span class="cl">ovs-vsctl add-br br1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用 Patch Port 连接两个 Bridge</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-- add-port br0 patch0 -- <span class="nb">set</span> interface patch0 <span class="nv">type</span><span class="o">=</span>patch options:peer<span class="o">=</span>patch1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-- add-port br1 patch1 -- <span class="nb">set</span> interface patch1 <span class="nv">type</span><span class="o">=</span>patch options:peer<span class="o">=</span>patch0
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Tunnel</strong>: Common tunneling technologies are GRE or VxLAN. tunneling is the construction of a virtual network on top of an existing physical network, with the upper layer applications related only to the virtual network, thus enabling a more flexible virtual network configuration than the physical network and enabling L2 communication across hosts. Tunneling allows Bridges on different hosts to interoperate as if they were connected to a single large Bridge.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Host A，192.168.7.21</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-br br-vxlan
</span></span><span class="line"><span class="cl"><span class="c1"># Host B，192.168.7.23</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-br br-vxlan
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Host A 上添加连接到 Host B 的 Tunnel Port</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port br-vxlan tun0 -- <span class="nb">set</span> Interface tun0 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>192.168.7.23
</span></span><span class="line"><span class="cl"><span class="c1"># Host B 上添加连接到 Host A 的 Tunnel Port</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port br-vxlan tun0 -- <span class="nb">set</span> Interface tun0 <span class="nv">type</span><span class="o">=</span>vxlan options:remote_ip<span class="o">=</span>192.168.7.21
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>netdev: generic NIC device (e.g. eth0, veth)
<ul>
<li>Receive: A netdev receives a message at L2 and processes it directly through the OvS receive function, without going through the traditional kernel TCP/IP stack.</li>
<li>send: A stream in OvS specifying that it is sent from that netdev is sent through that NIC device.</li>
</ul>
</li>
<li>internal: Virtual NIC device
<ul>
<li>Receive: The OvS receive processing function is entered when a message from the system is routed to be sent through this device.</li>
<li>send: When a flow in OvS is formulated to be sent from this internal device, the message is reinjected into the kernel stack.</li>
</ul>
</li>
<li>gre device: tunnel device (no matter how many GRE tunnels are created in user state, there is one and only one GRE device in kernel state)
<ul>
<li>Receive: When the system receives a GRE message, it is passed to the L4 layer to parse the gre header and then passed to the OvS receive processing function.</li>
<li>Send: A flow in OvS is formulated to be sent from this GRE device, and the message will be sent according to the flow table rules plus the GRE header and the outer wrapper IP, and find the route.</li>
</ul>
</li>
</ul>
<h4 id="vlan-for-port">VLAN for Port</h4>
<p>An important feature of the Port is VLAN Configuration, which has two types.</p>
<ul>
<li>Trunk Port</li>
<li>Access Port</li>
</ul>
<p>Trunk Port.</p>
<ul>
<li>This port is not configured with Tag, configured with trunks.</li>
<li>If trunks is empty, then all VLANs are trunked and the default VLAN ID is 0, all are allowed to pass.</li>
<li>If trunks is not empty, only VLANs that match the condition (ID) can pass.</li>
</ul>
<p>In short, it is the Trunk port of the physical switch that matches the VLAN ID of the Trunks list to pass through.</p>
<p>Access Port.</p>
<ul>
<li>This Port is configured with a Tag, and packets coming in from this Port are tagged with a Tag (ID).</li>
<li>If a packet coming in from another Trunk Port has a VLAN ID of its own, it will be sent out from this Port if the VLAN ID is equal to the Tag of this Port.</li>
<li>Packets coming in from other Access Ports with the same Tag will also be Forwarded to this Port.</li>
<li>Packets out of an Access Port are stripped of their Tag and do not carry a VLAN ID.</li>
<li>If a packet arrives at the Access Port with a VLAN ID of its own, even if the VLAN ID is equal to the Tag, it is discarded and the Access Port only accepts Untag packets.</li>
</ul>
<p>In short, packets received by the Access Port are tagged and the Access Port only accepts Untag packets, otherwise they are discarded. Packets with the same VLAN ID are forwarded to the corresponding Access Port and then untagged for retransmission.</p>
<h4 id="vlan-common-operation-commands-for-port">VLAN common operation commands for Port</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 添加 Port 并设置 VLAN tag，ID 为 3</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port &lt;bridge&gt; &lt;vlan_access_interface&gt; <span class="nv">tag</span><span class="o">=</span><span class="m">3</span> -- <span class="nb">set</span> interface &lt;vlan_access_interface&gt; <span class="nv">type</span><span class="o">=</span>internal
</span></span><span class="line"><span class="cl"><span class="c1"># 为已存在的 Port 设置 VLAN tag，ID 为 9</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> port &lt;port&gt; <span class="nv">tag</span><span class="o">=</span><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 移除 VLAN tag</span>
</span></span><span class="line"><span class="cl">ovs-vsctl del-port &lt;bridge&gt; &lt;vlan_access_interface&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 查询 VLAN</span>
</span></span><span class="line"><span class="cl">ifconfig &lt;vlan_access_interface&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 Vlan Trunk</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-port &lt;bridge&gt; &lt;vlan_trunk_interface&gt; <span class="nv">trunk</span><span class="o">=</span>3,4,5,6
</span></span><span class="line"><span class="cl"><span class="c1"># 添加设置 VLAN 的 Flow，ID 为 100</span>
</span></span><span class="line"><span class="cl">ovs-ofctl add-flow &lt;bridge&gt; <span class="nv">in_port</span><span class="o">=</span>1,dl_vlan<span class="o">=</span>0xffff,actions<span class="o">=</span>mod_vlan_vid:100,output:3
</span></span><span class="line"><span class="cl">ovs-ofctl add-flow &lt;bridge&gt; <span class="nv">in_port</span><span class="o">=</span>1,dl_vlan<span class="o">=</span>0xffff,actions<span class="o">=</span>push_vlan:0x8100,set_field:100-<span class="se">\&gt;</span>vlan_vid,output:3
</span></span><span class="line"><span class="cl"><span class="c1"># 添加摘除 VLAN tag 的 Flow</span>
</span></span><span class="line"><span class="cl">ovs-ofctl add-flow &lt;bridge&gt; <span class="nv">in_port</span><span class="o">=</span>3,dl_vlan<span class="o">=</span>100,actions<span class="o">=</span>strip_vlan,output:1
</span></span><span class="line"><span class="cl"><span class="c1"># ovs-ofctl add-flow pop-vlan</span>
</span></span><span class="line"><span class="cl">ovs-ofctl add-flow ovs-br <span class="nv">in_port</span><span class="o">=</span>3,dl_vlan<span class="o">=</span>0xffff,actions<span class="o">=</span>pop_vlan,output:1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="bonding-of-ports">Bonding of Ports</h4>
<p>The relationship between Port and Interface is a one-to-many relationship because OvS supports the Bond feature. Bonding is the process of &ldquo;bundling&rdquo; multiple Interfaces together to form a virtual connection, thus achieving high availability and high throughput.</p>
<p>Common bond_modes are as follows.</p>
<ul>
<li>active-backup: Failover, where one connection is active and the others are backup.</li>
<li>balance-slb: Load balancing, load balancing based on source MAC and output VLAN.</li>
<li>balance-tcp: Load balancing, must support LACP protocol to do so, can load balance based on L2, L3, L4.</li>
<li>stable (LACP): Attempts to always assign a given flow to the same slave consistently.</li>
</ul>
<p>PS: LACP (Link Aggregation Control Protocol).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/64ffdaaf21224b15931719a6018fb401.png" alt="Link Aggregation Control Protocol"></p>
<p><strong>Bond model for OvS</strong>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/a92505b96f884148ad1577526c43b6eb.png" alt="Bond model for OvS"></p>
<h4 id="qos-for-ports">QoS for Ports</h4>
<p>Qos in OvS is often used in conjunction with Flow Policy. It is well known that QoS has two directions, one for Ingress and one for Egress.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/ce95c5c932914e3a83edfba1bf4aaf45.png" alt="QoS for Ports"></p>
<h4 id="network-process-qos-implementation-principles-and-methods">Network Process QoS Implementation Principles and Methods</h4>
<p>The most commonly used network QoS on Linux is the TC tool, which is mainly implemented by means of <strong>Queuing</strong>.</p>
<ol>
<li>
<p><strong>Classless Queuing Disciplines</strong>: default is pfifo_fast, a technique that does not classify network packets. pfifo_fast checks the corresponding Band in the priomap of TOS according to the number corresponding to the TOS in the network packet, and different Bands correspond to different queues.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/03143126497d45aab909cc069ed8d131.png" alt="Classless Queuing Disciplines"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/4ecaf01e6cf74573aa42952ecccf33df.png" alt="Classless Queuing Disciplines"></p>
</li>
<li>
<p><strong>SFQ, Stochastic Fair Queuing</strong>: There are many queues of FIFOs, and TCP sessions or UDP streams are assigned to a queue. Packets are RoundRobin&rsquo;d from each queue and sent. This way one Session does not take up all the traffic. But instead of having a queue for each Session, a large number of Sessions are assigned to a limited number of queues through a Hash algorithm. This way two or more Sessions will share a queue and may affect each other. Therefore, the Hash function changes frequently so that Sessions do not always affect each other.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/3965d043ca104c74ba33a5a8305b6372.png" alt="SFQ, Stochastic Fair Queuing"></p>
</li>
<li>
<p><strong>TBF, Token Bucket Filter</strong>: All network packets are queued for sending, but not at the head of the queue, but only when the packet has a Token. tokens are generated according to a set rate (Rate), so even if the queue is long, they are sent according to the Rate. When there are no packets in the queue, Tokens are still generated at a set rate, but they do not accumulate indefinitely until the Buckets are full, and the size of the Buckets is often set by the burst/buffer/maxburst parameter. Token, then suddenly a large number of packets come in and each one gets a Token, resulting in an instant traffic spike.</p>
</li>
<li>
<p><strong>Classful Queuing Disciplines</strong>: typical of these is <strong>HTB, Hierarchical Token Bucket</strong>.</p>
</li>
</ol>
<ul>
<li>
<p>Shaping: Occurs only at leaf nodes and depends on other Queues.</p>
</li>
<li>
<p>Borrowing: When network resources are free, borrow some for my use.</p>
</li>
<li>
<p>Rate: The set rate.</p>
</li>
<li>
<p>Ceil: The maximum rate. The difference between Ceil and Rate indicates the maximum amount that can be borrowed from others.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/8a37623403dc4c0185b53bb635ce3759.png" alt="*HTB, Hierarchical Token Bucket"></p>
</li>
</ul>
<h4 id="create-an-htb-hierarchical-token-bucket-tree-using-tc">Create an HTB (Hierarchical Token Bucket) tree using TC</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/6f98618b53a447bd80eaed40ab65518f.png" alt="HTB tree"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 创建一个 HTB 的 qdisc 在 eth0 上，句柄为 1:，default 12 表示默认发送给 1:12。</span>
</span></span><span class="line"><span class="cl">tc qdisc add dev eth0 root handle 1: htb default <span class="m">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建一个 root class，然后再创建几个 sub class。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 同一个 root class 下的 sub class 可以相互借流量，如果直接不在 qdisc下面创建一个 root class，而是直接创建三个 class，他们之间是不能相互借流量的。</span>
</span></span><span class="line"><span class="cl">tc class add dev eth0 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps
</span></span><span class="line"><span class="cl">tc class add dev eth0 parent 1:1 classid 1:10 htb rate 30kbps ceil 100kbps
</span></span><span class="line"><span class="cl">tc class add dev eth0 parent 1:1 classid 1:11 htb rate 10kbps ceil 100kbps
</span></span><span class="line"><span class="cl">tc class add dev eth0 parent 1:1 classid 1:12 htb rate 60kbps ceil 100kbps
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建叶子 qdisc，分别为 fifo 和 sfq。</span>
</span></span><span class="line"><span class="cl">tc qdisc add dev eth0 parent 1:10 handle 20: pfifo limit <span class="m">5</span>
</span></span><span class="line"><span class="cl">tc qdisc add dev eth0 parent 1:11 handle 30: pfifo limit <span class="m">5</span>
</span></span><span class="line"><span class="cl">tc qdisc add dev eth0 parent 1:12 handle 40: sfq perturb <span class="m">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设定规则：从 IP 1.2.3.4 来的并且发送给 port 80 的包，从 1:10 走；其他从 1.2.3.4 发送来的包从 1:11 走；其他的走默认。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 实现了限速与分流。</span>
</span></span><span class="line"><span class="cl">tc filter add dev eth0 protocol ip parent 1:0 prio <span class="m">1</span> u32 match ip src 1.2.3.4 match ip dport <span class="m">80</span> 0xffff flowid 1:10
</span></span><span class="line"><span class="cl">tc filter add dev eth0 protocol ip parent 1:0 prio <span class="m">1</span> u32 match ip src 1.2.3.4 flowid 1:11
</span></span></code></pre></td></tr></table>
</div>
</div><p>In fact, the only thing OvS can control is the Egress QoS, which is implemented through Shaping. The Ingress QoS cannot be controlled, but only the specified packets can be dropped by Policy.</p>
<p><strong>Ingress policy</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> Interface tap0 <span class="nv">ingress_policing_rate</span><span class="o">=</span><span class="m">100000</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> Interface tap0 <span class="nv">ingress_policing_burst</span><span class="o">=</span><span class="m">10000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Egress shaping</strong> : Port QoS policy is only supported for HTB.</p>
<ul>
<li>QoS can be created on the Port</li>
<li>A QoS can have multiple Queues</li>
<li>Rules are set via Flow</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/0bc134570b354b32b393534dc6bdde8b.png" alt="Egress shaping"></p>
<h3 id="tunnel">Tunnel</h3>
<p>OvS supports three types of tunnels, all of which are described in the Networking Basics Terminology/Concepts, and will not be repeated.</p>
<ul>
<li>GRE</li>
<li>VxLAN</li>
<li>IPSec_gre</li>
</ul>
<h4 id="example-of-ovs-tunnel-operation-command">Example of OvS Tunnel operation command</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Instance1</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-br testbr
</span></span><span class="line"><span class="cl">ifconfig testbr 10.0.0.1/24
</span></span><span class="line"><span class="cl">ovs-vsctl add-port testbr gre0 -- <span class="nb">set</span> Interface gre0 <span class="nv">type</span><span class="o">=</span>gre options:local_ip<span class="o">=</span>192.168.100.100 options:remote_ip<span class="o">=</span>192.168.100.101
</span></span><span class="line"><span class="cl">ovs-vsctl add-port testbr vxlan0 -- <span class="nb">set</span> Interface vxlan0 <span class="nv">type</span><span class="o">=</span>vxlan options:local_ip<span class="o">=</span>192.168.100.100 options:remote_ip<span class="o">=</span>192.168.100.102
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Instance2</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-br testbr
</span></span><span class="line"><span class="cl">ifconfig testbr 10.0.0.2/24
</span></span><span class="line"><span class="cl">ovs-vsctl add-port testbr gre0 -- <span class="nb">set</span> Interface gre0 <span class="nv">type</span><span class="o">=</span>gre options:local_ip<span class="o">=</span>192.168.100.101 options:remote_ip<span class="o">=</span>192.168.100.100
</span></span><span class="line"><span class="cl">ovs-vsctl add-port testbr ipsec0 -- <span class="nb">set</span> Interface ipsec0 <span class="nv">type</span><span class="o">=</span>ipsec_gre options:local_ip<span class="o">=</span>192.168.100.101 options:remote_ip<span class="o">=</span>192.168.100.102 options:psk<span class="o">=</span>password
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Instance3</span>
</span></span><span class="line"><span class="cl">ovs-vsctl add-br testbr
</span></span><span class="line"><span class="cl">ifconfig testbr 10.0.0.3/24
</span></span><span class="line"><span class="cl">ovs-vsctl add-port testbr vxlan0 -- <span class="nb">set</span> Interface vxlan0 <span class="nv">type</span><span class="o">=</span>vxlan options:local_ip<span class="o">=</span>192.168.100.102 options:remote_ip<span class="o">=</span>192.168.100.100
</span></span><span class="line"><span class="cl">ovs-vsctl add-port testbr ipsec0 -- <span class="nb">set</span> Interface ipsec0 <span class="nv">type</span><span class="o">=</span>ipsec_gre options:local_ip<span class="o">=</span>192.168.100.102 options:remote_ip<span class="o">=</span>192.168.100.101 options:psk<span class="o">=</span>password
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># enable STP，避免环导致的洪泛（Flood）</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Spanning Tree Protocol，即通过协议，将一个有环的二层网络变成一颗树。</span>
</span></span><span class="line"><span class="cl">ovs-vsctl <span class="nb">set</span> Bridge testbr <span class="nv">stp_enable</span><span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/12e88c22d7e347658af6b4e49166565a.png" alt="OvS Tunnel "></p>
<h3 id="flow-tables">Flow Tables</h3>
<p>Open vSwitch defines a series of Flow Tables that control the flow and structure of network packets.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/31af0bf4914c498f9502ca7704da333b.png" alt="Flow Tables">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/cc035adcdcf34978917b3eaa9b8dc9d0.png" alt="Flow Tables"></p>
<p>According to the OpenFlow protocol, a Flow Entry should consist of two parts.</p>
<ul>
<li><strong>Match Field</strong></li>
<li><strong>Action</strong></li>
</ul>
<p>If the packet matches the Match then the Action is executed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/0ce80ebc950a4cedbccb73c25da3de3b.png" alt="packet matches"></p>
<p>Match Field parses network packets covering all layers of the TCP/IP protocol family, with the following fields to see if they can match a value.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/22/15e338abf1514e908045aa34873a8510.png" alt="Match Field parses network packets"></p>
<ul>
<li>Layer 1 - Tunnel ID, In Port, QoS priority, skb mark</li>
<li>Layer 2 - MAC address, VLAN ID, Ethernet type</li>
<li>Layer 3 - IPv4/IPv6 fields, ARP</li>
<li>Layer 4 - TCP/UDP, ICMP, ND</li>
</ul>
<p>Action mainly contains the following actions.</p>
<ul>
<li>Output to port (port range, flood, mirror)</li>
<li>Discard, Resubmit to table x</li>
<li>Packet Mangling (Push/Pop VLAN header, TOS, …)</li>
<li>Send to controller, Learn</li>
</ul>
<h4 id="common-flow-table-operations-commands">Common Flow Table Operations Commands</h4>
<p>The management of Flow Table by OvS is mainly done through the ovs-ofctl utility.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看 Bridge 的流表</span>
</span></span><span class="line"><span class="cl">ovs-ofctl show &lt;bridge&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 查询指定 Bridge 的流表</span>
</span></span><span class="line"><span class="cl">ovs-ofctl dump-flows &lt;bridge&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 添加 Bridge 的流表</span>
</span></span><span class="line"><span class="cl">ovs-ofctl add−flow &lt;bridge&gt; &lt;flow&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># e.g.</span>
</span></span><span class="line"><span class="cl">ovs-ofctl add-flow ovs_br <span class="nv">dl_src</span><span class="o">=</span>02:a2:a2:a2:a2:a2,dl_dst<span class="o">=</span>02:b2:b2:b2:b2:b2,in_port<span class="o">=</span>2,dl_type<span class="o">=</span>0x0800,nw_src<span class="o">=</span>10.0.0.1,nw_dst<span class="o">=</span>10.0.0.2,actions<span class="o">=</span>output:6
</span></span><span class="line"><span class="cl"><span class="c1"># 修改 Bridge 的流表</span>
</span></span><span class="line"><span class="cl">ovs-ofctl mod−flows &lt;bridge&gt; &lt;flow&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 Bridge 的指定流表</span>
</span></span><span class="line"><span class="cl">ovs-ofctl del−flows &lt;bridge&gt; &lt;flow&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># e.g.</span>
</span></span><span class="line"><span class="cl">ovs-ofctl del-flows &lt;bridge&gt; <span class="nv">dl_src</span><span class="o">=</span>02:a2:a2:a2:a2:a2,dl_dst<span class="o">=</span>02:b2:b2:b2:b2:b2,in_port<span class="o">=</span>2,dl_type<span class="o">=</span>0x0800,nw_src<span class="o">=</span>10.0.0.1,nw_dst<span class="o">=</span>10.0.0.2
</span></span><span class="line"><span class="cl"><span class="c1"># 删除 Bridge 的所有流表</span>
</span></span><span class="line"><span class="cl">ovs-ofctl del-flows &lt;bridge&gt;   <span class="c1"># This will delete all the flow entries in the flow table</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/open-vswitch/">open vswitch</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/go-efficient/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Golang&#39;s efficient development model</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/kubernetes-security/">
            <span class="next-text nav-default">Kubernetes Best Practices Guide for Security</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
