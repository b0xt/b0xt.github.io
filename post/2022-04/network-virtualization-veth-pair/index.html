<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>[Network Virtualization] Veth Pair - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the Veth Pair in Network Virtualization." /><meta name="keywords" content="Network Virtualization, Veth Pair" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/network-virtualization-veth-pair/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="[Network Virtualization] Veth Pair" />
<meta property="og:description" content="Explore the Veth Pair in Network Virtualization." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/network-virtualization-veth-pair/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-30T11:37:36+08:00" />
<meta property="article:modified_time" content="2022-04-30T11:37:36+08:00" />

<meta itemprop="name" content="[Network Virtualization] Veth Pair">
<meta itemprop="description" content="Explore the Veth Pair in Network Virtualization."><meta itemprop="datePublished" content="2022-04-30T11:37:36+08:00" />
<meta itemprop="dateModified" content="2022-04-30T11:37:36+08:00" />
<meta itemprop="wordCount" content="623">
<meta itemprop="keywords" content="network virtualization," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Network Virtualization] Veth Pair"/>
<meta name="twitter:description" content="Explore the Veth Pair in Network Virtualization."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">[Network Virtualization] Veth Pair</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-30 11:37:36 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 623 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>A veth virtual network device is connected to a protocol stack on one end and another veth device on the other end instead of a physical network. A packet sent out of a pair of veth devices goes directly to another veth device. Each veth device can be configured with an IP address and participate in the Layer 3 IP network routing process.</p>
<p>The following is an example of a typical veth device pair.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/30/f9574f5503e14990b59b2cb2dfce443e.png" alt=" an example of a typical veth device pair."></p>
<p>We configure the physical NIC eth0 with an IP of 12.124.10.11, and the veth devices that appear in pairs are veth0 and veth1 with IPs of 20.1.0.10 and 20.1.0.11, respectively.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># ip link add veth0 type veth peer name veth1
</span></span><span class="line"><span class="cl"># ip addr add 20.1.0.10/24 dev veth0
</span></span><span class="line"><span class="cl"># ip addr add 20.1.0.11/24 dev veth1
</span></span><span class="line"><span class="cl"># ip link set veth0 up
</span></span><span class="line"><span class="cl"># ip link set veth1 up
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then try to ping the other device veth1 from veth0 device:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ping -c 2 20.1.0.11 -I veth0</span>
</span></span><span class="line"><span class="cl">PING 20.1.0.11 <span class="o">(</span>20.1.0.11<span class="o">)</span> from 20.1.0.11 veth0: 28<span class="o">(</span>42<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.1.0.11: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.034 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 20.1.0.11: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.052 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 20.1.0.11 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1500ms
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: In some Ubuntu devices, the ping may not work because the default kernel network configuration causes the veth device pair to fail to return ARP packets. The solution is.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># echo 1 &gt; /proc/sys/net/ipv4/conf/veth1/accept_local</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo 1 &gt; /proc/sys/net/ipv4/conf/veth0/accept_local</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo 0 &gt; /proc/sys/net/ipv4/conf/veth0/rp_filter</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo 0 &gt; /proc/sys/net/ipv4/conf/veth1/rp_filter</span>
</span></span><span class="line"><span class="cl"><span class="c1"># echo 0 &gt; /proc/sys/net/ipv4/conf/all/rp_filter</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can try using tcpdump to see the request packets on the veth device pair.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># tcpdump -n -i veth1</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on veth1, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">458122</span> bytes
</span></span><span class="line"><span class="cl">20:24:12.220002 ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">20:24:12.220198 ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">20:24:12.221372 IP 20.1.0.10 &gt; 20.1.0.11: ICMP <span class="nb">echo</span> request, id 18174, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">20:24:13.222089 IP 20.1.0.10 &gt; 20.1.0.11: ICMP <span class="nb">echo</span> request, id 18174, seq 2, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that there are only ICMP echo request packets on veth1, but no answer packets. If you think about it, veth1 receives the ICMP echo request packet and forwards it to the protocol stack at the other end, but the protocol stack checks the current device list and finds that there is <code>20.1.0.10</code> locally, so it constructs the ICMP echo reply packet and forwards it to the lo device, which receives the packet and hands it directly to the protocol stack and then gives it to the ping process in user space. After receiving the packet, the lo device directly hands it over to the protocol stack and then to the ping process in user space.</p>
<p>We can try to capture the data on the lo device using tcpdump.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># tcpdump -n -i lo</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on lo, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">458122</span> bytes
</span></span><span class="line"><span class="cl">20:25:49.486019 IP IP 20.1.0.11 &gt; 20.1.0.10: ICMP <span class="nb">echo</span> reply, id 24177, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">20:25:50.4861228 IP IP 20.1.0.11 &gt; 20.1.0.10: ICMP <span class="nb">echo</span> reply, id 24177, seq 2, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It follows that for pairs of veth devices that appear in pairs, packets going out from one device are sent directly to the other device. In practical application scenarios, such as container networks, pairs of veth device pairs are in different <a href="https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/">network namespaces</a> and packets are forwarded between between network namespaces, which will be explained in detail later when introducing container networks.</p>
<hr>
<p>Reference <code>https://houmin.cc/posts/680a2369/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/network-virtualization/">network virtualization</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/network-virtualization-bridge/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">[Network Virtualization] Bridge</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/network-virtualization-tun-tap/">
            <span class="next-text nav-default">[Network Virtualization] TUN/TAP</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
