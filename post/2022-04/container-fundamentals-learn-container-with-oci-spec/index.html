<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Pprinciple of container technology (1): from the fundamental understanding of the container image - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the principles of container technology. Understand the OCI specification, image specification, runtime specification." /><meta name="keywords" content="docker, Oci, OverlayFS" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/container-fundamentals-learn-container-with-oci-spec/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Pprinciple of container technology (1): from the fundamental understanding of the container image" />
<meta property="og:description" content="Learn the principles of container technology. Understand the OCI specification, image specification, runtime specification." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/container-fundamentals-learn-container-with-oci-spec/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-16T14:09:10+08:00" />
<meta property="article:modified_time" content="2022-04-16T14:09:10+08:00" />

<meta itemprop="name" content="Pprinciple of container technology (1): from the fundamental understanding of the container image">
<meta itemprop="description" content="Learn the principles of container technology. Understand the OCI specification, image specification, runtime specification."><meta itemprop="datePublished" content="2022-04-16T14:09:10+08:00" />
<meta itemprop="dateModified" content="2022-04-16T14:09:10+08:00" />
<meta itemprop="wordCount" content="3406">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pprinciple of container technology (1): from the fundamental understanding of the container image"/>
<meta name="twitter:description" content="Learn the principles of container technology. Understand the OCI specification, image specification, runtime specification."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Pprinciple of container technology (1): from the fundamental understanding of the container image</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-16 14:09:10 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3406 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#starting-with-the-oci-specification">Starting with the OCI specification</a></li>
        <li><a href="#image-specification">Image Specification</a>
          <ul>
            <li><a href="#whats-inside-the-image">What&rsquo;s inside the image</a></li>
            <li><a href="#how-to-delete-a-file-in-a---image-layer">How to delete a file in a   image layer</a></li>
            <li><a href="#how-to-merge-multiple---image-layers-into-a-single-file-system">How to merge multiple   image layers into a single file system</a></li>
            <li><a href="#how-overlayfs-in-docker-works">How OverlayFS in Docker works</a></li>
          </ul>
        </li>
        <li><a href="#runtime-specification">Runtime specification</a>
          <ul>
            <li><a href="#container-lifecycle">Container lifecycle</a></li>
            <li><a href="#the-essence-of-a-container-is-a-process">The essence of a container is a process</a></li>
          </ul>
        </li>
        <li><a href="#implementation-and-ecology">Implementation and Ecology</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="starting-with-the-oci-specification">Starting with the OCI specification</h2>
<p>The OCI (Open Container Initiative) specification is the de facto container standard that has been adopted by most container implementations and container orchestration systems, including Docker and Kubernetes, and was introduced in 2015 by Dokcer as the lead company.</p>
<p>Starting with the OCI specification to understand container images allows us to build a clearer picture of container technology rather than getting bogged down in implementation details. The OCI specification is divided into two parts, <code>Image spec</code> and <code>Runtime spec</code>, which cover different phases of the container lifecycle.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/16/0826639db340430e97b1d00d2fb858d2.png" alt="OCI specification"></p>
<h2 id="image-specification">Image Specification</h2>
<p>The image specification defines how to create an OCI-compliant image. It specifies the content and format that the image&rsquo;s build system needs to output, and the output container image can be unpacked into a <code>runtime bundle</code>, which is a folder consisting of specific files and directory structures from which the container can be run according to runtime standards.</p>
<h3 id="whats-inside-the-image">What&rsquo;s inside the image</h3>
<p>The specification requires that the contents of the image must include the following 3 parts.</p>
<ul>
<li><strong>Image Manifest</strong>: Provides configuration and filesystem layer location information for an image, which can be thought of as a directory for the image, in <code>json</code> file format.</li>
<li><strong>Image Layer Filesystem Changeset</strong>: serialized filesystem and filesystem changes that can be applied sequentially layer by layer as a container rootfs, so often also called a <code>layer</code> (synonymous with the image layer mentioned below), file format can be <code>tar</code>, <code>gzip</code> and other archive or compressed formats.</li>
<li><strong>Image Configuration</strong>: contains the execution parameters used by the image at runtime as well as ordered rootfs change information, file type <code>json</code>.</li>
</ul>
<p><em>rootfs (root file system), the file system mounted by the <code>/</code> root mount point, is the files, configurations, and directories contained in an operating system, but not the operating system kernel, which is shared by all containers on the same machine with the kernel of the host operating system.</em></p>
<p>Next, let&rsquo;s explore the actual contents of an image using <code>Docker</code> and <code>nginx</code> as examples. Pull a recent version of the <code>nginx</code> image, save it as a tar file, and extract it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ docker pull nginx
</span></span><span class="line"><span class="cl">$ docker save nginx -o nginx-img.tar
</span></span><span class="line"><span class="cl">$ mkdir nginx-img
</span></span><span class="line"><span class="cl">$ tar -xf nginx-img.tar --directory<span class="o">=</span>nginx-img
</span></span></code></pre></td></tr></table>
</div>
</div><p>Get the contents of the <code>nginx-img</code> directory as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">nginx-img
</span></span><span class="line"><span class="cl">├── 013a6edf61f54428da349193e7a2077a714697991d802a1c5298b07dbe0519c9
</span></span><span class="line"><span class="cl">│   ├── json
</span></span><span class="line"><span class="cl">│   ├── layer.tar
</span></span><span class="line"><span class="cl">│   └── VERSION
</span></span><span class="line"><span class="cl">├── 2bf70c858e6c8243c4713064cf43dea840866afefe52089a3b339f06576b930e
</span></span><span class="line"><span class="cl">│   ├── json
</span></span><span class="line"><span class="cl">│   ├── layer.tar
</span></span><span class="line"><span class="cl">│   └── VERSION
</span></span><span class="line"><span class="cl">├── 490a3e67a61048564048a15d501b8e075d951d0dbba8098d5788bb8453f2371f
</span></span><span class="line"><span class="cl">│   ├── json
</span></span><span class="line"><span class="cl">│   ├── layer.tar
</span></span><span class="line"><span class="cl">│   └── VERSION
</span></span><span class="line"><span class="cl">├── 4cdc5dd7eaadff5080649e8d0014f2f8d36d4ddf2eff2fdf577dd13da85c5d2f.json
</span></span><span class="line"><span class="cl">├── 761c908ee54e7ccd769e815f38e3040f7b3ff51f1c04f55aac12b9ea3d544cfe
</span></span><span class="line"><span class="cl">│   ├── json
</span></span><span class="line"><span class="cl">│   ├── layer.tar
</span></span><span class="line"><span class="cl">│   └── VERSION
</span></span><span class="line"><span class="cl">├── 96bfd5bf4ab4c2513fb43534d51e816c4876620767858377d14dcc5a7de5f1fd
</span></span><span class="line"><span class="cl">│   ├── json
</span></span><span class="line"><span class="cl">│   ├── layer.tar
</span></span><span class="line"><span class="cl">│   └── VERSION
</span></span><span class="line"><span class="cl">├── d18832ef411b346c36b7ba42a6c2e3f77097026fb80651c2d870f19c6fd9ccef
</span></span><span class="line"><span class="cl">│   ├── json
</span></span><span class="line"><span class="cl">│   ├── layer.tar
</span></span><span class="line"><span class="cl">│   └── VERSION
</span></span><span class="line"><span class="cl">├── manifest.json
</span></span><span class="line"><span class="cl">└── repositories
</span></span></code></pre></td></tr></table>
</div>
</div><p>First look at the contents of the <code>manifest.json</code> file, which is the Image Manifest for the image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ python -m json.tool manifest.json
</span></span><span class="line"><span class="cl"><span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Config&#34;</span>: <span class="s2">&#34;4cdc5dd7eaadff5080649e8d0014f2f8d36d4ddf2eff2fdf577dd13da85c5d2f.json&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Layers&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;490a3e67a61048564048a15d501b8e075d951d0dbba8098d5788bb8453f2371f/layer.tar&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;2bf70c858e6c8243c4713064cf43dea840866afefe52089a3b339f06576b930e/layer.tar&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;013a6edf61f54428da349193e7a2077a714697991d802a1c5298b07dbe0519c9/layer.tar&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;761c908ee54e7ccd769e815f38e3040f7b3ff51f1c04f55aac12b9ea3d544cfe/layer.tar&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;d18832ef411b346c36b7ba42a6c2e3f77097026fb80651c2d870f19c6fd9ccef/layer.tar&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;96bfd5bf4ab4c2513fb43534d51e816c4876620767858377d14dcc5a7de5f1fd/layer.tar&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">]</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;RepoTags&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;nginx:latest&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It contains the file location information for <code>Config</code> and <code>Layers</code>, which are the Image Layer Filesystem Changeset and Image Configuration as specified in the standard.</p>
<p><code>Config</code> is stored in a separate json file, which is more extensive than we can show, and contains the following information.</p>
<ul>
<li>The configuration of the image, which will be written to the runtime configuration file after the image is extracted into a <code>runtime bundle</code>.</li>
<li>Diff IDs between the <code>layers</code> of the   images.</li>
<li>Meta information such as the build history of the   image.</li>
</ul>
<p>The tar files in the <code>Layers</code> list together form the rootfs of the generated container, the image of the container is built in layers, the order of the elements in <code>Layers</code> also represents the order of the stack of   image layers, all <code>layers</code> form a stack structure from bottom to top. Let&rsquo;s first look at the contents of the base layer, the first record.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ mkdir base
</span></span><span class="line"><span class="cl">$ tar -xf 490a3e67a61048564048a15d501b8e075d951d0dbba8098d5788bb8453f2371f/layer.tar --directory<span class="o">=</span>base
</span></span></code></pre></td></tr></table>
</div>
</div><p>The contents of the extracted file in the <code>base</code> directory are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">drwxr-xr-x  2 root root 4096 6月  21 08:00 bin
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  13 18:30 boot
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  21 08:00 dev
</span></span><span class="line"><span class="cl">drwxr-xr-x 28 root root 4096 6月  21 08:00 etc
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  13 18:30 home
</span></span><span class="line"><span class="cl">drwxr-xr-x  7 root root   85 6月  21 08:00 lib
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root   34 6月  21 08:00 lib64
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  21 08:00 media
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  21 08:00 mnt
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  21 08:00 opt
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  13 18:30 proc
</span></span><span class="line"><span class="cl">drwx------  2 root root   37 6月  21 08:00 root
</span></span><span class="line"><span class="cl">drwxr-xr-x  3 root root   30 6月  21 08:00 run
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root 4096 6月  21 08:00 sbin
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  21 08:00 srv
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 6月  13 18:30 sys
</span></span><span class="line"><span class="cl">drwxrwxrwt  2 root root    6 6月  21 08:00 tmp
</span></span><span class="line"><span class="cl">drwxr-xr-x 10 root root  105 6月  21 08:00 usr
</span></span><span class="line"><span class="cl">drwxr-xr-x 11 root root  139 6月  21 08:00 var
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is already a complete rootfs, look at the contents of the file obtained from the top layer of <code>layer</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">96bfd5bf4ab4c2513fb43534d51e816c4876620767858377d14dcc5a7de5f1fd/
</span></span><span class="line"><span class="cl">└── docker-entrypoint.d
</span></span><span class="line"><span class="cl">    └── 30-tune-worker-processes.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is only one shell script file, which means that the image is built incrementally, with each layer containing only the contents of files that have changed compared to lower layers, which is why the container image is kept small.</p>
<h3 id="how-to-delete-a-file-in-a---image-layer">How to delete a file in a   image layer</h3>
<p>Each layer in <code>Layers</code> is a ChangeSet for the file system, and the ChangeSet contains three kinds of changes: add, modify and delete. The case of adding or modifying (replacing) a file is better handled, but how to delete a file when applying a ChangeSet? The answer is to use Whiteouts to indicate the file or folder to be deleted.</p>
<p>A Whiteouts file is an empty file with a special filename, and the prefix <code>.wh.</code> added to the base name of the path to be deleted in the filename indicates that a path (at a lower layer) should be deleted. Suppose there are the following files in a <code>layer</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">./etc/my-app.d/
</span></span><span class="line"><span class="cl">./etc/my-app.d/default.cfg
</span></span><span class="line"><span class="cl">./bin/my-app-tools
</span></span><span class="line"><span class="cl">./etc/my-app-config
</span></span></code></pre></td></tr></table>
</div>
</div><p>If a higher level <code>layer</code> of the application contains <code>. /etc/.wh.my-app-config</code>, the original <code>. /etc/my-app-config</code> path will be removed when that layer is changed.</p>
<h3 id="how-to-merge-multiple---image-layers-into-a-single-file-system">How to merge multiple   image layers into a single file system</h3>
<p>The specification has only a schematic description of how to apply multiple   image layers into a single file system, so if we want to apply <code>Layer B</code> on top of <code>Layer A</code>.</p>
<ul>
<li>first copy the filesystem directory in <code>Layer A</code> to another snapshot directory <code>A.snapshot</code> with the file attributes preserved</li>
<li>Then execute the file changes contained in <code>Layer B</code> in the snapshot directory, all changes will not affect the original changeset.</li>
</ul>
<p>In practice more efficient implementations such as federated file systems are used.</p>
<h4 id="what-is-union-file-system">What is Union File System</h4>
<p>Union File System, also known as UnionFS, is a system that mounts multiple directories from different locations to the same directory.</p>
<p>The following is an example of Ubuntu distribution and <code>unionfs-fuse</code> implementation to demonstrate the effect of union mount.</p>
<ol>
<li>
<p>First install <code>unionfs-fuse</code>, which is an implementation of UnionFS, using the package manager.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ apt install unionfs-fuse
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Then create the following directory structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">A
</span></span><span class="line"><span class="cl">├── a
</span></span><span class="line"><span class="cl">└── x
</span></span><span class="line"><span class="cl">B
</span></span><span class="line"><span class="cl">├── b
</span></span><span class="line"><span class="cl">└── x
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create directory C and co-mount directories A and B under C.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ unionfs ./B:./A ./C
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The contents of the C directory after mounting are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">C
</span></span><span class="line"><span class="cl">├── a
</span></span><span class="line"><span class="cl">├── b
</span></span><span class="line"><span class="cl">└── x
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>If we edit the x files in directories A and B separately, we will find that accessing the x files in directory C gives us the contents of B/x (because B is higher up in the mount).</p>
</li>
</ol>
<h3 id="how-overlayfs-in-docker-works">How OverlayFS in Docker works</h3>
<p>The current federated filesystem implementation used by most distributions of Docker is <code>overlay2</code>, which is much lighter and more efficient than other implementations, so here is an example to understand how it works.</p>
<p>Following the example of the <code>nginx</code> image above, pull the image and extract the corresponding <code>layer</code> to the <code>/var/lib/docker/overlay2</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ll /var/lib/docker/overlay2 <span class="p">|</span> tee layers.a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">4</span> root root     <span class="m">72</span> 7月  <span class="m">20</span> 17:20 335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">3</span> root root     <span class="m">47</span> 7月  <span class="m">19</span> 10:04 560df35d349e6a750f1139db22d4cb52cba2a1f106616dc1c0c68b3cf11e3df6
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">4</span> root root     <span class="m">72</span> 7月  <span class="m">20</span> 17:20 769a9f5d698522d6e55bd9882520647bd84375a751a67a8ccad1f7bb1ca066dd
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">4</span> root root     <span class="m">72</span> 7月  <span class="m">20</span> 17:20 97aaf293fef495f0f06922d422a6187a952ec6ab29c0aa94cd87024c40e1a7e8
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">4</span> root root     <span class="m">72</span> 7月  <span class="m">20</span> 17:20 a91fb6955249dadfb34a3f5f06d083c192f2774fbec5fbb1db42a04e918432c0
</span></span><span class="line"><span class="cl">brw------- <span class="m">1</span> root root 253, <span class="m">1</span> 7月  <span class="m">19</span> 10:00 backingFsBlockDev
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">4</span> root root     <span class="m">72</span> 7月  <span class="m">20</span> 17:20 fa29ec8cfe5a6c0b2cd1486f27a20a02867126edf654faad7f3520a220f3705f
</span></span><span class="line"><span class="cl">drwx-----x <span class="m">2</span> root root    <span class="m">278</span> 7月  <span class="m">20</span> 17:25 l
</span></span></code></pre></td></tr></table>
</div>
</div><p>We save the output to the <code>layers.a</code> file for later comparison. The six <code>l</code> directories contain the six <code>layers</code> of the   image (the directory names do not correspond to the names in <code>manifest.json</code>), and the <code>l</code> directory contains soft links to the <code>layers</code> folder, mainly for the purpose of shortening the directory identifiers to avoid exceeding the page size limit when executing the <code>mount</code> command.</p>
<p>The contents of each <code>layer</code> folder are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> /var/lib/docker/overlay2/
</span></span><span class="line"><span class="cl">$ ll 335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root root  <span class="m">0</span> 7月  <span class="m">15</span> 17:00 committed
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">33</span> 7月  <span class="m">15</span> 17:00 diff
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">26</span> 7月  <span class="m">15</span> 17:00 link
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">86</span> 7月  <span class="m">15</span> 17:00 lower
</span></span><span class="line"><span class="cl">drwx------ <span class="m">2</span> root root  <span class="m">6</span> 7月  <span class="m">15</span> 17:00 work
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>link</code> records the short links in the <code>l</code> directory, <code>lower</code> records the lower layer of the <code>layer</code> (if there is no such file, the current <code>layer</code> is already the lowest layer, i.e. the base layer), the <code>work</code> directory is used internally by <code>overlay2</code>, and the <code>diff</code> directory holds the contents of the filesystem contained in the <code>layer</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ ll 335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc/diff/
</span></span><span class="line"><span class="cl">drwxr-xr-x  2 root root    6 7月   7 03:39 docker-entrypoint.d
</span></span><span class="line"><span class="cl">drwxr-xr-x 20 root root 4096 7月   7 03:39 etc
</span></span><span class="line"><span class="cl">drwxr-xr-x  5 root root   56 7月   7 03:39 lib
</span></span><span class="line"><span class="cl">drwxrwxrwt  2 root root    6 7月   7 03:39 tmp
</span></span><span class="line"><span class="cl">drwxr-xr-x  7 root root   66 6月  21 08:00 usr
</span></span><span class="line"><span class="cl">drwxr-xr-x  5 root root   41 6月  21 08:00 var
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let&rsquo;s try to run a container based on this image and see the effect of co-mounting during the container phase.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ docker run -d --name nginx_container  nginx
</span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the <code>mount</code> command to confirm the addition of a read/write <code>overlay</code> mount point.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ mount <span class="p">|</span> grep overlay
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">overlay on /var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/merged <span class="nb">type</span> overlay <span class="o">(</span>rw,relatime,lowerdir<span class="o">=</span>/var/lib/docker/overlay2/l/6Y7DPCTGLB6JHUPVBGTOEK2QFN:/var/lib/docker/overlay2/l/QMEEOSTJM2QON4M7PJJBB4KDEF:/var/lib/docker/overlay2/l/XNN2MRN4KWITFTZYLFUSLBP322:/var/lib/docker/overlay2/l/6DC6VDOMBZMLBZBT3QSOWLCR37:/var/lib/docker/overlay2/l/NXYWG253WSMELQKF2E2NH2GWCG:/var/lib/docker/overlay2/l/M4SO5XMO4VXRIJIGUHDMTATWH3:/var/lib/docker/overlay2/l/QI3P6ONJSLQI26DVPFGWIZI2EW,upperdir<span class="o">=</span>/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/diff,workdir<span class="o">=</span>/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/work<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This mount point contains a rootfs that is a combination of all the   image layers <code>layer</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ll /var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/merged
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> 6月  <span class="m">21</span> 08:00 bin
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">13</span> 18:30 boot
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">43</span> 7月  <span class="m">16</span> 16:52 dev
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">41</span> 7月   <span class="m">7</span> 03:39 docker-entrypoint.d
</span></span><span class="line"><span class="cl">-rwxrwxr-x <span class="m">1</span> root root <span class="m">1202</span> 7月   <span class="m">7</span> 03:39 docker-entrypoint.sh
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">19</span> 7月  <span class="m">16</span> 16:52 etc
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">13</span> 18:30 home
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">56</span> 7月   <span class="m">7</span> 03:39 lib
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root   <span class="m">34</span> 6月  <span class="m">21</span> 08:00 lib64
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">21</span> 08:00 media
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">21</span> 08:00 mnt
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">21</span> 08:00 opt
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">13</span> 18:30 proc
</span></span><span class="line"><span class="cl">drwx------ <span class="m">2</span> root root   <span class="m">37</span> 6月  <span class="m">21</span> 08:00 root
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">23</span> 7月  <span class="m">16</span> 16:52 run
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> 6月  <span class="m">21</span> 08:00 sbin
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">21</span> 08:00 srv
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root    <span class="m">6</span> 6月  <span class="m">13</span> 18:30 sys
</span></span><span class="line"><span class="cl">drwxrwxrwt <span class="m">1</span> root root    <span class="m">6</span> 7月   <span class="m">7</span> 03:39 tmp
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">66</span> 6月  <span class="m">21</span> 08:00 usr
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">1</span> root root   <span class="m">19</span> 6月  <span class="m">21</span> 08:00 var
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition to co-mounting the original image layer to the <code>merged</code> directory as shown above, the <code>diff</code> command shows that two new <code>layer</code> directories are added to <code>/var/lib/docker/overlay2</code> after the container runs successfully, and <code>merged</code> is also located in one of them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ll /var/lib/docker/overlay2 <span class="p">|</span> tee layers.b
</span></span><span class="line"><span class="cl">$ diff layers.a layers.b
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; drwx-----x <span class="m">5</span> root root     <span class="m">69</span> 7月  <span class="m">19</span> 10:08 bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011
</span></span><span class="line"><span class="cl">&gt; drwx-----x <span class="m">4</span> root root     <span class="m">72</span> 7月  <span class="m">19</span> 10:08 bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011-init
</span></span><span class="line"><span class="cl">&lt; drwx-----x <span class="m">2</span> root root    <span class="m">210</span> 7月  <span class="m">19</span> 10:08 l
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">&gt; drwx-----x <span class="m">2</span> root root    <span class="m">278</span> 7月  <span class="m">19</span> 10:08 l
</span></span></code></pre></td></tr></table>
</div>
</div><p>Probing the <code>GraphDriver</code> of a running container with the <code>inspect</code> command allows you to see more clearly how the container&rsquo;s <code>layers</code> have changed compared to the   image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ docker inspect nginx_container
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">....
</span></span><span class="line"><span class="cl"><span class="s2">&#34;GraphDriver&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Data&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;LowerDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011-init/diff:/var/lib/docker/overlay2/97aaf293fef495f0f06922d422a6187a952ec6ab29c0aa94cd87024c40e1a7e8/diff:/var/lib/docker/overlay2/fa29ec8cfe5a6c0b2cd1486f27a20a02867126edf654faad7f3520a220f3705f/diff:/var/lib/docker/overlay2/769a9f5d698522d6e55bd9882520647bd84375a751a67a8ccad1f7bb1ca066dd/diff:/var/lib/docker/overlay2/a91fb6955249dadfb34a3f5f06d083c192f2774fbec5fbb1db42a04e918432c0/diff:/var/lib/docker/overlay2/335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc/diff:/var/lib/docker/overlay2/560df35d349e6a750f1139db22d4cb52cba2a1f106616dc1c0c68b3cf11e3df6/diff&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;MergedDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/merged&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;UpperDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/diff&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;WorkDir&#34;</span>: <span class="s2">&#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/work&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Name&#34;</span>: <span class="s2">&#34;overlay2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">....
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>LowerDir</code> records the original   image layer file system, in addition to a new <code>init</code> layer at the top, they are read-only in the container runtime; <code>MergedDir</code> records all the directories of <code>LowerDir</code> for joint mounting mount point; <code>UpperDir</code> is also a new <code>layer</code>, at this time is also a new <code>layer</code>, which is at the top of all the above <code>layers</code> and is read and writeable compared to the other   image layers. The <code>layers</code> of the container stage are shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/16/d273adfff2e742de92c03b19373d0eda.png" alt="The layers of the container stage"></p>
<p>The new writable <code>layer</code> added when creating a container is called <code>container layer</code>, and any changes to the file system during the container runtime are only written to this <code>layer</code>, including additions, modifications and deletions of files, without changing the contents of the original image at lower layers. This greatly improves the efficiency of image distribution. The <code>init</code> layer between the image layer and the <code>container layer</code> records some configuration files written by the container at startup, which happens before the new read/write layer is added, and we do not want to write this data to the original image.</p>
<p>These two new layers exist only during the container runtime, and they will be deleted when the container is deleted. Multiple different containers can be created from the same image, and only multiple different writeable layers need to be created; containers that have been changed at runtime can also be repackaged into a new image by adding the writeable layer to the read-only layer of the new image.</p>
<h4 id="why-containers-are-not-as-efficient-as-native-file-systems-for-reading-and-writing">Why containers are not as efficient as native file systems for reading and writing</h4>
<p>To minimize I/O and reduce image size, a container&rsquo;s federated file system uses a copy-on-write strategy for reading and writing files. If a file or directory exists on a lower tier in the image and another tier (including the writable tier) needs to read access to it, it will access the file on the lower tier directly. The first time another layer needs to write to that file (when building an image or running a container), the file is copied to that layer and modified. This greatly reduces the startup time of the container (the new writeable layer at startup has very few files to write), but each time a file is modified for the first time after the container is running, the entire file needs to be copied to the <code>container layer</code> first.</p>
<p>For the above reasons, the read and write efficiency of container runtime is not as good as the native file system (especially the write efficiency), so it is not suitable to do a lot of file reading and writing in the <code>container layer</code>. Bind Mount) directly in the read-write layer, bypassing the performance loss caused by copy-on-write.</p>
<h2 id="runtime-specification">Runtime specification</h2>
<p>The runtime specification describes the configuration, execution environment and lifecycle of a container. It describes in detail the field format of the configuration file <code>config.json</code> for different container runtime architectures, how to apply and inject these configurations in the execution environment to ensure a consistent environment between different runtimes for programs running inside a container, and defines a uniform set of operational behaviors through the container&rsquo;s lifecycle.</p>
<h3 id="container-lifecycle">Container lifecycle</h3>
<p>The <a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#lifecycle">container lifecycle</a>, as defined by the specification, describes a timeline consisting of events that occur from the creation to the exit of a container, which defines 13 different events, and the following diagram depicts the changes in the container state in the timeline.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/16/fad7531ade024aceb6345ac78f0a1a89.png" alt="Container lifecycle"></p>
<p>Only four <a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#state">container states</a> are defined in the specification, and runtime implementations can add other states to the specification, while the standard also specifies the runtime must support <a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#operations">Operations</a>.</p>
<ul>
<li>Query State, which queries the current state of the container</li>
<li>Create, which creates a new container based on the image and configuration, but does not run the user-specified program</li>
<li>Start, runs the user-specified program in a created container</li>
<li>Kill, send a specific signal to terminate the container process</li>
<li>Delete, which deletes the resources created by the stopped container</li>
</ul>
<p>Each operation is also preceded or followed by different hooks, which must be executed by the compliant runtime.</p>
<h3 id="the-essence-of-a-container-is-a-process">The essence of a container is a process</h3>
<p>The concept of <code>container process</code> is used in the runtime specification. <code>container process</code> is equivalent to the user-specified program and container process mentioned above, and some scenarios also refer to the process as the container&rsquo;s <code>init</code> process. To run a container, you must define the container&rsquo;s <code>container process</code> in <code>config.json</code>, and the fields that can be defined include command parameters, environment parameters, execution paths, and so on.</p>
<p>The change of container state actually reflects the change of <code>container process</code>. We can divide the container&rsquo;s life cycle and state changes into the following phases.</p>
<ol>
<li>Before <code>container process</code> execution.
<ul>
<li>The <code>create</code> command is executed at runtime to create the specified resource based on <code>config.json</code>.</li>
<li>When the resource is created successfully, the container enters the <code>created</code> state.</li>
</ul>
</li>
<li>Execute the <code>container process</code>.
<ul>
<li>The <code>start</code> command is executed at runtime.</li>
<li>The user-specified program, <code>container process</code>, is run at runtime.</li>
<li>The container enters the <code>running</code> state.</li>
</ul>
</li>
<li>The <code>container process</code> process ends, either because the program has finished executing, because of an error or because it has crashed, or because the <code>kill</code> command signals it to terminate at runtime.
<ul>
<li>The container enters the <code>stopped</code> state.</li>
<li>All resources created by the <code>create</code> command are cleared by executing the <code>delete</code> command at runtime.</li>
</ul>
</li>
</ol>
<p>The core of the container runtime is the <code>container process</code>: the image file system satisfies the dependencies needed to run the process, the runtime preparation is to run the process correctly, the runtime continuously monitors the state of the process, once the process is finished the container is declared (temporarily) dead, and the runtime performs the finishing cleanup.</p>
<p>Of course, other processes can be run in the container, but they only share the <code>container process</code> environment.</p>
<h2 id="implementation-and-ecology">Implementation and Ecology</h2>
<p>Docker has donated its container runtime <code>runC</code> project to the OCI specification as a standard implementation of the specification. Most of the container projects that exist today directly use <code>runC</code> as their runtime implementation.</p>
<p>The following diagram summarizes the relationship between Docker-related organizations and projects within the container ecosystem.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/16/7a526ada16684bbaaaa8477f19741743.png" alt="relationship between Docker-related organizations and projects within the container ecosystem"></p>
<p>Kubernetes defines a CRI (Container Runtime Interface) to implement an interchangeable container runtime, and there are several implementations such as <code>cri-containerd</code>, <code>cri-o</code> and <code>docker</code>, but they are all actually based on <code>runC</code> as well.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/16/82ad257a71cb4d758101ff42717fc40e.png" alt="Container Runtime Interface"></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/container-fundamentals-process-isolation-using-namespace/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Principles of container technology (2): using Namespace to achieve process isolation</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/httpie-star-to-zero/">
            <span class="next-text nav-default">54,000 Star all to zero, the project author: very regret</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
