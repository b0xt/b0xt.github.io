<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to improve the security of Docker containers - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to improve the security of Docker containers." /><meta name="keywords" content="docker, security" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/docker-safe/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How to improve the security of Docker containers" />
<meta property="og:description" content="Learn how to improve the security of Docker containers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/docker-safe/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-18T13:32:09+08:00" />
<meta property="article:modified_time" content="2022-04-18T13:32:09+08:00" />

<meta itemprop="name" content="How to improve the security of Docker containers">
<meta itemprop="description" content="Learn how to improve the security of Docker containers."><meta itemprop="datePublished" content="2022-04-18T13:32:09+08:00" />
<meta itemprop="dateModified" content="2022-04-18T13:32:09+08:00" />
<meta itemprop="wordCount" content="1019">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to improve the security of Docker containers"/>
<meta name="twitter:description" content="Learn how to improve the security of Docker containers."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to improve the security of Docker containers</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-18 13:32:09 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1019 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#build-configuration">Build configuration</a>
          <ul>
            <li><a href="#check-the-image-file">Check the image file</a></li>
            <li><a href="#always-use-unprivileged-users">Always use unprivileged users</a></li>
            <li><a href="#using-a-separate-user-id-namespace">Using a separate user ID namespace</a></li>
            <li><a href="#dont-expose-docker-daemon-sockets">Don&rsquo;t expose Docker daemon sockets</a></li>
            <li><a href="#privileged-capabilities-and-shared-resources">Privileged capabilities and shared resources</a></li>
            <li><a href="#using-control-groups-to-limit-access-to-resources">Using control groups to limit access to resources</a></li>
          </ul>
        </li>
        <li><a href="#file-system">File system</a>
          <ul>
            <li><a href="#use-a-temporary-file-system-for-non-persistent-data">Use a temporary file system for non-persistent data</a></li>
            <li><a href="#using-the-file-system-to-store-persistent-data">Using the file system to store persistent data</a></li>
          </ul>
        </li>
        <li><a href="#networking">Networking</a>
          <ul>
            <li><a href="#do-not-use-dockers-default-bridge-docker0">Do not use Docker&rsquo;s default bridge docker0</a></li>
            <li><a href="#do-not-share-the-network-namespace-of-the-host">Do not share the network namespace of the host</a></li>
          </ul>
        </li>
        <li><a href="#open-source-container-vulnerability-scanning-tools">Open source container vulnerability scanning tools</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>With the rise of <code>Docker</code>, more and more projects use <code>Docker</code> to build production environments, because the container is light enough to quickly start and migrate business services, but in the process of using, we can easily ignore the project security issues, although the container has the role of isolation, but we know that he and the virtual machine architecture gap is still relatively large.</p>
<p>Virtual machine by adding <code>Hypervisor</code> layer, virtualized <strong>Network card</strong>, <strong>memory</strong>, <strong>CPU</strong> and other virtual hardware, and then build virtual machines on it, each virtual machine has its own system kernel. The <code>Docker</code> container is supported by the kernel to isolate the file system, processes, devices, network and other resources, and then control the permissions, CPU resources, etc., so that the containers do not affect each other. However, containers share resources such as kernel, file system, hardware, etc. with the host.</p>
<h2 id="build-configuration">Build configuration</h2>
<h3 id="check-the-image-file">Check the image file</h3>
<p>When we customize the build environment, we need to choose the base image, <code>docker pull image:tag</code>, make sure to choose the official image of <code>Docker</code> to reduce the risk of victimization, when choosing the image, we generally give priority to the base version of <code>Alpine Linux</code>, which is a streamlined distribution, it is light enough, after cutting, the system The performance of the system is so much better, and at the same time, the victimization of the system can be reduced.</p>
<p>Do I need to use the latest or a fixed tag version?</p>
<p>For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">python:3.9.6-alpine3.14
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python:3.9.6-alpine
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python:3.9-alpine
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python:alpine
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you choose a definite version, you can avoid being affected by subsequent image changes. On the other hand, using the latest version will ensure that more vulnerabilities are patched. This is a trade-off, but it is usually recommended to fix to a stable version.
Generally smaller versions are optimized for stable versions and will ensure backwards compatibility without major changes, with this in mind I would choose <code>python:3.9-alpine</code>.</p>
<blockquote>
<p>This choice is usually also applicable to our selection of software versions for production environments.</p>
</blockquote>
<h3 id="always-use-unprivileged-users">Always use unprivileged users</h3>
<p>By default, processes inside the container run as <code>root (id=0)</code>.</p>
<p>To enforce the principle of least privilege, we should set a default user. There are two options.</p>
<ol>
<li>
<p>Use the following option to specify an arbitrary user ID that does not exist in the running container -u</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run -u <span class="m">4000</span> &lt;image&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: If we need to mount the filesystem later, we should match the user <code>ID</code> we use with the host user in order to access the files.</p>
</blockquote>
</li>
<li>
<p>By creating a default user in <code>Dockerfile</code></p>
<p>It is more common, for example <code>nginx</code> official <code>Dockerfile</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> &lt;base image&gt;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> addgroup -S appgroup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="o">&amp;&amp;</span> adduser -S appuser -G appgroup<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">USER</span><span class="s"> appuser</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>... &lt;rest of Dockerfile&gt; ...<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="using-a-separate-user-id-namespace">Using a separate user ID namespace</h3>
<p>By default, the <code>Docker</code> daemon uses the server&rsquo;s user <code>ID</code> namespace. Therefore, any successful elevation of privileges within a container also implies <code>root</code> access to the server and other containers.
To reduce this risk, we should configure the server and the <code>Docker</code> daemon with different users and groups.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">dockerd --userns-remap<span class="o">=</span>testuser:testuser
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dont-expose-docker-daemon-sockets">Don&rsquo;t expose Docker daemon sockets</h3>
<p>Unless you are very sure of what you are doing, never expose the <code>UNIX</code> socket that <code>Docker</code> is listening on: <code>/var/run/docker.sock</code>.</p>
<p>This is the main entry point for the <code>Docker API</code>. Granting someone access is the same as granting <code>root</code> privileges to your server.</p>
<p>Try to avoid the following actions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">-v /var/run/docker.sock://var/run/docker.sock
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="privileged-capabilities-and-shared-resources">Privileged capabilities and shared resources</h3>
<p>First of all, a container should never run as privileged, otherwise it has the <code>root</code> privileges of the host.
To be more secure, it is recommended to explicitly disable the possibility of adding new privileges after creating a container using the option <code>-security-opt=no-new-privileges</code> , a security option that prevents application processes inside the container from acquiring new privileges during execution .</p>
<p>Do not share sensitive parts of the host filesystem.</p>
<ul>
<li>root (/),</li>
<li>devices (/dev)</li>
<li>process (/proc)</li>
<li>Virtual (/sys) mount points.</li>
</ul>
<p>If you need to access server devices, be careful to use the <code>[r|w|m]</code> flag (read, write and use <code>mknod</code>) to selectively enable access options.</p>
<h3 id="using-control-groups-to-limit-access-to-resources">Using control groups to limit access to resources</h3>
<p>Control groups are mechanisms used to control each container&rsquo;s access to <code>CPU</code>, <code>memory</code>, <code>disk I/O</code>.</p>
<p>We should avoid sharing resources with the host, otherwise the server may be at risk of a <strong>DoS attack</strong>. It is recommended to specify memory and <code>CPU</code> usage with the following options.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">--memory<span class="o">=</span><span class="s2">&#34;400m&#34;</span>
</span></span><span class="line"><span class="cl">--memory-swap<span class="o">=</span><span class="s2">&#34;1g&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--cpus<span class="o">=</span>0.5
</span></span><span class="line"><span class="cl">--restart<span class="o">=</span>on-failure:5
</span></span><span class="line"><span class="cl">--ulimit <span class="nv">nofile</span><span class="o">=</span><span class="m">5</span>
</span></span><span class="line"><span class="cl">--ulimit <span class="nv">nproc</span><span class="o">=</span><span class="m">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="file-system">File system</h2>
<h3 id="use-a-temporary-file-system-for-non-persistent-data">Use a temporary file system for non-persistent data</h3>
<p>If you need only temporary storage, use the appropriate option.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run --read-only --tmpfs /tmp:rw ,noexec,nosuid &lt;image&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="using-the-file-system-to-store-persistent-data">Using the file system to store persistent data</h3>
<p>If data needs to be shared with the host filesystem or other containers, there are two options.</p>
<ul>
<li>Create a bound mount with limited available disk space <code>(--mount type=bind,o=size)</code></li>
<li>Create bound volumes for dedicated partitions <code>(--mount type=volume)</code></li>
</ul>
<p>In either case, if the container does not need to modify shared data, use the read-only option.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run -v &lt;volume-name&gt;:/path/in/container:ro &lt;image&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>or</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run --mount <span class="nv">source</span><span class="o">=</span>&lt;volume-name&gt;,destination<span class="o">=</span>/path/in/container,readonly &lt;image&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="networking">Networking</h2>
<h3 id="do-not-use-dockers-default-bridge-docker0">Do not use Docker&rsquo;s default bridge docker0</h3>
<p><code>docker0</code> is a bridge created at boot time to separate the host network from the container network. When creating containers, <code>Docker</code> uses <code>docker0</code> to connect to the network by default. Therefore, all containers are connected to each other with <code>docker0</code> and can communicate with each other.
We should disable the default connection for all containers by specifying the option <code>--bridge=none</code> and then create a private network for each connection using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker network create &lt;network_name&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use it to access the host network interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run --network<span class="o">=</span>&lt;network_name&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="do-not-share-the-network-namespace-of-the-host">Do not share the network namespace of the host</h3>
<p>In the same sense, isolate the network interface of the host: <code>--network=host</code> The share with server option should not be used.</p>
<h2 id="open-source-container-vulnerability-scanning-tools">Open source container vulnerability scanning tools</h2>
<p>After building the container you can use some static container detection tools to see if there are any bugs found, for example.</p>
<ul>
<li><a href="https://github.com/quay/clair">clair</a></li>
<li><a href="https://github.com/aquasecurity/trivy">trivy</a></li>
<li><a href="https://github.com/docker/docker-bench-security">docker-bench-security</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/memory-alignment/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">About Memory Alignment</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/controller-runtime/">
            <span class="next-text nav-default">Four ways to use Controller Runtime</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
