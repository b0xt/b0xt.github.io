<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Four ways to use Controller Runtime - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="controller-runtime is a relatively good tool provided by the Kubernetes community to quickly build a set of watch for ApiServer" /><meta name="keywords" content="Kubernetes, Controller Runtime" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/controller-runtime/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Four ways to use Controller Runtime" />
<meta property="og:description" content="controller-runtime is a relatively good tool provided by the Kubernetes community to quickly build a set of watch for ApiServer" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/controller-runtime/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-18T09:26:55+08:00" />
<meta property="article:modified_time" content="2022-04-18T09:26:55+08:00" />

<meta itemprop="name" content="Four ways to use Controller Runtime">
<meta itemprop="description" content="controller-runtime is a relatively good tool provided by the Kubernetes community to quickly build a set of watch for ApiServer"><meta itemprop="datePublished" content="2022-04-18T09:26:55+08:00" />
<meta itemprop="dateModified" content="2022-04-18T09:26:55+08:00" />
<meta itemprop="wordCount" content="2245">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Four ways to use Controller Runtime"/>
<meta name="twitter:description" content="controller-runtime is a relatively good tool provided by the Kubernetes community to quickly build a set of watch for ApiServer"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Four ways to use Controller Runtime</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-18 09:26:55 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2245 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#architecture">Architecture</a></li>
        <li><a href="#usage">Usage</a>
          <ul>
            <li><a href="#general-usage">General Usage</a></li>
            <li><a href="#setting-up-eventhandler">Setting up EventHandler</a></li>
            <li><a href="#set-cache-selector">Set Cache selector</a></li>
            <li><a href="#using-metadata">Using Metadata</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>As the cloud-native ecosystem continues to evolve, most of the current Kubernetes-based cloud-native technologies almost always adopt the CRD + Controller model. Even without a custom CRD, there will be a need for a controller to detect resources of interest and do the work required by the business when their state changes.</p>
<p>controller-runtime is a relatively good tool provided by the Kubernetes community to quickly build a set of watch for ApiServer. This article will give a brief summary and introduction of how controller-runtime works and how it is used in different scenarios.</p>
<h2 id="architecture">Architecture</h2>
<p>The architecture of controller-runtime can be summarized in the following diagram. Note: Webhook is not in the scope of this article, so it is omitted from the diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/18/959884b001334018913252f659151ea3.png" alt="controller-runtime Architecture"></p>
<p>The main components are Manager and Reconciler created by the user and Cache and Controller started by Controller Runtime itself. First, the user side, Manager is created by the user during initialization and used to start the Controller Runtime components; Reconciler is a component that the user needs to provide to handle their own business logic.</p>
<p>The controller-runtime component, Cache, as the name implies, is a cache, which is used to establish the Informer&rsquo;s connection to the ApiServer to watch the resources and push the watched objects into the queue; the Controller will register the eventHandler with the Informer on the one hand, and get the data from the queue on the other. On the other hand, the controller will take data from the queue and execute the user-side Reconciler functions.</p>
<p>The entire workflow on the controller-runtime side is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/18/c4607be119a4428dbc49c62e10e1a150.png" alt="controller-runtime workflow"></p>
<p>First, the Controller registers a resource-specific eventHandler with the Informer; then the Cache starts the Informer, which sends a request to the ApiServer to establish a connection; when the Informer detects a resource change, it uses the When the Informer detects a resource change, it uses the eventHandler registered with the Controller to determine if it is pushed into the queue; when an element is pushed into the queue, the Controller takes the element out and executes the Reconciler on the user side.</p>
<h2 id="usage">Usage</h2>
<p>The following describes several different scenarios of usage.</p>
<h3 id="general-usage">General Usage</h3>
<p>We are already familiar with the usage of controller-runtime, and the simplest usage can be expressed in the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scheme</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">corev1</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. init Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mgr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">GetConfigOrDie</span><span class="p">(),</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>   <span class="mi">9443</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. init Reconciler（Controller）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewControllerManagedBy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">For</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Complete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ApplicationReconciler</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. start Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetupSignalHandler</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ApplicationReconciler</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">ApplicationReconciler</span><span class="p">)</span> <span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">reconcile</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first step is to initialize the Manager and generate a default configuration of the Cache.</p>
<p>The second step is to initialize the Controller.</p>
<ul>
<li><code>ctrl.NewControllerManagedBy</code> : used to create the Controller and inject some configurations of the Manager generated in the first step into the Controller.</li>
<li><code>For</code> : A shortcut method provided by Controller Runtime to specify the resource type of the watch.</li>
<li><code>Owns</code>: sometimes the <code>Owns</code> method is used to indicate that a resource is a slave of a resource I care about and its event will go into the Controller&rsquo;s queue.</li>
<li><code>Complete</code> is also a shortcut method for generating a Controller, registering the user&rsquo;s Reconciler into the Controller, and generating the default eventHandler for the watch resource, while executing the Controller&rsquo;s <code>watch</code> function.</li>
</ul>
<p>The user&rsquo;s Reconciler just needs to implement the <code>reconcile.Reconciler</code> interface.</p>
<p>The last step is to start the Manager, which starts the Cache, i.e. the Informer, and the Controller at the same time.</p>
<h3 id="setting-up-eventhandler">Setting up EventHandler</h3>
<p>In the whole architecture, Informer plays the role of ListWatch for ApiServer, and when it detects the change of the resource it is interested in, it will process it according to the registered eventHandler and determine whether it needs to be pushed into the queue.</p>
<p>So, in the process of using it, we can register the eventHandler function of Informer into it when we create the Controller, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scheme</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">corev1</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. init Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mgr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">GetConfigOrDie</span><span class="p">(),</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>   <span class="mi">9443</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. init Reconciler（Controller）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}},</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForObject</span><span class="p">{},</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">Funcs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CreateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="nx">event</span><span class="p">.</span><span class="nx">CreateEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">updateEvent</span> <span class="nx">event</span><span class="p">.</span><span class="nx">UpdateEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">deleteEvent</span> <span class="nx">event</span><span class="p">.</span><span class="nx">DeleteEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. start Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetupSignalHandler</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Adding the logic of judging resources before they are added to the Queue in predicate can effectively prevent the queue from being pushed with too many useless resources. If our Reconciler needs to detect multiple resources, here the Controller can perform watch for different resource types and register different eventHandler each time.</p>
<h3 id="set-cache-selector">Set Cache selector</h3>
<p>In addition, we can also add a valid LabelSelector or FieldSelector to Informer&rsquo;s ListWatch function to further reduce the detected invalid resources, which can also play a role in reducing the pressure on ApiServer in case of a large amount of cluster resources. The details are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scheme</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">corev1</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. init Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mgr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">GetConfigOrDie</span><span class="p">(),</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>   <span class="mi">9443</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NewCache</span><span class="p">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">BuilderWithOptions</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">SelectorsByObject</span><span class="p">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SelectorsByObject</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Label</span><span class="p">:</span> <span class="nx">labels</span><span class="p">.</span><span class="nf">SelectorFromSet</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nx">Set</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Node</span><span class="p">{}:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Field</span><span class="p">:</span> <span class="nx">fields</span><span class="p">.</span><span class="nf">SelectorFromSet</span><span class="p">(</span><span class="nx">fields</span><span class="p">.</span><span class="nx">Set</span><span class="p">{</span><span class="s">&#34;metadata.name&#34;</span><span class="p">:</span> <span class="s">&#34;node01&#34;</span><span class="p">}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. init Reconciler（Controller）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}},</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForObject</span><span class="p">{},</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">Funcs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CreateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="nx">event</span><span class="p">.</span><span class="nx">CreateEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">updateEvent</span> <span class="nx">event</span><span class="p">.</span><span class="nx">UpdateEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">deleteEvent</span> <span class="nx">event</span><span class="p">.</span><span class="nx">DeleteEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. start Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetupSignalHandler</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that controller-runtime is only available in version <a href="https://github.com/kubernetes-sigs/controller-runtime/releases/tag/v0.11.0">v0.11.0</a> to set the cache selector.</p>
<p>The way to do this is to use the <code>cache.BuilderWithOptions</code> function to register the LabelSelector or FieldSelector when initializing the Manager, and to register the scheme so that when the Informer generated by the cache makes a request to the ApiServer, it will also give the resource scheme. The resource scheme is given at the same time.</p>
<p>Here you can see from the source code that Cache generates 3 types of Informer, <code>structured</code>, <code>unstructured</code> and <code>metadata</code>. The following is a list of the 3 types of Informers that are started at the same time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewInformersMap</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mapper</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTMapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resync</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectors</span> <span class="nx">SelectorsByGVK</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">disableDeepCopy</span> <span class="nx">DisableDeepCopyByGVK</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">*</span><span class="nx">InformersMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">InformersMap</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">structured</span><span class="p">:</span>   <span class="nf">newStructuredInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">selectors</span><span class="p">,</span> <span class="nx">disableDeepCopy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unstructured</span><span class="p">:</span> <span class="nf">newUnstructuredInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">selectors</span><span class="p">,</span> <span class="nx">disableDeepCopy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metadata</span><span class="p">:</span>     <span class="nf">newMetadataInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">selectors</span><span class="p">,</span> <span class="nx">disableDeepCopy</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Start calls Run on each of the informers and sets started to true.  Blocks on the context.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">InformersMap</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">m</span><span class="p">.</span><span class="nx">structured</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">m</span><span class="p">.</span><span class="nx">unstructured</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">m</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Among them, <code>structured</code> is a deterministic resource, which needs to register the corresponding resource type in scheme; <code>unstructured</code> is an indeterminate resource; and <code>metadata</code> is a request to ApiServer in the form of <code>protobuf</code>.</p>
<p>Take <code>structured</code> as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createStructuredListWatch</span><span class="p">(</span><span class="nx">gvk</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="nx">ip</span> <span class="o">*</span><span class="nx">specificInformersMap</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Kubernetes APIs work against Resources, not GroupVersionKinds.  Map the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// groupVersionKind to the Resource API we will use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mapping</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">mapper</span><span class="p">.</span><span class="nf">RESTMapping</span><span class="p">(</span><span class="nx">gvk</span><span class="p">.</span><span class="nf">GroupKind</span><span class="p">(),</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">RESTClientForGVK</span><span class="p">(</span><span class="nx">gvk</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">codecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">listGVK</span> <span class="o">:=</span> <span class="nx">gvk</span><span class="p">.</span><span class="nf">GroupVersion</span><span class="p">().</span><span class="nf">WithKind</span><span class="p">(</span><span class="nx">gvk</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">+</span> <span class="s">&#34;List&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">listObj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">listGVK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: the functions that make use of this ListWatch should be adapted to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  pass in their own contexts instead of relying on this fixed one here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create a new ListWatch for the obj
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ListFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">).</span><span class="nf">ApplyToList</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">res</span> <span class="o">:=</span> <span class="nx">listObj</span><span class="p">.</span><span class="nf">DeepCopyObject</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">namespace</span> <span class="o">:=</span> <span class="nf">restrictNamespaceBySelector</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">isNamespaceScoped</span> <span class="o">:=</span> <span class="nx">namespace</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameRoot</span>
</span></span><span class="line"><span class="cl">            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span><span class="nf">NamespaceIfScoped</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">isNamespaceScoped</span><span class="p">).</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">paramCodec</span><span class="p">).</span><span class="nf">Do</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Into</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup the watch function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">WatchFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">).</span><span class="nf">ApplyToList</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Watch needs to be set to true separately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">opts</span><span class="p">.</span><span class="nx">Watch</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="nx">namespace</span> <span class="o">:=</span> <span class="nf">restrictNamespaceBySelector</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">isNamespaceScoped</span> <span class="o">:=</span> <span class="nx">namespace</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameRoot</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span><span class="nf">NamespaceIfScoped</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">isNamespaceScoped</span><span class="p">).</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">paramCodec</span><span class="p">).</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that in Informer&rsquo;s ListWatch interface, <code>p.selectors(gvk).ApplyToList(&amp;opts)</code> will add the <code>selector</code> we registered at the beginning to the <code>list/watch</code> request that follows.</p>
<h3 id="using-metadata">Using Metadata</h3>
<p>In the above example, we mentioned that <code>metadata</code> uses <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#alternate-representations-of-resources"><code>protobuf</code></a> serialized form to request ApiServer, which is more efficient than the default serialized type json, and performs better in large-scale environments. However, not all resource types support the protobuf format, for example, CRD does not.</p>
<p>Another point to note is that in Metadata data, the only data that is watched is metadata, not spec and status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scheme</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. init Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mgr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">GetConfigOrDie</span><span class="p">(),</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span>   <span class="mi">9443</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NewCache</span><span class="p">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">BuilderWithOptions</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">SelectorsByObject</span><span class="p">:</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SelectorsByObject</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Label</span><span class="p">:</span> <span class="nx">labels</span><span class="p">.</span><span class="nf">SelectorFromSet</span><span class="p">(</span><span class="nx">labels</span><span class="p">.</span><span class="nx">Set</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Node</span><span class="p">{}:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">Field</span><span class="p">:</span> <span class="nx">fields</span><span class="p">.</span><span class="nf">SelectorFromSet</span><span class="p">(</span><span class="nx">fields</span><span class="p">.</span><span class="nx">Set</span><span class="p">{</span><span class="s">&#34;metadata.name&#34;</span><span class="p">:</span> <span class="s">&#34;node01&#34;</span><span class="p">}),</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. init Reconciler（Controller）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;app&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewControllerManagedBy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">For</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}).</span>
</span></span><span class="line"><span class="cl">        <span class="nf">Complete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ApplicationReconciler</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">u</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">PartialObjectMetadata</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">.</span><span class="nf">SetGroupVersionKind</span><span class="p">(</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Kind</span><span class="p">:</span>    <span class="s">&#34;Pod&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Group</span><span class="p">:</span>   <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">u</span><span class="p">},</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForObject</span><span class="p">{},</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">Funcs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CreateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="nx">event</span><span class="p">.</span><span class="nx">CreateEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">updateEvent</span> <span class="nx">event</span><span class="p">.</span><span class="nx">UpdateEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">deleteEvent</span> <span class="nx">event</span><span class="p">.</span><span class="nx">DeleteEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. start Manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetupSignalHandler</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the Cache metadata data, the data format used is <code>meta.v1.PartialObjectMetadata</code>, the premise is that the user only cares about the metadata of the resource, not its spec and status, so in the ListWatch function of the ApiServer, only the metadata is fetched. The source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// PartialObjectMetadata is a generic representation of any object with ObjectMeta. It allows clients
</span></span></span><span class="line"><span class="cl"><span class="c1">// to get access to a particular ObjectMeta schema without knowing the details of the version.
</span></span></span><span class="line"><span class="cl"><span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">PartialObjectMetadata</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">TypeMeta</span> <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Standard object&#39;s metadata.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createMetadataListWatch</span><span class="p">(</span><span class="nx">gvk</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="nx">ip</span> <span class="o">*</span><span class="nx">specificInformersMap</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Kubernetes APIs work against Resources, not GroupVersionKinds.  Map the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// groupVersionKind to the Resource API we will use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mapping</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">mapper</span><span class="p">.</span><span class="nf">RESTMapping</span><span class="p">(</span><span class="nx">gvk</span><span class="p">.</span><span class="nf">GroupKind</span><span class="p">(),</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Always clear the negotiated serializer and use the one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// set from the metadata client.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">CopyConfig</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cfg</span><span class="p">.</span><span class="nx">NegotiatedSerializer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// grab the metadata client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// create the relevant listwatch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ListFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">).</span><span class="nf">ApplyToList</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nx">list</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">PartialObjectMetadataList</span>
</span></span><span class="line"><span class="cl">                <span class="nx">err</span>  <span class="kt">error</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">namespace</span> <span class="o">:=</span> <span class="nf">restrictNamespaceBySelector</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">namespace</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameRoot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">list</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">Namespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">list</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">list</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">list</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">list</span><span class="p">.</span><span class="nx">Items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">SetGroupVersionKind</span><span class="p">(</span><span class="nx">gvk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Setup the watch function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">WatchFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">).</span><span class="nf">ApplyToList</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Watch needs to be set to true separately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">opts</span><span class="p">.</span><span class="nx">Watch</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nx">watcher</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">                <span class="nx">err</span>     <span class="kt">error</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">namespace</span> <span class="o">:=</span> <span class="nf">restrictNamespaceBySelector</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">selectors</span><span class="p">(</span><span class="nx">gvk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">namespace</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameRoot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">watcher</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">Namespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">watcher</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">watcher</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">watcher</span> <span class="p">=</span> <span class="nf">newGVKFixupWatcher</span><span class="p">(</span><span class="nx">gvk</span><span class="p">,</span> <span class="nx">watcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">watcher</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the controller-runtime uses <code>client-go.metadata.Client</code> and the data format returned by this Client&rsquo;s interface is <code>PartialObjectMetadata</code>.</p>
<h2 id="summary">Summary</h2>
<p>controller-runtime is a very useful tool for generating resource controllers, and we can use controller-runtime to quickly generate the resource controllers we need in the usual development process. At the same time, controller-runtime also provides many ways to not only build controllers quickly, but also to configure them flexibly for different business needs to achieve the desired results.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/docker-safe/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to improve the security of Docker containers</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/js-new-features/">
            <span class="next-text nav-default">5 New JavaScript Features You Must Learn</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
