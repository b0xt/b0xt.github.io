<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Customizing Kubernetes CRD - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article, we introduce ConfigMapHistory, a CRD, as an example, and take you through building and deploying a CRD from zero to one." /><meta name="keywords" content="Kubernetes, Crd" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/kubernetes-crd/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Customizing Kubernetes CRD" />
<meta property="og:description" content="In this article, we introduce ConfigMapHistory, a CRD, as an example, and take you through building and deploying a CRD from zero to one." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/kubernetes-crd/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-04T13:25:33+08:00" />
<meta property="article:modified_time" content="2022-04-04T13:25:33+08:00" />

<meta itemprop="name" content="Customizing Kubernetes CRD">
<meta itemprop="description" content="In this article, we introduce ConfigMapHistory, a CRD, as an example, and take you through building and deploying a CRD from zero to one."><meta itemprop="datePublished" content="2022-04-04T13:25:33+08:00" />
<meta itemprop="dateModified" content="2022-04-04T13:25:33+08:00" />
<meta itemprop="wordCount" content="1582">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Customizing Kubernetes CRD"/>
<meta name="twitter:description" content="In this article, we introduce ConfigMapHistory, a CRD, as an example, and take you through building and deploying a CRD from zero to one."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Customizing Kubernetes CRD</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-04 13:25:33 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1582 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-theoretical-overview">1. Theoretical Overview</a></li>
        <li><a href="#2-kubebuilder-installation">2. kubebuilder installation</a></li>
        <li><a href="#3-kubebuilder-initialization">3. kubebuilder initialization</a></li>
        <li><a href="#4-kubebuilder-create-api">4. kubebuilder Create API</a></li>
        <li><a href="#5-customize-the-code-and-generate-the-client-code">5. Customize the code and generate the client code</a></li>
        <li><a href="#6-create-crd">6. Create CRD</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-theoretical-overview">1. Theoretical Overview</h2>
<p>We know that Kubernetes provides a CRD mechanism to scale resources, and in some scenarios we can use CRD to scale resources stored through Kubernetes, i.e., use Kubernetes as storage. According to the official statement CRD + Controller = Operator, <a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a> can generate such a code framework, and can be customized to generate Controller or not. The client-related code can be generated by <a href="https://github.com/kubernetes/code-generator">code-generator</a>, which generates informer, listster, clientset, and other series of code. In this way, we only need to fill the generated code with business code, and do not need to care about the code outside the framework, which can greatly improve the development efficiency and reduce the threshold of CRD. In this article, we introduce ConfigMapHistory, a CRD, as an example, and take you through building and deploying a CRD from zero to one.</p>
<h2 id="2-kubebuilder-installation">2. kubebuilder installation</h2>
<p>The kubebuilder installation documentation can be found in the official file <a href="https://book.kubebuilder.io/quick-start.html#installation">Install kubebuilder</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">os</span><span class="o">=</span><span class="k">$(</span>go env GOOS<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">arch</span><span class="o">=</span><span class="k">$(</span>go env GOARCH<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># download kubebuilder and extract it to tmp</span>
</span></span><span class="line"><span class="cl">curl -L https://go.kubebuilder.io/dl/2.3.1/<span class="si">${</span><span class="nv">os</span><span class="si">}</span>/<span class="si">${</span><span class="nv">arch</span><span class="si">}</span> <span class="p">|</span> tar -xz -C /tmp/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># move to a long-term location and put it on your path</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (you&#39;ll need to set the KUBEBUILDER_ASSETS env var if you put it somewhere else)</span>
</span></span><span class="line"><span class="cl">sudo mv /tmp/kubebuilder_2.3.1_<span class="si">${</span><span class="nv">os</span><span class="si">}</span>_<span class="si">${</span><span class="nv">arch</span><span class="si">}</span> /usr/local/kubebuilder
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/kubebuilder/bin
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-kubebuilder-initialization">3. kubebuilder initialization</h2>
<p>kubebuilder code initialization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># github.com/opskumu 以实际仓库为主，本实例为 crd-example</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="nv">$GOPATH</span>/src/github.com/opskumu/crd-example
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/opskumu/crd-example
</span></span><span class="line"><span class="cl"><span class="c1"># 域名以实际域名为主，本实例为 opskumu.com</span>
</span></span><span class="line"><span class="cl">kubebuilder init --domain opskumu.com
</span></span><span class="line"><span class="cl">kubebuilder edit --multigroup<span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To view the current directory structure of the generated code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># tree -L 2 ./</span>
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── Dockerfile
</span></span><span class="line"><span class="cl">├── Makefile
</span></span><span class="line"><span class="cl">├── PROJECT
</span></span><span class="line"><span class="cl">├── bin
</span></span><span class="line"><span class="cl">│   └── manager
</span></span><span class="line"><span class="cl">├── config
</span></span><span class="line"><span class="cl">│   ├── certmanager
</span></span><span class="line"><span class="cl">│   ├── default
</span></span><span class="line"><span class="cl">│   ├── manager
</span></span><span class="line"><span class="cl">│   ├── prometheus
</span></span><span class="line"><span class="cl">│   ├── rbac
</span></span><span class="line"><span class="cl">│   └── webhook
</span></span><span class="line"><span class="cl">├── go.mod
</span></span><span class="line"><span class="cl">├── go.sum
</span></span><span class="line"><span class="cl">├── hack
</span></span><span class="line"><span class="cl">│   └── boilerplate.go.txt
</span></span><span class="line"><span class="cl">└── main.go
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-kubebuilder-create-api">4. kubebuilder Create API</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># kubebuilder create api --group test --version v1 --kind ConfigMapHistory</span>
</span></span><span class="line"><span class="cl">Create Resource <span class="o">[</span>y/n<span class="o">]</span>    <span class="c1"># 创建 ConfigMapHistory 资源，此处选择 y</span>
</span></span><span class="line"><span class="cl">y
</span></span><span class="line"><span class="cl">Create Controller <span class="o">[</span>y/n<span class="o">]</span>  <span class="c1"># 创建控制器，此处不需要，选择 n</span>
</span></span><span class="line"><span class="cl">n
</span></span><span class="line"><span class="cl"><span class="c1"># tree apis/test/v1   # apis 目录存放 group test v1 相关的资源 API</span>
</span></span><span class="line"><span class="cl">apis/test/v1
</span></span><span class="line"><span class="cl">├── configmaphistory_types.go
</span></span><span class="line"><span class="cl">├── groupversion_info.go
</span></span><span class="line"><span class="cl">└── zz_generated.deepcopy.go
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-customize-the-code-and-generate-the-client-code">5. Customize the code and generate the client code</h2>
<p>Generate <code>apis/test/v1/configmaphistory_types.go</code> code by default as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">// +kubebuilder:object:root=true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// ConfigMapHistory is the Schema for the configmaphistories API
</span></span><span class="line"><span class="cl">type ConfigMapHistory struct {
</span></span><span class="line"><span class="cl">    metav1.TypeMeta   `json:&#34;,inline&#34;`
</span></span><span class="line"><span class="cl">    metav1.ObjectMeta `json:&#34;metadata,omitempty&#34;`
</span></span><span class="line"><span class="cl">    Spec   ConfigMapHistorySpec   `json:&#34;spec,omitempty&#34;`
</span></span><span class="line"><span class="cl">    Status ConfigMapHistoryStatus `json:&#34;status,omitempty&#34;`
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>The purpose of creating a resource of type ConfigMapHistory is to store the history of the ConfigMap, so some changes need to be made to the above code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="c1">// +genclient
</span></span></span><span class="line"><span class="cl"><span class="c1">// +kubebuilder:object:root=true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ConfigMapHistory is the Schema for the configmaphistories API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ConfigMapHistory</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>   <span class="s">`json:&#34;,inline&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ConfigMap</span>  <span class="kt">string</span>            <span class="s">`json:&#34;configMap&#34;`</span>                <span class="c1">// 关联 ConfigMap 名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Data</span>       <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`json:&#34;data,omitempty&#34;`</span>           <span class="c1">// 对应 ConfigMap 版本数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">BinaryData</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">byte</span>   <span class="s">`json:&#34;binaryData,omitempty&#34;`</span>     <span class="c1">// 对应 ConfigMap 版本二进制数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that <code>// +genclient</code> is added additionally to tag the subsequent <code>code-generator</code> to generate the client code. after the changes to the types file, the <code>make manifests</code> command can be executed to generate the CRD file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># make manifests</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ls config/crd/bases</span>
</span></span><span class="line"><span class="cl">test.opskumu.com_configmaphistories.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the code structure changes, you need to run <code>make manifest</code> again to generate a new CRD file.</p>
<p>Create <code>apis/test/v1/doc.go</code>, <code>apis/test/v1/register.go</code>, <code>hack/tools.go</code> and <code>hack/update-codegen.sh</code> files</p>
<ul>
<li>apis/test/v1/doc.go</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Copyright 2017 The Kubernetes Authors.
</span></span></span><span class="line"><span class="cl"><span class="cm">Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">you may not use this file except in compliance with the License.
</span></span></span><span class="line"><span class="cl"><span class="cm">You may obtain a copy of the License at
</span></span></span><span class="line"><span class="cl"><span class="cm">    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class="line"><span class="cl"><span class="cm">Unless required by applicable law or agreed to in writing, software
</span></span></span><span class="line"><span class="cl"><span class="cm">distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class="line"><span class="cl"><span class="cm">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class="line"><span class="cl"><span class="cm">See the License for the specific language governing permissions and
</span></span></span><span class="line"><span class="cl"><span class="cm">limitations under the License.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// +k8s:deepcopy-gen=package
</span></span></span><span class="line"><span class="cl"><span class="c1">// 注意 groupName 和实际相同
</span></span></span><span class="line"><span class="cl"><span class="c1">// +groupName=test.opskumu.com
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Package v1 is the v1 version of the API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">v1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>apis/test/v1/register.go</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Copyright 2017 The Kubernetes Authors.
</span></span></span><span class="line"><span class="cl"><span class="cm">Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">you may not use this file except in compliance with the License.
</span></span></span><span class="line"><span class="cl"><span class="cm">You may obtain a copy of the License at
</span></span></span><span class="line"><span class="cl"><span class="cm">    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class="line"><span class="cl"><span class="cm">Unless required by applicable law or agreed to in writing, software
</span></span></span><span class="line"><span class="cl"><span class="cm">distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class="line"><span class="cl"><span class="cm">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class="line"><span class="cl"><span class="cm">See the License for the specific language governing permissions and
</span></span></span><span class="line"><span class="cl"><span class="cm">limitations under the License.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">v1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SchemeGroupVersion is group version used to register these objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">SchemeGroupVersion</span> <span class="p">=</span> <span class="nx">GroupVersion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Resource</span><span class="p">(</span><span class="nx">resource</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupResource</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nf">WithResource</span><span class="p">(</span><span class="nx">resource</span><span class="p">).</span><span class="nf">GroupResource</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>hack/tools.go</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +build tools
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Copyright 2019 The Kubernetes Authors.
</span></span></span><span class="line"><span class="cl"><span class="cm">Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span class="line"><span class="cl"><span class="cm">you may not use this file except in compliance with the License.
</span></span></span><span class="line"><span class="cl"><span class="cm">You may obtain a copy of the License at
</span></span></span><span class="line"><span class="cl"><span class="cm">    http://www.apache.org/licenses/LICENSE-2.0
</span></span></span><span class="line"><span class="cl"><span class="cm">Unless required by applicable law or agreed to in writing, software
</span></span></span><span class="line"><span class="cl"><span class="cm">distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span></span></span><span class="line"><span class="cl"><span class="cm">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span></span></span><span class="line"><span class="cl"><span class="cm">See the License for the specific language governing permissions and
</span></span></span><span class="line"><span class="cl"><span class="cm">limitations under the License.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// This package imports things required by build scripts, to force `go mod` to see them as dependencies
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">tools</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nx">_</span> <span class="s">&#34;k8s.io/code-generator&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>tools.go</code> is mainly used to introduce the <code>k8s.io/code-generator</code> dependency.</p>
<ul>
<li>hack/update-codegen.sh</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Copyright 2017 The Kubernetes Authors.                                                                                       #                                                                                                                              # Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);                                                              # you may not use this file except in compliance with the License.                                                             # You may obtain a copy of the License at</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class="line"><span class="cl"><span class="c1"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class="line"><span class="cl"><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># See the License for the specific language governing permissions and</span>
</span></span><span class="line"><span class="cl"><span class="c1"># limitations under the License.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o errexit
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o nounset
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">SCRIPT_ROOT</span><span class="o">=</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span>/..
</span></span><span class="line"><span class="cl"><span class="nv">CODEGEN_PKG</span><span class="o">=</span><span class="si">${</span><span class="nv">CODEGEN_PKG</span><span class="k">:-$(</span><span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SCRIPT_ROOT</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span> ls -d -1 ./vendor/k8s.io/code-generator 2&gt;/dev/null <span class="o">||</span> <span class="nb">echo</span> ../code-generator<span class="k">)</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># generate the code with:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --output-base    because this script should also be able to run inside the vendor dir of</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                  k8s.io/kubernetes. The output-base is needed for the generators to output into the vendor dir</span>
</span></span><span class="line"><span class="cl"><span class="c1">#                  instead of the $GOPATH directly. For normal projects this can be dropped.</span>
</span></span><span class="line"><span class="cl">bash <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CODEGEN_PKG</span><span class="si">}</span><span class="s2">&#34;</span>/generate-groups.sh <span class="s2">&#34;client,informer,lister&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  github.com/opskumu/crd-example/generated github.com/opskumu/crd-example/apis <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  test:v1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --output-base <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BASH_SOURCE</span><span class="p">[0]</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">/../../../..&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --go-header-file <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SCRIPT_ROOT</span><span class="si">}</span><span class="s2">&#34;</span>/hack/boilerplate.go.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># To use your own boilerplate text append:</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   --go-header-file &#34;${SCRIPT_ROOT}&#34;/hack/custom-boilerplate.go.txt</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code can be found in sample-controller <a href="https://github.com/kubernetes/sample-controller/blob/master/pkg/apis/samplecontroller/v1alpha1/doc.go">doc.go</a>/<a href="https://github.com/kubernetes/sample-controller/blob/master/pkg/apis/samplecontroller/v1alpha1/register.go">register.go</a>/ <a href="https://github.com/kubernetes/sample-controller/blob/master/hack/tools.go">tools.go</a>/<a href="https://github.com/kubernetes/sample-controller/blob/master/hack/update-codegen.sh">update-codegen.sh</a>. The CRD in this article is generated by kubebuilder, so the content is slightly different.</p>
<p>After creating the above files, execute the following command to generate the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 注意此处版本以下几个包要一致，否则可能出现不兼容的情况</span>
</span></span><span class="line"><span class="cl"><span class="c1"># K8SVERSION=v0.19.6</span>
</span></span><span class="line"><span class="cl"><span class="c1"># go get -v k8s.io/code-generator@${K8SVERSION}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># go get -v k8s.io/client-go@${K8SVERSION}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># go get -v k8s.io/apimachinery@${K8SVERSION}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># go mod vendor</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Put the relevant dependency packages in the vendor so that <code>hack/update-codegen.sh</code> can call the script in <code>code-generator</code>. Once done, execute the code-generator command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># bash hack/update-codegen.sh</span>
</span></span><span class="line"><span class="cl">Generating clientset <span class="k">for</span> test:v1 at github.com/opskumu/crd-example/generated/clientset
</span></span><span class="line"><span class="cl">Generating listers <span class="k">for</span> test:v1 at github.com/opskumu/crd-example/generated/listers
</span></span><span class="line"><span class="cl">Generating informers <span class="k">for</span> test:v1 at github.com/opskumu/crd-example/generated/informers
</span></span><span class="line"><span class="cl"><span class="c1"># crd-example tree -L 1 generated</span>
</span></span><span class="line"><span class="cl">generated
</span></span><span class="line"><span class="cl">├── clientset
</span></span><span class="line"><span class="cl">├── informers
</span></span><span class="line"><span class="cl">└── listers
</span></span></code></pre></td></tr></table>
</div>
</div><p>This completes all the operations to add ConfigMapHistory CRD and related client code. If you need to generate other Kind types, repeat the above operations (the above created files do not need to be created again).</p>
<h2 id="6-create-crd">6. Create CRD</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create -f config/crd/bases/test.opskumu.com_configmaphistories.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create test resources.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># cat test.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test.opskumu.com/v1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMapHistory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">configMap</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># kubectl create -f ./test.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">configmaphistory.test.opskumu.com/test created</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># kubectl get configmaphistory.test.opskumu.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NAME   AGE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">test   27s</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>See <a href="https://github.com/opskumu/crd-example">crd-example</a> for full example code.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/kubernetes-ext-service/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kubernetes External Service Mapping</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/kubernetes-access-control/">
            <span class="next-text nav-default">Kubernetes Access Control</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
