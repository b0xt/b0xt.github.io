<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Optimization of Rust Enum Layout  - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the optimization of Rust Enum Layout." /><meta name="keywords" content="rust, Enum, Layout" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/rust-enum-layout/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Optimization of Rust Enum Layout " />
<meta property="og:description" content="Explore the optimization of Rust Enum Layout." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/rust-enum-layout/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-07T14:38:20+08:00" />
<meta property="article:modified_time" content="2022-04-07T14:38:20+08:00" />

<meta itemprop="name" content="Optimization of Rust Enum Layout ">
<meta itemprop="description" content="Explore the optimization of Rust Enum Layout."><meta itemprop="datePublished" content="2022-04-07T14:38:20+08:00" />
<meta itemprop="dateModified" content="2022-04-07T14:38:20+08:00" />
<meta itemprop="wordCount" content="1516">
<meta itemprop="keywords" content="rust," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Optimization of Rust Enum Layout "/>
<meta name="twitter:description" content="Explore the optimization of Rust Enum Layout."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Optimization of Rust Enum Layout </h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-07 14:38:20 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1516 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#optionpt"><code>Option&lt;P&lt;T&gt;&gt;</code></a></li>
        <li><a href="#bool--ordering"><code>bool</code> , <code>Ordering</code></a></li>
        <li><a href="#enum">Enum</a></li>
        <li><a href="#struct-tuple">Struct, Tuple</a></li>
        <li><a href="#optimization-possibilities-for-custom-structs">Optimization possibilities for custom structs</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I learned a little bit about Rust Enum today, and before you start reading, you can guess what the output of the following Rust code is on a common 64 bit machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">A</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">B</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In this <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=bab644e35609b5475978821378d3560f">Rust Playground</a> you can see the result.</p>
<p>Rust enum is essentially a <a href="https://en.wikipedia.org/wiki/Tagged_union">tagged union</a>, which corresponds to the sum type of the algebraic data type, and is not expanded upon here. In Rust enum implementations, a byte is usually used to store the type tag, which means that ideally the following two structures are equivalent.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">enum</span> <span class="nc">Attr</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Color</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Shape</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="kt">u16</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Color</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">uint8_t</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">Shape</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">uint16_t</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">Attr</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">uint8_t</span><span class="w"> </span><span class="n">tag</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">union</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Color</span><span class="w"> </span><span class="n">color</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Shape</span><span class="w"> </span><span class="n">shape</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Under this implementation, enum is not zero overhead in many scenarios. Fortunately, Rust has never defined an ABI, and enum with data cannot even be represented by <code>repr(C)</code>, which gives Rust plenty of room for fine-grained optimizations of enum memory layout. This article will cover some of the relevant optimizations under <code>rustc 1.60.0-nightly</code>.</p>
<p>Before we start exploring the details, we need to prepare a helper function that will help us look at the memory structure of our variables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">fn</span> <span class="nf">print_memory</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&#34;{:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">from_raw_parts</span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of_val</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Take the above <code>Attr</code> as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Attr</span>::<span class="n">Color</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0, 1, 2, 3, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ^  ^  ^  ^  ^^^^
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |  |  |    |
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |  |  |    --- padding
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |  |  -------- b
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |  |---------- g
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |------------- r
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ----------------- tag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Attr</span>::<span class="n">Shape</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span><span class="w"> </span><span class="mi">258</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1, 0, 1, 1, 2, 1]
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ^  ^  ^^^^  ^^^^
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |    |     |
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |    |     --- h, 256 + 2
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |    --------- w, 256 + 1
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |  |------------- padding
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ----------------- tag
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="optionpt"><code>Option&lt;P&lt;T&gt;&gt;</code></h2>
<p>P is a common smart pointer type, including <code>&amp;</code> / <code>&amp;mut</code> / <code>Box</code>. This is probably the best known example of enum layout optimization. rust recommends using <code>Option&lt;P&lt;T&gt;&gt;</code> for nullable pointers, which implements <a href="https://en.wikipedia.org/wiki/Void_safety">null safety</a>.</p>
<p><code>Option&lt;T&gt;</code> is represented in rust as an enum.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">None</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Without any optimization, it is clear that there is an unnecessary overhead, and that a null pointer can fully represent the semantics of <code>None</code>. Since this is too common, rustc not only makes targeted optimizations, but also standardizes them.</p>
<blockquote>
<p>If T is an FFI-safe non-nullable pointer type, Option is guaranteed to have the same layout and ABI as T and is therefore also FFI-safe. As of this writing, this covers &amp;, &amp;mut, and function pointers, all of which can never be null.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="k">u64</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [208, 185, 38, 40, 162, 85, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">p</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [208, 185, 38, 40, 162, 85, 0, 0]
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>One tip is that this hack is not specific to <code>Option</code>, but to pointer types. Any custom enum that satisfies the condition can achieve the same effect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">enum</span> <span class="nc">MyOption</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MySome</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MyNone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="k">u64</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyOption</span>::<span class="n">MySome</span><span class="p">(</span><span class="n">p</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [208, 185, 38, 40, 162, 85, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1">// The address of `p`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyOption</span>::<span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;&gt;</span>::<span class="n">MyNone</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0, 0, 0, 0, 0, 0, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1">// Use nullptr to represent `MyNone`.
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The fundamental reason why <code>Option&lt;P&lt;T&gt;&gt;</code> can be optimized is that there is an always illegal value under the in-memory representation of P, and the corresponding enum only needs to represent an extra value to express the redundant type. Exceeding this constraint causes this optimization to fail.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">enum</span> <span class="nc">MyOption2</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MySome</span><span class="p">(</span><span class="n">T</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MyNone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MyNone2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="k">u64</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyOption2</span>::<span class="n">MySome</span><span class="p">(</span><span class="n">p</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0, 0, 0, 0, 0, 0, 0, 0, 208, 185, 38, 40, 162, 85, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyOption2</span>::<span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;&gt;</span>::<span class="n">MyNone2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bool--ordering"><code>bool</code> , <code>Ordering</code></h2>
<p><code>bool</code> in rust occupies one byte and has only two legal values, <code>True</code> and <code>False</code>, which correspond to the memory representations <code>1u08</code> and <code>0u08</code>. We can interpret this to mean that <code>bool</code> has 254 illegal values available for the type tag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">None</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [2]
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>To take it a step further, we can be a little more forceful.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="kc">false</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="kc">true</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&gt;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [2]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">None</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;&gt;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [3]
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Correspondingly, Ordering has three legal values that also apply to this optimization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">std</span>::<span class="n">cmp</span>::<span class="n">Ordering</span>::<span class="n">Less</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [255]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">std</span>::<span class="n">cmp</span>::<span class="n">Ordering</span>::<span class="n">Greater</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">std</span>::<span class="n">cmp</span>::<span class="n">Ordering</span>::<span class="n">Equal</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">None</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">cmp</span>::<span class="n">Ordering</span><span class="o">&gt;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [2]
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="enum">Enum</h2>
<p>In fact, the compiler does not make special judgments for bool, Ordering, and any enum of less than 256 kinds itself satisfies the condition to be optimized, i.e., there will be (256 - kinds) empty bits in the type tag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">enum</span> <span class="nc">ShapeKind</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Square</span><span class="p">,</span><span class="w"> </span><span class="n">Circle</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">ShapeKind</span>::<span class="n">Square</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyOption</span>::<span class="n">MySome</span><span class="p">(</span><span class="n">MyOption</span>::<span class="n">MySome</span><span class="p">(</span><span class="mi">1</span><span class="k">u8</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0, 1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">MyOption</span>::<span class="n">MyNone</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MyOption</span><span class="o">&lt;</span><span class="n">MyOption</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [2, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1">// 尽管 u8 本身没有空位，但是 MyOption 的 type tag 有 254 个空位，因此外层的 MyOption 的 typetag 被优化掉了。
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="struct-tuple">Struct, Tuple</h2>
<p>Struct, Tuple, etc. are all Product types, and are often implemented by storing all the fields in order and making extra padding, so it is a logical optimization that if one of the fields of the struct has an empty space, then the enum tag can be stuffed into it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">A1</span><span class="w"> </span><span class="p">(</span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">A1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">A1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1, 1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="nb">None</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [0, 2]
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s go back to the example at the beginning of the article.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">A</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">B</span><span class="w"> </span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;&gt;</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">print_memory</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">Some</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ^  ^^^^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^ ^  ^^^^^^^^^^^^^^^^^^^
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |           |                      |            |           |
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |           |                      |            |           ------------ padding
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |           |                      |            ------------------------ .1
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |           |                      ------------------------------------- .0
</span></span></span><span class="line"><span class="cl"><span class="c1">//  |           ------------------------------------------------------------ padding
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ------------------------------------------------------------------------ tag
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>A and B both take 16 bytes due to padding, while <code>Option&lt;B&gt;</code> only takes 16 bytes due to the presence of a bool field <code>.2</code>, which is optimized into the bool, and <code>Option&lt;A&gt;</code> uses 24 bytes.</p>
<p>An easy optimization to think of is to use undefined memory in the padding to store the type tag. unfortunately, the layout of A is determined when compiling A itself, and the data stored in <code>Option&lt;A&gt;</code> in the padding of <code>A</code> is undefined behavior. This also leads to the funny result that by storing an extra field, <code>Option</code> takes up less space.</p>
<p>Of course, it is perfectly possible to use padding to store data, but only if it does not affect the memory layout of the child data structures. if we put <code>A</code> in <code>Option</code> <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=964744f99048e78207f6ee120329b9ce">manually expand</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">struct</span> <span class="nc">A</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">enum</span> <span class="nc">OptionA</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">),</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">());</span><span class="w"> </span><span class="c1">// 16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="p">());</span><span class="w"> </span><span class="c1">// 24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="fm">dbg!</span><span class="p">(</span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">OptionA</span><span class="o">&gt;</span><span class="p">());</span><span class="w"> </span><span class="c1">// 16
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In this case, since the data of OptionA is stored directly inside Some, it is perfectly possible to use padding to store the type tag when instantiating without causing potentially undefined behavior.</p>
<h2 id="optimization-possibilities-for-custom-structs">Optimization possibilities for custom structs</h2>
<p>Currently, all enum layout-related optimizations are suitable for type-specific hacking by the compiler, and we have no control over the layout of our custom structs in the enum. To optimize some common scenarios, rust also provides <a href="https://doc.rust-lang.org/std/num/struct.NonZeroI8.html"><code>NonZero*</code></a> to represent non-zero integers, while the compiler makes <code>size_of::&lt;Option&lt;NonZeroU8&gt;&gt; == size_of::&lt;u8&gt;</code>. But this can only be handled by the standard library case by case, and real requirements are very complex, e.g. sometimes we may need <code>NonMaxU64</code>, or for example use a third-party library <a href="https://docs.rs/ordered-float/2.10.0/ordered_float/struct.NotNan.html#"><code>Option&lt;ordered_float::NotNan&lt;f64&gt;&gt;</code></a> will not be optimized.</p>
<p>Optimizing for custom interfaces requires introducing very complex mechanisms to tell the compiler at compile time what memory structures are illegal for a type. I currently feel that a possible implementation would be const trait + const iterator, giving the compiler an iterator over potentially illegal values. However, I don&rsquo;t see an RFC for this at the moment.</p>
<p>All the examples in this article can be found at <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=2cecbb4523443229d32a943bea2e48aa">Rust Playground</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/rust/">rust</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/golang-container/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go container package</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/linux-top-memory/">
            <span class="next-text nav-default">Memory-related fields in the Linux top command</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
