<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Using PostgreSQL as a search engine - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use PostgreSQL to implement a search engine that can replace ES." /><meta name="keywords" content="Postgresql, Full-text search" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/postgresql-fulltext-search/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Using PostgreSQL as a search engine" />
<meta property="og:description" content="Learn how to use PostgreSQL to implement a search engine that can replace ES." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/postgresql-fulltext-search/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-28T13:30:00+08:00" />
<meta property="article:modified_time" content="2022-04-28T13:30:00+08:00" />

<meta itemprop="name" content="Using PostgreSQL as a search engine">
<meta itemprop="description" content="Learn how to use PostgreSQL to implement a search engine that can replace ES."><meta itemprop="datePublished" content="2022-04-28T13:30:00+08:00" />
<meta itemprop="dateModified" content="2022-04-28T13:30:00+08:00" />
<meta itemprop="wordCount" content="2005">
<meta itemprop="keywords" content="PostgreSQL," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Using PostgreSQL as a search engine"/>
<meta name="twitter:description" content="Learn how to use PostgreSQL to implement a search engine that can replace ES."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Using PostgreSQL as a search engine</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-28 13:30:00 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2005 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pg-internal-support">PG Internal Support</a></li>
        <li><a href="#build-inverted-index">Build inverted index</a></li>
        <li><a href="#searching">Searching</a></li>
        <li><a href="#performance-testing">Performance testing</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, I am studying PostgreSQL to do search engine, in short, the main use of the search engine is the inverted index, that is, an article or statement, the first word, the article into N words, each word has a certain weight, there are many places in this step can be optimized, the article will be cut into the exact meaning of the word, the impact on the subsequent search is very big, this can refer to TF-IDF or TEXTRANK algorithm. The second step is to establish the inverted index, that is, the word and the position of the word in the article associated; with the inverted index, the third step is to search, the same, we will input the word, and assembled into a certain search criteria, into the search engine to search; the fourth step is to process the search results.</p>
<p>However, the commonly used search engines in the industry are ES, why do I want to use PG? The search in the case of massive data maybe ES will be a better solution, but the general case with ES is too heavy, PG can be competent for common cases? If our business data and search can be handled by PG, we don&rsquo;t need to synchronize between database and ES, and the overall complexity will be reduced a lot.</p>
<p>This is the reason why I made this attempt.</p>
<h2 id="pg-internal-support">PG Internal Support</h2>
<p>To use full-text indexes in PostgreSQL (PG for short), you need to use a built-in data structure provided by PG, called <code>tsvector</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">A</span><span class="w"> </span><span class="n">tsvector</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">sorted</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="n">lexemes</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">normalized</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">merge</span><span class="w"> </span><span class="n">different</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">variants</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="p">(</span><span class="n">see</span><span class="w"> </span><span class="n">Chapter</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">details</span><span class="p">).</span><span class="w"> </span><span class="n">Sorting</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">duplicate</span><span class="o">-</span><span class="n">elimination</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="n">automatically</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">during</span><span class="w"> </span><span class="k">input</span><span class="p">,</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">shown</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">example</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="s1">&#39;a fat cat sat on a mat and ate a fat rat&#39;</span><span class="p">::</span><span class="n">tsvector</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="n">tsvector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="w"> </span><span class="s1">&#39;and&#39;</span><span class="w"> </span><span class="s1">&#39;ate&#39;</span><span class="w"> </span><span class="s1">&#39;cat&#39;</span><span class="w"> </span><span class="s1">&#39;fat&#39;</span><span class="w"> </span><span class="s1">&#39;mat&#39;</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="w"> </span><span class="s1">&#39;rat&#39;</span><span class="w"> </span><span class="s1">&#39;sat&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>tsvector</code> is used to store the subword vector, let&rsquo;s look at a simple example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="s1">&#39;一&#39;</span><span class="p">:</span><span class="mi">66</span><span class="n">B</span><span class="p">,</span><span class="mi">70</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;一部分&#39;</span><span class="p">:</span><span class="mi">68</span><span class="n">B</span><span class="p">,</span><span class="mi">72</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;上&#39;</span><span class="p">:</span><span class="mi">35</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;不是&#39;</span><span class="p">:</span><span class="mi">62</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;两极&#39;</span><span class="p">:</span><span class="mi">29</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;两极分化&#39;</span><span class="p">:</span><span class="mi">31</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;中国&#39;</span><span class="p">:</span><span class="mi">44</span><span class="n">B</span><span class="p">,</span><span class="mi">54</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;丰&#39;</span><span class="p">:</span><span class="mi">19</span><span class="n">B</span><span class="w"> </span><span class="s1">&#39;丰衣足食&#39;</span><span class="p">:</span><span class="mi">22</span><span class="n">B</span><span class="p">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, here is what we said earlier about the inverted index, each is a word and the position of the word composed of the <code>A</code> and <code>B</code> is actually the weight of the word, PG has ABCD 4 weights, A&rsquo;s weight is the highest, D&rsquo;s lowest. The higher the weight, the higher the ranking can be when the subsequent search.</p>
<h2 id="build-inverted-index">Build inverted index</h2>
<p>After we get the article, we have to do the splitting first, I use <code>sego</code>, the reason is that <code>gojieba</code> is always somehow panic, so for simplicity, I use <code>sego</code> first, assuming that later we find that <code>sego</code> optimization space is not enough, then we can use <code>jieba</code> Python version encapsulated as a service to provide out.</p>
<p>My database is designed as follows</p>
<ul>
<li><code>title</code> title</li>
<li><code>description</code> article or description</li>
<li><code>tokens</code> stores the subword vectors</li>
</ul>
<p>This should work for most scenarios, such as searching for articles, products, lyrics, posts, etc. The code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">titleWords</span>       <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">descriptionWords</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sego</span><span class="p">.</span><span class="nf">SegmentsToSlice</span><span class="p">(</span><span class="nx">segmenter</span><span class="p">.</span><span class="nf">Segment</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cargo</span><span class="p">.</span><span class="nx">Title</span><span class="p">)),</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">titleWords</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">titleWords</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sego</span><span class="p">.</span><span class="nf">SegmentsToSlice</span><span class="p">(</span><span class="nx">segmenter</span><span class="p">.</span><span class="nf">Segment</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cargo</span><span class="p">.</span><span class="nx">Description</span><span class="p">)),</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">descriptionWords</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">descriptionWords</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next step is to update the results of the word split into.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">sql</span> <span class="o">:=</span> <span class="s">`UPDATE cargos SET tokens = setweight(to_tsvector(&#39;simple&#39;, $1), &#39;A&#39;) || setweight(to_tsvector(&#39;simple&#39;, $2), &#39;B&#39;) WHERE id = $3`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sql</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">titleWords</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">),</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">descriptionWords</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">),</span> <span class="nx">cargo</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use <code>to_tsvector</code> to set the vector, preceded by <code>simple</code> to indicate that it is cut by spaces, or by <code>english</code> by default if not given. The <code>setweight</code> function is used to set the weight of the result of <code>to_tsvector</code>, and there are <code>ABCD</code> options for the weight, as described above. <code>||</code> is used to merge multiple subword vectors.</p>
<p>This mode is actually controlling the subword entirely at the application level, and most of the cases that can be searched online are based on the compiled PG plugin form. I prefer application-level subscripts, which have the following advantages.</p>
<ul>
<li>Simple maintenance and no compilation. If it is a cloud-hosted PG, it may not be able to load self-compiled plugins</li>
<li>Easy to scale, application level scaling is much easier than database level scaling. The word splitting itself is a CPU-intensive task, so it is easy to reach the bottleneck in the database.</li>
<li>The application is fast to update, and it is very easy to update any new features and functions of the Pictionary plugin.</li>
</ul>
<p>At this point, we&rsquo;ve updated the subword vector in. Next we still need to create the index.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="n">pg_trgm</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">cargos_token_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cargos</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">GIN</span><span class="p">(</span><span class="n">tokens</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>I use the GIN index, in addition to the GiST option, see the difference at: <a href="https://www.postgresql.org/docs/current/textsearch-indexes.html">https://www.postgresql.org/docs/current/textsearch-indexes.html</a>.</p>
<h2 id="searching">Searching</h2>
<p>After saving the data, the next thing we have to do is to search.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">queryWords</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sego</span><span class="p">.</span><span class="nf">SegmentsToSlice</span><span class="p">(</span><span class="nx">segmenter</span><span class="p">.</span><span class="nf">Segment</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">query</span><span class="p">)),</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">queryWords</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">queryWords</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">sql</span> <span class="o">:=</span> <span class="s">`SELECT id, created_at, updated_at, title, ts_rank(tokens, query) AS score FROM cargos, to_tsquery(&#39;simple&#39;, $1) query WHERE tokens @@ query ORDER BY score DESC`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sql</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">queryWords</span><span class="p">,</span> <span class="s">&#34; | &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>to_tsquery</code> is a parsing query statement with the following syntax (refer to <a href="https://www.postgresql.org/docs/current/datatype-textsearch.html#DATATYPE-TSQUERY">documentation</a>).</p>
<ul>
<li><code>&amp;</code> means both conditions must be satisfied</li>
<li><code>|</code> means one of them is satisfied</li>
<li><code>!</code> NOT operation means no match</li>
<li><code>&lt;-&gt;</code> means that the A word follows the B word, almost like <code>A.... B</code> structure</li>
<li><code>blabla*</code> means it matches the prefix</li>
</ul>
<p><code>ts_rank</code> is calculated based on the weight, which is convenient for the subsequent <code>ORDER BY</code> ranking.</p>
<h2 id="performance-testing">Performance testing</h2>
<p>I have repeatedly imported all the articles of the blog many times to get together 100 million subwords, here is the actual test data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="err">\</span><span class="n">timing</span><span class="w"> </span><span class="k">on</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Timing</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">on</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ts_rank</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">,</span><span class="w"> </span><span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;共同 &amp; 富裕&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">775</span><span class="w"> </span><span class="n">ms</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">行结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ts_rank</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">,</span><span class="w"> </span><span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Linux&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">317</span><span class="p">.</span><span class="mi">306</span><span class="w"> </span><span class="n">ms</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="mi">47775</span><span class="w"> </span><span class="err">行结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ts_rank</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">,</span><span class="w"> </span><span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Go &amp; 并发&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">111</span><span class="p">.</span><span class="mi">316</span><span class="w"> </span><span class="n">ms</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="mi">16170</span><span class="w"> </span><span class="err">行结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">ts_rank</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">,</span><span class="w"> </span><span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Windows &amp; 虚拟机&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">.</span><span class="mi">231</span><span class="w"> </span><span class="n">ms</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="mi">8085</span><span class="w"> </span><span class="err">行结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">count</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">--------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="mi">360152</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">48</span><span class="p">.</span><span class="mi">547</span><span class="w"> </span><span class="n">ms</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">LENGTH</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cargos</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">sum</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-----------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="mi">101115491</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">477</span><span class="p">.</span><span class="mi">441</span><span class="w"> </span><span class="n">ms</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the total number of articles is 360,000, and the total number of words is about 100 million after the word separation. When searching, the response time is basically proportional to the number of results returned, and the response is very fast if there are few search results. I think the common scenario PG is completely enough to cover. There are still many places to optimize, for example, removing common tone words, removing punctuation, special characters, removing most useless words, using TF-IDF to extract keywords to give higher weight, and reducing the weight of the rest of the words, after these optimizations, the overall performance should be much better.</p>
<h2 id="summary">Summary</h2>
<p>This article summarizes my experience of tossing PG as a search engine, after verification, PG is fully capable of common scenarios, in the future I do some of my own what need to search capabilities, I believe this solution can make the overall simpler.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/postgresql/">PostgreSQL</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/go-project-layout/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How should the standard structure of a Go project be laid out?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/golang-migrate-iofs/">
            <span class="next-text nav-default">Golang migrate for database change management</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
