<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Principles of container technology (5): file system isolation and sharing - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the principles of container technology and explore how to implement file system isolation and sharing." /><meta name="keywords" content="docker, Volumes, fs" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/container-fundamentals-filesystem-isolation-and-sharing/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Principles of container technology (5): file system isolation and sharing" />
<meta property="og:description" content="Learn the principles of container technology and explore how to implement file system isolation and sharing." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/container-fundamentals-filesystem-isolation-and-sharing/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-16T16:41:10+08:00" />
<meta property="article:modified_time" content="2022-04-16T16:41:10+08:00" />

<meta itemprop="name" content="Principles of container technology (5): file system isolation and sharing">
<meta itemprop="description" content="Learn the principles of container technology and explore how to implement file system isolation and sharing."><meta itemprop="datePublished" content="2022-04-16T16:41:10+08:00" />
<meta itemprop="dateModified" content="2022-04-16T16:41:10+08:00" />
<meta itemprop="wordCount" content="2324">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Principles of container technology (5): file system isolation and sharing"/>
<meta name="twitter:description" content="Learn the principles of container technology and explore how to implement file system isolation and sharing."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Principles of container technology (5): file system isolation and sharing</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-16 16:41:10 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2324 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background-knowledge">Background Knowledge</a>
          <ul>
            <li><a href="#directories-vs-file-systems">Directories vs. file systems</a></li>
            <li><a href="#what-is-rootfs">What is <code>rootfs</code>?</a></li>
          </ul>
        </li>
        <li><a href="#the-nature-of-mount-namespace-and-how-it-works">The nature of mount namespace and how it works</a>
          <ul>
            <li><a href="#creating-a-new-mount-namespace-in-a-container">Creating a new mount namespace in a container</a></li>
          </ul>
        </li>
        <li><a href="#switching-root-directories-with-pivot_root-or-chroot">Switching root directories with pivot_root or chroot</a>
          <ul>
            <li><a href="#example-of-chroot-command-usage">Example of chroot command usage</a></li>
          </ul>
        </li>
        <li><a href="#bind-mount--share-files-between-host-and-container">bind mount : share files between host and container</a>
          <ul>
            <li><a href="#using-bind-mount-in-a-container">Using bind mount in a container</a></li>
            <li><a href="#what-are-docker-volumes">What are docker volumes</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="background-knowledge">Background Knowledge</h2>
<p>All accessible files on a Unix system are organized in a huge tree-like file hierarchy, the root node of which is the <code>/</code> directory. These files can be scattered and stored in different devices, provided that we mount the file systems on those devices into the file tree using the <code>mount</code> system call.</p>
<h3 id="directories-vs-file-systems">Directories vs. file systems</h3>
<p>It is important to understand the difference between a file system and a directory. A file system is a part of a storage device such as a hard disk that is allocated to hold file data. After a file system is mounted on a directory, the files stored in this part can be accessed. After the file system is mounted, it is accessible to the end user just like a normal directory.</p>
<p>We often refer to <code>ext</code>, <code>xfs</code> and <code>zfs</code> as types of file systems. Different types of file systems access and manage data in different ways, and Linux supports many types of file systems.</p>
<h3 id="what-is-rootfs">What is <code>rootfs</code>?</h3>
<p><code>rootfs</code> (Root Filesystem) is the top of the hierarchical file tree. It contains files and directories that are critical to the operation of the system, including device directories and programs used to boot the system. <code>rootfs</code> also contains a number of mount points through which other file systems can connect to the <code>rootfs</code> file tree. <code>rootfs</code> is usually provided by Linux distributions, and the contents of a typical <code>rootfs</code> are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ls /
</span></span><span class="line"><span class="cl">boot  etc   home  lib64  mnt  proc  run   srv  tmp  var
</span></span><span class="line"><span class="cl">bin   dev   lib   media  opt  root  sbin  sys  usr
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the system boots, the initialization process mounts <code>rootfs</code> to the <code>/</code> directory and then mounts other filesystems to their subdirectories. All <code>mount</code> system calls during this time are recorded in the initialization process&rsquo;s <code>mount table</code>, and all processes have a separate <code>mount table</code> recorded in <code>/proc/{PID}/mounts</code>. In general, however, all processes on the system use the initialization process&rsquo;s <code>mount table</code> directly.</p>
<h2 id="the-nature-of-mount-namespace-and-how-it-works">The nature of mount namespace and how it works</h2>
<p>Each process can create its own <code>mount table</code>, but only if it first copies the <code>mount table</code> of its parent process, and any changes that occur when <code>mount</code> is called later will only affect the <code>mount table</code> of the current process, which is how mount namespace works. If multiple processes are in the same mount namespace, any changes made to the <code>mount table</code> by one process will be visible to the other processes as well.</p>
<p>Now let&rsquo;s actually see all the mount namespaces that currently exist on the system, with the help of the <code>cinf</code> tool described in the previous article.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cinf <span class="p">|</span> grep mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> NAMESPACE   TYPE  NPROCS  USERS                      CMD
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="m">4026531840</span>  mnt   <span class="m">130</span>     0,32,70,81,89,998,999      /sbin/init splash
</span></span><span class="line"><span class="cl"> <span class="m">4026531860</span>  mnt   <span class="m">1</span>       <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">4026532320</span>  mnt   <span class="m">1</span>       <span class="m">997</span>                        /usr/sbin/chronyd
</span></span><span class="line"><span class="cl"> <span class="m">4026532389</span>  mnt   <span class="m">1</span>       <span class="m">0</span>                          sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output of the command is somewhat processed to give a clearer picture, and the number of processes (NPROCS) shows that most of the processes are located in the <code>4026531840</code> mount namspace created by the initialization process <code>/sbin/init</code>. Generally new processes do not create new mount namespace, and if you print the <code>mount table</code> of these processes, <code>/proc/{PID}/mounts</code>, you will see that the output is the same.</p>
<p>When you create a new mount namespace, a copy of the mount point from the parent namespace is created in the new mount namspace. We will verify this by creating a new mount namespace with <code>unshare -m</code> and will also use the <code>filesystem bundle</code> we created with the Docker image in the previous article.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> /mycontainer/rootfs
</span></span><span class="line"><span class="cl"><span class="nv">PS1</span><span class="o">=</span><span class="s1">&#39;\u@new-mnt$ &#39;</span> unshare -Umr
</span></span></code></pre></td></tr></table>
</div>
</div><p>After executing this command we are in a new mount namespace, but still see all the mount points in the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ df -h
</span></span><span class="line"><span class="cl">文件系统        容量  已用  可用 已用% 挂载点
</span></span><span class="line"><span class="cl">/dev/sdb3       119G   28G   86G   25% /
</span></span><span class="line"><span class="cl">tmpfs           7.8G     <span class="m">0</span>  7.8G    0% /dev/shm
</span></span><span class="line"><span class="cl">tmpfs           1.6G  1.9M  1.6G    1% /run
</span></span><span class="line"><span class="cl">tmpfs           5.0M  4.0K  5.0M    1% /run/lock
</span></span><span class="line"><span class="cl">tmpfs           1.6G   84K  1.6G    1% /run/user/121
</span></span><span class="line"><span class="cl">tmpfs           1.6G   68K  1.6G    1% /run/user/0
</span></span><span class="line"><span class="cl">tmpfs           4.0M     <span class="m">0</span>  4.0M    0% /sys/fs/cgroup
</span></span><span class="line"><span class="cl">/dev/sdb2        94G  5.8G   83G    7% /home
</span></span><span class="line"><span class="cl">/dev/sda2        96M   30M   67M   31% /boot/efi
</span></span></code></pre></td></tr></table>
</div>
</div><p>In turn, when we perform a new mount on the new mount namespace, the corresponding records are not visible from the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># in new mount namspace</span>
</span></span><span class="line"><span class="cl">$ mount -t tmpfs tmpfs /mnt
</span></span><span class="line"><span class="cl">$ findmnt <span class="p">|</span> grep mnt
</span></span><span class="line"><span class="cl">└─/mnt
</span></span><span class="line"><span class="cl">        tmpfs                  tmpfs           rw,relatime,inode64
</span></span><span class="line"><span class="cl"><span class="c1"># in host</span>
</span></span><span class="line"><span class="cl">$ findmnt <span class="p">|</span> grep mnt
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is how mount namespace works.</p>
<h3 id="creating-a-new-mount-namespace-in-a-container">Creating a new mount namespace in a container</h3>
<p>Now create a new container to see the changes to mount namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> /mycontainer
</span></span><span class="line"><span class="cl">$ runc run mybox
</span></span></code></pre></td></tr></table>
</div>
</div><p>In a new window, we query namespace from the host environment using <code>cinf</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cinf <span class="p">|</span> grep mnt
</span></span><span class="line"><span class="cl"> <span class="m">4026531840</span>  mnt   <span class="m">134</span>     0,32,70,81,89,998,999      /usr/lib/systemd/systemd --swi
</span></span><span class="line"><span class="cl"> <span class="m">4026531860</span>  mnt   <span class="m">1</span>       <span class="m">0</span>
</span></span><span class="line"><span class="cl"> <span class="m">4026532320</span>  mnt   <span class="m">1</span>       <span class="m">997</span>                        /usr/sbin/chronyd
</span></span><span class="line"><span class="cl"> <span class="m">4026532325</span>  mnt   <span class="m">1</span>       <span class="m">0</span>                          sh
</span></span><span class="line"><span class="cl"> <span class="m">4026532389</span>  mnt   <span class="m">1</span>       <span class="m">0</span>                          sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>You will see that a new mount namespace <code>4026532325</code> has been added, and the process that created it is the container&rsquo;s <code>init</code> process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cinf --namespace <span class="m">4026532325</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> PID   PPID  NAME  CMD  NTHREADS  CGROUPS                                                           STATE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="m">7656</span>  <span class="m">7646</span>  sh    sh   <span class="m">1</span>         11:blkio:/mybox 10:devices:/mybox 9:pids:/mybox                   S <span class="o">(</span>sleeping<span class="o">)</span>
</span></span><span class="line"><span class="cl">                                  8:cpu,cpuacct:/mybox 7:net_cls,net_prio:/mybox
</span></span><span class="line"><span class="cl">                                  6:freezer:/mybox 5:memory:/mybox 4:cpuset:/mybox
</span></span><span class="line"><span class="cl">                                  3:hugetlb:/mybox 2:perf_event:/mybox
</span></span><span class="line"><span class="cl">                                  1:name<span class="o">=</span>systemd:/user.slice/user-0.slice/session-1231.scope/mybox
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ runc ps mybox
</span></span><span class="line"><span class="cl">UID        PID  PPID  C STIME TTY          TIME CMD
</span></span><span class="line"><span class="cl">root      <span class="m">7656</span>  <span class="m">7646</span>  <span class="m">0</span> 14:39 pts/0    00:00:00 sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that creating a new mount namspace does not create a completely new <code>mount table</code>, but changes it on a copy of the parent process&rsquo; mount namspace. So when creating the container, the new container container has all the mount points of the host, which is obviously not what we expect when we want to create an isolated filesystem for the container using <code>rootfs</code> in the <code>filesystem bundle</code>. This requires us to <code>unmount</code> the current <code>rootfs</code> in the new mount namespace and <code>mount</code> the <code>rootfs</code> in the <code>filesystem bundle</code> to the <code>/</code> directory. We can verify this by printing the <code>inode</code> number of the <code>/</code> directory using <code>ls -id</code> in the container and host respectively.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在容器中打印 / 目录</span>
</span></span><span class="line"><span class="cl">$ ls -id /
</span></span><span class="line"><span class="cl"><span class="m">7077890</span> /
</span></span><span class="line"><span class="cl"><span class="c1"># 在宿主机中打印 filesystem bundle 中 rootfs 所在目录</span>
</span></span><span class="line"><span class="cl">$ ls -id /mycontainer/rootfs
</span></span><span class="line"><span class="cl"><span class="m">7077890</span> /mycontainer/rootfs
</span></span></code></pre></td></tr></table>
</div>
</div><p>This cannot be done with <code>mount</code>, because we cannot make all processes stop using the current <code>rootfs</code>, which must be in use and cannot be <code>unmounted</code>. But there is an alternative route to take: use the <code>pivot_root</code> system call, which allows us to remount <code>rootfs</code> to a location other than <code>/</code>, while mounting a new directory on the <code>/</code> directory and switching the root of all current processes to the new directory. After that we can <code>unmount</code> the original <code>rootfs</code> without any problems.</p>
<h2 id="switching-root-directories-with-pivot_root-or-chroot">Switching root directories with pivot_root or chroot</h2>
<p><code>pivot_root</code> is a system call provided by Linux that switches the root and current working directory of all processes in a mount namespace to a new directory. The main purpose of <code>pivot_root</code> is to mount a temporary <code>rootfs</code> for a specific function at system boot time, and then switch to the real <code>rootfs</code>.</p>
<p>During container creation, after creating a new mount namespace, we can use <code>pivot_root()</code> to switch the root directory of the processes in the container to the directory where <code>rootfs</code> is located in the <code>filesystem bundle</code>.</p>
<h3 id="example-of-chroot-command-usage">Example of chroot command usage</h3>
<p>In addition to <code>pivot_root</code>, Linux also provides the <code>chroot</code> system call to change the root directory of the current process to a new directory, which will be inherited by all children of the current process.</p>
<p>Both <code>pivot_root</code> and <code>chroot</code> mentioned above are system calls provided by the Linux kernel, and each of them has a command line program that implements a simple wrapper around the system call.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 切换到有效的 filesystem bundle 目录</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /mycontainer
</span></span><span class="line"><span class="cl">$ chroot rootfs /bin/sh
</span></span><span class="line"><span class="cl"><span class="c1"># 进入到一个新的shell中</span>
</span></span><span class="line"><span class="cl">$ ls /
</span></span><span class="line"><span class="cl">bin   dev   etc   home  old   proc  root  sys   tmp   usr   var
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the new shell program, executing <code>ls</code> returns the contents of the <code>/mycontainer/rootfs</code> directory instead of the contents of the root directory of the host. With the <code>chroot</code> command, we can also switch the root directory of the processes in the container without the need for <code>mount namespace</code>.</p>
<p>The <code>pivot_root</code> system call with mount namspace is safer than <code>chroot</code> and is preferred when the container is running, but <code>chroot</code> is also optional. The implementation of <code>runC</code> has the following (Golang) code snippet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">NoPivotRoot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">msMoveRoot</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">Rootfs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">config</span><span class="p">.</span><span class="n">Namespaces</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">configs</span><span class="p">.</span><span class="n">NEWNS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">pivotRoot</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">Rootfs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">chroot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ignore the first user-specified <code>no root switch</code> selection branch, the remaining branches represent the two ways to switch root directories.</p>
<ul>
<li>If a new mount namespace is created, the <code>pivot_root</code> system call is used.</li>
<li>If no new mount namespace is created, <code>chroot</code> is used directly.</li>
</ul>
<h2 id="bind-mount--share-files-between-host-and-container">bind mount : share files between host and container</h2>
<p>After establishing an isolated filesystem, we also need a mechanism to access part of the host&rsquo;s filesystem from the container, or to persist data generated by the container&rsquo;s operation to the host.</p>
<p>bind mount (bind mount) is a type of mount provided by Linux, which can remount a file or directory to a new target path, after the mount, the original data will be accessible from both old and new paths, and any changes to the data from both paths will take effect, and the original content of the target path will be hidden. Take the following directory structure as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ tree .
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── A
</span></span><span class="line"><span class="cl">│   ├── a
</span></span><span class="line"><span class="cl">│   └── a.conf
</span></span><span class="line"><span class="cl">└── B
</span></span><span class="line"><span class="cl">    ├── b
</span></span><span class="line"><span class="cl">    └── b.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>Mount the A bindings to the B directory with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ mount --bind A B
</span></span></code></pre></td></tr></table>
</div>
</div><p>Afterwards, the contents of the original A directory will be accessible from both A and B directories, while the original contents of the B directory will be hidden.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ tree .
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── A
</span></span><span class="line"><span class="cl">│   ├── a
</span></span><span class="line"><span class="cl">│   └── a.conf
</span></span><span class="line"><span class="cl">└── B
</span></span><span class="line"><span class="cl">    ├── a
</span></span><span class="line"><span class="cl">    └── a.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can use bind mount to share files between the host and the container, mount directories or even block devices from the host to the container.</p>
<h3 id="using-bind-mount-in-a-container">Using bind mount in a container</h3>
<p>Here we will create a bind mount in the container that connects to the host. the container runtime implementation is to modify <code>config.json</code> in the <code>filesystem bundle</code> and add the following objects to the <code>mounts</code> list of the JSON object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;destination&#34;</span><span class="p">:</span> <span class="s2">&#34;/host_dir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;bind&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;/mycontainer/host&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;options&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;bind&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This tells the container runtime to mount the <code>/mycontainer/host</code> directory in the host (or <code>host</code> if using a relative path, relative to the <code>filesystem bundle</code> directory) to the <code>/host_dir</code> directory in the container&rsquo;s <code>rootfs</code>. The <code>host</code> directory in the host must exist in advance, while the <code>host_dir</code> in the container will be created automatically by the container at runtime if it does not exist. Now we create the <code>host</code> directory in the host and populate it with a file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> /mycontainer
</span></span><span class="line"><span class="cl">$ mkdir host
</span></span><span class="line"><span class="cl">$ touch mkdir/hello
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then run the container and we will see the contents of the host <code>/mycontainer/host</code> directory in the container&rsquo;s <code>/host_dir</code> directory, and the files in that directory will also be visible to the host when modified within the container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># in container</span>
</span></span><span class="line"><span class="cl">$ ls /host_dir
</span></span><span class="line"><span class="cl">hello
</span></span><span class="line"><span class="cl">$ touch /host_dir/world
</span></span><span class="line"><span class="cl"><span class="c1"># in host</span>
</span></span><span class="line"><span class="cl">$ ls /mycontainer/host
</span></span><span class="line"><span class="cl">hello  world
</span></span></code></pre></td></tr></table>
</div>
</div><p>Also, since the binding of the mount takes place in the mount namespace of the container, the host is not aware of the existence of the mount point.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># in container</span>
</span></span><span class="line"><span class="cl">$ cat /proc/self/mounts <span class="p">|</span> grep host_dir
</span></span><span class="line"><span class="cl">/dev/sdb3 /host_dir ext4 rw,relatime,errors<span class="o">=</span>remount-ro <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in host</span>
</span></span><span class="line"><span class="cl">$ cat /proc/self/mounts <span class="p">|</span> grep host_dir
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the first article of the series, we mentioned that the mount point of the binding mount is located in the writeable layer of the container. Although the whole writeable layer will be deleted after the container is deleted, the write data during the operation of the container will still remain in the mount path of the host, so the data in the container can be persisted through this route.</p>
<h3 id="what-are-docker-volumes">What are docker volumes</h3>
<p>Dcoekr provides Volumes (a term that does not exist in the OCI specification) to persist data in containers, and the underlying implementation uses bind mount to mount path bindings in the host to the container, compared to Docker which provides a more friendly command line interface, and also provides <code>named volume</code>, which (on Instead of specifying an existing directory in the host, Docker manages it by creating a separate directory in its host&rsquo;s data directory.</p>
<h2 id="summary">Summary</h2>
<p>In this article we have discussed several aspects related to container filesystems.</p>
<ul>
<li>Using mount namespace to create a separate file system environment in the container, but not completely isolated from the host at this point.</li>
<li>Use <code>pivot_root</code> to switch the root directory in the container to the <code>rootfs</code> provided by the image, so that it cannot access other paths on the host and is isolated.</li>
<li>Use bind mount to share data between the host and the container or to persist the data generated while the container is running.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/porter/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A PaaS system powered by Kubernetes - Porter</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/container-fundamentals-permission-control-using-capabilities/">
            <span class="next-text nav-default">Principles of container technology (4): Using Capabilities to Implement Permission Control</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
