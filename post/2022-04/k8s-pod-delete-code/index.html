<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kubernetes Pod Delete Operation Source Code Analysis - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the source code for the Kubernetes Pod delete operation." /><meta name="keywords" content="Kubernetes, pod, Delete" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/k8s-pod-delete-code/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Kubernetes Pod Delete Operation Source Code Analysis" />
<meta property="og:description" content="Explore the source code for the Kubernetes Pod delete operation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/k8s-pod-delete-code/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-09T10:57:18+08:00" />
<meta property="article:modified_time" content="2022-04-09T10:57:18+08:00" />

<meta itemprop="name" content="Kubernetes Pod Delete Operation Source Code Analysis">
<meta itemprop="description" content="Explore the source code for the Kubernetes Pod delete operation."><meta itemprop="datePublished" content="2022-04-09T10:57:18+08:00" />
<meta itemprop="dateModified" content="2022-04-09T10:57:18+08:00" />
<meta itemprop="wordCount" content="2847">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes Pod Delete Operation Source Code Analysis"/>
<meta name="twitter:description" content="Explore the source code for the Kubernetes Pod delete operation."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kubernetes Pod Delete Operation Source Code Analysis</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-09 10:57:18 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2847 words </span>
          <span class="more-meta"> 14 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#delete-status">Delete Status</a></li>
        <li><a href="#elegant-deletion">Elegant deletion</a></li>
        <li><a href="#synchronization-status">Synchronization Status</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>For example, now I have an application with an update policy of <code>Recreate</code>, and then execute the delete command as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl get pods
</span></span><span class="line"><span class="cl">NAME                    READY   STATUS    RESTARTS        AGE
</span></span><span class="line"><span class="cl">minio-875749785-sv5ns   1/1     Running   <span class="m">1</span> <span class="o">(</span>2m52s ago<span class="o">)</span>   42h
</span></span><span class="line"><span class="cl">☸ ➜ kubectl delete pod minio-875749785-sv5ns
</span></span><span class="line"><span class="cl">pod <span class="s2">&#34;minio-875749785-sv5ns&#34;</span> deleted
</span></span></code></pre></td></tr></table>
</div>
</div><p>Observe the application status on another terminal before deleting it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl get pods -w
</span></span><span class="line"><span class="cl">NAME                    READY   STATUS              RESTARTS         AGE
</span></span><span class="line"><span class="cl">minio-875749785-sv5ns   1/1     Running             <span class="m">1</span> <span class="o">(</span>2m46s ago<span class="o">)</span>   42h
</span></span><span class="line"><span class="cl">minio-875749785-sv5ns   1/1     Terminating         <span class="m">1</span> <span class="o">(</span>2m57s ago<span class="o">)</span>   42h
</span></span><span class="line"><span class="cl">minio-875749785-h2j2b   0/1     Pending             <span class="m">0</span>               0s
</span></span><span class="line"><span class="cl">minio-875749785-h2j2b   0/1     Pending             <span class="m">0</span>               0s
</span></span><span class="line"><span class="cl">minio-875749785-h2j2b   0/1     ContainerCreating   <span class="m">0</span>               0s
</span></span><span class="line"><span class="cl">minio-875749785-sv5ns   0/1     Terminating         <span class="m">1</span> <span class="o">(</span>2m59s ago<span class="o">)</span>   42h
</span></span><span class="line"><span class="cl">minio-875749785-sv5ns   0/1     Terminating         <span class="m">1</span> <span class="o">(</span>2m59s ago<span class="o">)</span>   42h
</span></span><span class="line"><span class="cl">minio-875749785-sv5ns   0/1     Terminating         <span class="m">1</span> <span class="o">(</span>2m59s ago<span class="o">)</span>   42h
</span></span><span class="line"><span class="cl">minio-875749785-h2j2b   0/1     Running             <span class="m">0</span>               17s
</span></span><span class="line"><span class="cl">minio-875749785-h2j2b   1/1     Running             <span class="m">0</span>               30s
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the above process, the Pod becomes <code>Terminating</code> after we execute the <code>kubectl delete</code> command, and then disappears. Next, we will describe the overall process of deleting a Pod from a code perspective.</p>
<blockquote>
<p>Here we will use Kubernetes version <code>v1.22.8</code> as an example. Other versions are not guaranteed to be identical, but the overall idea is the same.</p>
</blockquote>
<h2 id="delete-status">Delete Status</h2>
<p>We can track the status based on what we see after the kubectl operation, the formatting above is done with the code <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/printers/internalversion/printers.go#L88-L102">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/printers/internalversion/printers.go#L88-L102</a>. This is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// TODO: handle errors from Handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">AddHandlers</span><span class="p">(</span><span class="nx">h</span> <span class="nx">printers</span><span class="p">.</span><span class="nx">PrintHandler</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">podColumnDefinitions</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">TableColumnDefinition</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Name&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Format</span><span class="p">:</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{}.</span><span class="nf">SwaggerDoc</span><span class="p">()[</span><span class="s">&#34;name&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Ready&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="s">&#34;The aggregate readiness state of this pod for accepting traffic.&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Status&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="s">&#34;The aggregate status of the containers in this pod.&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Restarts&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="s">&#34;The number of times the containers in this pod have been restarted and when the last container in this pod has restarted.&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Age&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{}.</span><span class="nf">SwaggerDoc</span><span class="p">()[</span><span class="s">&#34;creationTimestamp&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;IP&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="nx">apiv1</span><span class="p">.</span><span class="nx">PodStatus</span><span class="p">{}.</span><span class="nf">SwaggerDoc</span><span class="p">()[</span><span class="s">&#34;podIP&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Node&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="nx">apiv1</span><span class="p">.</span><span class="nx">PodSpec</span><span class="p">{}.</span><span class="nf">SwaggerDoc</span><span class="p">()[</span><span class="s">&#34;nodeName&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Nominated Node&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="nx">apiv1</span><span class="p">.</span><span class="nx">PodStatus</span><span class="p">{}.</span><span class="nf">SwaggerDoc</span><span class="p">()[</span><span class="s">&#34;nominatedNodeName&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Readiness Gates&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Priority</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">Description</span><span class="p">:</span> <span class="nx">apiv1</span><span class="p">.</span><span class="nx">PodSpec</span><span class="p">{}.</span><span class="nf">SwaggerDoc</span><span class="p">()[</span><span class="s">&#34;readinessGates&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nf">TableHandler</span><span class="p">(</span><span class="nx">podColumnDefinitions</span><span class="p">,</span> <span class="nx">printPodList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nf">TableHandler</span><span class="p">(</span><span class="nx">podColumnDefinitions</span><span class="p">,</span> <span class="nx">printPod</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The output for the Pod is obtained using the <code>printPod</code> function, the code is located at: <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/printers/internalversion/printers.go#L756-L840">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/printers/internalversion/printers.go#L756-L840</a>, where there is a section of code that refers to the <code>Terminating</code> value, which is changed to that state if <code>pod.DeletionTimestamp ! = nil</code>. This is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Reason</span> <span class="o">==</span> <span class="nx">node</span><span class="p">.</span><span class="nx">NodeUnreachablePodReason</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reason</span> <span class="p">=</span> <span class="s">&#34;Unknown&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reason</span> <span class="p">=</span> <span class="s">&#34;Terminating&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This means that when a delete operation is performed, the <code>DeletionTimestamp</code> property of the Pod is set, and the <code>Terminating</code> state is displayed at this time.</p>
<p>When the deletion operation is performed, a DELETE request is sent to the apiserver.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">I0408 11:25:33.002155   <span class="m">42938</span> round_trippers.go:435<span class="o">]</span> curl -v -XDELETE  -H <span class="s2">&#34;Content-Type: application/json&#34;</span> -H <span class="s2">&#34;User-Agent: kubectl/v1.22.7 (darwin/amd64) kubernetes/b56e432&#34;</span> -H <span class="s2">&#34;Accept: application/json&#34;</span> <span class="s1">&#39;https://192.168.0.111:6443/api/v1/namespaces/default/pods/minio-875749785-sv5ns&#39;</span>
</span></span><span class="line"><span class="cl">I0408 11:25:33.037245   <span class="m">42938</span> round_trippers.go:454<span class="o">]</span> DELETE https://192.168.0.111:6443/api/v1/namespaces/default/pods/minio-875749785-sv5ns <span class="m">200</span> OK in <span class="m">35</span> milliseconds
</span></span></code></pre></td></tr></table>
</div>
</div><p>The processor that received the delete request is located at the code <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L986">https://github.com/kubernetes/kubernetes/blob/v1.22.8/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L986</a>. As shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deleteValidation</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">ValidateObjectFunc</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">key</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">KeyFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">obj</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">NewFunc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">qualifiedResource</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">qualifiedResourceFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{},</span> <span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">storeerr</span><span class="p">.</span><span class="nf">InterpretDeleteError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">qualifiedResource</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// support older consumers of delete by treating &#34;nil&#34; as delete immediately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">options</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">options</span> <span class="p">=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewDeleteOptions</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">preconditions</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">Preconditions</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Preconditions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">preconditions</span><span class="p">.</span><span class="nx">UID</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Preconditions</span><span class="p">.</span><span class="nx">UID</span>
</span></span><span class="line"><span class="cl">        <span class="nx">preconditions</span><span class="p">.</span><span class="nx">ResourceVersion</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Preconditions</span><span class="p">.</span><span class="nx">ResourceVersion</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">graceful</span><span class="p">,</span> <span class="nx">pendingGraceful</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">BeforeDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DeleteStrategy</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// this means finalizers cannot be updated via DeleteOptions if a deletion is already pending
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">pendingGraceful</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">finalizeDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// check if obj has pending finalizers
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>BeforeDelete</code> function to determine whether graceful deletion is needed, the criterion is whether the <code>DeletionGracePeriodSeconds</code> value is 0, not zero is considered graceful deletion, apiserver will not immediately delete the object from etcd, otherwise it is deleted directly. For Pods, the default <code>DeletionGracePeriodSeconds</code> is 30 seconds, so here it is not deleted immediately, but <code>DeletionTimestamp</code> is set to the current time and <code>DeletionGracePeriodSeconds</code> is set to the default value of 30 seconds. The code is located at <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/staging/src/k8s.io/apiserver/pkg/registry/rest/delete.go#L93-L159">https://github.com/kubernetes/kubernetes/blob/v1.22.8/staging/src/k8s.io/apiserver/pkg/registry/rest/delete.go#L93-L159</a> and in this function will sets the value of <code>DeletionTimestamp</code>. This is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// `CheckGracefulDelete` will be implemented by specific strategy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">gracefulStrategy</span><span class="p">.</span><span class="nf">CheckGracefulDelete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewInternalError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;options.GracePeriodSeconds should not be nil&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">now</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewTime</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="nx">objectMeta</span><span class="p">.</span><span class="nf">SetDeletionTimestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">objectMeta</span><span class="p">.</span><span class="nf">SetDeletionGracePeriodSeconds</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracePeriodSeconds</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code verifies that when performing a deletion operation, apiserver will first set the <code>DeletionTimestamp</code> property of the Pod to the current time plus the time point of the graceful deletion graceful duration, and after setting this property, what our client sees after formatting is the <code>Terminating</code> state.</p>
<h2 id="elegant-deletion">Elegant deletion</h2>
<p>As Pods involve many other resources, such as sandbox containers, volume volumes, etc., they need to be recycled after deletion, and deleting a Pod is ultimately a matter of deleting the corresponding container, which requires the kubelet of the Pod&rsquo;s node to complete the cleanup. kubelet will first keep watching our Pod, and when the Pod&rsquo;s deletion When the Pod&rsquo;s deletion time is updated, it will naturally receive the event and clean up accordingly.</p>
<p>The kubelet&rsquo;s processing of Pods is mainly in the <code>syncLoop</code> function, which calls the event-related handler <code>syncLoopIteration</code>, the code of which is located in <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kubelet.go#L2040-L2079">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kubelet.go#L2040-L2079</a>. This is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">syncLoopIteration</span><span class="p">(</span><span class="nx">configCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">PodUpdate</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">SyncHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syncCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">housekeepingCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">plegCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">pleg</span><span class="p">.</span><span class="nx">PodLifecycleEvent</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">open</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">configCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Update from a config source; dispatch it to the right handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// callback.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">open</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;Update channel is closed, exiting the sync loop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Op</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">ADD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;SyncLoop ADD&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="s">&#34;pods&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// After restarting, kubelet will get all existing pods through
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ADD as if they are new pods. These pods will then go through the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// admission process and *may* be rejected. This can be resolved
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// once we have checkpointing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodAdditions</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">UPDATE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;SyncLoop UPDATE&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="s">&#34;pods&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">REMOVE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;SyncLoop REMOVE&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="s">&#34;pods&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodRemoves</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">RECONCILE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;SyncLoop RECONCILE&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="s">&#34;pods&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodReconcile</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;SyncLoop DELETE&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="s">&#34;pods&#34;</span><span class="p">,</span> <span class="nx">format</span><span class="p">.</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// DELETE is treated as a UPDATE because of graceful deletion.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">handler</span><span class="p">.</span><span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Pods</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">SET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO: Do we want to support this?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;Kubelet does not support snapshot update&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;Invalid operation type received&#34;</span><span class="p">,</span> <span class="s">&#34;operation&#34;</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">kl</span><span class="p">.</span><span class="nx">sourcesReady</span><span class="p">.</span><span class="nf">AddSource</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Source</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When performing a delete operation, apiserver will first update the <code>DeletionTimestamp</code> property in the Pod. This change is an update operation for the kubelet, so it will correspond to the <code>kubetypes.UPDATE</code> operation and will call the <code>HandlePodUpdates</code> function to update it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// HandlePodUpdates is the callback in the SyncHandler interface for pods
</span></span></span><span class="line"><span class="cl"><span class="c1">// being updated from a config source.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">HandlePodUpdates</span><span class="p">(</span><span class="nx">pods</span> <span class="p">[]</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">start</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">clock</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pod</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pods</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">kl</span><span class="p">.</span><span class="nx">podManager</span><span class="p">.</span><span class="nf">UpdatePod</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nf">IsMirrorPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">kl</span><span class="p">.</span><span class="nf">handleMirrorPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mirrorPod</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">podManager</span><span class="p">.</span><span class="nf">GetMirrorPodByPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">kl</span><span class="p">.</span><span class="nf">dispatchWork</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">SyncPodUpdate</span><span class="p">,</span> <span class="nx">mirrorPod</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>HandlePodUpdates</code>, <code>dispatchWork</code> is called to assign the Pod deletion to a specific worker for processing, and the podWorker is the specific executor, i.e. every time the Pod needs to be updated, it is sent to the podWorker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// dispatchWork starts the asynchronous sync of the pod in a pod worker.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the pod has completed termination, dispatchWork will perform no action.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">dispatchWork</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">syncType</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">SyncPodType</span><span class="p">,</span> <span class="nx">mirrorPod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">start</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Run the sync in an async worker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kl</span><span class="p">.</span><span class="nx">podWorkers</span><span class="p">.</span><span class="nf">UpdatePod</span><span class="p">(</span><span class="nx">UpdatePodOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Pod</span><span class="p">:</span>        <span class="nx">pod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">MirrorPod</span><span class="p">:</span>  <span class="nx">mirrorPod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">UpdateType</span><span class="p">:</span> <span class="nx">syncType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">StartTime</span><span class="p">:</span>  <span class="nx">start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Note the number of containers for new pods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">syncType</span> <span class="o">==</span> <span class="nx">kubetypes</span><span class="p">.</span><span class="nx">SyncPodCreate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metrics</span><span class="p">.</span><span class="nx">ContainersPerPodCount</span><span class="p">.</span><span class="nf">Observe</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Containers</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>dispatchWork</code> method calls the <code>UpdatePod</code> function to delete the Pod, the code is located in <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/pod_workers.go#L540-L765">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/pod_workers.go#L540-L765</a>, in which the Pod information is passed through a channel, and the <code>managePodLoop</code> function is called in a goroutine to process it, in which the <code>syncTerminatingPod/syncPod</code> method to perform the delete operation.</p>
<p>Eventually the <code>killPod</code> function will be called to perform the deletion of the Pod.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/5be9b2b828264273b9ab0d2875e38aca.png" alt="killPod"></p>
<p>The <code>killPod</code> function calls the container runtime to stop the container in the Pod, and the code is located at <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kubelet_pods.go#L856-L868">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kubelet_pods.go#L856-L868</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// killPod instructs the container runtime to kill the pod. This method requires that
</span></span></span><span class="line"><span class="cl"><span class="c1">// the pod status contains the result of the last syncPod, otherwise it may fail to
</span></span></span><span class="line"><span class="cl"><span class="c1">// terminate newly created containers and sandboxes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">killPod</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Call the container runtime KillPod method which stops all known running containers of the pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">containerRuntime</span><span class="p">.</span><span class="nf">KillPod</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">containerManager</span><span class="p">.</span><span class="nf">UpdateQOSCgroups</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Failed to update QoS cgroups while killing pod&#34;</span><span class="p">,</span> <span class="s">&#34;err&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The KillPod method of the container runtime is located at <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L969-L998">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L969-L998</a>. The following shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// KillPod kills all the containers of a pod. Pod may be nil, running pod must not be.
</span></span></span><span class="line"><span class="cl"><span class="c1">// gracePeriodOverride if specified allows the caller to override the pod default grace period.
</span></span></span><span class="line"><span class="cl"><span class="c1">// only hard kill paths are allowed to specify a gracePeriodOverride in the kubelet in order to not corrupt user data.
</span></span></span><span class="line"><span class="cl"><span class="c1">// it is useful when doing SIGKILL for hard eviction scenarios, or max grace period during soft eviction scenarios.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">KillPod</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">runningPod</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">killPodWithSyncResult</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">runningPod</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// killPodWithSyncResult kills a runningPod and returns SyncResult.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note: The pod passed in could be *nil* when kubelet restarted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">kubeGenericRuntimeManager</span><span class="p">)</span> <span class="nf">killPodWithSyncResult</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">runningPod</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">PodSyncResult</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">killContainerResults</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">killContainersWithSyncResult</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">runningPod</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">containerResult</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">killContainerResults</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">.</span><span class="nf">AddSyncResult</span><span class="p">(</span><span class="nx">containerResult</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// stop sandbox, the sandbox will be removed in GarbageCollect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">killSandboxResult</span> <span class="o">:=</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nf">NewSyncResult</span><span class="p">(</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">KillPodSandbox</span><span class="p">,</span> <span class="nx">runningPod</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">.</span><span class="nf">AddSyncResult</span><span class="p">(</span><span class="nx">killSandboxResult</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Stop all sandboxes belongs to same pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">podSandbox</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">runningPod</span><span class="p">.</span><span class="nx">Sandboxes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeService</span><span class="p">.</span><span class="nf">StopPodSandbox</span><span class="p">(</span><span class="nx">podSandbox</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">ID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">crierror</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">killSandboxResult</span><span class="p">.</span><span class="nf">Fail</span><span class="p">(</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ErrKillPodSandbox</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;Failed to stop sandbox&#34;</span><span class="p">,</span> <span class="s">&#34;podSandboxID&#34;</span><span class="p">,</span> <span class="nx">podSandbox</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>killPodWithSyncResult</code> method first calls the function <code>killContainersWithSyncResult</code> to kill all the running containers and then delete the sandbox of the Pod.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/27088ad4d7074ab1ba926ecac4be72d9.png" alt="killContainersWithSyncResult"></p>
<p>In this function, multiple goroutines are used to delete each container in the Pod. The method to delete the container is <code>killContainer</code>, where the hook pre-stop is executed first (if it exists) before stopping the container, the code is located at <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kuberuntime/kuberuntime_container.go#L660-L736">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/kuberuntime/kuberuntime_container.go#L660-L736</a>.</p>
<p>First get the graceful deletion grace time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// From this point, pod and container must be non-nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gracePeriod</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">minimumGracePeriodInSeconds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">DeletionGracePeriodSeconds</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">reason</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">reasonStartupProbe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">StartupProbe</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">StartupProbe</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">containerSpec</span><span class="p">.</span><span class="nx">StartupProbe</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">reasonLivenessProbe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">LivenessProbe</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">containerSpec</span><span class="p">.</span><span class="nx">LivenessProbe</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">gracePeriod</span> <span class="p">=</span> <span class="o">*</span><span class="nx">containerSpec</span><span class="p">.</span><span class="nx">LivenessProbe</span><span class="p">.</span><span class="nx">TerminationGracePeriodSeconds</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Where <code>TerminationGracePeriodSeconds</code> can be set in the resource manifest file, the default is 30 seconds, this time is, after sending a shutdown command to Pod will send SIGTERM signal to the application, the program only needs to capture the SIGTERM signal and do the corresponding processing. This is the time that the application can gracefully shut down after the Pod receives the SIGTERM signal. This time is set by the apiserver, which was analyzed earlier.</p>
<p>If the pre-stop hook is configured and there is enough time left, the hook will be executed. The pre-stop is mainly for the business to stop gracefully before the container is deleted, such as resource recycling and other operations.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/1a4cd7d61e7e47f68a20fc24c2394161.png" alt="TerminationGracePeriodSeconds"></p>
<p>Finally it will actually go to call the underlying container runtime to stop the container.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/2d6fe3442f334c9e95611ba7dc6ccb9a.png" alt="stop the container"></p>
<p>After the container is deleted and returned to the <code>killPodWithSyncResult</code> function, the next step is to call the <code>StopPodSandbox</code> function of the runtime service to stop the sandbox container, that is, the pause container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Stop all sandboxes belongs to same pod
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">podSandbox</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">runningPod</span><span class="p">.</span><span class="nx">Sandboxes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">runtimeService</span><span class="p">.</span><span class="nf">StopPodSandbox</span><span class="p">(</span><span class="nx">podSandbox</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nx">ID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">crierror</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">killSandboxResult</span><span class="p">.</span><span class="nf">Fail</span><span class="p">(</span><span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ErrKillPodSandbox</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">ErrorS</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;Failed to stop sandbox&#34;</span><span class="p">,</span> <span class="s">&#34;podSandboxID&#34;</span><span class="p">,</span> <span class="nx">podSandbox</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is where the kubelet completes the graceful removal of the Pod, but it doesn&rsquo;t end there.</p>
<h2 id="synchronization-status">Synchronization Status</h2>
<p>For graceful deletion, at first the apiserver just set the <code>DeletionTimestamp</code> property to the Pod, and then the kubelet watch was updated to complete the graceful deletion of the Pod, but now there is still a record of the Pod on the server side, and it is not really deleted.</p>
<p>When the kubelet starts, it also starts a statusManager synchronization loop, which is the real source of the kubelet pod status and should be in sync with the latest `v1. manager to synchronize the status back to the apiserver.</p>
<p>The status manager will call the <code>syncPod</code> method underneath the manager to handle the status synchronization with the apiserver, which is located at <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/status/status_manager.go#L149-L181">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/status/status_manager.go#L149-L181</a>. As follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Don&#39;t start the status manager if we don&#39;t have a client. This will happen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on the master, where the kubelet is responsible for bootstrapping the pods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// of the master components.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">kubeClient</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Kubernetes client is nil, not starting status manager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">klog</span><span class="p">.</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Starting to sync pod status with apiserver&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//lint:ignore SA1015 Ticker can link since this is only called once and doesn&#39;t handle termination.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">syncTicker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Tick</span><span class="p">(</span><span class="nx">syncPeriod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// syncPod and syncBatch share the same go routine to avoid sync races.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Forever</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nx">syncRequest</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">m</span><span class="p">.</span><span class="nx">podStatusChannel</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Status Manager: syncing pod with status from podStatusChannel&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;podUID&#34;</span><span class="p">,</span> <span class="nx">syncRequest</span><span class="p">.</span><span class="nx">podUID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;statusVersion&#34;</span><span class="p">,</span> <span class="nx">syncRequest</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;status&#34;</span><span class="p">,</span> <span class="nx">syncRequest</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nf">syncPod</span><span class="p">(</span><span class="nx">syncRequest</span><span class="p">.</span><span class="nx">podUID</span><span class="p">,</span> <span class="nx">syncRequest</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">syncTicker</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Status Manager: syncing batch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// remove any entries in the status channel since the batch will handle them
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">podStatusChannel</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;-</span><span class="nx">m</span><span class="p">.</span><span class="nx">podStatusChannel</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nf">syncBatch</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The method determines whether the Pod has been gracefully stopped, and the code is located at <a href="https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/status/status_manager.go#L583-L652">https://github.com/kubernetes/kubernetes/blob/v1.22.8/pkg/kubelet/status/status_manager.go#L583-L652</a>. as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// We don&#39;t handle graceful deletion of mirror pods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nf">canBeDeleted</span><span class="p">(</span><span class="nx">pod</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">deleteOptions</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">GracePeriodSeconds</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="kt">int64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Use the pod UID as the precondition for deletion to prevent deleting a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// newly created pod with the same name and namespace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">Preconditions</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nf">NewUIDPreconditions</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">UID</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">kubeClient</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">pod</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">deleteOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Failed to delete status for pod&#34;</span><span class="p">,</span> <span class="s">&#34;pod&#34;</span><span class="p">,</span> <span class="nx">klog</span><span class="p">.</span><span class="nf">KObj</span><span class="p">(</span><span class="nx">pod</span><span class="p">),</span> <span class="s">&#34;err&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">InfoS</span><span class="p">(</span><span class="s">&#34;Pod fully terminated and removed from etcd&#34;</span><span class="p">,</span> <span class="s">&#34;pod&#34;</span><span class="p">,</span> <span class="nx">klog</span><span class="p">.</span><span class="nf">KObj</span><span class="p">(</span><span class="nx">pod</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">m</span><span class="p">.</span><span class="nf">deletePodStatus</span><span class="p">(</span><span class="nx">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For example, it will determine if there are still containers running, if the volumes have not been cleaned, if the pod cgroup has not been emptied, and so on. If <code>canBeDeleted</code> returns true, then the pod has been gracefully stopped, so you can send a Delete request to the apiserver to delete the pod again.</p>
<p>However, this time the <code>GracePeriodSeconds</code> is set to 0, which means that the pod will be forcibly deleted, and the apiserver will receive a DELETE request again here. Unlike the first time, this time the Pod is forcibly deleted and the Pod object is deleted from etcd.</p>
<p>At this time, kubelet will receive the REMOVE event and call the <code>HandlePodRemoves</code> function to process it.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/09/d2a46c6df63242598375d7d8ff808032.png" alt="HandlePodRemoves"></p>
<p>The <code>deletePod</code> function will be called first to stop the associated pod worker, and then <code>probeManager</code> will be called to remove the pod-related probe prober worker, which means that the pod is completely removed from the node.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-04/go-bgp/">
            <span class="next-text nav-default">GoBGP Principles and Practices</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
