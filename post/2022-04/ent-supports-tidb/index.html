<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Golang entity framework Ent supports distributed database TiDB - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Recently, Facebook&#39;s open source Golang entity framework, Ent, completed support for TiDB databases, and this article gives an example application." /><meta name="keywords" content="golang, ent, tidb" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/ent-supports-tidb/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Golang entity framework Ent supports distributed database TiDB" />
<meta property="og:description" content="Recently, Facebook&#39;s open source Golang entity framework, Ent, completed support for TiDB databases, and this article gives an example application." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/ent-supports-tidb/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-01T17:56:18+08:00" />
<meta property="article:modified_time" content="2022-04-01T17:56:18+08:00" />

<meta itemprop="name" content="Golang entity framework Ent supports distributed database TiDB">
<meta itemprop="description" content="Recently, Facebook&#39;s open source Golang entity framework, Ent, completed support for TiDB databases, and this article gives an example application."><meta itemprop="datePublished" content="2022-04-01T17:56:18+08:00" />
<meta itemprop="dateModified" content="2022-04-01T17:56:18+08:00" />
<meta itemprop="wordCount" content="630">
<meta itemprop="keywords" content="ent,tidb," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang entity framework Ent supports distributed database TiDB"/>
<meta name="twitter:description" content="Recently, Facebook&#39;s open source Golang entity framework, Ent, completed support for TiDB databases, and this article gives an example application."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Golang entity framework Ent supports distributed database TiDB</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-01 17:56:18 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 630 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#hello-world-application-example">Hello World Application Example</a>
          <ul>
            <li><a href="#start-a-tidb-server-locally-with-docker">Start a TiDB Server locally with Docker</a></li>
            <li><a href="#copy-the-hello-world-example-repo-locally">Copy the hello world example repo locally</a></li>
            <li><a href="#run-this-sample-program">Run this sample program</a></li>
            <li><a href="#summary">Summary</a></li>
          </ul>
        </li>
        <li><a href="#release-notes">Release Notes</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, Facebook&rsquo;s open source Golang entity framework, Ent, completed support for TiDB databases.</p>
<p><a href="https://github.com/ent/ent">Ent</a> is an easy framework for building and maintaining applications and big data models. It has the following features.</p>
<ul>
<li>Schema as code : the ability to model any database table as a Go object.</li>
<li>Easy to traverse any graph : can easily run queries, aggregation and traversal of any graph structure .</li>
<li>Static Types and Explicit APIs: Use code to generate static types and explicit APIs for easier querying of data.</li>
<li>Multi-storage drivers : support for MySQL, PostgreSQL, SQLite, Gremlin, and now also TiDB.</li>
<li>Extensible: easy to extend and customize with Go templates.</li>
</ul>
<p>TiDB is an open source distributed relational database designed and developed by PingCAP, which is a converged distributed database product that supports both online transaction processing and online analytical processing (HTAP). It has important features such as horizontal scaling or scaling, financial grade high availability, real-time HTAP, cloud-native distributed database, compatibility with MySQL 5.7 protocol and MySQL ecology. The goal is to provide users with one-stop OLTP (Online Transactional Processing), OLAP (Online Analytical Processing) and HTAP solutions. TiDB is suitable for various application scenarios such as high availability, strong consistency requirements, and large data size.</p>
<p>The following is a Hello World application example to see how to quickly implement an Ent + TiDB based application.</p>
<h2 id="hello-world-application-example">Hello World Application Example</h2>
<h3 id="start-a-tidb-server-locally-with-docker">Start a TiDB Server locally with Docker</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run -p 4000:4000 pingcap/tidb
</span></span></code></pre></td></tr></table>
</div>
</div><p>You now have a running instance of TiDB, with port 4000 open for listening.</p>
<h3 id="copy-the-hello-world-example-repo-locally">Copy the hello world example repo locally</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://github.com/hedwigz/tidb-hello-world.git
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this example repo we have defined a simple User schema.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">title</span><span class="p">=</span><span class="s">&#34;ent/schema/user.go&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">User</span><span class="p">)</span> <span class="nf">Fields</span><span class="p">()</span> <span class="p">[]</span><span class="nx">ent</span><span class="p">.</span><span class="nx">Field</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span><span class="nx">ent</span><span class="p">.</span><span class="nx">Field</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">field</span><span class="p">.</span><span class="nf">Time</span><span class="p">(</span><span class="s">&#34;created_at&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">Default</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">field</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">field</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then, to connect Ent and TiDB.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">title</span><span class="p">=</span><span class="s">&#34;main.go&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ent</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;mysql&#34;</span><span class="p">,</span> <span class="s">&#34;root@tcp(localhost:4000)/test?parseTime=true&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed opening connection to TiDB: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Run the auto migration tool, with Atlas.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">schema</span><span class="p">.</span><span class="nf">WithAtlas</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed printing schema changes: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, in the first line we connect to TiDB Server through a MySQL statement, since TiDB is MySQL compatible, no special driver is needed.
Having said that, there are still many differences between TiDB and MySQL, especially operations related to Schema migration, such as SQL diagnosis and migration planning. So, Atlas can automatically monitor the connection to TiDB and do the migration process accordingly.
In addition, in the seventh line we use schema.WithAtlas (true) to indicate that Ent is using &ldquo;Atlas&rdquo; as the migration engine, which is the migration engine that Ent just released, and thanks to the latest design of Atlas, it is easier than ever to support new databases. Atlas is Ent&rsquo;s newly released migration engine, and thanks to Atlas&rsquo; latest design, supporting new databases has never been easier.</p>
<p>Finally, we create a new user data and save it to TiDB for later data reading and exporting.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">title</span><span class="p">=</span><span class="s">&#34;main.go&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">client</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">Create</span><span class="p">().</span>
</span></span><span class="line"><span class="cl">                <span class="nf">SetAge</span><span class="p">(</span><span class="mi">30</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">SetName</span><span class="p">(</span><span class="s">&#34;hedwigz&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">SaveX</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nx">user</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">Query</span><span class="p">().</span><span class="nf">FirstX</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;the user: %s is %d years old\n&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Age</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="run-this-sample-program">Run this sample program</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go run main.go
</span></span><span class="line"><span class="cl">the user: hedwigz is <span class="m">30</span> years old
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="summary">Summary</h3>
<p>In this quick walkthrough, we successfully completed.</p>
<ul>
<li>start a local instance of TiDB.</li>
<li>connecting Ent and TiDB databases.</li>
<li>migrating Ent Schema using Atlas.</li>
<li>inserting and reading data from TiDB using Ent.</li>
</ul>
<h2 id="release-notes">Release Notes</h2>
<p>This sample application currently works fine with Ent v0.10 and TiDB v5.4.0, and Ent plans to continue to expand support for TiDB in the future.</p>
<p>In addition to Ent, TiDB has previously added support for GORM and go-sql-driver/mysql, see <a href="https://docs.pingcap.com/appdev/dev">docs</a> for details.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ent/">ent</a>
          <a href="/tags/tidb/">tidb</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/postgresql-compile-install/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Compile and install PostgreSQL on CentOS</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/how-to-add-babel-polyfill/">
            <span class="next-text nav-default">How to Add Babel Polyfill</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
