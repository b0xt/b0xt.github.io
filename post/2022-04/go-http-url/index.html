<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Constructing HTTP request URLs in the Go language more standardly and securely - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to construct HTTP request URLs in Go in a more standard and secure way." /><meta name="keywords" content="golang, Http Url" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/go-http-url/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Constructing HTTP request URLs in the Go language more standardly and securely" />
<meta property="og:description" content="Learn how to construct HTTP request URLs in Go in a more standard and secure way." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/go-http-url/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-06T12:43:25+08:00" />
<meta property="article:modified_time" content="2022-04-06T12:43:25+08:00" />

<meta itemprop="name" content="Constructing HTTP request URLs in the Go language more standardly and securely">
<meta itemprop="description" content="Learn how to construct HTTP request URLs in Go in a more standard and secure way."><meta itemprop="datePublished" content="2022-04-06T12:43:25+08:00" />
<meta itemprop="dateModified" content="2022-04-06T12:43:25+08:00" />
<meta itemprop="wordCount" content="1630">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Constructing HTTP request URLs in the Go language more standardly and securely"/>
<meta name="twitter:description" content="Learn how to construct HTTP request URLs in Go in a more standard and secure way."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Constructing HTTP request URLs in the Go language more standardly and securely</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-06 12:43:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1630 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preliminary-knowledge">Preliminary Knowledge</a></li>
        <li><a href="#handling-protocols-correctly">Handling protocols correctly</a></li>
        <li><a href="#proper-handling-of-paths">Proper handling of paths</a>
          <ul>
            <li><a href="#naming-issues">Naming issues</a></li>
            <li><a href="#to-have-or-not-to-have-the-final--question">To have or not to have the final <code>/</code> question</a></li>
            <li><a href="#path-encoding-problem">Path encoding problem</a></li>
          </ul>
        </li>
        <li><a href="#handling-query-strings-correctly">Handling query strings correctly</a></li>
        <li><a href="#finally">Finally</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In reviewing the code that my colleagues have written to initiate external HTTP requests, I have rarely seen a more standard (or correct and safe) way to construct the URL of an HTTP request. What is standard practice, if you ask me? I probably can&rsquo;t tell you exactly. However, I have a few simple criteria of my own.</p>
<ul>
<li>Protocol: Does the request work without <code>http://</code>?</li>
<li>Path: Does it stitch out <code>Path</code> correctly with <code>/</code> at the end?</li>
<li>Query: Do the query parameters handle the transcoding correctly?</li>
</ul>
<h2 id="preliminary-knowledge">Preliminary Knowledge</h2>
<p>What is a URL? The following structure is from the Go language <a href="https://github.com/golang/go/blob/604140d93111f89911e17cb147dcf6a02d2700d0/src/net/url/url.go#L341-L350">URL official documentation</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A URL represents a parsed URL (technically, a URI reference).
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The general form represented is:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  [scheme:][//[userinfo@]host][/]path[?query][#fragment]
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// URLs that do not start with a slash after the scheme are interpreted as:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  scheme:opaque[?query][#fragment]
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="handling-protocols-correctly">Handling protocols correctly</h2>
<p>Go&rsquo;s <code>url</code> package does not support URLs without a protocol (Scheme), and since http internally also uses the <code>url</code> package to parse, the following request is wrong.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span> <span class="o">:=</span> <span class="s">`example.com`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">rsp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The error is reported as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go run main.go
</span></span><span class="line"><span class="cl">2022/04/05 18:28:20 Get &#34;example.com&#34;: unsupported protocol scheme &#34;&#34;
</span></span><span class="line"><span class="cl">exit status 1
</span></span></code></pre></td></tr></table>
</div>
</div><p>I don&rsquo;t know if this counts as a bug in the <code>url</code> package, so I won&rsquo;t theorize here, but I always make a habit of dealing with it first in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">u</span> <span class="o">:=</span> <span class="s">`example.com`</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="s">`://`</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span> <span class="p">=</span> <span class="s">`http://`</span> <span class="o">+</span> <span class="nx">u</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that I&rsquo;m judging here by <code>://</code> and not <code>http://</code> or <code>https://</code>. There are several reasons for this.</p>
<ul>
<li>
<p>Simplicity. No need to determine both <code>http://</code> or <code>https://</code>.</p>
</li>
<li>
<p>Don&rsquo;t worry about case. The protocol (scheme) part of the URL is case-insensitive. <code>HTTP://example.com</code> and <code>http://example.com</code> are equivalent. If you insist on determining the prefix, you should also write it as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">u</span><span class="p">),</span> <span class="s">`http://`</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span> <span class="p">=</span> <span class="s">`http://`</span> <span class="o">+</span> <span class="nx">u</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is too cumbersome to write! This is still the way to write the <code>http</code> protocol only.</p>
</li>
</ul>
<h2 id="proper-handling-of-paths">Proper handling of paths</h2>
<p>The part of <code>http://example.com/path/to/file.txt</code> that looks like <code>/path/to/file.txt</code> is called <code>Path</code>, i.e. path. Understanding and constructing paths correctly is a major area of error.</p>
<h3 id="naming-issues">Naming issues</h3>
<p>The first and foremost problem is naming. Many people assume that API requests can only be sent to <code>/</code> paths, like <code>http://example.com/v1/posts</code>, an API interface where the <code>/v1/posts</code> part is fixed and the preceding <code>http://example.com</code> is in the configuration file. So they name this part <code>host</code> (or even more <code>host_port</code>). At first glance I thought I could only match the <code>example.com</code> part (because it&rsquo;s called host, hostname or host_port).</p>
<p>So in case I want to test a proxied API someday and the prefix changes, for example, now it&rsquo;s <code>http://example.com/proxy/v1/posts</code>. Then the configuration file should now say <code>http://example.com/proxy</code> in this section. Is this still called <code>host</code>?</p>
<p>Why am I bothering with this, you ask? I didn&rsquo;t want to, I didn&rsquo;t even think this kind of stuff could be a dispute for us. I thought everyone was following the specs.</p>
<p>Where is this scenario, you ask? All over the place, like Grafana using requests to data sources in Server mode (as opposed to Direct).</p>
<p>So what&rsquo;s a good name for it? I&rsquo;ve seen: <code>endpoint</code>, <code>prefix</code>, <code>url</code>, <code>address</code>, etc.</p>
<h3 id="to-have-or-not-to-have-the-final--question">To have or not to have the final <code>/</code> question</h3>
<p>Because his code is based on configuring and then appending (yes, <code>+</code>) API paths, so.</p>
<ul>
<li>If the configuration is <code>http://example.com</code>, then it will get: <code>http://example.com/v1/posts</code>; * If the configuration is <code>http://example.com</code>, then it will get</li>
<li>If you configure <code>http://example.com/</code>, then you get: <code>http://example.com//v1/posts</code>; * If you configure <code>http://example.com/</code>, then you get: <code>http://example.com//v1/posts</code>.</li>
</ul>
<p>See? They simply can&rsquo;t handle whether it ends with <code>/</code> or not, and at one point they even verbally asked you not to bring the final <code>/</code>.</p>
<p>The root cause of this is that their URLs are manually spliced.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">prefix</span> <span class="o">:=</span> <span class="s">`http://example.com/`</span>
</span></span><span class="line"><span class="cl"><span class="nx">api</span> <span class="o">:=</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="s">`/v1/posts`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Not all servers are compatible with automatically turning <code>//</code> into <code>/</code>, and errors are inevitable.</p>
<p>So how to do it? Use the <a href="https://pkg.go.dev/path"><code>path</code></a> package. (This package conflicts with our common variable name <code>path</code>, which is a bit unpleasant.)</p>
<p>There is a corresponding package called <a href="https://pkg.go.dev/path/filepath"><code>filepath</code></a>. The main difference between these two packages is that the former applies to forward-slash related paths, while the latter applies to OS related paths. For example, <code>/</code> separates paths on Linux and <code>\</code> separates paths on Windows. This is clearly stated in the package documentation.</p>
<blockquote>
<p><strong>path</strong></p>
<p>Package path implements utility routines for manipulating slash-separated paths.</p>
<p>The path package should only be used for paths separated by forward slashes, such as the paths in URLs. This package does not deal &gt;with Windows paths with drive letters or backslashes; to manipulate operating system paths, use the path/filepath package.</p>
<p><strong>filepath</strong></p>
<p>Package filepath implements utility routines for manipulating filename paths in a way compatible with the target operating &gt;system-defined file paths.</p>
<p>The filepath package uses either forward slashes or backslashes, depending on the operating system. To process paths such as URLs that always use forward slashes regardless of the operating system, see the path package.</p>
</blockquote>
<p>How do I use the <code>path</code> package? Just one method: <a href="https://pkg.go.dev/path#Join"><code>path.Join</code></a>.</p>
<blockquote>
<p><code>func Join(elem ...string) string</code></p>
<p>Join joins any number of path elements into a single path, separating them with slashes. Empty elements are ignored. The result is Cleaned. However, if the argument list is empty or all its elements are empty, Join returns an empty string.</p>
</blockquote>
<p>Test code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/url&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;path&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">api</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="s">`://`</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prefix</span> <span class="p">=</span> <span class="s">&#34;http://&#34;</span> <span class="o">+</span> <span class="nx">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">`/v1/posts`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Output results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go run main.go
</span></span><span class="line"><span class="cl">http://example.com/v1/posts
</span></span><span class="line"><span class="cl">http://example.com/v1/posts
</span></span><span class="line"><span class="cl">http://example.com/v1/posts
</span></span><span class="line"><span class="cl">http://example.com/proxy/v1/posts
</span></span><span class="line"><span class="cl">http://example.com/proxy/v1/posts
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you are using go1.18 or later, the <code>url</code> library already comes with this capability, see: <a href="https://github.com/golang/go/commit/604140d93111f89911e17cb147dcf6a02d2700d0">net/url: add <code>JoinPath</code>, URL.JoinPath</a>.</p>
<h3 id="path-encoding-problem">Path encoding problem</h3>
<p>The above <code>path.Join</code> will automatically handle encoding issues:.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/url&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;path&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">api</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="s">`://`</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prefix</span> <span class="p">=</span> <span class="s">&#34;http://&#34;</span> <span class="o">+</span> <span class="nx">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">`/v1/posts/新文章`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">prefix</span> <span class="o">:=</span> <span class="s">`http://example.com`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">prefix</span> <span class="o">+</span> <span class="s">`/v1/posts/新文章`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">api</span><span class="p">(</span><span class="nx">prefix</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Output results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go run main.go
</span></span><span class="line"><span class="cl">http://example.com/v1/posts/新文章
</span></span><span class="line"><span class="cl">http://example.com/v1/posts/%E6%96%B0%E6%96%87%E7%AB%A0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Many servers or more modern backends should now be able to handle unencoded characters correctly, and it is less common to use characters other than numeric letters in the API. The encoding problem is not particularly serious.</p>
<p>Do you think I <code>/v1/posts/new-posts</code> wrote it wrong because I didn&rsquo;t encode it myself? Sorry, no mistake. The <code>path.Join</code> joins the paths (segments) before encoding, and the <code>url.String()</code> method gets the final URL for transmission.</p>
<h2 id="handling-query-strings-correctly">Handling query strings correctly</h2>
<p>A query is simply the part of the URL that comes after the question mark. For example: <code>http://example.com/v1/posts?page_no=1&amp;a=b</code>, <code>page_no=1&amp;a=b</code> is called a <strong>query</strong> (query or query_string).</p>
<p>I&rsquo;m sure everyone has seen someone else manually splice in the code for this query, or written it themselves (I&rsquo;m no exception).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">:=</span> <span class="s">`http://example.com/v1/posts`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="s">`?`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="s">`page_no=1`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="s">`&amp;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="s">`a=b`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="s">`&amp;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;text=%s&#34;</span><span class="p">,</span> <span class="s">`text with spaces`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="s">`&amp;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="o">+=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">`chinese=%s`</span><span class="p">,</span> <span class="s">`桃子`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">api</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following are the results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ go run main.go
</span></span><span class="line"><span class="cl">http://example.com/v1/posts?page_no=1&amp;a=b
</span></span><span class="line"><span class="cl">http://example.com/v1/posts?page_no=1&amp;a=b&amp;text=text with spaces
</span></span><span class="line"><span class="cl">http://example.com/v1/posts?page_no=1&amp;a=b&amp;text=text with spaces&amp;chinese=桃子
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s hard to read so much hardcoding. I don&rsquo;t think you&rsquo;ve seen many URLs with spaces, have you? The ones with Chinese characters are probably not very standardized either, right? I&rsquo;m very bitter.</p>
<p>The following is what I think is a more standard and safe way to write.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/url&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">`http://example.com/v1/posts?existed=query`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span> <span class="o">:=</span> <span class="nx">u</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">`page_no`</span><span class="p">,</span> <span class="s">`1`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">`a`</span><span class="p">,</span> <span class="s">`b`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">`text`</span><span class="p">,</span> <span class="s">`text with spaces`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">`chinese`</span><span class="p">,</span> <span class="s">`桃子`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Output results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go run main.go
</span></span><span class="line"><span class="cl">http://example.com/v1/posts?a=b&amp;chinese=%E6%A1%83%E5%AD%90&amp;existed=query&amp;page_no=1&amp;text=text+with+spaces
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="finally">Finally</h2>
<p>I don&rsquo;t know if you have made similar mistakes, but I have made them many times before anyway, so I have a summary like this today.</p>
<p>I also don&rsquo;t know if other languages have similar problems is, at least I used to write C, C++, Lua, PHP, Javascript, etc. all have similar problems.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/graceful-shutdown-docker/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to shutdown containers gracefully</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/dagger/">
            <span class="next-text nav-default">Getting started with Dagger</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
