<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Python3&#39;s web tool library requests and aiohttp manual - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Python3&#39;s network tool libraries requests and aiohttp." /><meta name="keywords" content="python, requests, aiohttp" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/python-requests-aiohttp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Python3&#39;s web tool library requests and aiohttp manual" />
<meta property="og:description" content="Learn how to use Python3&#39;s network tool libraries requests and aiohttp." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/python-requests-aiohttp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-14T13:35:09+08:00" />
<meta property="article:modified_time" content="2022-04-14T13:35:09+08:00" />

<meta itemprop="name" content="Python3&#39;s web tool library requests and aiohttp manual">
<meta itemprop="description" content="Learn how to use Python3&#39;s network tool libraries requests and aiohttp."><meta itemprop="datePublished" content="2022-04-14T13:35:09+08:00" />
<meta itemprop="dateModified" content="2022-04-14T13:35:09+08:00" />
<meta itemprop="wordCount" content="5029">
<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python3&#39;s web tool library requests and aiohttp manual"/>
<meta name="twitter:description" content="Learn how to use Python3&#39;s network tool libraries requests and aiohttp."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Python3&#39;s web tool library requests and aiohttp manual</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-14 13:35:09 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 5029 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-background">1. Background</a></li>
        <li><a href="#2-requests">2. requests</a>
          <ul>
            <li><a href="#21-installation">2.1. installation</a></li>
            <li><a href="#22-get-and-post-use">2.2. Get and Post use</a></li>
            <li><a href="#23-session-usage">2.3. session usage</a></li>
          </ul>
        </li>
        <li><a href="#3-aiohttp">3. aiohttp</a>
          <ul>
            <li><a href="#31-installation">3.1. Installation</a></li>
            <li><a href="#32-use-of-get-and-post">3.2. Use of Get and Post</a></li>
            <li><a href="#33-use-of-session">3.3. Use of Session</a></li>
          </ul>
        </li>
        <li><a href="#4-speed-comparison">4. Speed comparison</a></li>
        <li><a href="#5-aiohttp-concurrency-control-and-timeout-settings">5. aiohttp concurrency control and timeout settings</a>
          <ul>
            <li><a href="#51-concurrency-limitation">5.1. Concurrency limitation</a></li>
            <li><a href="#52-timeout-limits">5.2. Timeout limits</a></li>
          </ul>
        </li>
        <li><a href="#6-finally">6. Finally</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-background">1. Background</h2>
<p>Python is amazing as an excellent scripting language with its excellent network library Requests. The only drawback is that it cannot implement asynchronous requests, only synchronous ones. If you want to implement asynchronous requests, you need to use aiohttp/httpx.</p>
<h2 id="2-requests">2. requests</h2>
<p>Before we get into the aiohttp library, let&rsquo;s see what are the best HTTP libraries under Python3, which are</p>
<ul>
<li>requests</li>
<li>httpx</li>
<li>aiohttp</li>
</ul>
<p>Requests is an easy-to-use synchronous request HTTP library for beginners who are just getting started with Python.</p>
<p>HTTPX is a latecomer, supporting both synchronous and asynchronous syntax, while aiohttp supports only asynchronous requests.</p>
<p>In terms of asynchronous request efficiency, the gap between httpx and aiohttp is not obvious.</p>
<blockquote>
<p>If you are interested, you can also write two simple demos to verify the asynchronous request performance gap between httpx and aiohttp, httpx is not in the scope of this article.</p>
</blockquote>
<h3 id="21-installation">2.1. installation</h3>
<p>reqeusts is not a standard library for Python3. Use pip to install it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pip3 install requests
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-get-and-post-use">2.2. Get and Post use</h3>
<p><code>GET request</code></p>
<p>Take the example of requesting Json data of a website message list.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; import requests
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">response</span> <span class="o">=</span> requests.get<span class="o">(</span><span class="s1">&#39;https://www.chancel.me/messages?ownType=2&amp;ownID=0&#39;</span>,timeout<span class="o">=</span>10<span class="o">)</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; response.status_code
</span></span><span class="line"><span class="cl"><span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; response.json
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s1">&#39;data&#39;</span>: <span class="o">{</span><span class="s1">&#39;hasNext&#39;</span>: False, <span class="s1">&#39;hasPrev&#39;</span>: False, <span class="s1">&#39;items&#39;</span>: <span class="o">[{</span><span class="s1">&#39;create_time&#39;</span>: <span class="s1">&#39;Mon, 14 Jan 2019 17:34:42 GMT&#39;</span>, <span class="s1">&#39;id&#39;</span>: 8, <span class="s1">&#39;m_author&#39;</span>: <span class="s1">&#39;浮光&#39;</span>, <span class="s1">&#39;m_content&#39;</span>: <span class="s1">&#39;&lt;blockquote&gt;&lt;p&gt;理解得越多就越痛苦。知道得越多就越撕裂。但他有着同痛苦相对称的清澈，与绝望相 均衡的坚韧。&lt;/p&gt;\n&lt;p&gt;-- 勒内.夏尔&lt;/p&gt;\n&lt;/blockquote&gt;\n&#39;</span>, <span class="s1">&#39;m_email&#39;</span>: <span class="s1">&#39;ycs1026@vip.qq.com&#39;</span>, <span class="s1">&#39;m_environ&#39;</span>: <span class="o">[]</span>, <span class="s1">&#39;m_gravatar&#39;</span>: <span class="s1">&#39;https://www.gravatar.com/avatar/d45071b54cf3339bd3d16bb35f750f35?d=https%3A%2F%2Fwww.chancel.ltd%2Fstatic%2Fimg%2Fgravatar.jpg&amp;s=64&#39;</span>, <span class="s1">&#39;m_own_id&#39;</span>: 0, <span class="s1">&#39;m_parent_id&#39;</span>: None, <span class="s1">&#39;m_site_url&#39;</span>: None, <span class="s1">&#39;m_type&#39;</span>: 2, <span class="s1">&#39;sub_messages&#39;</span>: <span class="o">[]</span>, <span class="s1">&#39;t_message_type&#39;</span>: <span class="o">{</span><span class="s1">&#39;id&#39;</span>: 2, <span class="s1">&#39;m_type&#39;</span>: <span class="s1">&#39;book&#39;</span><span class="o">}}]</span>, <span class="s1">&#39;page&#39;</span>: 1, <span class="s1">&#39;pages&#39;</span>: 1, <span class="s1">&#39;perPage&#39;</span>: 100, <span class="s1">&#39;total&#39;</span>: 1<span class="o">}</span>, <span class="s1">&#39;message&#39;</span>: <span class="s1">&#39;留言获取成功&#39;</span>, <span class="s1">&#39;success&#39;</span>: True<span class="o">}</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; response.json<span class="o">[</span><span class="s1">&#39;message&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;获取成功&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>et requests are relatively simple to use, and requests are very easy to encapsulate against the returned Json.</p>
<p>`POST request</p>
<p>Taking the switch blog theme as an example, I manually put the cookies assigned for the first visit to the site into the cookies field in headers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">headers</span> <span class="o">=</span> <span class="o">{</span><span class="s1">&#39;Cookie&#39;</span>: <span class="s1">&#39;IDTAG=3e56264d-8fa8-11eb-9636-0050560000a0&#39;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">request_data</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;theme&#34;</span>:<span class="o">{</span><span class="s2">&#34;appClass&#34;</span>:<span class="s2">&#34;mdui-color-white&#34;</span>,<span class="s2">&#34;bodyClass&#34;</span>:<span class="s2">&#34;mdui-theme-layout-dark&#34;</span>,<span class="s2">&#34;containerClass&#34;</span>:<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;footerClass&#34;</span>:<span class="s2">&#34;&#34;</span><span class="o">}}</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">response</span> <span class="o">=</span> requests.post<span class="o">(</span><span class="s1">&#39;https://www.chancel.me/idtag&#39;</span>,headers<span class="o">=</span>headers,json<span class="o">=</span>request_data<span class="o">)</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; response.status_code
</span></span><span class="line"><span class="cl"><span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; response.text
</span></span><span class="line"><span class="cl"><span class="s1">&#39;{&#34;data&#34;:{},&#34;message&#34;:&#34;存储成功&#34;,&#34;success&#34;:true}\n&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Post requests usually need to submit data, for json data (Content-Type:application/json) type the parameter is Json.</p>
<p>In case of form requests, the data parameter can be used, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">response</span> <span class="o">=</span> requests.post<span class="o">(</span><span class="s1">&#39;https://www.chancel.me/idtag&#39;</span>,headers<span class="o">=</span>headers,data<span class="o">=</span>request_data<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-session-usage">2.3. session usage</h3>
<p>In practical scenarios, requests are often continuous and with cookies, and manually maintaining cookies for each POST submission is a troublesome chore.</p>
<p>For example, when repeatedly requesting to change the theme of a blog site, you need to carry information about the cookies that visit the blog, you can manually add the cookie information in the headers in the code.</p>
<p>Obviously it is not very convenient to do this every time, we can use the session carried by requests to solve this problem.</p>
<p>Take switching blog themes as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">requests_session</span> <span class="o">=</span> requests.session<span class="o">()</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; requests_session.get<span class="o">(</span><span class="s1">&#39;https://www.chancel.me&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">&lt;Response <span class="o">[</span>200<span class="o">]</span>&gt;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; requests_session.cookies
</span></span><span class="line"><span class="cl">&lt;RequestsCookieJar<span class="o">[</span>Cookie<span class="o">(</span><span class="nv">version</span><span class="o">=</span>0, <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;IDTAG&#39;</span>, <span class="nv">value</span><span class="o">=</span><span class="s1">&#39;2155a6c4-8fa9-11eb-afcb-0050560000a0&#39;</span>, <span class="nv">port</span><span class="o">=</span>None, <span class="nv">port_specified</span><span class="o">=</span>False, <span class="nv">domain</span><span class="o">=</span><span class="s1">&#39;www.chancel.ltd&#39;</span>, <span class="nv">domain_specified</span><span class="o">=</span>False, <span class="nv">domain_initial_dot</span><span class="o">=</span>False, <span class="nv">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span>, <span class="nv">path_specified</span><span class="o">=</span>True, <span class="nv">secure</span><span class="o">=</span>True, <span class="nv">expires</span><span class="o">=</span>1648460213, <span class="nv">discard</span><span class="o">=</span>False, <span class="nv">comment</span><span class="o">=</span>None, <span class="nv">comment_url</span><span class="o">=</span>None, <span class="nv">rest</span><span class="o">={</span><span class="s1">&#39;HttpOnly&#39;</span>: None<span class="o">}</span>, <span class="nv">rfc2109</span><span class="o">=</span>False<span class="o">)]</span>&gt;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">request</span> <span class="o">=</span> requests_session.post<span class="o">(</span><span class="s1">&#39;https://www.chancel.me/idtag&#39;</span>,json<span class="o">=</span>request_data<span class="o">)</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; request.status_code
</span></span><span class="line"><span class="cl"><span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; request.text
</span></span><span class="line"><span class="cl"><span class="s1">&#39;{&#34;data&#34;:{},&#34;message&#34;:&#34;存储成功&#34;,&#34;success&#34;:true}\n&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The session can effectively store all the current request cookies and track the changes of cookies, which is a very useful wrapper for continuous requests in complex scenarios.</p>
<p>It is also very convenient for logging in to a website, as soon as the login operation is performed, the session object will automatically save the current cookies for other requests.</p>
<p>We can also serialize the session&rsquo;s cookies property locally and use it again when we start the next session, avoiding the problem of repeated logins to get cookies.</p>
<p>Write to local cookies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&gt;&gt;&gt; with open<span class="o">(</span><span class="s1">&#39;/tmp/chancel.ltd-cookies&#39;</span>, <span class="s1">&#39;w&#39;</span><span class="o">)</span> as f:
</span></span><span class="line"><span class="cl">...     f.write<span class="o">(</span>json.dumps<span class="o">(</span>requests_session.cookies.get_dict<span class="o">()))</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>View information about locally saved cookies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># chancel @ home-ubuntu in ~ [17:42:22]</span>
</span></span><span class="line"><span class="cl">$ cat /tmp/chancel.ltd-cookies
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;IDTAG&#34;</span>: <span class="s2">&#34;2155a6c4-8fa9-11eb-afcb-0050560000a0&#34;</span><span class="o">}</span>%
</span></span></code></pre></td></tr></table>
</div>
</div><p>Retrieves information from locally stored cookies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/chancel.ltd-cookies&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">requests_session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above usage is enough syntax for most request scenarios. For more advanced usage of request (e.g. file upload, SSL certificate ignore, web proxy wind, etc.) you can refer to the official documentation.</p>
<p><a href="https://requests.readthedocs.io/en/master/">Requests: HTTP for Humans™</a></p>
<h2 id="3-aiohttp">3. aiohttp</h2>
<p>aiohttp is a very good asynchronous HTTP library, but relatively more difficult to get started than requests.</p>
<p>I believe that you are no stranger to asynchronous if you have programming experience, and here you can briefly explain the difference between synchronous and asynchronous.</p>
<ul>
<li>Synchronous request: After initiating a request, the next code is not executed until the request returns or an exception is thrown.</li>
<li>Asynchronous request: After initiating a request, you can continue to execute the next code step.</li>
</ul>
<p>By the principle of asynchronous, we can prepare a large number of requests to observe the difference between the two executions.</p>
<h3 id="31-installation">3.1. Installation</h3>
<p>Installing aiohttp can also be done using pip.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pip3 install aiohttp asyncio
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-use-of-get-and-post">3.2. Use of Get and Post</h3>
<p>`Get request</p>
<p>Take the example from the official website and modify it a bit, still taking the example of getting the Json data of the blog&rsquo;s message list. Get request uses asynchronous methods that are standard asyncio library methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me/messages?ownType=2&amp;ownID=0&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Response status -&gt; </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Response data -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">response_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">Response</span> <span class="n">status</span> <span class="o">-&gt;</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl"><span class="n">Response</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;hasNext&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;hasPrev&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;create_time&#39;</span><span class="p">:</span> <span class="s1">&#39;Mon, 14 Jan 2019 17:34:42 GMT&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;m_author&#39;</span><span class="p">:</span> <span class="s1">&#39;浮光&#39;</span><span class="p">,</span> <span class="s1">&#39;m_content&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;blockquote&gt;&lt;p&gt;理解得越多就越痛苦。知道得越多就越撕裂。但他有着同痛苦相对称的清澈，与绝望相均衡的坚韧。&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&lt;p&gt;-- 勒内.夏尔&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&lt;/blockquote&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;m_email&#39;</span><span class="p">:</span> <span class="s1">&#39;ycs1026@vip.qq.com&#39;</span><span class="p">,</span> <span class="s1">&#39;m_environ&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;m_gravatar&#39;</span><span class="p">:</span> <span class="s1">&#39;https://cdn.v2ex.com/gravatar/d45071b54cf3339bd3d16bb35f750f35?d=https%3A</span><span class="si">%2F%2F</span><span class="s1">www.chancel.ltd</span><span class="si">%2F</span><span class="s1">static</span><span class="si">%2F</span><span class="s1">img</span><span class="si">%2F</span><span class="s1">gravatar.jpg&amp;s=64&#39;</span><span class="p">,</span> <span class="s1">&#39;m_own_id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;m_parent_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;m_site_url&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;m_type&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;sub_messages&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;t_message_type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;m_type&#39;</span><span class="p">:</span> <span class="s1">&#39;book&#39;</span><span class="p">}}],</span> <span class="s1">&#39;page&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pages&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;perPage&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;留言获取成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>`POST request</p>
<p>Still take switching blog themes as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="s1">&#39;IDTAG=f4fad1e1-911d-11eb-bbcb-0050560000a0&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;theme&#34;</span><span class="p">:{</span><span class="s2">&#34;appClass&#34;</span><span class="p">:</span><span class="s2">&#34;mdui-color-white&#34;</span><span class="p">,</span><span class="s2">&#34;bodyClass&#34;</span><span class="p">:</span><span class="s2">&#34;mdui-theme-layout-dark&#34;</span><span class="p">,</span><span class="s2">&#34;containerClass&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;footerClass&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me/idtag&#39;</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">Response</span> <span class="n">status</span> <span class="o">-&gt;</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl"><span class="n">Response</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ordinary requests for aiohttp are not complicated, if you are not sure about the await/async syntax, you can refer to <a href="https://docs.python.org/3/library/asyncio-task.html">Coroutines and Tasks - doc.python.org</a>.</p>
<h3 id="33-use-of-session">3.3. Use of Session</h3>
<p>The use of cookies in aiohttp is more complex, it also supports exporting to files, but the file format is binary, it can also be exported to Json files in line with Requests&rsquo; session, but it needs to use the unsafe flag, for details refer to <a href="https://docs.aiohttp.org/en/stable/client_advanced.html#cookie-jar">Cookie Jar - docs.aiohttp.org</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">request_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;theme&#34;</span><span class="p">:{</span><span class="s2">&#34;appClass&#34;</span><span class="p">:</span><span class="s2">&#34;mdui-color-white&#34;</span><span class="p">,</span><span class="s2">&#34;bodyClass&#34;</span><span class="p">:</span><span class="s2">&#34;mdui-theme-layout-dark&#34;</span><span class="p">,</span><span class="s2">&#34;containerClass&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;footerClass&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me/idtag&#39;</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="n">request_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">session</span><span class="o">.</span><span class="n">cookie_jar</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;www.chancel.ltd.cookies&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># session.cookie_jar.load(file_path) 可以读回cookies,大部分情况无需理会cookie内容</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Response status -&gt; </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Response data -&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">response_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-speed-comparison">4. Speed comparison</h2>
<p>The biggest difference between aiohttp and Requests is the asynchronous requests, taking the example of requesting 10 blog theme switches. It takes about 15 seconds to execute the code below, and you can see from the return that each request is executed sequentially.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.chancel.me&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">post_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.chancel.me/idtag&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;theme&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;appClass&#34;</span><span class="p">:</span> <span class="s2">&#34;mdui-color-white&#34;</span><span class="p">,</span> <span class="s2">&#34;bodyClass&#34;</span><span class="p">:</span> <span class="s2">&#34;mdui-theme-layout-dark&#34;</span><span class="p">,</span> <span class="s2">&#34;containerClass&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;footerClass&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">requests_post</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">requests_session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">requests_session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">requests_session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;第</span><span class="si">%d</span><span class="s1">次Post请求更换主题成功，返回结果Response数据-&gt;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_count</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">post_count</span> <span class="o">&lt;</span> <span class="n">try_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">requests_post</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">post_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopwatch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requests使用POST请求</span><span class="si">%d</span><span class="s1">次共用时</span><span class="si">%d</span><span class="s1">秒&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_count</span><span class="p">,</span> <span class="n">stopwatch</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">第1次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第2次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">第7次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第8次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第9次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第10次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Requests使用POST请求10次共用时15秒</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And the same request logic, aiohttp takes only 1 second to complete, and you can see that the execution of the request is out of order.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.chancel.me&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">post_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.chancel.me/idtag&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;theme&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;appClass&#34;</span><span class="p">:</span> <span class="s2">&#34;mdui-color-white&#34;</span><span class="p">,</span> <span class="s2">&#34;bodyClass&#34;</span><span class="p">:</span> <span class="s2">&#34;mdui-theme-layout-dark&#34;</span><span class="p">,</span> <span class="s2">&#34;containerClass&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;footerClass&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">aiohttp_post</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;第</span><span class="si">%d</span><span class="s1">次Post请求更换主题成功，返回结果Response数据-&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">response_json</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_count</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">post_count</span> <span class="o">&lt;</span> <span class="n">try_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aiohttp_post</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">post_count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopwatch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requests使用POST请求</span><span class="si">%d</span><span class="s1">次共用时</span><span class="si">%d</span><span class="s1">秒&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_count</span><span class="p">,</span> <span class="n">stopwatch</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">第2次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第4次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第10次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第6次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第1次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第8次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第9次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第7次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第5次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第3次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Requests使用POST请求10次共用时1秒</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-aiohttp-concurrency-control-and-timeout-settings">5. aiohttp concurrency control and timeout settings</h2>
<h3 id="51-concurrency-limitation">5.1. Concurrency limitation</h3>
<p>Using the above example as an example, the code to limit the frequency of aiohttp requests to switch blog topics is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.chancel.me&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">post_url</span> <span class="o">=</span> <span class="s1">&#39;https://www.chancel.me/idtag&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">post_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;theme&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;appClass&#34;</span><span class="p">:</span> <span class="s2">&#34;mdui-color-white&#34;</span><span class="p">,</span> <span class="s2">&#34;bodyClass&#34;</span><span class="p">:</span> <span class="s2">&#34;mdui-theme-layout-dark&#34;</span><span class="p">,</span> <span class="s2">&#34;containerClass&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;footerClass&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">aiohttp_post</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index_url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">post_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response_json</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;第</span><span class="si">%d</span><span class="s1">次Post请求更换主题成功，返回结果Response数据-&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">response_json</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_count</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">client_session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">post_count</span> <span class="o">&lt;</span> <span class="n">try_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aiohttp_post</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">client_session</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">post_count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopwatch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requests使用POST请求</span><span class="si">%d</span><span class="s1">次共用时</span><span class="si">%d</span><span class="s1">秒&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_count</span><span class="p">,</span> <span class="n">stopwatch</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">第3次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第7次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第10次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第4次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第8次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第6次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第5次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第1次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第9次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">第2次Post请求更换主题成功</span><span class="err">，</span><span class="n">返回结果Response数据</span><span class="o">-&gt;</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;存储成功&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Requests使用POST请求10次共用时5秒</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This restricts only a single request to connect at a time, but it is still much faster than requests, but it does not mean that asynchronous requests are necessarily faster than synchronous requests, and needs to be discussed in the context of the scenario.</p>
<h3 id="52-timeout-limits">5.2. Timeout limits</h3>
<p>The timeout limit is very simple in Requests, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me&#39;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So in aiohttp is also so simple? You can try it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">aiohttp_post</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me&#39;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;第</span><span class="si">%d</span><span class="s1">次请求返回状态码</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_count</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">client_session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">post_count</span> <span class="o">&lt;</span> <span class="n">try_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aiohttp_post</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">client_session</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">post_count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopwatch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;请求首页</span><span class="si">%d</span><span class="s1">次共耗时</span><span class="si">%d</span><span class="s1">秒&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_count</span><span class="p">,</span> <span class="n">stopwatch</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">第55次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第56次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第57次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第58次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第59次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第60次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第61次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第62次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第32次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">Task</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">never</span> <span class="n">retrieved</span>
</span></span><span class="line"><span class="cl"><span class="n">future</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Task-68&#39;</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">aiohttp_post</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">sda</span><span class="o">/</span><span class="n">Codes</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">test_code</span><span class="o">/</span><span class="n">demo</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">exception</span><span class="o">=</span><span class="ne">TimeoutError</span><span class="p">()</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="n">File</span> <span class="s2">&#34;/mnt/sda/Codes/dev/test_code/demo.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">9</span><span class="p">,</span> <span class="ow">in</span> <span class="n">aiohttp_post</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me&#39;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">File</span> <span class="s2">&#34;/mnt/sda/Codes/dev/test_code/.venv/lib/python3.9/site-packages/aiohttp/client.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1117</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__aenter__</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">_resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coro</span>
</span></span><span class="line"><span class="cl">  <span class="n">File</span> <span class="s2">&#34;/mnt/sda/Codes/dev/test_code/.venv/lib/python3.9/site-packages/aiohttp/client.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">619</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_request</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span>
</span></span><span class="line"><span class="cl">  <span class="n">File</span> <span class="s2">&#34;/mnt/sda/Codes/dev/test_code/.venv/lib/python3.9/site-packages/aiohttp/helpers.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">656</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__exit__</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="kn">from</span> <span class="bp">None</span>
</span></span><span class="line"><span class="cl"><span class="n">asyncio</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TimeoutError</span>
</span></span><span class="line"><span class="cl"><span class="n">Task</span> <span class="n">exception</span> <span class="n">was</span> <span class="n">never</span> <span class="n">retrieved</span>
</span></span><span class="line"><span class="cl"><span class="n">请求首页100次共耗时10秒</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you try to do this, you will find that whether you request the blog home page 100 times or 10000 times, it will return within 10 seconds.</p>
<p>The reason why the 10 seconds timeout exception is thrown is that the timeout in <code>session.get('https://www.chancel.me',timeout=10)</code> refers to the timeout of the whole session, which looks very awkward.</p>
<p>Combined with the official example, you can set the total timeout of the whole asynchronous request, which is actually the same as the above code, only it looks less awkward.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">aiohttp_post</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.chancel.me&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;第</span><span class="si">%d</span><span class="s1">次请求返回状态码</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">try_count</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">    <span class="n">post_count</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeout</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sock_connect</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sock_read</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">client_session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">post_count</span> <span class="o">&lt;</span> <span class="n">try_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aiohttp_post</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">client_session</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">post_count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">post_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopwatch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;请求首页</span><span class="si">%d</span><span class="s1">次共耗时</span><span class="si">%d</span><span class="s1">秒&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">try_count</span><span class="p">,</span> <span class="n">stopwatch</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="n">第26次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第88次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第27次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">第25次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">第87次请求返回状态码200</span>
</span></span><span class="line"><span class="cl"><span class="n">请求首页100次共耗时17秒</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The complete 100 requests took about 17 seconds, similar to the requests score. timeout object has 4 properties.</p>
<ul>
<li>total: the timeout of the entire session (in seconds, type float).</li>
<li>connect: the number of seconds the connection pool waits to get a connection, i.e. the timeout waiting to allocate the requested resource (in seconds, type float).</li>
<li>sock_connect: the timeout to connect to the other server, i.e. the traditional request timeout (in seconds, type float).</li>
<li>sock_read: timeout for reading a resource (usually reading the returned data).</li>
</ul>
<h2 id="6-finally">6. Finally</h2>
<p>Practice using down, about aiohttp many uses are different from requests, asynchronous calls in many APIs with the traditional multi-threaded approach is completely different ideas, the best way to have doubts or read the documentation.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/jigsaw/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Microsoft&#39;s new tool has an 80% accuracy rate</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/python-informix/">
            <span class="next-text nav-default">Python3 connection to Informix database</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
