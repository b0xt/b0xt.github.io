<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Setting up the shared memory of a kubernetes Pod - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Discover how to set up shared memory for kubernetes Pods." /><meta name="keywords" content="Kubernetes, pod, Shared Memory" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/k8s-pod-shared-memory/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Setting up the shared memory of a kubernetes Pod" />
<meta property="og:description" content="Discover how to set up shared memory for kubernetes Pods." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/k8s-pod-shared-memory/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-06T09:00:39+08:00" />
<meta property="article:modified_time" content="2022-04-06T09:00:39+08:00" />

<meta itemprop="name" content="Setting up the shared memory of a kubernetes Pod">
<meta itemprop="description" content="Discover how to set up shared memory for kubernetes Pods."><meta itemprop="datePublished" content="2022-04-06T09:00:39+08:00" />
<meta itemprop="dateModified" content="2022-04-06T09:00:39+08:00" />
<meta itemprop="wordCount" content="3381">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting up the shared memory of a kubernetes Pod"/>
<meta name="twitter:description" content="Discover how to set up shared memory for kubernetes Pods."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Setting up the shared memory of a kubernetes Pod</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-06 09:00:39 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3381 words </span>
          <span class="more-meta"> 16 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background-knowledge-1-shared-memory">Background knowledge 1: shared memory</a>
          <ul>
            <li><a href="#system-v">System V</a></li>
            <li><a href="#posix">POSIX</a></li>
          </ul>
        </li>
        <li><a href="#background-knowledge-2-kubernetes-shared-memory">Background knowledge 2: kubernetes shared memory</a></li>
        <li><a href="#kubernetes-empty-dir">kubernetes empty dir</a></li>
        <li><a href="#disadvantages-of-using-empty-dir">Disadvantages of using empty dir</a></li>
        <li><a href="#cgroup-limits">cgroup limits</a>
          <ul>
            <li><a href="#cgroup-limits-for-memory">cgroup limits for memory</a></li>
            <li><a href="#is-shared-memory-limited-by-cgroup">Is shared memory limited by cgroup?</a></li>
          </ul>
        </li>
        <li><a href="#final-design">Final design</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Users can use shared memory to do some for communication (vs golang&rsquo;s &ldquo;shared memory by communication&rdquo;). On a kvm or physical machine, the size of shared memory available to the user is about half of the total memory. Here&rsquo;s how shared memory looks like on my pve machine, <code>/dev/shm</code> is the size of the shared memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@pve:~# free -h
</span></span><span class="line"><span class="cl">              total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:           47Gi        33Gi       3.4Gi       1.7Gi       9.7Gi        10Gi
</span></span><span class="line"><span class="cl">Swap:            0B          0B          0B
</span></span><span class="line"><span class="cl">root@pve:~# df -h
</span></span><span class="line"><span class="cl">Filesystem            Size  Used Avail Use% Mounted on
</span></span><span class="line"><span class="cl">udev                   24G     <span class="m">0</span>   24G   0% /dev
</span></span><span class="line"><span class="cl">tmpfs                  24G   54M   24G   1% /dev/shm
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, on kubernetes, a pod cannot use more than 64MB of shared memory. Here is the information of a pod on the cluster, you can see that the size of <code>/dev/shm</code> is 64MB, and when writing data to shared memory via dd, it will throw an exception &ldquo;No space left on device&rdquo; when it reaches 64MB.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl run centos --rm -it --image centos:7 bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos-7df8445565-dvpnt /<span class="o">]</span><span class="c1"># df -h|grep shm</span>
</span></span><span class="line"><span class="cl">Filesystem      Size  Used Avail Use% Mounted on
</span></span><span class="line"><span class="cl">shm              64M     <span class="m">0</span>   64M   0% /dev/shm
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos-7df8445565-dvpnt /<span class="o">]</span><span class="c1"># dd if=/dev/zero of=/dev/shm/test      bs=1024 count=102400</span>
</span></span><span class="line"><span class="cl">dd: error writing <span class="s1">&#39;/dev/shm/test&#39;</span>: No space left on device
</span></span><span class="line"><span class="cl">65537+0 records in
</span></span><span class="line"><span class="cl">65536+0 records out
</span></span><span class="line"><span class="cl"><span class="m">67108864</span> bytes <span class="o">(</span><span class="m">67</span> MB<span class="o">)</span> copied, 0.161447 s, <span class="m">416</span> MB/s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos-7df8445565-dvpnt /<span class="o">]</span><span class="c1"># ls -l -h</span>
</span></span><span class="line"><span class="cl">total 64M
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 64M Nov <span class="m">14</span> 14:33 <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@centos-7df8445565-dvpnt /<span class="o">]</span><span class="c1"># df -h|grep shm</span>
</span></span><span class="line"><span class="cl">Filesystem      Size  Used Avail Use% Mounted on
</span></span><span class="line"><span class="cl">shm              64M   64M     <span class="m">0</span> 100% /dev/shm
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="background-knowledge-1-shared-memory">Background knowledge 1: shared memory</h2>
<p>Shared memory is a mechanism used for inter-process communication (IPC) on Linux.</p>
<p>We know that inter-process communication can use pipes, sockets, signals, semaphores, message queues, etc., but these methods usually require copying between user state and kernel state, which is generally considered to be four times; in contrast, shared memory maps memory directly to user state space, i.e., multiple processes access the same block of memory, which is theoretically higher performance.</p>
<p>Shared memory is usually used in combination with semaphores to achieve synchronization and mutual exclusion between processes.</p>
<p>There are two ways to use shared memory, System V and POSIX.</p>
<ul>
<li>shmget/shmat/shmdt for the System V method.</li>
<li>shm_open/mmap/shm_unlink for the POSIX method.</li>
</ul>
<h3 id="system-v">System V</h3>
<p>The System V mechanism has a long history, so let&rsquo;s post a sample code for System V.</p>
<p>Here is the code to write the process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ipc.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/shm.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// ftok to generate unique key 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="s">&#34;shmfile&#34;</span><span class="p">,</span><span class="mi">65</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// shmget returns an identifier in shmid 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">shmid</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mo">0666</span><span class="o">|</span><span class="n">IPC_CREAT</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// shmat to attach to shared memory 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&#34;Write Data : &#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="n">gets</span><span class="p">(</span><span class="n">str</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Data written in memory: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">str</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    <span class="c1">//detach from shared memory  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">shmdt</span><span class="p">(</span><span class="n">str</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is the code of the read process. You can see that the read process finds the corresponding shared memory based on <code>key</code> and reads the contents of the shared memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/ipc.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/shm.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// ftok to generate unique key 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ftok</span><span class="p">(</span><span class="s">&#34;shmfile&#34;</span><span class="p">,</span><span class="mi">65</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// shmget returns an identifier in shmid 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">shmid</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mo">0666</span><span class="o">|</span><span class="n">IPC_CREAT</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// shmat to attach to shared memory 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Data read from memory: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">str</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    <span class="c1">//detach from shared memory  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">shmdt</span><span class="p">(</span><span class="n">str</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// destroy the shared memory 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">shmctl</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span><span class="n">IPC_RMID</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="posix">POSIX</h3>
<p>The POSIX interface is a bit more convenient and easy to use, where <code>shm_open(&quot;abc&quot;...)</code>, which is actually equivalent to <code>open(&quot;/dev/shm/aaa&quot;...)</code>, which converts shared memory to file operations; then maps the file to a pointer via mmap, and addresses the shared memory via the pointer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* the size (in bytes) of shared memory object */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Size of shm(in bytes): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%ld&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;size %ld</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* name of the shared memory object */</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;test&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* shared memory file descriptor */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">shm_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* pointer to shared memory obect */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* create the shared memory object */</span>
</span></span><span class="line"><span class="cl">    <span class="n">shm_fd</span> <span class="o">=</span> <span class="n">shm_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* configure the size of the shared memory object */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ftruncate</span><span class="p">(</span><span class="n">shm_fd</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* memory map the shared memory object */</span>
</span></span><span class="line"><span class="cl">    <span class="n">ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">shm_fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">close</span><span class="p">(</span><span class="n">shm_fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">shm_unlink</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="background-knowledge-2-kubernetes-shared-memory">Background knowledge 2: kubernetes shared memory</h2>
<p>Pods created by kubernetes have a default of 64MB of shared memory, which cannot be changed.</p>
<p>Why is this value? Actually, kubernetes itself does not set the size of shared memory. 64MB is actually the default shared memory size of docker.</p>
<p>When you run docker, you can set the shared memory size with <code>-shm-size</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ docker run  --rm centos:7 df -h <span class="p">|</span>grep shm
</span></span><span class="line"><span class="cl">shm              64M     <span class="m">0</span>   64M   0% /dev/shm
</span></span><span class="line"><span class="cl">$ docker run  --rm --shm-size 128M centos:7 df -h <span class="p">|</span>grep shm
</span></span><span class="line"><span class="cl">shm             128M     <span class="m">0</span>  128M   0% /dev/shm
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, kubernetes does not provide a way to set the shm size. In this <a href="https://github.com/kubernetes/kubernetes/issues/28272">issue</a> the community discussed for a long time whether to add a parameter to shm, but in the end there was no conclusion, except for a workgroud solution: mount the memory type emptyDir to /dev/shm to solve the problem.</p>
<h2 id="kubernetes-empty-dir">kubernetes empty dir</h2>
<p>The emptyDir volume is useful in some scenarios, such as sharing data between different containers in a Pod, where the same emptyDir can be mounted to both containers for sharing purposes. In this case, emtpyDir is actually a directory on the host, which is still essentially a disk (e.g. collecting logs by means of sidecar).</p>
<p>kubernetes provides a special kind of emptyDir: medium for temporary storage of memory. Users can hook the emptyDir of the memory medium to any directory and then use that directory as a high-performance filesystem.</p>
<p>Of course, we can also take the empty dir of the memory media and mount it under /dev/shm. This will solve the problem of not having enough shared memory /dev/shm.</p>
<p>Here is an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">infinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">sleep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">centos:7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">centos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/shm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">emptyDir</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">medium</span><span class="p">:</span><span class="w"> </span><span class="l">Memory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">sizeLimit</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After executing on kubernetes, we go into the container and do some operations to see if <code>/dev/shm</code> is expanded and if it will not exceed the <code>sizeLimit</code> value, and what will happen if it exceeds <code>sizeLimit</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it xxx-f6f865646-l54tq bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-f6f865646-l54tq /<span class="o">]</span><span class="c1"># df -h |grep shm</span>
</span></span><span class="line"><span class="cl">tmpfs           3.9G     <span class="m">0</span>  3.9G   0% /dev/shm
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-f6f865646-l54tq /<span class="o">]</span><span class="c1"># dd if=/dev/zero of=/dev/shm/test bs=1024 count=204800</span>
</span></span><span class="line"><span class="cl">204800+0 records in
</span></span><span class="line"><span class="cl">204800+0 records out
</span></span><span class="line"><span class="cl"><span class="m">209715200</span> bytes <span class="o">(</span><span class="m">210</span> MB<span class="o">)</span> copied, 0.366529 s, <span class="m">572</span> MB/s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-f6f865646-l54tq /<span class="o">]</span><span class="c1"># ls -l -h /dev/shm/test</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 200M Dec  <span class="m">4</span> 14:52 /dev/shm/test
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-f6f865646-l54tq /<span class="o">]</span><span class="c1"># command terminated with exit code 137</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods -o wide <span class="p">|</span>grep xxx
</span></span><span class="line"><span class="cl">xxx-f6f865646-8ll9p                       1/1     Running   <span class="m">0</span>          10s     10.244.7.110    optiplex-1   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">xxx-f6f865646-l54tq                       0/1     Evicted   <span class="m">0</span>          4m59s   &lt;none&gt;          optiplex-3   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the operation log above, the shared memory <code>/dev/shm</code> can write to files larger than 64MB, but if the file written exceeds the sizeLimit, it will be evict by kubelet after a period of time (1-2 minutes). The reason why it is not evict &ldquo;immediately&rdquo; is that kubelet checks periodically and there is a time lag here.</p>
<h2 id="disadvantages-of-using-empty-dir">Disadvantages of using empty dir</h2>
<p>The above temporary storage using memory media can solve the problem that the maximum shared memory can only be 64MB, but it has disadvantages.</p>
<p>Listed below.</p>
<ul>
<li>Can&rsquo;t disable users from using memory in time. Although the kubelet will extricate the Pod after 1-2 minutes, there is actually a risk to the node during this time.</li>
<li>Affects kubernetes scheduling because empty dir does not involve node resources, which can cause Pods to &ldquo;secretly&rdquo; use node memory without the scheduler knowing about it.</li>
<li>The user does not realize that memory is not available in time.</li>
</ul>
<p>Regarding the second point, as shown below, since there is no request and limit set in the Deployment configuration, the node shows that the memory request and limit of the Pod are 0, but the 1GiB of memroy temporary storage set in front of it is not reflected here, so it affects the scheduler and causes the scheduler to The memory usage of the node is &ldquo;overestimated&rdquo; by the scheduler.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl describe nodes optiplex-1
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Non-terminated Pods:         <span class="o">(</span><span class="m">11</span> in total<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Namespace                  Name                                      CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
</span></span><span class="line"><span class="cl">  ---------                  ----                                      ------------  ----------  ---------------  -------------  ---
</span></span><span class="line"><span class="cl">  default                    xxx-f6f865646-8ll9p                       <span class="m">0</span> <span class="o">(</span>0%<span class="o">)</span>        <span class="m">0</span> <span class="o">(</span>0%<span class="o">)</span>      <span class="m">0</span> <span class="o">(</span>0%<span class="o">)</span>           <span class="m">0</span> <span class="o">(</span>0%<span class="o">)</span>         7m3s
</span></span></code></pre></td></tr></table>
</div>
</div><p>To address these shortcomings, we need to go back to cgroup first.</p>
<h2 id="cgroup-limits">cgroup limits</h2>
<h3 id="cgroup-limits-for-memory">cgroup limits for memory</h3>
<p>The following is a small program for c. The code requests a number of memory sizes and memset the memory to 0. Note that you must memset, otherwise malloc just &ldquo;claims&rdquo; to have requested the memory and the kernel does not map the virtual addresses to physical memory addresses.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Number of calloc: &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Size of calloc(in bytes): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kt">int</span><span class="o">**</span> <span class="n">x</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="n">perror</span><span class="p">(</span><span class="s">&#34;malloc failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="n">memset</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="n">printf</span><span class="p">(</span><span class="s">&#34;calloc %d bytes memory.</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span><span class="s">&#34;done</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">printf</span><span class="p">(</span><span class="s">&#34;pause</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">pause</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We set the memory limit for the container and copy the binary compiled above calloc to the container after startup.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx-cgroup-calloc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">infinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">sleep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">centos:7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">centos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After the container is started, we go into the container first to see the current configuration of the cgroup.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@xxx-cgroup-calloc-5b998f5897-b7xn6 memory<span class="o">]</span><span class="c1"># cat /sys/fs/cgroup/memory/memory.limit_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">268435456</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-cgroup-calloc-5b998f5897-b7xn6 memory<span class="o">]</span><span class="c1"># cat /sys/fs/cgroup/memory/memory.usage_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">2056192</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the memory limit configured in cgroup is <code>memory.limit_in_bytes</code> of 256MB, and the current used memory <code>memory.usage_in_bytes</code> is about 2MB, because there are sleep processes, bash processes, etc. started in the container, which will consume some memory.</p>
<p>Let&rsquo;s start by requesting 64MB of memory using the calloc applet above.</p>
<p>Request 64MB of memory in console 1 and do not exit the calloc process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@xxx-cgroup-calloc-5b998f5897-b7xn6 memory<span class="o">]</span><span class="c1"># /bin/calloc</span>
</span></span><span class="line"><span class="cl">Number of calloc: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Size of calloc<span class="o">(</span>in bytes<span class="o">)</span>: <span class="m">67108864</span>
</span></span><span class="line"><span class="cl">calloc <span class="m">67108864</span> bytes memory.
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">pause
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check the current used memory in console 2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@xxx-cgroup-calloc-5b998f5897-b7xn6 memory<span class="o">]</span><span class="c1"># cat /sys/fs/cgroup/memory/memory.usage_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">69464064</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the used memory increases by about 67108864 bytes.</p>
<p>So, when will cgroup exercise its power?</p>
<p>We stop the current calloc on console 1 and request 256MB of memory again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@xxx-cgroup-calloc-5b998f5897-b7xn6 memory<span class="o">]</span><span class="c1"># /bin/calloc</span>
</span></span><span class="line"><span class="cl">Number of calloc: <span class="m">1</span>
</span></span><span class="line"><span class="cl">Size of calloc<span class="o">(</span>in bytes<span class="o">)</span>: <span class="m">268435456</span>
</span></span><span class="line"><span class="cl">Killed
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the calloc process is killed directly. Who killed it?</p>
<p>Let&rsquo;s go to the node where the pod is located and look at the system logs, we can find traces of the oom killer working.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276093] calloc invoked oom-killer: gfp_mask=0x14000c0(GFP_KERNEL), nodemask=(null), order=0, oom_score_adj=968
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276094] calloc cpuset=beead52e53d4918e7b2820c2712151f2833e4055bc72abc9ea287a02459fc55a mems_allowed=0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276097] CPU: 0 PID: 28285 Comm: calloc Not tainted 4.15.0-63-generic #72-Ubuntu
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276097] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.12.1-0-ga5cab58e9a3f-prebuilt.qemu.org 04/01/2014
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276098] Call Trace:
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276103]  dump_stack+0x63/0x8e
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276104]  dump_header+0x71/0x285
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276106]  oom_kill_process+0x21f/0x420
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276107]  out_of_memory+0x2b6/0x4d0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276108]  mem_cgroup_out_of_memory+0xbb/0xd0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276109]  mem_cgroup_oom_synchronize+0x2e8/0x320
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276111]  ? mem_cgroup_css_online+0x40/0x40
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276112]  pagefault_out_of_memory+0x36/0x7b
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276114]  mm_fault_error+0x90/0x180
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276115]  __do_page_fault+0x46b/0x4b0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276116]  ? __schedule+0x256/0x880
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276117]  do_page_fault+0x2e/0xe0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276118]  ? async_page_fault+0x2f/0x50
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276120]  do_async_page_fault+0x51/0x80
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276121]  async_page_fault+0x45/0x50
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276122] RIP: 0033:0x7f129f50dfe0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276123] RSP: 002b:00007ffcbafce968 EFLAGS: 00010206
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276124] RAX: 00007f128f47e010 RBX: 0000563b4b7df010 RCX: 00007f129f1cb000
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276124] RDX: 00007f129f47e000 RSI: 0000000000000000 RDI: 00007f128f47e010
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276125] RBP: 00007ffcbafce9a0 R08: ffffffffffffffff R09: 0000000010000000
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276125] R10: 0000000000000022 R11: 0000000000001000 R12: 0000563b49a997c0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276125] R13: 00007ffcbafcea80 R14: 0000000000000000 R15: 0000000000000000
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276126] Task in /kubepods/burstable/pod465a9fc1-0de9-44cd-b22c-7e6b23fd75f8/beead52e53d4918e7b2820c2712151f2833e4055bc72abc9ea287a02459fc55a killed as a result of limit of /kubepods/burstable/pod465a9fc1-0de9-44cd-b22c-7e6b23fd75f8
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276129] memory: usage 262144kB, limit 262144kB, failcnt 131
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276130] memory+swap: usage 0kB, limit 9007199254740988kB, failcnt 0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276130] kmem: usage 1704kB, limit 9007199254740988kB, failcnt 0
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276131] Memory cgroup stats for /kubepods/burstable/pod465a9fc1-0de9-44cd-b22c-7e6b23fd75f8: cache:0KB rss:0KB rss_huge:0KB shmem:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:0KB active_anon:0KB inactive_file:0KB active_file:0KB unevictable:0KB
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276136] Memory cgroup stats for /kubepods/burstable/pod465a9fc1-0de9-44cd-b22c-7e6b23fd75f8/d081810d182504b5c3c38e0a28e16467385abda8553e286948f6cc5b3849ca0b: cache:0KB rss:40KB rss_huge:0KB shmem:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:0KB active_anon:40KB inactive_file:0KB active_file:0KB unevictable:0KB
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276141] Memory cgroup stats for /kubepods/burstable/pod465a9fc1-0de9-44cd-b22c-7e6b23fd75f8/beead52e53d4918e7b2820c2712151f2833e4055bc72abc9ea287a02459fc55a: cache:0KB rss:260400KB rss_huge:0KB shmem:0KB mapped_file:0KB dirty:0KB writeback:0KB inactive_anon:0KB active_anon:260396KB inactive_file:0KB active_file:0KB unevictable:0KB
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276145] [ pid ]   uid  tgid total_vm      rss pgtables_bytes swapents oom_score_adj name
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276203] [ 8111]     0  8111      256        1    32768        0          -998 pause
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276204] [ 8255]     0  8255     1093      146    57344        0           968 sleep
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276205] [14119]     0 14119     2957      710    65536        0           968 bash
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276206] [21462]     0 21462     2958      690    69632        0           968 bash
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276207] [28285]     0 28285    66627    65119   577536        0           968 calloc
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276208] Memory cgroup out of memory: Kill process 28285 (calloc) score 1955 or sacrifice child
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.276513] Killed process 28285 (calloc) total-vm:266508kB, anon-rss:259280kB, file-rss:1196kB, shmem-rss:0kB
</span></span><span class="line"><span class="cl">Dec  4 15:24:33 optiplex-2 kernel: [6686782.289037] oom_reaper: reaped process 28285 (calloc), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB
</span></span></code></pre></td></tr></table>
</div>
</div><p>We often see oom killer kill processes on some memory-strapped servers, but actually oom killer works in cgroups, for example, the above cgroup is <code>/kubepods/burstable/pod465a9fc1-0de9-44cd-b22c- 7e6b23fd75f8/</code> . In this cgroup, when there is a missing page interrupt (do_page_fault), oom killer will look for all processes in <strong>this cgroup</strong> and score them. The scoring process will refer to oom_score_adj, which is a priority factor, the smaller the value, the higher the priority.</p>
<p>From the logs, we can see that all processes are 968 except for the pause process (i.e. the creator of the sandbox container, cgroup and namespace in Pod, which has a priority of -998, the highest priority), so the scoring is more about the memory used by the process.</p>
<p>Since the calloc process uses the most processes, it has the highest score (1955), so the oom killer kills the process, which is what we saw above when the calloc process was &ldquo;Killed&rdquo;.</p>
<p>This is how kubernetes&rsquo; memory limit works.</p>
<h3 id="is-shared-memory-limited-by-cgroup">Is shared memory limited by cgroup?</h3>
<p>Back to our question.</p>
<p>Since normal memory is limited by cgroup, it naturally begs the question: Is shared memory limited by cgroup? If it is, then just set the memroy limit for the Pod, and the kubernetes level doesn&rsquo;t need to care whether the user uses the memory for shared memory or for general use: because shared memory is not a &ldquo;standalone&rdquo; memory, it is just included in the memory The shared memory is not a &ldquo;standalone&rdquo; memory, but is included in the memory limit for scheduling, and therefore does not affect scheduling.</p>
<p>Let&rsquo;s add memory limit to deployment xxx and continue testing. Since we are using POSIX to manipulate shared memory, we can test it directly with dd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">infinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">sleep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">centos:7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">centos</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/shm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">emptyDir</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">medium</span><span class="p">:</span><span class="w"> </span><span class="l">Memory</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">sizeLimit</span><span class="p">:</span><span class="w"> </span><span class="l">128Mi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cache-volume</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We go to the container, create and delete a 100MB file in <code>/dev/shm</code> by dd, and look at <code>memory.usage_in_bytes</code> to see the usage of shared memory during the process, which is reflected in the cgroup.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it xxx-789569d8c8-8pls5 bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># cat /sys/fs/cgroup/memory/memory.limit_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">268435456</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># df -h |grep shm</span>
</span></span><span class="line"><span class="cl">tmpfs           3.9G     <span class="m">0</span>  3.9G   0% /dev/shm
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># dd if=/dev/zero of=/dev/shm/test      bs=1024 count=102400</span>
</span></span><span class="line"><span class="cl">102400+0 records in
</span></span><span class="line"><span class="cl">102400+0 records out
</span></span><span class="line"><span class="cl"><span class="m">104857600</span> bytes <span class="o">(</span><span class="m">105</span> MB<span class="o">)</span> copied, 0.156172 s, <span class="m">671</span> MB/s
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># ls -l -h /dev/shm/test</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 100M Dec  <span class="m">4</span> 15:43 /dev/shm/test
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># df -h |grep sh</span>
</span></span><span class="line"><span class="cl">tmpfs           3.9G  100M  3.8G   3% /dev/shm
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># cat /sys/fs/cgroup/memory/memory.usage_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">106643456</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># rm /dev/shm/test</span>
</span></span><span class="line"><span class="cl">rm: remove regular file <span class="s1">&#39;/dev/shm/test&#39;</span>? y
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># cat /sys/fs/cgroup/memory/memory.usage_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">1654784</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># dd if=/dev/zero of=/dev/shm/test      bs=1024 count=409600</span>
</span></span><span class="line"><span class="cl">Killed
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@xxx-789569d8c8-8pls5 /<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">bash: /usr/bin/ls: Argument list too long
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that when a file larger than the memory limit is finally created, it will be found that the dd process will be killed, which is also in line with the cgroup limit, but this will then cause a problem: no commands can be executed because the memory is all depleted by the shared memory.</p>
<p>But don&rsquo;t worry, as the shared memory usage exceeds the set <code>sizeLimit</code>, after 1-2 minutes, it will be evict by kubelet and pull up a new pod again, and the new pod can run normally.</p>
<p>So, referring to kvm and physical machines, we can set <code>sizeLimit</code> always to 50% of memory limit, even if users use shared memory and exceed the memory limit, it will be found by kubelet and evict away.</p>
<h2 id="final-design">Final design</h2>
<p>Based on the above analysis, the &ldquo;shared memory&rdquo; feature of the kubernetes-based platform is designed as follows.</p>
<ol>
<li>mount <code>emptyDir</code> of the memory media to <code>/dev/shm/</code></li>
<li>configure the <code>memory limit</code> of the container</li>
<li>Configure the <code>sizeLimit</code> of <code>emptyDir</code> of the memory media to be 50% of the <code>memory limit</code>.</li>
</ol>
<p>Further, the above configuration can be automatically configured in the admission controller for the user, so the user does not need to explicitly &ldquo;request to turn on shared memory&rdquo;.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/k8s-pod-security-policies/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Enabling Pod Security Policies for Kubernetes Clustering</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/almalinux-microsoft-store/">
            <span class="next-text nav-default">Another Linux-based operating system comes to the Microsoft Store</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
