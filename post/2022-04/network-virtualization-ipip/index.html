<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>[Network Virtualization] Ipip - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to implement a very typical IPIP tunneling in the cloud computing world through TUN devices." /><meta name="keywords" content="Network Virtualization, Ipip" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/network-virtualization-ipip/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="[Network Virtualization] Ipip" />
<meta property="og:description" content="Learn how to implement a very typical IPIP tunneling in the cloud computing world through TUN devices." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/network-virtualization-ipip/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-30T11:54:05+08:00" />
<meta property="article:modified_time" content="2022-04-30T11:54:05+08:00" />

<meta itemprop="name" content="[Network Virtualization] Ipip">
<meta itemprop="description" content="Learn how to implement a very typical IPIP tunneling in the cloud computing world through TUN devices."><meta itemprop="datePublished" content="2022-04-30T11:54:05+08:00" />
<meta itemprop="dateModified" content="2022-04-30T11:54:05+08:00" />
<meta itemprop="wordCount" content="2805">
<meta itemprop="keywords" content="network virtualization," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Network Virtualization] Ipip"/>
<meta name="twitter:description" content="Learn how to implement a very typical IPIP tunneling in the cloud computing world through TUN devices."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">[Network Virtualization] Ipip</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-30 11:54:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2805 words </span>
          <span class="more-meta"> 14 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#ipip-tunneling">IPIP Tunneling</a></li>
            <li><a href="#one-to-one">one-to-one</a></li>
            <li><a href="#one-to-many">one-to-many</a></li>
            <li><a href="#under-the-hood">under the hood</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In the previous note, we learned about a typical principle of VPN through TUN/TAP devices when introducing network devices, but did not practice how TUN/TAP virtual network devices specifically function practically in linux. In this note we will look at how a very typical IPIP tunnel in the cloud computing field is implemented through TUN devices.</p>
<h3 id="ipip-tunneling">IPIP Tunneling</h3>
<p>As we mentioned in the previous note, the TUN network device can encapsulate a Layer 3 (IP) network packet within another Layer 3 network packet, and it looks like the packet sent out through the TUN device will look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">MAC: xx:xx:xx:xx:xx:xx
</span></span><span class="line"><span class="cl">IP Header: &lt;new destination IP&gt;
</span></span><span class="line"><span class="cl">IP Body:
</span></span><span class="line"><span class="cl">  IP: &lt;original destination IP&gt;
</span></span><span class="line"><span class="cl">  TCP: stuff
</span></span><span class="line"><span class="cl">  HTTP: stuff
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is the structure of a typical IPIP tunnel packet. Linux natively supports several different types of IPIP tunnels, but all rely on TUN network devices, and we can view the relevant types of IPIP tunnels and their operations by using the command ip tunnel help.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip tunnel help</span>
</span></span><span class="line"><span class="cl">Usage: ip tunnel <span class="o">{</span> add <span class="p">|</span> change <span class="p">|</span> del <span class="p">|</span> show <span class="p">|</span> prl <span class="p">|</span> 6rd <span class="o">}</span> <span class="o">[</span> NAME <span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="o">[</span> mode <span class="o">{</span> ipip <span class="p">|</span> gre <span class="p">|</span> sit <span class="p">|</span> isatap <span class="p">|</span> vti <span class="o">}</span> <span class="o">]</span> <span class="o">[</span> remote ADDR <span class="o">]</span> <span class="o">[</span> <span class="nb">local</span> ADDR <span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="o">[</span> <span class="o">[</span>i<span class="p">|</span>o<span class="o">]</span>seq <span class="o">]</span> <span class="o">[</span> <span class="o">[</span>i<span class="p">|</span>o<span class="o">]</span>key KEY <span class="o">]</span> <span class="o">[</span> <span class="o">[</span>i<span class="p">|</span>o<span class="o">]</span>csum <span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="o">[</span> prl-default ADDR <span class="o">]</span> <span class="o">[</span> prl-nodefault ADDR <span class="o">]</span> <span class="o">[</span> prl-delete ADDR <span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="o">[</span> 6rd-prefix ADDR <span class="o">]</span> <span class="o">[</span> 6rd-relay_prefix ADDR <span class="o">]</span> <span class="o">[</span> 6rd-reset <span class="o">]</span>
</span></span><span class="line"><span class="cl">          <span class="o">[</span> ttl TTL <span class="o">]</span> <span class="o">[</span> tos TOS <span class="o">]</span> <span class="o">[</span> <span class="o">[</span>no<span class="o">]</span>pmtudisc <span class="o">]</span> <span class="o">[</span> dev PHYS_DEV <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Where: NAME :<span class="o">=</span> STRING
</span></span><span class="line"><span class="cl">       ADDR :<span class="o">=</span> <span class="o">{</span> IP_ADDRESS <span class="p">|</span> any <span class="o">}</span>
</span></span><span class="line"><span class="cl">       TOS  :<span class="o">=</span> <span class="o">{</span> STRING <span class="p">|</span> 00..ff <span class="p">|</span> inherit <span class="p">|</span> inherit/STRING <span class="p">|</span> inherit/00..ff <span class="o">}</span>
</span></span><span class="line"><span class="cl">       TTL  :<span class="o">=</span> <span class="o">{</span> 1..255 <span class="p">|</span> inherit <span class="o">}</span>
</span></span><span class="line"><span class="cl">       KEY  :<span class="o">=</span> <span class="o">{</span> DOTTED_QUAD <span class="p">|</span> NUMBER <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>where <code>mode</code> represents the different IPIP tunnel types, Linux natively supports a total of 5 types of IPIP tunnels.</p>
<ol>
<li>ipip: Common IPIP tunneling, which is the encapsulation of an IPv4 message on top of a message</li>
<li>gre: Generic Routing Encapsulation, which defines a mechanism to encapsulate any other network layer protocol on top of any other network layer protocol, so it works for both IPv4 and IPv6</li>
<li>sit: sit mode is mainly used for IPv4 messages to encapsulate IPv6 messages, i.e. IPv6 over IPv4</li>
<li>isatap: Intra-Site Automatic Tunnel Addressing Protocol, similar to sit, is also used for IPv6 tunnel encapsulation</li>
<li>vti: Virtual Tunnel Interface, an IPsec tunneling technology</li>
</ol>
<p>Some other useful parameters.</p>
<ul>
<li><code>- ttl N</code> sets the TTL of the incoming tunnel packet to N (N is a number between 1 and 255, 0 is a special value indicating that the TTL value of this packet is inherited (inherit)), the default value of the ttl parameter is for inherit</li>
<li><code>- tos T/dsfield T</code> Set the TOS field of the incoming channel packet, the default is inherit</li>
<li><code>- [no]pmtudisc</code> Disable or turn on Path MTU Discovery on this tunnel, the default is enable</li>
</ul>
<blockquote>
<p>Note: The nopmtudisc option is not compatible with fixed ttl, if the fixed ttl parameter is used, the system will turn on Path MTU Discovery.</p>
</blockquote>
<h3 id="one-to-one">one-to-one</h3>
<p>Let&rsquo;s start with the most basic one-to-one IPIP tunneling mode as an example to introduce how to build IPIP tunnels in linux to communicate between two different subnets.</p>
<p>Before you start, it should be noted that not all linux distributions load the <code>ipip.ko</code> module by default. You can check if the kernel loads the module by using <code>lsmod | grep ipip</code>; if not, use <code>modprobe ipip</code> to load it first; if everything is fine then it should look like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># lsmod | grep ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># modprobe ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lsmod | grep ipip</span>
</span></span><span class="line"><span class="cl">ipip                   <span class="m">20480</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">tunnel4                <span class="m">16384</span>  <span class="m">1</span> ipip
</span></span><span class="line"><span class="cl">ip_tunnel              <span class="m">24576</span>  <span class="m">1</span> ipip
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now it&rsquo;s time to start building the IPIP tunnel. Our network topology is shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/30/ef01c6569b604828a38baafeeec6ceb7.png" alt="network topology"></p>
<p>There are two hosts A and B in the same network segment <code>172.16.0.0/16</code>, so they can be connected directly. What we need to do is to create two different subnets on each of the two hosts.</p>
<blockquote>
<p>Note: In fact, the two hosts A and B are unnecessarily in the same subnet, as long as they are in the same layer 3 network, which means that they can be routed through the layer 3 network to complete the IPIP tunnel.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">A: 10.42.1.0/24
</span></span><span class="line"><span class="cl">B: 10.42.2.0/24
</span></span></code></pre></td></tr></table>
</div>
</div><p>To simplify things, we first create the bridge network device <code>mybr0</code> on node A and set the IP address to the gateway address of the <code>10.42.1.0/24</code> subnet, then enable <code>mybr0</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip link add name mybr0 type bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.1.1/24 dev mybr0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set dev mybr0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similarly, a similar operation is then performed separately on node B.</p>
<p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip link add name mybr0 type bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.2.1/24 dev mybr0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set dev mybr0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, we separately on two nodes A and B</p>
<ol>
<li>create the corresponding TUN network devices</li>
<li>set the corresponding local and remote addresses as the routable addresses of the node</li>
<li>set the corresponding gateway address as the TUN network device we are going to create</li>
<li>Enable the TUN network device to create the IPIP tunnel</li>
</ol>
<blockquote>
<p>Note: Step 3 is to save and simplify the steps of creating subnets by setting the gateway address directly without creating additional network devices.</p>
</blockquote>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># modprobe ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip tunnel add tunl0 mode ipip remote 172.16.232.194 local 172.16.232.172</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.1.1/24 dev tunl0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set tunl0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command creates a new tunnel device <code>tunl0</code> and sets the <code>remote</code> and <code>local</code> IP addresses of the tunnel, which are the outer addresses of the IPIP packets; for the inner addresses, we set two separate subnet addresses, so that the IPIP packets will look as shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/30/ead3ed3f142941e0ae58a0e7e11614e5.png" alt="IPIP packets"></p>
<p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># modprobe ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip tunnel add tunl0 mode ipip remote 172.16.232.172 local 172.16.232.194</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.2.1/24 dev tunl0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set tunl0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In order to ensure that we access subnets on two different hosts through the IPIP tunnel created, we need to manually add the following static route.</p>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip route add 10.42.2.0/24 dev tunl0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip route add 10.42.1.0/24 dev tunl0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The routing table for host AB is now shown below.</p>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip route show</span>
</span></span><span class="line"><span class="cl">default via 172.16.200.51 dev ens3
</span></span><span class="line"><span class="cl">10.42.1.0/24 dev tunl0 proto kernel scope link src 10.42.1.1
</span></span><span class="line"><span class="cl">10.42.2.0/24 dev tunl0 scope link
</span></span><span class="line"><span class="cl">172.16.0.0/16 dev ens3 proto kernel scope link src 172.16.232.172
</span></span></code></pre></td></tr></table>
</div>
</div><p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip route show</span>
</span></span><span class="line"><span class="cl">default via 172.16.200.51 dev ens3
</span></span><span class="line"><span class="cl">10.42.1.0/24 dev tunl0 scope link
</span></span><span class="line"><span class="cl">10.42.2.0/24 dev tunl0 proto kernel scope link src 10.42.2.1
</span></span><span class="line"><span class="cl">172.16.0.0/16 dev ens3 proto kernel scope link src 172.16.232.194
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point we can start verifying that the IPIP tunnel is working properly:</p>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ping 10.42.2.1 -c 2</span>
</span></span><span class="line"><span class="cl">PING 10.42.2.1 <span class="o">(</span>10.42.2.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.2.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.269 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.2.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.303 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.42.2.1 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1013ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.269/0.286/0.303/0.017 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ping 10.42.1.1 -c 2</span>
</span></span><span class="line"><span class="cl">PING 10.42.1.1 <span class="o">(</span>10.42.1.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.214 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>3.27 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.42.1.1 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1021ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.214/1.745/3.277/1.532 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>Yes, it can ping through, and we grab the data at the TUN device via tcpdump.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># tcpdump -n -i tunl0</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on tunl0, link-type RAW <span class="o">(</span>Raw IP<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">01:32:05.486835 IP 10.42.1.1 &gt; 10.42.2.1: ICMP <span class="nb">echo</span> request, id 3460, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">01:32:05.486868 IP 10.42.2.1 &gt; 10.42.1.1: ICMP <span class="nb">echo</span> reply, id 3460, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">01:32:06.509617 IP 10.42.1.1 &gt; 10.42.2.1: ICMP <span class="nb">echo</span> request, id 3460, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">01:32:06.509668 IP 10.42.2.1 &gt; 10.42.1.1: ICMP <span class="nb">echo</span> reply, id 3460, seq 2, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Up to this point, our experiment was successful. However, it should be noted that if we are using gre mode, it is possible that we need to set up a firewall to allow the two subnets to interoperate, which is more common in building IPv6 tunnels.</p>
<h3 id="one-to-many">one-to-many</h3>
<p>In the previous section, we created a one-to-one IPIP tunnel by specifying the local address and remote address of the TUN device. In fact, it is possible to create an IPIP tunnel without specifying the remote address at all, just add the corresponding route on the TUN device, and the IPIP tunnel will know how to encapsulate the new IP packets and deliver them to the route to the specified destination address.</p>
<p>To illustrate, suppose we now have three nodes in the same Layer 3 network.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">A: 172.16.165.33
</span></span><span class="line"><span class="cl">B: 172.16.165.244
</span></span><span class="line"><span class="cl">C: 172.16.168.113
</span></span></code></pre></td></tr></table>
</div>
</div><p>Attach three different subnets on each of these three nodes at the same time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">A: 10.42.1.0/24
</span></span><span class="line"><span class="cl">B: 10.42.2.0/24
</span></span><span class="line"><span class="cl">C: 10.42.3.0/24
</span></span></code></pre></td></tr></table>
</div>
</div><p>Unlike the previous subsection, instead of directly setting the gateway address of the subnet to the IP address of the TUN device, we create an additional bridge network device to simulate the actual common container network model. We create the bridge network device <code>mybr0</code> on node A and set the IP address to the gateway address of the <code>10.42.1.0/24</code> subnet, and then enable <code>mybr0</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip link add name mybr0 type bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.1.1/24 dev mybr0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set dev mybr0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similarly, a similar operation is then performed on nodes B and C, respectively.</p>
<p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip link add name mybr0 type bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.2.1/24 dev mybr0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set dev mybr0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>C:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip link add name mybr0 type bridge</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.3.1/24 dev mybr0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set dev mybr0 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our ultimate goal is to build IPIP tunnels between each of the three nodes to ensure that the three different subnets can communicate directly with each other, so the next step is to create the TUN network device and set up the routing information. On nodes A and B, respectively.</p>
<ol>
<li>create the corresponding TUN network device and enable it</li>
<li>set the IP address of the TUN network device</li>
<li>set the routes to different subnets and specify the next hop address</li>
</ol>
<p>The corresponding gateway address is the TUN network device we are going to create respectively</p>
<ol>
<li>Enable the TUN network device to create IPIP tunnel</li>
</ol>
<blockquote>
<p>Note: The IP address of the TUN network device is the subnet address of the corresponding node, but the subnet mask is 32 bits, for example, the subnet address on node A is <code>10.42.1.0/24</code>, the IP address of the TUN network device on node A is <code>10.42.1.0/32</code>. The reason for this is that sometimes addresses on the same subnet (e.g. <code>10.42.1.0/24</code>) are assigned the same MAC address and therefore cannot communicate directly through the link layer of layer 2, whereas if the IP address of the TUN network device and any address are guaranteed not to be on the same subnet, there is no direct communication at the link layer of layer 2. On this point please refer to the implementation principle of calico, each container will have the same MAC address, later we have the opportunity to explore in depth.</p>
<p>Note: Another point to note is that when setting up the route to the TUN network device, <code>onlink</code> is specified, the purpose of this is to ensure that the next hop is directly attached to the TUN network device, so that even if the nodes are not in the same subnet, you can still build IPIP tunnels.</p>
</blockquote>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># modprobe ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip tunnel add tunl0 mode ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set tunl0 up</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.1.0/32 dev tunl0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip route add 10.42.2.0/24 via 172.16.165.244 dev tunl0 onlink</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip route add 10.42.3.0/24 via 172.16.168.113 dev tunl0 onlink</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># modprobe ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip tunnel add tunl0 mode ipip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip link set tunl0 up</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip addr add 10.42.2.0/32 dev tunl0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip route add 10.42.1.0/24 via 172.16.165.33 dev tunl0 onlink</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ip route add 10.42.3.0/24 via 172.16.168.113 dev tunl0 onlink</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>C:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">modprobe ipip
</span></span><span class="line"><span class="cl">ip tunnel add tunl0 mode ipip
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> tunl0 up
</span></span><span class="line"><span class="cl">ip addr add 10.42.3.0/32 dev tunl0
</span></span><span class="line"><span class="cl">ip route add 10.42.1.0/24 via 172.16.165.33 dev tunl0 onlink
</span></span><span class="line"><span class="cl">ip route add 10.42.2.0/24 via 172.16.165.244 dev tunl0 onlink
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point we can start verifying that the IPIP tunnel we built is working properly.</p>
<p>A:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># try to ping IP in 10.42.2.0/24 on Node B</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ping 10.42.2.1 -c 2</span>
</span></span><span class="line"><span class="cl">PING 10.42.2.1 <span class="o">(</span>10.42.2.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.2.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.338 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.2.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.302 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.42.2.1 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1028ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.302/0.320/0.338/0.018 ms
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># try to ping IP in 10.42.3.0/24 on Node C</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ping 10.42.3.1 -c 2</span>
</span></span><span class="line"><span class="cl">PING 10.42.3.1 <span class="o">(</span>10.42.3.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.3.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.315 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.42.3.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.381 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">--- 10.42.3.1 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1029ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.315/0.348/0.381/0.033 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>Everything seems to work fine, and if we reverse the process and ping the other subnets from node B or C respectively, we can get through. This shows that we can indeed create one-to-many IPIP tunnels, and this one-to-many pattern is very useful in creating overlay communication models in some typical multi-node networks.</p>
<h3 id="under-the-hood">under the hood</h3>
<p>We then grab the data via tcpdump on the TUN devices in B and C respectively.</p>
<p>B:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># tcpdump -n -i tunl0</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on tunl0, link-type RAW <span class="o">(</span>Raw IP<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">22:38:28.268089 IP 10.42.1.0 &gt; 10.42.2.1: ICMP <span class="nb">echo</span> request, id 6026, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">22:38:28.268125 IP 10.42.2.1 &gt; 10.42.1.0: ICMP <span class="nb">echo</span> reply, id 6026, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">22:38:29.285595 IP 10.42.1.0 &gt; 10.42.2.1: ICMP <span class="nb">echo</span> request, id 6026, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">22:38:29.285629 IP 10.42.2.1 &gt; 10.42.1.0: ICMP <span class="nb">echo</span> reply, id 6026, seq 2, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>C:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># tcpdump -n -i tunl0</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on tunl0, link-type RAW <span class="o">(</span>Raw IP<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">22:36:18.236446 IP 10.42.1.0 &gt; 10.42.3.1: ICMP <span class="nb">echo</span> request, id 5894, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">22:36:18.236499 IP 10.42.3.1 &gt; 10.42.1.0: ICMP <span class="nb">echo</span> reply, id 5894, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">22:36:19.265946 IP 10.42.1.0 &gt; 10.42.3.1: ICMP <span class="nb">echo</span> request, id 5894, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">22:36:19.265997 IP 10.42.3.1 &gt; 10.42.1.0: ICMP <span class="nb">echo</span> reply, id 5894, seq 2, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In fact, from the process of creating one-to-many IPIP tunnels we can roughly guess that the Linux ipip module gets the internal IPIP packet based on routing information and then encapsulates it with an external IP into a new IP packet. As for how to unpack IPIP packets, let&rsquo;s look at the process of ipip module to receive packets.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ip_protocol_deliver_rcu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">struct</span> <span class="n">net_protocol</span> <span class="o">*</span><span class="n">ipprot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">raw</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">resubmit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw</span> <span class="o">=</span> <span class="n">raw_local_deliver</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ipprot</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">inet_protos</span><span class="p">[</span><span class="n">protocol</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ipprot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipprot</span><span class="o">-&gt;</span><span class="n">no_policy</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xfrm4_policy_check</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">XFRM_POLICY_IN</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">nf_reset_ct</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">INDIRECT_CALL_2</span><span class="p">(</span><span class="n">ipprot</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="n">tcp_v4_rcv</span><span class="p">,</span> <span class="n">udp_rcv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">protocol</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">__IP_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INDELIVERS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">xfrm4_policy_check</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">XFRM_POLICY_IN</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">__IP_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INUNKNOWNPROTOS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">icmp_send</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ICMP_DEST_UNREACH</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ICMP_PROT_UNREACH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">__IP_INC_STATS</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">IPSTATS_MIB_INDELIVERS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From <a href="https://github.com/torvalds/linux/blob/master/net/ipv4/ip_input.c#L187-L224">https://github.com/torvalds/linux/blob/master/net/ipv4/ip_input.c#L187-L224</a></p>
<p>As you can see, the ipip module will unblock the packet according to its protocol type, and then do it again with the unblocked skb packet. The above is just some very superficial analysis, if you are interested, we recommend to go to see more source code implementation of ipip module.</p>
<hr>
<p>Reference <code>https://houmin.cc/posts/cc24de6a/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/network-virtualization/">network virtualization</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/network-virtualization-ipvlan/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">[Network Virtualization] IPVlan</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/network-virtualization-bridge/">
            <span class="next-text nav-default">[Network Virtualization] Bridge</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
