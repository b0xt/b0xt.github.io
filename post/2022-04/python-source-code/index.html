<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Automated build solutions for Python source code protection - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore solutions for automated builds of Python source code protection." /><meta name="keywords" content="python, Source Code, protection, Cython" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/python-source-code/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Automated build solutions for Python source code protection" />
<meta property="og:description" content="Explore solutions for automated builds of Python source code protection." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/python-source-code/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-12T18:45:08+08:00" />
<meta property="article:modified_time" content="2022-04-12T18:45:08+08:00" />

<meta itemprop="name" content="Automated build solutions for Python source code protection">
<meta itemprop="description" content="Explore solutions for automated builds of Python source code protection."><meta itemprop="datePublished" content="2022-04-12T18:45:08+08:00" />
<meta itemprop="dateModified" content="2022-04-12T18:45:08+08:00" />
<meta itemprop="wordCount" content="876">
<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automated build solutions for Python source code protection"/>
<meta name="twitter:description" content="Explore solutions for automated builds of Python source code protection."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Automated build solutions for Python source code protection</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-12 18:45:08 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 876 words </span>
          <span class="more-meta"> 2 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>The three main options for Python source protection are code obfuscation, modifying the interpreter, and compiling to binary; the other methods are basically ineffective. The safest of these three options is to compile py files with <a href="https://cython.org/">Cython</a> (but you need to be careful about compatibility).</p>
<p>The method is simple: write a <code>setup.py</code> file first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">glob</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">py_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*/**/*.py&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 第一层的 py 文件不编译，因为 so 文件不支持直接用 python -m 来执行</span>
</span></span><span class="line"><span class="cl"><span class="n">setup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">py_files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">nthreads</span><span class="o">=</span><span class="mi">4</span>  <span class="c1"># 同时用 4 个进程来编译 py 到 c，根据自己的 CPU 核数来设置</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If needed, you can refer to <a href="https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiler-directives">documentation</a> to add <code>compiler_directives</code>.</p>
<p>Then execute <code>python setup.py build_ext --inplace -j 4</code> to start compiling, where <code>-inplace</code> is to put the compiled c and so files together with the py files, and <code>-j 4</code> is to use 4 processes to compile c to so at the same time.
When you&rsquo;re done compiling, delete the py and c files and you&rsquo;re ready to release. Execution can be done just like a normal Python project, using something like <code>python -m app</code>.
If the first level of <code>app.py</code> is also sensitive, you can put it in a lower level package and just write <code>import xxx.app</code> in <code>app.py</code>.</p>
<p>These processes are cumbersome to handle manually, and can be automated with GitLab CI to build them in a few lines of code. But as the project grew, a new problem emerged: the builds were taking longer and longer, even up to half an hour.</p>
<p>So I looked into Cython&rsquo;s build cache, and found that it checks to see if the py file it needs to build has already generated a corresponding so file; if it has and the file is later than the py file, it skips compiling the py file. When I compiled with docker, I only ``COPYed&rsquo;&rsquo; the source code, but not the so file, so naturally I had to recompile it.
But if I <code>COPY</code> the so file directly, it will be modified later than the py file, and even if I change the code, it won&rsquo;t be recompiled, which obviously doesn&rsquo;t work either.</p>
<p>To solve this paradox, I thought of mounting a volume and saving both the source and so files on the host, so that the modification time of the files would not be lost.
Before compiling, I also need to do some synchronization work, i.e., compare the new source folder that needs to be compiled with the last compiled folder in the volume, delete the py, c and so files that no longer exist, and copy the new or modified py files. This way the new py files will be modified later than so and will be recompiled, while the other py files will be skipped.
This solution looks perfect, but <code>docker build</code> doesn&rsquo;t support mounting volume, which is a real bummer.</p>
<p>I had no choice but to use <code>docker run</code> to mount the volume, compile it, copy the required files from the volume (i.e. the py files in the first layer and the so files in subsequent layers) to the image, and then use <code>docker commit</code> to save the new image. Note: If you&rsquo;re building locally with docker, you can use <code>COPY</code> or <code>ADD</code> in <code>Dockerfile</code>; however, GitLab CI uses docker in docker, so you can&rsquo;t access the path in the host directly.</p>
<p>To do this, you need to write two <code>Dockerfiles</code>, one for compiling and one for packaging.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">docker build -f Dockerfile_compile -t xxx-compile .</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">docker rm xxx_compile || true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">docker run --name xxx_compile -v $CACHE_DIR:/root/xxx xxx-compile python /root/setup.py build_ext --inplace -j 4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">docker commit xxx_compile xxx-compile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">docker rm xxx_compile || true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">docker build -f Dockerfile_package -t $IMAGE_NAME .</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>What <code>Dockerfile_package</code> does is copy <code>/usr/local/lib</code> and the compiled files from <code>xxx-compile</code> to a new image, which reduces the size of the image and avoids saving intermediate layers.
I tested it and found that the compile time was reduced from half an hour to half a minute, done!</p>
<p>Here I came up with a new solution, I don&rsquo;t actually need to save the py and so modification time, just make sure that the py file I don&rsquo;t want to compile has a later so file.
So I built it directly from the original plan and saved it as an intermediate image. In the second build step, we <code>COPY</code> the files in the intermediate image to another folder, then do a sync and <code>cp</code> the so files that don&rsquo;t need to be compiled to the corresponding path. Wait for the compilation to complete, and then save it as an intermediate image as well. In the third build step, you can <code>copy</code> the files from the intermediate image to the new image.
This solution does not need to expose the host folder, nor does it need to use <code>docker commit</code>, a statement that people with code cleanliness do not want to use, perfect!</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/web-service-process/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python web service process management</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/advanced-argparse/">
            <span class="next-text nav-default">Advanced use of argparse in Python</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
