<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Getting started with Dagger - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the new product from Docker&#39;s founder - Dagger." /><meta name="keywords" content="dagger, DevOps" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/dagger/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Getting started with Dagger" />
<meta property="og:description" content="Explore the new product from Docker&#39;s founder - Dagger." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/dagger/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-06T12:22:30+08:00" />
<meta property="article:modified_time" content="2022-04-06T12:22:30+08:00" />

<meta itemprop="name" content="Getting started with Dagger">
<meta itemprop="description" content="Explore the new product from Docker&#39;s founder - Dagger."><meta itemprop="datePublished" content="2022-04-06T12:22:30+08:00" />
<meta itemprop="dateModified" content="2022-04-06T12:22:30+08:00" />
<meta itemprop="wordCount" content="2285">
<meta itemprop="keywords" content="dagger," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Getting started with Dagger"/>
<meta name="twitter:description" content="Explore the new product from Docker&#39;s founder - Dagger."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Getting started with Dagger</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-06 12:22:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2285 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install">Install</a></li>
        <li><a href="#example">Example</a></li>
        <li><a href="#pipeline-definition">Pipeline Definition</a>
          <ul>
            <li><a href="#client-side-interaction">Client-side interaction</a></li>
            <li><a href="#accessing-the-file-system">Accessing the file system</a></li>
            <li><a href="#get-local-socket">Get Local Socket</a></li>
            <li><a href="#environment-variables">Environment Variables</a></li>
            <li><a href="#execute-commands">Execute commands</a></li>
            <li><a href="#get-platform-information">Get platform information</a></li>
            <li><a href="#building-an-image">Building an image</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, Docker founder Solomon Hykes announced the launch of a new product <a href="https://dagger.io/">Dagger</a>, a new DevOps platform designed to solve some of the problems in the DevOps process for developers. Dagger has raised $20 million in Series A funding led by Redpoint Ventures, with participation from Nat Fireman, former CEO of GitHub, Brian Stevens, former CTO of Red Hat, and Ellan Pao, former CEO of Reddit.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/06/a228b684e5cd49949941333d4cb3c546.png" alt="dagger"></p>
<p>Dagger wants to help DevOps developers write CI/CD pipelines as declarative models in CUE, so that they can describe their own pipelines and interface the various parts of them, all in pure code.</p>
<h2 id="install">Install</h2>
<p>If you are on macOS and have Homebrew installed, you can use the following command to install <code>dagger</code> with one click.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ brew install dagger/tap/dagger
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command will install <code>dagger</code> into the <code>/opt/homebrew/bin</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ <span class="nb">type</span> dagger
</span></span><span class="line"><span class="cl">dagger is /opt/homebrew/bin/dagger
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you do not have Homebrew or another system installed, or if you want to install a specific version of <code>dagger</code>, you can use the following command to do so.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ curl -L https://dl.dagger.io/dagger/install.sh <span class="p">|</span> <span class="nv">DAGGER_VERSION</span><span class="o">=</span>0.2.4 sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">☸ ➜ ./bin/dagger version
</span></span><span class="line"><span class="cl">dagger 0.2.4 <span class="o">(</span>GIT_SHA<span class="o">)</span> darwin/arm64
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since <code>dagger</code> uses Docker to perform tasks, you need to install and run the Docker Engine before you can use it officially.</p>
<h2 id="example">Example</h2>
<p>Now let&rsquo;s use the official <code>todo</code> sample application to demonstrate how to use <code>dagger</code> to run its CI/CD pipeline.</p>
<p>First get the sample application code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ git clone https://github.com/dagger/dagger
</span></span><span class="line"><span class="cl">☸ ➜ <span class="nb">cd</span> dagger
</span></span><span class="line"><span class="cl">☸ ➜ git checkout v0.2.4
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go to the root of the sample application code and execute the <code>dagger do build</code> command to execute the CI/CD pipeline.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ <span class="nb">cd</span> pkg/universe.dagger.io/examples/todoapp
</span></span><span class="line"><span class="cl">☸ ➜ dagger <span class="k">do</span> build
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first time the task is executed, the test build for the sample application takes a while to complete because there is no cache and all dependencies need to be installed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> client.filesystem.<span class="s2">&#34;./&#34;</span>.read                                                                   0.4s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.deps                                                                                170.8s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.test.script                                                                           0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.run.script                                                                      0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.test                                                                                  4.4s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.run                                                                            49.6s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.contents                                                                        0.1s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> client.filesystem.<span class="s2">&#34;./_build&#34;</span>.write                                                            0.4s
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above result shows the execution of our build command above, which takes place in a local container named <code>dagger-buildkitd</code> throughout the execution process.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/06/69951eb12bc04e47884a4d603b8b172b.png" alt="dagger-buildkitd"></p>
<p>This proves that <code>dagger</code> is going to execute the task in Docker&rsquo;s execution engine <code>BuildKit</code>.</p>
<p>Since this is a static application, we can open the final generated file in the browser, here we are defining the final copy of the build result to the <code>_build</code> directory on the host. We can execute the <code>open _build/index.html</code> command to preview the application.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/06/b6b1db45a6ca4ab5ae47cab903c31650.png" alt="open _build/index.html"></p>
<p>Now we don&rsquo;t need to install any application-specific dependencies, <code>dagger</code> manages all these intermediate steps, and with <code>dagger</code> we don&rsquo;t need to commit and push the code every time to see the results of the application, and each executed action is cached so that subsequent runs are very fast.</p>
<p>For example, in the <code>todoapp</code> directory, edit line 25 of <code>src/components/Form.js</code>, change the line to <code>What must be done today?</code> and save the file, then run the build command locally again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">dagger <span class="k">do</span> build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> client.filesystem.<span class="s2">&#34;./&#34;</span>.read                                                                   0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.deps                                                                                  1.8s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.test.script                                                                           0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.run.script                                                                      0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.test                                                                                  0.0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.run                                                                             0.0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.contents                                                                        0.0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> client.filesystem.<span class="s2">&#34;./_build&#34;</span>.write                                                            0.5s
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that the execution time of the entire pipeline has been drastically reduced and the results are output correctly.</p>
<h2 id="pipeline-definition">Pipeline Definition</h2>
<p><code>dagger</code> uses the CUE language to define the pipeline, so we have to understand the language first, as we described in the previous article about the basic use of the CUE language.</p>
<p>The pipeline definition for our sample application here is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">todoapp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;dagger.io/dagger&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;dagger.io/dagger/core&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;universe.dagger.io/alpine&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;universe.dagger.io/bash&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;universe.dagger.io/docker&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;universe.dagger.io/netlify&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">Plan</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">_nodeModulesMount</span><span class="p">:</span> <span class="s">&#34;/src/node_modules&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dest</span><span class="p">:</span>     <span class="s">&#34;/src/node_modules&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">type</span><span class="p">:</span>     <span class="s">&#34;cache&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">contents</span><span class="p">:</span> <span class="nx">core</span><span class="p">.</span><span class="err">#</span><span class="nx">CacheDir</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">id</span><span class="p">:</span> <span class="s">&#34;todoapp-modules-cache&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">client</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">filesystem</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;./&#34;</span><span class="p">:</span> <span class="nx">read</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">contents</span><span class="p">:</span> <span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">FS</span>
</span></span><span class="line"><span class="cl">    <span class="nx">exclude</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;README.md&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;_build&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;todoapp.cue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="s">&#34;node_modules&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="s">&#34;./_build&#34;</span><span class="p">:</span> <span class="nx">write</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="nx">actions</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">output</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">env</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">APP_NAME</span><span class="p">:</span>      <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">NETLIFY_TEAM</span><span class="p">:</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">NETLIFY_TOKEN</span><span class="p">:</span> <span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">Secret</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">actions</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">deps</span><span class="p">:</span> <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Build</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">steps</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alpine</span><span class="p">.</span><span class="err">#</span><span class="nx">Build</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">packages</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">bash</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">yarn</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">git</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Copy</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">contents</span><span class="p">:</span> <span class="nx">client</span><span class="p">.</span><span class="nx">filesystem</span><span class="p">.</span><span class="s">&#34;./&#34;</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">contents</span>
</span></span><span class="line"><span class="cl">     <span class="nx">dest</span><span class="p">:</span>     <span class="s">&#34;/src&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bash</span><span class="p">.</span><span class="err">#</span><span class="nx">Run</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">workdir</span><span class="p">:</span> <span class="s">&#34;/src&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="nx">mounts</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s">&#34;/cache/yarn&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="nx">dest</span><span class="p">:</span>     <span class="s">&#34;/cache/yarn&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="kd">type</span><span class="p">:</span>     <span class="s">&#34;cache&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="nx">contents</span><span class="p">:</span> <span class="nx">core</span><span class="p">.</span><span class="err">#</span><span class="nx">CacheDir</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span><span class="p">:</span> <span class="s">&#34;todoapp-yarn-cache&#34;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_nodeModulesMount</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">script</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="err">#</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      yarn config set cache-folder /cache/yarn
</span></span></span><span class="line"><span class="cl"><span class="s">      yarn install
</span></span></span><span class="line"><span class="cl"><span class="s">      &#34;&#34;&#34;</span><span class="err">#</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">test</span><span class="p">:</span> <span class="nx">bash</span><span class="p">.</span><span class="err">#</span><span class="nx">Run</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">input</span><span class="p">:</span>   <span class="nx">deps</span><span class="p">.</span><span class="nx">output</span>
</span></span><span class="line"><span class="cl">   <span class="nx">workdir</span><span class="p">:</span> <span class="s">&#34;/src&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="nx">mounts</span><span class="p">:</span>  <span class="nx">_nodeModulesMount</span>
</span></span><span class="line"><span class="cl">   <span class="nx">script</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="err">#</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    yarn run test
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;&#34;&#34;</span><span class="err">#</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">build</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">run</span><span class="p">:</span> <span class="nx">bash</span><span class="p">.</span><span class="err">#</span><span class="nx">Run</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">input</span><span class="p">:</span>   <span class="nx">test</span><span class="p">.</span><span class="nx">output</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mounts</span><span class="p">:</span>  <span class="nx">_nodeModulesMount</span>
</span></span><span class="line"><span class="cl">    <span class="nx">workdir</span><span class="p">:</span> <span class="s">&#34;/src&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">script</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="err">#</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">     yarn run build
</span></span></span><span class="line"><span class="cl"><span class="s">     &#34;&#34;&#34;</span><span class="err">#</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">contents</span><span class="p">:</span> <span class="nx">core</span><span class="p">.</span><span class="err">#</span><span class="nx">Subdir</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">input</span><span class="p">:</span> <span class="nx">run</span><span class="p">.</span><span class="nx">output</span><span class="p">.</span><span class="nx">rootfs</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span><span class="p">:</span>  <span class="s">&#34;/src/build&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">deploy</span><span class="p">:</span> <span class="nx">netlify</span><span class="p">.</span><span class="err">#</span><span class="nx">Deploy</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">contents</span><span class="p">:</span> <span class="nx">build</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">output</span>
</span></span><span class="line"><span class="cl">   <span class="nx">site</span><span class="p">:</span>     <span class="nx">client</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_NAME</span>
</span></span><span class="line"><span class="cl">   <span class="nx">token</span><span class="p">:</span>    <span class="nx">client</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NETLIFY_TOKEN</span>
</span></span><span class="line"><span class="cl">   <span class="nx">team</span><span class="p">:</span>     <span class="nx">client</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NETLIFY_TEAM</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The CUE file above shows that the <code>dagger</code> pipeline starts with a <code>#Plan</code> in which we can.</p>
<ul>
<li>interact with the <code>client</code> client file system.
<ul>
<li>read files, usually using <code>.</code> for the current directory.</li>
<li>write to files, usually build output as <code>_build</code> directory.</li>
</ul>
</li>
<li>Read environment variables, such as <code>NETLIFY_TOKEN</code> as defined above.</li>
<li>Declare some actions, such as test, build, deploy, etc. The names of the actions can be arbitrary.</li>
</ul>
<p>The overall architecture of the pipeline we defined above is shown below, where the <code>client</code> section defines client-related interactions and the <code>actions</code> section defines the pipeline actions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">dagger.#Plan &amp; {
</span></span><span class="line"><span class="cl">  client: {
</span></span><span class="line"><span class="cl">    filesystem: {
</span></span><span class="line"><span class="cl">      // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    env: {
</span></span><span class="line"><span class="cl">      // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">  actions: {
</span></span><span class="line"><span class="cl">    deps: docker.#Build &amp; {
</span></span><span class="line"><span class="cl">      // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    test: bash.#Run &amp; {
</span></span><span class="line"><span class="cl">      // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    build: {
</span></span><span class="line"><span class="cl">      run: bash.#Run &amp; {
</span></span><span class="line"><span class="cl">         // ...
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">      contents: core.#Subdir &amp; {
</span></span><span class="line"><span class="cl">        // ...
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    deploy: netlify.#Deploy &amp; {
</span></span><span class="line"><span class="cl">      // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we executed the <code>dagger do build</code> command earlier, the following output was generated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> client.filesystem.<span class="s2">&#34;./&#34;</span>.read                                                                   0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.deps                                                                                  1.8s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.test.script                                                                           0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.run.script                                                                      0.2s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.test                                                                                  0.0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.run                                                                             0.0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> actions.build.contents                                                                        0.0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>✔<span class="o">]</span> client.filesystem.<span class="s2">&#34;./_build&#34;</span>.write                                                            0.5s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since we only execute the <code>build</code> action, no <code>deploy</code> related information appears. We can choose to run a specific action by simply specifying the action name after <code>dagger do &lt;action&gt;</code>, and since the input to the <code>build</code> action is the <code>test.output</code>, we will also execute <code>test</code>. Similarly the input to the <code>test</code> action is the output of <code>deps</code>, so that action will be executed as well.</p>
<p>Each specific action is basically defined using a package that is imported off-the-shelf. For example, the <code>build</code> action defines the flow of execution via <code>bash.#Run</code>, and the code is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">build: {
</span></span><span class="line"><span class="cl">    run: bash.#Run &amp; {
</span></span><span class="line"><span class="cl">        input:   test.output
</span></span><span class="line"><span class="cl">        mounts:  _nodeModulesMount
</span></span><span class="line"><span class="cl">        workdir: &#34;/src&#34;
</span></span><span class="line"><span class="cl">        script: contents: #&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">            yarn run build
</span></span><span class="line"><span class="cl">            &#34;&#34;&#34;#
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    contents: core.#Subdir &amp; {
</span></span><span class="line"><span class="cl">        input: run.output.rootfs
</span></span><span class="line"><span class="cl">        path:  &#34;/src/build&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the output of the <code>test</code> action is used as the input to this project via <code>input: test.output</code>, then the directory to mount is specified via <code>mounts</code>, so that the cached <code>nodemodules</code> directory can be used, <code>workdir</code> specifies the working directory as <code>/src</code>, and then the <code>script</code> specifies the command to execute The overall definition structure is actually defined by <code>base.#Run</code>, which can be found in the package <code>universe.dagger.io/bash</code>.</p>
<p>To improve the developer experience, <code>dagger</code> has released a toolkit library called <code>Dagger Universe</code> to help developers import their own Dagger configurations flexibly, and many of the pipelines above are defined in that toolkit.</p>
<h3 id="client-side-interaction">Client-side interaction</h3>
<p>For details on what properties or operations can be defined in <code>dagger.#Plan</code>, we can look at the code in the imported package <code>dagger.io/dagger</code> at <a href="https://github.com/dagger/dagger/blob/main/pkg/dagger.io/dagger/plan.cue">https://github.com/dagger/dagger/blob/main/pkg/dagger.io/dagger/plan.cue</a>. This file defines all the properties of <code>#Plan</code>, such as client-side interaction via <code>client</code>.</p>
<h3 id="accessing-the-file-system">Accessing the file system</h3>
<p>Access to the filesystem can be defined via <code>client.filesystem</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">dagger.#Plan &amp; {
</span></span><span class="line"><span class="cl">    client: filesystem:  {
</span></span><span class="line"><span class="cl">        &#34;.&#34;: read: {
</span></span><span class="line"><span class="cl">            // 将本地目录加载为 dagger.#FS
</span></span><span class="line"><span class="cl">            contents: dagger.#FS   
</span></span><span class="line"><span class="cl">            exclude: [&#34;node_modules&#34;]
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        &#34;config.yaml&#34;: write: {
</span></span><span class="line"><span class="cl">            // 将 CUE 值转换为 YAML 格式的字符串
</span></span><span class="line"><span class="cl">            contents: yaml.Marshal(actions.pull.output.config)
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    actions: {
</span></span><span class="line"><span class="cl">        copy: docker.#Copy &amp; {
</span></span><span class="line"><span class="cl">            contents: client.filesystem.&#34;.&#34;.read.contents
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="get-local-socket">Get Local Socket</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">dagger.#Plan &amp; {
</span></span><span class="line"><span class="cl">    client: network: &#34;unix:///var/run/docker.sock&#34;: connect: dagger.#Socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    actions: {
</span></span><span class="line"><span class="cl">        image: alpine.#Build &amp; {
</span></span><span class="line"><span class="cl">            packages: &#34;docker-cli&#34;: {}
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        run: docker.#Run &amp; {
</span></span><span class="line"><span class="cl">            input: image.output
</span></span><span class="line"><span class="cl">            mounts: docker: {
</span></span><span class="line"><span class="cl">                dest:     &#34;/var/run/docker.sock&#34;
</span></span><span class="line"><span class="cl">                contents: client.network.&#34;unix:///var/run/docker.sock&#34;.connect
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">            command: {
</span></span><span class="line"><span class="cl">                name: &#34;docker&#34;
</span></span><span class="line"><span class="cl">                args: [&#34;info&#34;]
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="environment-variables">Environment Variables</h3>
<p>Environment variables can be read from the host as strings or Secret, just specify the type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">dagger.#Plan &amp; {
</span></span><span class="line"><span class="cl">    client: env: {
</span></span><span class="line"><span class="cl">        REGISTRY_USER:  string
</span></span><span class="line"><span class="cl">        REGISTRY_TOKEN: dagger.#Secret
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    actions: pull: docker.#Pull &amp; {
</span></span><span class="line"><span class="cl">        source: &#34;registry.example.com/image&#34;
</span></span><span class="line"><span class="cl">        auth: {
</span></span><span class="line"><span class="cl">            username: client.env.REGISTRY_USER
</span></span><span class="line"><span class="cl">            secret:   client.env.REGISTRY_TOKEN
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="execute-commands">Execute commands</h3>
<p>Sometimes you need to execute some local commands, which can also be defined in <code>client</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">dagger.#Plan &amp; {
</span></span><span class="line"><span class="cl">    client: commands: {
</span></span><span class="line"><span class="cl">        os: {
</span></span><span class="line"><span class="cl">            name: &#34;uname&#34;
</span></span><span class="line"><span class="cl">            args: [&#34;-s&#34;]
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        arch: {
</span></span><span class="line"><span class="cl">            name: &#34;uname&#34;
</span></span><span class="line"><span class="cl">            args: [&#34;-m&#34;]
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    actions: build: go.#Build &amp; {
</span></span><span class="line"><span class="cl">        os:   client.commands.os.stdout
</span></span><span class="line"><span class="cl">        arch: client.commands.arch.stdout
</span></span><span class="line"><span class="cl">        // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="get-platform-information">Get platform information</h3>
<p>You can get platform information via <code>client.platform</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">dagger.#Plan &amp; {
</span></span><span class="line"><span class="cl">    client: _
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    actions: build: go.#Build &amp; {
</span></span><span class="line"><span class="cl">        os:   client.platform.os
</span></span><span class="line"><span class="cl">        arch: client.platform.arch
</span></span><span class="line"><span class="cl">        // ...
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="building-an-image">Building an image</h3>
<p>Again, we can use <code>dagger</code> to build the container image. The code is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;dagger.io/dagger&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;universe.dagger.io/docker&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">Plan</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">:</span> <span class="nx">filesystem</span><span class="p">:</span> <span class="s">&#34;./src&#34;</span><span class="p">:</span> <span class="nx">read</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">FS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">actions</span><span class="p">:</span> <span class="nx">build</span><span class="p">:</span> <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Dockerfile</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 构建上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">source</span><span class="p">:</span> <span class="nx">client</span><span class="p">.</span><span class="nx">filesystem</span><span class="p">.</span><span class="s">&#34;./src&#34;</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">contents</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认在 context 中查找 Dockerfile，这里我们直接声明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">dockerfile</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="err">#</span><span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">            FROM python:3.9
</span></span></span><span class="line"><span class="cl"><span class="s">            COPY . /app
</span></span></span><span class="line"><span class="cl"><span class="s">            RUN pip install -r /app/requirements.txt
</span></span></span><span class="line"><span class="cl"><span class="s">            CMD python /app/app.py
</span></span></span><span class="line"><span class="cl"><span class="s">            &#34;&#34;&#34;</span><span class="err">#</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we import the <code>universe.dagger.io/docker</code> package, so a <code>docker.#Dockerfile</code> definition is used in the <code>build</code> action, which first reads the <code>./src</code> directory, then specifying the build context in the <code>build</code> action, and then defining the Dockerfile to use directly via <code>dockerfile.contents</code>, or we can just provide a build context in the <code>./src</code> directory.</p>
<p>In addition to using the Dockerfile directly, we can also build the image directly in CUE, as shown in the code below, which is exactly the same as the result above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;dagger.io/dagger&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;universe.dagger.io/docker&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">Plan</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">:</span> <span class="nx">filesystem</span><span class="p">:</span> <span class="s">&#34;./src&#34;</span><span class="p">:</span> <span class="nx">read</span><span class="p">:</span> <span class="nx">contents</span><span class="p">:</span> <span class="nx">dagger</span><span class="p">.</span><span class="err">#</span><span class="nx">FS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">actions</span><span class="p">:</span> <span class="nx">build</span><span class="p">:</span> <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Build</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">steps</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Pull</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">source</span><span class="p">:</span> <span class="s">&#34;python:3.9&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Copy</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">contents</span><span class="p">:</span> <span class="nx">client</span><span class="p">.</span><span class="nx">filesystem</span><span class="p">.</span><span class="s">&#34;./src&#34;</span><span class="p">.</span><span class="nx">read</span><span class="p">.</span><span class="nx">contents</span>
</span></span><span class="line"><span class="cl">                <span class="nx">dest</span><span class="p">:</span>     <span class="s">&#34;/app&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Run</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">command</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">name</span><span class="p">:</span> <span class="s">&#34;pip&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">args</span><span class="p">:</span> <span class="p">[</span><span class="s">&#34;install&#34;</span><span class="p">,</span> <span class="s">&#34;-r&#34;</span><span class="p">,</span> <span class="s">&#34;/app/requirements.txt&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">docker</span><span class="p">.</span><span class="err">#</span><span class="nx">Set</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">config</span><span class="p">:</span> <span class="nx">cmd</span><span class="p">:</span> <span class="p">[</span><span class="s">&#34;python&#34;</span><span class="p">,</span> <span class="s">&#34;/app/app.py&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we are using the <code>docker.#Build</code> definition for configuration. <code>steps</code> defines the build steps, <code>docker.#Pull</code> specifies the base image, <code>docker.#Copy</code> copies the source file directory, <code>docker.#Run</code> configures the image build command, and <code>docker.#Set</code> specifies the image start command. This is actually equivalent to implementing the Dockerfile declaration through CUE.</p>
<h2 id="summary">Summary</h2>
<p><code>dagger</code> uses the CUE language to configure the pipeline, so this naturally adds a bit of a barrier, but if you get familiar with CUE, you&rsquo;ll find that <code>dagger</code>&rsquo;s pipeline is very easy to configure, basically by looking at the package definitions and knowing how to use it.</p>
<p>The tagline of <code>dagger</code> is a portable development toolkit for CI/CD pipelines, which allows DevOps engineers to quickly build powerful CI/CD pipelines, run them anywhere, unify development and CI environments, and test and debug pipelines locally, which is undoubtedly the biggest benefit of <code>dagger</code> so far, but you&rsquo;d say it&rsquo;s going to be a disruptive product in the DevOps space? We haven&rsquo;t seen any of these disruptions yet, at least not yet, but of course <code>dagger</code> is still in the very early stages, so maybe there will be more and more surprising features to come.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/dagger/">dagger</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/go-http-url/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Constructing HTTP request URLs in the Go language more standardly and securely</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/golang-supply-chain/">
            <span class="next-text nav-default">How does Go respond to supply chain attacks?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
