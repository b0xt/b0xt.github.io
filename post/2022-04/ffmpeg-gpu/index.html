<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Compile and use GPU-accelerated ffmpeg - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to compile and use GPU-accelerated ffmpeg." /><meta name="keywords" content="ffmpeg, Gpu" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/ffmpeg-gpu/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Compile and use GPU-accelerated ffmpeg" />
<meta property="og:description" content="Learn how to compile and use GPU-accelerated ffmpeg." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/ffmpeg-gpu/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-25T20:20:20+08:00" />
<meta property="article:modified_time" content="2022-04-25T20:20:20+08:00" />

<meta itemprop="name" content="Compile and use GPU-accelerated ffmpeg">
<meta itemprop="description" content="Learn how to compile and use GPU-accelerated ffmpeg."><meta itemprop="datePublished" content="2022-04-25T20:20:20+08:00" />
<meta itemprop="dateModified" content="2022-04-25T20:20:20+08:00" />
<meta itemprop="wordCount" content="384">
<meta itemprop="keywords" content="ffmpeg," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compile and use GPU-accelerated ffmpeg"/>
<meta name="twitter:description" content="Learn how to compile and use GPU-accelerated ffmpeg."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Compile and use GPU-accelerated ffmpeg</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-25 20:20:20 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 384 words </span>
          <span class="more-meta"> 1 min read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#system-architecture">System Architecture</a></li>
        <li><a href="#compile">Compile</a>
          <ul>
            <li><a href="#compilation-steps">Compilation steps</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, I am developing a video analysis system based on video streams. When using the browser to play the finished video, the browser needs the fmp4 format stream, which needs to be transcoded by ffmpeg. During the development phase, the CPU version of ffmpeg was used, but the online deployment was very unsatisfactory. So I compiled a GPU version.</p>
<h2 id="system-architecture">System Architecture</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">+----------------------------------------------------------------+
</span></span><span class="line"><span class="cl">|                                                                |
</span></span><span class="line"><span class="cl">|                          /--queue--&gt;ffmpeg--&gt;\                 |
</span></span><span class="line"><span class="cl">| rtsp h.264--open cv ---&gt;                      --&gt;merge--&gt; web  |
</span></span><span class="line"><span class="cl">|                          \--queue--&gt;models--&gt;/                 |
</span></span><span class="line"><span class="cl">|                                                                |
</span></span><span class="line"><span class="cl">+----------------------------------------------------------------+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="compile">Compile</h2>
<p>Compiling hardware-accelerated ffmpeg from source code requires several steps</p>
<ol>
<li>Download the <code>ffmpeg</code> source code <a href="https://git.ffmpeg.org/ffmpeg.git">https://git.ffmpeg.org/ffmpeg.git</a></li>
<li>download the Nvidia driver</li>
<li>install CUDA toolkit</li>
<li>download <code>nv-codec-headers</code> source code <a href="https://github.com/FFmpeg/nv-codec-headers.git">https://github.com/FFmpeg/nv-codec-headers.git</a></li>
<li>install <code>nasm</code> <code>yasm</code> <code>pkgconf</code></li>
</ol>
<h3 id="compilation-steps">Compilation steps</h3>
<p>Since I have the specified version of the Nvidia driver and CUDA toolkit installed locally, I skip these two steps.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">apt install -y nasm yasm pkgconf
</span></span><span class="line"><span class="cl">git clone https://git.ffmpeg.org/ffmpeg.git
</span></span><span class="line"><span class="cl">git clone https://github.com/FFmpeg/nv-codec-headers.git
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 切换到你想要的tag版本，我这里nv-codec-headers使用的n9.0.18.3，ffmpeg使用的n4.2.2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置 nv-codec-headers</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> nv-codec-headers
</span></span><span class="line"><span class="cl">git checkout n9.0.18.3
</span></span><span class="line"><span class="cl">make install
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ..
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 编译ffmpeg</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ffmpeg
</span></span><span class="line"><span class="cl">git checkout n4.2.2
</span></span><span class="line"><span class="cl">./configure --enable-cuda --enable-cuvid --enable-nvenc --enable-nonfree --enable-libnpp --extra-cflags<span class="o">=</span>-I/usr/local/cuda/include  --extra-ldflags<span class="o">=</span>-L/usr/local/cuda/lib64
</span></span><span class="line"><span class="cl">make -j<span class="k">$(</span>nproc<span class="k">)</span>
</span></span><span class="line"><span class="cl">make install
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the above steps, the GPU version of ffmpeg is compiled and tested to see if it works.</p>
<p>The original CPU version of the transcode command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ffmpeg -i input.mp4 -c:a copy -c:v h264 -b:v 5M output.mp4
</span></span></code></pre></td></tr></table>
</div>
</div><p>Modify the transcoding command to the GPU version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ffmpeg -vsync <span class="m">0</span> -hwaccel cuvid -c:v h264_cuvid -i input.mp4 -c:a copy -c:v h264_nvenc -b:v 5M output.mp4
</span></span></code></pre></td></tr></table>
</div>
</div><p>The conversion was tested successfully.</p>
<p>Of course, in the video analysis system, it is not directly transcoded using the command line in this way, but through the input and output pipeline, and the input parameters and output parameters also need to be adjusted accordingly according to the actual encoding format.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ffmpeg/">ffmpeg</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/kubernetes-multi-cluster/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Introduction to the Kubernetes Multi-Cluster Project</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/taskfile/">
            <span class="next-text nav-default">Taskfile - A better build tool than Makefile</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
