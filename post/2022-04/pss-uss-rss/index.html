<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Are PSS/USS and RSS actually the same thing? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore whether PSS/USS and RSS in golang are the same thing." /><meta name="keywords" content="golang, PSS, Uss, Rss" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/pss-uss-rss/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Are PSS/USS and RSS actually the same thing?" />
<meta property="og:description" content="Explore whether PSS/USS and RSS in golang are the same thing." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/pss-uss-rss/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-25T19:51:46+08:00" />
<meta property="article:modified_time" content="2022-04-25T19:51:46+08:00" />

<meta itemprop="name" content="Are PSS/USS and RSS actually the same thing?">
<meta itemprop="description" content="Explore whether PSS/USS and RSS in golang are the same thing."><meta itemprop="datePublished" content="2022-04-25T19:51:46+08:00" />
<meta itemprop="dateModified" content="2022-04-25T19:51:46+08:00" />
<meta itemprop="wordCount" content="1841">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Are PSS/USS and RSS actually the same thing?"/>
<meta name="twitter:description" content="Explore whether PSS/USS and RSS in golang are the same thing."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Are PSS/USS and RSS actually the same thing?</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-25 19:51:46 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1841 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-rsspssuss">What is RSS/PSS/USS</a></li>
        <li><a href="#madv_dontneed-vs-madv_free"><code>MADV_DONTNEED</code> vs <code>MADV_FREE</code></a></li>
        <li><a href="#pssuss-vs-rss">PSS/USS vs RSS</a></li>
        <li><a href="#related-documents-for-further-reading">Related documents for further reading</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Since Go 1.12, people have been having problems with monitoring false positives. The reason for this is that Go changed the memory reclamation policy used by the <code>madvise</code> system call from <code>MADV_DONTNEED</code> to <code>MADV_FREE</code> starting in 1.12. From the available documentation, it appears that RSS, the most commonly used memory monitoring metric, does not reflect the portion of memory in the process that is not reclaimed by the OS. Naturally, there are some suggestions that RSS should be replaced with a more appropriate metric, such as PSS or even USS. This leads to some tricky questions, as PSS and USS are not as common as RSS, and the documentation does not say much about how they actually reflect memory consumption. Are they really more appropriate than RSS?</p>
<h2 id="what-is-rsspssuss">What is RSS/PSS/USS</h2>
<p>In order to make the problem clear, it is always necessary to explain what the problem is. The question always searches out a whole bunch of repeatedly copied explanations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">VSS, USS, PSS, and RSS are four indicators for measuring memory usage:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- VSS: Virtual Set Size, virtual memory footprint, including shared libraries.
</span></span><span class="line"><span class="cl">- RSS: Resident Set Size, actual physical memory usage, including shared libraries.
</span></span><span class="line"><span class="cl">- PSS: Proportion Set Size, the actual physical memory used, shared libraries, etc. are allocated proportionally.
</span></span><span class="line"><span class="cl">- USS: Unique Set Size, the physical memory occupied by the process, does not calculate the memory usage of the shared library.
</span></span><span class="line"><span class="cl">- 
</span></span><span class="line"><span class="cl">Generally we have VSS &gt;= RSS &gt;= PSS &gt;= USS.
</span></span></code></pre></td></tr></table>
</div>
</div><p>From these descriptions, the overall impression is that USS is better than PSS, PSS is better than RSS, and VSS is basically unusable: because VSS reflects the virtual address space requested and not returned by the current process, RSS contains the so-called shared libraries, PSS shares the size of the shared libraries in proportion to the shared processes, and USS does not count the memory of the shared libraries directly.</p>
<p>By this definition, the difference between RSS, PSS, and USS is only in the shared libraries, but for statically linked programs like Go, shared libraries are not that common. A reasonable doubt is that in most cases: RSS == PSS == USS.</p>
<h2 id="madv_dontneed-vs-madv_free"><code>MADV_DONTNEED</code> vs <code>MADV_FREE</code></h2>
<p>For functions like memory consumption that are directly tied to the kernel, a good kernel will naturally log this information somewhere for review. On Linux, for example, RSS is usually placed in <code>/proc/[pid]/status</code>, and when a running application wants to query its own consumption behavior, it can even use <code>/prof/self/status</code> to read its own consumption status directly, like <code>cat</code> itself.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ cat /proc/self/status
</span></span><span class="line"><span class="cl">Name:   cat
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Pid:    3509083
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">VmPeak:    11676 kB
</span></span><span class="line"><span class="cl">VmSize:    11676 kB
</span></span><span class="line"><span class="cl">VmLck:         0 kB
</span></span><span class="line"><span class="cl">VmPin:         0 kB
</span></span><span class="line"><span class="cl">VmHWM:       596 kB
</span></span><span class="line"><span class="cl">VmRSS:       596 kB
</span></span><span class="line"><span class="cl">RssAnon:              68 kB
</span></span><span class="line"><span class="cl">RssFile:             528 kB
</span></span><span class="line"><span class="cl">RssShmem:              0 kB
</span></span></code></pre></td></tr></table>
</div>
</div><p>The meaning of each variable can be found in the man page <code>man proc</code>, for example <code>VmRSS</code> refers to the value of RSS, and VmSize is the value of VSS, and so on. Of course, the contents of <code>/proc/[pid]/status</code> are embellished, so you can get this information directly from the more concise <code>/proc/[pid]/stat</code> statistics file if you&rsquo;re really programmatic. Let&rsquo;s take RSS as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">var</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">.</span><span class="n">Getpagesize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// rss returns the resident set size of the current process, unit in MiB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">func</span> <span class="n">rss</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">,</span> <span class="nl">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">ioutil</span><span class="p">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="s">&#34;/proc/self/stat&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="p">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nl">fs</span> <span class="p">:</span><span class="o">=</span> <span class="n">strings</span><span class="p">.</span><span class="n">Fields</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">rss</span><span class="p">,</span> <span class="nl">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">strconv</span><span class="p">.</span><span class="n">ParseInt</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="p">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">uintptr</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span> <span class="o">*</span> <span class="n">uintptr</span><span class="p">(</span><span class="n">pageSize</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="c1">// MiB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For memory management system calls on Linux, the memory from mmap plus <code>PROT_READ</code> and <code>PROT_WRITE</code> will result in a missing page error. But eventually the OS will actually allocate this memory to the process anyway. The difference between using <code>MADV_DONTNEED</code> with <code>madvise</code> and <code>MADV_FREE</code> can be directly measured by the <code>rss()</code> method above. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;io/ioutil&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;runtime&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;strconv&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;syscall&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">#include &lt;sys/mman.h&gt; // for C.MADV_FREE
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">useDontneed</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;dontneed&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;use MADV_DONTNEED instead of MADV_FREE&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nx">Usage</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;usage: %s [flags] anon-MiB\n&#34;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="nx">flag</span><span class="p">.</span><span class="nf">PrintDefaults</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">NArg</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">flag</span><span class="p">.</span><span class="nf">Usage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">anonMB</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">flag</span><span class="p">.</span><span class="nf">Arg</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">flag</span><span class="p">.</span><span class="nf">Usage</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// anonymous mapping
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Mmap</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">anonMB</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">PROT_READ</span><span class="p">|</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">PROT_WRITE</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">MAP_PRIVATE</span><span class="p">|</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">MAP_ANON</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printStats</span><span class="p">(</span><span class="s">&#34;After anon mmap:&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// page fault by accessing it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">pageSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="mi">42</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printStats</span><span class="p">(</span><span class="s">&#34;After anon fault:&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// use different strategy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">*</span><span class="nx">useDontneed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Madvise</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">MADV_DONTNEED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printStats</span><span class="p">(</span><span class="s">&#34;After MADV_DONTNEED:&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Madvise</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">C</span><span class="p">.</span><span class="nx">MADV_FREE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printStats</span><span class="p">(</span><span class="s">&#34;After MADV_FREE:&#34;</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runtime</span><span class="p">.</span><span class="nf">KeepAlive</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">printStats</span><span class="p">(</span><span class="nx">ident</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">m</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">ident</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">,</span> <span class="nf">rss</span><span class="p">(),</span> <span class="s">&#34; MiB RSS\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Assuming a 10M request, you can see the following result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go run main.go 10
</span></span><span class="line"><span class="cl">After anon mmap: 2 MiB RSS
</span></span><span class="line"><span class="cl">After anon fault: 13 MiB RSS
</span></span><span class="line"><span class="cl">After MADV_FREE: 13 MiB RSS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go run main.go -dontneed 10
</span></span><span class="line"><span class="cl">After anon mmap: 3 MiB RSS
</span></span><span class="line"><span class="cl">After anon fault: 13 MiB RSS
</span></span><span class="line"><span class="cl">After MADV_DONTNEED: 3 MiB RSS
</span></span></code></pre></td></tr></table>
</div>
</div><p>The difference is clear: after <code>MADV_FREE</code> ends, RSS is not reduced, while the <code>MADV_DONTNEED</code> policy is returned in full.</p>
<h2 id="pssuss-vs-rss">PSS/USS vs RSS</h2>
<p>So how do we get the PSS/USS values? More detailed memory mapping information is actually further documented in <code>/proc/[pid]/smaps</code>, but it&rsquo;s a bit tricky to compute because it&rsquo;s documented by different mmap operations. But this does not prevent us from automating this fetching process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">mmapStat</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Size</span>           <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RSS</span>            <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PSS</span>            <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PrivateClean</span>   <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PrivateDirty</span>   <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PrivateHugetlb</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getMmaps</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="p">[]</span><span class="nx">mmapStat</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ret</span> <span class="p">[]</span><span class="nx">mmapStat</span>
</span></span><span class="line"><span class="cl">    <span class="nx">contents</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="s">&#34;/proc/self/smaps&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lines</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">contents</span><span class="p">),</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// function of parsing a block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">getBlock</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">block</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">mmapStat</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">m</span> <span class="o">:=</span> <span class="nx">mmapStat</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">line</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;VmFlags&#34;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;Name&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">field</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">field</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">v</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Trim</span><span class="p">(</span><span class="nx">field</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34; kB&#34;</span><span class="p">)</span> <span class="c1">// remove last &#34;kB&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseUint</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="nx">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;Size&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nx">Size</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;Rss&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nx">RSS</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;Pss&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nx">PSS</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;Private_Clean&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nx">PrivateClean</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;Private_Dirty&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nx">PrivateDirty</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s">&#34;Private_Hugetlb&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">m</span><span class="p">.</span><span class="nx">PrivateHugetlb</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">m</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">blocks</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">line</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lines</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#34;:&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">blocks</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">g</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getBlock</span><span class="p">(</span><span class="nx">blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">ret</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">blocks</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">blocks</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">blocks</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ret</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">smapsStat</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">VSS</span> <span class="kt">uint64</span> <span class="c1">// bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">RSS</span> <span class="kt">uint64</span> <span class="c1">// bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">PSS</span> <span class="kt">uint64</span> <span class="c1">// bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">USS</span> <span class="kt">uint64</span> <span class="c1">// bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getSmaps</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">smapsStat</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mmaps</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getMmaps</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">smaps</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">smapsStat</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">mmap</span> <span class="o">:=</span> <span class="k">range</span> <span class="o">*</span><span class="nx">mmaps</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">smaps</span><span class="p">.</span><span class="nx">VSS</span> <span class="o">+=</span> <span class="nx">mmap</span><span class="p">.</span><span class="nx">Size</span> <span class="o">*</span> <span class="mi">1014</span>
</span></span><span class="line"><span class="cl">        <span class="nx">smaps</span><span class="p">.</span><span class="nx">RSS</span> <span class="o">+=</span> <span class="nx">mmap</span><span class="p">.</span><span class="nx">RSS</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">        <span class="nx">smaps</span><span class="p">.</span><span class="nx">PSS</span> <span class="o">+=</span> <span class="nx">mmap</span><span class="p">.</span><span class="nx">PSS</span> <span class="o">*</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">        <span class="nx">smaps</span><span class="p">.</span><span class="nx">USS</span> <span class="o">+=</span> <span class="nx">mmap</span><span class="p">.</span><span class="nx">PrivateDirty</span><span class="o">*</span><span class="mi">1024</span> <span class="o">+</span> <span class="nx">mmap</span><span class="p">.</span><span class="nx">PrivateClean</span><span class="o">*</span><span class="mi">1024</span> <span class="o">+</span> <span class="nx">mmap</span><span class="p">.</span><span class="nx">PrivateHugetlb</span><span class="o">*</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">smaps</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This can eventually be used as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">stat</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getSmaps</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;VSS: %d MiB, RSS: %d MiB, PSS: %d MiB, USS: %d MiB\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stat</span><span class="p">.</span><span class="nx">VSS</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">),</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">RSS</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">),</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">PSS</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">),</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">USS</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Well, applying it to the previous program, the performance is as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go run main.go 10 # MADV_FREE
</span></span><span class="line"><span class="cl">After anon mmap: 2 MiB RSS
</span></span><span class="line"><span class="cl">After anon fault: 13 MiB RSS
</span></span><span class="line"><span class="cl">After MADV_FREE: 13 MiB RSS
</span></span><span class="line"><span class="cl">VSS: 1048 MiB, RSS: 13 MiB, PSS: 12 MiB, USS: 12 MiB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go run main.go -dontneed 10
</span></span><span class="line"><span class="cl">After anon mmap: 2 MiB RSS
</span></span><span class="line"><span class="cl">After anon fault: 13 MiB RSS
</span></span><span class="line"><span class="cl">After MADV_DONTNEED: 3 MiB RSS
</span></span><span class="line"><span class="cl">After anon mmap: 2 MiB RSS
</span></span><span class="line"><span class="cl">After anon fault: 13 MiB RSS
</span></span><span class="line"><span class="cl">After MADV_DONTNEED: 3 MiB RSS
</span></span><span class="line"><span class="cl">VSS: 1049 MiB, RSS: 3 MiB, PSS: 2 MiB, USS: 2 MiB
</span></span></code></pre></td></tr></table>
</div>
</div><p>Yes, there is no difference. Oh then what to monitor? Three means.</p>
<ol>
<li><code>GODEBUG=madvdontneed=1</code>, for distributions between 1.12 and 1.16</li>
<li><a href="https://golang.org/pkg/runtime/#MemStats"><code>runtime.ReadMemStats</code></a> to read the reports periodically. Or use <a href="https://golang.org/pkg/expvar/">expvar</a>, or the standard <a href="https://golang.org/pkg/net/http/pprof/">pprof</a> hand, except that each is a significant performance penalty for the runtime, since these queries are requires STW.</li>
<li>upgrade to Go 1.16</li>
</ol>
<p>Of course, there is a fourth way to do this: no monitoring.</p>
<h2 id="related-documents-for-further-reading">Related documents for further reading</h2>
<ul>
<li><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">https://man7.org/linux/man-pages/man2/mmap.2.html</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/madvise.2.html">https://man7.org/linux/man-pages/man2/madvise.2.html</a></li>
<li><a href="https://man7.org/linux/man-pages/man2/mincore.2.html">https://man7.org/linux/man-pages/man2/mincore.2.html</a></li>
<li><a href="https://man7.org/linux/man-pages/man5/procfs.5.html">https://man7.org/linux/man-pages/man5/procfs.5.html</a></li>
<li><a href="https://unix.stackexchange.com/questions/33381/getting-information-about-a-process-memory-usage-from-proc-pid-smaps">https://unix.stackexchange.com/questions/33381/getting-information-about-a-process-memory-usage-from-proc-pid-smaps</a></li>
<li><a href="https://golang.org/pkg/expvar/">https://golang.org/pkg/expvar/</a></li>
<li><a href="https://golang.org/pkg/runtime/#MemStats">https://golang.org/pkg/runtime/#MemStats</a></li>
<li><a href="https://golang.org/pkg/net/http/pprof/">https://golang.org/pkg/net/http/pprof/</a></li>
</ul>
<p>If you know Linux system calls well, you might also think of using the mincore system call to check the page out status, which is one way to do it but not for Go, because the user code does not know the address consumed by the process, much less the page. Even if we could, it would be very expensive. Nonetheless, it is possible to check the whole thing, but only if you query the memory that you requested via mmap.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">#include &lt;stdlib.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">#include &lt;unistd.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">#include &lt;sys/mman.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">#include &lt;stdint.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">static int inCore(void *base, uint64_t length, uint64_t pages) {
</span></span></span><span class="line"><span class="cl"><span class="cm">    int count = 0;
</span></span></span><span class="line"><span class="cl"><span class="cm">    unsigned char *vec = malloc(pages);
</span></span></span><span class="line"><span class="cl"><span class="cm">    if (vec == NULL)
</span></span></span><span class="line"><span class="cl"><span class="cm">        return -1;
</span></span></span><span class="line"><span class="cl"><span class="cm">    if (mincore(base, length, vec) &lt; 0)
</span></span></span><span class="line"><span class="cl"><span class="cm">        return -1;
</span></span></span><span class="line"><span class="cl"><span class="cm">    for (int i = 0; i &lt; pages; i++)
</span></span></span><span class="line"><span class="cl"><span class="cm">        if (vec[i] != 0)
</span></span></span><span class="line"><span class="cl"><span class="cm">            count++;
</span></span></span><span class="line"><span class="cl"><span class="cm">    free(vec);
</span></span></span><span class="line"><span class="cl"><span class="cm">    return count;
</span></span></span><span class="line"><span class="cl"><span class="cm">}
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">inCore</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">inCore</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">C</span><span class="p">.</span><span class="nf">uint64_t</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)),</span> <span class="nx">C</span><span class="p">.</span><span class="nf">uint64_t</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="o">/</span><span class="nx">pageSize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">*</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">pageSize</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="c1">// MiB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/taskfile/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Taskfile - A better build tool than Makefile</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/upside-down-cake/">
            <span class="next-text nav-default">Android 14 development code name leaked! &#34;Upside Down Cake&#34;</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
