<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Develop eBPF programs using Go language - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to develop eBPF programs using Golang." /><meta name="keywords" content="golang, eBPF" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/go-ebfp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Develop eBPF programs using Go language" />
<meta property="og:description" content="Learn how to develop eBPF programs using Golang." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/go-ebfp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-13T21:30:58+08:00" />
<meta property="article:modified_time" content="2022-04-13T21:30:58+08:00" />

<meta itemprop="name" content="Develop eBPF programs using Go language">
<meta itemprop="description" content="Learn how to develop eBPF programs using Golang."><meta itemprop="datePublished" content="2022-04-13T21:30:58+08:00" />
<meta itemprop="dateModified" content="2022-04-13T21:30:58+08:00" />
<meta itemprop="wordCount" content="3012">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Develop eBPF programs using Go language"/>
<meta name="twitter:description" content="Learn how to develop eBPF programs using Golang."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Develop eBPF programs using Go language</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-13 21:30:58 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3012 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#selecting-ebpf-libraries">Selecting eBPF Libraries</a></li>
        <li><a href="#environment-preparation">Environment preparation</a></li>
        <li><a href="#programming-specifications">Programming Specifications</a>
          <ul>
            <li><a href="#bpf-code">BPF code</a></li>
            <li><a href="#code-compilation">Code compilation</a></li>
            <li><a href="#loading-code">Loading code</a></li>
            <li><a href="#kprobe-processing">Kprobe processing</a></li>
            <li><a href="#view-map-information">View Map information</a></li>
            <li><a href="#container-image">Container image</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>In the previous article, I described the process of developing and loading eBPF code based on kernel source code. This article will cover developing eBPF programs based on Go and the corresponding libraries, all of which can be found on my <a href="https://github.com/SimpCosm/godemo/tree/master/ebpf">Github</a>.</p>
<h2 id="selecting-ebpf-libraries">Selecting eBPF Libraries</h2>
<p>It can be confusing when it comes to choosing libraries and tools to interact with eBPF. When choosing, you have to choose between the Python-based <a href="https://github.com/iovisor/bcc">BCC</a> framework, the C-based <a href="https://github.com/libbpf/libbpf">libbpf</a>, and a series of Go-based <a href="https://github.com/dropbox/goebpf">Dropbox</a>, <a href="https://github.com/cilium/ebpf">Cilium</a>, <a href="https://github.com/aquasecurity/tracee/tree/main/libbpfgo">Aqua</a>, and <a href="https://github.com/projectcalico/felix/tree/master/bpf">Calico</a> to choose from.</p>
<p>In most cases, the eBPF libraries assist with two main functions.</p>
<ul>
<li><strong>Load the eBPF program and Map</strong> into the kernel and perform <a href="https://kinvolk.io/blog/2018/10/exploring-bpf-elf-loaders-at-the-bpf-hackfest/#common-steps">relocation</a> through its file descriptors associating the eBPF program with the correct Map.</li>
<li><strong>Interacts with the eBPF Map</strong> to allow standard CRUD operations on key/value pairs stored in the Map.</li>
</ul>
<p>Some of the libraries can also help you to attach an eBPF program to a specific <a href="https://ebpf.io/what-is-ebpf/#hook-overview">hook</a>, although for network scenarios this may easily be done using the existing netlink API libraries.</p>
<p>It is still confusing when it comes to the choice of eBPF libraries (see <a href="https://twitter.com/maurovasquezb/status/1146438190062063616">[1]</a>, <a href="https://twitter.com/qeole/status/1364521385138282497">[2]</a>). The truth is that each library has its own scope and limitations.</p>
<ul>
<li><a href="https://pkg.go.dev/github.com/projectcalico/felix@v3.8.9+incompatible/bpf">Calico</a> in use with <a href="https://twitter.com/qeole/status/1101450782841466880">bpftool</a> and iproute2 implements a Go wrapper around the CLI commands.</li>
<li><a href="https://github.com/aquasecurity/tracee/tree/main/tracee-ebpf">Aqua</a> implements a Go wrapper for the libbpf C library.</li>
<li><a href="https://github.com/dropbox/goebpf">Dropbox</a> supports a small number of programs, but has a very clean and user-friendly API.</li>
<li>IO Visor&rsquo;s <a href="https://github.com/iovisor/gobpf">gobpf</a> is the Go language binding for the BCC framework, which is more focused on tracing and performance analysis.</li>
<li><a href="https://github.com/cilium/ebpf">Cilium and Cloudflare</a> maintains a <a href="https://linuxplumbersconf.org/event/4/contributions/449/">library written in pure Go</a> attachments/239/529/A_pure_Go_eBPF_library.pdf) (hereafter &ldquo;libbpf-go&rdquo;) which abstracts all eBPF system calls behind a native Go interface.</li>
</ul>
<p>As you can see <code>cilium/ebpf</code> is more active, and this article is based on the <code>cilium/ebpf</code> library. <code>cilium/ebpf</code> is written purely in Go, thus achieving minimal dependencies; at the same time it provides the <code>bpf2go</code> tool, which can be used to compile eBPF programs as part of the Go language, making delivery easier and subsequently more powerful when combined with CO-RE functionality.</p>
<h2 id="environment-preparation">Environment preparation</h2>
<p>The eBPF program generally consists of two parts.</p>
<ol>
<li>a C-based eBPF program, eventually compiled into an <code>elf</code> format file using <code>clang/llvm</code>, for the programs to be loaded in the kernel.</li>
<li>Go language programs for loading and debugging eBPF programs, which are user-space programs for configuring or reading data generated by eBPF programs.</li>
</ol>
<p>Prerequisites require the <code>clang/llvm</code> compiler to be installed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 安装 llvm 编译器，至少要求 clang 9.0 版本以上</span>
</span></span><span class="line"><span class="cl">$ sudo apt update -y
</span></span><span class="line"><span class="cl">$ sudo apt install -y llvm
</span></span><span class="line"><span class="cl">$ sudo apt install -y clang
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can download the code from my Github. The directory structure is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@VM-4-27-centos demo]# tree
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">|-- bpf
</span></span><span class="line"><span class="cl">|   |-- headers
</span></span><span class="line"><span class="cl">|   |   |-- bpf_core_read.h
</span></span><span class="line"><span class="cl">|   |   |-- bpf_helper_defs.h
</span></span><span class="line"><span class="cl">|   |   |-- bpf_helpers.h
</span></span><span class="line"><span class="cl">|   |   |-- bpf_tracing.h
</span></span><span class="line"><span class="cl">|   |   |-- update.sh
</span></span><span class="line"><span class="cl">|   |   `-- vmlinux.h
</span></span><span class="line"><span class="cl">|   `-- kprobe.c
</span></span><span class="line"><span class="cl">|-- Dockerfile
</span></span><span class="line"><span class="cl">|-- go.mod
</span></span><span class="line"><span class="cl">|-- go.sum
</span></span><span class="line"><span class="cl">|-- main.go
</span></span><span class="line"><span class="cl">`-- Makefile
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="programming-specifications">Programming Specifications</h2>
<h3 id="bpf-code">BPF code</h3>
<h4 id="take-kprobe-as-an-example">Take kprobe as an example</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// +build ignore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">__license</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;Dual MIT/GPL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">bpf_map_def</span> <span class="nf">SEC</span><span class="p">(</span><span class="s">&#34;maps&#34;</span><span class="p">)</span> <span class="n">kprobe_map</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SEC</span><span class="p">(</span><span class="s">&#34;kprobe/sys_execve&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">kprobe_execve</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">u32</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">u64</span> <span class="n">initval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">valp</span> <span class="o">=</span> <span class="n">bpf_map_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kprobe_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpf_map_update_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kprobe_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">initval</span><span class="p">,</span> <span class="n">BPF_ANY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="n">valp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="headers">headers</h4>
<h5 id="libbpf">libbpf</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/env bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp"># Version of libbpf to fetch headers from
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">LIBBPF_VERSION</span><span class="o">=</span><span class="mf">0.5.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp"># The headers we want
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">prefix</span><span class="o">=</span><span class="n">libbpf</span><span class="o">-</span><span class="s">&#34;$LIBBPF_VERSION&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">headers</span><span class="o">=</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;$prefix&#34;</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bpf_core_read</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;$prefix&#34;</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bpf_helper_defs</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;$prefix&#34;</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bpf_helpers</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;$prefix&#34;</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bpf_tracing</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp"># Fetch libbpf release and extract the desired headers
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">curl</span> <span class="o">-</span><span class="n">sL</span> <span class="s">&#34;https://github.com/libbpf/libbpf/archive/refs/tags/v${LIBBPF_VERSION}.tar.gz&#34;</span> <span class="o">|</span> \
</span></span><span class="line"><span class="cl">    <span class="n">tar</span> <span class="o">-</span><span class="n">xz</span> <span class="o">--</span><span class="n">xform</span><span class="o">=</span><span class="err">&#39;</span><span class="n">s</span><span class="err">#</span><span class="p">.</span><span class="err">*/##&#39;</span> <span class="s">&#34;${headers[@]}&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="vmlinuxh">vmlinux.h</h5>
<p><code>vmlinux.h</code> is a code file generated using the tools. It contains all the type definitions used in the source code of the system running the Linux kernel. When we compile the Linux kernel, we output a file component called <code>vmlinux</code>, which is an <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a> binary file that contains the compiled bootable kernel. The <code>vmlinux</code> file is also usually packaged in major Linux distributions.</p>
<p>One of the functions of the bpftool utility in the kernel is to read the <code>vmlinux</code> file and generate the corresponding <code>vmlinux.h</code> header file. <code>vmlinux.h</code> will contain the definitions of every type used in the running kernel, so it is a relatively large file.</p>
<p>The command to generate the <code>vmlinux.h</code> file is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; vmlinux.h
</span></span></code></pre></td></tr></table>
</div>
</div><p>The inclusion of this <code>vmlinux.h</code> means that our program can use all the data type definitions used in the kernel, so that the BPF program can map to the corresponding type structure by field when reading the relevant memory.</p>
<p>For example, the <a href="https://elixir.bootlin.com/linux/latest/source/include/linux/sched.h#L649">task_struct</a> structure in Linux is used to represent processes, and if a BPF program needs to check the value of the `task_struct structure, then first it needs to know the specific type definition of the structure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/6103f1198004468bb2a6a76ee4580e41.png" alt="task_struct in Linux"></p>
<p>Since the <code>vmlinux.h</code> file is generated by the current running kernel, you may face a crash dilemma if you try to run the compiled eBPF program on another machine running a different kernel version. This is mainly because the definitions of the corresponding data types may change in the Linux source code in different versions.</p>
<p>However, &ldquo;CO:RE&rdquo; (compile once, run everywhere) can be achieved by using the functions provided by the libbpf library. libbpf library defines partial macros (e.g. BPF_CORE_READ) that analyze which fields in the types defined in <code>vmlinux.h</code> that the eBPF program tries to access. which fields are accessed. If the accessed field has moved within the current kernel-defined structure, the macro/helper function will help to find the corresponding field automatically. Therefore, we can compile the eBPF program using the <code>vmlinux.h</code> header file generated in the current kernel and then run it on a different kernel [the kernel that needs to be run also supports the BTF kernel compilation option].</p>
<h3 id="code-compilation">Code compilation</h3>
<h4 id="bpf2go">bpf2go</h4>
<p>This annotation uses the <code>bpf2go</code> program to compile the <code>kprobe.c</code> file into two files <code>bpfdemo_bpfeb.go</code> and <code>bpfdemo_bpfel.go</code>. The programs are for <code>bigendian</code> and <code>littleendian</code> platforms respectively.</p>
<p>where the <code>BPFDemo</code> parameter is the name of the function call in the <code>main.go</code> file, e.g. <code>objs := BPFDemoObjects{}</code> and <code>LoadBPFDemoObjects(&amp;objs, nil);</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: GPL-2.0-only
</span></span></span><span class="line"><span class="cl"><span class="c1">// Copyright (C) 2021 Authors of Nylon */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//go:generate sh -c &#34;echo Generating for amd64&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cc clang BPFDemo ./bpf/kprobe.c -- -DOUTPUT_SKB -D__TARGET_ARCH_x86 -I./bpf/headers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="makefile">Makefile</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">GO :<span class="o">=</span> go
</span></span><span class="line"><span class="cl"><span class="nv">GO_BUILD</span> <span class="o">=</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="k">$(</span>GO<span class="k">)</span> build
</span></span><span class="line"><span class="cl"><span class="nv">GO_GENERATE</span> <span class="o">=</span> <span class="k">$(</span>GO<span class="k">)</span> generate
</span></span><span class="line"><span class="cl">GO_TAGS ?<span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">TARGET</span><span class="o">=</span>BPFDemo
</span></span><span class="line"><span class="cl">BINDIR ?<span class="o">=</span> /usr/local/bin
</span></span><span class="line"><span class="cl"><span class="nv">VERSION</span><span class="o">=</span><span class="k">$(</span>shell git describe --tags --always<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">$(</span>TARGET<span class="k">)</span>:
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>GO_GENERATE<span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>GO_BUILD<span class="k">)</span> <span class="k">$(if</span> <span class="k">$(</span>GO_TAGS<span class="k">)</span>,-tags <span class="k">$(</span>GO_TAGS<span class="k">))</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        -ldflags <span class="s2">&#34;-w -s \
</span></span></span><span class="line"><span class="cl"><span class="s2">        -X &#39;github.com/SimpCosm/godemo/ebpf/BPFDemo.Version=</span><span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span><span class="s2">&#39;&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">clean:
</span></span><span class="line"><span class="cl">    rm -f <span class="k">$(</span>TARGET<span class="k">)</span>
</span></span><span class="line"><span class="cl">    rm -f bpfdemo_bpf*
</span></span><span class="line"><span class="cl">    rm -rf ./release
</span></span></code></pre></td></tr></table>
</div>
</div><p>Executing the compilation, you can see that the corresponding BPF bytecodes <code>bpfdemo_bpfeb.o</code> and <code>bpfdemo_bpfel.o</code> are generated, as well as the corresponding go files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos demo<span class="o">]</span><span class="c1"># make</span>
</span></span><span class="line"><span class="cl">go generate
</span></span><span class="line"><span class="cl">Generating <span class="k">for</span> amd64
</span></span><span class="line"><span class="cl">Compiled /root/demo/bpfdemo_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /root/demo/bpfdemo_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /root/demo/bpfdemo_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /root/demo/bpfdemo_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /root/demo/bpfdemo_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /root/demo/bpfdemo_bpfeb.go
</span></span><span class="line"><span class="cl"><span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> go build  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -ldflags <span class="s2">&#34;-w -s \
</span></span></span><span class="line"><span class="cl"><span class="s2">    -X &#39;github.com/SimpCosm/godemo/ebpf/BPFDemo.Version=&#39;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos demo<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">Dockerfile  bpf               bpfdemo_bpfeb.o   bpfdemo_bpfel.o  go.mod  main.go        main_arm64.go
</span></span><span class="line"><span class="cl">Makefile    bpfdemo_bpfeb.go  bpfdemo_bpfel.go  demo             go.sum  main_amd64.go
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="loading-code">Loading code</h3>
<p>In the Go code we write, we first need to load the compiled eBPF code into the kernel by calling <code>LoadBPFDemoObjects</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Load pre-compiled programs and maps into the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">objs</span> <span class="o">:=</span> <span class="nx">BPFDemoObjects</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">LoadBPFDemoObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">objs</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;loading objects: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">objs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>LoadBPFDemoObjects</code> and <code>BPFDemoObjects</code> are both from the automatically generated code of <code>bpf2go</code>.</p>
<p>Take <code>bpfdemo_bpfeb.go</code> as an example, you can see that many helper functions and structures are generated, among which.</p>
<ul>
<li>BPFDemoObjects includes BPF procedures and BPF Map.</li>
<li>LoadBPFDemoObjects will call <code>LoadBPFDemo</code> to load the compiled BPF code in ELF format into memory, and then call <code>LoadAndAssign</code> to actually call the BPF system call to load the BPF program into the kernel.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// BPFDemoMaps contains all maps after they have been loaded into the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It can be passed to LoadBPFDemoObjects or ebpf.CollectionSpec.LoadAndAssign.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BPFDemoMaps</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">KprobeMap</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">Map</span> <span class="s">`ebpf:&#34;kprobe_map&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BPFDemoPrograms contains all programs after they have been loaded into the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It can be passed to LoadBPFDemoObjects or ebpf.CollectionSpec.LoadAndAssign.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BPFDemoPrograms</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">KprobeExecve</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">Program</span> <span class="s">`ebpf:&#34;kprobe_execve&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BPFDemoObjects contains all objects after they have been loaded into the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It can be passed to LoadBPFDemoObjects or ebpf.CollectionSpec.LoadAndAssign.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">BPFDemoObjects</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">BPFDemoPrograms</span>
</span></span><span class="line"><span class="cl">        <span class="nx">BPFDemoMaps</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// LoadBPFDemoObjects loads BPFDemo and converts it into a struct.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The following types are suitable as obj argument:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//     *BPFDemoObjects
</span></span></span><span class="line"><span class="cl"><span class="c1">//     *BPFDemoPrograms
</span></span></span><span class="line"><span class="cl"><span class="c1">//     *BPFDemoMaps
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See ebpf.CollectionSpec.LoadAndAssign documentation for details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">LoadBPFDemoObjects</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">CollectionOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">LoadBPFDemo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">spec</span><span class="p">.</span><span class="nf">LoadAndAssign</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Actually looking at <code>LoadAndAssign</code> you can see that it loads the BPF Program and BPF Map into the kernel.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// LoadAndAssign loads Maps and Programs into the kernel and assigns them
</span></span></span><span class="line"><span class="cl"><span class="c1">// to a struct.
</span></span></span><span class="line"><span class="cl"><span class="c1">//    struct {
</span></span></span><span class="line"><span class="cl"><span class="c1">//        Foo     *ebpf.Program `ebpf:&#34;xdp_foo&#34;`
</span></span></span><span class="line"><span class="cl"><span class="c1">//        Bar     *ebpf.Map     `ebpf:&#34;bar_map&#34;`
</span></span></span><span class="line"><span class="cl"><span class="c1">//        Ignored int
</span></span></span><span class="line"><span class="cl"><span class="c1">//    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">CollectionSpec</span><span class="p">)</span> <span class="nf">LoadAndAssign</span><span class="p">(</span><span class="nx">to</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">CollectionOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">loader</span> <span class="o">:=</span> <span class="nf">newCollectionLoader</span><span class="p">(</span><span class="nx">cs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">loader</span><span class="p">.</span><span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Support assigning Programs and Maps, lazy-loading the required objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">assignedMaps</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getValue</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">typ</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">((</span><span class="o">*</span><span class="nx">Program</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">loader</span><span class="p">.</span><span class="nf">loadProgram</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">((</span><span class="o">*</span><span class="nx">Map</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="nx">assignedMaps</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">loader</span><span class="p">.</span><span class="nf">loadMap</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unsupported type %s&#34;</span><span class="p">,</span> <span class="nx">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>loadProgram</code> will call <code>newProgramWithOptions</code>, process a lot of other content with BTF and so on, and finally call <code>sys.ProgLoad(attr)</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newProgramWithOptions</span><span class="p">(</span><span class="nx">spec</span> <span class="o">*</span><span class="nx">ProgramSpec</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ProgramOptions</span><span class="p">,</span> <span class="nx">handles</span> <span class="o">*</span><span class="nx">handleCache</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Program</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">ProgLoad</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This calls the BPF system call.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ProgLoad</span><span class="p">(</span><span class="nx">attr</span> <span class="o">*</span><span class="nx">ProgLoadAttr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">FD</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">BPF</span><span class="p">(</span><span class="nx">BPF_PROG_LOAD</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">attr</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="o">*</span><span class="nx">attr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">NewFD</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">fd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Loading a map is similar, with the final call to <code>sys.MapCreate</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">MapCreate</span><span class="p">(</span><span class="nx">attr</span> <span class="o">*</span><span class="nx">MapCreateAttr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">FD</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">BPF</span><span class="p">(</span><span class="nx">BPF_MAP_CREATE</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">attr</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="o">*</span><span class="nx">attr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">NewFD</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">fd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="kprobe-processing">Kprobe processing</h3>
<p>kprobe can stub any kernel function and can be enabled in a production environment in real time, without rebooting the system or restarting the kernel in a special way.
The following three interfaces are now available to access kprobes.</p>
<ul>
<li>kprobe API: such as <code>register_kprobe()</code> etc.</li>
<li>Frace-based, via <code>/sys/kernel/debug/tracing/kprobe_events</code> : By writing strings to this file, you can configure to enable and disable kprobes.</li>
<li><code>perf_event_open()</code> : As used by the perf tool, these functions are now being used by the BPF tracing tool.</li>
</ul>
<p>Corresponding to <code>main.go</code>, we also call <code>link.Kprobe</code> after <code>LoadBPFDemoObjects</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Open a Kprobe at the entry point of the kernel function and attach the
</span></span></span><span class="line"><span class="cl"><span class="c1">// pre-compiled program. Each time the kernel function enters, the program
</span></span></span><span class="line"><span class="cl"><span class="c1">// will increment the execution counter by 1. The read loop below polls this
</span></span></span><span class="line"><span class="cl"><span class="c1">// map value once per second.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">kp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">link</span><span class="p">.</span><span class="nf">Kprobe</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">KprobeExecve</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;opening kprobe: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">kp</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="creates-a-perf-event-of-type-kprobe">creates a perf event of type kprobe</h4>
<ul>
<li>symbol is the traced kernel function</li>
<li>prog is the compiled eBPF program</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Kprobe</span><span class="p">(</span><span class="nx">symbol</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">prog</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">Program</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">KprobeOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Link</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">k</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">kprobe</span><span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">prog</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">lnk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">attachPerfEvent</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">prog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">k</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">lnk</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here a Perf Event of type <code>kprobe</code> is created, and the trace address passed in is <code>symbol</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// kprobe opens a perf event on the given symbol and attaches prog to it.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If ret is true, create a kretprobe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">kprobe</span><span class="p">(</span><span class="nx">symbol</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">prog</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">Program</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">KprobeOptions</span><span class="p">,</span> <span class="nx">ret</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">perfEvent</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">    <span class="nx">args</span> <span class="o">:=</span> <span class="nx">probeArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pid</span><span class="p">:</span>    <span class="nx">perfAllThreads</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">symbol</span><span class="p">:</span> <span class="nf">platformPrefix</span><span class="p">(</span><span class="nx">symbol</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ret</span><span class="p">:</span>    <span class="nx">ret</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Use kprobe PMU if the kernel has it available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">pmuKprobe</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">tp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use tracefs if kprobe PMU is missing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">args</span><span class="p">.</span><span class="nx">symbol</span> <span class="p">=</span> <span class="nf">platformPrefix</span><span class="p">(</span><span class="nx">symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">tracefsKprobe</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">tp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The final call is <code>PerfEventOpen</code> to open a perf event, this system call can be found <a href="https://man7.org/linux/man-pages/man2/perf_event_open.2.html">here</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pmuProbe opens a perf event based on a Performance Monitoring Unit.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Requires at least a 4.17 kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1">// e12f03d7031a &#34;perf/core: Implement the &#39;perf_kprobe&#39; PMU&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">// 33ea4b24277b &#34;perf/core: Implement the &#39;perf_uprobe&#39; PMU&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns ErrNotSupported if the kernel doesn&#39;t support perf_[k,u]probe PMU
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">pmuProbe</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">probeType</span><span class="p">,</span> <span class="nx">args</span> <span class="nx">probeArgs</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">perfEvent</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="nx">typ</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">kprobeType</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Create a pointer to a NUL-terminated string for the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">unsafeStringPtr</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">attr</span> <span class="p">=</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PerfEventAttr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Type</span><span class="p">:</span>   <span class="nb">uint32</span><span class="p">(</span><span class="nx">et</span><span class="p">),</span>          <span class="c1">// PMU event type read from sysfs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">Ext1</span><span class="p">:</span>   <span class="nb">uint64</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">sp</span><span class="p">)),</span> <span class="c1">// Kernel symbol to trace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">Config</span><span class="p">:</span> <span class="nx">config</span><span class="p">,</span>              <span class="c1">// Retprobe flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">uprobeType</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rawFd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">PerfEventOpen</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PERF_FLAG_FD_CLOEXEC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">NewFD</span><span class="p">(</span><span class="nx">rawFd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Kernel has perf_[k,u]probe PMU available, initialize perf event.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">perfEvent</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">typ</span><span class="p">:</span>    <span class="nx">typ</span><span class="p">.</span><span class="nf">PerfEventType</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">ret</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="p">:</span>   <span class="nx">args</span><span class="p">.</span><span class="nx">symbol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pmuID</span><span class="p">:</span>  <span class="nx">et</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cookie</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">cookie</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fd</span><span class="p">:</span>     <span class="nx">fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mount-the-ebpf-program-to-perf-event">Mount the eBPF program to perf event</h4>
<p>Attach the BPF program to the kprobe event via the perf_event ioctl call</p>
<ul>
<li><code>PERF_EVENT_IOC_SET_BPF</code>, which allows attaching BPF programs to the kprobe event, where the third parameter set by ioctl represents the fd of the bpf system call.</li>
<li><code>PERF_EVENT_IOC_ENABLE</code>, which means enable event.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nf">ioctl</span><span class="p">(</span><span class="nx">perf_event_fd</span><span class="p">,</span> <span class="nx">PERF_EVENT_IOC_SET_BPF</span><span class="p">,</span> <span class="nx">bpf_prog_fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">ioctl</span><span class="p">(</span><span class="nx">perf_event_fd</span><span class="p">,</span> <span class="nx">PERF_EVENT_IOC_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>attachPerfEvent</code> attaches the BPF program to the kprobe event via the perf_event ioctl call.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// attach the given eBPF prog to the perf event stored in pe.
</span></span></span><span class="line"><span class="cl"><span class="c1">// pe must contain a valid perf event fd.
</span></span></span><span class="line"><span class="cl"><span class="c1">// prog&#39;s type must match the program type stored in pe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">attachPerfEvent</span><span class="p">(</span><span class="nx">pe</span> <span class="o">*</span><span class="nx">perfEvent</span><span class="p">,</span> <span class="nx">prog</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">Program</span><span class="p">)</span> <span class="p">(</span><span class="nx">Link</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">prog</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;cannot attach a nil program&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">FD</span><span class="p">()</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid program: %w&#34;</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">ErrClosedFd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="nx">pe</span><span class="p">.</span><span class="nx">typ</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">kprobeEvent</span><span class="p">,</span> <span class="nx">kretprobeEvent</span><span class="p">,</span> <span class="nx">uprobeEvent</span><span class="p">,</span> <span class="nx">uretprobeEvent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t</span> <span class="o">:=</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">Type</span><span class="p">();</span> <span class="nx">t</span> <span class="o">!=</span> <span class="nx">ebpf</span><span class="p">.</span><span class="nx">Kprobe</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid program type (expected %s): %s&#34;</span><span class="p">,</span> <span class="nx">ebpf</span><span class="p">.</span><span class="nx">Kprobe</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">tracepointEvent</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t</span> <span class="o">:=</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">Type</span><span class="p">();</span> <span class="nx">t</span> <span class="o">!=</span> <span class="nx">ebpf</span><span class="p">.</span><span class="nx">TracePoint</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid program type (expected %s): %s&#34;</span><span class="p">,</span> <span class="nx">ebpf</span><span class="p">.</span><span class="nx">TracePoint</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unknown perf event type: %d&#34;</span><span class="p">,</span> <span class="nx">pe</span><span class="p">.</span><span class="nx">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">haveBPFLinkPerfEvent</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lnk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">attachPerfEventLink</span><span class="p">(</span><span class="nx">pe</span><span class="p">,</span> <span class="nx">prog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">lnk</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">lnk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">attachPerfEventIoctl</span><span class="p">(</span><span class="nx">pe</span><span class="p">,</span> <span class="nx">prog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">lnk</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Mount the BPF program via ioctl.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">attachPerfEventIoctl</span><span class="p">(</span><span class="nx">pe</span> <span class="o">*</span><span class="nx">perfEvent</span><span class="p">,</span> <span class="nx">prog</span> <span class="o">*</span><span class="nx">ebpf</span><span class="p">.</span><span class="nx">Program</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">perfEventIoctl</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">pe</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cookies are not supported: %w&#34;</span><span class="p">,</span> <span class="nx">ErrNotSupported</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Assign the eBPF program to the perf event.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">IoctlSetInt</span><span class="p">(</span><span class="nx">pe</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nf">Int</span><span class="p">(),</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PERF_EVENT_IOC_SET_BPF</span><span class="p">,</span> <span class="nx">prog</span><span class="p">.</span><span class="nf">FD</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;setting perf event bpf program: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// PERF_EVENT_IOC_ENABLE and _DISABLE ignore their given values.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">IoctlSetInt</span><span class="p">(</span><span class="nx">pe</span><span class="p">.</span><span class="nx">fd</span><span class="p">.</span><span class="nf">Int</span><span class="p">(),</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PERF_EVENT_IOC_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;enable perf event: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">pi</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">perfEventIoctl</span><span class="p">{</span><span class="nx">pe</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Close the perf event when its reference is lost to avoid leaking system resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">runtime</span><span class="p">.</span><span class="nf">SetFinalizer</span><span class="p">(</span><span class="nx">pi</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">perfEventIoctl</span><span class="p">).</span><span class="nx">Close</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">pi</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="view-map-information">View Map information</h3>
<p>Periodically check the eBPF map for updates.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Read loop reporting the total amount of times the kernel
</span></span></span><span class="line"><span class="cl"><span class="c1">// function was entered, once per second.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Waiting for events..&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="k">range</span> <span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">value</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">KprobeMap</span><span class="p">.</span><span class="nf">Lookup</span><span class="p">(</span><span class="nx">mapKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">value</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;reading map: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s called %d times\n&#34;</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="container-image">Container image</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> ubuntu:20.04</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt update -y -q<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get install --no-install-recommends -y -q curl build-essential ca-certificates<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> curl -s https://storage.googleapis.com/golang/go1.16.3.linux-amd64.tar.gz<span class="p">|</span> tar -v -C /usr/local -xz<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> PATH <span class="nv">$PATH</span>:/usr/local/go/bin<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt install -y wget gnupg2<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nb">printf</span> <span class="s2">&#34;deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-12 main&#34;</span> <span class="p">|</span> tee /etc/apt/sources.list.d/llvm-toolchain-xenial-12.list<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key <span class="p">|</span> apt-key add -<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt -y update<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt install -y llvm clang git<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /ebpf</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> make<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> chmod a+x /ebpf<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;./ebpf&#34;</span><span class="p">]</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;./ebpf&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/gobgp/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">GoBGP Principles and Practices</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/ebpf/">
            <span class="next-text nav-default">Introduction and practice of eBPF</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
