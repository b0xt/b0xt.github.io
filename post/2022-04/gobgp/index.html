<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>GoBGP Principles and Practices - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article, we will introduce the main features of gobgp and put them into practice." /><meta name="keywords" content="golang, Gobgp" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/gobgp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="GoBGP Principles and Practices" />
<meta property="og:description" content="In this article, we will introduce the main features of gobgp and put them into practice." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/gobgp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-13T21:52:50+08:00" />
<meta property="article:modified_time" content="2022-04-13T21:52:50+08:00" />

<meta itemprop="name" content="GoBGP Principles and Practices">
<meta itemprop="description" content="In this article, we will introduce the main features of gobgp and put them into practice."><meta itemprop="datePublished" content="2022-04-13T21:52:50+08:00" />
<meta itemprop="dateModified" content="2022-04-13T21:52:50+08:00" />
<meta itemprop="wordCount" content="2793">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GoBGP Principles and Practices"/>
<meta name="twitter:description" content="In this article, we will introduce the main features of gobgp and put them into practice."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">GoBGP Principles and Practices</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-13 21:52:50 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2793 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a>
          <ul>
            <li><a href="#installation-and-composition">Installation and Composition</a></li>
            <li><a href="#support-features">Support Features</a></li>
            <li><a href="#performance-test">Performance Test</a></li>
            <li><a href="#integration-with-quaggazebra-etc">Integration with Quagga/Zebra, etc</a></li>
          </ul>
        </li>
        <li><a href="#using-gobgp">Using GoBGP</a>
          <ul>
            <li><a href="#basic-operation">Basic operation</a></li>
            <li><a href="#route-reflector">Route Reflector</a></li>
            <li><a href="#route-server">Route Server</a></li>
            <li><a href="#bgp-policy">BGP Policy</a></li>
            <li><a href="#graceful-restart">Graceful Restart</a></li>
            <li><a href="#bmp">BMP</a></li>
            <li><a href="#dynamic-neighbors">Dynamic Neighbors</a></li>
            <li><a href="#others">Others</a></li>
          </ul>
        </li>
        <li><a href="#gobgp-programming">GoBGP Programming</a>
          <ul>
            <li><a href="#basic-server">Basic Server</a></li>
            <li><a href="#route-reflector-1">Route Reflector</a></li>
            <li><a href="#bmp-1">BMP</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>GoBGP is an open source tool developed in Go language and running on Linux systems that provides control plane functionality for the BGP protocol. Compared with Quagga/FRRouting, GoBGP has better performance and shorter convergence time, and can be applied to larger networks, such as acting as an IXP router. GoBGP can be configured via the gRPC API using multiple languages such as Python, C++, and of course the CLI. GoBGP also supports OpenConfig, and its YANG model conforms to <a href="https://datatracker.ietf.org/doc/html/draft-ietf-idr-bgp-model-03">draft-ietf-idr-bgp-model-03</a>. Because GoBGP can easily interfere with routing manually and is more involved, it is a good tool for experimentation. In this paper, we will introduce the main features and practices of gobgp.</p>
<h2 id="background">Background</h2>
<h3 id="installation-and-composition">Installation and Composition</h3>
<p>The installation of GoBGP is very simple, just download the tar.gz file from <a href="https://github.com/osrg/gobgp/releases">https://github.com/osrg/gobgp/releases</a> and unzip it. The one selected here is v2.27.0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ tar -xzf gobgp_2.27.0_linux_amd64.tar.gz
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>gobgpd
<ul>
<li>daemon for Gobgp, complete implementation of BGP protocol.</li>
<li>Can interact with gobgpd via the gRPC API.</li>
<li>You can also configure bgp through configuration files.</li>
</ul>
</li>
<li>gobgp
<ul>
<li>Full-featured CLI.</li>
<li>You can view BGP-related information and configure BGP.</li>
</ul>
</li>
<li>Configuration file: supports multiple formats toml/yaml/json, etc.</li>
</ul>
<h3 id="support-features">Support Features</h3>
<ul>
<li>Full-featured CLI</li>
<li>Multiprotocol Support
<ul>
<li>IPv4/Pv6</li>
<li>Labeled IPv4/IPv6</li>
<li>Labeled IPv4/IPv6</li>
<li>EVPN</li>
<li>Flowspec IPv4/IPv6/L2</li>
</ul>
</li>
<li>Flexible Policy</li>
<li>Graceful Restart
<ul>
<li>Both restarting/helper speak role</li>
</ul>
</li>
<li>Route Reflector</li>
<li>Route Server</li>
<li>MRT Dumping</li>
<li>BMP</li>
<li>RPKI Validation</li>
<li>FIB manipulation</li>
<li>gRPC API</li>
<li>Standard configuration format</li>
</ul>
<h3 id="performance-test">Performance Test</h3>
<p>Compared with Quagga/FRRouting, GoBGP has better performance and shorter convergence time, and can be applied to larger networks, such as acting as an IXP router. For more performance tests on BGP, see <a href="https://elegantnetwork.github.io/posts/comparing-open-source-bgp-internet-routes">Comparing Open Source BGP stacks with internet routes</a>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/351e3c4a1b89452d92350f074f03aa75.png" alt="Comparing Open Source BGP stacks with internet routes"></p>
<h3 id="integration-with-quaggazebra-etc">Integration with Quagga/Zebra, etc</h3>
<p>GoBGP supports only one routing protocol, BGP, but it can be integrated with Zebra to work with Quagga/FRR by way of an API to support multiple routing protocols.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/ab7cc8a03ce24eb39151ca4f0c46b45e.png" alt="Integration with Quagga/Zebra, etc"></p>
<p>GoBGP can be integrated into the Quagga/Zebra system.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/dc32be8dd81044d9b01e50afd4c60829.png" alt="GoBGP integrated into the Quagga/Zebra system"></p>
<h2 id="using-gobgp">Using GoBGP</h2>
<h3 id="basic-operation">Basic operation</h3>
<p>We can start <code>gobgpd</code> as a bgp server to establish a BGP connection with the switch.</p>
<p>Here is the network topology diagram</p>
<p>For example, for</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[global.config]
</span></span><span class="line"><span class="cl">  as = 1002
</span></span><span class="line"><span class="cl">  router-id = &#34;172.25.0.136&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    peer-as = 1002
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;172.25.0.129&#34;
</span></span><span class="line"><span class="cl">    auth-password: &#34;xxxxx&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start gobgpd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">/</span> <span class="err">#</span> <span class="err">./gobgpd</span> <span class="err">-t</span> <span class="err">yaml</span> <span class="err">-f</span> <span class="err">gobgpd.yaml</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;gobgpd started&#34;</span><span class="p">,</span><span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2022-03-03T07:28:56Z&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;Topic&#34;</span><span class="p">:</span><span class="s2">&#34;Config&#34;</span><span class="p">,</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;Finished reading the config file&#34;</span><span class="p">,</span><span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2022-03-03T07:28:56Z&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;Peer 172.25.0.129 is added&#34;</span><span class="p">,</span><span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2022-03-03T07:28:56Z&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;Topic&#34;</span><span class="p">:</span><span class="s2">&#34;Peer&#34;</span><span class="p">,</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;Add a peer configuration for:172.25.0.129&#34;</span><span class="p">,</span><span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2022-03-03T07:28:56Z&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;Key&#34;</span><span class="p">:</span><span class="s2">&#34;172.25.0.129&#34;</span><span class="p">,</span><span class="nt">&#34;State&#34;</span><span class="p">:</span><span class="s2">&#34;BGP_FSM_OPENCONFIRM&#34;</span><span class="p">,</span><span class="nt">&#34;Topic&#34;</span><span class="p">:</span><span class="s2">&#34;Peer&#34;</span><span class="p">,</span><span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;info&#34;</span><span class="p">,</span><span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;Peer Up&#34;</span><span class="p">,</span><span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2022-03-03T07:29:01Z&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check the peer information via gobgp, here the <code>Establ</code> of the State means the connection has been established, if the State is <code>Active</code> then you need to check if the switch configuration is correct.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/ <span class="c1"># ./gobgp neighbor</span>
</span></span><span class="line"><span class="cl">Peer           AS  Up/Down State       <span class="p">|</span><span class="c1">#Received  Accepted</span>
</span></span><span class="line"><span class="cl">172.25.0.129 <span class="m">1002</span> 00:01:29 Establ      <span class="p">|</span>        <span class="m">8</span>         <span class="m">8</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># ./gobgp neighbor 172.25.0.129</span>
</span></span><span class="line"><span class="cl">BGP neighbor is 172.25.0.129, remote AS <span class="m">1002</span>
</span></span><span class="line"><span class="cl">  BGP version 4, remote router ID 172.25.100.4
</span></span><span class="line"><span class="cl">  BGP <span class="nv">state</span> <span class="o">=</span> ESTABLISHED, up <span class="k">for</span> 00:01:34
</span></span><span class="line"><span class="cl">  BGP <span class="nv">OutQ</span> <span class="o">=</span> 0, <span class="nv">Flops</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">  Hold <span class="nb">time</span> is 90, keepalive interval is <span class="m">30</span> seconds
</span></span><span class="line"><span class="cl">  Configured hold <span class="nb">time</span> is 90, keepalive interval is <span class="m">30</span> seconds
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Neighbor capabilities:
</span></span><span class="line"><span class="cl">    multiprotocol:
</span></span><span class="line"><span class="cl">        ipv4-unicast:   advertised and received
</span></span><span class="line"><span class="cl">    route-refresh:  advertised and received
</span></span><span class="line"><span class="cl">    extended-nexthop:   advertised
</span></span><span class="line"><span class="cl">        Local:  nlri: ipv4-unicast, nexthop: ipv6
</span></span><span class="line"><span class="cl">    4-octet-as: advertised and received
</span></span><span class="line"><span class="cl">  Message statistics:
</span></span><span class="line"><span class="cl">                         Sent       Rcvd
</span></span><span class="line"><span class="cl">    Opens:                  <span class="m">1</span>          <span class="m">1</span>
</span></span><span class="line"><span class="cl">    Notifications:          <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Updates:                <span class="m">0</span>          <span class="m">7</span>
</span></span><span class="line"><span class="cl">    Keepalives:             <span class="m">4</span>          <span class="m">4</span>
</span></span><span class="line"><span class="cl">    Route Refresh:          <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Discarded:              <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Total:                  <span class="m">5</span>         <span class="m">12</span>
</span></span><span class="line"><span class="cl">  Route statistics:
</span></span><span class="line"><span class="cl">    Advertised:             <span class="m">0</span>
</span></span><span class="line"><span class="cl">    Received:               <span class="m">8</span>
</span></span><span class="line"><span class="cl">    Accepted:               <span class="m">8</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>View the <code>global table</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/ <span class="c1"># ./gobgp global rib</span>
</span></span><span class="line"><span class="cl">   Network              Next Hop             AS_PATH              Age        Attrs
</span></span><span class="line"><span class="cl">*&gt; 10.0.0.0/24          172.25.0.129         <span class="m">801</span> <span class="m">45090</span> <span class="m">45090</span>      00:04:16   <span class="o">[{</span>Origin: ?<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 10.0.2.0/24          172.25.0.129         <span class="m">801</span> <span class="m">45090</span> <span class="m">45090</span>      00:04:16   <span class="o">[{</span>Origin: ?<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 172.25.0.0/25        172.25.0.129         <span class="m">801</span> <span class="m">1001</span>             00:04:16   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 172.25.0.128/25      172.25.0.129                              00:04:16   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 172.25.100.1/32      172.25.0.129         <span class="m">801</span>                  00:04:16   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 172.25.100.2/32      172.25.0.129         <span class="m">801</span>                  00:04:16   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 172.25.100.3/32      172.25.0.129         <span class="m">801</span> <span class="m">1001</span>             00:04:16   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">*&gt; 172.25.100.4/32      172.25.0.129                              00:04:16   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check out <code>adjacent rib-in and rib-out</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/ <span class="c1"># ./gobgp neighbor 172.25.0.129 adj-in</span>
</span></span><span class="line"><span class="cl">   ID  Network              Next Hop             AS_PATH              Age        Attrs
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   10.0.0.0/24          172.25.0.129         <span class="m">801</span> <span class="m">45090</span> <span class="m">45090</span>      00:07:18   <span class="o">[{</span>Origin: ?<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   10.0.2.0/24          172.25.0.129         <span class="m">801</span> <span class="m">45090</span> <span class="m">45090</span>      00:07:18   <span class="o">[{</span>Origin: ?<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   172.25.0.0/25        172.25.0.129         <span class="m">801</span> <span class="m">1001</span>             00:07:18   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   172.25.0.128/25      172.25.0.129                              00:07:18   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   172.25.100.1/32      172.25.0.129         <span class="m">801</span>                  00:07:18   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   172.25.100.2/32      172.25.0.129         <span class="m">801</span>                  00:07:18   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   172.25.100.3/32      172.25.0.129         <span class="m">801</span> <span class="m">1001</span>             00:07:18   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">   <span class="m">0</span>   172.25.100.4/32      172.25.0.129                              00:07:18   <span class="o">[{</span>Origin: i<span class="o">}</span> <span class="o">{</span>Med: 0<span class="o">}</span> <span class="o">{</span>LocalPref: 100<span class="o">}]</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># ./gobgp neighbor 172.25.0.129 adj-out</span>
</span></span><span class="line"><span class="cl">Network not in table
</span></span></code></pre></td></tr></table>
</div>
</div><p>The route can be declared with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">gobgp global rib -a ipv4 add 192.168.1.0/24
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="route-reflector">Route Reflector</h3>
<p>To ensure connectivity between iBGP peers, <strong>full connectivity relationships between IBGP peers are required</strong> . The <a href="https://datatracker.ietf.org/doc/html/rfc2796">Route Reflection</a> mode is a mature alternative to the Full Mesh mode, which will become dramatically less efficient as the cluster size increases. The RR scheme allows a BGP Speaker (that is, a Route Reflector) to broadcast the learned route information to other BGP Peers, greatly reducing the number of BGP Peer connections.</p>
<p>For gobgpd, the BGP Server can be supported as a Route Reflector by modifying the configuration file by adding the <code>RouteReflector.RouteReflectorConfig</code> configuration as follows.</p>
<ul>
<li>node 172.25.0.7 as an RR node to establish a bgp peer with switch <code>172.25.0.1</code></li>
<li>Node 172.25.0.6 as RR client node, establish bgp peer with RR node 172.25.0.7</li>
<li>node 172.25.0.8 as RR client node, establish bgp peer with RR node 172.25.0.7</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[global.config]
</span></span><span class="line"><span class="cl">  as = 1001
</span></span><span class="line"><span class="cl">  router-id = &#34;172.25.0.7&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;172.25.0.1&#34;
</span></span><span class="line"><span class="cl">    peer-as = 1001
</span></span><span class="line"><span class="cl">    auth-password = &#34;xxxxxx&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;172.25.0.6&#34;
</span></span><span class="line"><span class="cl">    peer-as = 1001
</span></span><span class="line"><span class="cl">    auth-password = &#34;xxxxxx&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  [neighbors.route-reflector.config]
</span></span><span class="line"><span class="cl">    route-reflector-client = true
</span></span><span class="line"><span class="cl">    route-reflector-cluster-id = &#34;172.25.0.137&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;172.25.0.8&#34;
</span></span><span class="line"><span class="cl">    peer-as = 1001
</span></span><span class="line"><span class="cl">    auth-password = &#34;xxxxxx&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  [neighbors.route-reflector.config]
</span></span><span class="line"><span class="cl">    route-reflector-client = true
</span></span><span class="line"><span class="cl">    route-reflector-cluster-id = &#34;172.25.0.137&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="route-server">Route Server</h3>
<p>There are some scenarios in the existing network, <strong>In order to achieve network traffic interoperability, it is usually necessary to perform full connectivity through eBGP</strong> . Full connectivity between border devices is more demanding in terms of cost consumption and device performance, and is not conducive to network topology and device expansion. <strong>Route Server is similar to IBGP full connection using route reflector</strong> , which is a device (or multiple devices) used to perform routing services, and its main function is to propagate routes to individual clients (border devices), and the routes published to clients do not modify path attributes such as AS_PATH, Nexthop, MED, etc., thus reducing the border router full connection consumption.</p>
<p>As shown in the figure below, an IX (Internet eXchange) contains multiple independent SPs (service providers) that want to interoperate traffic. Each SP has a border router connected to the common switching network. Each SP has its own AS number, and the BGP Router addresses range from 10.0.0.1 to 10.0.0.8.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/4500bd3d5aa048608b44cab7d7e88749.png" alt="Internet eXchange"></p>
<p>In this case, the 8 BGP Peers are required to establish a full connection. Like iBGP, this full mesh connection is more demanding in terms of cost consumption and device performance, and is not conducive to the expansion of network topology and number of devices.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/e46d0d32f3ef4d7ab1d3a61950abb184.png" alt="ix eBGP full mesh"></p>
<p>BGP Route Server can simplify SP connectivity. This is shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/a8c9c3adfc684e2585184e13aca10105.png" alt="BGP Route Server"></p>
<p>The following figure shows the transparent route propagation implemented by route server.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/8906795cceaa44d4a3afded270f39967.png" alt="transparent route propagation implemented by route server"></p>
<p>For more information about route server, you can refer to <a href="https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/iproute_bgp/configuration/xe-3s/irg-xe-3s-book/irg-route-server.pdf">Route Server</a>.</p>
<p>For GoBGP, Route Server is also supported.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[global.config]
</span></span><span class="line"><span class="cl">  as = 64512
</span></span><span class="line"><span class="cl">  router-id = &#34;192.168.255.1&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;10.0.255.1&#34;
</span></span><span class="line"><span class="cl">    peer-as = 65001
</span></span><span class="line"><span class="cl">    auth-password = &#34;hoge1&#34;
</span></span><span class="line"><span class="cl">  [neighbors.transport.config]
</span></span><span class="line"><span class="cl">    passive-mode = true
</span></span><span class="line"><span class="cl">  [neighbors.route-server.config]
</span></span><span class="line"><span class="cl">    route-server-client = true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;10.0.255.2&#34;
</span></span><span class="line"><span class="cl">    peer-as = 65002
</span></span><span class="line"><span class="cl">    auth-password = &#34;hoge2&#34;
</span></span><span class="line"><span class="cl">  [neighbors.transport.config]
</span></span><span class="line"><span class="cl">    passive-mode = true
</span></span><span class="line"><span class="cl">  [neighbors.route-server.config]
</span></span><span class="line"><span class="cl">    route-server-client = true
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bgp-policy">BGP Policy</h3>
<p>Policy is a way to control how BGP routes are inserted into the RIB or broadcast to BGP Peers, and is divided into two parts <code>Condition</code> and <code>Action</code>. When the Policy is configured and the Condition condition is triggered, an Action action is performed to modify the route.</p>
<ul>
<li>Condition includes <code>prefix</code>, <code>neighbor</code> (source/destination of the route) and <code>aspath</code>, etc.</li>
<li>Action includes <code>accept</code> , <code>reject</code> , <code>MED/aspath/community manipulation</code> , etc.</li>
</ul>
<h4 id="policy-model">Policy Model</h4>
<p>Policy model includes <code>Import Policy</code> and <code>Export Policy</code> ：</p>
<ul>
<li><strong>Import</strong> policy is invoked before best path calculation and pushing routes to RIB.</li>
<li><strong>Export</strong> policy is invoked after that.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/381a649ae3494dc2b4fa82756dc92a67.png" alt="Policy Model"></p>
<p>You can view the policy with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ gobgp global policy import
</span></span><span class="line"><span class="cl">$ gobgp global policy <span class="nb">export</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="route-server-policy-model">Route Server Policy Model</h4>
<p>For the Route Server model, <strong>Import</strong> and <strong>Export</strong> policies are both specific to a Peer.</p>
<ul>
<li>The <strong>Import</strong> policy defines what routes will be imported into the master RIB.</li>
<li>The <strong>Export</strong> policy defines what routes will be exported from the master RIB.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/c1f294c76d244c6880873ae3540e41f0.png" alt="Route Server Policy Model"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ gobgp neighbor &lt;neighbor-addr&gt; policy import
</span></span><span class="line"><span class="cl">$ gobgp neighbor &lt;neighbor-addr&gt; policy <span class="nb">export</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="policy-structure">Policy Structure</h4>
<p>A Policy contains multiple Statements, each with its own Condtions and Actions.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/13/98f6248c50bc4f408102f4968818910b.png" alt="Policy Structure"></p>
<p>Conditions includes.</p>
<ul>
<li>prefix</li>
<li>neighbor</li>
<li>aspath</li>
<li>aspath length</li>
<li>community</li>
<li>extended community</li>
<li>rpki validation result</li>
<li>route type (internal/external/local)</li>
<li>large community</li>
<li>afi-safi in</li>
</ul>
<p>Actions includes.</p>
<ul>
<li>accept or reject</li>
<li>add/replace/remove community or remove all communities</li>
<li>add/subtract or replace MED value</li>
<li>set next-hop (specific address/own local address/don&rsquo;t modify)</li>
<li>set local-pref</li>
<li>prepend AS number in the AS_PATH attribute</li>
</ul>
<p>You can view the Policy configuration with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ gobgp policy
</span></span><span class="line"><span class="cl">$ gobgp policy statement
</span></span><span class="line"><span class="cl">$ gobgp policy prefix
</span></span><span class="line"><span class="cl">$ gobgp policy neighbor
</span></span><span class="line"><span class="cl">$ gobgp policy as-path
</span></span><span class="line"><span class="cl">$ gobgp policy community
</span></span><span class="line"><span class="cl">$ gobgp policy ext-community
</span></span><span class="line"><span class="cl">$ gobgp policy large-community
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="policy-configuration">Policy Configuration</h4>
<p>Policy configuration is more complicated, here are the steps to configure it, you can refer to <a href="https://github.com/osrg/gobgp/blob/master/docs/sources/policy.md#examples">here</a> for details.</p>
<ol>
<li>define defined-sets
<ol>
<li>define prefix-sets</li>
<li>define neighbor-sets</li>
</ol>
</li>
<li>define bgp-defined-sets
<ol>
<li>define community-sets</li>
<li>define ext-community-sets</li>
<li>define as-path-setList</li>
<li>define large-community-sets</li>
</ol>
</li>
<li>define policy-definitions</li>
<li>attach policies to global rib (or neighbor local rib when neighbor is <a href="https://github.com/osrg/gobgp/blob/master/docs/sources/route-server.md">route-server-client</a>).</li>
</ol>
<h3 id="graceful-restart">Graceful Restart</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[global.config]
</span></span><span class="line"><span class="cl">  as = 64512
</span></span><span class="line"><span class="cl">  router-id = &#34;192.168.255.1&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[neighbors]]
</span></span><span class="line"><span class="cl">  [neighbors.config]
</span></span><span class="line"><span class="cl">    neighbor-address = &#34;10.0.255.1&#34;
</span></span><span class="line"><span class="cl">    peer-as = 65001
</span></span><span class="line"><span class="cl">  [neighbors.graceful-restart.config]
</span></span><span class="line"><span class="cl">    enabled = true
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bmp">BMP</h3>
<p>GoBGP supports <a href="https://tools.ietf.org/html/rfc7854">BGP Monitoring Protocol (RFC 7854)</a> for real-time monitoring of the operational status of BGP sessions, including the establishment and closure of peer relationships, routing information, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[global.config]
</span></span><span class="line"><span class="cl">  as = 64512
</span></span><span class="line"><span class="cl">  router-id = &#34;192.168.255.1&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[bmp-servers]]
</span></span><span class="line"><span class="cl">  [bmp-servers.config]
</span></span><span class="line"><span class="cl">    address = &#34;127.0.0.1&#34;
</span></span><span class="line"><span class="cl">    port=11019
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dynamic-neighbors">Dynamic Neighbors</h3>
<p>In a BGP network, when multiple peers change frequently, if the peers are configured statically, the peers need to be added or deleted frequently at the local end, which is a great maintenance workload. In this case, you can configure the BGP dynamic peer function to make BGP listen to BGP connection requests from the specified network segment and dynamically establish BGP peers, and add these peers to the same peer group. This reduces the workload of network maintenance by eliminating the need to add or remove BGP peers at the local end when peer changes occur.</p>
<p>Switches generally support the configuration of Dynamic Neighbors, such as <a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100034251/f1ac6afd">here is the method of configuring Dynamic Neighbors for Huawei switches</a> Dynamic Neighbors are also supported for gobgp.</p>
<p>As shown below, there are two main parts to configure.</p>
<ul>
<li>Create a peer group, describing the basic information of the peer group</li>
<li>Configure the peer group to listen on the <code>172.40.0.0/16</code> network segment</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[global.config]
</span></span><span class="line"><span class="cl">  as = 65001
</span></span><span class="line"><span class="cl">  router-id = &#34;172.40.1.2&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[peer-groups]]
</span></span><span class="line"><span class="cl">  [peer-groups.config]
</span></span><span class="line"><span class="cl">    peer-group-name = &#34;sample-group&#34;
</span></span><span class="line"><span class="cl">    peer-as = 65002
</span></span><span class="line"><span class="cl">  [[peer-groups.afi-safis]]
</span></span><span class="line"><span class="cl">    [peer-groups.afi-safis.config]
</span></span><span class="line"><span class="cl">      afi-safi-name = &#34;ipv4-unicast&#34;
</span></span><span class="line"><span class="cl">  [[peer-groups.afi-safis]]
</span></span><span class="line"><span class="cl">    [peer-groups.afi-safis.config]
</span></span><span class="line"><span class="cl">      afi-safi-name = &#34;ipv4-flowspec&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[[dynamic-neighbors]]
</span></span><span class="line"><span class="cl">  [dynamic-neighbors.config]
</span></span><span class="line"><span class="cl">    prefix = &#34;172.40.0.0/16&#34;
</span></span><span class="line"><span class="cl">    peer-group = &#34;sample-group&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="others">Others</h3>
<p>There are a lot of other features on GitHub about MRT/BMP/EVPN, so you can check out the documentation if you need to.</p>
<h2 id="gobgp-programming">GoBGP Programming</h2>
<h3 id="basic-server">Basic Server</h3>
<p>Referring to the gobgp library <a href="https://github.com/osrg/gobgp/blob/master/docs/sources/lib.md">documentation provided</a>, we can implement a simple go bgp server as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apb</span> <span class="s">&#34;google.golang.org/protobuf/types/known/anypb&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">api</span> <span class="s">&#34;github.com/osrg/gobgp/v3/api&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/osrg/gobgp/v3/pkg/log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/osrg/gobgp/v3/pkg/server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span> <span class="o">:=</span> <span class="nx">logrus</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建 BGP Server 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewBgpServer</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nf">LoggerOption</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myLogger</span><span class="p">{</span><span class="nx">logger</span><span class="p">:</span> <span class="nx">log</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// global configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">StartBgp</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">StartBgpRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Global</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Global</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Asn</span><span class="p">:</span>         <span class="mi">65003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">RouterId</span><span class="p">:</span>   <span class="s">&#34;10.0.255.254&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ListenPort</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// gobgp won&#39;t listen on tcp:179
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// monitor the change of the peer state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">MonitorPeer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">MonitorPeerRequest</span><span class="p">{},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">Peer</span><span class="p">)</span> <span class="p">{</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// neighbor configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Peer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Conf</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">PeerConf</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">NeighborAddress</span><span class="p">:</span> <span class="s">&#34;172.17.0.2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">PeerAsn</span><span class="p">:</span>          <span class="mi">65002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddPeer</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">AddPeerRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Peer</span><span class="p">:</span> <span class="nx">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// add routes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nlri</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">IPAddressPrefix</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Prefix</span><span class="p">:</span>    <span class="s">&#34;10.0.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrefixLen</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">a1</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">OriginAttribute</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Origin</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a2</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">NextHopAttribute</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NextHop</span><span class="p">:</span> <span class="s">&#34;10.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a3</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">AsPathAttribute</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Segments</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">AsSegment</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">Type</span><span class="p">:</span>    <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">Numbers</span><span class="p">:</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">{</span><span class="mi">6762</span><span class="p">,</span> <span class="mi">39919</span><span class="p">,</span> <span class="mi">65000</span><span class="p">,</span> <span class="mi">35753</span><span class="p">,</span> <span class="mi">65000</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">attrs</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apb</span><span class="p">.</span><span class="nx">Any</span><span class="p">{</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">a3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddPath</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">AddPathRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Path</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Path</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Family</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Family</span><span class="p">{</span><span class="nx">Afi</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">Family_AFI_IP</span><span class="p">,</span> <span class="nx">Safi</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">Family_SAFI_UNICAST</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Nlri</span><span class="p">:</span>   <span class="nx">nlri</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Pattrs</span><span class="p">:</span> <span class="nx">attrs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">v6Family</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Family</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Afi</span><span class="p">:</span>  <span class="nx">api</span><span class="p">.</span><span class="nx">Family_AFI_IP6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Safi</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">Family_SAFI_UNICAST</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// add v6 route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nlri</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">IPAddressPrefix</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrefixLen</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Prefix</span><span class="p">:</span>    <span class="s">&#34;2001:db8:1::&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v6Attrs</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">MpReachNLRIAttribute</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Family</span><span class="p">:</span>   <span class="nx">v6Family</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NextHops</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;2001:db8::1&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Nlris</span><span class="p">:</span>    <span class="p">[]</span><span class="o">*</span><span class="nx">apb</span><span class="p">.</span><span class="nx">Any</span><span class="p">{</span><span class="nx">nlri</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">apb</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">CommunitiesAttribute</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Communities</span><span class="p">:</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">{</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddPath</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">AddPathRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Path</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Path</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Family</span><span class="p">:</span> <span class="nx">v6Family</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Nlri</span><span class="p">:</span>   <span class="nx">nlri</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Pattrs</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">apb</span><span class="p">.</span><span class="nx">Any</span><span class="p">{</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">v6Attrs</span><span class="p">,</span> <span class="nx">c</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nf">ListPath</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">ListPathRequest</span><span class="p">{</span><span class="nx">Family</span><span class="p">:</span> <span class="nx">v6Family</span><span class="p">},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">Destination</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// do something useful here instead of exiting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the sample code is relatively simple and mainly uses the following APIs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 创建 BGP Server 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewBgpServer</span><span class="p">(</span><span class="nx">opt</span> <span class="o">...</span><span class="nx">ServerOption</span><span class="p">)</span> <span class="o">*</span><span class="nx">BgpServer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 启动 BGP Server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BgpServer</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// global 配置
</span></span></span><span class="line"><span class="cl"><span class="c1">// BGP Server 的 AS 是 65003，RouterId 是 10.0.255.254
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">api</span><span class="p">.</span><span class="nx">Global</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Asn</span><span class="p">:</span>         <span class="mi">65003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouterId</span><span class="p">:</span>   <span class="s">&#34;10.0.255.254&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ListenPort</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// gobgp won&#39;t listen on tcp:179
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 根据传入 global 配置，开启 BGP Server 的 BGP 协商
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BgpServer</span><span class="p">)</span> <span class="nf">StartBgp</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">StartBgpRequest</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 观察 BGP Peer 状态变化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BgpServer</span><span class="p">)</span> <span class="nf">MonitorPeer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">MonitorPeerRequest</span><span class="p">,</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">Peer</span><span class="p">))</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Peer 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">api</span><span class="p">.</span><span class="nx">Peer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Conf</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">PeerConf</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">NeighborAddress</span><span class="p">:</span> <span class="s">&#34;172.17.0.2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">PeerAsn</span><span class="p">:</span>          <span class="mi">65002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 建立 BGP Peer 连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BgpServer</span><span class="p">)</span> <span class="nf">AddPeer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">AddPeerRequest</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 传递 BGP 路由信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BgpServer</span><span class="p">)</span> <span class="nf">AddPath</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">AddPathRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">AddPathResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="route-reflector-1">Route Reflector</h3>
<p>The <code>api.Peer</code> structure can be configured in more detail so that the joined BGP Peer is acting as an RR client.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">n</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Peer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Conf</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">PeerConf</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NeighborAddress</span><span class="p">:</span> <span class="s">&#34;172.25.0.6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PeerAsn</span><span class="p">:</span>          <span class="mi">1001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RouteReflector</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">RouteReflector</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RouteReflectorClient</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RouteReflectorClusterId</span><span class="p">:</span> <span class="s">&#34;172.25.0.7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bmp-1">BMP</h3>
<p>Here is a list of several common BMP messages.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BMPMessage</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Header</span>     <span class="nx">BMPHeader</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PeerHeader</span> <span class="nx">BMPPeerHeader</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Body</span>       <span class="nx">BMPBody</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BMPRouteMonitoring</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">BGPUpdate</span>        <span class="o">*</span><span class="nx">bgp</span><span class="p">.</span><span class="nx">BGPMessage</span>
</span></span><span class="line"><span class="cl">    <span class="nx">BGPUpdatePayload</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BMPPeerDownNotification</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Reason</span>          <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">BGPNotification</span> <span class="o">*</span><span class="nx">bgp</span><span class="p">.</span><span class="nx">BGPMessage</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Data</span>            <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BMPPeerUpNotification</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">LocalAddress</span>    <span class="nx">net</span><span class="p">.</span><span class="nx">IP</span>
</span></span><span class="line"><span class="cl">    <span class="nx">LocalPort</span>       <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">    <span class="nx">RemotePort</span>      <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SentOpenMsg</span>     <span class="o">*</span><span class="nx">bgp</span><span class="p">.</span><span class="nx">BGPMessage</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ReceivedOpenMsg</span> <span class="o">*</span><span class="nx">bgp</span><span class="p">.</span><span class="nx">BGPMessage</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-04/go-ebfp/">
            <span class="next-text nav-default">Develop eBPF programs using Go language</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
