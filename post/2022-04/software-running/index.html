<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Software running mechanism and memory management - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore computer software operation mechanism and memory management." /><meta name="keywords" content="Software Running mechanism, memory management" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-04/software-running/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Software running mechanism and memory management" />
<meta property="og:description" content="Explore computer software operation mechanism and memory management." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-04/software-running/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-18T14:15:04+08:00" />
<meta property="article:modified_time" content="2022-04-18T14:15:04+08:00" />

<meta itemprop="name" content="Software running mechanism and memory management">
<meta itemprop="description" content="Explore computer software operation mechanism and memory management."><meta itemprop="datePublished" content="2022-04-18T14:15:04+08:00" />
<meta itemprop="dateModified" content="2022-04-18T14:15:04+08:00" />
<meta itemprop="wordCount" content="2234">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Software running mechanism and memory management"/>
<meta name="twitter:description" content="Explore computer software operation mechanism and memory management."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Software running mechanism and memory management</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-18 14:15:04 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2234 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#the-whole-process-of-computer-operation">The whole process of computer operation</a></li>
        <li><a href="#memory-management-in-real-mode">Memory management in real mode</a></li>
        <li><a href="#memory-management-in-protected-mode">Memory management in protected mode</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The core function of an operating system is software governance, and a very important part of software governance is to allow multiple software to work together to use the computer&rsquo;s resources rationally and without contention.</p>
<p>Memory, as the most basic hardware resource of a computer, has a very special position. We know that the <code>CPU</code> can directly access very few storage resources, only: <strong>registers</strong>, <strong>memory (RAM)</strong>, <strong>ROM on the motherboard</strong>.</p>
<p>The registers are very, very fast to access, but are so few in number that most programmers do not deal with them directly, but rather the compiler of the programming language automatically selects registers as needed to optimize the performance of the program.</p>
<p>The <code>ROM</code> on the motherboard is non-volatile, read-only storage. By non-volatile, I mean that the data inside it will still be there after the computer restarts. This is unlike <strong>memory (RAM)</strong> where the data on it is lost after the computer reboots.ROM&rsquo;s non-volatile and read-only nature dictates that it is ideal for storing a computer&rsquo;s bootloader (BIOS).</p>
<p>So you can see that memory is in a very special position, it is the only basic resource that the <code>CPU</code> has built-in support and that the programmer will deal with directly.</p>
<h2 id="the-whole-process-of-computer-operation">The whole process of computer operation</h2>
<p>Of course, this is the view from the <code>CPU</code> point of view: for the <code>CPU</code>, the <strong>&ldquo;computing &ldquo;</strong> process is a complete <strong>&ldquo;computing &ldquo;</strong> process from the moment the computer is powered up, the first instruction of the <code>BIOS</code> program is executed, and the computer is finally shut down. It doesn&rsquo;t care how many &ldquo;sub &lsquo;computing&rsquo; processes&rdquo; there are in this process.</p>
<p>But from the perspective of the operating system, the entire <strong>&ldquo;computing &ldquo;</strong> process, from boot-up to shutdown, is accomplished by a number of software, i.e., sub <strong>&ldquo;computing &ldquo;</strong> processes, working together. In terms of timing, the complete <strong>&ldquo;computing &ldquo;</strong> process of a computer is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/18/baf8703287684aadb6f73dc3b701effe.png" alt="boot process"></p>
<p>Each sub-process of the entire <strong>&ldquo;computing &ldquo;</strong> process has its own explicit considerations.</p>
<p>First of all, the BIOS program is not solidified in the CPU, but placed independently on the ROM of the motherboard, because the input and output devices of computers in different historical periods are very different, there are keyboard + mouse + monitor, touch screen, and pure voice interaction, external storage is floppy, hard disk, flash memory, these changes we can cope with by adjusting the BIOS program, without the need to modify the CPU.</p>
<p>The boot sector bootloader is the boundary where the program is transferred from the internal storage (ROM) to the external storage. The bootloader is so short that <code>BIOS</code> only needs to load it into memory for execution, but then control of the system is subtly transferred to the external storage.</p>
<p>The boot sector bootloader is not solidified in the BIOS, but written in the boot sector of the external storage, in order to avoid the need for frequent BIOS program modifications. After all, the BIOS is still hardware, while the boot sector bootloader is already in the software category, so it will be much easier to modify it.</p>
<p>The OS bootloader, then, is the real start of external storage taking over control of the computer. Here OS stands for Operating System. This is where the operating system gets to work. There are many, many things that happen in this process, which we&rsquo;ll skip here. But eventually, after all the initialization is done, the OS hands over the execution to the OS Shell program.</p>
<p>The OS Shell program is responsible for the interaction between the operating system and the user. In the earliest days, when computers interacted with a character interface, the OS Shell program was a command line program. In DOS, it was called command.com, while in Linux it was called something like sh or bash. Here sh is short for shell.</p>
<p>During this period, the way to start a software was to type a command line into a shell program, and the shell was responsible for interpreting the command line to understand the user&rsquo;s intent, and then starting the appropriate software. In the GUI era, starting software in the shell became a matter of clicking the mouse or moving a finger (touch screen), and the interaction paradigm was much simplified.</p>
<p>After understanding the entire process of computer boot-up to shutdown, you may soon realize that there is a critical detail that is not explained: how does the computer run the software on external storage?</p>
<p>This has to do with memory management.</p>
<p>In conjunction with the role of memory, we talk about memory management and only need to talk clearly about two issues.</p>
<ul>
<li>How to allocate memory (to running software, to avoid them competing for resources).</li>
<li>How to run software on external storage (e.g. hard disk)?</li>
</ul>
<p>Before answering these two questions, let&rsquo;s understand a little background: the real mode and the protected mode of the CPU. These two modes are completely different in the way the CPU operates on memory. In real mode, the CPU accesses memory directly through physical addresses. In protected mode, the CPU translates virtual memory addresses into physical memory addresses through an address mapping table, and then reads the data.</p>
<p>Accordingly, an operating system that works in real mode is called a real mode operating system, and an operating system that works in protected mode is called a protected mode operating system.</p>
<h2 id="memory-management-in-real-mode">Memory management in real mode</h2>
<p>Under a real-mode operating system, all software, including the operating system itself, is under the same physical address space. To the <code>CPU</code>, they appear to be the same program. How does the operating system allocate memory? There are at least two possible ways.</p>
<ol>
<li>Put the address of the OS memory management related function in a recognized place (e.g. at 0x10000), and every software that wants to request memory will go to this place to get the memory management function and call it.</li>
<li>design the memory management function as an interrupt request. An interrupt is a mechanism by which the <code>CPU</code> responds to a hardware device event. When something happens to an input/output device that needs to be handled by the <code>CPU</code>, it triggers an interrupt.</li>
</ol>
<p>The memory has a global interrupt vector table, which is essentially a bunch of function addresses in a place that everyone recognizes. For example, if the keyboard presses a key, it will trigger interrupt number 9. When the CPU receives an interrupt request, it stops what it&rsquo;s doing to respond to the interrupt request (goes to the interrupt vector table, finds the function address corresponding to item 9 and executes it), and then goes back to what it was doing when it&rsquo;s done.</p>
<p>The interrupt mechanism was originally designed to respond to hardware events, but the CPU also provides instructions to allow software to trigger an interrupt, which we call a soft interrupt. For example, we have agreed that interrupt 77 is a memory management interrupt, and the operating system writes its own memory management function to item 77 of the interrupt vector table during initialization.</p>
<p>So, the two methods above are essentially the same method, only the details of the mechanism are different. The interrupt mechanism is much more than just a function vector table. For example, interrupts will have priority, and higher priority interrupts can interrupt lower priority interrupts. The opposite is not possible.</p>
<p>So, how does the OS run software on external storage (like a hard drive) in real mode?</p>
<p>Quite simply, it reads the complete software from the external storage into memory and then executes it. However, before execution it does one thing, it fixes the floating address. Why is there a floating address? Because the software does not know where it will be when it is not loaded into memory, so there are many addresses involving data and functions that cannot be fixed and have to be determined when the OS loads it into memory.</p>
<p>Overall, the mechanism of real mode memory management is very easy to understand. After all, it is essentially a program that is split into many pieces of software (program code fragments), which enables the dynamic loading of program code fragments.</p>
<h2 id="memory-management-in-protected-mode">Memory management in protected mode</h2>
<p>But there are two problems with real mode.</p>
<p>One of them is <strong>security</strong>. The operating system and all software running together can modify each other&rsquo;s data and even program instructions at will, so it is very easy to do damage.</p>
<p>The second is that the software supported <strong>low complexity</strong> , while the number of software that can be run is small.</p>
<p>On the one hand, the more complex the software is, the more code it has, the more storage space it needs, and it may even appear that the size of a single piece of software exceeds the available memory of the computer, which then can not execute it in real mode.</p>
<p>On the other hand, even if a single piece of software can run, once we have several more running at the same time, the memory requirements of the operating system increase dramatically. Compared to the memory demand of so many software combined, the memory storage space is often still insufficient.</p>
<p>But why do we usually open new software without any fear of running out of memory?</p>
<p>This is where protected mode comes into play. In protected mode, memory access is no longer directly through physical memory, but is based on virtual memory. In virtual memory mode, the entire memory space is divided into a number of contiguous memory pages. Each memory page is a fixed size, say 64K.</p>
<p>Thus, each time the CPU accesses data in a virtual memory address, it first calculates which memory page it is accessing, and then the CPU converts the virtual memory address to a physical memory address through an address mapping table, and then goes to this physical memory address to read the data. The address mapping table is an array where the subscript is the memory page number and the value is the first address of the physical memory corresponding to that memory page.</p>
<p>Of course, it is possible that the physical memory address corresponding to a memory page does not exist yet, and this is called a missing page, so the data cannot be read. In this case, the CPU will initiate a missing page interrupt request.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/04/18/379ae616769a45a9b1831251771ecde2.png" alt="missing page interrupt request"></p>
<p>This out-of-page interrupt request is taken over by the operating system. When a page out occurs, the operating system allocates physical memory for this memory page and recovers the data for this memory page. If there is no free physical memory to allocate, it selects a memory page that has not been accessed for the longest time for elimination.</p>
<p>Of course, the data of this memory page is saved before elimination (for unix-based systems it is often a swap partition; for windows it is a .swp file with hidden attributes.) The next time the CPU accesses the obsolete memory page, a missing page interrupt will occur and the OS will have to recover the data.</p>
<p>With this virtual memory mechanism, the operating system does not need to load the entire software into memory right from the start, but loads the corresponding program code fragments on demand via page-out interrupts. The problem of running multiple software programs at the same time is also solved. When memory is not enough, the longest unused memory pages are eliminated to free up physical memory.</p>
<p>The problem of running software is solved. So, how does the operating system allocate memory to running software?</p>
<p>Actually, the problem of memory allocation is also solved, without any additional mechanism. The memory address space is virtual anyway, and the OS can allocate a super large amount of memory to the software it wants to run right from the start, and you can use it however you want. If the software doesn&rsquo;t use a memory page, nothing happens. Once the software uses a memory page, the operating system allocates real physical memory to it through a page-out interrupt.</p>
<p>By introducing virtual memory and its out-of-page mechanism, the CPU has solved the relationship between the operating system and the software very well.</p>
<p>Each running piece of software, let&rsquo;s call it a process, has its own address mapping table. That is, the virtual addresses are not global, but rather each process has a separate virtual address space of its own.</p>
<p>In protected mode, one of the things that the computer&rsquo;s infrastructure system and the operating system are working together to do is to make each piece of software &ldquo;feel&rdquo; like it is monopolizing the resources of the entire computer. The independent virtual address space camouflages this nicely: it looks like I&rsquo;m enjoying all the memory resources alone. The problem of floating addresses in real mode is also solved by the fact that software can assume what the absolute address of its own code is for loading, and does not need to readjust the address of CPU instruction operations at load time.</p>
<p>This is very different from real mode. In real mode, all processes are in the same address space in physical memory, and they can access each other&rsquo;s data, modify or even destroy each other&rsquo;s data, and thus cause other processes (including those of the operating system itself) to crash. Memory is the basic resource for process operation, and keeping the process basic resources independent is the most basic requirement of software governance. This is the reason why protection mode is called &ldquo;protection&rdquo; mode.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/php-extensions/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Writing extensions to PHP 7.4</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-04/memory-alignment/">
            <span class="next-text nav-default">About Memory Alignment</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
