<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kubernetes Containers and image GC Principles Explained - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article analyzes in detail the principles of GC for Kubernetes containers and images." /><meta name="keywords" content="Containers, image, Gc" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/k8s-image-gc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Kubernetes Containers and image GC Principles Explained" />
<meta property="og:description" content="This article analyzes in detail the principles of GC for Kubernetes containers and images." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/k8s-image-gc/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-14T12:26:56+08:00" />
<meta property="article:modified_time" content="2022-06-14T12:26:56+08:00" />

<meta itemprop="name" content="Kubernetes Containers and image GC Principles Explained">
<meta itemprop="description" content="This article analyzes in detail the principles of GC for Kubernetes containers and images."><meta itemprop="datePublished" content="2022-06-14T12:26:56+08:00" />
<meta itemprop="dateModified" content="2022-06-14T12:26:56+08:00" />
<meta itemprop="wordCount" content="2871">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes Containers and image GC Principles Explained"/>
<meta name="twitter:description" content="This article analyzes in detail the principles of GC for Kubernetes containers and images."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kubernetes Containers and image GC Principles Explained</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-14 12:26:56 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2871 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#container-gc">Container GC</a></li>
        <li><a href="#image-gc">Image GC</a>
          <ul>
            <li><a href="#parameter-configuration">Parameter configuration</a></li>
            <li><a href="#imagegcmanager">ImageGCManager</a></li>
            <li><a href="#initialization">Initialization</a></li>
            <li><a href="#realimagegcmanagerstart">realImageGCManager.Start()</a></li>
            <li><a href="#start-garbage-collection">Start garbage collection</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="container-gc">Container GC</h2>
<p>Exiting containers continue to use system resources, such as storing a lot of data on the filesystem and the CPU and memory that Docker applications use to maintain these containers.</p>
<p>Docker itself does not automatically delete exiting containers, so kubelet takes over this responsibility. kubelet container recycling is used to delete exiting containers to save space on nodes and improve performance.</p>
<p>While container GC is good for space and performance, deleting containers also results in the error site being cleaned up, which is not good for debug and error location, so it is not recommended to delete all exiting containers. Therefore, container cleanup requires a certain strategy, mainly telling the kubelet how many exiting containers you want to keep. Configurable kubelet startup parameters related to container GC include</p>
<ul>
<li><code>minimum-container-ttl-duration</code>: how long after the container ends before it can be recycled, default is one minute</li>
<li><code>maximum-dead-containers-per-container</code> : how many containers can be saved per container, default is 1, negative setting means no limit</li>
<li><code>maximum-dead-containers</code>: the maximum number of dead containers that can be kept on the node, the default is -1, which means no limit</li>
</ul>
<p>This means that by default, kubelet will automatically do container GC every minute, containers can be deleted after one minute of exit, and only one exiting history container will be kept per container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">containerGC</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// client 用来和 docker API 交互，比如获取容器列表、查看某个容器的详细信息等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">client</span>           <span class="nx">DockerInterface</span>
</span></span><span class="line"><span class="cl">    <span class="nx">podGetter</span>        <span class="nx">podGetter</span>
</span></span><span class="line"><span class="cl">    <span class="nx">containerLogsDir</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewContainerGC</span><span class="p">(</span><span class="nx">client</span> <span class="nx">DockerInterface</span><span class="p">,</span> <span class="nx">podGetter</span> <span class="nx">podGetter</span><span class="p">,</span> <span class="nx">containerLogsDir</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">containerGC</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">containerGC</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">client</span><span class="p">:</span>           <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">podGetter</span><span class="p">:</span>        <span class="nx">podGetter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">containerLogsDir</span><span class="p">:</span> <span class="nx">containerLogsDir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cgc</span> <span class="o">*</span><span class="nx">containerGC</span><span class="p">)</span> <span class="nf">GarbageCollect</span><span class="p">(</span><span class="nx">gcPolicy</span> <span class="nx">kubecontainer</span><span class="p">.</span><span class="nx">ContainerGCPolicy</span><span class="p">,</span> <span class="nx">allSourcesReady</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 找到可以清理的容器列表，条件是不在运行并且创建时间超过 MinAge。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这个步骤会过滤掉不是 kubelet 管理的容器，并且把容器按照创建时间进行排序（也就是说最早创建的容器会先被删除）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// evictUnits 返回的是需要被正确回收的，第二个参数是 kubelet 无法识别的容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">evictUnits</span><span class="p">,</span> <span class="nx">unidentifiedContainers</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cgc</span><span class="p">.</span><span class="nf">evictableContainers</span><span class="p">(</span><span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MinAge</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 删除无法识别的容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">container</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">unidentifiedContainers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Removing unidentified dead container %q with ID %q&#34;</span><span class="p">,</span> <span class="nx">container</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">container</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">cgc</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">RemoveContainer</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">dockertypes</span><span class="p">.</span><span class="nx">ContainerRemoveOptions</span><span class="p">{</span><span class="nx">RemoveVolumes</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">glog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;Failed to remove unidentified dead container %q: %v&#34;</span><span class="p">,</span> <span class="nx">container</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果 pod 已经不存在了，就删除其中所有的容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">allSourcesReady</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">unit</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">evictUnits</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">cgc</span><span class="p">.</span><span class="nf">isPodDeleted</span><span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">uid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">cgc</span><span class="p">.</span><span class="nf">removeOldestN</span><span class="p">(</span><span class="nx">unit</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">unit</span><span class="p">))</span> <span class="c1">// Remove all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nb">delete</span><span class="p">(</span><span class="nx">evictUnits</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行 GC 策略，保证每个 POD 最多只能保存 MaxPerPodContainer 个已经退出的容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxPerPodContainer</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cgc</span><span class="p">.</span><span class="nf">enforceMaxContainersPerEvictUnit</span><span class="p">(</span><span class="nx">evictUnits</span><span class="p">,</span> <span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxPerPodContainer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行 GC 策略，保证节点上最多有 MaxContainers 个已经退出的容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 先把最大容器数量平分到 pod，保证每个 pod 在平均数量以下；如果还不满足要求的数量，就按照时间顺序先删除最旧的容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxContainers</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">evictUnits</span><span class="p">.</span><span class="nf">NumContainers</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxContainers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 先按照 pod 进行删除，每个 pod 能保留的容器数是总数的平均值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">numContainersPerEvictUnit</span> <span class="o">:=</span> <span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxContainers</span> <span class="o">/</span> <span class="nx">evictUnits</span><span class="p">.</span><span class="nf">NumEvictUnits</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">numContainersPerEvictUnit</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">numContainersPerEvictUnit</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cgc</span><span class="p">.</span><span class="nf">enforceMaxContainersPerEvictUnit</span><span class="p">(</span><span class="nx">evictUnits</span><span class="p">,</span> <span class="nx">numContainersPerEvictUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果还不满足数量要求，按照容器进行删除，先删除最老的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">numContainers</span> <span class="o">:=</span> <span class="nx">evictUnits</span><span class="p">.</span><span class="nf">NumContainers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">numContainers</span> <span class="p">&gt;</span> <span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxContainers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">flattened</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">containerGCInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">numContainers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="nx">uid</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">evictUnits</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">flattened</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">flattened</span><span class="p">,</span> <span class="nx">evictUnits</span><span class="p">[</span><span class="nx">uid</span><span class="p">]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nf">byCreated</span><span class="p">(</span><span class="nx">flattened</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">cgc</span><span class="p">.</span><span class="nf">removeOldestN</span><span class="p">(</span><span class="nx">flattened</span><span class="p">,</span> <span class="nx">numContainers</span><span class="o">-</span><span class="nx">gcPolicy</span><span class="p">.</span><span class="nx">MaxContainers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This code is the core logic of container GC, and it does something like this.</p>
<ul>
<li>first find the containers that can be cleaned from the running containers, including those that meet the cleanup criteria or are not recognized by the kubelet</li>
<li>directly delete containers that are not recognized and those whose pod information no longer exists</li>
<li>Delete the remaining containers according to the configured container deletion policy</li>
</ul>
<h2 id="image-gc">Image GC</h2>
<p>images mainly take up disk space, and although docker uses image tiering to allow multiple images to share storage, long-running nodes that download many images can take up too much storage space. If the images fill up the disk, the application will not work properly. docker does not clean up images by default, once they are downloaded, they will stay in the local area forever unless they are manually deleted.</p>
<p>In fact, many images are not actually used, so it&rsquo;s a huge waste of space and a huge risk that these unused images continue to take up space, so kubelet also cleans up images periodically.</p>
<p>Unlike containers, cleanup of images is based on the amount of space they occupy, and users can configure what percentage of storage space is occupied by a image before it is cleaned up. The cleanup will prioritize the longest unused images, and will update its recent usage time when it is pulled down or used by a container.</p>
<p>When starting a kubelet, you can configure these parameters to control the policy for image cleanup.</p>
<ul>
<li><code>image-gc-high-threshold</code>: the upper limit of disk usage that will trigger image cleanup when this usage is reached. The default value is 90%.</li>
<li><code>image-gc-low-threshold</code>: the lower limit of disk usage, each cleanup will not stop until the usage falls below this value or there are no more images to clean up. The default value is 80%.</li>
<li><code>minimum-image-ttl-duration</code>: the image will be cleaned up only if it has not been used for at least this long, configurable in h (hours), m (minutes), s (seconds) and ms (milliseconds) time units, default is 2m (two minutes)</li>
</ul>
<p>That is, by default, kubelet will clean up when the image fills 90% of the capacity of the disk it is on, until the image occupancy is below 80%.</p>
<h3 id="parameter-configuration">Parameter configuration</h3>
<p>Users can adjust the relevant thresholds to optimize image garbage collection using the following kubelet parameters.</p>
<ol>
<li><code>image-gc-high-threshold</code> , the percentage of disk usage that triggers image garbage collection. The default value is 8. If this value is set to 100, image garbage collection will be stopped.</li>
<li><code>image-gc-low-threshold</code>, the percentage of disk utilization reached after image garbage collection attempts to free resources. The default value is 80.</li>
<li><code>minimum-image-ttl-duration</code>, default 2m0s, the minimum age of the recycled image.</li>
</ol>
<p>The following events may be reported during garbage collection.</p>
<ul>
<li><code>ContainerGCFailed</code>: container garbage collection is executed every 1min, and this event is reported if the execution fails.</li>
<li><code>ImageGCFailed</code>: Image garbage collection is performed every 5min, and if it fails, the event is reported.</li>
<li><code>FreeDiskSpaceFailed</code> : Report this exception if the cleaned space does not meet the requirement when executing image garbage collection.</li>
<li><code>InvalidDiskCapacity</code> : Report this exception if the image disk capacity is 0.</li>
</ul>
<h3 id="imagegcmanager">ImageGCManager</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ImageGCManager</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行垃圾回收策略，如果根据垃圾回收策略不能释放足够的空间，则会返回 error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">GarbageCollect</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启动异步垃圾镜像回收
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">GetImageList</span><span class="p">()</span> <span class="p">([]</span><span class="nx">container</span><span class="p">.</span><span class="nx">Image</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 删除所有无用镜像
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">DeleteUnusedImages</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="initialization">Initialization</h3>
<p>The ImageGCManager is initialized in the <code>kubelet.NewMainKubelet()</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// setup imageManager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">imageManager</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">images</span><span class="p">.</span><span class="nf">NewImageGCManager</span><span class="p">(</span><span class="nx">klet</span><span class="p">.</span><span class="nx">containerRuntime</span><span class="p">,</span> <span class="nx">klet</span><span class="p">.</span><span class="nx">StatsProvider</span><span class="p">,</span> <span class="nx">kubeDeps</span><span class="p">.</span><span class="nx">Recorder</span><span class="p">,</span> <span class="nx">nodeRef</span><span class="p">,</span> <span class="nx">imageGCPolicy</span><span class="p">,</span> <span class="nx">crOptions</span><span class="p">.</span><span class="nx">PodSandboxImage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to initialize image manager: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">klet</span><span class="p">.</span><span class="nx">imageManager</span> <span class="p">=</span> <span class="nx">imageManager</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="realimagegcmanagerstart">realImageGCManager.Start()</h3>
<p>ImageGCManager is started in the <code>kubelet.initializeModules()</code> method. imageGCManager starts performing two tasks asynchronously after starting.</p>
<ul>
<li>Update the information about the list of images in use every 5min.</li>
<li>Update the image cache every 30s.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">im</span> <span class="o">*</span><span class="nx">realImageGCManager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">ts</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">im</span><span class="p">.</span><span class="nx">initialized</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ts</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">im</span><span class="p">.</span><span class="nf">detectImages</span><span class="p">(</span><span class="nx">ts</span><span class="p">)</span> <span class="c1">// 更新缓存镜像列表，并返回正在使用的镜像列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;[imageGCManager] Failed to monitor images: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">im</span><span class="p">.</span><span class="nx">initialized</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> <span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span> <span class="c1">// 每5min探测一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 每30s更新一次镜像缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">images</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">im</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">ListImages</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;[imageGCManager] Failed to update image list: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">im</span><span class="p">.</span><span class="nx">imageCache</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">images</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="start-garbage-collection">Start garbage collection</h3>
<p>When the kubelet is started, it opens a garbage collection asynchronous thread. It will</p>
<ul>
<li>
<p>perform a container garbage collection every 1min, and report the event ContainerGCFailed if it fails.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kl</span> <span class="o">*</span><span class="nx">Kubelet</span><span class="p">)</span> <span class="nf">StartGarbageCollection</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">loggedContainerGCFailure</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">containerGC</span><span class="p">.</span><span class="nf">GarbageCollect</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">// 每 1min 执行一次容器垃圾回收，如果执行失败，则上报事件 ContainerGCFailed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Container garbage collection failed: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">kl</span><span class="p">.</span><span class="nx">recorder</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">kl</span><span class="p">.</span><span class="nx">nodeRef</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">ContainerGCFailed</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="nx">loggedContainerGCFailure</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">vLevel</span> <span class="nx">klog</span><span class="p">.</span><span class="nx">Level</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">loggedContainerGCFailure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">vLevel</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="nx">loggedContainerGCFailure</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">vLevel</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Container garbage collection succeeded&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">ContainerGCPeriod</span><span class="p">,</span> <span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果 --image-gc-high-threshold=100，则会停止镜像垃圾回收。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">kubeletConfiguration</span><span class="p">.</span><span class="nx">ImageGCHighThresholdPercent</span> <span class="o">==</span> <span class="mi">100</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;ImageGCHighThresholdPercent is set 100, Disable image GC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">prevImageGCFailed</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kl</span><span class="p">.</span><span class="nx">imageManager</span><span class="p">.</span><span class="nf">GarbageCollect</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// 每 5min 执行一次镜像垃圾回收，如果执行失败，则上报 ImageGCFailed 事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">prevImageGCFailed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Image garbage collection failed multiple times in a row: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Only create an event for repeated failures
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">kl</span><span class="p">.</span><span class="nx">recorder</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">kl</span><span class="p">.</span><span class="nx">nodeRef</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">ImageGCFailed</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Image garbage collection failed once. Stats initialization may not have completed yet: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">prevImageGCFailed</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">vLevel</span> <span class="nx">klog</span><span class="p">.</span><span class="nx">Level</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">prevImageGCFailed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">vLevel</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="nx">prevImageGCFailed</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">vLevel</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Image garbage collection succeeded&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">ImageGCPeriod</span><span class="p">,</span> <span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="realimagegcmanagergarbagecollect">realImageGCManager.GarbageCollect()</h4>
<p>The execution of image garbage collection is as follows</p>
<ol>
<li>get the image disk information from <code>cadvisor</code>.</li>
<li>calculate the disk capacity and disk utilization.</li>
<li>if the disk utilization reaches the upper limit set by <code>--image-gc-high-threshold</code>, then image garbage collection is performed.</li>
<li>if the space freed after image garbage collection does not reach the expected value, report a <code>-FreeDiskSpaceFailed</code> exception event.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">im</span> <span class="o">*</span><span class="nx">realImageGCManager</span><span class="p">)</span> <span class="nf">GarbageCollect</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 从 cadvisor 获取 image 磁盘信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fsStats</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">im</span><span class="p">.</span><span class="nx">statsProvider</span><span class="p">.</span><span class="nf">ImageFsStats</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">capacity</span><span class="p">,</span> <span class="nx">available</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fsStats</span><span class="p">.</span><span class="nx">CapacityBytes</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// image 磁盘容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">capacity</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="o">*</span><span class="nx">fsStats</span><span class="p">.</span><span class="nx">CapacityBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fsStats</span><span class="p">.</span><span class="nx">AvailableBytes</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// image 磁盘可用空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">available</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="o">*</span><span class="nx">fsStats</span><span class="p">.</span><span class="nx">AvailableBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">available</span> <span class="p">&gt;</span> <span class="nx">capacity</span> <span class="p">{</span> <span class="c1">// 修正磁盘容量大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">klog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;available %d is larger than capacity %d&#34;</span><span class="p">,</span> <span class="nx">available</span><span class="p">,</span> <span class="nx">capacity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">available</span> <span class="p">=</span> <span class="nx">capacity</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check valid capacity.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">capacity</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// 如果磁盘容量为0，则上报 InvalidDiskCapacity 异常时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">goerrors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid capacity 0 on image filesystem&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">im</span><span class="p">.</span><span class="nx">recorder</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">im</span><span class="p">.</span><span class="nx">nodeRef</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">InvalidDiskCapacity</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">usagePercent</span> <span class="o">:=</span> <span class="mi">100</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nx">available</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="nx">capacity</span><span class="p">)</span> <span class="c1">// 磁盘使用率达到上限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">usagePercent</span> <span class="o">&gt;=</span> <span class="nx">im</span><span class="p">.</span><span class="nx">policy</span><span class="p">.</span><span class="nx">HighThresholdPercent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">amountToFree</span> <span class="o">:=</span> <span class="nx">capacity</span><span class="o">*</span><span class="nb">int64</span><span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="nx">im</span><span class="p">.</span><span class="nx">policy</span><span class="p">.</span><span class="nx">LowThresholdPercent</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span> <span class="o">-</span> <span class="nx">available</span> <span class="c1">// 计算要清理的磁盘空间大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;[imageGCManager]: Disk usage on image filesystem is at %d%% which is over the high threshold (%d%%). Trying to free %d bytes down to the low threshold (%d%%).&#34;</span><span class="p">,</span> <span class="nx">usagePercent</span><span class="p">,</span> <span class="nx">im</span><span class="p">.</span><span class="nx">policy</span><span class="p">.</span><span class="nx">HighThresholdPercent</span><span class="p">,</span> <span class="nx">amountToFree</span><span class="p">,</span> <span class="nx">im</span><span class="p">.</span><span class="nx">policy</span><span class="p">.</span><span class="nx">LowThresholdPercent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">freed</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">im</span><span class="p">.</span><span class="nf">freeSpace</span><span class="p">(</span><span class="nx">amountToFree</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span> <span class="c1">// 清理镜像，并返回清理的空间大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">freed</span> <span class="p">&lt;</span> <span class="nx">amountToFree</span> <span class="p">{</span> <span class="c1">// 如果被清理空间不满足要求，则上报 FreeDiskSpaceFailed 异常事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to garbage collect required amount of images. Wanted to free %d bytes, but freed %d bytes&#34;</span><span class="p">,</span> <span class="nx">amountToFree</span><span class="p">,</span> <span class="nx">freed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">im</span><span class="p">.</span><span class="nx">recorder</span><span class="p">.</span><span class="nf">Eventf</span><span class="p">(</span><span class="nx">im</span><span class="p">.</span><span class="nx">nodeRef</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">EventTypeWarning</span><span class="p">,</span> <span class="nx">events</span><span class="p">.</span><span class="nx">FreeDiskSpaceFailed</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="freeing-disk-space-freespace">Freeing disk space (freeSpace)</h4>
<p>The detailed process of image garbage collection is documented here.</p>
<ol>
<li>list all images that are not in use.</li>
<li>install the last used time and detection time sorted from far to near.</li>
<li>iterate through the list and clean up the images by time from far to near.</li>
<li>again determine, if the image is in use, then do not clean up. Determine when the image was first probed to avoid cleaning up the image with a short pull time, because these images may have just been pulled down and will soon be used by a container.</li>
<li>call the runtime interface to delete useless images until enough space is freed up.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">im</span> <span class="o">*</span><span class="nx">realImageGCManager</span><span class="p">)</span> <span class="nf">freeSpace</span><span class="p">(</span><span class="nx">bytesToFree</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">freeTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">imagesInUse</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">im</span><span class="p">.</span><span class="nf">detectImages</span><span class="p">(</span><span class="nx">freeTime</span><span class="p">)</span> <span class="c1">// 更新正在使用的镜像列表，并返回正在使用的镜像列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">im</span><span class="p">.</span><span class="nx">imageRecordsLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">im</span><span class="p">.</span><span class="nx">imageRecordsLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 列出所有没在使用的镜像
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">images</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">evictionInfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">im</span><span class="p">.</span><span class="nx">imageRecords</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">record</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">im</span><span class="p">.</span><span class="nx">imageRecords</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nf">isImageUsed</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span> <span class="nx">imagesInUse</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Image ID %s is being used&#34;</span><span class="p">,</span> <span class="nx">image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">images</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">images</span><span class="p">,</span> <span class="nx">evictionInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span><span class="p">:</span>          <span class="nx">image</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">imageRecord</span><span class="p">:</span> <span class="o">*</span><span class="nx">record</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nf">byLastUsedAndDetected</span><span class="p">(</span><span class="nx">images</span><span class="p">))</span>  <span class="c1">// 按照最后使用时间和探测时间排序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 删除无用的镜像，直到释放足够的空间为止
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">deletionErrors</span> <span class="p">[]</span><span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spaceFreed</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">image</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">images</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Evaluating image ID %s for possible garbage collection&#34;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 再次判断镜像是否正在使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">image</span><span class="p">.</span><span class="nx">lastUsed</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">freeTime</span><span class="p">)</span> <span class="o">||</span> <span class="nx">image</span><span class="p">.</span><span class="nx">lastUsed</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">freeTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Image ID %s has lastUsed=%v which is &gt;= freeTime=%v, not eligible for garbage collection&#34;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">lastUsed</span><span class="p">,</span> <span class="nx">freeTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 避免清理拉取时间较短的镜像，因为这些镜像可能刚被拉取下来，马上要被某个容器使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">freeTime</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">firstDetected</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">im</span><span class="p">.</span><span class="nx">policy</span><span class="p">.</span><span class="nx">MinAge</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Image ID %s has age %v which is less than the policy&#39;s minAge of %v, not eligible for garbage collection&#34;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">freeTime</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">firstDetected</span><span class="p">),</span> <span class="nx">im</span><span class="p">.</span><span class="nx">policy</span><span class="p">.</span><span class="nx">MinAge</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 清理镜像，即便发生error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;[imageGCManager]: Removing image %q to free %d bytes&#34;</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">im</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">RemoveImage</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">ImageSpec</span><span class="p">{</span><span class="nx">Image</span><span class="p">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">deletionErrors</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">deletionErrors</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">delete</span><span class="p">(</span><span class="nx">im</span><span class="p">.</span><span class="nx">imageRecords</span><span class="p">,</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">spaceFreed</span> <span class="o">+=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">size</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">spaceFreed</span> <span class="o">&gt;=</span> <span class="nx">bytesToFree</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">deletionErrors</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">spaceFreed</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;wanted to free %d bytes, but freed %d bytes space with errors in image deletion: %v&#34;</span><span class="p">,</span> <span class="nx">bytesToFree</span><span class="p">,</span> <span class="nx">spaceFreed</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">NewAggregate</span><span class="p">(</span><span class="nx">deletionErrors</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">spaceFreed</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/icp-terms/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Understand some of the terms used in ICP programming</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/memory-ballast-gc-tuner/">
            <span class="next-text nav-default">memory ballast and gc tuner are history</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
