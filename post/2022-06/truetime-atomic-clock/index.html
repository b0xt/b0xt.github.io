<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>TrueTime and Atomic Clocks - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore TrueTime and atomic clocks." /><meta name="keywords" content="TrueTime, Atomic Clocks" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/truetime-atomic-clock/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="TrueTime and Atomic Clocks" />
<meta property="og:description" content="Explore TrueTime and atomic clocks." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/truetime-atomic-clock/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-19T11:55:22+08:00" />
<meta property="article:modified_time" content="2022-06-19T11:55:22+08:00" />

<meta itemprop="name" content="TrueTime and Atomic Clocks">
<meta itemprop="description" content="Explore TrueTime and atomic clocks."><meta itemprop="datePublished" content="2022-06-19T11:55:22+08:00" />
<meta itemprop="dateModified" content="2022-06-19T11:55:22+08:00" />
<meta itemprop="wordCount" content="1651">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="TrueTime and Atomic Clocks"/>
<meta name="twitter:description" content="Explore TrueTime and atomic clocks."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">TrueTime and Atomic Clocks</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-19 11:55:22 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1651 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#network-clock-synchronization">Network Clock Synchronization</a></li>
        <li><a href="#marzullo-algorithm">Marzullo algorithm</a></li>
        <li><a href="#clock-drift">Clock drift</a></li>
        <li><a href="#atomic-clock">Atomic clock</a></li>
        <li><a href="#gps-timing">GPS Timing</a></li>
        <li><a href="#truetime">TrueTime</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>If you are concerned about distributed databases, I believe you have more or less heard of Google&rsquo;s distributed database Spanner, and how Spanner uses atomic clocks to make a set of TrueTime to achieve distributed transactions across data centers.</p>
<p>Many people have the impression that Google is so rich that it can afford to use atomic clocks as a sophisticated high-end device. This statement cannot be said to be entirely wrong, but at least it is not completely accurate.</p>
<h2 id="network-clock-synchronization">Network Clock Synchronization</h2>
<p>The underlying logic of the 3 timestamp fetching methods mentioned above is very different. tiDB&rsquo;s TSO is central timing, every timestamp has to be fetched from the central server; CockroachDB&rsquo;s HLC is essentially a logical clock, relying on message exchange to advance the clock counter; Spanner&rsquo;s TrueTime is clock synchronization, by periodically exchanging messages, the The local clock is synchronized with the source clock by exchanging messages periodically.</p>
<p>The clock synchronization model is similar to the way we use our watches every day. We synchronize our watches with the news feed every once in a while, and the time during that period is read out directly from the watch.</p>
<p>The most common clock synchronization inside the computer is NTP, synchronizing the clock through the network has a problem is the error caused by the delay.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/4b3de3acd37d45c5a90038c29d7ef64e.png" alt="NTP"></p>
<p>For example, if the client initiates a query request at 12:00:00, and receives a message from the server 2 seconds later, the time returned is also 12:00:00. This does not mean that the local clock is accurate, because it takes time to send the message to the server, the local clock is actually a little faster. But exactly how much faster is impossible to know, we only know that the message took 2 seconds to come and go, but do not know how long it took to come and go respectively. So we can only approximate a middle value, dial back the time by 1 second, and then the error range is Â± 1 second.</p>
<h2 id="marzullo-algorithm">Marzullo algorithm</h2>
<p>Synchronizing time only from a single time source is not reliable enough. Besides the possibility of failure or network outage, what is worse is that the time source itself goes wrong. The <a href="https://en.wikipedia.org/wiki/Marzullo%27s_algorithm">Marzullo algorithm</a> is the algorithm used to estimate the exact time from multiple time sources.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/4eb7b1deda8747e3ac2bac251e13bb74.png" alt="Marzullo algorithm"></p>
<p>As shown in the figure, we get the clock deviation and error range by querying the time from each of the four time sources ABCD. The general idea of the algorithm is to select the intervals that are covered by as many time sources as possible (narrowing the error range) and to exclude the problematic intervals (e.g., A).</p>
<p>However, in scenarios with strict timing requirements (e.g., distributed transactions), the Marzullo algorithm has to undergo some refinements. For example, a more obvious drawback is that when the problematic time sourceoffset interval overlaps with the normal interval, it may lead to the error range being estimated too small. If you want to know the relevant details, you can go to study the <a href="http://infolab.stanford.edu/pub/cstr/reports/csl/tr/83/247/CSL-TR-83-247.pdf">related materials</a>, which will not be expanded here.</p>
<h2 id="clock-drift">Clock drift</h2>
<p>It&rsquo;s not over when the time is set with the server. Usually the timing process is triggered periodically. Just as our watches become inaccurate over time, the CPU&rsquo;s crystal cycle is not completely accurate, and is affected by temperature and voltage, and can &ldquo;drift&rdquo; over time.</p>
<p>Spanner assumes that the error of his server is not more than 200Î¼s per second, according to the maximum value to calculate, 30 seconds out of sync, the error will accumulate up to 6ms. if 1 day out of sync, the maximum error reaches about 17s. note that the error range here is very, very conservative, the actual situation of the CPU is far from being so bad, for example, to compare, China&rsquo;s quartz electronic watch Industry standards are, a class of monthly difference of 10-15 seconds, the second class of monthly difference of 20-30 seconds.</p>
<h2 id="atomic-clock">Atomic clock</h2>
<blockquote>
<p>Atomic clock, a device that uses the difference in energy levels of atoms and molecules as a reference signal to calibrate the frequency of a crystal oscillator or laser in order to make it output a standard frequency signal. It works by using the electromagnetic waves emitted by atoms when they absorb or release energy to keep time. Since this electromagnetic wave is very stable and controlled by a series of precision instruments, the timing of atomic clocks can be very accurate, reaching a level of only one second or better in 10 million years.</p>
</blockquote>
<p>It does look very high-end, so how much would it cost if you wanted to buy such an atomic clock? The reality is that atomic clocks are much more affordable than they sound, and we can search for them directly on e-commerce sites.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/93040fb5bba14c2bba943a9b99e235f1.png" alt="Atomic clock"></p>
<p>The price is about tens of thousands to more than a hundred thousand ranging, not unaffordable expensive, and a high-end point of the server is about the same price, if you reduce the accuracy requirements can be cheaper.</p>
<p>To put it bluntly, atomic clocks and computers everywhere above the crystal oscillator is the same kind of thing, but the precision is several orders of magnitude higher.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/95b73eb3587249b5a713e94eca0b99e1.png" alt="Timing accuracy with different hardware"></p>
<p>Note that some people mistakenly believe that TrueTime requires each machine to be equipped with an atomic clock, in fact, there is no need, a data center has a few is completely sufficient. The specific reasons for this will be discussed later.</p>
<h2 id="gps-timing">GPS Timing</h2>
<p>GPS not only provides positioning services, but also timing. Each GPS satellite carries several high-precision atomic clocks and continuously broadcasts ephemeris (orbit) and time. After the ground device receives signals from at least 4 satellites, it solves a system of quadratic equations with 3-dimensional space + 1-dimensional time as variables to get the time-space information at the same time.</p>
<p>The accuracy of GPS is so high that the error can be controlled within a few nanoseconds. This is because the electromagnetic wave signal is basically a straight line propagation, the path of interference is very small, according to the distance can be very accurate calculation of the signal transmission delay. Network messages are affected by relay and multi-layer network packets, and even in fiber optics, the signal does not travel in a straight line.</p>
<h2 id="truetime">TrueTime</h2>
<p>With the background knowledge out of the way, let&rsquo;s take a look at what TrueTime actually does.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/b4544c1993c746108e59c43471ad295e.png" alt="TrueTime component deployment in the server room"></p>
<p>The TrueTime component is divided by role into time master and time daemon. time master can be thought of as the server side of TrueTime, deployed on a number of separate machines, and time daemon is the client side, deployed as a process on each host where the service is actually running.</p>
<p>The time master is divided into two categories. One type installs GPS modules, which are scattered in different locations in the server room, and each GPS node uses an independent antenna to avoid failing together due to signal interference. The other category is the installation of atomic clocks, which are also multiple units to prevent failures from generating unavailability.</p>
<p>Various time masters periodically use the Marzullo algorithm to time match each other, and each time daemon will also time match with multiple time masters in 30-second intervals (also using the Marzullo algorithm).</p>
<p>As introduced before, the accuracy of GPS is nanosecond level, this error is negligible compared with the network latency in the server room, directly counted as 0ms. so that the time daemon to synchronize the clock after the error depends only on the network latency, usually no more than 1ms in the server room.</p>
<p>We also need to take into account the completion of the clock synchronization, to the next synchronization period time daemon clock drift, that is, the previous calculation, the maximum error within 30 seconds may accumulate to 6ms. so, time daemon on the clock error range between 1ms to 7ms constantly rise and fall, drawn out in such a jagged shape:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/0467a27eb5d944b6b2ebdb2cc3a18948.png" alt="Time daemon error range variation diagram"></p>
<p>So the question arises, what is the atomic clock for?</p>
<p>In short, the atomic clock is a backup for GPS, which is susceptible to weather and electromagnetic signal interference, and in extreme cases, the entire GPS system may fail or be shut down due to war (GPS is a military facility), which is when the atomic clock comes in handy.</p>
<p>It is not written in detail in the paper, but it is speculated that the logic of synchronizing the atomic clock with the GPS node should be similar to that of time daemon, i.e., the effect is also to fall back to around 1ms periodically. The difference is that when the GPS fails, the error growth rate of the atomic clock is much smaller than that of a normal machine, so it can replace it and provide clock synchronization services offline as a data source for the data center.</p>
<h2 id="summary">Summary</h2>
<p>Back to the original question: Why is Spanner the only one that uses the TrueTime design? It&rsquo;s not because the atomic clock is so far out of reach; TrueTime is an elaborate and complex set of facilities, and the atomic clock is only one of the somewhat critical components.</p>
<p>In the case of TiDB, we did not have the resources or the opportunity to design and build a complete server room from scratch to support this system, so we had to choose an alternative solution. But TrueTime&rsquo;s design concept and ideas are worth learning and absorbing!</p>
<p>The biggest contribution of TrueTime is to provide the time error range as an API to the upper layer, with careful design at the transaction level to achieve demanding transaction consistency. We can neither fundamentally eliminate the error nor calculate the error range exactly, but cleverly use the determined error upper bound as a breakthrough point to solve the problem elegantly!</p>
<p>Here is the beauty of distributed systems: we are faced with near-desperate uncertainty, yet with faith, reason, and intelligence, we can build highly reliable, unquestionable systems on such a fragile foundation.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/api-server/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The process of apiserver processing requests</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/containerd-boot-process/">
            <span class="next-text nav-default">The boot process of containerd</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
