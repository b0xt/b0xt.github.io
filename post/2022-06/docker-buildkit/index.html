<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Accelerating Image Compilation with Docker BuildKit - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Docker BuildKit to accelerate compiling images." /><meta name="keywords" content="docker, Buildkit" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/docker-buildkit/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Accelerating Image Compilation with Docker BuildKit" />
<meta property="og:description" content="Learn how to use Docker BuildKit to accelerate compiling images." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/docker-buildkit/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-03T11:02:14+08:00" />
<meta property="article:modified_time" content="2022-06-03T11:02:14+08:00" />

<meta itemprop="name" content="Accelerating Image Compilation with Docker BuildKit">
<meta itemprop="description" content="Learn how to use Docker BuildKit to accelerate compiling images."><meta itemprop="datePublished" content="2022-06-03T11:02:14+08:00" />
<meta itemprop="dateModified" content="2022-06-03T11:02:14+08:00" />
<meta itemprop="wordCount" content="1243">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Accelerating Image Compilation with Docker BuildKit"/>
<meta name="twitter:description" content="Learn how to use Docker BuildKit to accelerate compiling images."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Accelerating Image Compilation with Docker BuildKit</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-03 11:02:14 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1243 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#prepare-beforehand">Prepare beforehand</a></li>
        <li><a href="#compile-without-buildkit">Compile without BuildKit</a></li>
        <li><a href="#compiling-with-buildkit">Compiling with BuildKit</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Now the deployment of the compilation process will certainly use Docker, regardless of testing and deployment are implemented in Docker as far as possible, to achieve environmental isolation. But how to shorten Docker in the compilation of Image time, this is a problem, this article to introduce you to an experimental feature is <a href="https://docs.docker.com/develop/develop-images/build_enhancements/">BuildKit</a>.</p>
<h2 id="prepare-beforehand">Prepare beforehand</h2>
<p>Since <a href="https://docs.docker.com/develop/develop-images/build_enhancements/">BuildKit</a> is an experimental feature, the default installation of Docker will not enable this feature. Currently, only compiled Linux containers are supported. Please use the following method to start it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">DOCKER_BUILDKIT</span><span class="o">=</span><span class="m">1</span> docker build .
</span></span></code></pre></td></tr></table>
</div>
</div><p>After placing the command, you will see that the whole output result is different, the interface looks better, and you can see how long each layer takes to compile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[+] Building 0.1s (15/15) FINISHED                                                                                     
</span></span><span class="line"><span class="cl"> =&gt; [internal] load .dockerignore                                                                                 0.0s
</span></span><span class="line"><span class="cl"> =&gt; =&gt; transferring context: 2B                                                                                   0.0s
</span></span><span class="line"><span class="cl"> =&gt; [internal] load build definition from Dockerfile                                                              0.0s
</span></span><span class="line"><span class="cl"> =&gt; =&gt; transferring dockerfile: 545B                                                                              0.0s
</span></span><span class="line"><span class="cl"> =&gt; [internal] load metadata for docker.io/library/golang:1.14-alpine                                             0.0s
</span></span><span class="line"><span class="cl"> =&gt; [1/10] FROM docker.io/library/golang:1.14-alpine                                                              0.0s
</span></span><span class="line"><span class="cl"> =&gt; [internal] load build context                                                                                 0.0s
</span></span><span class="line"><span class="cl"> =&gt; =&gt; transferring context: 184B                                                                                 0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [2/10] RUN apk add bash ca-certificates git gcc g++ libc-dev                                           0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [3/10] WORKDIR /app                                                                                    0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [4/10] COPY go.mod .                                                                                   0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [5/10] COPY go.sum .                                                                                   0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [6/10] RUN go mod download                                                                             0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [7/10] COPY main.go .                                                                                  0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [8/10] COPY foo/foo.go foo/                                                                            0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [9/10] COPY bar/bar.go bar/                                                                            0.0s
</span></span><span class="line"><span class="cl"> =&gt; CACHED [10/10] RUN go build -o /app -v -tags netgo -ldflags &#39;-w -extldflags &#34;-static&#34;&#39; .                      0.0s
</span></span><span class="line"><span class="cl"> =&gt; exporting to image                                                                                            0.0s
</span></span><span class="line"><span class="cl"> =&gt; =&gt; exporting layers                                                                                           0.0s
</span></span><span class="line"><span class="cl"> =&gt; =&gt; writing image sha256:6cc56539b3191d5efd87fb4d05181993d013411299b5cefb74047d2447b4d0c9                      0.0s
</span></span><span class="line"><span class="cl"> =&gt; =&gt; naming to docker.io/appleboy/demo                                                                          0.0s
</span></span></code></pre></td></tr></table>
</div>
</div><p>For a detailed compilation step, please add <code>--progress=plain</code> to see the detailed process. In fact, I think the point is that each step actually adds time, which is very helpful in development or CI/CD process. In addition, you can add config to the docker daemon so that you don&rsquo;t have to add the <code>DOCKER_BUILDKIT</code> environment variable.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;debug&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;experimental&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;features&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;buildkit&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Please remember to restart Docker for the new settings to take effect.</p>
<h2 id="compile-without-buildkit">Compile without BuildKit</h2>
<p>Let&rsquo;s test the basic Go language example to see how much time is saved. The code can be found <a href="https://github.com/go-training/docker-buildkit-demo">here</a>, and the examples are below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;gin/bar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;gin/foo&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;pong&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping2&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;pong2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping100&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="nx">foo</span><span class="p">.</span><span class="nf">Foo</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping101&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="nx">bar</span><span class="p">.</span><span class="nf">Bar</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span> <span class="c1">// listen and serve on 0.0.0.0:8080 (for windows &#34;localhost:8080&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then write the Dockerfile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> golang:1.14-alpine</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">LABEL</span> <span class="nv">maintainer</span><span class="o">=</span><span class="s2">&#34;Bo-Yi Wu &lt;appleboy.tw@gmail.com&gt;&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apk add bash ca-certificates git gcc g++ libc-dev<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Force the go compiler to use modules</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on
</span></span><span class="line"><span class="cl"><span class="c"># We want to populate the module cache based on the go.{mod,sum} files.</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.mod .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.sum .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> main.go .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> foo/foo.go foo/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> bar/bar.go bar/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">GOOS</span><span class="o">=</span>linux
</span></span><span class="line"><span class="cl"><span class="k">ENV</span> <span class="nv">GOARCH</span><span class="o">=</span>amd64
</span></span><span class="line"><span class="cl"><span class="k">RUN</span> go build -o /app -v -tags netgo -ldflags <span class="s1">&#39;-w -extldflags &#34;-static&#34;&#39;</span> .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/app&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, if there is no change in go.mode and go.sum, basically the go module file can be processed through the docker cache layer. But every time there is any change in the code, the final go build will be compiled from scratch, please see the result below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">docker build --progress=plain -t appleboy/docker-demo -f Dockerfile .
</span></span><span class="line"><span class="cl">#14 [10/10] RUN go build -o /app -v -tags netgo -ldflags &#39;-w -extldflags &#34;-s...
</span></span><span class="line"><span class="cl">#14 0.391 gin/foo
</span></span><span class="line"><span class="cl">#14 0.403 gin/bar
</span></span><span class="line"><span class="cl">#14 0.412 github.com/go-playground/locales/currency
</span></span><span class="line"><span class="cl">#14 0.438 github.com/gin-gonic/gin/internal/bytesconv
</span></span><span class="line"><span class="cl">#14 0.441 github.com/go-playground/locales
</span></span><span class="line"><span class="cl">#14 0.449 golang.org/x/sys/unix
</span></span><span class="line"><span class="cl">#14 0.464 net
</span></span><span class="line"><span class="cl">#14 0.471 github.com/gin-gonic/gin/internal/json
</span></span><span class="line"><span class="cl">#14 0.508 github.com/go-playground/universal-translator
</span></span><span class="line"><span class="cl">#14 0.511 github.com/leodido/go-urn
</span></span><span class="line"><span class="cl">#14 0.694 github.com/golang/protobuf/proto
</span></span><span class="line"><span class="cl">#14 0.754 gopkg.in/yaml.v2
</span></span><span class="line"><span class="cl">#14 1.535 github.com/mattn/go-isatty
</span></span><span class="line"><span class="cl">#14 1.789 net/textproto
</span></span><span class="line"><span class="cl">#14 1.790 crypto/x509
</span></span><span class="line"><span class="cl">#14 1.920 vendor/golang.org/x/net/http/httpproxy
</span></span><span class="line"><span class="cl">#14 1.978 vendor/golang.org/x/net/http/httpguts
</span></span><span class="line"><span class="cl">#14 2.019 github.com/go-playground/validator/v10
</span></span><span class="line"><span class="cl">#14 2.434 crypto/tls
</span></span><span class="line"><span class="cl">#14 3.043 net/http/httptrace
</span></span><span class="line"><span class="cl">#14 3.085 net/http
</span></span><span class="line"><span class="cl">#14 4.211 net/rpc
</span></span><span class="line"><span class="cl">#14 4.212 github.com/gin-contrib/sse
</span></span><span class="line"><span class="cl">#14 4.212 net/http/httputil
</span></span><span class="line"><span class="cl">#14 4.372 github.com/ugorji/go/codec
</span></span><span class="line"><span class="cl">#14 6.322 github.com/gin-gonic/gin/binding
</span></span><span class="line"><span class="cl">#14 6.322 github.com/gin-gonic/gin/render
</span></span><span class="line"><span class="cl">#14 6.517 github.com/gin-gonic/gin
</span></span><span class="line"><span class="cl">#14 6.819 gin
</span></span><span class="line"><span class="cl">#14 DONE 7.8s
</span></span></code></pre></td></tr></table>
</div>
</div><p>It took a total of 7.8 seconds, but think about it, when you develop on your own computer, it will not take that long, but will only be compiled based on the corrected Go files, but how can you do that in the CI/CD process? In fact, we can find that the compiled files are cached in the computer. In Linux environment, it will be <code>/root/.cache/go-build</code>. How can we speed up the compilation with buildKit?</p>
<h2 id="compiling-with-buildkit">Compiling with BuildKit</h2>
<p>Let&rsquo;s take a look at how Dockerfile can be improved to speed up compilation. Take a look at the following</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="c"># syntax = docker/dockerfile:experimental</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> golang:1.14-alpine</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">LABEL</span> <span class="nv">maintainer</span><span class="o">=</span><span class="s2">&#34;Bo-Yi Wu &lt;appleboy.tw@gmail.com&gt;&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,target<span class="o">=</span>/var/cache/apk apk add bash ca-certificates git gcc g++ libc-dev<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># Force the go compiler to use modules</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">GO111MODULE</span><span class="o">=</span>on
</span></span><span class="line"><span class="cl"><span class="c"># We want to populate the module cache based on the go.{mod,sum} files.</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.mod .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.sum .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,target<span class="o">=</span>/go/pkg/mod go mod download<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> main.go .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> foo/foo.go foo/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> bar/bar.go bar/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">GOOS</span><span class="o">=</span>linux
</span></span><span class="line"><span class="cl"><span class="k">ENV</span> <span class="nv">GOARCH</span><span class="o">=</span>amd64
</span></span><span class="line"><span class="cl"><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,target<span class="o">=</span>/go/pkg/mod --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,target<span class="o">=</span>/root/.cache/go-build go build -o /app -v -tags netgo -ldflags <span class="s1">&#39;-w -extldflags &#34;-static&#34;&#39;</span> .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/app&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>To the first line is necessary to fill in the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># syntax = docker/dockerfile:experimental</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then use the <code>-mount</code> method to cache the file, which can be done at any <code>RUN</code> step. So you can see that it is used in go build.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Dockerfile" data-lang="Dockerfile"><span class="line"><span class="cl"><span class="k">RUN</span> --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,target<span class="o">=</span>/go/pkg/mod <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --mount<span class="o">=</span><span class="nv">type</span><span class="o">=</span>cache,target<span class="o">=</span>/root/.cache/go-build<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that this step will cache all the files after go module and build, so that next time when compiling, the files will be automatically placed in the corresponding location by default to speed up the compilation process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker build --progress<span class="o">=</span>plain -t appleboy/docker-buildkit -f Dockerfile.buildkit .
</span></span><span class="line"><span class="cl"><span class="c1">#16 [stage-0 10/10] RUN --mount=type=cache,target=/go/pkg/mod --mount=type=c...</span>
</span></span><span class="line"><span class="cl"><span class="c1">#16 0.381 gin/foo</span>
</span></span><span class="line"><span class="cl"><span class="c1">#16 0.447 gin</span>
</span></span><span class="line"><span class="cl"><span class="c1">#16 DONE 1.2s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that after modifying the file, the result of the compilation is exactly the same as on your own computer, shortening the time by six seconds, which is a lot of time saved in a large Go project.</p>
<h2 id="summary">Summary</h2>
<p>Now the CI/CD tools are not sure they all support docker buildKit, so you may have to do your own experiments to try it out, like the GitHub Action official also <a href="https://github.com/docker/github-actions/issues/12">does not support docker buildkit</a>. If you are setting up all your own, you can basically use docker buildKit + docker cache-from together, which will save a lot of time. <a href="https://github.com/go-training/docker-buildkit-demo">See here for code examples</a></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-shutdown-after-job-completely/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Finish the Job in the Worker before stopping the Go service</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/go-context/">
            <span class="next-text nav-default">Context Usage Scenarios and Introduction in Golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
