<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>A Loki built on top of ClickHouse - cLoki - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="cLoki is a more flexible Loki-compatible LogQL API built on top of ClickHouse." /><meta name="keywords" content="cLoki" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/cloki/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="A Loki built on top of ClickHouse - cLoki" />
<meta property="og:description" content="cLoki is a more flexible Loki-compatible LogQL API built on top of ClickHouse." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/cloki/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-04T13:00:46+08:00" />
<meta property="article:modified_time" content="2022-06-04T13:00:46+08:00" />

<meta itemprop="name" content="A Loki built on top of ClickHouse - cLoki">
<meta itemprop="description" content="cLoki is a more flexible Loki-compatible LogQL API built on top of ClickHouse."><meta itemprop="datePublished" content="2022-06-04T13:00:46+08:00" />
<meta itemprop="dateModified" content="2022-06-04T13:00:46+08:00" />
<meta itemprop="wordCount" content="547">
<meta itemprop="keywords" content="ClickHouse," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Loki built on top of ClickHouse - cLoki"/>
<meta name="twitter:description" content="cLoki is a more flexible Loki-compatible LogQL API built on top of ClickHouse."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">A Loki built on top of ClickHouse - cLoki</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-04 13:00:46 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 547 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#features">Features</a>
          <ul>
            <li><a href="#-logql-support">ðŸ”¥ LogQL support</a></li>
            <li><a href="#-log-streaming">â›½ Log Streaming</a></li>
            <li><a href="#tempo-support">Tempo Support</a></li>
          </ul>
        </li>
        <li><a href="#installation">Installation</a>
          <ul>
            <li><a href="#docker">Docker</a></li>
            <li><a href="#manual-installation">Manual Installation</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><strong><a href="https://github.com/lmangani/cLoki">cLoki</a></strong> is a more flexible Loki-compatible LogQL API built on top of ClickHouse.</p>
<ul>
<li>Built-in Explore UI and LogQL CLI for querying and extracting data.</li>
<li>Native Grafana and LogQL API for querying, processing, ingesting, tracking, and alerting.</li>
<li>Powerful pipeline to dynamically search, filter, and extract data from logs, events, and more.</li>
<li>Ingestion and push APIs compatible with LogQL, PromQL, InfluxDB, Elastic, etc.</li>
<li>Works with agents such as Promtail, Grafana-Agent, Vector, Logstash, Telegraf, etc.</li>
<li>Cloud-native, stateless design.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/04/c8e22121babc4672aa170c622da50541.png" alt="cLoki"></p>
<p>The <em>Loki API</em> and its native Grafana integration are excellent and easy to use - but we prefer <strong>ClickHouse</strong>.</p>
<p><strong>cLoki</strong> implements a full LogQL API that is cached by a fast bulk LUR on top of ClickHouse tables and relies on its columnar search and insert performance and reliable distribution and clustering capabilities for stored data. Like Loki, cLoki does not parse or index incoming logs, but instead groups log streams using the same tagging system as Prometheus.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/04/53fc6ebfb3924e7398efd97daa5ecc37.png" alt="cLoki"></p>
<h2 id="features">Features</h2>
<h3 id="-logql-support">ðŸ”¥ LogQL support</h3>
<p>cLoki implements LogQL queries to provide compatibility with the Loki API. grafana Loki data source can be used to query logs and display extracted time series locally, no additional plugins are required.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/04/a4c235965c87425daf767a7425f42273.png" alt="LogQL"></p>
<h3 id="-log-streaming">â›½ Log Streaming</h3>
<p>cLoki supports Push API input through the use of JSON or Protobuf, which is compatible with Promtail and any other Loki agent. In addition to this, cLoki can accept and convert logs and metrics inserts using Influx, Elastic, Tempo and other common API formats.</p>
<p>Our preferred tool for parsing and sending log streams to cLoki is <code>paStash</code>, which has extensive interpolation capabilities, can create labels and prune any log, and is recommended for sending logs in JSON format when working with metrics.</p>
<h3 id="tempo-support">Tempo Support</h3>
<p><strong>cLoki Pulse</strong> provides experimental support for the Grafana Tempo API, providing cross-degree ingestion and querying.</p>
<p>At the database level, Tempo Spans/Traces are stored as tagged logs and can be accessed from LogQL and Tempo APIs.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/04/06302aa73db44b05a8286f6eac67fa8d.png" alt="Tempo"></p>
<h2 id="installation">Installation</h2>
<h3 id="docker">Docker</h3>
<p>If you use Docker, just add our container to your Stack to send traffic. cLoki instances are stateless and load balancer friendly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">cloki</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">qxip/cloki:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;3100:3100&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">CLICKHOUSE_SERVER=http://user:pass@clickhouse:8123</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="manual-installation">Manual Installation</h3>
<p>Before doing a manual installation, the following requirements must be in place.</p>
<ul>
<li>The <code>clickhouse-server</code> service must come with HTTP+ authentication.</li>
<li><code>nodejs</code> 14.x or 16.x, with <code>npm</code> installed.</li>
</ul>
<p>Then install <code>cloki</code> and <code>pm2</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo npm install -g cloki pm2
</span></span></code></pre></td></tr></table>
</div>
</div><p>Start <code>cloki</code> with <code>pm2</code> and use your clickhouse-server instance to connect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">cd</span> <span class="k">$(</span>dirname <span class="k">$(</span>readlink -f <span class="sb">`</span>which cloki<span class="sb">`</span><span class="k">))</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="o">&amp;&amp;</span> <span class="nv">CLICKHOUSE_SERVER</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span> <span class="nv">CLICKHOUSE_AUTH</span><span class="o">=</span><span class="s2">&#34;default:password&#34;</span> <span class="nv">CLICKHOUSE_DB</span><span class="o">=</span><span class="s2">&#34;cloki&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  pm2 start cloki --name <span class="s2">&#34;cloki&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition, cloki instances can also be started and managed using the pm2 configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">apps</span> <span class="o">:</span> <span class="p">[{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span>   <span class="o">:</span> <span class="s2">&#34;cloki_custom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">script</span> <span class="o">:</span> <span class="s2">&#34;cd $(dirname $(readlink -f `which cloki`)) &amp;&amp; ./cloki.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;UUID&#34;</span><span class="o">:</span> <span class="s2">&#34;cloki_custom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CLICKHOUSE_SERVER&#34;</span><span class="o">:</span> <span class="s2">&#34;localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CLICKHOUSE_PORT&#34;</span><span class="o">:</span> <span class="mi">8123</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CLICKHOUSE_AUTH&#34;</span><span class="o">:</span> <span class="s2">&#34;default:password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CLICKHOUSE_DB&#34;</span><span class="o">:</span> <span class="s2">&#34;cloki_custom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CLOKI_USER&#34;</span><span class="o">:</span> <span class="s2">&#34;demo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;CLOKI_PASSWORD&#34;</span><span class="o">:</span> <span class="s2">&#34;demo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;LABELS_DAYS&#34;</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;SAMPLES_DAYS&#34;</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;PORT&#34;</span><span class="o">:</span> <span class="mi">3100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;DEBUG&#34;</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check service status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pm2 status cloki
</span></span></code></pre></td></tr></table>
</div>
</div><p>If there are no errors, then you can save your service and start it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pm2 save
</span></span><span class="line"><span class="cl">pm2 startup
</span></span></code></pre></td></tr></table>
</div>
</div><p>Of course, you can also deploy to Kubernetes. For more information on how to use cLoki, go to the official documentation page at <a href="https://github.com/lmangani/cLoki/wiki">https://github.com/lmangani/cLoki/wiki</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/clickhouse/">ClickHouse</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/minikube/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Want to learn k8s but don&#39;t have an environment? Build one easily with minikube</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/go-shutdown-after-job-completely/">
            <span class="next-text nav-default">Finish the Job in the Worker before stopping the Go service</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
