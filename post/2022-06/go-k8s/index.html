<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Controlling Kubernetes with client-go - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to control Kubernetes with client-go." /><meta name="keywords" content="client-go, Kubernetes" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/go-k8s/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Controlling Kubernetes with client-go" />
<meta property="og:description" content="Learn how to control Kubernetes with client-go." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/go-k8s/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-12T12:18:25+08:00" />
<meta property="article:modified_time" content="2022-06-12T12:18:25+08:00" />

<meta itemprop="name" content="Controlling Kubernetes with client-go">
<meta itemprop="description" content="Learn how to control Kubernetes with client-go."><meta itemprop="datePublished" content="2022-06-12T12:18:25+08:00" />
<meta itemprop="dateModified" content="2022-06-12T12:18:25+08:00" />
<meta itemprop="wordCount" content="1982">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Controlling Kubernetes with client-go"/>
<meta name="twitter:description" content="Learn how to control Kubernetes with client-go."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Controlling Kubernetes with client-go</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-12 12:18:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1982 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#getting-started">Getting Started</a>
          <ul>
            <li><a href="#accessing-the-api-and-viewing-the-list">Accessing the API and viewing the list</a></li>
          </ul>
        </li>
        <li><a href="#sdk-out-of-cluster-access">SDK out-of-cluster access</a></li>
        <li><a href="#sdk-intra-cluster-access">SDK intra-cluster access</a></li>
        <li><a href="#sdk-operations-on-k8s-various-resource-objects">SDK operations on k8s various resource objects</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/12/1d38153cbdf544a7ae406e6a09bc7721.png" alt="k8s Architecture"></p>
<p>Earlier I have built a local k3s cluster of two machines and deployed <em>Crawlab</em> (a distributed crawler management platform developed using Golang) to achieve a local distributed cluster service environment. After the service is up, we need Kubernetes to control the container nodes dynamically, monitor the container running status, and achieve even the expansion. Fortunately, Kubernetes directly provides python and golang clients, which can easily implement Kubernetes API operations. So let&rsquo;s get familiar with it together next, based on golng client Kubernetes control.</p>
<h2 id="getting-started">Getting Started</h2>
<h3 id="accessing-the-api-and-viewing-the-list">Accessing the API and viewing the list</h3>
<p>After understanding the basic architecture of Kubernetes and how it provides APIs, we need to know exactly what APIs Kubernetes provides.</p>
<p>For debugging purposes, we first need to run the <code>kubectl proxy</code> command locally. kube-apiserver will then listen on port 8001 locally, which provides an HTTP proxy for the Kubernetes API services.</p>
<p>At this point we can access.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl https://127.0.0.1:6443/api/v1
</span></span></code></pre></td></tr></table>
</div>
</div><p>View the corresponding API&rsquo;s provided.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;APIResourceList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;groupVersion&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;resources&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;bindings&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;singularName&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;namespaced&#34;</span>: true,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Binding&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;verbs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;create&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;componentstatuses&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;singularName&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;namespaced&#34;</span>: false,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;ComponentStatus&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;verbs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;get&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;list&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;shortNames&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cs&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Visit the <code>api/v1/pods</code> path and get all Pods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl https://127.0.0.1:6443/api/v1/pods
</span></span></code></pre></td></tr></table>
</div>
</div><p>response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;PodList&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;apiVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;v1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;selfLink&#34;</span><span class="p">:</span> <span class="s2">&#34;/api/v1/pods&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;resourceVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;614376&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;awesome-project-76788db95b-7ztwr&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;generateName&#34;</span><span class="p">:</span> <span class="s2">&#34;awesome-project-76788db95b-&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;selfLink&#34;</span><span class="p">:</span> <span class="s2">&#34;/api/v1/namespaces/default/pods/awesome-project-76788db95b-7ztwr&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;uid&#34;</span><span class="p">:</span> <span class="s2">&#34;4fdb6661-edbd-4fc6-bf71-1d2dadb3ffc1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;resourceVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;608545&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;creationTimestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-05-03T02:29:32Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;labels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;app&#34;</span><span class="p">:</span> <span class="s2">&#34;awesome-project&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;pod-template-hash&#34;</span><span class="p">:</span> <span class="s2">&#34;76788db95b&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="err">...</span>
</span></span><span class="line"><span class="cl">        <span class="err">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="err">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A more extensive list and description of the API can be found in the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.15/">official documentation</a>.</p>
<p>Kubernetes officially provides a Client SDK for the Go language, also known as <a href="https://github.com/kubernetes/client-go">client-go</a></p>
<h2 id="sdk-out-of-cluster-access">SDK out-of-cluster access</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置 k8s 集群外 kubeconfig 配置文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">kubeconfig</span> <span class="o">*</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kubeconfig</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;kubeconfig&#34;</span><span class="p">,</span> <span class="s">&#34;/etc/rancher/k3s/k3s.yaml&#34;</span><span class="p">,</span> <span class="s">&#34;absolute path to the kubeconfig file&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//在 kubeconfig 中使用当前上下文环境，config 获取支持 url 和 path 方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据指定的 config 创建一个新的 clientset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">clientset</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 通过实现 clientset 的 CoreV1Interface 接口列表中的 PodsGetter 接口方法 Pods(namespace string)返回 PodInterface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// PodInterface 接口拥有操作 Pod 资源的方法，例如 Create、Update、Get、List 等方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 注意：Pods() 方法中 namespace 不指定则获取 Cluster 所有 Pod 列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pods</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;There are %d pods in the k8s cluster\n&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pods</span><span class="p">.</span><span class="nx">Items</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">clientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Namespaces</span><span class="p">().</span><span class="nf">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取指定 namespace 中的 Pod 列表信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">namespace</span> <span class="o">:=</span> <span class="s">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pods</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Pods</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">List</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;\nThere are %d pods in namespaces %s\n&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pods</span><span class="p">.</span><span class="nx">Items</span><span class="p">),</span> <span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>kubeconfig defaults to <code>/etc/kubernetes/admin.conf</code>, and since I installed K3s the path here is <code>/etc/rancher/k3s/k3s.yaml</code>.</p>
</blockquote>
<p>Run the program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">There are <span class="m">15</span> pods in the k8s cluster
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">There are <span class="m">5</span> pods in namespaces crawlab
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="sdk-intra-cluster-access">SDK intra-cluster access</h2>
<p>In addition to the above methods, it is possible to run the client inside a k8s cluster to manipulate the resource type. Since you are running within a k8s cluster, you need to put the written code inside the image and then run the image container as a Pod within the k8s cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># cat main2.go</span>
</span></span><span class="line"><span class="cl">package main
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import <span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">    metav1 <span class="s2">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func main<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    // 通过集群内部配置创建 k8s 配置信息，通过 KUBERNETES_SERVICE_HOST 和 KUBERNETES_SERVICE_PORT 环境变量方式获取
</span></span><span class="line"><span class="cl">    // 若集群使用 TLS 认证方式，则默认读取集群内部 tokenFile 和 CAFile
</span></span><span class="line"><span class="cl">    // <span class="nv">tokenFile</span>  <span class="o">=</span> <span class="s2">&#34;/var/run/secrets/kubernetes.io/serviceaccount/token&#34;</span>
</span></span><span class="line"><span class="cl">    // <span class="nv">rootCAFile</span> <span class="o">=</span> <span class="s2">&#34;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&#34;</span>
</span></span><span class="line"><span class="cl">    config, err :<span class="o">=</span> rest.InClusterConfig<span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err.Error<span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 根据指定的 config 创建一个新的 clientset
</span></span><span class="line"><span class="cl">    clientset, err :<span class="o">=</span> kubernetes.NewForConfig<span class="o">(</span>config<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err.Error<span class="o">())</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        // 通过实现 clientset 的 CoreV1Interface 接口列表中的 PodsGetter 接口方法 Pods<span class="o">(</span>namespace string<span class="o">)</span>返回 PodInterface
</span></span><span class="line"><span class="cl">        // PodInterface 接口拥有操作 Pod 资源的方法，例如 Create、Update、Get、List 等方法
</span></span><span class="line"><span class="cl">        // 注意：Pods<span class="o">()</span> 方法中 namespace 不指定则获取 Cluster 所有 Pod 列表
</span></span><span class="line"><span class="cl">        pods, err :<span class="o">=</span> clientset.CoreV1<span class="o">()</span>.Pods<span class="o">(</span><span class="s2">&#34;&#34;</span><span class="o">)</span>.List<span class="o">(</span>metav1.ListOptions<span class="o">{})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">            panic<span class="o">(</span>err.Error<span class="o">())</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        fmt.Printf<span class="o">(</span><span class="s2">&#34;There are %d pods in the k8s cluster\n&#34;</span>, len<span class="o">(</span>pods.Items<span class="o">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 获取指定 namespace 中的 Pod 列表信息
</span></span><span class="line"><span class="cl">        namespce :<span class="o">=</span> <span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl">        pods, <span class="nv">err</span> <span class="o">=</span> clientset.CoreV1<span class="o">()</span>.Pods<span class="o">(</span>namespce<span class="o">)</span>.List<span class="o">(</span>metav1.ListOptions<span class="o">{})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">            panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        fmt.Printf<span class="o">(</span><span class="s2">&#34;\nThere are %d pods in namespaces %s\n&#34;</span>, len<span class="o">(</span>pods.Items<span class="o">)</span>, namespce<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> _, pod :<span class="o">=</span> range pods.Items <span class="o">{</span>
</span></span><span class="line"><span class="cl">            fmt.Printf<span class="o">(</span><span class="s2">&#34;Name: %s, Status: %s, CreateTime: %s\n&#34;</span>, pod.ObjectMeta.Name, pod.Status.Phase, pod.ObjectMeta.CreationTimestamp<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // 获取所有的 Namespaces 列表信息
</span></span><span class="line"><span class="cl">        ns, err :<span class="o">=</span> clientset.CoreV1<span class="o">()</span>.Namespaces<span class="o">()</span>.List<span class="o">(</span>metav1.ListOptions<span class="o">{})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">            panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        nss :<span class="o">=</span> ns.Items
</span></span><span class="line"><span class="cl">        fmt.Printf<span class="o">(</span><span class="s2">&#34;\nThere are %d namespaces in cluster\n&#34;</span>, len<span class="o">(</span>nss<span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> _, ns :<span class="o">=</span> range nss <span class="o">{</span>
</span></span><span class="line"><span class="cl">            fmt.Printf<span class="o">(</span><span class="s2">&#34;Name: %s, Status: %s, CreateTime: %s\n&#34;</span>, ns.ObjectMeta.Name, ns.Status.Phase, ns.CreationTimestamp<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        time.Sleep<span class="o">(</span><span class="m">10</span> * time.Second<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This example demonstrates how to manipulate Pod and Namespaces resource types within a k8s cluster, including getting the number of Pod lists in the cluster, getting information about the Pod list in a given Namespace, and getting information about the list of all Namespaces in the cluster. Here, this method obtains the k8s cluster configuration in a different way than the above method. It obtains the k8s configuration information created inside the cluster through the KUBERNETES_SERVICE_HOST and KUBERNETES_SERVICE_PORT environment variables to establish a connection with k8s and then operate its resource types. If k8s has TLS authentication enabled, it reads the tokenFile and CAFile from the specified location inside the cluster by default.</p>
<p>Compile it and see if it passes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># go build main2.go</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">main2  main2.go
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, create a Dockerfile file in the same level directory as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">FROM debian
</span></span><span class="line"><span class="cl">COPY ./main2 /opt
</span></span><span class="line"><span class="cl">ENTRYPOINT /opt/main2
</span></span></code></pre></td></tr></table>
</div>
</div><p>Building a docker image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">Dockerfile  main2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># docker build -t client-go/in-cluster:1.0 .</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since RBAC authentication is enabled by default on local k8s, you need to create a clusterrolebinding to give default account view permissions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl create clusterrolebinding default-view --clusterrole<span class="o">=</span>view --serviceaccount<span class="o">=</span>default:default
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io <span class="s2">&#34;default-view&#34;</span> created
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, just run the image in the Pod, either by yaml or by running the kubectl run command to create it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># kubectl run --rm -i client-go-in-cluster-demo --image=client-go/in-cluster:1.0 --image-pull-policy=Never</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">There are <span class="m">3</span> pods in namespaces default
</span></span><span class="line"><span class="cl">Name: client-go-in-cluster-demo-58d9b5bd79-7w5ds, Status: Running, CreateTime: 2019-02-13 14:25:38 +0000 UTC
</span></span><span class="line"><span class="cl">Name: podinfo-7b8c9bc5c9-64g8k, Status: Running, CreateTime: 2019-01-10 14:40:18 +0000 UTC
</span></span><span class="line"><span class="cl">Name: podinfo-7b8c9bc5c9-bx7ml, Status: Running, CreateTime: 2019-01-10 14:40:18 +0000 UTC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">There are <span class="m">5</span> namespaces in cluster
</span></span><span class="line"><span class="cl">Name: custom-metrics, Status: Active, CreateTime: 2019-01-10 09:01:52 +0000 UTC
</span></span><span class="line"><span class="cl">Name: default, Status: Active, CreateTime: 2019-01-05 09:18:02 +0000 UTC
</span></span><span class="line"><span class="cl">Name: kube-public, Status: Active, CreateTime: 2019-01-05 09:18:02 +0000 UTC
</span></span><span class="line"><span class="cl">Name: kube-system, Status: Active, CreateTime: 2019-01-05 09:18:02 +0000 UTC
</span></span><span class="line"><span class="cl">Name: monitoring, Status: Active, CreateTime: 2019-01-08 15:00:41 +0000 UTC
</span></span><span class="line"><span class="cl">There are <span class="m">16</span> pods in the k8s cluster
</span></span></code></pre></td></tr></table>
</div>
</div><p>It runs fine, simply verify it!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># kubectl get pods -n default</span>
</span></span><span class="line"><span class="cl">NAME                                         READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">client-go-in-cluster-demo-58d9b5bd79-7w5ds   1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">podinfo-7b8c9bc5c9-64g8k                     1/1     Running   <span class="m">1</span>          33d
</span></span><span class="line"><span class="cl">podinfo-7b8c9bc5c9-bx7ml                     1/1     Running   <span class="m">1</span>          33d
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="sdk-operations-on-k8s-various-resource-objects">SDK operations on k8s various resource objects</h2>
<p>As demonstrated above, running clients inside and outside the k8s cluster operate on resource types, but only Read related read operations, the next brief demonstration of how to Create, Update, Delete operations. Create the main.go file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># cat main3.go</span>
</span></span><span class="line"><span class="cl">package main
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import <span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    apiv1 <span class="s2">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="cl">    metav1 <span class="s2">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func main<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    // 配置 k8s 集群外 kubeconfig 配置文件
</span></span><span class="line"><span class="cl">    var kubeconfig *string
</span></span><span class="line"><span class="cl">        <span class="nv">kubeconfig</span> <span class="o">=</span> flag.String<span class="o">(</span><span class="s2">&#34;kubeconfig&#34;</span>, <span class="s2">&#34;/etc/rancher/k3s/k3s.yaml&#34;</span>, <span class="s2">&#34;absolute path to the kubeconfig file&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    flag.Parse<span class="o">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    //在 kubeconfig 中使用当前上下文环境，config 获取支持 url 和 path 方式
</span></span><span class="line"><span class="cl">    config, err :<span class="o">=</span> clientcmd.BuildConfigFromFlags<span class="o">(</span><span class="s2">&#34;&#34;</span>, *kubeconfig<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 根据指定的 config 创建一个新的 clientset
</span></span><span class="line"><span class="cl">    clientset, err :<span class="o">=</span> kubernetes.NewForConfig<span class="o">(</span>config<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 通过实现 clientset 的 CoreV1Interface 接口列表中的 NamespacesGetter 接口方法 Namespaces 返回 NamespaceInterface
</span></span><span class="line"><span class="cl">    // NamespaceInterface 接口拥有操作 Namespace 资源的方法，例如 Create、Update、Get、List 等方法
</span></span><span class="line"><span class="cl">    name :<span class="o">=</span> <span class="s2">&#34;client-go-test&#34;</span>
</span></span><span class="line"><span class="cl">    namespacesClient :<span class="o">=</span> clientset.CoreV1<span class="o">()</span>.Namespaces<span class="o">()</span>
</span></span><span class="line"><span class="cl">    namespace :<span class="o">=</span> <span class="p">&amp;</span>apiv1.Namespace<span class="o">{</span>
</span></span><span class="line"><span class="cl">        ObjectMeta: metav1.ObjectMeta<span class="o">{</span>
</span></span><span class="line"><span class="cl">            Name: name,
</span></span><span class="line"><span class="cl">        <span class="o">}</span>,
</span></span><span class="line"><span class="cl">        Status: apiv1.NamespaceStatus<span class="o">{</span>
</span></span><span class="line"><span class="cl">            Phase: apiv1.NamespaceActive,
</span></span><span class="line"><span class="cl">        <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 创建一个新的 Namespaces
</span></span><span class="line"><span class="cl">    fmt.Println<span class="o">(</span><span class="s2">&#34;Creating Namespaces...&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    result, err :<span class="o">=</span> namespacesClient.Create<span class="o">(</span>namespace<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    fmt.Printf<span class="o">(</span><span class="s2">&#34;Created Namespaces %s on %s\n&#34;</span>, result.ObjectMeta.Name, result.ObjectMeta.CreationTimestamp<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 获取指定名称的 Namespaces 信息
</span></span><span class="line"><span class="cl">    fmt.Println<span class="o">(</span><span class="s2">&#34;Getting Namespaces...&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    result, <span class="nv">err</span> <span class="o">=</span> namespacesClient.Get<span class="o">(</span>name, metav1.GetOptions<span class="o">{})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    fmt.Printf<span class="o">(</span><span class="s2">&#34;Name: %s, Status: %s, selfLink: %s, uid: %s\n&#34;</span>,
</span></span><span class="line"><span class="cl">        result.ObjectMeta.Name, result.Status.Phase, result.ObjectMeta.SelfLink, result.ObjectMeta.UID<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 删除指定名称的 Namespaces 信息
</span></span><span class="line"><span class="cl">    fmt.Println<span class="o">(</span><span class="s2">&#34;Deleting Namespaces...&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    deletePolicy :<span class="o">=</span> metav1.DeletePropagationForeground
</span></span><span class="line"><span class="cl">    <span class="k">if</span> err :<span class="o">=</span> namespacesClient.Delete<span class="o">(</span>name, <span class="p">&amp;</span>metav1.DeleteOptions<span class="o">{</span>
</span></span><span class="line"><span class="cl">        PropagationPolicy: <span class="p">&amp;</span>deletePolicy,
</span></span><span class="line"><span class="cl">    <span class="o">})</span><span class="p">;</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span></span><span class="line"><span class="cl">        panic<span class="o">(</span>err<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    fmt.Printf<span class="o">(</span><span class="s2">&#34;Deleted Namespaces %s\n&#34;</span>, name<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Run the program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># go run main3.go</span>
</span></span><span class="line"><span class="cl">Creating Namespaces...
</span></span><span class="line"><span class="cl">Created Namespaces client-go-test on 2019-02-13 21:44:52 +0800 CST
</span></span><span class="line"><span class="cl">Getting Namespaces...
</span></span><span class="line"><span class="cl">Name: client-go-test, Status: Active, selfLink: /api/v1/namespaces/client-go-test, uid: 8a2de86e-2f95-11e9-b2e0-a0369f3f0404
</span></span><span class="line"><span class="cl">Deleting Namespaces...
</span></span><span class="line"><span class="cl">Deleted Namespaces client-go-test
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-multi-platform-compilation/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Multi-platform compilation for Golang</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/go-sync-pool/">
            <span class="next-text nav-default">Use sync.Pool in Golang to reduce GC pressure</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
