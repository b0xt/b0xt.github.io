<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>From Reactive programming to Combine Practices - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article starts with the basic ideas of reactive programming and goes deeper into the concepts and best practices of Combine." /><meta name="keywords" content="Reactive programming , Combine" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/reactive-combine/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="From Reactive programming to Combine Practices" />
<meta property="og:description" content="This article starts with the basic ideas of reactive programming and goes deeper into the concepts and best practices of Combine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/reactive-combine/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-17T13:31:47+08:00" />
<meta property="article:modified_time" content="2022-06-17T13:31:47+08:00" />

<meta itemprop="name" content="From Reactive programming to Combine Practices">
<meta itemprop="description" content="This article starts with the basic ideas of reactive programming and goes deeper into the concepts and best practices of Combine."><meta itemprop="datePublished" content="2022-06-17T13:31:47+08:00" />
<meta itemprop="dateModified" content="2022-06-17T13:31:47+08:00" />
<meta itemprop="wordCount" content="4001">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="From Reactive programming to Combine Practices"/>
<meta name="twitter:description" content="This article starts with the basic ideas of reactive programming and goes deeper into the concepts and best practices of Combine."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">From Reactive programming to Combine Practices</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-17 13:31:47 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4001 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#reactive-programming">Reactive Programming</a></li>
        <li><a href="#declarative-programming">Declarative Programming</a></li>
        <li><a href="#data-flow-oriented-and-change-propagation">Data flow oriented and change propagation</a>
          <ul>
            <li><a href="#reactive-genre">Reactive genre</a></li>
            <li><a href="#reactivex-reactive-extension">ReactiveX (Reactive Extension)</a></li>
          </ul>
        </li>
        <li><a href="#why-combine">Why Combine</a>
          <ul>
            <li><a href="#advantages-of-combine">Advantages of Combine</a></li>
            <li><a href="#combine-interface">Combine interface</a></li>
            <li><a href="#opencombine">OpenCombine</a></li>
          </ul>
        </li>
        <li><a href="#combine-basic-concepts">Combine Basic Concepts</a>
          <ul>
            <li><a href="#publisher">Publisher</a></li>
            <li><a href="#subscriber">Subscriber</a></li>
            <li><a href="#subscriptions">Subscriptions</a></li>
            <li><a href="#subject">Subject</a></li>
            <li><a href="#operator">Operator</a></li>
          </ul>
        </li>
        <li><a href="#practical-advice">Practical advice</a>
          <ul>
            <li><a href="#type-erasure">Type Erasure</a></li>
            <li><a href="#debugging">Debugging</a></li>
            <li><a href="#common-errors">Common Errors</a></li>
            <li><a href="#combine-in-resso">Combine In Resso</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article will introduce the concepts and best practices of Combine from the basic idea of reactive programming and step by step, hoping to help more people to get started and practice reactive programming successfully.</p>
<h2 id="reactive-programming">Reactive Programming</h2>
<blockquote>
<p>In computing, reactive programming is a declarative programming paradigm oriented to data flow and change propagation.
&ndash;wiki</p>
</blockquote>
<h2 id="declarative-programming">Declarative Programming</h2>
<p>Declarative and imperative programming are common programming paradigms. In imperative programming, the developer makes the computer execute the program by combining statements such as operations, loops, and conditions. Declarative is the opposite of imperative, in that if an imperative is like telling the computer how to do, a declarative is telling the computer what to do. in fact, we have all been exposed to declarative programming, but we don&rsquo;t realize it when we code. DSLs and functional programming of all kinds fall under the category of declarative programming.</p>
<p>For example, suppose we want to get all the odd numbers in a shape-shifting array. Following imperative logic, we need to break down the process into step-by-step statements that</p>
<ol>
<li>iterate through all the elements of the array.</li>
<li>determine if it is an odd number.</li>
<li>If it is, add it to the result. Continue the traversal.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[</span><span class="nx">Int</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">num</span> <span class="k">in</span> <span class="nx">values</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">num</span> <span class="o">%</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">results</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we go by declarative programming, the idea might be to &ldquo;filter out all odd numbers&rdquo;, and the corresponding code would be very intuitive.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">filter</span> <span class="p">{</span> <span class="nx">$0</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is a clear distinction between the two types of programming mentioned above.</p>
<ul>
<li>Instructional programming: describes the process (How) and the computer executes it directly and gets the result.</li>
<li>Declarative programming: Describes the result (What) and lets the computer organize the specific process for us and finally gets the described result.</li>
</ul>
<h2 id="data-flow-oriented-and-change-propagation">Data flow oriented and change propagation</h2>
<p>In layman&rsquo;s terms, data-flow oriented and change propagation is <strong>reactive to the flow of events that occur in the future.</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/c59e6c1049314e8fbfbfa72424b67e68.png" alt="Data flow oriented and change propagation"></p>
<ol>
<li><strong>Event Posting:</strong> An operation posts an event <code>A</code>, and the event <code>A</code> can carry an optional data <code>B</code>.</li>
<li><strong>Operation morphing:</strong> Event <code>A</code> and data <code>B</code> are changed by one or more operations, resulting in event <code>A'</code> and data <code>B'</code>.</li>
<li><strong>Subscription Usage:</strong> On the consumer side, one or more subscribers consume the processed <code>A'</code> and <code>B'</code> and further drive other parts (e.g. UI ).</li>
</ol>
<p>In this flow, a myriad of events make up the event stream, and subscribers are constantly receiving and responding to new events.</p>
<p>At this point, we have an initial understanding of the definition of reactive programming, i.e., responding to future occurrences of event streams in a <strong>declarative manner.</strong> In practice coding, many good three-party libraries further abstract this mechanism and provide developers with interfaces with varying functionality. In iOS development, there are three dominant &ldquo;schools&rdquo; of reactiveness.</p>
<h3 id="reactive-genre">Reactive genre</h3>
<ul>
<li>ReactiveX：RxSwift</li>
<li>Reactive Streams：Combine</li>
<li>Reactive*：ReactiveCocoa / ReactiveSwift ／ReactiveObjc</li>
</ul>
<p>These three schools are ReactiveX, Reactive Streams, and Reactive*.
ReactiveX is described in more detail next, and Reactive Stream aims to define a standard for non-blocking asynchronous event stream processing, which Combine has chosen as the specification for its implementation. Reactive*, represented by ReactiveCocoa, was very popular in the Objective-C era, but with the rise of Swift, more developers chose RxSwift or Combine, causing Reactive* to decline in popularity overall.</p>
<h3 id="reactivex-reactive-extension">ReactiveX (Reactive Extension)</h3>
<p>ReactiveX was originally a reactive extension implemented by Microsoft on . Its interfaces are not intuitively named, such as Observable and Observer, and the strength of ReactiveX is the innovative incorporation of many functional programming concepts, making the entire event stream very flexible in its morphing. This easy-to-use and powerful concept was quickly adopted by developers of all languages, so ReactiveX is very popular in many languages with corresponding versions (e.g. RxJS, RxJava, RxSwift), and Resso&rsquo;s Android team is using RxJava heavily.</p>
<h2 id="why-combine">Why Combine</h2>
<p>Combine is an RxSwift-like asynchronous event processing framework coming from Apple in 2019.</p>
<blockquote>
<p>Combine provides a set of declarative Swift APIs to handle values that change over time. These values can represent user interface events, network responses, scheduled events, or many other types of asynchronous data.</p>
</blockquote>
<p>The Resso iOS team also briefly tried RxSwift, but after a closer look at Combine, we found that Combine outperformed RxSwift in terms of performance, ease of debugging, and the special advantages of a built-in framework and SwiftUI official configuration, and were attracted by its many advantages to switch to Combine.</p>
<h3 id="advantages-of-combine">Advantages of Combine</h3>
<p>Combine has a number of advantages over RxSwift.</p>
<ul>
<li>Apple product
<ul>
<li>Built into the system, no impact on App package size</li>
</ul>
</li>
<li>Better performance</li>
<li>Debug is easier</li>
<li>SwiftUI official</li>
</ul>
<h4 id="performance-benefits">Performance Benefits</h4>
<p>Combine has more than 30% performance improvement over RxSwift for all operations.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/ef0e30bb8f1c422c937b26a6864064e2.png" alt="Combine"></p>
<blockquote>
<p>Reference: Combine vs. RxSwift Performance Benchmark Test Suite</p>
</blockquote>
<h4 id="debug-benefits">Debug Benefits</h4>
<p>Since Combine is a library, with the <code>Show stack frames without debug symbols and between libraries</code> option turned on in Xcode, the number of invalid stacks can be significantly reduced, improving Debug efficiency.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">// 在 GlobalQueue 中接受并答应出数组中的值</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="n">publisher</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="bp">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/73c3f0f2b91c4933994746d187587811.png" alt="Combine"></p>
<h3 id="combine-interface">Combine interface</h3>
<p>As mentioned above, Combine&rsquo;s interface is based on the Reactive Streams Spec implementation, where concepts such as <code>Publisher</code>, <code>Subscriber</code>, and <code>Subscription</code> are already defined, with some fine-tuning by Apple.</p>
<p>Specifically at the interface level, the Combine API is more similar to the RxSwift API. The missing interfaces in Combine can be replaced by other existing interfaces, and a few operators are available in open source third-party implementations, so there is no impact on the production environment.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/190d882b3b54462f9f9c57a619229ddf.png" alt="Combine interface"></p>
<h3 id="opencombine">OpenCombine</h3>
<p>If you are a careful reader, you may have noticed the presence of OpenCombine in the Debug Advantage diagram, which is great, but has one fatal drawback: it requires a minimum system version of iOS 13, which is not available for many apps that require multiple system versions.</p>
<p>The OpenCombine community has been kind enough to implement an open source implementation of Combine that only requires iOS 9.0: OpenCombine, which has been tested internally to be on par with Combine in terms of performance. The cost of migrating from OpenCombine to Combine is also very low, with only a simple text replacement job. OpenCombine is also used by Resso, Cut Image, Waking Image, and Lark in our company.</p>
<h2 id="combine-basic-concepts">Combine Basic Concepts</h2>
<p>As mentioned above, the concept of Combine is based on Reactive Streams. three key concepts in reactive programming, event publication/operation transformation/subscription usage, correspond to <code>Publisher</code> , <code>Operator</code> and <code>Subscriber</code> in Combine.</p>
<p>In the simplified model, there is first a <code>Publisher</code> that is transformed by an <code>Operater</code> and then consumed by a <code>Subscriber</code>. In actual coding, the source of <code>Operator</code> may be a plural <code>Publisher</code>, and <code>Operator</code> may be subscribed by multiple <code>Publishers</code>, usually forming a very complex graph.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/b1f2fd24f3dd48dda6fbf98078560f1b.png" alt="Combine Basic Concepts"></p>
<h3 id="publisher">Publisher</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Publisher&lt;Output, Failure: Error&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Publisher</code> is the source of <strong>Event</strong> generation. Events are a very important concept in Combine and can be divided into two categories, one carrying a value (<code>Value</code>) and the other marking the end (<code>Completion</code>). The end can be either a normal completion (<code>Finished</code>) or a failure (<code>Failure</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">Events：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">Value：Output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">Completion</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Finished</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Failure(Error)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/8bfb45454c2b42c292de729918fc5299.png" alt="Publisher"></p>
<p>Typically, a <code>Publisher</code> can generate <code>N</code> events before ending. Note that once a <code>Publisher</code> has issued a <code>Completion</code> (which can be either a normal completion or a failure), the entire subscription will end and no events can be issued after that.</p>
<p>Apple provides Combine extensions to the Publisher for many common classes in the official base library, such as Timer, NotificationCenter, Array, URLSession, KVO, and more. Using these extensions we can quickly combine a Publisher, such as</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">// `cancellable` 是用于取消订阅的 token，下文会详细介绍</span>
</span></span><span class="line"><span class="cl"><span class="n">cancellable</span> <span class="p">=</span> <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 生成一个 https://example.com 请求的 Publisher</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">dataTaskPublisher</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&#34;https://example.com&#34;</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将请求结果中的 Data 转换为字符串，并忽略掉空结果，下面会详细介绍 compactMap</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">compactMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nv">$0</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在主线程接受后续的事件 （上面的 compactMap 发生在 URLSession 的线程中）</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">RunLoop</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对最终的结果（请求结果对应的字符串）进行消费</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">resultString</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="kc">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="n">resultString</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition, there are some special <code>Publisher</code>s that are also very useful.</p>
<ul>
<li><code>Future</code>: only generates one event, either success or failure, suitable for most simple callback scenarios</li>
<li><code>Just</code>: a simple wrapper around a value, like <code>Just(1)</code></li>
<li><code>@Published</code> : described in more detail below In most cases, using these special <code>Publisher</code>s and the <code>Subject</code>s described below allows flexible combinations of event sources to meet your needs.</li>
</ul>
<h3 id="subscriber">Subscriber</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="n">Subscriber</span><span class="p">&lt;</span><span class="n">Input</span><span class="p">,</span> <span class="n">Failure</span><span class="p">:</span> <span class="n">Error</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A <code>Subsriber</code> is defined as a subscriber to an event and corresponds to a <code>Publisher</code>, where the <code>Output</code> in the <code>Publisher</code> corresponds to the <code>Input</code> of the <code>Subscriber</code>. Commonly used <code>Subscriber</code>s are <code>Sink</code> and <code>Assign</code>.</p>
<p><code>Sink</code> is used to subscribe directly to the event stream, and can handle <code>Value</code> and <code>completion</code> separately.</p>
<blockquote>
<p>The word <code>Sink</code> can be very confusing at first sight. The term can be derived from the sink in a network stream, which we can also understand as The stream goes down the sink.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">// 从数组生成一个 Publisher</span>
</span></span><span class="line"><span class="cl"><span class="n">cancellable</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">].</span><span class="n">publisher</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 处理事件流结束</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 打印会每个值，会依次打印出 1, 2, 3, 4, 5</span>
</span></span><span class="line"><span class="cl">        <span class="bp">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Assign</code> is a special version of <code>Sink</code> that supports direct assignment via <code>KeyPath</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">textLabel</span> <span class="o">=</span> <span class="nx">UILabel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">cancellable</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nx">publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将 数字 转换为 字符串，并忽略掉 nil ，下面会详细介绍这个 Operator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">.</span><span class="nx">compactMap</span> <span class="p">{</span> <span class="nb">String</span><span class="p">(</span><span class="nx">$0</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">to</span><span class="o">:</span> <span class="err">\</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">on</span>: <span class="kt">textLabel</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that assigning <code>self</code> with <code>assign</code> may result in an implicit circular reference, in which case you need to manually assign <code>sink</code> with <code>weak self</code> instead.</p>
<h4 id="cancellable--anycancellable">Cancellable &amp; AnyCancellable</h4>
<p>Careful readers may have noticed the presence of a <code>cancellable</code> above. Each subscription generates an <code>AnyCancellable</code> object, which is used to control the lifecycle of the subscription. Through this object, we can cancel the subscription. When this object is released, the subscription will also be cancelled.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">// 取消订阅</span>
</span></span><span class="line"><span class="cl"><span class="n">cancellable</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that for each subscription we need to hold this <code>cancellable</code>, otherwise the whole subscription will be cancelled and ended immediately.</p>
<h3 id="subscriptions">Subscriptions</h3>
<p>The connection between <code>Publisher</code> and <code>Subscriber</code> is made via <code>Subscription</code>. Understanding the entire subscription process can be very helpful when using Combine in depth.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/cd0b032234df4f4fbfbe6de8b590484b.png" alt="Subscriptions"></p>
<p>Combine&rsquo;s subscription process is actually a pull model.</p>
<ol>
<li><code>Subscriber</code> initiates a subscription, telling <code>Publisher</code> that I need a subscription.</li>
<li><code>Publisher</code> returns a subscription entity (<code>Subscription</code>).</li>
<li><code>Subscriber</code> requests a fixed amount (<code>Demand</code>) of data through this <code>Subscription</code>.</li>
<li><code>Publisher</code> returns events based on <code>Demand</code>. After a single <code>Demand</code> is published, if the <code>Subscriber</code> continues to request events, the <code>Publisher</code> will continue to publish.</li>
<li>Continue the publishing process.</li>
<li>When all the events requested by the <code>Subscriber</code> have been published, the <code>Publisher</code> sends a <code>Completion</code>.</li>
</ol>
<h3 id="subject">Subject</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Subject&lt;Output, Failure: Error&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Subject</code> is a special class of <code>Publisher</code> that can be used to manually inject new events into the event stream via method calls such as <code>send()</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">let</span> <span class="nv">isPlayingPodcastSubject</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 向 isPlayingPodcastPublisher 注入一个新的事件，它的值是 true</span>
</span></span><span class="line"><span class="cl"><span class="n">isPlayingPodcastSubject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Combine provides two common <code>Subject</code>s: <code>PassthroughSubject</code> and <code>CurrentValueSubject</code>.</p>
<ul>
<li><code>PassthroughSubject</code>: Passes through events and does not hold the latest <code>Output</code>.</li>
<li><code>CurrentValueSubject</code>: holds the latest <code>Output</code> in addition to the passed events.</li>
</ul>
<h4 id="published">@Published</h4>
<p>For those who are new to Combine, there is no greater problem than finding an event source that you can use directly. Combine provides a Property Wrapper <code>@Pubilshed</code> to quickly wrap a variable to get a <code>Publisher</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">// 声明变量</span>
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Alarm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">@</span><span class="n">Published</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">countDown</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">alarm</span> <span class="p">=</span> <span class="n">Alarm</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 订阅变化</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">cancellable</span> <span class="p">=</span> <span class="n">alarm</span><span class="p">.</span><span class="err">$</span><span class="n">countDown</span> <span class="c1">// Published&lt;Int&gt;.Publisher</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 修改 countDown，上面 sink 的闭包会触发</span>
</span></span><span class="line"><span class="cl"><span class="n">alarm</span><span class="p">.</span><span class="n">countDown</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What is interesting above is that <code>$countDown</code> accesses a <code>Publisher</code>, which is actually syntactic sugar, <code>$</code> accesses what is actually the <code>projectedValue</code> of <code>countDown</code>, which is the corresponding <code>Publisher</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="p">@</span><span class="n">propertyWrapper</span> <span class="kd">public</span> <span class="kd">struct</span> <span class="nc">Published</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// The property for which this instance exposes a publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// The ``Published/projectedValue` is the property accessed with the `$` operator</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">var</span> <span class="nv">projectedValue</span><span class="p">:</span> <span class="n">Published</span><span class="p">&lt;</span><span class="n">Value</span><span class="p">&gt;.</span><span class="n">Publisher</span> <span class="p">{</span> <span class="kr">mutating</span> <span class="kr">get</span> <span class="kr">set</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>@Published is great for encapsulating events within a module, type-erasing them and then making them available externally for subscription consumption.</p>
<p>In practice, for existing code logic, @Published can be used to quickly give properties the ability to be Publisher without changing other code. For new code, @Published is also a good choice if no errors occur and the current Value needs to be used, but otherwise consider using PassthroughSubject or CurrentValueSubject on an as-needed basis.</p>
<h3 id="operator">Operator</h3>
<p>Combine comes with a very rich set of Operators, and we will introduce some of them.</p>
<h4 id="map-filter-reduce">map, filter, reduce</h4>
<p>Students familiar with functional programming should be familiar with these Operators. Their effects are very similar to those on arrays, except this time in an asynchronous event stream.</p>
<p>For example, for <code>map</code>, he transforms the values in each event.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/9a31b539204f45e19dd1fc7df3d3a430.png" alt="map"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nx">publisher</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">map</span> <span class="p">{</span> <span class="nx">$0</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">value</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将会答应出 10, 20, 30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">print</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>filter</code> is similar, filtering each event with the conditions in the closure. <code>reduce</code>, on the other hand, will compute the value of each event and finally pass the result of the computation downstream.</p>
<h4 id="compactmap">compactMap</h4>
<p>For event streams whose Value is <code>Optional</code>, you can use <code>compactMap</code> to get a Publisher whose Value is a non-empty type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// Publiser&lt;Int?, Never&gt; -&gt; Publisher&lt;Int, Never&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">cancellable</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="nx">nil</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="nx">publisher</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">compactMap</span> <span class="p">{</span> <span class="nx">$0</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span> <span class="p">{</span> <span class="nx">$0</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">print</span><span class="p">(</span><span class="nx">$0</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="flatmap">flatMap</h4>
<p><code>flatMap</code> is a special operator that converts each of the events into an event stream and merges them together. For example, when the user enters text in the search box, we can subscribe to the text changes and generate the corresponding search request Publisher for each text and aggregate all the Publisher&rsquo;s events together for consumption.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/40c399298fe149a8a0b4657cfc8f0f8a.png" alt="flatMap"></p>
<p>Other common Operators are <code>zip</code> , <code>combineLatest</code> and so on.</p>
<h2 id="practical-advice">Practical advice</h2>
<h3 id="type-erasure">Type Erasure</h3>
<p>The <code>Publisher</code> in Combine gets a multi-layer generic nested type after various <code>Operator</code> transformations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">URLSession</span><span class="p">.</span><span class="nx">shared</span><span class="p">.</span><span class="nx">dataTaskPublisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">URL</span><span class="p">(</span><span class="kt">string</span><span class="o">:</span> <span class="s2">&#34;https://resso.com&#34;</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">map</span> <span class="p">{</span> <span class="nx">$0</span><span class="p">.</span><span class="nx">data</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">decoder</span>: <span class="kt">JSONDecoder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 这个 publisher 的类型是 Publishers.Decode&lt;Publishers.Map&lt;URLSession.DataTaskPublisher, JSONDecoder. Input&gt;, String, JSONDecoder&gt;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This does not pose any problem if the subscription is consumed as soon as the <code>Publisher</code> is created and deformed. However, once we need to make this <code>Publisher</code> available for external use, complex types can expose too many internal implementation details and also make the function/variable definition very bloated. Combine provides a special operator <code>erasedToAnyPublisher</code> that allows us to erase the specific type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// 生成一个类型擦除后的请求。函数的返回值更简洁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">func</span> <span class="nx">requestRessoAPI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">AnyPublisher</span><span class="p">&lt;</span><span class="nt">String</span><span class="err">,</span> <span class="na">Error</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">URLSession</span><span class="p">.</span><span class="nx">shared</span><span class="p">.</span><span class="nx">dataTaskPublisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">URL</span><span class="p">(</span><span class="kt">string</span><span class="o">:</span> <span class="s2">&#34;https://resso.com&#34;</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span> <span class="p">{</span> <span class="nx">$0</span><span class="p">.</span><span class="nx">data</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">decoder</span>: <span class="kt">JSONDecoder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Publishers.Decode&lt;Publishers.Map&lt;URLSession.DataTaskPublisher, JSONDecoder. Input&gt;, String, JSONDecoder&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// AnyPublisher&lt;String, Error&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">eraseToAnyPublisher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 在模块外，不用关心 `requestRessoAPI()` 返回的具体类型，直接进行消费
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">cancellable</span> <span class="o">=</span> <span class="nx">requestRessoAPI</span><span class="p">().</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">_</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="nx">receiveValue</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print</span><span class="p">(</span><span class="nx">$0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With type erasure, the final exposure to the outside world is a simple <code>AnyPublisher&lt;String, Error&gt;</code>.</p>
<h3 id="debugging">Debugging</h3>
<p>reactive programming is very easy to write, but debugging is not as pleasant. In response, Combine also provides several Operators to help developers debug.</p>
<h4 id="debug-operator">Debug Operator</h4>
<p><code>print</code> and <code>handleEvents</code></p>
<p><code>print</code> prints out the entire subscription process from start to finish with all the changes and values, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="n">cancellable</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="n">publisher</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 使用 `Array Publisher` 作为所有打印内容的前缀</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="bp">print</span> <span class="p">(</span> <span class="s">&#34;Array Publisher&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can get:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Array Publisher: receive subscription: (ReceiveOn)
</span></span><span class="line"><span class="cl">Array Publisher: request unlimited
</span></span><span class="line"><span class="cl">Array Publisher: receive cancel
</span></span><span class="line"><span class="cl">Array Publisher: receive value: (1)
</span></span><span class="line"><span class="cl">Array Publisher: receive value: (2)
</span></span><span class="line"><span class="cl">Array Publisher: receive value: (3)
</span></span><span class="line"><span class="cl">Array Publisher: receive finished
</span></span></code></pre></td></tr></table>
</div>
</div><p>In some cases, we are only interested in some of the events in all the changes, and this can be done by printing some of the events with <code>handleEvents</code>. Similarly there is <code>breakpoint</code>, which can trigger a breakpoint when an event occurs.</p>
<h4 id="drawing-method">Drawing method</h4>
<p>When you get to the point where you&rsquo;ve run out of ideas, it&rsquo;s good to use images to clarify your thinking. For a single Operator, you can find the corresponding Operator in RxMarble to check if you understand it correctly. For complex subscriptions, you can draw a diagram to confirm that the event flow is being delivered as expected.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">greetings</span> <span class="o">=</span> <span class="nx">PassthroughSubject</span><span class="p">&lt;</span><span class="nt">String</span><span class="err">,</span> <span class="na">Never</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">PassthroughSubject</span><span class="p">&lt;</span><span class="nt">String</span><span class="err">,</span> <span class="na">Never</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">years</span> <span class="o">=</span> <span class="nx">PassthroughSubject</span><span class="p">&lt;</span><span class="nt">Int</span><span class="err">,</span> <span class="na">Never</span><span class="p">&gt;()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// CombineLatest 会选用两个事件流中最新的值生成新的事件流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">greetingNames</span> <span class="o">=</span> <span class="nx">Publishers</span><span class="p">.</span><span class="nx">CombineLatest</span><span class="p">(</span><span class="nx">greetings</span><span class="p">,</span> <span class="nx">names</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span> <span class="p">{</span><span class="s2">&#34;\($1) \($0)&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">wholeSentence</span> <span class="o">=</span> <span class="nx">Publishers</span><span class="p">.</span><span class="nx">CombineLatest</span><span class="p">(</span><span class="nx">greetingNames</span><span class="p">,</span> <span class="nx">years</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span> <span class="p">{</span> <span class="s2">&#34;)($0), \($1)&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">print</span><span class="p">(</span><span class="nx">$0</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">greetings</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Hello&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">names</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Combine&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">years</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">2022</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/17/a76df1eae38d4448ac87207becf2f5d3.png" alt="images"></p>
<h3 id="common-errors">Common Errors</h3>
<h4 id="just-and-future-that-start-immediately">Just and Future that start immediately</h4>
<p>For most <code>Publishers</code>, they start producing events only after subscription, but there are some exceptions. <code>Just</code> and <code>Future</code> execute closures to produce events immediately after initialization is complete, which may allow some time-consuming operations to start earlier than expected, and may allow the first subscription to miss some events that start too early.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">makeMyPublisher</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">AnyPublisher</span><span class="p">&lt;</span><span class="nt">Int</span><span class="err">,</span> <span class="na">Never</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Just</span><span class="p">(</span><span class="nx">calculateTimeConsumingResult</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">eraseToAnyPublisher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A possible solution is to wrap a layer of <code>Defferred</code> outside such <code>Publisher</code> and let it start executing the internal closure after receiving the subscription.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">makeMyFuture2</span><span class="p">(</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">AnyPublisher</span><span class="p">&lt;</span><span class="nt">Int</span><span class="err">,</span> <span class="na">Never</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Deferred</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Just</span><span class="p">(</span><span class="nx">calculateTimeConsumingResult</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}.</span><span class="nx">eraseToAnyPublisher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="an-error-occurred-causing-the-subscription-to-end-unexpectedly">An error occurred causing the Subscription to end unexpectedly</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">requestingAPI</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">AnyPublisher</span><span class="p">&lt;</span><span class="nt">String</span><span class="err">,</span> <span class="na">Error</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">URLSession</span><span class="p">.</span><span class="nx">shared</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">dataTaskPublisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">URL</span><span class="p">(</span><span class="kt">string</span><span class="o">:</span> <span class="s2">&#34;https://resso.com&#34;</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span> <span class="p">{</span> <span class="nx">$0</span><span class="p">.</span><span class="nx">data</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">.</span><span class="nx">self</span><span class="p">,</span> <span class="nx">decoder</span>: <span class="kt">JSONDecoder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">eraseToAnyPublisher</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">cancellable</span> <span class="o">=</span> <span class="nx">NotificationCenter</span><span class="p">.</span><span class="k">default</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">publisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">UserCenter</span><span class="p">.</span><span class="nx">userStateChanged</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">flatMap</span><span class="p">({</span> <span class="nx">_</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">requestingAPI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">completion</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="nx">receiveValue</span><span class="o">:</span> <span class="p">{</span> <span class="nx">value</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="nx">textLabel</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">value</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code converts a notification of user status into a network request and updates the result of the request to a Label. Note that if an error occurs in a network request, the entire subscription will be terminated and subsequent new notifications will not be converted into requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">cancellable</span> <span class="o">=</span> <span class="nx">NotificationCenter</span><span class="p">.</span><span class="k">default</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">publisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">UserCenter</span><span class="p">.</span><span class="nx">userStateChanged</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">flatMap</span> <span class="p">{</span> <span class="nx">value</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">requestingAPI</span><span class="p">().</span><span class="nx">materialize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">text</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="nx">titleLabel</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are many ways to solve this problem, the above uses <code>materialize</code> to convert events from <code>Publisher&lt;Output, MyError&gt;</code> to <code>Publisher&lt;Event&lt;Output, MyError&gt;, Never&gt;</code> to avoid errors.</p>
<p>Combine does not officially implement materialize, CombineExt provides an open source implementation.</p>
<h3 id="combine-in-resso">Combine In Resso</h3>
<p>Resso uses Combine in many scenarios, the most classic example is the logic of getting multiple attributes in the sound effect function. The sound effect needs to use the album cover, the album theme color, and the song&rsquo;s corresponding effects configuration to drive the sound effect playback. These three properties need to be fetched using three network requests, and if you use the classic iOS closure callbacks to write this part of the logic, you&rsquo;re nesting three closures and getting stuck in callback hell, not to mention the possibility of missing the wrong branch.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">startEffectNormal() {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. 获取歌曲封面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">WebImageManager</span><span class="p">.</span><span class="nx">shared</span><span class="p">.</span><span class="nx">requestImage</span><span class="p">(</span><span class="nx">trackCoverURL</span><span class="p">)</span> <span class="p">{</span> <span class="nx">result</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">let</span> <span class="nx">image</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 2. 获取特效配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">fetchVisualEffectConfig</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">trackID</span><span class="p">)</span> <span class="p">{</span> <span class="nx">result</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">                <span class="k">switch</span> <span class="nx">result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">let</span> <span class="nx">path</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 3. 获取封面主题色
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">fetchAlbumColor</span><span class="p">(</span><span class="nx">trackID</span>: <span class="kt">trackID</span><span class="p">)</span> <span class="p">{</span> <span class="nx">result</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">                        <span class="k">switch</span> <span class="nx">result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">case</span> <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">let</span> <span class="nx">albumColor</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">self</span><span class="p">.</span><span class="nx">startEffect</span><span class="p">(</span><span class="nx">coverImage</span>: <span class="kt">coverImage</span><span class="p">,</span> <span class="nx">effectConfig</span>: <span class="kt">effectConfig</span><span class="p">,</span> <span class="nx">coverColor</span>: <span class="kt">coverColor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">case</span> <span class="p">.</span><span class="nx">failure</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// 处理获取封面颜色错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="k">break</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="p">.</span><span class="nx">failure</span><span class="p">(</span><span class="kd">let</span> <span class="nx">error</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 处理获取特效配置错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="p">.</span><span class="nx">failure</span><span class="p">(</span><span class="kd">let</span> <span class="nx">error</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 处理下载图片错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using Combine, we can wrap the three requests into a single <code>Publisher</code> and use the three results together with <code>combineLatest</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">startEffect() {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取歌曲封面的 Publisher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cancellable</span> <span class="o">=</span> <span class="nx">fetchTrackCoverImagePublisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">trackCoverURL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 并与 获取特效配置的 Publisher 和 获取专辑主题色的 Publisher 中的最新结果组成新的 Publisher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="nx">combineLatest</span><span class="p">(</span><span class="nx">fetchVisualEffectPathPublisher</span><span class="p">(</span><span class="k">for</span><span class="o">:</span> <span class="nx">trackID</span><span class="p">),</span> <span class="nx">fetchAlbumColorPublisher</span><span class="p">(</span><span class="nx">trackID</span>: <span class="kt">trackID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 对最终的结果进行使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">.</span><span class="nx">sink</span> <span class="p">{</span> <span class="nx">completion</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="k">case</span> <span class="p">.</span><span class="nx">failure</span><span class="p">(</span><span class="kd">let</span> <span class="nx">error</span><span class="p">)</span> <span class="o">=</span> <span class="nx">completion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 对错误进行处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="nx">receiveValue</span><span class="o">:</span> <span class="p">{</span> <span class="p">(</span><span class="nx">coverImage</span><span class="p">,</span> <span class="nx">effectConfig</span><span class="p">,</span> <span class="nx">coverColor</span><span class="p">)</span> <span class="k">in</span>
</span></span><span class="line"><span class="cl">            <span class="nx">self</span><span class="p">.</span><span class="nx">startEffect</span><span class="p">(</span><span class="nx">coverImage</span>: <span class="kt">coverImage</span><span class="p">,</span> <span class="nx">effectConfig</span>: <span class="kt">effectConfig</span><span class="p">,</span> <span class="nx">coverColor</span>: <span class="kt">coverColor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Such an implementation brings a number of benefits.</p>
<ol>
<li>more compact code structure and better readability</li>
<li>more focused error handling, less likely to be missed</li>
<li>better maintainability, if you need a new request, just continue to combine new Publisher</li>
</ol>
<p>In addition, Resso has also implemented Combine extensions to its own web library to make it easier for more people to start using Combine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">func</span> <span class="nx">fetchSomeResource</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">RestfulClient</span><span class="p">&lt;</span><span class="nt">SomeResponse</span><span class="p">&gt;.</span><span class="nx">DataTaskPublisher</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">SomeRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">RestfulClient</span><span class="p">&lt;</span><span class="nt">SomeResponse</span><span class="p">&gt;(</span><span class="nx">request</span>: <span class="kt">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">dataTaskPublisher</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>In a nutshell, the core of reactive programming is <strong>responding to future streams of events in a declarative way.</strong> In everyday development, using reactive programming wisely can simplify code logic dramatically, but abusing it in inappropriate scenarios (or even all scenarios) can leave colleagues 🤬. The common multiple nested callbacks and custom notifications are perfect for cut-and-dried scenarios.</p>
<p>Combine is a concrete implementation of reactive programming, and its built-in system and excellent implementation give it many advantages over other reactive frameworks. Learning and mastering Combine is a great way to practice reactive programming and has many benefits for everyday development.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/gomock/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">What is mock testing and the use of gomock</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/ebpf/">
            <span class="next-text nav-default">In-depth understanding of eBPF｜7 core issues you need to know</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
