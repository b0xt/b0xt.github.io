<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to use SetMemoryLimit? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use SetMemoryLimit in Go 1.19." /><meta name="keywords" content="golang, SetMemoryLimit" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/how-to-use-set-memorylimit/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How to use SetMemoryLimit?" />
<meta property="og:description" content="Learn how to use SetMemoryLimit in Go 1.19." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/how-to-use-set-memorylimit/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-20T15:28:23+08:00" />
<meta property="article:modified_time" content="2022-06-20T15:28:23+08:00" />

<meta itemprop="name" content="How to use SetMemoryLimit?">
<meta itemprop="description" content="Learn how to use SetMemoryLimit in Go 1.19."><meta itemprop="datePublished" content="2022-06-20T15:28:23+08:00" />
<meta itemprop="dateModified" content="2022-06-20T15:28:23+08:00" />
<meta itemprop="wordCount" content="1450">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to use SetMemoryLimit?"/>
<meta name="twitter:description" content="Learn how to use SetMemoryLimit in Go 1.19."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to use SetMemoryLimit?</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-20 15:28:23 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1450 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#basic-example">Basic example</a></li>
        <li><a href="#setmemorylimit--gogcoff--memorylimit-is-large-enough"><code>SetMemoryLimit</code> + <code>GOGC=off</code> + <code>MemoryLimit</code> is large enough</a></li>
        <li><a href="#setmemorylimit--gogcoff--memorylimit-is-not-big-enough"><code>SetMemoryLimit</code> + <code>GOGC=off</code> + <code>MemoryLimit</code> is not big enough</a></li>
        <li><a href="#setmemorylimit--gogc100--memorylimit-is-big-enough"><code>SetMemoryLimit</code> + <code>GOGC=100</code> + <code>MemoryLimit</code> is big enough</a></li>
        <li><a href="#setmemorylimit--gogc100--memorylimit-is-not-big-enough"><code>SetMemoryLimit</code> + <code>GOGC=100</code> + <code>MemoryLimit</code> is not big enough</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Go 1.19 finally implements <code>SetMemoryLimit</code>, Go&rsquo;s GC doesn&rsquo;t provide as many parameters to adjust as Java, there is only one parameter <code>GOGC</code>, so it&rsquo;s exciting to add a parameter that can adjust GC.</p>
<p>Those who have been following Go performance will know that there are two hacker ways to tune Go GC in recent years:</p>
<ul>
<li><a href="https://blog.twitch.tv/en/2019/04/10/go-memory-ballast-how-i-learnt-to-stop-worrying-and-love-the-heap/">ballast</a>: ballast technique. This technique uses a &ldquo;false&rdquo; memory footprint to make it harder for Go to reach the threshold for triggering GC, in order to reduce the number of GCs and thus improve performance. This technique is very effective if your application&rsquo;s memory footprint is basically below a certain threshold, because after all, a large part of Go&rsquo;s performance consumption is on GC. This is a technique provided by the engineers at twitch.tv.</li>
<li><a href="https://eng.uber.com/how-we-saved-70k-cores-across-30-mission-critical-services/">GOGC tuner</a>: Dynamic tuning of the GC target by automatically tuning the GOGC, which is used to reduce the number of GCs when there is enough memory. This is also a very interesting and effective technique that works well in uber&rsquo;s practice. This is a technology provided by uber engineers, Uber engineers did not open source it out.</li>
</ul>
<p>Now, Go 1.19 provides <code>SetMemoryLimit</code>, a method that replaces <code>ballast</code>&rsquo;s scheme and partially replaces <code>GOGC Tuner</code>&rsquo;s scheme.</p>
<p>Talking about the history of this feature, it dates back to <a href="https://github.com/golang/go/issues/23044">#23044</a> in December 2017, which proposed to add a method that would specify the minimum target heap size. This issue was hotly discussed and the result was that in 2019 twitch.tv engineers implemented ballast,verifying from an engineering point of view that GC can be optimized and that it works in practice.</p>
<p>In 2021 Go team engineer Michael Knyszek launched a proposal <a href="https://github.com/golang/go/issues/44309">#44309</a>, including a design document <a href="https://github.com/golang/proposal/blob/7f0d01687e030f21e8bdc36dfd9d5aac3a6f4a71/design/44309-user-configurable-memory-target.md">user configurable memory target</a>. the tracking issue for this proposal was eventually attributed to <a href="https://github.com/golang/go/issues/48409">#48409</a>.</p>
<p>Originally, this proposal was expected to be implemented in Go 1.18, but because of the delayed approval of the proposal, it will eventually be implemented in Go 1.19.</p>
<p>At the time of writing, Go 1.19 is still under development, but the proposal has already been implemented, and all that remains is some documentation and bug fixes, so we can use <a href="https://pkg.go.dev/golang.org/dl/gotip">gotip</a> to test it.</p>
<p>The original implementation of this proposal was to implement (replace) the ballast functionality, so once Go 1.19 was released, the ballast solution could be deprecated. This year, suddenly Uber&rsquo;s engineers came up with a scheme to automatically adjust GOGC, so the current scheme can not completely replace GOGC tuner, after all, GOGC tuner can be more flexible to adjust the target of GC, and <code>SetMemoryLimit</code> in the set <code>MemoryLimit</code>, but will still be frequent GC If you add <code>GOGC=off</code>, you can only wait for <code>MemoryLimit</code> to be reached before GC, which is different from the way of GOGC Tuner, so it can&rsquo;t replace GOGC tuner completely.</p>
<p>The detailed GC tuning guide <a href="https://tip.golang.org/doc/gc-guide">official document</a> is not yet complete, so you can also pay attention to it and see the official recommendations.</p>
<blockquote>
<p>This page is currently a work-in-progress and is expected to be complete by the time of the Go 1.19 release. See this <a href="https://tip.golang.org/doc/gc-guide#:~:text=This%20page%20is%20currently%20a%20work%2Din%2Dprogress%20and%20is%20expected%20to%20be%20complete%20by%20the%20time%20of%20the%20Go%201.19%20release.%20See%20this%20tracking%20issue%20for%20more%20details.">tracking issue</a> for more details.</p>
</blockquote>
<p>Even if the official documentation is not yet complete, we can still get an early idea of the functionality and benefits of this proposal according to its content.</p>
<p>Here are four scenarios to observe the impact of this feature on GC:</p>
<ul>
<li><code>SetMemoryLimit</code> + <code>GOGC=off</code> + <code>MemoryLimit</code> is big enough</li>
<li><code>SetMemoryLimit</code> + <code>GOGC=off</code> + <code>MemoryLimit</code> is not large enough</li>
<li><code>SetMemoryLimit</code> + <code>GOGC=100</code> + <code>MemoryLimit</code> is large enough</li>
<li><code>SetMemoryLimit</code> + <code>GOGC=100</code> + <code>MemoryLimit</code> is not large enough</li>
</ul>
<h2 id="basic-example">Basic example</h2>
<p>This article demonstrates these with the <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/program/binarytrees-go-2.html">btree example</a> from Debian&rsquo;s benchmarks game four scenarios.</p>
<p>Because this example generates spanning binary trees frequently, it is suitable for memory allocation and recycling scenarios.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">node</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">next</span> <span class="o">*</span><span class="nx">next</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">next</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">left</span><span class="p">,</span> <span class="nx">right</span> <span class="nx">node</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="nx">d</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">d</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">node</span><span class="p">{</span><span class="o">&amp;</span><span class="nx">next</span><span class="p">{</span><span class="nx">node</span><span class="p">{},</span> <span class="nx">node</span><span class="p">{}}}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">node</span><span class="p">{</span><span class="o">&amp;</span><span class="nx">next</span><span class="p">{</span><span class="nf">create</span><span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nf">create</span><span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)}}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">node</span><span class="p">)</span> <span class="nf">check</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sum</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">current</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">next</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">current</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">right</span><span class="p">.</span><span class="nf">check</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nx">current</span> <span class="p">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">left</span><span class="p">.</span><span class="nx">next</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">sum</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">depth</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;depth&#34;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#34;depth&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="nx">MinDepth</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="nx">NoTasks</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxDepth</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">depth</span>
</span></span><span class="line"><span class="cl">    <span class="nx">longLivedTree</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">(</span><span class="nx">maxDepth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stretchTreeCheck</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stretchDepth</span> <span class="o">:=</span> <span class="nx">maxDepth</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stretchTreeCheck</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;stretch tree of depth %d\t check: %d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">stretchDepth</span><span class="p">,</span> <span class="nf">create</span><span class="p">(</span><span class="nx">stretchDepth</span><span class="p">).</span><span class="nf">check</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">results</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="p">(</span><span class="nx">maxDepth</span><span class="o">-</span><span class="nx">MinDepth</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">results</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">depth</span> <span class="o">:=</span> <span class="mi">2</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">MinDepth</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="o">:=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nx">maxDepth</span> <span class="o">-</span> <span class="nx">depth</span> <span class="o">+</span> <span class="nx">MinDepth</span><span class="p">))</span> <span class="o">/</span> <span class="nx">NoTasks</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tasks</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">NoTasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">NoTasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 执行NoTasks个goroutine, 每个goroutine执行n个深度为depth的tree的check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 一共是n*NoTasks个tree,每个tree的深度是depth
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">t</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tasks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">t</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">check</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">check</span> <span class="o">+=</span> <span class="nf">create</span><span class="p">(</span><span class="nx">depth</span><span class="p">).</span><span class="nf">check</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">tasks</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="p">=</span> <span class="nx">check</span>
</span></span><span class="line"><span class="cl">                <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">check</span> <span class="o">:=</span> <span class="mi">0</span> <span class="c1">// 总检查次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tasks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">check</span> <span class="o">+=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%d\t trees of depth %d\t check: %d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">n</span><span class="o">*</span><span class="nx">NoTasks</span><span class="p">,</span> <span class="nx">depth</span><span class="p">,</span> <span class="nx">check</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">stretchTreeCheck</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">results</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;long lived tree of depth %d\t check: %d\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maxDepth</span><span class="p">,</span> <span class="nx">longLivedTree</span><span class="p">.</span><span class="nf">check</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;took %.02f s&#34;</span><span class="p">,</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">).</span><span class="nf">Milliseconds</span><span class="p">())</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can use <code>gotip build main.go</code> to generate the Go 1.19 compiled binaries.</p>
<p>In the latter example I did not set <code>MemoryLimit</code> using <code>debug.SetMemoryLimit</code>, but used the environment variable <code>GOMEMLIMIT</code>.</p>
<h2 id="setmemorylimit--gogcoff--memorylimit-is-large-enough"><code>SetMemoryLimit</code> + <code>GOGC=off</code> + <code>MemoryLimit</code> is large enough</h2>
<p>First compile the executable binary <code>soft_memory_limit</code> using <code>gotip build main.go</code>.</p>
<p>Run <code>GOMEMLIMIT=10737418240 GOGC=off GODEBUG=gctrace=1 . /soft_memory_limit -depth=21</code> to see the effect.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/20/80c804667af748fcb2aa7fc9446ea3af.png" alt="go gc"></p>
<p>Here I set <code>MemoryLimit</code> to 10G, and the memory threshold is not reached in the whole program, so no GC happens.</p>
<p>Is it the same effect as setting ballast.</p>
<h2 id="setmemorylimit--gogcoff--memorylimit-is-not-big-enough"><code>SetMemoryLimit</code> + <code>GOGC=off</code> + <code>MemoryLimit</code> is not big enough</h2>
<p>Let&rsquo;s set <code>MemoryLimit</code> to 1G and see how GC behaves (<code>GOMEMLIMIT=1073741824 GOGC=off GODEBUG=gctrace=1 . /soft_memory_limit -depth=21</code>).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/20/a0cc1e9e4d234c998f6b9eb5033be5a5.png" alt="go gc"></p>
<p>You can see that the memory usage during the program run can still touch the threshold of 1G, which will lead to several garbage collections, and the overall running time is less than the difference between case1, because the GC collection is only a few times and can be ignored.</p>
<p>If you set the threshold smaller, for example by 10 times (<code>GOMEMLIMIT=107374182 GOGC=off GODEBUG=gctrace=1 . /soft_memory_limit -depth=21</code>), you can see more frequent garbage collection and a significant increase in overall program runtime.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/20/ef2c3b40790d4d6b9fa69664db39e19e.png" alt="go gc"></p>
<h2 id="setmemorylimit--gogc100--memorylimit-is-big-enough"><code>SetMemoryLimit</code> + <code>GOGC=100</code> + <code>MemoryLimit</code> is big enough</h2>
<p>In order to achieve the ballast effect, the previous cases set GOGC to <code>off</code>, what if we set it to the default value of 100?</p>
<p><code>GOMEMLIMIT=10737418240 GOGC=100 GODEBUG=gctrace=1 . /soft_memory_limit -depth=21</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/20/db37eb71e1ec46d0ad03e6d995fb1cce.png" alt="go gc"></p>
<p>As you can see, there will be a large number of GC events, and many of them do not reach the threshold before GC occurs. This is also obvious because the GOGC target is still followed to decide whether to garbage collect without reaching the <code>MemoryLimit</code> threshold.</p>
<p>In this case, GOGC tuner can be used for tuning to avoid so many garbage collections.</p>
<h2 id="setmemorylimit--gogc100--memorylimit-is-not-big-enough"><code>SetMemoryLimit</code> + <code>GOGC=100</code> + <code>MemoryLimit</code> is not big enough</h2>
<p>If the <code>MemoryLimit</code> is not large enough, the GC will be triggered when the memory reaches <code>MemoryLimit</code>, but since GOGC is not closed, both GOGC and <code>MemoryLimit</code> may trigger the GC, and the program will still run slower overall.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/20/5f60bf5a88f64194be7d7ced506f75e7.png" alt="go gc"></p>
<p>To sum up, by setting a larger value of <code>SetMemoryLimit</code> and adding <code>GOGC=off</code>, you can achieve the effect of ballast.</p>
<p>But in the case of not turning off <code>GOGC</code>, it may still trigger many times of GC, which affects the performance, this time also need GOGC Tuner tuning, reduce the number of GC before reaching <code>MemoryLimit</code>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/golang-error-logs/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">5 Suggestions for Error Handling and Log Printing in Golang</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/k8s-auth/">
            <span class="next-text nav-default">Authentication and authorization in kubernetes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
