<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The disappearing Prometheus indicator - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Solve the problem of disappearing Prometheus indicators." /><meta name="keywords" content="Prometheus, Indicator disappeared" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/prometheus-disappearing/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="The disappearing Prometheus indicator" />
<meta property="og:description" content="Solve the problem of disappearing Prometheus indicators." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/prometheus-disappearing/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-30T12:38:05+08:00" />
<meta property="article:modified_time" content="2022-06-30T12:38:05+08:00" />

<meta itemprop="name" content="The disappearing Prometheus indicator">
<meta itemprop="description" content="Solve the problem of disappearing Prometheus indicators."><meta itemprop="datePublished" content="2022-06-30T12:38:05+08:00" />
<meta itemprop="dateModified" content="2022-06-30T12:38:05+08:00" />
<meta itemprop="wordCount" content="1931">
<meta itemprop="keywords" content="Prometheus," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The disappearing Prometheus indicator"/>
<meta name="twitter:description" content="Solve the problem of disappearing Prometheus indicators."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The disappearing Prometheus indicator</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-30 12:38:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1931 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#problem-phenomenon">Problem phenomenon</a></li>
        <li><a href="#kubelet-and-cadvisor">kubelet and cadvisor</a></li>
        <li><a href="#cadvisor-and-runtime">cadvisor and runtime</a></li>
        <li><a href="#cadvisor-and-docker">cadvisor and docker</a></li>
        <li><a href="#the-real-reason">The real reason</a></li>
        <li><a href="#solution">Solution</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="problem-phenomenon">Problem phenomenon</h2>
<p>We have some GPU machines and need to count GPU related information, the data is taken from Prometheus, but one day we suddenly found that some labels of some GPU node metrics are empty.</p>
<p>Here are the metrics of normal nodes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">container_accelerator_duty_cycle{acc_id=&#34;GPU-d8384090-81d2-eda5-ed02-8137eb037460&#34;,container_name=&#34;nvidia-device-plugin-ctr&#34;,endpoint=&#34;https-metrics&#34;,id=&#34;/kubepods/besteffort/podd917e00f-a779-11e9-b971-6805ca7f5b2a/38a5decf96e9f007fcb0059d79017ea3b3c29ff4c9a81b7fec86cf63c06baf53&#34;,image=&#34;sha256:7354b8a316796fba0463a68da79d79eb654d741241ca3c4f62a1ef24d8e11718&#34;,instance=&#34;10.0.0.1:10250&#34;,job=&#34;kubelet&#34;,make=&#34;nvidia&#34;,model=&#34;Tesla P40&#34;,name=&#34;k8s_nvidia-device-plugin-ctr_nvidia-device-plugin-daemonset-sn2cg_lambda_d917e00f-a779-11e9-b971-6805ca7f5b2a_1&#34;,namespace=&#34;ieevee&#34;,node=&#34;x1.ieevee.com&#34;,pod_name=&#34;nvidia-device-plugin-daemonset-sn2cg&#34;,service=&#34;kubelet&#34;}  0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here are the metrics of the exception node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">container_accelerator_duty_cycle{acc_id=&#34;GPU-a7b535d0-d6ca-022c-5b23-1bff863646a4&#34;,container_name=&#34;&#34;,endpoint=&#34;https-metrics&#34;,id=&#34;/kubepods/besteffort/pod8bb25662-de9a-11e9-84e7-f8f21e04010c/cde3858becb05366e71f230e876204be586662f274dcb4a6e2b75ea404f2d5a9&#34;,instance=&#34;10.0.0.2:10250&#34;,job=&#34;kubelet&#34;,make=&#34;nvidia&#34;,model=&#34;Tesla V100-PCIE-16GB&#34;,name=&#34;&#34;,namespace=&#34;&#34;,pod_name=&#34;&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the data taken out by Prometheus, the container_name, name, namespace, and pod_name in the label are all empty.</p>
<p><code>container_accelerator_duty_cycle</code> This metric is provided by kubelet (kubelet is a target of Prometheus) and can be viewed as metrics via <code>https://10.0.0.2:10250/metrics</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/30/d7bd322df4b74f1abae246d6c3e1d676.png" alt="Prometheus"></p>
<p>Use the following command to view the metrics and compare the difference in the data taken from the kubelet of the normal and abnormal nodes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">curl -i -k -H &#34;Authorization: Bearer ${token}&#34; https://10.0.0.2:10250/metrics/cadvisor |grep container_accelerator_duty_cycle
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normal nodes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">container_accelerator_duty_cycle<span class="o">{</span><span class="nv">acc_id</span><span class="o">=</span><span class="s2">&#34;GPU-0e67d3a8-5c36-4232-46b1-14d4470adcb6&#34;</span>,endpoint<span class="o">=</span><span class="s2">&#34;https-metrics&#34;</span>,id<span class="o">=</span><span class="s2">&#34;/kubepods/besteffort/pod756bcd3a-e9a7-11e9-84e7-f8f21e04010c/9c6af6f329cf4d01462b0ba8c2f8bbb79269bc309434489228b4c97154f0f2d5&#34;</span>,instance<span class="o">=</span><span class="s2">&#34;10.0.0.1:10250&#34;</span>,job<span class="o">=</span><span class="s2">&#34;kubelet&#34;</span>,make<span class="o">=</span><span class="s2">&#34;nvidia&#34;</span>,model<span class="o">=</span><span class="s2">&#34;Tesla V100-PCIE-16GB&#34;</span>,node<span class="o">=</span><span class="s2">&#34;x1.ieevee.com&#34;</span>,service<span class="o">=</span><span class="s2">&#34;kubelet&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Exception node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">container_accelerator_duty_cycle{acc_id=&#34;GPU-a7b535d0-d6ca-022c-5b23-1bff863646a4&#34;,container_name=&#34;&#34;,id=&#34;/kubepods/besteffort/pod8bb25662-de9a-11e9-84e7-f8f21e04010c/cde3858becb05366e71f230e876204be586662f274dcb4a6e2b75ea404f2d5a9&#34;,image=&#34;&#34;,make=&#34;nvidia&#34;,model=&#34;Tesla V100-PCIE-16GB&#34;,name=&#34;&#34;,namespace=&#34;&#34;,pod_name=&#34;&#34;} 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>That is, the data taken from the kubelet already has the problem of some Label being empty, and the problem has nothing to do with Prometheus, so let&rsquo;s see why the kubelet has the problem.</p>
<h2 id="kubelet-and-cadvisor">kubelet and cadvisor</h2>
<p>We know that many of the kubelet metrics, are obtained through cadvisor, which runs directly in the kubelet process, and there is not a separate cadvisor process on the node. However, the cadvisor code still uses <code>github.com/google/cadvisor</code>, in other words, cadvisor has been turned into an SDK for kubelet calls.</p>
<p>Let&rsquo;s briefly analyze the code (the following is based on 1.11.1).</p>
<p>The kubelet initializes a CAdvisorInterface when it starts.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">func</span> <span class="nf">run</span><span class="o">(</span><span class="n">s</span> <span class="o">*</span><span class="n">options</span><span class="o">.</span><span class="na">KubeletServer</span><span class="o">,</span> <span class="n">kubeDeps</span> <span class="o">*</span><span class="n">kubelet</span><span class="o">.</span><span class="na">Dependencies</span><span class="o">,</span> <span class="n">stopCh</span> <span class="o">&lt;-</span><span class="n">chan</span> <span class="n">struct</span><span class="o">{})</span> <span class="o">(</span><span class="n">err</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">kubeDeps</span><span class="o">.</span><span class="na">CAdvisorInterface</span> <span class="o">==</span> <span class="n">nil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">imageFsInfoProvider</span> <span class="o">:=</span> <span class="n">cadvisor</span><span class="o">.</span><span class="na">NewImageFsInfoProvider</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">ContainerRuntime</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">RemoteRuntimeEndpoint</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">kubeDeps</span><span class="o">.</span><span class="na">CAdvisorInterface</span><span class="o">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cadvisor</span><span class="o">.</span><span class="na">New</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">Address</span><span class="o">,</span> <span class="n">uint</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">CAdvisorPort</span><span class="o">),</span> <span class="n">imageFsInfoProvider</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">RootDirectory</span><span class="o">,</span> <span class="n">cadvisor</span><span class="o">.</span><span class="na">UsingLegacyCadvisorStats</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">ContainerRuntime</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">RemoteRuntimeEndpoint</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The initialization process is mainly done by starting a cadvisor http server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// New creates a cAdvisor and exports its API on the specified port if port &gt; 0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">func</span> <span class="nf">New</span><span class="o">(</span><span class="n">address</span> <span class="n">string</span><span class="o">,</span> <span class="n">port</span> <span class="n">uint</span><span class="o">,</span> <span class="n">imageFsInfoProvider</span> <span class="n">ImageFsInfoProvider</span><span class="o">,</span> <span class="n">rootPath</span> <span class="n">string</span><span class="o">,</span> <span class="n">usingLegacyStats</span> <span class="n">bool</span><span class="o">)</span> <span class="o">(</span><span class="n">Interface</span><span class="o">,</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">cadvisorClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">cadvisorClient</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">imageFsInfoProvider</span><span class="o">:</span> <span class="n">imageFsInfoProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">rootPath</span><span class="o">:</span>            <span class="n">rootPath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">Manager</span><span class="o">:</span>             <span class="n">m</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">cadvisorClient</span><span class="o">.</span><span class="na">exportHTTP</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">nil</span><span class="o">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cadvisorClient</span><span class="o">,</span> <span class="n">nil</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>exportHTTP</code> function starts the http server and registers a kubelet callback function <code>containerLabels</code> with the cadvisor http server, where the kubelet adds the <strong>label it needs</strong> to the cadvisor&rsquo;s metrics.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">cadvisorClient</span><span class="p">)</span> <span class="nf">exportHTTP</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">port</span> <span class="kt">uint</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Register the handlers regardless as this registers the prometheus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// collector properly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cadvisorhttp</span><span class="p">.</span><span class="nf">RegisterPrometheusHandler</span><span class="p">(</span><span class="nx">mux</span><span class="p">,</span> <span class="nx">cc</span><span class="p">,</span> <span class="s">&#34;/metrics&#34;</span><span class="p">,</span> <span class="nx">containerLabels</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>First look at what <code>containerLabels</code> has done.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">func</span> <span class="nf">containerLabels</span><span class="o">(</span><span class="n">c</span> <span class="o">*</span><span class="n">cadvisorapi</span><span class="o">.</span><span class="na">ContainerInfo</span><span class="o">)</span> <span class="n">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Prometheus requires that all metrics in the same family have the same labels,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so we arrange to supply blank strings for missing labels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">var</span> <span class="n">name</span><span class="o">,</span> <span class="n">image</span><span class="o">,</span> <span class="n">podName</span><span class="o">,</span> <span class="n">namespace</span><span class="o">,</span> <span class="n">containerName</span> <span class="n">string</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">len</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">Aliases</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">Aliases</span><span class="o">[</span><span class="n">0</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">image</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">Spec</span><span class="o">.</span><span class="na">Image</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">v</span><span class="o">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="na">Spec</span><span class="o">.</span><span class="na">Labels</span><span class="o">[</span><span class="n">types</span><span class="o">.</span><span class="na">KubernetesPodNameLabel</span><span class="o">];</span> <span class="n">ok</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">podName</span> <span class="o">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">v</span><span class="o">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="na">Spec</span><span class="o">.</span><span class="na">Labels</span><span class="o">[</span><span class="n">types</span><span class="o">.</span><span class="na">KubernetesPodNamespaceLabel</span><span class="o">];</span> <span class="n">ok</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">namespace</span> <span class="o">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">v</span><span class="o">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="na">Spec</span><span class="o">.</span><span class="na">Labels</span><span class="o">[</span><span class="n">types</span><span class="o">.</span><span class="na">KubernetesContainerNameLabel</span><span class="o">];</span> <span class="n">ok</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">containerName</span> <span class="o">=</span> <span class="n">v</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span> <span class="o">:=</span> <span class="n">map</span><span class="o">[</span><span class="n">string</span><span class="o">]</span><span class="n">string</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">metrics</span><span class="o">.</span><span class="na">LabelID</span><span class="o">:</span>    <span class="n">c</span><span class="o">.</span><span class="na">Name</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">metrics</span><span class="o">.</span><span class="na">LabelName</span><span class="o">:</span>  <span class="n">name</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">metrics</span><span class="o">.</span><span class="na">LabelImage</span><span class="o">:</span> <span class="n">image</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pod_name&#34;</span><span class="o">:</span>         <span class="n">podName</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;namespace&#34;</span><span class="o">:</span>        <span class="n">namespace</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;container_name&#34;</span><span class="o">:</span>   <span class="n">containerName</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">set</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>What do we see? <code>pod_name</code>, <code>namespace</code>, <code>container_name</code>, which correspond to the missing labels.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">container_accelerator_duty_cycle{acc_id=&#34;GPU-a7b535d0-d6ca-022c-5b23-1bff863646a4&#34;,container_name=&#34;&#34;,id=&#34;/kubepods/besteffort/pod8bb25662-de9a-11e9-84e7-f8f21e04010c/cde3858becb05366e71f230e876204be586662f274dcb4a6e2b75ea404f2d5a9&#34;,image=&#34;&#34;,make=&#34;nvidia&#34;,model=&#34;Tesla V100-PCIE-16GB&#34;,name=&#34;&#34;,namespace=&#34;&#34;,pod_name=&#34;&#34;} 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, when does cadvisor call <code>containerLabels</code>? Continue to <code>RegisterPrometheusHandler</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">RegisterPrometheusHandler</span><span class="p">(</span><span class="nx">mux</span> <span class="nx">httpmux</span><span class="p">.</span><span class="nx">Mux</span><span class="p">,</span> <span class="nx">containerManager</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">Manager</span><span class="p">,</span> <span class="nx">prometheusEndpoint</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">f</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">ContainerLabelsFunc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">prometheus</span><span class="p">.</span><span class="nf">NewRegistry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nf">MustRegister</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">metrics</span><span class="p">.</span><span class="nf">NewPrometheusCollector</span><span class="p">(</span><span class="nx">containerManager</span><span class="p">,</span> <span class="nx">f</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewPrometheusCollector</span><span class="p">(</span><span class="nx">i</span> <span class="nx">infoProvider</span><span class="p">,</span> <span class="nx">f</span> <span class="nx">ContainerLabelsFunc</span><span class="p">)</span> <span class="o">*</span><span class="nx">PrometheusCollector</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">f</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span> <span class="p">=</span> <span class="nx">DefaultContainerLabels</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">PrometheusCollector</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">infoProvider</span><span class="p">:</span>        <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">containerLabelsFunc</span><span class="p">:</span> <span class="nx">f</span><span class="p">,</span> <span class="c1">//here 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="nx">containerMetrics</span><span class="p">:</span> <span class="p">[]</span><span class="nx">containerMetric</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">name</span><span class="p">:</span>      <span class="s">&#34;container_last_seen&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">help</span><span class="p">:</span>      <span class="s">&#34;Last time a container was seen by the exporter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="nx">name</span><span class="p">:</span>        <span class="s">&#34;container_accelerator_duty_cycle&#34;</span><span class="p">,</span>    <span class="c1">//here 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">help</span><span class="p">:</span>        <span class="s">&#34;Percent of time over the past sample period during which the accelerator was actively processing.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">valueType</span><span class="p">:</span>   <span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeValue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">extraLabels</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;make&#34;</span><span class="p">,</span> <span class="s">&#34;model&#34;</span><span class="p">,</span> <span class="s">&#34;acc_id&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="nx">getValues</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">info</span><span class="p">.</span><span class="nx">ContainerStats</span><span class="p">)</span> <span class="nx">metricValues</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">values</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">metricValues</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Accelerators</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Accelerators</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">values</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">metricValue</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">value</span><span class="p">:</span>  <span class="nb">float64</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">DutyCycle</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="nx">labels</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">value</span><span class="p">.</span><span class="nx">Make</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">ID</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                        <span class="p">})</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">values</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span> <span class="p">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the <code>NewPrometheusCollector</code>, we see the <code>container_accelerator_duty_cycle</code> collected earlier, and the three labels <code>make</code>, <code>model</code>, and <code>acc_id</code>; and also <code>containerLabels</code> hooked up to the <code>containerLabelsFunc</code>.</p>
<p>Thus, when the user API requests metrics, the cadvisor can add the labels/values he needs to the metrics&rsquo; labels by calling the kubelet&rsquo;s callback function <code>containerLabels</code>, as requested by the kubelet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">PrometheusCollector</span><span class="p">)</span> <span class="nf">collectContainersInfo</span><span class="p">(</span><span class="nx">ch</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">prometheus</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">..</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">container</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">containers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">values</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rawLabels</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">labels</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rawLabels</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">containerLabels</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">containerLabelsFunc</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">l</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rawLabels</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">labels</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">labels</span><span class="p">,</span> <span class="nf">sanitizeLabelName</span><span class="p">(</span><span class="nx">l</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">values</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">containerLabels</span><span class="p">[</span><span class="nx">l</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="cadvisor-and-runtime">cadvisor and runtime</h2>
<p>As you can see from the previous analysis, the missing labels were &ldquo;delegated&rdquo; to the cadvisor by the kubelet, but apparently the cadvisor is having some problems with them. Where is it?</p>
<p>Back to the &ldquo;delegate function&rdquo;, you can see from the following code, <code>containerLabels</code> actually reads the value of the map Labels from <code>ContainerInfo</code>, if the map does not have the corresponding key, then naturally the value is empty ( The initial value is an empty string).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">containerLabels</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">cadvisorapi</span><span class="p">.</span><span class="nx">ContainerInfo</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">podName</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">containerName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">KubernetesPodNameLabel</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">podName</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">KubernetesPodNamespaceLabel</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">namespace</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">KubernetesContainerNameLabel</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">containerName</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">KubernetesPodNameLabel</span>       <span class="p">=</span> <span class="s">&#34;io.kubernetes.pod.name&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">KubernetesPodNamespaceLabel</span>  <span class="p">=</span> <span class="s">&#34;io.kubernetes.pod.namespace&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">KubernetesPodUIDLabel</span>        <span class="p">=</span> <span class="s">&#34;io.kubernetes.pod.uid&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">KubernetesContainerNameLabel</span> <span class="p">=</span> <span class="s">&#34;io.kubernetes.container.name&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">KubernetesContainerTypeLabel</span> <span class="p">=</span> <span class="s">&#34;io.kubernetes.container.type&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the question is simplified to, <code>c.Spec.Labels</code> When was this processed?</p>
<h2 id="cadvisor-and-docker">cadvisor and docker</h2>
<p>Because I hadn&rsquo;t seen cadvisor&rsquo;s code before that and didn&rsquo;t understand cadvisor&rsquo;s architecture, I went straight to see how <code>Labels</code> were obtained in cadvisor&rsquo;s code.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/30/e0d6b0407df942ad82bfb4455d77f449.png" alt="cadvisor"></p>
<p>As you can see, there are implementations related to docker, containerd, rkt, crio, etc. Since we are using docker on our cluster, let&rsquo;s look at how docker is handled here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">func</span> <span class="o">(</span><span class="n">self</span> <span class="o">*</span><span class="n">dockerContainerHandler</span><span class="o">)</span> <span class="n">GetSpec</span><span class="o">()</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">ContainerSpec</span><span class="o">,</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hasFilesystem</span> <span class="o">:=</span> <span class="o">!</span><span class="n">self</span><span class="o">.</span><span class="na">ignoreMetrics</span><span class="o">.</span><span class="na">Has</span><span class="o">(</span><span class="n">container</span><span class="o">.</span><span class="na">DiskUsageMetrics</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">spec</span><span class="o">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">common</span><span class="o">.</span><span class="na">GetSpec</span><span class="o">(</span><span class="n">self</span><span class="o">.</span><span class="na">cgroupPaths</span><span class="o">,</span> <span class="n">self</span><span class="o">.</span><span class="na">machineInfoFactory</span><span class="o">,</span> <span class="n">self</span><span class="o">.</span><span class="na">needNet</span><span class="o">(),</span> <span class="n">hasFilesystem</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">spec</span><span class="o">.</span><span class="na">Labels</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="na">labels</span>
</span></span><span class="line"><span class="cl">    <span class="n">spec</span><span class="o">.</span><span class="na">Envs</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="na">envs</span>
</span></span><span class="line"><span class="cl">    <span class="n">spec</span><span class="o">.</span><span class="na">Image</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="na">image</span>
</span></span><span class="line"><span class="cl">    <span class="n">spec</span><span class="o">.</span><span class="na">CreationTime</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="na">creationTime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">spec</span><span class="o">,</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Obviously, <code>ContainerSpec</code> is <code>c.Spec.</code> in <code>containerLabels</code>, and the line <code>spec.Labels = self.labels</code> tells us that cadvisor is getting Labels from <code>dockerContainerHandler</code>.</p>
<p>And where does dockerContainerHandler get the Labels from? Keep looking for the code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newDockerContainerHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">client</span> <span class="o">*</span><span class="nx">docker</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We assume that if Inspect fails then the container is not known to docker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ctnr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">ContainerInspect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to inspect container %q: %v&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">handler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">dockerContainerHandler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="nx">labels</span><span class="p">:</span>             <span class="nx">ctnr</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ignoreMetrics</span><span class="p">:</span>      <span class="nx">ignoreMetrics</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">zfsParent</span><span class="p">:</span>          <span class="nx">zfsParent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OK, we found the real source of the data. In fact, docker inspects the container, gets the container&rsquo;s <code>ctnr.Config.Labels</code>, and then passes it out layer by layer, so the cause of the problem is probably that <code>ctnr.Config.Labels</code> doesn&rsquo;t have the <code>pod_name</code>, <code>namespace</code>, <code>container_name</code>, that is <code>types.KubernetesPodNameLabel</code> and other Labels.</p>
<p>Go to the GPU node where the exception is located and actually look at the docker information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl"># docker inspect b8f6b265835e
</span></span><span class="line"><span class="cl">[
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#34;Id&#34;: &#34;b8f6b265835ea112000aec5fd426be66f922bb241f3e65c45997e7bc63bad003&#34;,
</span></span><span class="line"><span class="cl">        &#34;Config&#34;: {
</span></span><span class="line"><span class="cl">            &#34;Labels&#34;: {
</span></span><span class="line"><span class="cl">                &#34;io.kubernetes.container.name&#34;: &#34;xxx&#34;,
</span></span><span class="line"><span class="cl">                &#34;io.kubernetes.docker.type&#34;: &#34;container&#34;,
</span></span><span class="line"><span class="cl">                &#34;io.kubernetes.pod.name&#34;: &#34;xxx-67d8c96565-nmcwg&#34;,
</span></span><span class="line"><span class="cl">                &#34;io.kubernetes.pod.namespace&#34;: &#34;ieevee&#34;,
</span></span></code></pre></td></tr></table>
</div>
</div><p>Unfortunately, docker inspect has the corresponding Label, which is a bit puzzling and shouldn&rsquo;t not be available.</p>
<h2 id="the-real-reason">The real reason</h2>
<p>So is it possible that cadvisor has a poor path to docker and is not getting any information from docker directly?</p>
<p>Let&rsquo;s take a look at the flow from cadvisor startup to the establishment of the path to docker.</p>
<p>When kubelet creates cadvisorClient, it creates the container manager, and then it calls the <code>Start</code> function of the container manager, and in the <code>Start</code> function, it registers docker, rkt, containerd, crio, etc.</p>
<p>So, cadvisor is actually the mover of Labels, and its data is also obtained by calling the APIs of docker, containerd, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start the container manager.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">self</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">docker</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fsInfo</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignoreMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Registration of the Docker container factory failed: %v.&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">rkt</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fsInfo</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignoreMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fsInfo</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignoreMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Registration of the containerd container factory failed: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">crio</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fsInfo</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignoreMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Registration of the crio container factory failed: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>On a wild assumption, if <code>docker.Register</code> fails to register, then you won&rsquo;t be able to get any information from docker inspect.</p>
<p>Check the kubelet logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@10-0-0-2 /var/log]# grep &#34;Registration of the Docker container factory&#34; messages*
</span></span><span class="line"><span class="cl">messages-20191013:Oct  8 16:51:45 10-0-0-2 kubelet: I1008 16:51:45.784752    3217 manager.go:297] Registration of the Docker container factory failed: failed to validate Docker info: version string &#34;dev&#34; doesn&#39;t match expected regular expression: &#34;(\d+)\.(\d+)\.(\d+)&#34;.
</span></span><span class="line"><span class="cl">messages-20191013:Oct  9 10:10:11 10-0-0-2 kubelet: I1009 10:10:11.221103  751886 manager.go:297] Registration of the Docker container factory failed: failed to validate Docker info: version string &#34;dev&#34; doesn&#39;t match expected regular expression: &#34;(\d+)\.(\d+)\.(\d+)&#34;.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Sure enough, docker registration failed. The reason for the registration failure is simple: the version of the docker was modified, and the version of the docker server is &ldquo;dev&rdquo;, which does not satisfy the regular expression <code>&quot;(\d+)\. (\d+)\. (\d+)&quot;</code>, so the registration fails, so the desired label cannot be inspected.</p>
<p>Although it can&rsquo;t be fetched from docker, can it be fetched from containerd?</p>
<p>The same, directly to the log grep &ldquo;Registration of&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@10-0-0-2 /var/log]# grep &#34;Registration of&#34; messages*
</span></span><span class="line"><span class="cl">messages-20191013:Oct  8 16:51:45 10-0-0-2 kubelet: I1008 16:51:45.784752    3217 manager.go:297] Registration of the Docker container factory failed: failed to validate Docker info: version string &#34;dev&#34; doesn&#39;t match expected regular expression: &#34;(\d+)\.(\d+)\.(\d+)&#34;.
</span></span><span class="line"><span class="cl">messages-20191013:Oct  8 16:51:45 10-0-0-2 kubelet: I1008 16:51:45.784809    3217 manager.go:302] Registration of the rkt container factory failed: unable to communicate with Rkt api service: rkt: cannot tcp Dial rkt api service: dial tcp [::1]:15441: connect: connection refused
</span></span><span class="line"><span class="cl">messages-20191013:Oct  8 16:51:45 10-0-0-2 kubelet: I1008 16:51:45.784937    3217 manager.go:313] Registration of the containerd container factory failed: unable to create containerd client: containerd: cannot unix dial containerd api service: dial unix /run/containerd/containerd.sock: connect: no such file or directory
</span></span><span class="line"><span class="cl">messages-20191013:Oct  8 16:51:45 10-0-0-2 kubelet: I1008 16:51:45.785134    3217 manager.go:318] Registration of the crio container factory failed: Get http://%2Fvar%2Frun%2Fcrio%2Fcrio.sock/info: dial unix /var/run/crio/crio.sock: connect: no such file or directory
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, containerd doesn&rsquo;t work either, there is no file socket, and everything else fails too. In other words, cadvisor has no data source and no way to add the labels that kubelet wants.</p>
<h2 id="solution">Solution</h2>
<p>It&rsquo;s simple, just generate the version of docker server by regular expression, for example &ldquo;18.06.1&rdquo;.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/prometheus/">Prometheus</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/nginx-ingress-maximumopenfile/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Tracing nginx ingress maximum open file count issue</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/k8s-shared-memory/">
            <span class="next-text nav-default">Setting up the shared memory of a kubernetes Pod</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
