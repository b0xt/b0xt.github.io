<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The principle of RxJava thread switching - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how RxJava thread switching through the source code ." /><meta name="keywords" content="rxjava, scheduler" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/rxjava-scheduler/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="The principle of RxJava thread switching" />
<meta property="og:description" content="Learn how RxJava thread switching through the source code ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/rxjava-scheduler/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-06T12:59:05+08:00" />
<meta property="article:modified_time" content="2022-06-06T12:59:05+08:00" />

<meta itemprop="name" content="The principle of RxJava thread switching">
<meta itemprop="description" content="Learn how RxJava thread switching through the source code ."><meta itemprop="datePublished" content="2022-06-06T12:59:05+08:00" />
<meta itemprop="dateModified" content="2022-06-06T12:59:05+08:00" />
<meta itemprop="wordCount" content="1882">
<meta itemprop="keywords" content="rxjava," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The principle of RxJava thread switching"/>
<meta name="twitter:description" content="Learn how RxJava thread switching through the source code ."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The principle of RxJava thread switching</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-06 12:59:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1882 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#scheduler">Scheduler</a></li>
        <li><a href="#newthread">newThread</a></li>
        <li><a href="#chained-calls">Chained Calls</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>RxJava is designed on the basis of chained calls, and by setting different schedulers, you can flexibly switch between threads and execute the corresponding Task.</p>
<p>Let&rsquo;s take a look at how this switching pattern is implemented.</p>
<h2 id="scheduler">Scheduler</h2>
<p><a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Scheduler.html">Scheduler</a> is the abstract parent class of all RxJava schedulers, and subclasses need to override its <code>createWorker()</code> to return a <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Scheduler.Worker.html">Worker</a> instance that accepts and executes a Task; it can also override its <code>scheduleDirect()</code> to determine how to assign a Task to a different worker. An abbreviated version of the Scheduler source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Scheduler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Worker</span> <span class="nf">createWorker</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 调度一次定时 Task，细节封装在传入的 Runnable 里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Disposable</span> <span class="nf">scheduleDirect</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span> <span class="n">Runnable</span> <span class="n">run</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 新建一个 Worker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Worker</span> <span class="n">w</span> <span class="o">=</span> <span class="n">createWorker</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 静态代理并封装我们想要执行的 Runnable，具体实现可忽略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">decoratedRun</span>
</span></span><span class="line"><span class="cl">      <span class="o">=</span> <span class="n">RxJavaPlugins</span><span class="o">.</span><span class="na">onSchedule</span><span class="o">(</span><span class="n">run</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DisposeTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisposeTask</span><span class="o">(</span><span class="n">decoratedRun</span><span class="o">,</span> <span class="n">w</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 将 Task 交给新建的 Worker 执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">w</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">delay</span><span class="o">,</span> <span class="n">unit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">task</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 同时 Worker 也是一个抽象类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">implements</span> <span class="n">Disposable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行被分配的定时 Task；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 注意，Worker 内部也可以维护一个自己的 Task 调度策略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Disposable</span> <span class="nf">schedule</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="nd">@NonNull</span> <span class="n">Runnable</span> <span class="n">run</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delay</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="nd">@NonNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In general, the default implementation of the Scheduler is to create a new instance of the Worker and assign the Task to it whenever a new Task arrives, and the Worker can also maintain a Task scheduling policy of its own internally.</p>
<h2 id="newthread">newThread</h2>
<p>RxJava&rsquo;s <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/schedulers/Schedulers.html#newThread--">newThread</a> scheduler starts a new thread for each new Task to execute it. Let&rsquo;s take newThread as an example and see how the simplest Scheduler is implemented.</p>
<p>Our usual <code>Schedulers.newThread()</code> is a singleton pattern that returns a NewThreadScheduler instance. Here is the corresponding source code for NewThreadScheduler.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">NewThreadScheduler</span> <span class="kd">extends</span> <span class="n">Scheduler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Worker</span> <span class="nf">createWorker</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="n">NewThreadWorker</span><span class="o">(</span><span class="n">threadFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the NewThreadScheduler does not override the default behavior of <code>scheduleDirect()</code>, which is to &ldquo;create a new worker instance and assign a Task to it whenever a new Task arrives&rdquo;; it simply overrides <code>createWorker()</code> to return a concrete NewThreadWorker instance.</p>
<p>Let&rsquo;s look at the corresponding source code for NewThreadWorker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewThreadWorker</span> <span class="kd">extends</span> <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span>
</span></span><span class="line"><span class="cl">  <span class="kd">implements</span> <span class="n">Disposable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">private</span> <span class="kd">final</span> <span class="n">ScheduledExecutorService</span> <span class="n">executor</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">NewThreadWorker</span><span class="o">(</span><span class="n">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 最终被赋值为 Executors.newScheduledThreadPool(1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">executor</span> <span class="o">=</span> <span class="n">SchedulerPoolFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">threadFactory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">Disposable</span> <span class="nf">schedule</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span> <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">action</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delayTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">scheduleActual</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">delayTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="n">ScheduledRunnable</span> <span class="nf">scheduleActual</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">run</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delayTime</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Nullable</span> <span class="n">DisposableContainer</span> <span class="n">parent</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 静态代理并封装我们想要执行的 Runnable，具体实现可忽略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Runnable</span> <span class="n">decoratedRun</span> <span class="o">=</span> <span class="n">RxJavaPlugins</span><span class="o">.</span><span class="na">onSchedule</span><span class="o">(</span><span class="n">run</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ScheduledRunnable</span> <span class="n">sr</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="n">ScheduledRunnable</span><span class="o">(</span><span class="n">decoratedRun</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Future</span><span class="o">&lt;?&gt;</span> <span class="n">f</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">(</span><span class="n">delayTime</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 立即执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">f</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">((</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;)</span> <span class="n">sr</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 延时调度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">f</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="o">(</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;)</span> <span class="n">sr</span><span class="o">,</span> <span class="n">delayTime</span><span class="o">,</span> <span class="n">unit</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">sr</span><span class="o">.</span><span class="na">setFuture</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RejectedExecutionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sr</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Combining the source code of NewThreadScheduler and NewThreadWorker, you can see that each new Task is immediately executed or deferred by a newly created thread pool with a capacity of 1 <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ScheduledExecutorService.html">ScheduledExecutorService</a>, which is a multi-threaded scheduler implementation natively provided by the JDK, is executed immediately or deferred. Other RxJava scheduler implementations will not be expanded here, you can check the corresponding source code if you are interested.</p>
<h2 id="chained-calls">Chained Calls</h2>
<p>After understanding the concrete implementation of Scheduler, we also need to know how Scheduler works in chained calls. For more information about how chained calls work in RxJava, it is recommended to read my <a href="/post/2022-06/rxjava-chain/">previous article</a> on RxJava chained call principles, so I won&rsquo;t go into it here. Here we will focus on the <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Observable.html#subscribeOn-io.reactivex.Scheduler-">subscribeOn</a> and <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Observable.html#observeOn-io.reactivex.Scheduler-">observeOn</a> operators for thread switching. Note that this article uses the operator implementation of <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Observable.html">Observable</a> as the object of discussion.</p>
<p>subscribeOn is used to set the thread in which the Observable starts execution; observeOn is used to set the thread in which the downstream operator starts from where the operator is called. A typical thread switching scenario is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">Observable</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">// 在 io 调度器上执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">.</span><span class="nf">subscribeOn</span><span class="p">(</span><span class="nx">Schedulers</span><span class="p">.</span><span class="nf">io</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nf">observeOn</span><span class="p">(</span><span class="nx">AndroidSchedulers</span><span class="p">.</span><span class="nf">mainThread</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1">// 在 Android 主线程上执行
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s look at the corresponding source code for subscribeOn.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Observable</span><span class="o">&lt;</span><span class="nd">@NonNull</span> <span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">implements</span> <span class="n">ObservableSource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">subscribeOn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span> <span class="n">Scheduler</span> <span class="n">scheduler</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">RxJavaPlugins</span><span class="o">.</span><span class="na">onAssembly</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="n">ObservableSubscribeOn</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s look at the source code for ObservableSubscribeOn.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ObservableSubscribeOn</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">extends</span> <span class="n">AbstractObservableWithUpstream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">ObservableSubscribeOn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObservableSource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">,</span> <span class="n">Scheduler</span> <span class="n">scheduler</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribeActual</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Observer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">observer</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 静态代理传入的上游 Observer，具体实现可忽略
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">SubscribeOnObserver</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">parent</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="n">SubscribeOnObserver</span><span class="o">&lt;&gt;(</span><span class="n">observer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">parent</span><span class="o">.</span><span class="na">setDisposable</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">scheduler</span><span class="o">.</span><span class="na">scheduleDirect</span><span class="o">(</span><span class="k">new</span> <span class="n">SubscribeTask</span><span class="o">(</span><span class="n">parent</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SubscribeTask</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">SubscribeOnObserver</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">SubscribeTask</span><span class="o">(</span><span class="n">SubscribeOnObserver</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 这是 Runnable 接口必须实现的方法，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 使得 subscribe() 可以运行在对应的 Scheduler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// source 对象是上游的 Observable,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// parent 对象是下游的 Observer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">source</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, observeOn wraps <code>subscribe()</code> of the Observable in a Task and calls <code>scheduleDirect()</code> of the Scheduler to switch threads, thus achieving the purpose of &ldquo;setting the thread where the Observable starts execution&rdquo;.</p>
<p>Next, let&rsquo;s look at the source code for observeOn.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Observable</span><span class="o">&lt;</span><span class="nd">@NonNull</span> <span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">implements</span> <span class="n">ObservableSource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@NonNull</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Observable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">observeOn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@NonNull</span> <span class="n">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">delayError</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bufferSize</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">RxJavaPlugins</span><span class="o">.</span><span class="na">onAssembly</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="n">ObservableObserveOn</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">,</span> <span class="n">scheduler</span><span class="o">,</span> <span class="n">delayError</span><span class="o">,</span> <span class="n">bufferSize</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s look at the source code for ObservableObserveOn.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ObservableSubscribeOn</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">extends</span> <span class="n">AbstractObservableWithUpstream</span><span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Scheduler</span> <span class="n">scheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="nf">ObservableObserveOn</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">ObservableSource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">,</span> <span class="n">Scheduler</span> <span class="n">scheduler</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">delayError</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bufferSize</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">super</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribeActual</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Observer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">observer</span>
</span></span><span class="line"><span class="cl">  <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">scheduler</span> <span class="k">instanceof</span> <span class="n">TrampolineScheduler</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 直接创建一个新的 Worker 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span> <span class="n">w</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="na">createWorker</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// source 对象是上游的 Observable，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// observer 对象是下游的 Observer；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 此处通过创建一个 ObserveOnObserver 作为中间人角色，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 它订阅了 source 并在相关回调中调用 observer 的对应方法,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 仍然是静态代理模式的应用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">source</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="k">new</span> <span class="n">ObserveOnObserver</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">        <span class="n">observer</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span> <span class="n">delayError</span><span class="o">,</span> <span class="n">bufferSize</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ObserveOnObserver</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">extends</span> <span class="n">BasicIntQueueDisposable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">implements</span> <span class="n">Observer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;,</span> <span class="n">Runnable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Observer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">downstream</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span> <span class="n">worker</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ObserveOnObserver</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">Observer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">actual</span><span class="o">,</span> <span class="n">Scheduler</span><span class="o">.</span><span class="na">Worker</span> <span class="n">worker</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">boolean</span> <span class="n">delayError</span><span class="o">,</span> <span class="kt">int</span> <span class="n">bufferSize</span>
</span></span><span class="line"><span class="cl">    <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">.</span><span class="na">downstream</span> <span class="o">=</span> <span class="n">actual</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">.</span><span class="na">worker</span> <span class="o">=</span> <span class="n">worker</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 和平时调用 subscribe() 时 new Observer 一样，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 复写以下四个方法；具体实现相对复杂，略去不表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSubscribe</span><span class="o">(</span><span class="n">Disposable</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 主要调用 downstream 的逻辑在这里；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这是 Runnable 接口必须实现的方法，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 使得 downstream 可以运行在对应的 Scheduler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 实际的逻辑跳转很多，但最终在这里切换线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span> <span class="nf">schedule</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">(</span><span class="n">getAndIncrement</span><span class="o">()</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">worker</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, observeOn achieves the purpose of &ldquo;setting the thread where the downstream operator is located from the point where the operator is invoked&rdquo; by encapsulating the invocation logic for calling the downstream Observer in a Task and switching threads by the specified Worker instance.</p>
<p>As you may have noticed here, we know from the previous Scheduler source code that the default call to <code>scheduleDirect()</code> is also to hand over the Task to the new Worker instance created by <code>createWorker()</code> for execution. implementation? If you&rsquo;re interested, take a look at the source code of the <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/schedulers/Schedulers.html#single--">single</a> scheduler, where the two methods can be more fully customized and the two methods are not necessarily directly related. Just make sure that the underlying dispatching logic is correct and you&rsquo;ll be OK.</p>
<p>Finally, even today, when the same JVM-based language <a href="https://kotlinlang.org/">Kotlin</a> already supports coroutines, RxJava is still a library well worth learning and using, as it handles thread switching so elegantly using only the multithreading API provided by the JDK. The author does not consider it obsolete.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/rxjava/">rxjava</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/duff-device/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Duff&#39;s Device</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/rxjava-chain/">
            <span class="next-text nav-default">The principle of RxJava chain calls</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
