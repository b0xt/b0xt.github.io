<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Extending Grafana Loki with Read-Write Separation Patterns - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to extend Grafana Loki using the read-write separation pattern." /><meta name="keywords" content="Grafana Loki, Read-Write Separation" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/grafana-loki-rw/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Extending Grafana Loki with Read-Write Separation Patterns" />
<meta property="og:description" content="Learn how to extend Grafana Loki using the read-write separation pattern." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/grafana-loki-rw/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-18T14:11:45+08:00" />
<meta property="article:modified_time" content="2022-06-18T14:11:45+08:00" />

<meta itemprop="name" content="Extending Grafana Loki with Read-Write Separation Patterns">
<meta itemprop="description" content="Learn how to extend Grafana Loki using the read-write separation pattern."><meta itemprop="datePublished" content="2022-06-18T14:11:45+08:00" />
<meta itemprop="dateModified" content="2022-06-18T14:11:45+08:00" />
<meta itemprop="wordCount" content="2449">
<meta itemprop="keywords" content="grafana," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Extending Grafana Loki with Read-Write Separation Patterns"/>
<meta name="twitter:description" content="Learn how to extend Grafana Loki using the read-write separation pattern."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Extending Grafana Loki with Read-Write Separation Patterns</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-18 14:11:45 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2449 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#standalone-mode">Standalone mode</a></li>
        <li><a href="#readwrite-separation-mode">Read/Write Separation Mode</a>
          <ul>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#promtail-writing-data">Promtail writing data</a></li>
            <li><a href="#grafana-read-data">Grafana Read Data</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Built from multiple microservice components that can run as a horizontally scalable distributed system, Loki is uniquely designed to compile the code of an entire distributed system into individual binaries or Docker images, with the behavior of the individual binaries controlled by the <code>-target</code> command line flag.</p>
<h2 id="standalone-mode">Standalone mode</h2>
<p>The simplest mode of operation is to set <code>-target=all</code>, which is the default way and does not need to be specified. This is the monolithic mode, which runs all of Loki&rsquo;s microservice components in a single process in the form of a single binary or Docker image.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/cda729ca9438485796f54d5e6b9a4824.png" alt="Standalone mode"></p>
<p>The monolithic mode is useful for getting started with Loki quickly and for reads and writes with data volumes of about 100GB per day. Scaling the monolithic mode deployment level to more instances can be done by using a shared object store and configuring the <code>memberlist_config</code> property to share state between all instances.</p>
<p>High availability can be configured by running two Loki instances with <code>memberlist_config</code> configuration and a shared object store. Traffic is routed to all Loki instances in a round-robin fashion. Parallel queries are limited by the number of instances and the defined query parallelism.</p>
<p>Installation of the monolithic model is very simple and is done directly using the Helm Chart package <code>grafana/loki-stack</code>.</p>
<h2 id="readwrite-separation-mode">Read/Write Separation Mode</h2>
<p>If you have more than a few hundred GB of logs per day, or if you want to separate reads and writes, Loki offers a simple scalable deployment model. This deployment mode can scale to several terabytes or more of logs per day.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/14ad96f94e094566b181c7d477a5122b.png" alt="Read/Write Separation Mode"></p>
<p>In this mode, Loki&rsquo;s component microservices are bound to two targets: <code>-target=read</code> and <code>-target=write</code>, and the BoltDB compactor service will run as part of the read target.</p>
<p>Separating the read and write paths has the following advantages.</p>
<ul>
<li>Improved availability of the write path by providing dedicated nodes</li>
<li>Read paths can be scaled separately to add/remove query performance on demand</li>
</ul>
<p>This read/write separation pattern requires a load balancer in front of Loki that routes <code>/loki/api/v1/push</code> traffic to the write node, all other requests go to the read node, and traffic should be sent in a round-robin fashion.</p>
<h3 id="installation">Installation</h3>
<p>We also use Helm Chart for installation, first getting the Chart package for the read-write separation model.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span class="line"><span class="cl">$ helm pull grafana/loki-simple-scalable --untar --version 1.4.1
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> loki-simple-scalable
</span></span></code></pre></td></tr></table>
</div>
</div><p>The Chart package supports the components shown in the table below. Ingester, distributor, querier, and query-frontend are installed, and the other components are optional.</p>
<table>
<thead>
<tr>
<th>Loki component</th>
<th>is optional</th>
<th>is enabled by default</th>
</tr>
</thead>
<tbody>
<tr>
<td>gateway</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>write</td>
<td>❎</td>
<td>n/a</td>
</tr>
<tr>
<td>read</td>
<td>❎</td>
<td>n/a</td>
</tr>
</tbody>
</table>
<p>Here we use MinIO as a remote data store and configure the number of copies of Loki instances to be read and written to be 2. In order to add a load balancer in front of Loki, we need to enable Gateway, and the corresponding Values file is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># ci/minio-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">loki</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">commonConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path_prefix</span><span class="p">:</span><span class="w"> </span><span class="l">/var/loki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replication_factor</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">authEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Configuration for the write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">write</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Number of replicas for the write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    podAntiAffinity:
</span></span></span><span class="line"><span class="cl"><span class="sd">      preferredDuringSchedulingIgnoredDuringExecution:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - weight: 1
</span></span></span><span class="line"><span class="cl"><span class="sd">          podAffinityTerm:
</span></span></span><span class="line"><span class="cl"><span class="sd">            labelSelector:
</span></span></span><span class="line"><span class="cl"><span class="sd">              matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="sd">                {{- include &#34;loki.writeSelectorLabels&#34; . | nindent 12 }}
</span></span></span><span class="line"><span class="cl"><span class="sd">            topologyKey: kubernetes.io/hostname</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Configuration for the read node(s)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">read</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Number of replicas for the read</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">affinity</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    podAntiAffinity:
</span></span></span><span class="line"><span class="cl"><span class="sd">      preferredDuringSchedulingIgnoredDuringExecution:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - weight: 1
</span></span></span><span class="line"><span class="cl"><span class="sd">          podAffinityTerm:
</span></span></span><span class="line"><span class="cl"><span class="sd">            labelSelector:
</span></span></span><span class="line"><span class="cl"><span class="sd">              matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="sd">                {{- include &#34;loki.readSelectorLabels&#34; . | nindent 12 }}
</span></span></span><span class="line"><span class="cl"><span class="sd">            topologyKey: kubernetes.io/hostname</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Configuration for the gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Specifies whether the gateway should be enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># -------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Configuration for `minio` child chart</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># -------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">minio</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessKey</span><span class="p">:</span><span class="w"> </span><span class="l">enterprise-logs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secretKey</span><span class="p">:</span><span class="w"> </span><span class="l">supersecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">buckets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">chunks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">purge</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ruler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">purge</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l">none</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">purge</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then use the values file above to install Loki in read-write mode.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install loki -n logging -f ci/minio-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;loki&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: loki
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Fri Jun <span class="m">17</span> 14:53:20 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl"> Welcome to Grafana Loki
</span></span><span class="line"><span class="cl"> Chart version: 1.4.1
</span></span><span class="line"><span class="cl"> Loki version: 2.5.0
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Installed components:
</span></span><span class="line"><span class="cl">* gateway
</span></span><span class="line"><span class="cl">* <span class="nb">read</span>
</span></span><span class="line"><span class="cl">* write
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This chart requires persistence and object storage to work correctly.
</span></span><span class="line"><span class="cl">Queries will not work unless you provide a <span class="sb">`</span>loki.config.common.storage<span class="sb">`</span> section with
</span></span><span class="line"><span class="cl">a valid object storage <span class="o">(</span>and the default <span class="sb">`</span>filesystem<span class="sb">`</span> storage <span class="nb">set</span> to <span class="sb">`</span>null<span class="sb">`</span><span class="o">)</span>, as well
</span></span><span class="line"><span class="cl">as a valid <span class="sb">`</span>loki.config.schema_config.configs<span class="sb">`</span> with an <span class="sb">`</span>object_store<span class="sb">`</span> that
</span></span><span class="line"><span class="cl">matches the common storage section.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For example, to use MinIO as your object storage backend:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">loki:
</span></span><span class="line"><span class="cl">  config:
</span></span><span class="line"><span class="cl">    common:
</span></span><span class="line"><span class="cl">      storage:
</span></span><span class="line"><span class="cl">        filesystem: null
</span></span><span class="line"><span class="cl">        s3:
</span></span><span class="line"><span class="cl">          endpoint: minio.minio.svc.cluster.local:9000
</span></span><span class="line"><span class="cl">          insecure: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">          bucketnames: loki-data
</span></span><span class="line"><span class="cl">          access_key_id: loki
</span></span><span class="line"><span class="cl">          secret_access_key: supersecret
</span></span><span class="line"><span class="cl">          s3forcepathstyle: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">    schema_config:
</span></span><span class="line"><span class="cl">      configs:
</span></span><span class="line"><span class="cl">        - from: <span class="s2">&#34;2020-09-07&#34;</span>
</span></span><span class="line"><span class="cl">          store: boltdb-shipper
</span></span><span class="line"><span class="cl">          object_store: s3
</span></span><span class="line"><span class="cl">          schema: v11
</span></span><span class="line"><span class="cl">          index:
</span></span><span class="line"><span class="cl">            period: 24h
</span></span><span class="line"><span class="cl">            prefix: loki_index_
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the installation is complete, check the Pod status to see if it is OK.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n logging
</span></span><span class="line"><span class="cl">NAME                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">loki-gateway-67f76958d7-bq46l   1/1     Running   <span class="m">0</span>          91m
</span></span><span class="line"><span class="cl">loki-minio-87c9bc6f5-jxdcn      1/1     Running   <span class="m">0</span>          70m
</span></span><span class="line"><span class="cl">loki-read-0                     1/1     Running   <span class="m">0</span>          81s
</span></span><span class="line"><span class="cl">loki-read-1                     1/1     Running   <span class="m">0</span>          81s
</span></span><span class="line"><span class="cl">loki-read-2                     1/1     Running   <span class="m">0</span>          81s
</span></span><span class="line"><span class="cl">loki-write-0                    1/1     Running   <span class="m">0</span>          81s
</span></span><span class="line"><span class="cl">loki-write-1                    1/1     Running   <span class="m">0</span>          81s
</span></span><span class="line"><span class="cl">loki-write-2                    1/1     Running   <span class="m">0</span>          81s
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that two copies of Loki are deployed for write and read respectively, and there is also a Pod for gateway, which is actually an nginx application that routes <code>/loki/api/v1/push</code> requests to the write node, which we can verify by looking at the configuration of gateway.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">$ kubectl get cm -n logging loki-gateway -o yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nginx.conf</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    worker_processes  5;  ## Default: 1
</span></span></span><span class="line"><span class="cl"><span class="sd">    error_log  /dev/stderr;
</span></span></span><span class="line"><span class="cl"><span class="sd">    pid        /tmp/nginx.pid;
</span></span></span><span class="line"><span class="cl"><span class="sd">    worker_rlimit_nofile 8192;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    events {
</span></span></span><span class="line"><span class="cl"><span class="sd">      worker_connections  4096;  ## Default: 1024
</span></span></span><span class="line"><span class="cl"><span class="sd">    }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    http {
</span></span></span><span class="line"><span class="cl"><span class="sd">      client_body_temp_path /tmp/client_temp;
</span></span></span><span class="line"><span class="cl"><span class="sd">      proxy_temp_path       /tmp/proxy_temp_path;
</span></span></span><span class="line"><span class="cl"><span class="sd">      fastcgi_temp_path     /tmp/fastcgi_temp;
</span></span></span><span class="line"><span class="cl"><span class="sd">      uwsgi_temp_path       /tmp/uwsgi_temp;
</span></span></span><span class="line"><span class="cl"><span class="sd">      scgi_temp_path        /tmp/scgi_temp;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      default_type application/octet-stream;
</span></span></span><span class="line"><span class="cl"><span class="sd">      log_format   main &#39;$remote_addr - $remote_user [$time_local]  $status &#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#39;&#34;$request&#34; $body_bytes_sent &#34;$http_referer&#34; &#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">            &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
</span></span></span><span class="line"><span class="cl"><span class="sd">      access_log   /dev/stderr  main;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      sendfile     on;
</span></span></span><span class="line"><span class="cl"><span class="sd">      tcp_nopush   on;
</span></span></span><span class="line"><span class="cl"><span class="sd">      resolver kube-dns.kube-system.svc.cluster.local;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      server {
</span></span></span><span class="line"><span class="cl"><span class="sd">        listen             8080;
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location = / {
</span></span></span><span class="line"><span class="cl"><span class="sd">          return 200 &#39;OK&#39;;
</span></span></span><span class="line"><span class="cl"><span class="sd">          auth_basic off;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location = /api/prom/push {
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_pass       http://loki-write.logging.svc.cluster.local:3100$request_uri;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location = /api/prom/tail {
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_set_header Upgrade $http_upgrade;
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_set_header Connection &#34;upgrade&#34;;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location ~ /api/prom/.* {
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location = /loki/api/v1/push {
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_pass       http://loki-write.logging.svc.cluster.local:3100$request_uri;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location = /loki/api/v1/tail {
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_set_header Upgrade $http_upgrade;
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_set_header Connection &#34;upgrade&#34;;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        location ~ /loki/api/.* {
</span></span></span><span class="line"><span class="cl"><span class="sd">          proxy_pass       http://loki-read.logging.svc.cluster.local:3100$request_uri;
</span></span></span><span class="line"><span class="cl"><span class="sd">        }
</span></span></span><span class="line"><span class="cl"><span class="sd">      }
</span></span></span><span class="line"><span class="cl"><span class="sd">    }</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-name</span><span class="p">:</span><span class="w"> </span><span class="l">loki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">meta.helm.sh/release-namespace</span><span class="p">:</span><span class="w"> </span><span class="l">logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2022-06-17T06:53:22Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/component</span><span class="p">:</span><span class="w"> </span><span class="l">gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">loki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/managed-by</span><span class="p">:</span><span class="w"> </span><span class="l">Helm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/name</span><span class="p">:</span><span class="w"> </span><span class="l">loki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/version</span><span class="p">:</span><span class="w"> </span><span class="m">2.5.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">helm.sh/chart</span><span class="p">:</span><span class="w"> </span><span class="l">loki-simple-scalable-1.4.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">loki-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4968787&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">ba9ba1c0-8561-41cb-8b55-287f352b5ee8</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The above is a typical Nginx configuration, from which you can see that the requests <code>/api/prom/push</code> and <code>/loki/api/v1/push</code> for the Push API are proxied to the <code>http://loki-write.logging.svc.cluster.local:3100$ request_uri;</code>, the two <code>loki-write</code> nodes above, while the read-related interfaces are proxied to the <code>loki-read</code> node, and then the <code>loki-write</code> start-up parameters are configured with <code>-target=write</code> and <code>loki-read</code> start-up parameters with <code>-target=read</code>. to achieve read/write separation. However, the read and write applications share the same configuration file, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get cm -n logging loki -o yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  config.yaml: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    auth_enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    common:
</span></span><span class="line"><span class="cl">      path_prefix: /var/loki
</span></span><span class="line"><span class="cl">      replication_factor: <span class="m">2</span>
</span></span><span class="line"><span class="cl">      storage:
</span></span><span class="line"><span class="cl">        s3:
</span></span><span class="line"><span class="cl">          access_key_id: enterprise-logs
</span></span><span class="line"><span class="cl">          bucketnames: chunks
</span></span><span class="line"><span class="cl">          endpoint: loki-minio.logging.svc:9000
</span></span><span class="line"><span class="cl">          insecure: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">          s3forcepathstyle: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">          secret_access_key: supersecret
</span></span><span class="line"><span class="cl">    limits_config:
</span></span><span class="line"><span class="cl">      enforce_metric_name: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      max_cache_freshness_per_query: 10m
</span></span><span class="line"><span class="cl">      reject_old_samples: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      reject_old_samples_max_age: 168h
</span></span><span class="line"><span class="cl">      split_queries_by_interval: 15m
</span></span><span class="line"><span class="cl">    memberlist:
</span></span><span class="line"><span class="cl">      join_members:
</span></span><span class="line"><span class="cl">      - loki-memberlist
</span></span><span class="line"><span class="cl">    ruler:
</span></span><span class="line"><span class="cl">      storage:
</span></span><span class="line"><span class="cl">        s3:
</span></span><span class="line"><span class="cl">          bucketnames: ruler
</span></span><span class="line"><span class="cl">    schema_config:
</span></span><span class="line"><span class="cl">      configs:
</span></span><span class="line"><span class="cl">      - from: <span class="s2">&#34;2022-06-17&#34;</span>
</span></span><span class="line"><span class="cl">        index:
</span></span><span class="line"><span class="cl">          period: 24h
</span></span><span class="line"><span class="cl">          prefix: loki_index_
</span></span><span class="line"><span class="cl">        object_store: s3
</span></span><span class="line"><span class="cl">        schema: v12
</span></span><span class="line"><span class="cl">        store: boltdb-shipper
</span></span><span class="line"><span class="cl">    server:
</span></span><span class="line"><span class="cl">      grpc_listen_port: <span class="m">9095</span>
</span></span><span class="line"><span class="cl">      http_listen_port: <span class="m">3100</span>
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>where <code>common.storage.s3</code> specifies the MinIO-related configuration, and <code>memberlist.join_members</code> specifies the members, which are actually all the read/write nodes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get svc loki-memberlist -n logging -o wide
</span></span><span class="line"><span class="cl">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE   SELECTOR
</span></span><span class="line"><span class="cl">loki-memberlist   ClusterIP   None         &lt;none&gt;        7946/TCP   54m   app.kubernetes.io/instance<span class="o">=</span>loki,app.kubernetes.io/name<span class="o">=</span>loki,app.kubernetes.io/part-of<span class="o">=</span>memberlist
</span></span><span class="line"><span class="cl">$ kubectl get pods -n logging -l app.kubernetes.io/part-of<span class="o">=</span>memberlist
</span></span><span class="line"><span class="cl">NAME           READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">loki-read-0    1/1     Running   <span class="m">0</span>          32s
</span></span><span class="line"><span class="cl">loki-read-1    1/1     Running   <span class="m">0</span>          72s
</span></span><span class="line"><span class="cl">loki-read-2    1/1     Running   <span class="m">0</span>          115s
</span></span><span class="line"><span class="cl">loki-write-0   1/1     Running   <span class="m">0</span>          4s
</span></span><span class="line"><span class="cl">loki-write-1   1/1     Running   <span class="m">0</span>          55s
</span></span><span class="line"><span class="cl">loki-write-2   1/1     Running   <span class="m">0</span>          116s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we are done with the deployment of Loki read-write mode.</p>
<h3 id="promtail-writing-data">Promtail writing data</h3>
<p>To verify that the application is working properly, next we install Promtail and Grafana for reading and writing data.</p>
<p>Get the <code>promtail</code> Chart package and unpack it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm pull grafana/promtail --untar
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> promtail
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a values file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># ci/simple-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pspEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">lokiAddress</span><span class="p">:</span><span class="w"> </span><span class="l">http://loki-gateway/loki/api/v1/push</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Note that we need to configure the Loki address in Promtail to be <code>http://loki-gateway/loki/api/v1/push</code> so that Promtail sends the log data to the Gateway first, and then the Gateway forwards it to the write node based on our Endpoints. node, using the values file above to install Promtail.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install promtail -n logging -f ci/simple-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;promtail&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: promtail
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Fri Jun <span class="m">17</span> 16:01:08 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl"> Welcome to Grafana Promtail
</span></span><span class="line"><span class="cl"> Chart version: 5.1.0
</span></span><span class="line"><span class="cl"> Promtail version: 2.5.0
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Verify the application is working by running these commands:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* kubectl --namespace logging port-forward daemonset/promtail <span class="m">3101</span>
</span></span><span class="line"><span class="cl">* curl http://127.0.0.1:3101/metrics
</span></span></code></pre></td></tr></table>
</div>
</div><p>A promtail will be run on each node after a normal installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n logging -l app.kubernetes.io/name<span class="o">=</span>promtail
</span></span><span class="line"><span class="cl">NAME             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">promtail-5r9hl   1/1     Running   <span class="m">0</span>          2m25s
</span></span><span class="line"><span class="cl">promtail-85mk4   1/1     Running   <span class="m">0</span>          2m25s
</span></span><span class="line"><span class="cl">promtail-qlfnv   1/1     Running   <span class="m">0</span>          2m25s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normal promtail is already collecting all the container logs on the node, and then pushing the log data to the gateway, which forwards it to the write node, where we can view the gateway logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl logs -f loki-gateway-67f76958d7-bq46l -n logging
</span></span><span class="line"><span class="cl">10.244.1.170 - - <span class="o">[</span>17/Jun/2022:08:09:03 +0000<span class="o">]</span>  <span class="m">204</span> <span class="s2">&#34;POST /loki/api/v1/push HTTP/1.1&#34;</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;promtail/2.5.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">10.244.1.170 - - <span class="o">[</span>17/Jun/2022:08:09:04 +0000<span class="o">]</span>  <span class="m">204</span> <span class="s2">&#34;POST /loki/api/v1/push HTTP/1.1&#34;</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;promtail/2.5.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">10.244.2.205 - - <span class="o">[</span>17/Jun/2022:08:09:05 +0000<span class="o">]</span>  <span class="m">204</span> <span class="s2">&#34;POST /loki/api/v1/push HTTP/1.1&#34;</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;promtail/2.5.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the gateway is now receiving requests directly from <code>/loki/api/v1/push</code>, which is what promtail is sending. Normally, the log data is now distributed to the write node, which stores the data in minio. You can check to see if there is already log data in minio. The minio service was assigned a NodePort of 32000 when it was installed.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/1ae5069fb8034ed58194070a07b23874.png" alt="minio login"></p>
<p>The login credentials are</p>
<ul>
<li>accessKey: enterprise-logs</li>
<li>secretKey: supersecret</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/f1945aa235974a868f6f3992af277d49.png" alt="minio console"></p>
<p>You can see that there is no log data in the <code>chunks</code> bucket of minio. This is because the bucket we created above only has read permission by default, and we can change the bucket to have <strong>read and write</strong> permission.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/9952bef261a84190bd2a2df5b8f038fa.png" alt="minio console"></p>
<p>After normal modifications, a <code>fake</code> directory is created, which is the default data directory without multi-tenancy provisioning, under which the chunk data of the logs are stored.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/1fb7aa7db2664e1b8b496fac80935a5e.png" alt="minio console"></p>
<p>This is the path to where the Loki logs are written.</p>
<h3 id="grafana-read-data">Grafana Read Data</h3>
<p>Let&rsquo;s verify the read path and install Grafana to interface with Loki.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm pull grafana/grafana --untar
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> grafana
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create the values configuration file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># ci/simple-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pspEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Install Grafana directly using the values file above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install grafana -n logging -f ci/simple-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;grafana&#34;</span> has been upgraded. Happy Helming!
</span></span><span class="line"><span class="cl">NAME: grafana
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Fri Jun <span class="m">17</span> 17:00:24 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">2</span>
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">1. Get your <span class="s1">&#39;admin&#39;</span> user password by running:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   kubectl get secret --namespace logging grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2. The Grafana server can be accessed via port <span class="m">80</span> on the following DNS name from within your cluster:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   grafana.logging.svc.cluster.local
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Get the Grafana URL to visit by running these commands in the same shell:
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NODE_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get --namespace logging -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.spec.ports[0].nodePort}&#34;</span> services grafana<span class="k">)</span>
</span></span><span class="line"><span class="cl">     <span class="nb">export</span> <span class="nv">NODE_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get nodes --namespace logging -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].status.addresses[0].address}&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">     <span class="nb">echo</span> http://<span class="nv">$NODE_IP</span>:<span class="nv">$NODE_PORT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. Login with the password from step <span class="m">1</span> and the username: admin
</span></span></code></pre></td></tr></table>
</div>
</div><p>The login password can be obtained by using the command in the prompt above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get secret --namespace logging grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then log in to Grafana using the password and <code>admin</code> username above.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/74295cae83184650a04c636bb8000248.png" alt="Grafana"></p>
<p>After logging in, go to Grafana and add a data source. Here you need to fill in the gateway address <code>http://loki-gateway</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/4a61c4b114234b6193bc23d8ed156f22.png" alt="Grafana"></p>
<p>After saving the data source, you can go to the <code>Explore</code> page to filter the logs, for example, we are here to view the logs of the gateway application in real time, as shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/18/cd8a2f7679024269b8a940027e01e415.png" alt="Grafana"></p>
<p>If you can see the latest log data that means we have successfully deployed Loki in read-write separation mode, read-write separation mode can greatly improve the performance and capacity of Loki, if this mode is not enough to meet your data volume, then you can use <strong>microservice mode</strong> to deploy Loki.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/grafana/">grafana</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/jest/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Unit test execution exceptions and solutions after upgrading jest 28</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/go-gc/">
            <span class="next-text nav-default">Talking about Go&#39;s two soon-to-be-obsolete GC optimization strategies</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
