<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Tracing nginx ingress maximum open file count issue - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to resolve ingress-nginx exception: Too many open files." /><meta name="keywords" content="nginx ingress, Too many open files" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/nginx-ingress-maximumopenfile/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Tracing nginx ingress maximum open file count issue" />
<meta property="og:description" content="Learn how to resolve ingress-nginx exception: Too many open files." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/nginx-ingress-maximumopenfile/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-30T13:06:53+08:00" />
<meta property="article:modified_time" content="2022-06-30T13:06:53+08:00" />

<meta itemprop="name" content="Tracing nginx ingress maximum open file count issue">
<meta itemprop="description" content="Learn how to resolve ingress-nginx exception: Too many open files."><meta itemprop="datePublished" content="2022-06-30T13:06:53+08:00" />
<meta itemprop="dateModified" content="2022-06-30T13:06:53+08:00" />
<meta itemprop="wordCount" content="1897">
<meta itemprop="keywords" content="nginx," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tracing nginx ingress maximum open file count issue"/>
<meta name="twitter:description" content="Learn how to resolve ingress-nginx exception: Too many open files."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Tracing nginx ingress maximum open file count issue</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-30 13:06:53 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1897 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#problem-phenomenon">Problem phenomenon</a></li>
        <li><a href="#preliminary-analysis">Preliminary analysis</a></li>
        <li><a href="#linux-basics-fsfile-max-vs-ulimit">linux basics: fs.file-max vs ulimit</a>
          <ul>
            <li><a href="#fsfile-max">fs.file-max</a></li>
            <li><a href="#fsfile-nr">fs.file-nr</a></li>
            <li><a href="#ulimit">ulimit</a></li>
          </ul>
        </li>
        <li><a href="#in-depth-analysis">In-depth analysis</a></li>
        <li><a href="#solution">Solution</a>
          <ul>
            <li><a href="#changing-the-ulimit-default-for-docker-daemon">Changing the ulimit default for docker daemon</a></li>
            <li><a href="#etcsecuritylimitsconf">/etc/security/limits.conf</a></li>
            <li><a href="#modifying-the-calculation">Modifying the calculation</a></li>
            <li><a href="#modify-the-fallback">Modify the fallback</a></li>
            <li><a href="#not-playing-with-you-configuration-items">Not playing with you: configuration items</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="problem-phenomenon">Problem phenomenon</h2>
<p>Our kubernetes ingress controller is using <a href="https://github.com/kubernetes/ingress-nginx/">ingress-nginx</a> from kubernetes and we recently encountered a &quot; Too many open files&quot; problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">2019/09/19 09:47:56 [warn] 26281#26281: *97238945 a client request body is buffered to a temporary file /var/lib/nginx/body/0000269456, client: 1.1.1.1, server: xxx.ieevee.com, request: &#34;POST /api/v1/xxx HTTP/1.1&#34;, host: &#34;xxx.ieevee.com&#34;
</span></span><span class="line"><span class="cl">2019/09/19 09:47:56 [crit] 26281#26281: accept4() failed (24: Too many open files)
</span></span><span class="line"><span class="cl">2019/09/19 09:47:56 [crit] 26281#26281: *97238948 open() &#34;/var/lib/nginx/body/0000269457&#34; failed (24: Too many open files), client: 1.1.1.1, server: xxx.ieevee.com, request: &#34;POST /api/v1/xxx HTTP/1.1&#34;, host: &#34;xxx.ieevee.com&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="preliminary-analysis">Preliminary analysis</h2>
<p>Look at the prompt message, it is nginx opening too many files (nginx caching user requests). nginx establishes new connections, which are handled by the nginx worker, so let&rsquo;s see how many files are opened by the nginx worker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ps aux|grep worker</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">nobody   <span class="m">26281</span>  0.0  0.0 <span class="m">422196</span> <span class="m">71596</span> ?        Sl   13:05   0:00 nginx: worker process
</span></span><span class="line"><span class="cl">nobody   <span class="m">26282</span>  0.0  0.0 <span class="m">422196</span> <span class="m">71664</span> ?        Sl   13:05   0:00 nginx: worker process
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># cat /proc/26281/limits |grep open</span>
</span></span><span class="line"><span class="cl">Max open files            <span class="m">1024</span>                <span class="m">1024</span>                files
</span></span><span class="line"><span class="cl"><span class="c1"># lsof -p 26281|wc -l</span>
</span></span><span class="line"><span class="cl"><span class="m">910</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ulimit -n</span>
</span></span><span class="line"><span class="cl"><span class="m">65535</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the nginx worker can open a maximum of 1024 files, but the current process caught has opened 910, in the traffic is larger, there may be a larger number of open files problem. Also note the ulimit value, which will be mentioned later.</p>
<h2 id="linux-basics-fsfile-max-vs-ulimit">linux basics: fs.file-max vs ulimit</h2>
<h3 id="fsfile-max">fs.file-max</h3>
<p>First, there is a global range of the number of files that can be opened on linux.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># cat /proc/sys/fs/file-max</span>
</span></span><span class="line"><span class="cl"><span class="m">13179954</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Attention.</p>
<ul>
<li>This value is related to OS, hardware resources, and may be different for different systems. For example, the value above is on a physical server, but on a virtual machine it is only 808539; the value may also be different for the same hardware and different os</li>
<li>This value expresses the max value of open files at the system level, and has nothing to do with a user or a session</li>
<li>This value is <strong>changeable!</strong> If you run some database or web server, the default file-max is likely to be insufficient due to the need to open a large number of files, which can then be modified by sysctl.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># sysctl -w fs.file-max=500000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Or modify sysctl.conf to add <code>fs.file-max=500000</code> and <code>sysctl -p</code> to take effect.</p>
<h3 id="fsfile-nr">fs.file-nr</h3>
<p>sys fs also has a sibling value <code>file-nr</code>, which indicates the number of files that have been opened. As follows, it means that 55296 files have been opened, and as long as this value is below file-max, the system can still open new files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># cat /proc/sys/fs/file-nr</span>
</span></span><span class="line"><span class="cl"><span class="m">55296</span>   <span class="m">0</span>   <span class="m">13179954</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ulimit">ulimit</h3>
<p>What about ulimit, is it system level? No, this is a classic misconception. In fact, ulimit limits the resources that <strong>a process</strong> can use.</p>
<p>If it&rsquo;s on the host, you can modify ulimit by modifying <code>/etc/security/limits.conf</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//未设置时，可打开文件soft限制是1024。
</span></span><span class="line"><span class="cl">$ ulimit -Sn
</span></span><span class="line"><span class="cl">1024
</span></span><span class="line"><span class="cl">$ ulimit -Hn
</span></span><span class="line"><span class="cl">1048576
</span></span><span class="line"><span class="cl">//修改limits.conf
</span></span><span class="line"><span class="cl">$ cat /etc/security/limits.conf
</span></span><span class="line"><span class="cl">bottle           soft    nofile          10000
</span></span><span class="line"><span class="cl">bottle           hard    nofile          100000
</span></span><span class="line"><span class="cl">//ssh重新登录
</span></span><span class="line"><span class="cl">$ ulimit -Sn
</span></span><span class="line"><span class="cl">10000
</span></span><span class="line"><span class="cl">$ ulimit -Hn
</span></span><span class="line"><span class="cl">100000
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="in-depth-analysis">In-depth analysis</h2>
<p>Back to the original question.</p>
<p>Our nginx ingress controller is running in a container, so the number of files that the nginx worker can open depends on the ulimit in the container.</p>
<p>As we can see from the previous logs, the maximum number of files that can be opened by the ulimit in the container is 65535, the nginx worker is a multi-threaded model, and the number of threads depends on the number of cpu cores, so the number of files that can be opened by each nginx worker is 65535/(number of cpu cores). The maximum number of files that each nginx worker can open is 65535/56 = 1170.</p>
<p>So where does the maximum number of open files per nginx worker of 1024 come from?</p>
<p>Let&rsquo;s look at how it is calculated in ingress-nginx.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// the limit of open files is per worker process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and we leave some room to avoid consuming all the FDs available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">WorkerProcesses</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;number of worker processes: %v&#34;</span><span class="p">,</span> <span class="nx">wp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wp</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxOpenFiles</span> <span class="o">:=</span> <span class="p">(</span><span class="nf">sysctlFSFileMax</span><span class="p">()</span> <span class="o">/</span> <span class="nx">wp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">    <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;maximum number of open file descriptors : %v&#34;</span><span class="p">,</span> <span class="nx">maxOpenFiles</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">maxOpenFiles</span> <span class="p">&lt;</span> <span class="mi">1024</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// this means the value of RLIMIT_NOFILE is too low.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">maxOpenFiles</span> <span class="p">=</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This means that 1024 will be deducted for the thread itself (after all, it has to open some .so .a etc. files) and the rest will be used to process web requests; if it is less than 1024, it will be rounded up to 1024, so we saw earlier that the maximum number of open files per nginx worker is 1024.</p>
<h2 id="solution">Solution</h2>
<p>Now the problem is clear, it is the nginx worker can open the maximum number of files, how to solve it?</p>
<p>Can #### ulimit do it?</p>
<p>The first solution that comes to mind is to modify ulimit.</p>
<p>However, since nginx for the ingress controller is running in a container, we need to modify the limit in the container.</p>
<p>docker is also essentially a process, if you want to set ulimit, take docker run as an example, you can set the <code>-ulimit</code> parameter in the format =[:], the maximum number of open files we want to set, and the type corresponds to nofile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ docker run -it --ulimit <span class="nv">nofile</span><span class="o">=</span>1024:65535 ubuntu bash
</span></span><span class="line"><span class="cl">root@917bd8850581:/# <span class="nb">ulimit</span> -Sn
</span></span><span class="line"><span class="cl"><span class="m">1024</span>
</span></span><span class="line"><span class="cl">root@917bd8850581:/# <span class="nb">ulimit</span> -Hn
</span></span><span class="line"><span class="cl"><span class="m">65535</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As mentioned before, ulimit represents the limits of the &ldquo;process&rdquo;, what about the ulimit of the child processes of the process? We&rsquo;ll go back to bash to see if the container is the same as before.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@917bd8850581:/# bash
</span></span><span class="line"><span class="cl">root@917bd8850581:/# <span class="nb">ulimit</span> -Sn
</span></span><span class="line"><span class="cl"><span class="m">1024</span>
</span></span><span class="line"><span class="cl">root@917bd8850581:/# <span class="nb">ulimit</span> -Hn
</span></span><span class="line"><span class="cl"><span class="m">65535</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the ulimit of the child process (the new bash) and the ulimit of the parent process (i.e. the docker run up bash), are the same.</p>
<p>Therefore, we can find a way to pass this parameter to the nginx worker, so that we can control the maximum number of open files for the nginx worker.</p>
<p>However, kubernetes does not support user-defined ulimit.<a href="https://github.com/kubernetes/kubernetes/issues/3595">issue 3595</a> was proposed by thockin when docker first introduced ulimit settings, but years have passed and there is no CLOSE, and the community has a different voice about this option.</p>
<p>This method does not work.</p>
<h3 id="changing-the-ulimit-default-for-docker-daemon">Changing the ulimit default for docker daemon</h3>
<p>The ulimit value of processes in containers is inherited from docker daemon, so we can modify the configuration of docker daemon to set the default ulimit so that we can control the ulimit value of containers running on the ingress machine (including the ingress container itself). Modify <code>/etc/docker/daemon.json</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="s">&#34;default-ulimits&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;nofile&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Name&#34;</span><span class="p">:</span> <span class="s">&#34;nofile&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Hard&#34;</span><span class="p">:</span> <span class="mi">64000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Soft&#34;</span><span class="p">:</span> <span class="mi">64000</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This way can be passed, but it is slightly tricky, so don&rsquo;t use it for now.</p>
<h3 id="etcsecuritylimitsconf">/etc/security/limits.conf</h3>
<p>Since you can modify ulimit on the host through <code>/etc/security/limits.conf</code>, can&rsquo;t you do the same in the container?</p>
<p>Let&rsquo;s make a new image and overwrite the <code>/etc/security/limits.conf</code> in the original image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> ubuntu</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> limits.conf /etc/security/limits.conf<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The contents of limits.conf are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root           soft    nofile          <span class="m">10000</span>
</span></span><span class="line"><span class="cl">root           hard    nofile          <span class="m">100000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Make a new image, named xxx, without setting <code>--ulimit</code> After booting, view.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ docker run -it --rm ubuntu bash
</span></span><span class="line"><span class="cl">root@fee1ea85ca56:/# <span class="nb">ulimit</span> -Sn
</span></span><span class="line"><span class="cl"><span class="m">1048576</span>
</span></span><span class="line"><span class="cl">root@fee1ea85ca56:/# <span class="nb">ulimit</span> -Hn
</span></span><span class="line"><span class="cl"><span class="m">1048576</span>
</span></span><span class="line"><span class="cl">root@fee1ea85ca56:/# <span class="nb">exit</span>
</span></span><span class="line"><span class="cl">$ docker run -it --rm xxx bash
</span></span><span class="line"><span class="cl">root@d535db9287b0:/# <span class="nb">ulimit</span> -Sn
</span></span><span class="line"><span class="cl"><span class="m">1048576</span>
</span></span><span class="line"><span class="cl">root@d535db9287b0:/# <span class="nb">ulimit</span> -Hn
</span></span><span class="line"><span class="cl"><span class="m">1048576</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Unfortunately, docker doesn&rsquo;t use the <code>/etc/security/limits.conf</code> file, so it doesn&rsquo;t work either.</p>
<h3 id="modifying-the-calculation">Modifying the calculation</h3>
<p>This issue was actually encountered by someone in 2018 and submitted <a href="https://github.com/kubernetes/ingress-nginx/pull/2050">PR 2050</a>.</p>
<p>The author&rsquo;s idea is that since I can&rsquo;t set ulimit, I can solve the problem by setting <code>fs.file-max</code> in the container (e.g. by adding init Container) and modifying the way ingress nginx is calculated, wouldn&rsquo;t that solve the problem?</p>
<p>Set in init Container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sysctl -w fs.file-max<span class="o">=</span>xxx
</span></span></code></pre></td></tr></table>
</div>
</div><p>The change in ingress nginx is also very simple, the previous calculation is not modified, just the <a href="https://github.com/kubernetes/ingress-nginx/pull/2050/files">implementation</a> of <code>sysctlFSFileMax</code> is changed from getting ulimit to <code>fs/file-max</code> (obviously, the original comment was wrong, because it was actually ulimit, process-level, not fs.file-max).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sysctlFSFileMax returns the value of fs.file-max, i.e.
</span></span></span><span class="line"><span class="cl"><span class="c1">// maximum number of open file descriptors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sysctlFSFileMax</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fileMax</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sysctl</span><span class="p">.</span><span class="nf">New</span><span class="p">().</span><span class="nf">GetSysctl</span><span class="p">(</span><span class="s">&#34;fs/file-max&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected error reading system maximum number of open file descriptors (fs.file-max): %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// returning 0 means don&#39;t render the value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;system fs.file-max=%v&#34;</span><span class="p">,</span> <span class="nx">fileMax</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fileMax</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Even though the ingress is in a container, since we have a whole physical machine that is used as the ingress, we don&rsquo;t need the init Container either, and it works just fine as calculated above.</p>
<p>The way is clear!</p>
<h3 id="modify-the-fallback">Modify the fallback</h3>
<p>However, this PR predates the version of ingress nginx I use, and in my version, ulimit is still used (of course the comments are still wrong).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sysctlFSFileMax returns the value of fs.file-max, i.e.
</span></span></span><span class="line"><span class="cl"><span class="c1">// maximum number of open file descriptors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sysctlFSFileMax</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">rLimit</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">Rlimit</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Getrlimit</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">RLIMIT_NOFILE</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rLimit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected error reading system maximum number of open file descriptors (RLIMIT_NOFILE): %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// returning 0 means don&#39;t render the value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;rlimit.max=%v&#34;</span><span class="p">,</span> <span class="nx">rLimit</span><span class="p">.</span><span class="nx">Max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">rLimit</span><span class="p">.</span><span class="nx">Max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>What happened?</em></p>
<p>It turns out that three months later, a user submitted a new <a href="https://github.com/kubernetes/ingress-nginx/issues/2157">issue</a> complaining that <a href="https://github.com/kubernetes/ingress-nginx/pull/2050">PR 2050</a> is a special case where one cannot assume that ingress nginx is able to use all the resources of the container host, and submitted a new <a href="https://github.com/kubernetes/ingress-nginx/pull/2241">PR</a> that backed out of the code.</p>
<p>It should be said that it is reasonable to use ulimit, because indeed nginx is in a container and it is not reasonable to allocate all host resources to the container.</p>
<p>However, docker&rsquo;s isolation is not good, the default nginx ingress controller calculates nginx workers by taking the <code>runtime.NumCPU()</code>, so that even if the nginx container is assigned a 4-core CPU, the number of workers obtained is still the host!</p>
<p>But you can&rsquo;t say that the current calculation is wrong and shouldn&rsquo;t be divided by the number of CPUs, because ulimit is indeed &ldquo;process&rdquo; level, and nginx workers are indeed threads.</p>
<p>OK, according to the above understanding, as long as you can set the ulimit of nginx container, everything will be fine, however, kubernetes does not support it.</p>
<h3 id="not-playing-with-you-configuration-items">Not playing with you: configuration items</h3>
<p>As you can see from the previous analysis, ingress nginx&rsquo;s calculation of the maximum number of open files for nginx workers is a bit messy, so a user later submitted a new <a href="https://github.com/kubernetes/ingress-nginx/pull/3604">PR</a> that skips the <em>guess</em> process and use it directly as a configuration item.</p>
<p>It finally cleared up.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/nginx/">nginx</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-arr-nil/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Is Golang&#39;s empty array nil?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/prometheus-disappearing/">
            <span class="next-text nav-default">The disappearing Prometheus indicator</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
