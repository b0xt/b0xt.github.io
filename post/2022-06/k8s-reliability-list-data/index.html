<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments" /><meta name="keywords" content="Kubernetes, LIST Requests" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/k8s-reliability-list-data/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments" />
<meta property="og:description" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/k8s-reliability-list-data/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-19T20:36:54+08:00" />
<meta property="article:modified_time" content="2022-06-19T20:36:54+08:00" />

<meta itemprop="name" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments">
<meta itemprop="description" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments"><meta itemprop="datePublished" content="2022-06-19T20:36:54+08:00" />
<meta itemprop="dateModified" content="2022-06-19T20:36:54+08:00" />
<meta itemprop="wordCount" content="6324">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments"/>
<meta name="twitter:description" content="K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-19 20:36:54 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 6324 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-introduction">1 Introduction</a>
          <ul>
            <li><a href="#11-k8s-architecture-a-hierarchical-view-of-the-ring">1.1 K8s Architecture: A Hierarchical View of the Ring</a></li>
            <li><a href="#12-the-apiserveretcd-role">1.2 The <code>apiserver/etcd</code> role</a></li>
            <li><a href="#13-apiserveretcd-list-overhead">1.3 <code>apiserver/etcd</code> List overhead</a></li>
            <li><a href="#14-potential-problems-with-large-scale-deployments">1.4 Potential problems with large scale deployments</a></li>
            <li><a href="#15-purpose-of-this-paper">1.5 Purpose of this paper</a></li>
          </ul>
        </li>
        <li><a href="#2-apiserver-list-operation-source-code-analysis">2 apiserver <code>List()</code> operation source code analysis</a>
          <ul>
            <li><a href="#21-call-stack-and-flowchart">2.1 Call stack and flowchart</a></li>
            <li><a href="#22-request-processing-entry-list">2.2 Request processing entry: <code>List()</code></a></li>
            <li><a href="#23-listpredicate">2.3 <code>ListPredicate()</code></a></li>
            <li><a href="#24-the-request-specifies-a-resource-name-get-a-single-object">2.4 The request specifies a resource name: Get a single object</a></li>
            <li><a href="#25-request-unspecified-resource-name-get-full-amount-of-data-to-do-filtering">2.5 Request unspecified resource name, get full amount of data to do filtering</a></li>
          </ul>
        </li>
        <li><a href="#3-list-test">3 LIST test</a>
          <ul>
            <li><a href="#31-specify-limit2-the-response-will-return-paging-information-continue">3.1 Specify <code>limit=2</code>: the response will return paging information (<code>continue</code>)</a></li>
            <li><a href="#311-curl-test">3.1.1 <code>curl</code> test</a></li>
            <li><a href="#32-specify-limit2resourceversion0-limit2-will-be-ignored-and-the-full-amount-of-data-will-be-returned">3.2 Specify <code>limit=2&amp;resourceVersion=0</code>: <code>limit=2</code> will be ignored and the full amount of data will be returned</a></li>
            <li><a href="#33-specify-specnodenamenode1resourceversion0-vs-specnodenamenode1">3.3 Specify <code>spec.nodeName=node1&amp;resourceVersion=0</code> vs. <code>specnode.Name=node1&quot;</code></a></li>
          </ul>
        </li>
        <li><a href="#4-list-request-to-control-plane-pressure-quantitative-analysis">4 LIST Request to Control Plane Pressure: Quantitative Analysis</a>
          <ul>
            <li><a href="#41-collecting-list-requests">4.1 Collecting LIST requests</a></li>
            <li><a href="#22-testing-the-amount-of-data-and-time-consumed-by-list-requests">2.2 Testing the amount of data and time consumed by LIST requests</a></li>
            <li><a href="#43-analysis-of-test-results">4.3 Analysis of test results</a></li>
          </ul>
        </li>
        <li><a href="#5-large-scale-foundation-services-deployment-and-tuning-recommendations">5 Large Scale Foundation Services: Deployment and Tuning Recommendations</a>
          <ul>
            <li><a href="#51-list-request-default-setting-resourceversion0">5.1 List request default setting <code>ResourceVersion=0</code></a></li>
            <li><a href="#52-preferring-the-namespaced-api">5.2 Preferring the namespaced API</a></li>
            <li><a href="#53-restart-backoff">5.3 Restart backoff</a></li>
            <li><a href="#54-prioritize-filtering-on-the-server-side-via-labelfield-selector">5.4 Prioritize filtering on the server side via label/field selector</a></li>
            <li><a href="#55-supporting-infrastructure-monitoring-alerting-etc">5.5 Supporting infrastructure (monitoring, alerting, etc.)</a></li>
          </ul>
        </li>
        <li><a href="#6-other">6 Other</a>
          <ul>
            <li><a href="#61-get-requests-getoptions">6.1 Get requests: <code>GetOptions{}</code></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>For unstructured data storage systems, LIST operations are usually very heavyweight, not only consuming a lot of disk IO, network bandwidth and CPU, but also affecting other requests in the same time period (especially the response latency demanding master selection requests), which is a major cluster stability killer.</p>
<p>For example, for Ceph object storage, each LIST bucket request needs to go to multiple disks to retrieve all the data of the bucket; it is not only slow, but also affects other common read and write requests in the same time period, because IO is shared, resulting in increased response latency and even timeout. If there are many objects in the bucket (e.g. as a storage backend for harbor/docker-registry), LIST operations cannot even be completed in regular time (and thus registry GC, which relies on LIST bucket operations, cannot run).</p>
<p>Compared to Ceph, an actual etcd cluster may store a small amount of data (a few ~ tens of gigabytes), even enough to be cached in memory. Unlike Ceph, however, the number of concurrent requests can be several orders of magnitude higher, e.g., it is an etcd for a ~4000 nodes k8s cluster. a single LIST request may only need to return a few tens of MB to a few GB of traffic, but the number of concurrent requests is obviously too much for etcd to handle, so it is better to have a cache layer in front of it, which is what apiserver does (for one). （Most of K8s&rsquo; LIST requests should be blocked by the apiserver and served from its local cache, but if not used properly, they can skip the cache and reach etcd directly, with significant stability risks.</p>
<p>This paper delves into the processing logic and performance bottlenecks of LIST operations on k8s apiserver/etcd, and provides some recommendations for LIST stress testing, deployment and tuning of basic services to improve the stability of large-scale K8s clusters.</p>
<p>The <code>kube-apiserver</code> <code>LIST</code> request processing logic is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/1e476048bf1f4a2789f7c151edaed0da.png" alt="kube-apiserver LIST request processing logic"></p>
<p>The code is based on v1.24.0. However, the basic logic and code path of 1.19~1.24 are the same, so you can cross-reference if you need.</p>
<h2 id="1-introduction">1 Introduction</h2>
<h3 id="11-k8s-architecture-a-hierarchical-view-of-the-ring">1.1 K8s Architecture: A Hierarchical View of the Ring</h3>
<p>From an architectural hierarchy and component dependency perspective, the analogy between a K8s cluster and a Linux host can be made as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/ce0dc493efb243e0ac3f0202beb16d2d.png" alt="Fig 1. Anology: a Linux host and a Kubernetes cluster"></p>
<p>For K8s clusters, several components and functions from the inside out.</p>
<ol>
<li><strong>etcd</strong>: persistent KV storage, the sole authoritative data (state) source for cluster resources (pods/services/networkpolicies/&hellip;).</li>
<li><strong>apiserver</strong>: reads (<strong><code>ListWatch</code></strong>) the full amount of data from etcd and caches it in memory; <strong>stateless service</strong>, horizontally scalable.</li>
<li>various <strong>basic services</strong> (e.g. <code>kubelet</code>, <code>*-agent</code>, <code>*-operator</code>): connect to apiserver and get (<strong><code>List/ListWatch</code></strong>) the data they each need.</li>
<li><strong>workloads</strong> within the cluster: created, managed and reconcile by 3 in case 1 and 2 are normal, e.g. kubelet creates pods, cilium configures network and security policies.</li>
</ol>
<h3 id="12-the-apiserveretcd-role">1.2 The <code>apiserver/etcd</code> role</h3>
<p>As you can see above, there are <strong>two levels of List/ListWatch</strong> in the system path (but the data is the same copy).</p>
<ol>
<li>apiserver List/ListWatch etcd</li>
<li>base service List/ListWatch apiserver</li>
</ol>
<p>So, in its simplest form, the <strong>apiserver is a proxy</strong> (proxy) in front of etcd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">           +--------+              +---------------+                 +------------+
</span></span><span class="line"><span class="cl">           | Client | -----------&gt; | Proxy (cache) | --------------&gt; | Data store |
</span></span><span class="line"><span class="cl">           +--------+              +---------------+                 +------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         infra services               apiserver                         etcd
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>in the vast majority of cases, the apiserver serves directly from the local cache (since it caches the full amount of data for the cluster).</li>
<li>some special cases, such as
<ol>
<li><strong>the client explicitly requests to read data from etcd</strong> (seeking the highest data accuracy), and</li>
<li><strong>apiserver local cache is not yet built</strong>apiserver will have to forward the request to etcd &ndash; <strong>Here you have to pay special attention</strong> - - Improperly set LIST parameters on the client side can also lead to this logic.</li>
</ol>
</li>
</ol>
<h3 id="13-apiserveretcd-list-overhead">1.3 <code>apiserver/etcd</code> List overhead</h3>
<h4 id="131-example-of-a-request">1.3.1 Example of a request</h4>
<p>Consider the following LIST operations.</p>
<ol>
<li>
<p><strong><code>LIST apis/cilium.io/v2/ciliumendpoints?limit=500&amp;resourceVersion=0</code></strong> Here both parameters are passed, but <code>resourceVersion=0</code> will cause apiserver ignore <code>limit=500</code>, so the client gets the full amount of ciliumendpoints data. The full amount of data for a resource can be quite large, and <strong>need to think through whether you really need the full amount of data</strong>. The <strong>quantitative measurement and analysis</strong> method will be described later.</p>
</li>
<li>
<p><strong><code>LIST api/v1/pods?filedSelector=spec.nodeName%3Dnode1</code></strong> This request is to fetch all pods on <code>node1</code> (<code>%3D</code> is an escape of <code>=</code>). Doing the filtering based on nodename may give the impression that the amount of data is not too large, but it&rsquo;s actually more complicated behind the scenes than it looks.</p>
<ul>
<li>First, resourceVersion=0 is not specified here, causing <strong>apiserver to skip the cache and go directly to etcd to read the data</strong>.</li>
<li>Secondly, <strong>etcd is just KV storage, with no filtering by label/field</strong> (only <code>limit/continue</code> is handled).</li>
<li>So, apiserver is pulling the full amount of data from etcd and then doing filtering in <strong>memory</strong>, which is also a lot of overhead, as analyzed in code later. This behavior is to be avoided unless there is an extremely high demand for data accuracy and you purposely want to bypass the apiserver cache.</li>
</ul>
</li>
<li>
<p>**<code>LIST api/v1/pods?filedSelector=spec.nodeName%3Dnode1&amp;resourceVersion=0</code>**The difference with 2 is that <code>resourceVersion=0</code> is added, so apiserver will read data from the cache, and <strong>there is an order of magnitude performance improvement</strong>. But note that while what is actually returned to the client may only be <strong>a few hundred KB to a few hundred MB</strong> (depending on the number of pods on the node, the number of labels on the pods, etc.), the amount of data that apiserver needs to process can be <strong>several GB</strong>. A quantitative analysis will follow later.</p>
</li>
</ol>
<p>As you can see above, the impact of different LIST operations is different, and the client may see only a small fraction of the data processed by apiserver/etcd. If the base service is started or restarted massively, it is very likely to blow up the control plane.</p>
<h4 id="132-processing-overhead">1.3.2 Processing overhead</h4>
<p>List requests can be divided into two types.</p>
<ol>
<li>list full amount of data: the overhead is spent mainly on data transfer.</li>
<li>specify filtering by label or field (field), only the data that needs to be matched.</li>
</ol>
<p>The special note here is the second case, where the list request comes with a filter.</p>
<ul>
<li>In most cases, apiserver will use its own cache to do the filtering, which is fast, so ** time spent is mostly on data transfer**.</li>
<li>The case where the request needs to be forwarded to etcd, as mentioned earlier, etcd is just KV storage and does not understand label/field information, so it cannot handle filtering requests. The actual process is: <strong>apiserver pulls the full amount of data from etcd, then does the filtering in memory</strong>, and returns it to the client. So in addition to the data transfer overhead (network bandwidth), this case also takes up a lot of apiserver <strong>CPU and memory</strong>.</li>
</ul>
<h3 id="14-potential-problems-with-large-scale-deployments">1.4 Potential problems with large scale deployments</h3>
<p>For another example, the following line of code uses k8s client-go to filter pods based on nodename</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"> podList, err :<span class="o">=</span> Client<span class="o">()</span>.CoreV1<span class="o">()</span>.Pods<span class="o">(</span><span class="s2">&#34;&#34;</span><span class="o">)</span>.List<span class="o">(</span>ctx<span class="o">()</span>, ListOptions<span class="o">{</span>FieldSelector: <span class="s2">&#34;spec.nodeName=node1&#34;</span><span class="o">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It looks like a very simple operation, let&rsquo;s actually look at the amount of data behind it. Using a 4000 node, 10w pod cluster as an example, <strong>full volume of pod data</strong>.</p>
<ol>
<li><strong>in etcd</strong>: compact unstructured KV storage in the <strong>1GB magnitude</strong>.</li>
<li><strong>in apiserver cache</strong>: already structured golang objects, in the <strong>2GB magnitude</strong> (TODO: further confirmation required).</li>
<li><strong>apiserver returns</strong>: the client generally chooses the default json format to receive, which is also already structured data. The json for the full pod is also in the <strong>2GB range</strong>.</li>
</ol>
<p>As you can see, some requests may look simple, a matter of a single line of code from the client, but the amount of data behind them is staggering. Specifying a pod filter by nodeName may return only 500KB of data, but apiserver needs to filter 2GB of data &ndash; <strong>worst case, etcd has to process 1GB of data along with it</strong> (the above parameter configuration does hit the worst case (see code analysis below).</p>
<p>When the cluster is small, this problem may not be visible (etcd only starts printing warning logs after the LIST response latency exceeds a certain threshold); when it is large, apiserver/etcd will not be able to handle such requests if there are more of them.</p>
<h3 id="15-purpose-of-this-paper">1.5 Purpose of this paper</h3>
<p>To deepen the understanding of performance issues by looking at the List/ListWatch implementation of k8s in deeper code, and to provide some reference for optimizing the stability of large-scale K8s clusters.</p>
<h2 id="2-apiserver-list-operation-source-code-analysis">2 apiserver <code>List()</code> operation source code analysis</h2>
<p>With the above theoretical warm-up, you can next look at the code implementation.</p>
<h3 id="21-call-stack-and-flowchart">2.1 Call stack and flowchart</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">store.List
</span></span><span class="line"><span class="cl">|-store.ListPredicate
</span></span><span class="line"><span class="cl">   |-if opt == nil
</span></span><span class="line"><span class="cl">   |   opt = ListOptions{ResourceVersion: &#34;&#34;}
</span></span><span class="line"><span class="cl">   |-Init SelectionPredicate.Limit/Continue fileld
</span></span><span class="line"><span class="cl">   |-list := e.NewListFunc()                               // objects will be stored in this list
</span></span><span class="line"><span class="cl">   |-storageOpts := storage.ListOptions{opt.ResourceVersion, opt.ResourceVersionMatch, Predicate: p}
</span></span><span class="line"><span class="cl">   |
</span></span><span class="line"><span class="cl">   |-if MatchesSingle ok                                   // 1. when &#34;metadata.name&#34; is specified,  get single obj
</span></span><span class="line"><span class="cl">   |   // Get single obj from cache or etcd
</span></span><span class="line"><span class="cl">   |
</span></span><span class="line"><span class="cl">   |-return e.Storage.List(KeyRootFunc(ctx), storageOpts)  // 2. get all objs and perform filtering
</span></span><span class="line"><span class="cl">      |-cacher.List()
</span></span><span class="line"><span class="cl">         | // case 1: list all from etcd and filter in apiserver
</span></span><span class="line"><span class="cl">         |-if shouldDelegateList(opts)                     // true if resourceVersion == &#34;&#34;
</span></span><span class="line"><span class="cl">         |    return c.storage.List                        // list from etcd
</span></span><span class="line"><span class="cl">         |             |- fromRV *int64 = nil
</span></span><span class="line"><span class="cl">         |             |- if len(storageOpts.ResourceVersion) &gt; 0
</span></span><span class="line"><span class="cl">         |             |     rv = ParseResourceVersion
</span></span><span class="line"><span class="cl">         |             |     fromRV = &amp;rv
</span></span><span class="line"><span class="cl">         |             |
</span></span><span class="line"><span class="cl">         |             |- for hasMore {
</span></span><span class="line"><span class="cl">         |             |    objs := etcdclient.KV.Get()
</span></span><span class="line"><span class="cl">         |             |    filter(objs)                   // filter by labels or filelds
</span></span><span class="line"><span class="cl">         |             | }
</span></span><span class="line"><span class="cl">         |
</span></span><span class="line"><span class="cl">         | // case 2: list &amp; filter from apiserver local cache (memory)
</span></span><span class="line"><span class="cl">         |-if cache.notready()
</span></span><span class="line"><span class="cl">         |   return c.storage.List                         // get from etcd
</span></span><span class="line"><span class="cl">         |
</span></span><span class="line"><span class="cl">         | // case 3: list &amp; filter from apiserver local cache (memory)
</span></span><span class="line"><span class="cl">         |-obj := watchCache.WaitUntilFreshAndGet
</span></span><span class="line"><span class="cl">         |-for elem in obj.(*storeElement)
</span></span><span class="line"><span class="cl">         |   listVal.Set()                                 // append results to listOjb
</span></span><span class="line"><span class="cl">         |-return  // results stored in listObj
</span></span></code></pre></td></tr></table>
</div>
</div><p>Corresponding flow chart.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/f0e9f92da6064ab6a37dddffa918b14b.png" alt="Fig 2-1. List operation processing in apiserver"></p>
<h3 id="22-request-processing-entry-list">2.2 Request processing entry: <code>List()</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L361
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 根据 PredicateFunc 中指定的 LabelSelector 和 FieldSelector 过滤，返回一个对象列表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">List</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">label</span> <span class="o">:=</span> <span class="nx">labels</span><span class="p">.</span><span class="nf">Everything</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">LabelSelector</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">label</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">LabelSelector</span> <span class="c1">// Label 过滤器，例如 app=nginx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">field</span> <span class="o">:=</span> <span class="nx">fields</span><span class="p">.</span><span class="nf">Everything</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">FieldSelector</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">field</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">FieldSelector</span> <span class="c1">// 字段过滤器，例如 spec.nodeName=node1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">out</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">ListPredicate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nf">PredicateFunc</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">field</span><span class="p">),</span> <span class="nx">options</span><span class="p">)</span> <span class="c1">// 拉取（List）数据并过滤（Predicate）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Decorator</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nf">Decorator</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-listpredicate">2.3 <code>ListPredicate()</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L411
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">ListPredicate</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">p</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">SelectionPredicate</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 1: 初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">options</span> <span class="o">==</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">options</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">metainternalversion</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span><span class="nx">ResourceVersion</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">p</span><span class="p">.</span><span class="nx">Limit</span>    <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Limit</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span><span class="p">.</span><span class="nx">Continue</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Continue</span>
</span></span><span class="line"><span class="cl">    <span class="nx">list</span>      <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">NewListFunc</span><span class="p">()</span>        <span class="c1">// 返回结果将存储在这里面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">storageOpts</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{</span> <span class="c1">// 将 API 侧的 ListOption 转成底层存储侧的 ListOption，字段区别见下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ResourceVersion</span><span class="p">:</span>      <span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ResourceVersionMatch</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Predicate</span><span class="p">:</span>            <span class="nx">p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Recursive</span><span class="p">:</span>            <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 2：如果请求指定了 metadata.name，则应获取单个 object，无需对全量数据做过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">MatchesSingle</span><span class="p">();</span> <span class="nx">ok</span> <span class="p">{</span> <span class="c1">// 检查是否设置了 metadata.name 字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">key</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">KeyFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// 获取这个 object 在 etcd 中的 key（唯一或不存在）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">storageOpts</span><span class="p">.</span><span class="nx">Recursive</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">storageOpts</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">list</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// else 逻辑：如果执行到这里，说明没有从 context 中拿到过滤用的 key，则 fallback 到下面拿全量数据再过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Step 3: 对全量数据做过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nf">KeyRootFunc</span><span class="p">(),</span> <span class="nx">storageOpts</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="c1">// KeyRootFunc() 用来获取这种资源在 etcd 里面的 root key（即 prefix，不带最后的 /）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">list</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>GetList()` in cases 1 &amp; 2 in 1.24.0, previous versions are a bit different: * e.Storage.</p>
<ul>
<li>GetToList in Case 1</li>
<li>List in Case 1</li>
</ul>
<p>But the basic process is the same.</p>
</blockquote>
<ol>
<li>If the client does not pass <strong><code>ListOption</code></strong>, a default value is initialized where <code>ResourceVersion</code> is set to the empty string, which will cause the apiserver *<em>to pull data from etcd to return to the client without using the local cache</em> (unless the local cache is not yet built) (unless the local cache is not yet built); for example, when the client sets <code>ListOption{Limit: 5000, ResourceVersion: 0}</code> list ciliumendpoints, the request sent will be <strong><code>/apis/cilium.io/v2/ ciliumendpoints?limit=500&amp;resourceVersion=0</code></strong>. <code>ResourceVersion</code> is the behavior of the empty string, which you will see parsed later.</li>
<li>initialize the limit/continue fields of the filter <strong>(SelectionPredicate) with the fields in listoptions</strong> respectively.</li>
<li>initialize the returned result, <code>list := e.NewListFunc()</code>.</li>
<li>convert the API-side ListOptions to the underlying stored ListOptions, see <code>metainternalversion.ListOptions</code> below for field differences. is the <strong>API-side structure</strong> containing the</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"> <span class="c1">// staging/src/k8s.io/apimachinery/pkg/apis/meta/internalversion/types.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl"> <span class="c1">// ListOptions is the query options to a standard REST list call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">type</span> <span class="nx">ListOptions</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">     <span class="nx">LabelSelector</span> <span class="nx">labels</span><span class="p">.</span><span class="nx">Selector</span> <span class="c1">// 标签过滤器，例如 app=nginx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">FieldSelector</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">Selector</span> <span class="c1">// 字段过滤器，例如 spec.nodeName=node1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">     <span class="nx">Watch</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">     <span class="nx">AllowWatchBookmarks</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ResourceVersion</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ResourceVersionMatch</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">     <span class="nx">TimeoutSeconds</span> <span class="o">*</span><span class="kt">int64</span>         <span class="c1">// Timeout for the list/watch call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">Limit</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">     <span class="nx">Continue</span> <span class="kt">string</span>               <span class="c1">// a token returned by the server. return a 410 error if the token has expired.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>storage.ListOptions</code> is the structure passed to the <strong>underlying storage</strong> , with a few differences in the fields.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"> <span class="c1">// staging/src/k8s.io/apiserver/pkg/storage/interfaces.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl"> <span class="c1">// ListOptions provides the options that may be provided for storage list operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kd">type</span> <span class="nx">ListOptions</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ResourceVersion</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">     <span class="nx">ResourceVersionMatch</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span>
</span></span><span class="line"><span class="cl">     <span class="nx">Predicate</span> <span class="nx">SelectionPredicate</span> <span class="c1">// Predicate provides the selection rules for the list operation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">Recursive</span> <span class="kt">bool</span>               <span class="c1">// true: 根据 key 获取单个对象；false：根据 key prefix 获取全量数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">ProgressNotify</span> <span class="kt">bool</span>          <span class="c1">// storage-originated bookmark, ignored for non-watch requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="24-the-request-specifies-a-resource-name-get-a-single-object">2.4 The request specifies a resource name: Get a single object</h3>
<p>Next, depending on whether <code>meta.Name</code> is specified in the request, there are two cases.</p>
<ol>
<li>if specified, it is a query for a single object, since <code>Name</code> is unique, and the next logical step is to query for a single object.</li>
<li>if it is not specified, you need to <strong>get the full amount of data</strong>, and then filter it in apiserver memory according to the filter conditions in SelectionPredicate, and return the final result to the client.</li>
</ol>
<p>The code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// case 1：根据 metadata.name 获取单个 object，无需对全量数据做过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">MatchesSingle</span><span class="p">();</span> <span class="nx">ok</span> <span class="p">{</span> <span class="c1">// 检查是否设置了 metadata.name 字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">key</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">KeyFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">storageOpts</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">list</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// else 逻辑：如果执行到这里，说明没有从 context 中拿到过滤用的 key，则 fallback 到下面拿全量数据再过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>e.Storage is an Interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// staging/src/k8s.io/apiserver/pkg/storage/interfaces.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Interface offers a common interface for object marshaling/unmarshaling operations and
</span></span></span><span class="line"><span class="cl"><span class="c1">// hides all the storage-related operations behind it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">ttl</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">preconditions</span> <span class="o">*</span><span class="nx">Preconditions</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">GetOptions</span><span class="p">,</span> <span class="nx">objPtr</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// unmarshall objects found at key into a *List api object (an object that satisfies runtime.IsList definition).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If &#39;opts.Recursive&#39; is false, &#39;key&#39; is used as an exact match; if is true, &#39;key&#39; is used as a prefix.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The returned contents may be delayed, but it is guaranteed that they will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// match &#39;opts.ResourceVersion&#39; according &#39;opts.ResourceVersionMatch&#39;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">ListOptions</span><span class="p">,</span> <span class="nx">listObj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>e.Storage.GetList() will execute to the cacher code.</p>
<p>Whether fetching a single object or the full amount of data, it goes through a similar process.</p>
<ol>
<li>fetching from the apiserver local cache first (determinants include ResourceVersion, etc.), and</li>
<li>go to etcd as a last resort.</li>
</ol>
<p>The logic of getting individual objects is relatively simple, so we won&rsquo;t look at it here. The next step is to look at the logic of filtering the full amount of data in the list.</p>
<h3 id="25-request-unspecified-resource-name-get-full-amount-of-data-to-do-filtering">2.5 Request unspecified resource name, get full amount of data to do filtering</h3>
<h4 id="251-apiserver-cache-layer-getlist-processing-logic">2.5.1 apiserver cache layer: <code>GetList()</code> processing logic</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L622
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// GetList implements storage.Interface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cacher</span><span class="p">)</span> <span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">,</span> <span class="nx">listObj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">recursive</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Recursive</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resourceVersion</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ResourceVersion</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pred</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Predicate</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 情况一：ListOption 要求必须从 etcd 读
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">shouldDelegateList</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">listObj</span><span class="p">)</span> <span class="c1">// c.storage 指向 etcd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If resourceVersion is specified, serve it from cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">listRV</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">versioner</span><span class="p">.</span><span class="nf">ParseResourceVersion</span><span class="p">(</span><span class="nx">resourceVersion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 情况二：apiserver 缓存未建好，只能从 etcd 读
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">listRV</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">ready</span><span class="p">.</span><span class="nf">check</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">listObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 情况三：apiserver 缓存正常，从缓存读：保证返回的 objects 版本不低于 `listRV`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">listPtr</span> <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">GetItemsPtr</span><span class="p">(</span><span class="nx">listObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">listVal</span> <span class="o">:=</span> <span class="nx">conversion</span><span class="p">.</span><span class="nf">EnforcePtr</span><span class="p">(</span><span class="nx">listPtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">filter</span>  <span class="o">:=</span> <span class="nf">filterWithAttrsFunction</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">pred</span><span class="p">)</span> <span class="c1">// 最终的过滤器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">objs</span><span class="p">,</span> <span class="nx">readResourceVersion</span><span class="p">,</span> <span class="nx">indexUsed</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">listItems</span><span class="p">(</span><span class="nx">listRV</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">pred</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// 根据 index 预筛，性能优化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">objs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">elem</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">storeElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nf">filter</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Labels</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Fields</span><span class="p">)</span>                           <span class="c1">// 真正的过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">listVal</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">listVal</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">elem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新最后一次读到的 ResourceVersion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">versioner</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">versioner</span><span class="p">.</span><span class="nf">UpdateList</span><span class="p">(</span><span class="nx">listObj</span><span class="p">,</span> <span class="nx">readResourceVersion</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="252-determining-whether-data-must-be-read-from-etcd-shoulddelegatelist">2.5.2 Determining whether data must be read from etcd: <code>shouldDelegateList()</code></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L591
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">shouldDelegateList</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resourceVersion</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ResourceVersion</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pred</span>            <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Predicate</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pagingEnabled</span>   <span class="o">:=</span> <span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">APIListChunking</span><span class="p">)</span>      <span class="c1">// 默认是启用的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hasContinuation</span> <span class="o">:=</span> <span class="nx">pagingEnabled</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pred</span><span class="p">.</span><span class="nx">Continue</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span>                   <span class="c1">// Continue 是个 token
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hasLimit</span>        <span class="o">:=</span> <span class="nx">pagingEnabled</span> <span class="o">&amp;&amp;</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">Limit</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">resourceVersion</span> <span class="o">!=</span> <span class="s">&#34;0&#34;</span> <span class="c1">// 只有在 resourceVersion != &#34;0&#34; 的情况下，hasLimit 才有可能为 true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. 如果未指定 resourceVersion，从底层存储（etcd）拉去数据；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. 如果有 continuation，也从底层存储拉数据；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3. 只有 resourceVersion != &#34;0&#34; 时，才会将 limit 传给底层存储（etcd），因为 watch cache 不支持 continuation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">resourceVersion</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">||</span> <span class="nx">hasContinuation</span> <span class="o">||</span> <span class="nx">hasLimit</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ResourceVersionMatch</span> <span class="o">==</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ResourceVersionMatchExact</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Very important here.</p>
<ol>
<li>
<p>Q: Does the fact that the <code>ResourceVersion</code> field in ListOption{} is not set by the client correspond to <code>resourceVersion == &quot;&quot;</code> here?</p>
<p>A: Yes, so <strong>Section 1</strong> of <a href="https://arthurchiao.art/blog/k8s-reliability-list-data-zh/#client_code_empty_rv">example</a> will result in pulling the full amount of data from etcd.</p>
</li>
<li>
<p>Q: Will the client set <code>limit=500&amp;resourceVersion=0</code> cause <code>hasContinuation==true</code> next time?</p>
<p>A: No, <strong>resourceVersion=0 will cause the limit to be ignored</strong> (the <code>hasLimit</code> line of code), meaning that <strong>the request will return the full amount of data</strong>, even though limit=500 is specified.</p>
</li>
<li>
<p>Q: What is the purpose of ResourceVersionMatch?</p>
<p>A: It&rsquo;s used to tell apiserver how to interpret ResourceVersion, and there&rsquo;s a complicated official <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#the-resourceversion-parameter">table</a> that you can look at if you&rsquo;re interested.</p>
</li>
</ol>
<p>Next, we return to cacher&rsquo;s <code>GetList()</code> logic and look at the specific cases of processing.</p>
<h4 id="253-case-1-listoption-asks-to-read-data-from-etcd">2.5.3 Case 1: ListOption asks to read data from etcd</h4>
<p>In this case, apiserver will read all objects directly from etcd and filter them, and then return them to the client, for scenarios where data consistency is extremely important. Of course, it is also easy to <strong>mistake into this scenario and overstress etcd</strong>, for example <strong>Section 1</strong> of <a href="https://arthurchiao.art/blog/k8s-reliability-list-data-zh/#client_code_empty_rv">example</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go#L563
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// GetList implements storage.Interface.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">store</span><span class="p">)</span> <span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">,</span> <span class="nx">listObj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">listPtr</span>   <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">GetItemsPtr</span><span class="p">(</span><span class="nx">listObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span>         <span class="o">:=</span> <span class="nx">conversion</span><span class="p">.</span><span class="nf">EnforcePtr</span><span class="p">(</span><span class="nx">listPtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">key</span>        <span class="p">=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pathPrefix</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">keyPrefix</span> <span class="o">:=</span> <span class="nx">key</span> <span class="c1">// append &#39;/&#39; if needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">newItemFunc</span> <span class="o">:=</span> <span class="nf">getNewItemFunc</span><span class="p">(</span><span class="nx">listObj</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">fromRV</span> <span class="o">*</span><span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">resourceVersion</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// 如果 RV 非空（客户端不传时，默认是空字符串）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">parsedRV</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">versioner</span><span class="p">.</span><span class="nf">ParseResourceVersion</span><span class="p">(</span><span class="nx">resourceVersion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fromRV</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">parsedRV</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ResourceVersion, ResourceVersionMatch 等处理逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">recursive</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">pagingEnabled</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pred</span><span class="p">.</span><span class="nx">Continue</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">recursive</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">pagingEnabled</span> <span class="o">&amp;&amp;</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">Limit</span> <span class="p">&gt;</span> <span class="mi">0</span>        <span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span>                                                    <span class="p">:</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// loop until we have filled the requested limit from etcd or there are no more results
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">getResp</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">KV</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">options</span><span class="o">...</span><span class="p">)</span> <span class="c1">// 从 etcd 拉数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">numFetched</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">getResp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">hasMore</span> <span class="p">=</span> <span class="nx">getResp</span><span class="p">.</span><span class="nx">More</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">kv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">getResp</span><span class="p">.</span><span class="nx">Kvs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">limitOption</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nf">Len</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">Limit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">hasMore</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">lastKey</span> <span class="p">=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">Key</span>
</span></span><span class="line"><span class="cl">            <span class="nx">data</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">transformer</span><span class="p">.</span><span class="nf">TransformFromStorage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">Key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">appendListItem</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">ModRevision</span><span class="p">,</span> <span class="nx">pred</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">versioner</span><span class="p">,</span> <span class="nx">newItemFunc</span><span class="p">)</span> <span class="c1">// 这里面会做过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">numEvald</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">key</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">lastKey</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;\x00&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// instruct the client to begin querying from immediately after the last key we returned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">hasMore</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// we want to start immediately after the last key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">next</span> <span class="o">:=</span> <span class="nf">encodeContinue</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">lastKey</span><span class="p">)</span><span class="o">+</span><span class="s">&#34;\x00&#34;</span><span class="p">,</span> <span class="nx">keyPrefix</span><span class="p">,</span> <span class="nx">returnedRV</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">versioner</span><span class="p">.</span><span class="nf">UpdateList</span><span class="p">(</span><span class="nx">listObj</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">returnedRV</span><span class="p">),</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">remainingItemCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// no continuation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">versioner</span><span class="p">.</span><span class="nf">UpdateList</span><span class="p">(</span><span class="nx">listObj</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">returnedRV</span><span class="p">),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>client.KV.Get()</code></strong> It goes into the etcd client library, so keep digging down if you&rsquo;re interested.</li>
<li><strong><code>appendListItem()</code></strong> will * <strong>filter the data it gets</strong>, which is the apiserver memory filtering operation we mentioned in section 1.</li>
</ul>
<h4 id="254-case-2-the-local-cache-is-not-yet-built-so-you-can-only-read-data-from-etcd">2.5.4 Case 2: The local cache is not yet built, so you can only read data from etcd</h4>
<p>The procedure is the same as in case 1.</p>
<h4 id="255-case-3-using-local-cache">2.5.5 Case 3: Using local cache</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L622
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// GetList implements storage.Interface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cacher</span><span class="p">)</span> <span class="nf">GetList</span><span class="p">(</span><span class="nx">ctx</span> <span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">,</span> <span class="nx">listObj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 情况一：ListOption 要求必须从 etcd 读
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 情况二：apiserver 缓存未建好，只能从 etcd 读
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 情况三：apiserver 缓存正常，从缓存读：保证返回的 objects 版本不低于 `listRV`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">listPtr</span> <span class="o">:=</span> <span class="nx">meta</span><span class="p">.</span><span class="nf">GetItemsPtr</span><span class="p">(</span><span class="nx">listObj</span><span class="p">)</span> <span class="c1">// List elements with at least &#39;listRV&#39; from cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">listVal</span> <span class="o">:=</span> <span class="nx">conversion</span><span class="p">.</span><span class="nf">EnforcePtr</span><span class="p">(</span><span class="nx">listPtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">filter</span>  <span class="o">:=</span> <span class="nf">filterWithAttrsFunction</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">pred</span><span class="p">)</span> <span class="c1">// 最终的过滤器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">objs</span><span class="p">,</span> <span class="nx">readResourceVersion</span><span class="p">,</span> <span class="nx">indexUsed</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">listItems</span><span class="p">(</span><span class="nx">listRV</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">pred</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="c1">// 根据 index 预筛，性能优化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">objs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">elem</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">storeElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nf">filter</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Labels</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Fields</span><span class="p">)</span>                           <span class="c1">// 真正的过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">listVal</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">Append</span><span class="p">(</span><span class="nx">listVal</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">elem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">versioner</span> <span class="o">!=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">versioner</span><span class="p">.</span><span class="nf">UpdateList</span><span class="p">(</span><span class="nx">listObj</span><span class="p">,</span> <span class="nx">readResourceVersion</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-list-test">3 LIST test</h2>
<p>To avoid client-side libraries (such as client-go) automatically setting some parameters for us, we test directly with <code>curl</code>, specifying the credentials.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat curl-k8s-apiserver.sh
</span></span><span class="line"><span class="cl">curl -s --cert /etc/kubernetes/pki/admin.crt --key /etc/kubernetes/pki/admin.key --cacert /etc/kubernetes/pki/ca.crt <span class="nv">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Usage.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./curl-k8s-apiserver.sh <span class="s2">&#34;https://localhost:6443/api/v1/pods?limit=2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;PodList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;resourceVersion&#34;</span>: <span class="s2">&#34;2127852936&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;continue&#34;</span>: <span class="s2">&#34;eyJ2IjoibWV0YS5rOHMuaW8vdjEiLCJ...&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;items&#34;</span>: <span class="o">[</span> <span class="o">{</span>pod1 data <span class="o">}</span>, <span class="o">{</span>pod2 data<span class="o">}]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="31-specify-limit2-the-response-will-return-paging-information-continue">3.1 Specify <code>limit=2</code>: the response will return paging information (<code>continue</code>)</h3>
<h3 id="311-curl-test">3.1.1 <code>curl</code> test</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./curl-k8s-apiserver.sh <span class="s2">&#34;https://localhost:6443/api/v1/pods?limit=2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;PodList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;resourceVersion&#34;</span>: <span class="s2">&#34;2127852936&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;continue&#34;</span>: <span class="s2">&#34;eyJ2IjoibWV0YS5rOHMuaW8vdjEiLCJ...&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;items&#34;</span>: <span class="o">[</span> <span class="o">{</span>pod1 data <span class="o">}</span>, <span class="o">{</span>pod2 data<span class="o">}]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the</p>
<ul>
<li>does return two pod messages, in the <code>items[]</code> field.</li>
<li>Also returns a <code>continue</code> field in <code>metadata</code>. The next time the client takes this parameter, apiserver will continue to return the rest until apiserver no longer returns <code>continue</code>.</li>
</ul>
<h4 id="312-kubectl-testing">3.1.2 <code>kubectl</code> testing</h4>
<p>Cranking up the logging level of kubectl also shows that it uses continue behind the scenes to get the full amount of pods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods --all-namespaces --v<span class="o">=</span><span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 以下都是 log 输出，做了适当调整</span>
</span></span><span class="line"><span class="cl"><span class="c1"># curl -k -v -XGET  -H &#34;User-Agent: kubectl/v1.xx&#34; -H &#34;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#39;http://localhost:8080/api/v1/pods?limit=500&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># GET http://localhost:8080/api/v1/pods?limit=500 200 OK in 202 milliseconds</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Response Body: {&#34;kind&#34;:&#34;Table&#34;,&#34;metadata&#34;:{&#34;continue&#34;:&#34;eyJ2Ijoib...&#34;,&#34;remainingItemCount&#34;:54},&#34;columnDefinitions&#34;:[...],&#34;rows&#34;:[...]}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="c1"># curl -k -v -XGET  -H &#34;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json&#34; -H &#34;User-Agent: kubectl/v1.xx&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   &#39;http://localhost:8080/api/v1/pods?continue=eyJ2Ijoib&amp;limit=500&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># GET http://localhost:8080/api/v1/pods?continue=eyJ2Ijoib&amp;limit=500 200 OK in 44 milliseconds</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Response Body: {&#34;kind&#34;:&#34;Table&#34;,&#34;metadata&#34;:{&#34;resourceVersion&#34;:&#34;2122644698&#34;},&#34;columnDefinitions&#34;:[],&#34;rows&#34;:[...]}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first request got 500 pods, and the second request took the continue return with it: <strong><code>GET http://localhost:8080/api/v1/pods?continue=eyJ2Ijoib&amp;limit=500</code></strong> , which is a token. The continue is a token and is a bit long, so it is truncated here for better presentation.</p>
<h3 id="32-specify-limit2resourceversion0-limit2-will-be-ignored-and-the-full-amount-of-data-will-be-returned">3.2 Specify <code>limit=2&amp;resourceVersion=0</code>: <code>limit=2</code> will be ignored and the full amount of data will be returned</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./curl-k8s-apiserver.sh <span class="s2">&#34;https://localhost:6443/api/v1/pods?limit=2&amp;resourceVersion=0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;PodList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;resourceVersion&#34;</span>: <span class="s2">&#34;2127852936&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;continue&#34;</span>: <span class="s2">&#34;eyJ2IjoibWV0YS5rOHMuaW8vdjEiLCJ...&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;items&#34;</span>: <span class="o">[</span> <span class="o">{</span>pod1 data <span class="o">}</span>, <span class="o">{</span>pod2 data<span class="o">}</span>, ...<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>items[]</code> contains the full amount of pod information.</p>
<h3 id="33-specify-specnodenamenode1resourceversion0-vs-specnodenamenode1">3.3 Specify <code>spec.nodeName=node1&amp;resourceVersion=0</code> vs. <code>specnode.Name=node1&quot;</code></h3>
<h4 id="same-result">Same result</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ./curl-k8s-apiserver.sh <span class="s2">&#34;https://localhost:6443/api/v1/namespaces/default/pods?fieldSelector=spec.nodeName%3Dnode1&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.items[].spec.nodeName&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node1&#34;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ./curl-k8s-apiserver.sh <span class="s2">&#34;https://localhost:6443/api/v1/namespaces/default/pods?fieldSelector=spec.nodeName%3Dnode1&amp;resourceVersion=0&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.items[].spec.nodeName&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node1&#34;</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>The result is the same, unless there is an inconsistency between apiserver cache and etcd data, which is extremely unlikely and we won&rsquo;t discuss here.</p>
<h4 id="speed-varies-greatly">Speed varies greatly</h4>
<p>Using time to measure the elapsed time in the above two cases, you will find that for larger clusters, there is a significant difference in response time between the two types of requests.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">time</span> ./curl-k8s-apiserver.sh &lt;url&gt; &gt; result
</span></span></code></pre></td></tr></table>
</div>
</div><p>For a cluster size of 4K nodes, 100K pods, the following data is provided for reference.</p>
<ul>
<li>without <code>resourceVersion=0</code> (read etcd and filter at apiserver): time consumed <strong><code>10s</code></strong></li>
<li>with <code>resourceVersion=0</code> (read apiserver cache): time consumed <strong><code>0.05s</code></strong></li>
</ul>
<p>200x worse.</p>
<blockquote>
<p>The total size of the full pod is calculated at 2GB, averaging 20KB each.</p>
</blockquote>
<h2 id="4-list-request-to-control-plane-pressure-quantitative-analysis">4 LIST Request to Control Plane Pressure: Quantitative Analysis</h2>
<p>This section presents an example of the cilium-agent to quantify the pressure on the control plane when it starts.</p>
<h3 id="41-collecting-list-requests">4.1 Collecting LIST requests</h3>
<p>The first step is to obtain which resources are LISTed to k8s when the agent starts. There are several ways to collect them.</p>
<ol>
<li>in the k8s access log, filtered by ServiceAccount, verb, request_uri, etc.</li>
<li>through agent logs.</li>
<li>by further code analysis, etc.</li>
</ol>
<p>Suppose we collect the following LIST requests.</p>
<ol>
<li><code>api/v1/namespaces?resourceVersion=0</code></li>
<li><code>api/v1/pods?filedSelector=spec.nodeName%3Dnode1&amp;resourceVersion=0</code></li>
<li><code>api/v1/nodes?fieldSelector=metadata.name%3Dnode1&amp;resourceVersion=0</code></li>
<li><code>api/v1/services?labelSelector=%21service.kubernetes.io%2Fheadless%2C%21service.kubernetes.io%2Fservice-proxy-name</code></li>
<li><code>apis/discovery.k8s.io/v1beta1/endpointslices?resourceVersion=0</code></li>
<li><code>apis/networking.k8s.io/networkpolicies?resourceVersion=0</code></li>
<li><code>apis/cilium.io/v2/ciliumnodes?resourceVersion=0</code></li>
<li><code>apis/cilium.io/v2/ciliumnetworkpolicies?resourceVersion=0</code></li>
<li><code>apis/cilium.io/v2/ciliumclusterwidenetworkpolicies?resourceVersion=0</code></li>
</ol>
<h3 id="22-testing-the-amount-of-data-and-time-consumed-by-list-requests">2.2 Testing the amount of data and time consumed by LIST requests</h3>
<p>With the list of LIST requests, you can then manually execute these requests and get the following data.</p>
<ol>
<li>
<p>request time consumption</p>
</li>
<li>
<p>the amount of data processed by the request, which is divided into two types.</p>
<ol>
<li>the amount of data processed by apiserver (full amount of data), the evaluation of the performance impact on apiserver/etcd should be based on this</li>
<li>the amount of data that the agent finally gets (filtered by selector)</li>
</ol>
</li>
</ol>
<p>The following script (put on the real environment k8s master) can be used to execute the test once.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat benchmark-list-overheads.sh
</span></span><span class="line"><span class="cl"><span class="nv">apiserver_url</span><span class="o">=</span><span class="s2">&#34;https://localhost:6443&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># List k8s core resources (e.g. pods, services)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># API: GET/LIST /api/v1/&lt;resources&gt;?&lt;fileld/label selector&gt;&amp;resourceVersion=0</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> benchmark_list_core_resource<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">resource</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="nv">selectors</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;----------------------------------------------------&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Benchmarking list </span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">listed_file</span><span class="o">=</span><span class="s2">&#34;listed-</span><span class="nv">$resource</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$apiserver_url</span><span class="s2">/api/v1/</span><span class="nv">$resource</span><span class="s2">?resourceVersion=0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># first perform a request without selectors, this is the size apiserver really handles</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;curl </span><span class="nv">$url</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">time</span> ./curl-k8s-apiserver.sh <span class="s2">&#34;</span><span class="nv">$url</span><span class="s2">&#34;</span> &gt; <span class="nv">$listed_file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># perform another request if selectors are provided, this is the size client receives</span>
</span></span><span class="line"><span class="cl">    <span class="nv">listed_file2</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$listed_file</span><span class="s2">-filtered&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&#34;</span><span class="nv">$selectors</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$url</span><span class="s2">&amp;</span><span class="nv">$selectors</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;curl </span><span class="nv">$url</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">time</span> ./curl-k8s-apiserver.sh <span class="s2">&#34;</span><span class="nv">$url</span><span class="s2">&#34;</span> &gt; <span class="nv">$listed_file2</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ls -ahl <span class="nv">$listed_file</span> <span class="nv">$listed_file2</span> 2&gt;/dev/null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;----------------------------------------------------&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># List k8s apiextension resources (e.g. pods, services)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># API: GET/LIST /apis/&lt;api group&gt;/&lt;resources&gt;?&lt;fileld/label selector&gt;&amp;resourceVersion=0</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> benchmark_list_apiexternsion_resource<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">api_group</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">    <span class="nv">resource</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">    <span class="nv">selectors</span><span class="o">=</span><span class="nv">$3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;----------------------------------------------------&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Benchmarking list </span><span class="nv">$api_group</span><span class="s2">/</span><span class="nv">$resource</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">api_group_flatten_name</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$api_group</span> <span class="p">|</span> sed <span class="s1">&#39;s/\//-/g&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">listed_file</span><span class="o">=</span><span class="s2">&#34;listed-</span><span class="nv">$api_group_flatten_name</span><span class="s2">-</span><span class="nv">$resource</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$apiserver_url</span><span class="s2">/apis/</span><span class="nv">$api_group</span><span class="s2">/</span><span class="nv">$resource</span><span class="s2">?resourceVersion=0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> ! -z <span class="s2">&#34;</span><span class="nv">$selectors</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$url</span><span class="s2">&amp;</span><span class="nv">$selectors</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;curl </span><span class="nv">$url</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">time</span> ./curl-k8s-apiserver.sh <span class="s2">&#34;</span><span class="nv">$url</span><span class="s2">&#34;</span> &gt; <span class="nv">$listed_file</span>
</span></span><span class="line"><span class="cl">    ls -ahl <span class="nv">$listed_file</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;----------------------------------------------------&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">benchmark_list_core_resource <span class="s2">&#34;namespaces&#34;</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_core_resource <span class="s2">&#34;pods&#34;</span>       <span class="s2">&#34;filedSelector=spec.nodeName%3Dnode1&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_core_resource <span class="s2">&#34;nodes&#34;</span>      <span class="s2">&#34;fieldSelector=metadata.name%3Dnode1&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_core_resource <span class="s2">&#34;services&#34;</span>   <span class="s2">&#34;labelSelector=%21service.kubernetes.io%2Fheadless%2C%21service.kubernetes.io%2Fservice-proxy-name&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;discovery.k8s.io/v1beta1&#34;</span> <span class="s2">&#34;endpointslices&#34;</span>                   <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;apiextensions.k8s.io/v1&#34;</span>  <span class="s2">&#34;customresourcedefinitions&#34;</span>        <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;networking.k8s.io&#34;</span>        <span class="s2">&#34;networkpolicies&#34;</span>                  <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;cilium.io/v2&#34;</span>             <span class="s2">&#34;ciliumnodes&#34;</span>                      <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;cilium.io/v2&#34;</span>             <span class="s2">&#34;ciliumendpoints&#34;</span>                  <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;cilium.io/v2&#34;</span>             <span class="s2">&#34;ciliumnetworkpolicies&#34;</span>            <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">benchmark_list_apiexternsion_resource <span class="s2">&#34;cilium.io/v2&#34;</span>             <span class="s2">&#34;ciliumclusterwidenetworkpolicies&#34;</span> <span class="s2">&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The execution effect is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ benchmark-list-overheads.sh
</span></span><span class="line"><span class="cl">----------------------------------------------------
</span></span><span class="line"><span class="cl">Benchmarking list
</span></span><span class="line"><span class="cl">curl https://localhost:6443/api/v1/namespaces?resourceVersion<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.090s
</span></span><span class="line"><span class="cl">user    0m0.038s
</span></span><span class="line"><span class="cl">sys     0m0.044s
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 69K listed-namespaces
</span></span><span class="line"><span class="cl">----------------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Benchmarking list <span class="nv">fieldSelector</span><span class="o">=</span>spec.nodeName%3Dnode1
</span></span><span class="line"><span class="cl">curl https://localhost:6443/api/v1/pods?resourceVersion<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m18.332s
</span></span><span class="line"><span class="cl">user    0m1.355s
</span></span><span class="line"><span class="cl">sys     0m1.822s
</span></span><span class="line"><span class="cl">curl https://localhost:6443/api/v1/pods?resourceVersion<span class="o">=</span>0<span class="p">&amp;</span><span class="nv">fieldSelector</span><span class="o">=</span>spec.nodeName%3Dnode1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">real    0m0.242s
</span></span><span class="line"><span class="cl">user    0m0.044s
</span></span><span class="line"><span class="cl">sys     0m0.188s
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 2.0G listed-pods
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 526K listed-pods-filtered
</span></span><span class="line"><span class="cl">----------------------------------------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note: For LIST with selector, e.g. <code>LIST pods?spec.nodeName=node1</code>, this script will execute the request without selector first, in order to measure the amount of data apiserver needs to process, e.g. the list pods above: 1.</p>
<ol>
<li>the agent really executes <code>pods?resourceVersion=0&amp;fieldSelector=spec.nodeName%3Dnode1</code>, so the request time consumption should be based on this</li>
<li>the extra execution of <code>pods?resourceVersion=0</code> is to test how much data the apiserver needs to process for a request of 1</li>
</ol>
<blockquote>
<p>Note: List all pods will generate 2GB files, so use this benchmark tool with caution, first understand what you are testing with the script you wrote, and especially don&rsquo;t automate or run concurrently, you may blow up apiserver/etcd.</p>
</blockquote>
<h3 id="43-analysis-of-test-results">4.3 Analysis of test results</h3>
<p>The above output has the following key information.</p>
<ol>
<li>the type of resources in the LIST, e.g. pods/endpoints/services</li>
<li>the time consumed by the LIST operation</li>
<li>the amount of data involved in the LIST operation
<ol>
<li>the amount of data (in json format) to be processed by apiserver: the above list pods, for example, corresponds to the <code>listed-pods</code> file, totaling 2GB.</li>
<li>the amount of data received by the agent (since the agent may have specified label/field filters): in the case of the list pods above, corresponding to the <code>listed-pods-filtered</code> file, totaling <code>526K</code></li>
</ol>
</li>
</ol>
<p>By collecting and sorting all LIST requests in the above way, we know how much pressure the agent puts on apiserver/etcd for one startup operation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ls -ahl listed-*
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  <span class="m">222</span> listed-apiextensions.k8s.io-v1-customeresourcedefinitions
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 5.8M listed-apiextensions.k8s.io-v1-customresourcedefinitions
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 2.0M listed-cilium.io-v2-ciliumclusterwidenetworkpolicies
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 193M listed-cilium.io-v2-ciliumendpoints
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  <span class="m">185</span> listed-cilium.io-v2-ciliumnetworkpolicies
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 6.6M listed-cilium.io-v2-ciliumnodes
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  42M listed-discovery.k8s.io-v1beta1-endpointslices
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  69K listed-namespaces
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  <span class="m">222</span> listed-networking.k8s.io-networkpolicies
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  70M listed-nodes    <span class="c1"># 仅用于评估 apiserver 需要处理的数据量</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  25K listed-nodes-filtered
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 2.0G listed-pods     <span class="c1"># 仅用于评估 apiserver 需要处理的数据量</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root 526K listed-pods-filtered
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  23M listed-services <span class="c1"># 仅用于评估 apiserver 需要处理的数据量</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root  23M listed-services-filtered
</span></span></code></pre></td></tr></table>
</div>
</div><p>Again using cilium as an example, there is roughly this sort (amount of data processed by apiserver, json format)</p>
<table>
<thead>
<tr>
<th>List Resource Type</th>
<th>Amount of data processed by apiserver (json)</th>
<th>Time consuming</th>
</tr>
</thead>
<tbody>
<tr>
<td>CiliumEndpoints (Full volume）</td>
<td>193MB</td>
<td>11s</td>
</tr>
<tr>
<td>CiliumNodes (Full volume）</td>
<td>70MB</td>
<td>0.5s</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<h2 id="5-large-scale-foundation-services-deployment-and-tuning-recommendations">5 Large Scale Foundation Services: Deployment and Tuning Recommendations</h2>
<h3 id="51-list-request-default-setting-resourceversion0">5.1 List request default setting <code>ResourceVersion=0</code></h3>
<p>As described earlier, not setting this parameter will cause apiserver to pull the full amount of data from etcd and then filter it, resulting in</p>
<ol>
<li>very slow</li>
<li>too large for etcd to handle</li>
</ol>
<p>Therefore, unless you have to pull data from etcd because of high data accuracy requirements, you should set the <code>ResourceVersion=0</code> parameter on LIST requests and let apiserver serve it with cache.</p>
<p>If you are using <strong>client-go&rsquo;s ListWatch/informer interface</strong>, then it already has <code>ResourceVersion=0</code> set by default.</p>
<h3 id="52-preferring-the-namespaced-api">5.2 Preferring the namespaced API</h3>
<p>If the resources to be LISTed are in a single or a few namespaces, consider using the namespaced API.</p>
<ul>
<li>Namespaced API: <code>/api/v1/namespaces/&lt;ns&gt;/pods?query=xxx</code></li>
<li>Un-namespaced API: <code>/api/v1/pods?query=xxx</code></li>
</ul>
<h3 id="53-restart-backoff">5.3 Restart backoff</h3>
<p>For per-node deployed base services, such as kubelet, cilium-agent, daemonsets, the stress on the control plane during large restarts needs to be reduced by an effective restart backoff.</p>
<p>For example, the number of agents restarted per minute after a simultaneous hang should not exceed 10% of the cluster size (configurable, or can be calculated automatically). api/v1/pods?query=xxx`</p>
<h3 id="54-prioritize-filtering-on-the-server-side-via-labelfield-selector">5.4 Prioritize filtering on the server side via label/field selector</h3>
<p>If you need to cache some resources and listen for changes, you need to use the ListWatch mechanism to pull the data locally and the business logic filters it from the local cache itself as needed. This is client-go&rsquo;s ListWatch/informer mechanism.</p>
<p>But if it&rsquo;s just a one-time LIST operation with filtering criteria, like the nodename filtering pod example mentioned earlier, then obviously we should let apiserver filter out the data for us by setting label or field filters. LIST 10w pods takes a few tens of seconds (most of the time is spent on data transfer and also takes up a lot of CPU/BW/IO on apiserver), while if only the pods on the local machine are needed, LIST may only take <code>0.05s</code> to return the results after setting <code>nodeName=node1</code>. It is also very important not to forget to include <code>resourceVersion=0</code> in the request.</p>
<h4 id="541-label-selector">5.4.1 Label selector</h4>
<p>In-memory filtering in apiserver.</p>
<h4 id="542-field-selector">5.4.2 Field selector</h4>
<p>In-memory filtering in apiserver.</p>
<h4 id="543-namespace-selector">5.4.3 Namespace selector</h4>
<p>Namespace is part of the prefix in etcd, so it is possible to specify namespace to filter resources much faster than selectors that are not prefixed.</p>
<h3 id="55-supporting-infrastructure-monitoring-alerting-etc">5.5 Supporting infrastructure (monitoring, alerting, etc.)</h3>
<p>The above analysis shows that a single request from a client may only return a few hundred KB of data, but an apiserver (or worse, etcd) needs to handle GBs of data. Therefore, mass restart of basic services should be avoided, and for this reason monitoring and alerting should be done as well as possible.</p>
<h4 id="551-use-independent-serviceaccount">5.5.1 Use independent ServiceAccount</h4>
<p>Each basic service (e.g. kubelet, cilium-agent, etc.) and various operators that have a lot of LIST operations on the apiserver use their own independent SAs, which makes it easy for the apiserver to distinguish the source of requests and is useful for monitoring, troubleshooting, and server-side flow limitation.</p>
<h4 id="552-liveness-monitoring-alerts">5.5.2 Liveness Monitoring Alerts</h4>
<p>The base service must be covered by liveness monitoring.</p>
<p>There must be P1 level liveness alerts to detect mass hang scenarios first. Then reduce the pressure on the control plane by restart backoff.</p>
<h4 id="553-monitoring-and-tuning-etcd">5.5.3 Monitoring and tuning etcd</h4>
<p>The key performance-related indicators need to be monitored and alerted.</p>
<ol>
<li>
<p>memory</p>
</li>
<li>
<p>bandwidth</p>
</li>
<li>
<p>number of large LIST requests and response times such as the following <code>LIST all pods</code> logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;warn&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;apply request took too long&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;took&#34;</span><span class="p">:</span><span class="s2">&#34;5357.87304ms&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;expected-duration&#34;</span><span class="p">:</span><span class="s2">&#34;100ms&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;prefix&#34;</span><span class="p">:</span><span class="s2">&#34;read-only range &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;request&#34;</span><span class="p">:</span><span class="s2">&#34;key:\&#34;/registry/pods/\&#34; range_end:\&#34;/registry/pods0\&#34; &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;response&#34;</span><span class="p">:</span><span class="s2">&#34;range_response_count:60077 size:602251227&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>Deployment and configuration tuning.</p>
<ol>
<li>K8s events split to a separate etcd cluster</li>
<li>other.</li>
</ol>
<h2 id="6-other">6 Other</h2>
<h3 id="61-get-requests-getoptions">6.1 Get requests: <code>GetOptions{}</code></h3>
<p>The basic principle is the same as <code>ListOption{}</code>, not setting <code>ResourceVersion=0</code> will cause the apiserver to go to etcd to get the data, so you should try to avoid it.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/wishbone/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Wishbone Bus Protocol</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/api-server/">
            <span class="next-text nav-default">The process of apiserver processing requests</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
