<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Mv and Rename - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="What happens if I Ctrl C in the middle of an mv operation? Will the file be corrupted?" /><meta name="keywords" content="mv, rename" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/mv-and-rename/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Mv and Rename" />
<meta property="og:description" content="What happens if I Ctrl C in the middle of an mv operation? Will the file be corrupted?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/mv-and-rename/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-23T13:57:16+08:00" />
<meta property="article:modified_time" content="2022-06-23T13:57:16+08:00" />

<meta itemprop="name" content="Mv and Rename">
<meta itemprop="description" content="What happens if I Ctrl C in the middle of an mv operation? Will the file be corrupted?"><meta itemprop="datePublished" content="2022-06-23T13:57:16+08:00" />
<meta itemprop="dateModified" content="2022-06-23T13:57:16+08:00" />
<meta itemprop="wordCount" content="871">
<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mv and Rename"/>
<meta name="twitter:description" content="What happens if I Ctrl C in the middle of an mv operation? Will the file be corrupted?"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Mv and Rename</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-23 13:57:16 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 871 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    
    <div class="post-content">
      <p>I had an interesting question today: &ldquo;What happens if I Ctrl C in the middle of an mv operation? Will the file be corrupted?&rdquo; Without considering error handling, this question needs to be discussed in separate cases.</p>
<ul>
<li>Is it on the same file system?</li>
<li>Is the object of the mv a file or a folder?</li>
</ul>
<p>First, the simplest case: mv a file on the same filesystem, where mv is done using <code>rename</code> syscall.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">execve</span><span class="p">(</span><span class="s">&#34;/usr/bin/mv&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;mv&#34;</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">],</span> <span class="mh">0x7ffe6ae9f580</span> <span class="cm">/* 51 vars */</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">renameat2</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="n">AT_FDCWD</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="n">RENAME_NOREPLACE</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">exit_group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                           <span class="o">=</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl"><span class="o">+++</span> <span class="n">exited</span> <span class="n">with</span> <span class="mi">0</span> <span class="o">+++</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>By POSIX definition, the <code>rename</code> operation is atomic, and subsequent additions of <code>renameat</code> and <code>renameat2</code> to the Linux kernel also meet this requirement. This is made clear in <a href="https://man7.org/linux/man-pages/man2/rename.2.html">rename(2)</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">rename() renames a file, moving it between directories if
</span></span><span class="line"><span class="cl">required.  Any other hard links to the file (as created using
</span></span><span class="line"><span class="cl">link(2)) are unaffected.  Open file descriptors for oldpath are
</span></span><span class="line"><span class="cl">also unaffected.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If newpath already exists, it will be atomically replaced, so
</span></span><span class="line"><span class="cl">that there is no point at which another process attempting to
</span></span><span class="line"><span class="cl">access newpath will find it missing.  However, there will
</span></span><span class="line"><span class="cl">probably be a window in which both oldpath and newpath refer to
</span></span><span class="line"><span class="cl">the file being renamed.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If newpath exists but the operation fails for some reason,
</span></span><span class="line"><span class="cl">rename() guarantees to leave an instance of newpath in place.
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can also use <code>rename</code> to mv a folder on the same filesystem, so I won&rsquo;t go into that again.</p>
<p>In summary, mv operations on the same filesystem are always atomic, and there is no chance of being interrupted by <code>Ctrl-C</code>, which is often referred to as <code>uninterruptable</code>.</p>
<p>Next, we deal with the case of not being on the same file system. For Linux, not being on the same filesystem is actually more strictly limited to not being under the same mount point. That is, <code>rename</code> syscall will return an <code>EXDEV</code> error regardless of whether they are on the same filesystem at the bottom, as long as they have different mount points.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">EXDEV  oldpath and newpath are not on the same mounted
</span></span><span class="line"><span class="cl">        filesystem.  (Linux permits a filesystem to be mounted at
</span></span><span class="line"><span class="cl">        multiple points, but rename() does not work across
</span></span><span class="line"><span class="cl">        different mount points, even if the same filesystem is
</span></span><span class="line"><span class="cl">        mounted on both.)
</span></span></code></pre></td></tr></table>
</div>
</div><p>It would obviously be very uncomfortable for <code>mv</code>, which is exposed for user use, to not support moving around the filesystem, and these considerations are documented in <a href="https://man7.org/linux/man-pages/man1/mv.1p.html">mv</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">The rename() function is able to move directories within the same
</span></span><span class="line"><span class="cl">file system. Some historical versions of mv have been able to
</span></span><span class="line"><span class="cl">move directories, but not to a different file system.  The
</span></span><span class="line"><span class="cl">standard developers considered that this was an annoying
</span></span><span class="line"><span class="cl">inconsistency, so this volume of POSIX.1‐2017 requires
</span></span><span class="line"><span class="cl">directories to be able to be moved even across file systems.
</span></span><span class="line"><span class="cl">There is no -R option to confirm that moving a directory is
</span></span><span class="line"><span class="cl">actually intended, since such an option was not required for
</span></span><span class="line"><span class="cl">moving directories in historical practice. Requiring the
</span></span><span class="line"><span class="cl">application to specify it sometimes, depending on the
</span></span><span class="line"><span class="cl">destination, seemed just as inconsistent. The semantics of the
</span></span><span class="line"><span class="cl">rename() function were preserved as much as possible. For
</span></span><span class="line"><span class="cl">example, mv is not permitted to ``rename&#39;&#39; files to or from
</span></span><span class="line"><span class="cl">directories, even though they might be empty and removable.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Specifically, mv is implemented by degenerating to <code>copy &amp; unlink</code> to move across filesystems, as we can confirm by reading the source code and analyzing strace. archlinux uses <a href="https://github.com/coreutils/coreutils">coreutils</a>, so take a brief look at it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="nf">do_move</span> <span class="p">(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cp_options</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">copy_into_self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">rename_succeeded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="n">copy</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copy_into_self</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rename_succeeded</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">dir_to_remove</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="n">status</span> <span class="o">=</span> <span class="n">rm</span> <span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rm_options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">assert</span> <span class="p">(</span><span class="n">VALID_STATUS</span> <span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">RM_ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So if you call <code>Ctrl C</code> while mving a file across filesystems, mv may leave an incomplete file at src or dst. But mv will always make sure that one of src or dst is complete, not that both src and dst are incomplete. As mentioned in the manual page.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">If the copying or removal of source_file is prematurely
</span></span><span class="line"><span class="cl">terminated by a signal or error, mv may leave a partial copy of
</span></span><span class="line"><span class="cl">source_file at the source or destination. The mv utility shall
</span></span><span class="line"><span class="cl">not modify both source_file and the destination path
</span></span><span class="line"><span class="cl">simultaneously; termination at any point shall leave either
</span></span><span class="line"><span class="cl">source_file or the destination path complete.
</span></span></code></pre></td></tr></table>
</div>
</div><p>The same guarantee mentioned above applies to mv folders across file systems. src/dst always has a complete file in one place, and mv will always make sure that all files are copied before it starts deleting them.</p>
<p>In general, <code>Ctrl C</code> will not destroy files during mv, and in the most extreme cases, only dst will be copied incompletely or src will be deleted incompletely.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">linux</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/mysql-binlog/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Recovering mysql data via binlog</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/dynamic-password-algorith/">
            <span class="next-text nav-default">Dynamic Password Algorith</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
