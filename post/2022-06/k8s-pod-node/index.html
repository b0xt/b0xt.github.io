<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to set up a Pod to run on a specific node - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to set up a Pod to run on a given node." /><meta name="keywords" content="Pod, node" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/k8s-pod-node/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How to set up a Pod to run on a specific node" />
<meta property="og:description" content="Learn how to set up a Pod to run on a given node." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/k8s-pod-node/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-28T12:48:37+08:00" />
<meta property="article:modified_time" content="2022-06-28T12:48:37+08:00" />

<meta itemprop="name" content="How to set up a Pod to run on a specific node">
<meta itemprop="description" content="Learn how to set up a Pod to run on a given node."><meta itemprop="datePublished" content="2022-06-28T12:48:37+08:00" />
<meta itemprop="dateModified" content="2022-06-28T12:48:37+08:00" />
<meta itemprop="wordCount" content="1285">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to set up a Pod to run on a specific node"/>
<meta name="twitter:description" content="Learn how to set up a Pod to run on a given node."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to set up a Pod to run on a specific node</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-28 12:48:37 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1285 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-specify-the-node-by-nodeselector-when-creating-the-load">1. Specify the Node by nodeSelector when creating the load</a></li>
        <li><a href="#2-bind-namespaces-to-nodes-via-access-control">2. Bind namespaces to nodes via access control</a>
          <ul>
            <li><a href="#21-modifying-kube-apiserver-parameters">2.1 Modifying kube-apiserver parameters</a></li>
            <li><a href="#22-adding-annotations-to-namespace">2.2 Adding annotations to Namespace</a></li>
            <li><a href="#23-adding-a-specified-label-to-a-node">2.3 Adding a specified label to a node</a></li>
            <li><a href="#24-creating-loads">2.4 Creating Loads</a></li>
            <li><a href="#25-cleaning-up-the-environment">2.5 Cleaning up the environment</a></li>
          </ul>
        </li>
        <li><a href="#3-grouping-nodes-using-topology-domains">3. Grouping nodes using topology domains</a></li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-specify-the-node-by-nodeselector-when-creating-the-load">1. Specify the Node by nodeSelector when creating the load</h2>
<ul>
<li>
<p>Add a label to the node</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label node node2 <span class="nv">project</span><span class="o">=</span>A
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Specify the nodeSelector to create the workload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: apps/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Deployment
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">name: nginx-nodeselector
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">replicas: 1
</span></span></span><span class="line"><span class="cl"><span class="s">selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: nginx-nodeselector
</span></span></span><span class="line"><span class="cl"><span class="s">template:
</span></span></span><span class="line"><span class="cl"><span class="s">    metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">    labels:
</span></span></span><span class="line"><span class="cl"><span class="s">        app: nginx-nodeselector
</span></span></span><span class="line"><span class="cl"><span class="s">    spec:
</span></span></span><span class="line"><span class="cl"><span class="s">    nodeSelector:
</span></span></span><span class="line"><span class="cl"><span class="s">        project: A
</span></span></span><span class="line"><span class="cl"><span class="s">    containers:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: nginx
</span></span></span><span class="line"><span class="cl"><span class="s">        image: nginx
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>View Workload</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod  -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                                  READY   STATUS    RESTARTS   AGE   IP              NODE    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-nodeselector-7bb75b7687-7r5xk   1/1     Running   <span class="m">0</span>          19s   10.233.96.60    node2   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>As expected, the Pod is running on the specified node node2.</p>
</li>
<li>
<p>Clean up the environment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl delete deployments nginx-nodeselector 
</span></span><span class="line"><span class="cl">kubectl label node node2 project-
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>In fact, there is another node selection parameter, <code>nodeName</code>, which specifies the node name directly. However, this setting is too rigid and overrides Kubernetes&rsquo; own scheduling mechanism, and is rarely used in production.</p>
<h2 id="2-bind-namespaces-to-nodes-via-access-control">2. Bind namespaces to nodes via access control</h2>
<p>Specifying nodeSelector when creating a load allows you to set the nodes under which the Pod will run. However, if you want to bind all Pods under a namespace to run under a given node, it is not possible. This can be done with kube-apiserver access control, a feature that entered alpha in Kubernetes 1.5.</p>
<h3 id="21-modifying-kube-apiserver-parameters">2.1 Modifying kube-apiserver parameters</h3>
<p>Edit the kube-apiserver file:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vim /etc/kubernetes/manifests/kube-apiserver.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Add <code>PodNodeSelector</code> to <code>admission-plugins</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">    - --enable-admission-plugins<span class="o">=</span>NodeRestriction,PodNodeSelector
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>NodeRestriction</code> is enabled by default. If it is a highly available cluster, then you need to modify each kube-apiserver and wait a while for the kube-apiserver to complete the reboot process.</p>
<h3 id="22-adding-annotations-to-namespace">2.2 Adding annotations to Namespace</h3>
<p>Edit the namespace and add annotations:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl edit ns default
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Namespace
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl"> name: default
</span></span><span class="line"><span class="cl"> annotations:
</span></span><span class="line"><span class="cl">   scheduler.alpha.kubernetes.io/node-selector: <span class="nv">project</span><span class="o">=</span>A
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>scheduler.alpha.kubernetes.io/node-selector</code> can be either a node name or a label key-value pair.</p>
<h3 id="23-adding-a-specified-label-to-a-node">2.3 Adding a specified label to a node</h3>
<p>Label the node3 node with <code>project=A</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label node node3 <span class="nv">project</span><span class="o">=</span>A
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here, the load on namespace default is bound to node node3.</p>
<h3 id="24-creating-loads">2.4 Creating Loads</h3>
<ul>
<li>
<p>Create a load for testing</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: apps/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Deployment
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">name: nginx-scheduler
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">replicas: 3
</span></span></span><span class="line"><span class="cl"><span class="s">selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: nginx-scheduler
</span></span></span><span class="line"><span class="cl"><span class="s">template:
</span></span></span><span class="line"><span class="cl"><span class="s">    metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">    labels:
</span></span></span><span class="line"><span class="cl"><span class="s">        app: nginx-scheduler
</span></span></span><span class="line"><span class="cl"><span class="s">    spec:
</span></span></span><span class="line"><span class="cl"><span class="s">    containers:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: nginx
</span></span></span><span class="line"><span class="cl"><span class="s">        image: nginx
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>View Load Distribution</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-scheduler-6478998698-brkzn   1/1     Running   <span class="m">0</span>          84s   10.233.92.52   node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-scheduler-6478998698-m422x   1/1     Running   <span class="m">0</span>          84s   10.233.92.51   node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-scheduler-6478998698-mnf4d   1/1     Running   <span class="m">0</span>          84s   10.233.92.50   node3   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>As you can see, although there are 4 available nodes on the cluster, the load under the default space is running under the node3 node.</p>
<h3 id="25-cleaning-up-the-environment">2.5 Cleaning up the environment</h3>
<ul>
<li>
<p>Cleanup label</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label node node3 project-
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Clearing the load</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl delete deployments nginx-scheduler 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Cleanup Notes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl edit ns default
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>Note that if the namespace has <code>scheduler.alpha.kubernetes.io/node-selector</code> turned on and the node does not have a tag associated with it, the Pod will remain in the Pending state and will not be scheduled until a node matching the tag is available.</p>
<h2 id="3-grouping-nodes-using-topology-domains">3. Grouping nodes using topology domains</h2>
<p>As shown in the figure below, with kube-apiserver&rsquo;s access control plugin, we can build models with one namespace per project and each namespace contains specified nodes. This meets the requirements of, business isolation and cost billing. However, as the cluster gets larger, the project needs to divide several availability zones under the cluster for securing business availability.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/28/59848166040746ef8f8abfe02e78f75b.png" alt="Grouping nodes using topology domains"></p>
<p>The topology domain is mainly to solve the problem of Pod distribution in the cluster, and can be used to achieve the demand of Pod to node directional selection. The topology domain feature of Kubernetes Cluster Scheduler entered Alpha phase in 1.16 and Beta phase in 1.18. Here we perform some experiments:</p>
<ul>
<li>
<p>Dividing nodes into different topological domains</p>
<p>Here, node2 is assigned to zone a and node3 and node4 are assigned to zone b.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label node node2 <span class="nv">zone</span><span class="o">=</span>a
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label node node3 node4 <span class="nv">zone</span><span class="o">=</span>b
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Creating Loads</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: apps/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Deployment
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">name: nginx-topology
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">replicas: 20
</span></span></span><span class="line"><span class="cl"><span class="s">selector:
</span></span></span><span class="line"><span class="cl"><span class="s">    matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: nginx-topology
</span></span></span><span class="line"><span class="cl"><span class="s">template:
</span></span></span><span class="line"><span class="cl"><span class="s">    metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">    labels:
</span></span></span><span class="line"><span class="cl"><span class="s">        app: nginx-topology
</span></span></span><span class="line"><span class="cl"><span class="s">    spec:
</span></span></span><span class="line"><span class="cl"><span class="s">    topologySpreadConstraints:
</span></span></span><span class="line"><span class="cl"><span class="s">    - maxSkew: 1
</span></span></span><span class="line"><span class="cl"><span class="s">        topologyKey: zone
</span></span></span><span class="line"><span class="cl"><span class="s">        whenUnsatisfiable: DoNotSchedule
</span></span></span><span class="line"><span class="cl"><span class="s">        labelSelector:
</span></span></span><span class="line"><span class="cl"><span class="s">        matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">            app: nginx-topology
</span></span></span><span class="line"><span class="cl"><span class="s">    containers:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: nginx
</span></span></span><span class="line"><span class="cl"><span class="s">        image: nginx
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>topologyKey</code> is used to specify the Key for dividing the topology domain, <code>maxSkew</code> means the difference in the number of Pods in zone=a and zone=b cannot exceed 1, <code>whenUnsatisfiable: DoNotSchedule</code> means no scheduling is done when the condition is not satisfied.</p>
</li>
<li>
<p>View Pod distribution</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod  -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                              READY   STATUS    RESTARTS   AGE    IP              NODE    NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-2srcj   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.63    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-2wxkp   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.53    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-4db5b   1/1     Running   <span class="m">0</span>          3m3s   10.233.105.43   node4   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-9tqvn   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.58    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-9zll5   1/1     Running   <span class="m">0</span>          3m3s   10.233.105.45   node4   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-d6nbm   1/1     Running   <span class="m">0</span>          3m3s   10.233.105.44   node4   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-f4nw9   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.54    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-ggfgv   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.66    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-gj4pg   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.61    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-jc2xt   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.62    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-jmmcx   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.56    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-l45qj   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.65    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-lwp8m   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.64    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-m65rx   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.57    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-pzrzs   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.55    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-tslxx   1/1     Running   <span class="m">0</span>          3m3s   10.233.92.60    node3   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-v4cqx   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.50    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-w4r86   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.52    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-wwn95   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.51    node2   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-topology-7d8698544d-xffpx   1/1     Running   <span class="m">0</span>          3m3s   10.233.96.59    node2   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are 10 Pods in node2, 7 nodes in node3, and 3 nodes in node4. You can see that the Pods are evenly distributed on zone=a and zone=b.</p>
</li>
<li>
<p>Clean up the environment</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl label node node2 node3 node4 zone-
</span></span><span class="line"><span class="cl">kubectl delete deployments nginx-topology
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="4-summary">4. Summary</h2>
<p>As clusters get larger, issues such as isolation between businesses and exclusivity of businesses to nodes surface. Usually, each business will have a separate namespace, so we can bind the namespace to the nodes.</p>
<p>This article mainly gives two methods, one is to set nodeSelector directly when creating loads, and the tricky way is to use namespace value as value; the other way is to use the access control plugin provided by kube-apiserver to filter the specified nodes by tag when creating loads under namespaces through annotation to complete the binding between namespaces and nodes. The other way is to use the access control plugin provided by kube-apiserver to filter nodes by tag when creating loads under namespaces.</p>
<p>Consider further that if the number of nodes is very large and we need to divide the available zones to spread the load, then we can do so with the help of topology domains. Through topology domains, we can make the load evenly distributed on the specified availability zones and cabinets according to the configured policies.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/show-file-deleted/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Find and delete large files that have been opened but deleted</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/cgroup/">
            <span class="next-text nav-default">cgroup cpu subsystem</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
