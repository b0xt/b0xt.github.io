<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The Complete Guide to Migrating Storage Across StorageClass in Kubernetes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to migrate storage across StorageClass in Kubernetes." /><meta name="keywords" content="Kubernetes, Migrating Storage, Across StorageClass" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/k8s-migrating/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="The Complete Guide to Migrating Storage Across StorageClass in Kubernetes" />
<meta property="og:description" content="Learn how to migrate storage across StorageClass in Kubernetes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/k8s-migrating/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-19T21:10:27+08:00" />
<meta property="article:modified_time" content="2022-06-19T21:10:27+08:00" />

<meta itemprop="name" content="The Complete Guide to Migrating Storage Across StorageClass in Kubernetes">
<meta itemprop="description" content="Learn how to migrate storage across StorageClass in Kubernetes."><meta itemprop="datePublished" content="2022-06-19T21:10:27+08:00" />
<meta itemprop="dateModified" content="2022-06-19T21:10:27+08:00" />
<meta itemprop="wordCount" content="1815">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The Complete Guide to Migrating Storage Across StorageClass in Kubernetes"/>
<meta name="twitter:description" content="Learn how to migrate storage across StorageClass in Kubernetes."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The Complete Guide to Migrating Storage Across StorageClass in Kubernetes</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-19 21:10:27 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1815 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#thinking">Thinking</a></li>
        <li><a href="#backup-pvc-and-pv">Backup PVC and PV</a></li>
        <li><a href="#copy-data">Copy data</a></li>
        <li><a href="#migrating-pvcs">Migrating PVCs</a></li>
        <li><a href="#one-more-time">One more time</a></li>
        <li><a href="#restore-workload">Restore Workload</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="thinking">Thinking</h2>
<p>Let&rsquo;s first think about what few things need to be done to switch StorageClass. First you need to reduce the number of copies of the application to 0, then create a new PVC, copy the data from the old PV to the new PV, then let the application use the new PV and expand the copies to the original number, and finally delete the old PV. This whole process also prevents Kubernetes from deleting the PV when the PVC is deleted.</p>
<p>Of course, some CSI drives or storage backends may have more convenient data migration techniques, but this article provides a more general solution, regardless of the storage backend.</p>
<p>The persistent volume declaration (PVC) used by KubeSphere 3.3.0 after turning on all components is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/52d93b37766142ff863870eba40222ef.png" alt="KubeSphere"></p>
<p>This article uses Elasticsearch as an example to demonstrate how to replace Elasticsearch&rsquo;s storage with distributed storage from local storage.</p>
<h2 id="backup-pvc-and-pv">Backup PVC and PV</h2>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/a0604d51f9f74d6ab525b4c2e1ba025f.png" alt="Backup PVC and PV"></p>
<p>The first step is to back up the PVC and PV, in case the operation fails later, there is room for reversal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pvc
</span></span><span class="line"><span class="cl">NAME                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS     AGE
</span></span><span class="line"><span class="cl">data-elasticsearch-logging-data-0        Bound    pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9   20Gi       RWO            local-hostpath   28h
</span></span><span class="line"><span class="cl">data-elasticsearch-logging-data-1        Bound    pvc-0851350a-270e-4d4d-af8d-081132c1775b   20Gi       RWO            local-hostpath   28h
</span></span><span class="line"><span class="cl">data-elasticsearch-logging-discovery-0   Bound    pvc-8f32fc97-3d6e-471a-8121-655991d945a8   4Gi        RWO            local-hostpath   28h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pv pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9 -o yaml &gt; pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9.yaml
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pv pvc-0851350a-270e-4d4d-af8d-081132c1775b -o yaml &gt; pvc-0851350a-270e-4d4d-af8d-081132c1775b.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pvc data-elasticsearch-logging-data-0 -o yaml &gt; data-elasticsearch-logging-data-0.yaml
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pvc data-elasticsearch-logging-data-1 -o yaml &gt; data-elasticsearch-logging-data-1.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="copy-data">Copy data</h2>
<p>Whether the accessModes of PV is <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes">ReadWriteOnce</a> or <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes">ReadWriteMany</a>, the number of copies of the application should be reduced to 0 before copying data, because ReadWriteOne mode allows only one Pod to be mounted at the same time and new Pods cannot be mounted, while ReadWriteMany mode if If the ReadWriteMany mode does not reduce the number of copies to 0, new data may be written when the data is copied. So by all means, reduce the number of replicas to 0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get sts
</span></span><span class="line"><span class="cl">NAME                              READY   AGE
</span></span><span class="line"><span class="cl">elasticsearch-logging-data        2/2     28h
</span></span><span class="line"><span class="cl">elasticsearch-logging-discovery   1/1     28h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system scale sts elasticsearch-logging-data --replicas<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get sts
</span></span><span class="line"><span class="cl">NAME                              READY   AGE
</span></span><span class="line"><span class="cl">elasticsearch-logging-data        0/0     28h
</span></span><span class="line"><span class="cl">elasticsearch-logging-discovery   1/1     28h
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a new PVC called <code>new-data-elasticsearch-logging-data-0</code> with the same capacity as <code>data-elasticsearch-logging-data-0</code>, and specify storageClassName as the new StorageClass.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/28830bb0a60940cdbff94f53ac5e773c.png" alt="StorageClass"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/ece351db64414bf2824b2d9ac821468a.png" alt="StorageClass"></p>
<p>Create a Deployment, mount both the new PV and the old PV, and then copy the data from the old PV to the new PV.</p>
<p>Click &ldquo;Create&rdquo; in the &ldquo;Workload&rdquo; screen, and paste the YAML below into it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubesphere-logging-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">datacopy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">datacopy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">datacopy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">datacopy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">datacopy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s1">&#39;sleep&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">infinity</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">old-pv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/old</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-pv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/mnt/new</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">old-pv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">data-elasticsearch-logging-data-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-pv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">new-data-elasticsearch-logging-data-0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This Deployment mounts both the new PV and the old PV, and later we will copy the data from the old PV to the new PV.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/6dd229c2e61c4de182c9179b7cd20057.png" alt="pod"></p>
<p>After the Pod starts successfully, click the container&rsquo;s terminal icon to enter the container&rsquo;s terminal.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/bb3472cb84774d16bf46edcbc940086b.png" alt="container&amp;rsquo;s terminal"></p>
<p>Verify in the container that the mount point of the old PV contains application data and that the mount point of the new PV is empty before executing the command <code>(cd /mnt/old; tar -cf - .) | (cd /mnt/new; tar -xpf -)</code> to ensure that all data ownership and permissions are inherited.</p>
<p>After execution is complete, verify that the mount point of the new PV contains the data of the old PV and that ownership and permissions are properly inherited.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/05b6d31bd5ec464ea511a1cd324c0062.png" alt="terminal"></p>
<p>Here the task of copying the data is done, now we need to reduce the number of datacopy copies to 0.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/b066bb132b2c4c6ca84ff6d0bc6c9bd8.png" alt="the number of datacopy copies to 0"></p>
<h2 id="migrating-pvcs">Migrating PVCs</h2>
<p>The ideal state for migrating storage would be to use the old PVC and point it to the new PV, so that the YAML configuration list of the workload does not need to be changed in any way. However, the binding relationship between the PVC and the PV is immutable, and to get them to unbind, you must first delete the old PVC, then create a PVC with the same name and bind the old PV to it.</p>
<p>Note that by default the recycling policy for PVs is <code>Delete</code>, once a PVC is deleted, the PV bound to it and the data in the PV will be deleted. We don&rsquo;t want to see this, so we need to modify the recycling policy so that the PV will be preserved when the PVC is deleted.</p>
<p>In fact, the <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#reclaim-policy">global reclaim policy can be set via StorageClass</a>, if not, the default is <code>Delete</code>. You can see the reclaimPolicy of a PV by using the command <code>kubectl describe pv &lt;pv-name&gt;</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl describe pv pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9
</span></span><span class="line"><span class="cl">Name:              pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9
</span></span><span class="line"><span class="cl">Labels:            openebs.io/cas-type<span class="o">=</span>local-hostpath
</span></span><span class="line"><span class="cl">Annotations:       pv.kubernetes.io/provisioned-by: openebs.io/local
</span></span><span class="line"><span class="cl">Finalizers:        <span class="o">[</span>kubernetes.io/pv-protection<span class="o">]</span>
</span></span><span class="line"><span class="cl">StorageClass:      local-hostpath
</span></span><span class="line"><span class="cl">Status:            Bound
</span></span><span class="line"><span class="cl">Claim:             kubesphere-logging-system/data-elasticsearch-logging-data-0
</span></span><span class="line"><span class="cl">Reclaim Policy:    Delete
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl describe pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">Name:              pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">Labels:            &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:       pv.kubernetes.io/provisioned-by: disk.csi.qingcloud.com
</span></span><span class="line"><span class="cl">Finalizers:        <span class="o">[</span>kubernetes.io/pv-protection external-attacher/disk-csi-qingcloud-com<span class="o">]</span>
</span></span><span class="line"><span class="cl">StorageClass:      csi-qingcloud
</span></span><span class="line"><span class="cl">Status:            Bound
</span></span><span class="line"><span class="cl">Claim:             kubesphere-logging-system/new-data-elasticsearch-logging-data-0
</span></span><span class="line"><span class="cl">Reclaim Policy:    Delete
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can set the recycling policy for old and new PVs to <code>Retain</code> with the patch command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl patch pv pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9 -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;persistentVolumeReclaimPolicy&#34;:&#34;Retain&#34;}}&#39;</span>
</span></span><span class="line"><span class="cl">persistentvolume/pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9 patched
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl patch pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;persistentVolumeReclaimPolicy&#34;:&#34;Retain&#34;}}&#39;</span>
</span></span><span class="line"><span class="cl">persistentvolume/pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9 patched
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>⚠️Note: This command has no effect on the stability and availability of PV and can be executed at any time.</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/8858f996e5f646a3b1666e3f81eeb652.png" alt="k8s"></p>
<p>Now you can delete all the old and new PVCs without any impact on the PV.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system delete pvc data-elasticsearch-logging-data-0 new-data-elasticsearch-logging-data-0
</span></span><span class="line"><span class="cl">persistentvolumeclaim <span class="s2">&#34;data-elasticsearch-logging-data-0&#34;</span> deleted
</span></span><span class="line"><span class="cl">persistentvolumeclaim <span class="s2">&#34;new-data-elasticsearch-logging-data-0&#34;</span> deleted
</span></span></code></pre></td></tr></table>
</div>
</div><p>Before creating the final PVC, we have to make sure that the newly created PVC can be bound to the new PV. With the following command you can see that the new PV is currently released and cannot be bound by the new PVC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl describe pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">Name:              pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">Labels:            &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:       pv.kubernetes.io/provisioned-by: disk.csi.qingcloud.com
</span></span><span class="line"><span class="cl">Finalizers:        <span class="o">[</span>kubernetes.io/pv-protection external-attacher/disk-csi-qingcloud-com<span class="o">]</span>
</span></span><span class="line"><span class="cl">StorageClass:      csi-qingcloud
</span></span><span class="line"><span class="cl">Status:            Released
</span></span><span class="line"><span class="cl">Claim:             kubesphere-logging-system/new-data-elasticsearch-logging-data-0
</span></span><span class="line"><span class="cl">Reclaim Policy:    Retain
</span></span><span class="line"><span class="cl">Access Modes:      RWO
</span></span><span class="line"><span class="cl">VolumeMode:        Filesystem
</span></span><span class="line"><span class="cl">Capacity:          20Gi
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is because the PV still references the deleted PVC in <code>spec.claimRef</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">$ kubectl get pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e -o yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">20Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">claimRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">new-data-elasticsearch-logging-data-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubesphere-logging-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;657019&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">f4e96f69-b3be-4afe-bb52-1e8e728ca55e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Retain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-qingcloud</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>To solve this problem, you can edit the PV directly with the command <code>kubectl edit pv &lt;pv-name&gt;</code> and delete all the contents of <code>claimRef</code>. Then check that the PV is available.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl describe pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">Name:              pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">Labels:            &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:       pv.kubernetes.io/provisioned-by: disk.csi.qingcloud.com
</span></span><span class="line"><span class="cl">Finalizers:        <span class="o">[</span>kubernetes.io/pv-protection external-attacher/disk-csi-qingcloud-com<span class="o">]</span>
</span></span><span class="line"><span class="cl">StorageClass:      csi-qingcloud
</span></span><span class="line"><span class="cl">Status:            Available
</span></span><span class="line"><span class="cl">Claim:
</span></span><span class="line"><span class="cl">Reclaim Policy:    Retain
</span></span><span class="line"><span class="cl">Access Modes:      RWO
</span></span><span class="line"><span class="cl">VolumeMode:        Filesystem
</span></span><span class="line"><span class="cl">Capacity:          20Gi
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ultimately we need to create a new PVC with the same name as the old PVC and, as far as possible, with the same parameters as the old PVC: * The new PVC has the same name as the old PVC.</p>
<ul>
<li>the name of the new PVC is the same as the name of the old PVC.</li>
<li><code>spec.volumeName</code> pointing to the new PV.</li>
<li><code>metadata.annotations</code> and <code>metadata.labels</code> of the new PVC are kept the same as the old PVC, as these values may affect the application deployment (e.g. Helm chart, etc.).</li>
</ul>
<p>The final PVC contents are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">elasticsearch-logging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data-elasticsearch-logging-data-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubesphere-logging-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">csi-qingcloud</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">20Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeName</span><span class="p">:</span><span class="w"> </span><span class="l">pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Click &ldquo;Create&rdquo; on the &ldquo;Storage Volume Declaration&rdquo; screen.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/786b29c3a14b48f9a94c9427d56d6fa9.png" alt="Storage Volume Declaration"></p>
<p>Select &lsquo;Edit YAML&rsquo;, copy and paste the above YAML content into it, and click &lsquo;Create&rsquo;.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/0d2a1f1855294b4f9656d2de63c102d1.png" alt="Edit YAML"></p>
<p>Finally, you can see that the new PVC and PV are all in Bound state.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pvc data-elasticsearch-logging-data-0
</span></span><span class="line"><span class="cl">NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE
</span></span><span class="line"><span class="cl">data-elasticsearch-logging-data-0   Bound    pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e   20Gi       RWO            csi-qingcloud   64s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e
</span></span><span class="line"><span class="cl">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                                         STORAGECLASS    REASON   AGE
</span></span><span class="line"><span class="cl">pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e   20Gi       RWO            Retain           Bound    kubesphere-logging-system/data-elasticsearch-logging-data-0   csi-qingcloud            11h
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="one-more-time">One more time</h2>
<p>So far, we have only migrated the data for <code>data-elasticsearch-logging-data-0</code>, for <code>data-elasticsearch-logging-data-1</code>, just repeat the steps above, remember to change the PVC in datacopy to <code>data- elasticsearch-logging-data-1</code> and <code>new-data-elasticsearch-logging-data-0</code>, and change the rest of the configuration to the new one.</p>
<h2 id="restore-workload">Restore Workload</h2>
<p>Now that all the storage is migrated, the PVC names remain the same and the PV is using the new storage.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pv -A<span class="p">|</span>grep elasticsearch-logging-data
</span></span><span class="line"><span class="cl">pvc-0851350a-270e-4d4d-af8d-081132c1775b   20Gi       RWO            Retain           Released   kubesphere-logging-system/data-elasticsearch-logging-data-1        local-hostpath            40h
</span></span><span class="line"><span class="cl">pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9   20Gi       RWO            Retain           Released   kubesphere-logging-system/data-elasticsearch-logging-data-0        local-hostpath            40h
</span></span><span class="line"><span class="cl">pvc-d0acd2e7-ee1d-47cf-8506-69147fe25563   20Gi       RWO            Retain           Bound      kubesphere-logging-system/data-elasticsearch-logging-data-1        csi-qingcloud             9m53s
</span></span><span class="line"><span class="cl">pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e   20Gi       RWO            Retain           Bound      kubesphere-logging-system/data-elasticsearch-logging-data-0        csi-qingcloud             11h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pvc<span class="p">|</span>grep elasticsearch-logging-data
</span></span><span class="line"><span class="cl">data-elasticsearch-logging-data-0        Bound    pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e   20Gi       RWO            csi-qingcloud    27m
</span></span><span class="line"><span class="cl">data-elasticsearch-logging-data-1        Bound    pvc-d0acd2e7-ee1d-47cf-8506-69147fe25563   20Gi       RWO            csi-qingcloud    3m49s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Restore copies of the workload to the previous number.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system scale sts elasticsearch-logging-data --replicas<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">statefulset.apps/elasticsearch-logging-data scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl -n kubesphere-logging-system get pod -l <span class="nv">app</span><span class="o">=</span>elasticsearch,component<span class="o">=</span>data
</span></span><span class="line"><span class="cl">NAME                           READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">elasticsearch-logging-data-0   1/1     Running   <span class="m">0</span>          4m12s
</span></span><span class="line"><span class="cl">elasticsearch-logging-data-1   1/1     Running   <span class="m">0</span>          3m42s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Perfect!</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/2aa23c29143c48119513f1929b6c6421.png" alt="k8s"></p>
<p>There is one last bit of finishing work, we need to reset the recycling policy for all new PVs to <code>Delete</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl patch pv pvc-d0acd2e7-ee1d-47cf-8506-69147fe25563 -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;persistentVolumeReclaimPolicy&#34;:&#34;Delete&#34;}}&#39;</span>
</span></span><span class="line"><span class="cl">persistentvolume/pvc-d0acd2e7-ee1d-47cf-8506-69147fe25563 patched
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl patch pv pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;persistentVolumeReclaimPolicy&#34;:&#34;Delete&#34;}}&#39;</span>
</span></span><span class="line"><span class="cl">persistentvolume/pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e patched
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pv -A<span class="p">|</span>grep elasticsearch-logging-data
</span></span><span class="line"><span class="cl">pvc-0851350a-270e-4d4d-af8d-081132c1775b   20Gi       RWO            Retain           Released   kubesphere-logging-system/data-elasticsearch-logging-data-1        local-hostpath            40h
</span></span><span class="line"><span class="cl">pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9   20Gi       RWO            Retain           Released   kubesphere-logging-system/data-elasticsearch-logging-data-0        local-hostpath            40h
</span></span><span class="line"><span class="cl">pvc-d0acd2e7-ee1d-47cf-8506-69147fe25563   20Gi       RWO            Delete           Bound      kubesphere-logging-system/data-elasticsearch-logging-data-1        csi-qingcloud             15m
</span></span><span class="line"><span class="cl">pvc-f4e96f69-b3be-4afe-bb52-1e8e728ca55e   20Gi       RWO            Delete           Bound      kubesphere-logging-system/data-elasticsearch-logging-data-0        csi-qingcloud             11h
</span></span></code></pre></td></tr></table>
</div>
</div><p>At the end of the day, you can delete all the old PVs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl delete pv pvc-0851350a-270e-4d4d-af8d-081132c1775b
</span></span><span class="line"><span class="cl">persistentvolume <span class="s2">&#34;pvc-0851350a-270e-4d4d-af8d-081132c1775b&#34;</span> deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl delete pv pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9
</span></span><span class="line"><span class="cl">persistentvolume <span class="s2">&#34;pvc-9aed3d1b-09a6-4fe3-8adc-9195a2bbb2b9&#34;</span> deleted
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-redis-server/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">A high latency problem caused by misaligned versions of go-redis and redis server</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/wishbone/">
            <span class="next-text nav-default">Wishbone Bus Protocol</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
