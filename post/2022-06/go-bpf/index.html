<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Use BPF to increase the throughput of Go network programs by 8 times - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use BPF to increase the throughput of Go network programs by a factor of 8." /><meta name="keywords" content="golang, Bpf" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/go-bpf/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Use BPF to increase the throughput of Go network programs by 8 times" />
<meta property="og:description" content="Learn how to use BPF to increase the throughput of Go network programs by a factor of 8." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/go-bpf/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-06T12:08:17+08:00" />
<meta property="article:modified_time" content="2022-06-06T12:08:17+08:00" />

<meta itemprop="name" content="Use BPF to increase the throughput of Go network programs by 8 times">
<meta itemprop="description" content="Learn how to use BPF to increase the throughput of Go network programs by a factor of 8."><meta itemprop="datePublished" content="2022-06-06T12:08:17+08:00" />
<meta itemprop="dateModified" content="2022-06-06T12:08:17+08:00" />
<meta itemprop="wordCount" content="2941">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Use BPF to increase the throughput of Go network programs by 8 times"/>
<meta name="twitter:description" content="Learn how to use BPF to increase the throughput of Go network programs by a factor of 8."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Use BPF to increase the throughput of Go network programs by 8 times</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-06 12:08:17 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2941 words </span>
          <span class="more-meta"> 14 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#demo-program">Demo program</a>
          <ul>
            <li><a href="#server-side-program">Server-side program</a></li>
            <li><a href="#client-program">Client program</a></li>
            <li><a href="#auxiliary-methods">Auxiliary methods</a></li>
          </ul>
        </li>
        <li><a href="#performance-issues">Performance issues</a></li>
        <li><a href="#bpf-for-packet-filtering">BPF for Packet Filtering</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The classic bpf (classical Berkeley Packet Filter) is a technique that works very well to improve performance in some special Go underlying network programming situations.</p>
<h2 id="background">Background</h2>
<p>I have previously developed a Go UDP application where the client and server communicate via a raw socket via a UDP program. The purpose of the program is rather specific, so I&rsquo;ll present a simple program as an example here.</p>
<p>Actually, I&rsquo;m not being strict when I say I&rsquo;m using the rawsocket approach.</p>
<p>I did not use the following way to implement sockets and communicate (link layer way).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span><span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Socket</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">AF_PACKET</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SOCK_RAW</span><span class="p">,</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">ETH_P_ALL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Obtained fd &#34;</span><span class="p">,</span> <span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The rawsocket approach (IP layer approach) below is also not used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fd</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Socket</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SOCK_RAW</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">IPPROTO_UDP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Problem @ location 1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SockaddrInet4</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Port</span><span class="p">:</span> <span class="mi">27289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Addr</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">byte</span><span class="p">{</span><span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span> <span class="o">:=</span> <span class="nf">pkt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">syscall</span><span class="p">.</span><span class="nf">Sendto</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;Sendto:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Instead, it directly uses the method <code>net.ListenPacket(&quot;ip4:udp&quot;, addr)</code> encapsulated in the Go standard library to send and receive packets at the IP layer.</p>
<p>I implement custom packet sending and receiving by wrapping custom UDP layer data structure for network monitoring.</p>
<p>Some people may say, just use the standard library UDPConn. If it is an ordinary UDP program, it is indeed no problem, if for some special needs, such as listening to 1000 UDP ports, there are tens of thousands of nodes regularly send monitoring data, we are unlikely to build 1000 * 10,000 UDPConn, so here I use the rawsocket communication method.</p>
<p>RawSocket is part of the standard Berkeley socket. When we use Go&rsquo;s standard library to develop network programs, most of the scenarios use the encapsulated datagram type (UDPConn) or stream type (TCPConn), but if you want to do some lower-level network programming, you need to use RawSocket, such as The underlying protocols are TCP, UDP, ICMP, ARP, etc. Different operating systems may implement RawSocket differently, here we take Linux environment as an example.</p>
<p>The Linux man manual gives a detailed introduction to RawSocket related knowledge: <a href="https://man7.org/linux/man-pages/man2/socket.2.html">socket(2)</a>, <a href="https://man7.org/linux/man-pages/man7/packet.7.html">packet(7)</a>, <a href="https://man7.org/linux/man-pages/man7/raw.7.html">raw(7)</a>, which will not be reproduced in this article, and is not the focus of this article.</p>
<p>According to the Linux documentation, packets received in the Linux server are passed to both the kernel network module and RawSocket, so you sometimes need to be careful when using RawSocket, for example, if you are processing a TCP packet, the Linux kernel network program may have already processed the packet.</p>
<blockquote>
<p>Raw sockets may tap all IP protocols in Linux, even protocols like ICMP or TCP which have a protocol module in the kernel. In this case, the packets are passed to both the kernel module and the raw socket(s). This should not be relied upon in portable programs, many other BSD socket implementation have limitations here.</p>
</blockquote>
<p>If there are no special requirements, we will just use <a href="https://pkg.go.dev/net#ListenPacket">net.ListenPacket</a> to implement a RawSocket program. The signature of this method is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ListenPacket</span><span class="p">(</span><span class="nx">network</span><span class="p">,</span> <span class="nx">address</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">PacketConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first parameter <code>network</code> can be <code>udp</code>, <code>udp4</code>, <code>udp6</code>, <code>unixgram</code>, or <code>ip</code>, <code>ip4</code>, <code>ip6</code> with a colon and a protocol number or protocol name, such as <code>ip:1</code>, <code>ip:icmp</code>.</p>
<h2 id="demo-program">Demo program</h2>
<h3 id="server-side-program">Server-side program</h3>
<p>The server-side program uses <code>conn, err := net.ListenPacket(&quot;ip4:udp&quot;, *addr)</code> to listen for all UDP packets on the local address and start a goroutine to process them. There should be another judgment in the handler, which is to check if the UDP port is the one we are dealing with, because here <code>net.ListenPacket</code> is listening to all the local UDP, and there may be a lot of useless UDP packets that are passed to the user state program.</p>
<p>Here we use gopacket&rsquo;s definition of packets for various protocol layers to facilitate the parsing (or creation) of network protocols for each TCP/IP layer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket/layers&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/go-network-programming/codec&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;golang.org/x/net/bpf&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;golang.org/x/net/ipv4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">port</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;p&#34;</span><span class="p">,</span> <span class="mi">8972</span><span class="p">,</span> <span class="s">&#34;port&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stat</span>         <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lastStatTime</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ListenPacket</span><span class="p">(</span><span class="s">&#34;ip4:udp&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">IPConn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span><span class="p">.</span><span class="nf">SetReadBuffer</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span><span class="p">.</span><span class="nf">SetWriteBuffer</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">handleConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">handleConn</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span><span class="p">,</span> <span class="nx">remoteaddr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">ReadFrom</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">buffer</span> <span class="p">=</span> <span class="nx">buffer</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">packet</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nf">NewPacket</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeUDP</span><span class="p">,</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nx">NoCopy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Get the UDP layer from this packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">udpLayer</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">Layer</span><span class="p">(</span><span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeUDP</span><span class="p">);</span> <span class="nx">udpLayer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">udp</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">udpLayer</span><span class="p">.(</span><span class="o">*</span><span class="nx">layers</span><span class="p">.</span><span class="nx">UDP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">app</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">ApplicationLayer</span><span class="p">();</span> <span class="nx">app</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">EncodeUDPPacket</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">),</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">),</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">udp</span><span class="p">.</span><span class="nx">DstPort</span><span class="p">),</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">udp</span><span class="p">.</span><span class="nx">SrcPort</span><span class="p">),</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Payload</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;failed to EncodePacket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">WriteTo</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">remoteaddr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;failed to write packet: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="client-program">Client program</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket/layers&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/go-network-programming/codec&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ListenPacket</span><span class="p">(</span><span class="s">&#34;ip4:udp&#34;</span><span class="p">,</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">EncodeUDPPacket</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">),</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">),</span> <span class="mi">8972</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;failed to EncodePacket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">remoteAddr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">net</span><span class="p">.</span><span class="nx">IPAddr</span><span class="p">{</span><span class="nx">IP</span><span class="p">:</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">WriteTo</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">remoteAddr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;failed to write packet: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">ReadFrom</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">buffer</span> <span class="p">=</span> <span class="nx">buffer</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">packet</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nf">NewPacket</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeUDP</span><span class="p">,</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nx">NoCopy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Get the UDP layer from this packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">udpLayer</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">Layer</span><span class="p">(</span><span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeUDP</span><span class="p">);</span> <span class="nx">udpLayer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">app</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">ApplicationLayer</span><span class="p">();</span> <span class="nx">app</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;reply: %s\n&#34;</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Payload</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The client program is simplified here by writing a <code>hello</code> and reading the return from the server. When we do performance testing, we use a loop to continuously write a seq number and check whether the server returns this seq in order to calculate the packet loss performance. And also use a flow limiter to limit the flow and test the packet loss rate at a certain RPS.</p>
<h3 id="auxiliary-methods">Auxiliary methods</h3>
<p>The following is the <code>EncodeUDPPacket</code> method, which is used to generate a UDP packet data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">codec</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket/layers&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">EncodeUDPPacket</span><span class="p">(</span><span class="nx">localIP</span><span class="p">,</span> <span class="nx">remoteIP</span> <span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">,</span> <span class="nx">localPort</span><span class="p">,</span> <span class="nx">remotePort</span> <span class="kt">uint16</span><span class="p">,</span> <span class="nx">payload</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ip</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">layers</span><span class="p">.</span><span class="nx">IPv4</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Version</span><span class="p">:</span>  <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">TTL</span><span class="p">:</span>      <span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">SrcIP</span><span class="p">:</span>    <span class="nx">localIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">DstIP</span><span class="p">:</span>    <span class="nx">remoteIP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Protocol</span><span class="p">:</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">IPProtocolUDP</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">udp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">layers</span><span class="p">.</span><span class="nx">UDP</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">SrcPort</span><span class="p">:</span> <span class="nx">layers</span><span class="p">.</span><span class="nf">UDPPort</span><span class="p">(</span><span class="nx">localPort</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">DstPort</span><span class="p">:</span> <span class="nx">layers</span><span class="p">.</span><span class="nf">UDPPort</span><span class="p">(</span><span class="nx">remotePort</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">udp</span><span class="p">.</span><span class="nf">SetNetworkLayerForChecksum</span><span class="p">(</span><span class="nx">ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">buf</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nf">NewSerializeBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opts</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nx">SerializeOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ComputeChecksums</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">FixLengths</span><span class="p">:</span>       <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nf">SerializeLayers</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">udp</span><span class="p">,</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nf">Payload</span><span class="p">(</span><span class="nx">payload</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">buf</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(),</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="performance-issues">Performance issues</h2>
<p>Although the above program runs fine, there are some problems in case of higher concurrency.</p>
<p>Above we started a goroutine to read this packet, here is a performance bottleneck, and eventually the server can only use one core to handle the RawSocket packet.</p>
<p>Even if you create multiple goroutines to read this PacketConn, it is useless because this PacketConn is unique and it is a bottleneck. Sometimes it is better to use only one goroutine to read it than multiple goroutines.</p>
<p>So can we call <code>net.ListenPacket(&quot;ip4:udp&quot;, *addr)</code> multiple times to generate multiple RawSockets to process concurrently?</p>
<p>It seems to work, but in reality, the multiple RawSockets all read the same UDPPacket instead of being load balanced and spread out over multiple Sockets. So multiple RawSockets are not only useless, but also consume more resources of the server.</p>
<p>The actual test can only reach 20-30 thousand throughput, and the higher the concurrency, the higher the packet loss.</p>
<p>But is there no way out?</p>
<p>Not really. Here we can see that the main performance bottleneck is that our program above has no way to do load balancing, using the power of multiple cores to concurrently process. The second performance bottleneck is that the program listens to all the UDP packets on the local machine and hands them over to the user state program to filter and process, which has a lot of packets we don&rsquo;t need.</p>
<p>Both of these performance problems can be handled by BPF.</p>
<h2 id="bpf-for-packet-filtering">BPF for Packet Filtering</h2>
<p>The classic BPF has been around since 1994, and although everyone is now talking about the extended BPF (eBPF), the classic BPF still has the power to make it work.</p>
<p>You may not have applied BPF in programming, but I believe you must have worked with it in practice.</p>
<p>For example, when you use tcpdump to listen to the transmission of the network, you often add filters, such as the following command to listen only to port 8080 of the tcp protocol:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">tcpdump -nn -vvvv -i any <span class="s2">&#34;tcp port 8080&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcpdump actually generates <code>tcp port 8080</code> as a filter, filters the packets in the kernel, and filters out only the filtered packets.</p>
<p>You can actually view the compiled filtering code with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@lab ~]# tcpdump -d &#34;tcp port 8080&#34;
</span></span><span class="line"><span class="cl">(000) ldh      [12]
</span></span><span class="line"><span class="cl">(001) jeq      #0x86dd          jt 2    jf 8
</span></span><span class="line"><span class="cl">(002) ldb      [20]
</span></span><span class="line"><span class="cl">(003) jeq      #0x6             jt 4    jf 19
</span></span><span class="line"><span class="cl">(004) ldh      [54]
</span></span><span class="line"><span class="cl">(005) jeq      #0x1f90          jt 18   jf 6
</span></span><span class="line"><span class="cl">(006) ldh      [56]
</span></span><span class="line"><span class="cl">(007) jeq      #0x1f90          jt 18   jf 19
</span></span><span class="line"><span class="cl">(008) jeq      #0x800           jt 9    jf 19
</span></span><span class="line"><span class="cl">(009) ldb      [23]
</span></span><span class="line"><span class="cl">(010) jeq      #0x6             jt 11   jf 19
</span></span><span class="line"><span class="cl">(011) ldh      [20]
</span></span><span class="line"><span class="cl">(012) jset     #0x1fff          jt 19   jf 13
</span></span><span class="line"><span class="cl">(013) ldxb     4*([14]&amp;0xf)
</span></span><span class="line"><span class="cl">(014) ldh      [x + 14]
</span></span><span class="line"><span class="cl">(015) jeq      #0x1f90          jt 18   jf 16
</span></span><span class="line"><span class="cl">(016) ldh      [x + 16]
</span></span><span class="line"><span class="cl">(017) jeq      #0x1f90          jt 18   jf 19
</span></span><span class="line"><span class="cl">(018) ret      #262144
</span></span><span class="line"><span class="cl">(019) ret      #0
</span></span></code></pre></td></tr></table>
</div>
</div><p>What does this mean? BPF defines a limited number of instructions to filter the packets in the VM.</p>
<p>The first line is to load the packet offset (offset 12 bytes), the second line is to check if it is IPV6, if so jump to <code>002</code>, if not jump to <code>008</code>. Let&rsquo;s focus on IPV4.</p>
<p>The <code>008</code> line is to determine if it is IPv4, if it is jump to <code>009</code>. The <code>009</code> line loads a byte at offset 23, which is the ip proto, and the <code>010</code> line determines if the ip proto is TCP, if so, jump to <code>011</code>.</p>
<p>Next, determine the flags in order to determine the address of the data.</p>
<p>Lines <code>014</code> and <code>016</code> read the source and destination ports in the TCP protocol, if they are equal to <code>8080</code> ( <code>0x1f90</code> ), the maximum return packet size is 262144 bytes, otherwise the packet is discarded.</p>
<p>Of course the code generated by tcpdump is quite rigorous. When we actually write it, if we are sure that it is an ipv4 package and the package is not much extended, the code is simpler than this. But we might as well use the code generated by tcpdump when we actually apply BPF without any errors.</p>
<p>Use <code>-dd</code> to display it as a c code fragment, and <code>-ddd</code> to display it as a decimal number. Let&rsquo;s look at the effect of <code>-dd</code>, as this result we can use to convert to Go code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">[root@lab ~]# tcpdump -dd &#34;tcp port 8080&#34;
</span></span><span class="line"><span class="cl">{ 0x28, 0, 0, 0x0000000c },
</span></span><span class="line"><span class="cl">{ 0x15, 0, 6, 0x000086dd },
</span></span><span class="line"><span class="cl">{ 0x30, 0, 0, 0x00000014 },
</span></span><span class="line"><span class="cl">{ 0x15, 0, 15, 0x00000006 },
</span></span><span class="line"><span class="cl">{ 0x28, 0, 0, 0x00000036 },
</span></span><span class="line"><span class="cl">{ 0x15, 12, 0, 0x00001f90 },
</span></span><span class="line"><span class="cl">{ 0x28, 0, 0, 0x00000038 },
</span></span><span class="line"><span class="cl">{ 0x15, 10, 11, 0x00001f90 },
</span></span><span class="line"><span class="cl">{ 0x15, 0, 10, 0x00000800 },
</span></span><span class="line"><span class="cl">{ 0x30, 0, 0, 0x00000017 },
</span></span><span class="line"><span class="cl">{ 0x15, 0, 8, 0x00000006 },
</span></span><span class="line"><span class="cl">{ 0x28, 0, 0, 0x00000014 },
</span></span><span class="line"><span class="cl">{ 0x45, 6, 0, 0x00001fff },
</span></span><span class="line"><span class="cl">{ 0xb1, 0, 0, 0x0000000e },
</span></span><span class="line"><span class="cl">{ 0x48, 0, 0, 0x0000000e },
</span></span><span class="line"><span class="cl">{ 0x15, 2, 0, 0x00001f90 },
</span></span><span class="line"><span class="cl">{ 0x48, 0, 0, 0x00000010 },
</span></span><span class="line"><span class="cl">{ 0x15, 0, 1, 0x00001f90 },
</span></span><span class="line"><span class="cl">{ 0x6, 0, 0, 0x00040000 },
</span></span><span class="line"><span class="cl">{ 0x6, 0, 0, 0x00000000 },
</span></span></code></pre></td></tr></table>
</div>
</div><p>In fact, <a href="https://pkg.go.dev/golang.org/x/net/bpf">x/net/bpf</a> provides the corresponding methods to write BPF programs, serializing and deserializing more easily. For example, to write a program that filters out all packets with destination port equal to 8972, we can simply write it in the following format (considering the simple form, we only considered the form of IPV4 and normal IP packets):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Filter</span> <span class="p">[]</span><span class="nx">bpf</span><span class="p">.</span><span class="nx">Instruction</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">filter</span> <span class="p">=</span> <span class="nx">Filter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bpf</span><span class="p">.</span><span class="nx">LoadAbsolute</span><span class="p">{</span><span class="nx">Off</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="nx">Size</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>                                <span class="c1">//Load destination port to register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bpf</span><span class="p">.</span><span class="nx">JumpIf</span><span class="p">{</span><span class="nx">Cond</span><span class="p">:</span> <span class="nx">bpf</span><span class="p">.</span><span class="nx">JumpEqual</span><span class="p">,</span> <span class="nx">Val</span><span class="p">:</span> <span class="mi">8972</span><span class="p">,</span> <span class="nx">SkipFalse</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="c1">// If the value is equal to 8972, then execute the next line, otherwise skip the next line
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bpf</span><span class="p">.</span><span class="nx">RetConstant</span><span class="p">{</span><span class="nx">Val</span><span class="p">:</span> <span class="mh">0xffff</span><span class="p">},</span>   <span class="c1">// Returns up to 0xffff bytes of data for this packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bpf</span><span class="p">.</span><span class="nx">RetConstant</span><span class="p">{</span><span class="nx">Val</span><span class="p">:</span> <span class="mh">0x0</span><span class="p">},</span> <span class="c1">// Return zero bytes, i.e. ignore the packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can write a program that converts the code generated by tcpdump into bpf&rsquo;s RawInstruction instruction:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">data</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">raws</span> <span class="p">[]</span><span class="nx">bpf</span><span class="p">.</span><span class="nx">RawInstruction</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lines</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">line</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lines</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">line</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;{&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">line</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSuffix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34; },&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">items</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// assert len(items) == 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">raw</span> <span class="o">:=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nx">RawInstruction</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Op</span><span class="p">:</span> <span class="nb">uint16</span><span class="p">(</span><span class="nf">numToInteger</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Jt</span><span class="p">:</span> <span class="nb">uint8</span><span class="p">(</span><span class="nf">numToInteger</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Jf</span><span class="p">:</span> <span class="nb">uint8</span><span class="p">(</span><span class="nf">numToInteger</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">K</span><span class="p">:</span>  <span class="nb">uint32</span><span class="p">(</span><span class="nf">numToInteger</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">raws</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">raws</span><span class="p">,</span> <span class="nx">raw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">raws</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">numToInteger</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&#34;0x&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="s">&#34;0x&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Well all this is ready, the background knowledge is introduced and the performance bottleneck of the current RawSocket program is introduced, so what if the performance bottleneck is solved.</p>
<p>The first performance bottleneck we can generate multiple goroutines, each goroutine is responsible for filtering a part of the packets, so that the load balancing is achieved. For example, filtering based on the IP of the client, or the server listens to 1000 ports, each goroutine is only responsible for a portion of the port. And filtering can be done based on the source port of the client, etc. Always, with BPF filtering, a goroutine is responsible for only a part of the packet, enabling multi-core processing.</p>
<p>The second bottleneck is solved with the first problem. Because BPF only filters our specific ports, UDP packets from other ports are not copied from the kernel state to the user state, reducing the processing of useless packets.</p>
<p>To set BPF filtering for PacketConn of standard library, there are also various ways to do it, such as calling <code>syscall.SetsockoptInt</code> to set it. But <a href="https://pkg.go.dev/golang.org/x/net/ipv4#PacketConn.SetBPF">golang.org/x/net/ipv4</a> provides the SetBPF method, so we can directly convert the PacketConn of the standard library to ipv4.PacketConn, and then set it.</p>
<p>For example, in the server program above, we can modify it to use BPF filtering in the kernel state:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/gopacket/layers&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/go-network-programming/codec&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;golang.org/x/net/bpf&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;golang.org/x/net/ipv4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="s">&#34;localhost&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">port</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;p&#34;</span><span class="p">,</span> <span class="mi">8972</span><span class="p">,</span> <span class="s">&#34;port&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stat</span>         <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lastStatTime</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ListenPacket</span><span class="p">(</span><span class="s">&#34;ip4:udp&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">IPConn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span><span class="p">.</span><span class="nf">SetReadBuffer</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span><span class="p">.</span><span class="nf">SetWriteBuffer</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pconn</span> <span class="o">:=</span> <span class="nx">ipv4</span><span class="p">.</span><span class="nf">NewPacketConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assembled</span> <span class="p">[]</span><span class="nx">bpf</span><span class="p">.</span><span class="nx">RawInstruction</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">assembled</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bpf</span><span class="p">.</span><span class="nf">Assemble</span><span class="p">(</span><span class="nx">filter</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pconn</span><span class="p">.</span><span class="nf">SetBPF</span><span class="p">(</span><span class="nx">assembled</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">handleConn</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">handleConn</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span><span class="p">,</span> <span class="nx">remoteaddr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">ReadFrom</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">buffer</span> <span class="p">=</span> <span class="nx">buffer</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">packet</span> <span class="o">:=</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nf">NewPacket</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeUDP</span><span class="p">,</span> <span class="nx">gopacket</span><span class="p">.</span><span class="nx">NoCopy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Get the UDP layer from this packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">udpLayer</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">Layer</span><span class="p">(</span><span class="nx">layers</span><span class="p">.</span><span class="nx">LayerTypeUDP</span><span class="p">);</span> <span class="nx">udpLayer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">udp</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">udpLayer</span><span class="p">.(</span><span class="o">*</span><span class="nx">layers</span><span class="p">.</span><span class="nx">UDP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">app</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">ApplicationLayer</span><span class="p">();</span> <span class="nx">app</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">EncodeUDPPacket</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">),</span> <span class="nx">net</span><span class="p">.</span><span class="nf">ParseIP</span><span class="p">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="p">),</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">udp</span><span class="p">.</span><span class="nx">DstPort</span><span class="p">),</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">udp</span><span class="p">.</span><span class="nx">SrcPort</span><span class="p">),</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Payload</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;failed to EncodePacket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">WriteTo</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">remoteaddr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;failed to write packet: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Filter</span> <span class="p">[]</span><span class="nx">bpf</span><span class="p">.</span><span class="nx">Instruction</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">filter</span> <span class="p">=</span> <span class="nx">Filter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bpf</span><span class="p">.</span><span class="nx">LoadAbsolute</span><span class="p">{</span><span class="nx">Off</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span> <span class="nx">Size</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>                                <span class="c1">// load the destination port
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bpf</span><span class="p">.</span><span class="nx">JumpIf</span><span class="p">{</span><span class="nx">Cond</span><span class="p">:</span> <span class="nx">bpf</span><span class="p">.</span><span class="nx">JumpEqual</span><span class="p">,</span> <span class="nx">Val</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="o">*</span><span class="nx">port</span><span class="p">),</span> <span class="nx">SkipFalse</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="c1">// if Val != 8972 skip next instruction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bpf</span><span class="p">.</span><span class="nx">RetConstant</span><span class="p">{</span><span class="nx">Val</span><span class="p">:</span> <span class="mh">0xffff</span><span class="p">},</span>                                      <span class="c1">// return 0xffff bytes (or less) from packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bpf</span><span class="p">.</span><span class="nx">RetConstant</span><span class="p">{</span><span class="nx">Val</span><span class="p">:</span> <span class="mh">0x0</span><span class="p">},</span> <span class="c1">// return 0 bytes, effectively ignore this packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/rxjava-chain/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The principle of RxJava chain calls</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/go-querystring/">
            <span class="next-text nav-default">go-querystring: a tool for converting structs to URL query strings</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
