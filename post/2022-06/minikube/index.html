<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Want to learn k8s but don&#39;t have an environment? Build one easily with minikube - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article gives you a way to build a k8s test cluster using minikube." /><meta name="keywords" content="Minikube, k8s" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/minikube/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Want to learn k8s but don&#39;t have an environment? Build one easily with minikube" />
<meta property="og:description" content="This article gives you a way to build a k8s test cluster using minikube." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/minikube/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-04T13:07:56+08:00" />
<meta property="article:modified_time" content="2022-06-04T13:07:56+08:00" />

<meta itemprop="name" content="Want to learn k8s but don&#39;t have an environment? Build one easily with minikube">
<meta itemprop="description" content="This article gives you a way to build a k8s test cluster using minikube."><meta itemprop="datePublished" content="2022-06-04T13:07:56+08:00" />
<meta itemprop="dateModified" content="2022-06-04T13:07:56+08:00" />
<meta itemprop="wordCount" content="2294">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Want to learn k8s but don&#39;t have an environment? Build one easily with minikube"/>
<meta name="twitter:description" content="This article gives you a way to build a k8s test cluster using minikube."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Want to learn k8s but don&#39;t have an environment? Build one easily with minikube</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-04 13:07:56 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2294 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#start">Start</a></li>
        <li><a href="#plugins">Plugins</a></li>
        <li><a href="#k8s-cluster">k8s cluster</a>
          <ul>
            <li><a href="#deploying-an-rpcx-server-side-application">Deploying an rpcx server-side application</a></li>
            <li><a href="#deploying-the-rpcx-client-application">Deploying the rpcx client application</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://kubernetes.io/">Kubernetes</a> (often referred to as K8s) is an open source system for automating the deployment, scaling, and management of &ldquo;containerized applications&rdquo;. The system was designed by Google and donated to the Cloud Native Computing Foundation (now part of the Linux Foundation) for use.</p>
<p>It is designed to provide &ldquo;a platform for automating the deployment, scaling, and running of application containers across host clusters&rdquo;. It supports a range of container tools, including Docker and others.</p>
<p>Kubernetes (which means &ldquo;helmsman&rdquo; or &ldquo;pilot&rdquo; in Greek) was founded by Joe Beda, Brendan Burns and Craig McLuckie and joined by other Google engineers, including Brian Grant and Tim Hockin, and was first announced by Google in 2014. The system&rsquo;s development and design were heavily influenced by Google&rsquo;s Borg system, and many of its top contributors were previously developers of Borg. Within Google, the original codename for Kubernetes used to be Seven, the Borg of Star Trek, and the seven spokes of the rudder wheel in the Kubernetes logo are a nod to the project&rsquo;s codename.</p>
<p>Kuberbetes has been a hot technology in the IT industry, many people want to learn it, but just want to get started encountered a problem, need to build a k8s cluster. Although cloud service providers such as AliCloud and BaiduCloud offer k8s clustering services, you still need to spend a fortune to buy the services and nodes. How can you build a k8s cluster to learn on your own machine? This article gives you a way to build a k8s test cluster using minikube.</p>
<h2 id="installation">Installation</h2>
<p><a href="https://minikube.sigs.k8s.io/docs/start/">minikube</a> is primarily based on running a single-node Kubernetes cluster in order to support development within VMs on local machines. It supports VM drivers such as VirtualBox, HyperV, KVM2. Since Minikube is a relatively mature solution in the Kubernetes architecture, the list of supported features is very impressive. These features are load balancers, multiple clusters, node ports, persistent volumes, portals, dashboards, or container runtimes.</p>
<p>Based on the Minikube open source tool, it enables developers, operations staff and DevOps engineers to quickly build Kubernetes single-node cluster environments locally. After all, Minikube does not require too much hardware and software resources, making it easy for technical staff to learn and practice, as well as for daily project development.</p>
<p>To run minikube, you need at least:</p>
<ul>
<li>2 CPU or more.</li>
<li>2GB of RAM.</li>
<li>20GB of disk space.</li>
<li>Internet access.</li>
<li>A container or virtual machine manager such as: Docker, Hyperkit, Hyper-V, KVM, Parallels, Podman, VirtualBox, or VMware Fusion/Workstation.</li>
</ul>
<p>I&rsquo;m using a MacBook Pro M1 and have Docker installed on my machine, so all of these requirements are met. If you have Linux or Windows, you can also install it, but you need to download the appropriate installer.</p>
<p>This article introduces my environment as an example.</p>
<p>For MacOS, you can install it in two ways.</p>
<p>One is the manual installation method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64
</span></span><span class="line"><span class="cl">sudo install minikube-darwin-amd64 /usr/local/bin/minikube
</span></span></code></pre></td></tr></table>
</div>
</div><p>If for some reason you don&rsquo;t have a way to download this file, you can also go to the github site and download <a href="https://github.com/kubernetes/minikube/releases/tag/v1.25.2">the binary</a> into <code>/usr/local/bin/minikube</code>.</p>
<p>The second way is to use the brew command to install it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install minikube
</span></span><span class="line"><span class="cl">// See where minikube is installed
</span></span><span class="line"><span class="cl">➜  ~ which minikube
</span></span><span class="line"><span class="cl">/usr/local/bin/minikube
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="start">Start</h2>
<p>The next step is to start minikube.</p>
<p>Execute the following command to start it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">minikube start
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first time you start, you need to download various mirrors that k8s depends on (in China, some mirrors may fail to pull down and install because of GFW).</p>
<p>I use the method of pulling mirrors from Ali cloud, and then re-tagging to the corresponding k8s dependent mirrors, such as</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.3 k8s.gcr.io/kube-proxy:v1.22.3
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.3 k8s.gcr.io/kube-scheduler:v1.22.3
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner:v5
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/storage-provisioner:v5 gcr.io/k8s-minikube/storage-provisioner:v5
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.3 k8s.gcr.io/kube-apiserver:v1.22.3
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0  k8s.gcr.io/etcd:3.5.0-0
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.3 k8s.gcr.io/kube-controller-manager:v1.22.3
</span></span><span class="line"><span class="cl">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5
</span></span><span class="line"><span class="cl">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5  k8s.gcr.io/pause:3.5
</span></span></code></pre></td></tr></table>
</div>
</div><p>After manually pulling these images locally and running <code>minikube start</code>, it started successfully.</p>
<p>I also saw another way to start on the internet:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">minikube start --image-mirror-country<span class="o">=</span><span class="s1">&#39;cn&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I think this is a much simpler way, but I have already installed it, so I have not tried this way, you can try it.</p>
<p>The minikube command provides a very large number of configuration parameters, such as</p>
<ul>
<li><code>--driver</code>: Starting with version 1.5.0, Minikube by default uses the system-preferred driver to create a Kubernetes local environment, e.g. if you already have a Docker environment installed, minikube will use the docker driver.</li>
<li><code>-cpus=2</code>: Allocate CPU cores to the minikube virtual machine.</li>
<li><code>--memory=4096mb</code>: the number of memory allocated for the minikube virtual machine.</li>
<li><code>--kubernetes-version=</code>: The version of kubernetes that the minikube virtual machine will use.</li>
</ul>
<p>Now, you can open the Kubernetes console: <code>minikube dashboard</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/04/9da2d276a884492f84258439d80ef67c.png" alt="minikube dashboard"></p>
<p>Now, a local test k8s cluster is set up.</p>
<p>If you don&rsquo;t use it for a while, you can call <code>minikube stop</code> to pause it and start it again when you need it.</p>
<h2 id="plugins">Plugins</h2>
<p>You can now quickly create, update and delete Kubernetes objects directly using the <code>kubectl</code> command. You are now free to learn and test k8s technologies in your own cluster.</p>
<p>minikube also provides many plugins, such as istio, ingress, helm-tiller, and more. As you master k8s, you can gradually install and test these extensions.</p>
<p>The list of plugins is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ minikube addons list
</span></span><span class="line"><span class="cl"><span class="p">|</span>-----------------------------<span class="p">|</span>----------<span class="p">|</span>--------------<span class="p">|</span>-----------------------<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>         ADDON NAME          <span class="p">|</span> PROFILE  <span class="p">|</span>    STATUS    <span class="p">|</span>      MAINTAINER       <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-----------------------------<span class="p">|</span>----------<span class="p">|</span>--------------<span class="p">|</span>-----------------------<span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ambassador                  <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> auto-pause                  <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> csi-hostpath-driver         <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> kubernetes            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> dashboard                   <span class="p">|</span> minikube <span class="p">|</span> enabled ✅   <span class="p">|</span> kubernetes            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> default-storageclass        <span class="p">|</span> minikube <span class="p">|</span> enabled ✅   <span class="p">|</span> kubernetes            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> efk                         <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> freshpod                    <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> gcp-auth                    <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> gvisor                      <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> helm-tiller                 <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ingress                     <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ingress-dns                 <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> istio                       <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> istio-provisioner           <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> kubevirt                    <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> logviewer                   <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> metallb                     <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> metrics-server              <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> kubernetes            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> nvidia-driver-installer     <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> nvidia-gpu-device-plugin    <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> olm                         <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> pod-security-policy         <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> portainer                   <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> portainer.io          <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> registry                    <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> google                <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> registry-aliases            <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> registry-creds              <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> storage-provisioner         <span class="p">|</span> minikube <span class="p">|</span> enabled ✅   <span class="p">|</span> kubernetes            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> storage-provisioner-gluster <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> unknown <span class="o">(</span>third-party<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> volumesnapshots             <span class="p">|</span> minikube <span class="p">|</span> disabled     <span class="p">|</span> kubernetes            <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>-----------------------------<span class="p">|</span>----------<span class="p">|</span>--------------<span class="p">|</span>-----------------------<span class="p">|</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Enabling a plugin can be done with the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ minikube addons <span class="nb">enable</span> ingress
</span></span><span class="line"><span class="cl">💡  After the addon is enabled, please run <span class="s2">&#34;minikube tunnel&#34;</span> and your ingress resources would be available at <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl">    ▪ Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</span></span><span class="line"><span class="cl">    ▪ Using image k8s.gcr.io/ingress-nginx/controller:v1.0.4
</span></span><span class="line"><span class="cl">    ▪ Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
</span></span><span class="line"><span class="cl">🔎  Verifying ingress addon...
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="k8s-cluster">k8s cluster</h2>
<p>Now that we have built a k8s cluster, we might as well use it to deploy applications and services.</p>
<p>Let&rsquo;s take the rpcx microservices framework for a hello world application as an example.</p>
<h3 id="deploying-an-rpcx-server-side-application">Deploying an rpcx server-side application</h3>
<p>The rpcx server-side application is simple:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">example</span> <span class="s">&#34;github.com/rpcxio/rpcx-examples&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/rpcx/server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;:8972&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Arith</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// the second parameter is not a pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Arith</span><span class="p">)</span> <span class="nf">Mul</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">args</span> <span class="nx">example</span><span class="p">.</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">example</span><span class="p">.</span><span class="nx">Reply</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">C</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">*</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;C=&#34;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// s.Register(new(Arith), &#34;&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nf">RegisterName</span><span class="p">(</span><span class="s">&#34;Arith&#34;</span><span class="p">,</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Arith</span><span class="p">),</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Write a Docker file, compile it and generate the image:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> golang:1.18-alpine as builder</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /usr/src/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> sed -i <span class="s1">&#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39;</span> /etc/apk/repositories <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  apk add --no-cache ca-certificates tzdata<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./go.mod ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./go.sum ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> go build -ldflags <span class="s2">&#34;-s -w&#34;</span> -o rpcx_server <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> scratch as runner</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /usr/share/zoneinfo/Asia/Shanghai /etc/localtime<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /usr/src/app/rpcx_server /opt/app/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 8972</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/opt/app/rpcx_server&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Generate the image (I also pushed it to the docker platform):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker build . -t smallnest/rpcx-server-demo:0.1.0
</span></span><span class="line"><span class="cl">docker push smallnest/rpcx-server-demo:0.1.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next step is to write the deployment file, using our image, with a copy number of 3:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">smallnest/rpcx-server-demo:0.1.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8972</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Next, we define the service and expose our microservice as a service of k8s:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo-service   </span><span class="w"> </span><span class="c">#Name of Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">       </span><span class="c">#Service&#39;s own tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo  </span><span class="w"> </span><span class="c">#Set the tag for the Service with key app and value rpcx-server-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">   </span><span class="c">#This is the definition of the Service, which describes how the Service selects Pods and how they are accessed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c">#Tag selector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo</span><span class="w"> </span><span class="c">#Select the Pod that contains the tag app:rpcx-server-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-server-demo-port</span><span class="w"> </span><span class="c">#Name of the port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP   </span><span class="w"> </span><span class="c">#Protocol type TCP/UDP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9981</span><span class="w">        </span><span class="c">#Other container groups in the cluster can access the Service on port 9981</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8972</span><span class="w"> </span><span class="c">#Forward the request to port 8972 of the matching Pod</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, execute the following command to publish the application and services:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f rpcx-server-demo.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f rpcx-server-demo-service.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can view the published applications and services:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ kubectl get pods
</span></span><span class="line"><span class="cl">NAME                                           READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="cl">rpcx-server-demo-deployment-7f9d85c5dc-42wbm   1/1     Running   <span class="m">1</span> <span class="o">(</span>102d ago<span class="o">)</span>   103d
</span></span><span class="line"><span class="cl">rpcx-server-demo-deployment-7f9d85c5dc-499gm   1/1     Running   <span class="m">1</span> <span class="o">(</span>102d ago<span class="o">)</span>   103d
</span></span><span class="line"><span class="cl">rpcx-server-demo-deployment-7f9d85c5dc-s6gh9   1/1     Running   <span class="m">1</span> <span class="o">(</span>25h ago<span class="o">)</span>    103d
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ kubectl get svc
</span></span><span class="line"><span class="cl">NAME                       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="cl">kubernetes                 ClusterIP   10.96.0.1     &lt;none&gt;        443/TCP    114d
</span></span><span class="line"><span class="cl">rpcx-server-demo-service   ClusterIP   10.98.134.3   &lt;none&gt;        9981/TCP   103d
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="deploying-the-rpcx-client-application">Deploying the rpcx client application</h3>
<p>Similarly, we deploy the rpcx client application, which will call the rpcx service we just deployed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/rpcx/protocol&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">example</span> <span class="s">&#34;github.com/rpcxio/rpcx-examples&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/rpcx/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;RPCX_SERVER_DEMO_SERVICE_PORT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">TrimPrefix</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="s">&#34;tcp://&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;dial &#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewPeer2PeerDiscovery</span><span class="p">(</span><span class="s">&#34;tcp@&#34;</span><span class="o">+</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">DefaultOption</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">.</span><span class="nx">SerializeType</span> <span class="p">=</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">JSON</span>
</span></span><span class="line"><span class="cl">    <span class="nx">xclient</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewXClient</span><span class="p">(</span><span class="s">&#34;Arith&#34;</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Failtry</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">RandomSelect</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">xclient</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span> <span class="o">:=</span> <span class="nx">example</span><span class="p">.</span><span class="nx">Args</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">A</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">B</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">reply</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">example</span><span class="p">.</span><span class="nx">Reply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">xclient</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;Mul&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to call: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d * %d = %d&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Write a Dockerfile file to generate the image:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> golang:1.18-alpine as builder</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /usr/src/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> sed -i <span class="s1">&#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39;</span> /etc/apk/repositories <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  apk add --no-cache ca-certificates tzdata<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./go.mod ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> ./go.sum ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> go mod download<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> go build -ldflags <span class="s2">&#34;-s -w&#34;</span> -o rpcx_client <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> busybox as runner</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /usr/share/zoneinfo/Asia/Shanghai /etc/localtime<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /usr/src/app/rpcx_client /opt/app/<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;/opt/app/rpcx_client&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Compile the generated image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker build . -t smallnest/rpcx-client-demo:0.1.0
</span></span><span class="line"><span class="cl">docker push smallnest/rpcx-client-demo:0.1.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Write yaml files:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-client-demo-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-client-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-client-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rpcx-client-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">smallnest/rpcx-client-demo:0.1.0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, release.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f rpcx-client-demo.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check if the client has published successfully:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ kubectl get pods
</span></span><span class="line"><span class="cl">NAME                                           READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="cl">rpcx-client-demo-deployment-699bfb8799-wdsww   1/1     Running   <span class="m">1</span> <span class="o">(</span>25h ago<span class="o">)</span>    103d
</span></span><span class="line"><span class="cl">rpcx-server-demo-deployment-7f9d85c5dc-42wbm   1/1     Running   <span class="m">1</span> <span class="o">(</span>102d ago<span class="o">)</span>   103d
</span></span><span class="line"><span class="cl">rpcx-server-demo-deployment-7f9d85c5dc-499gm   1/1     Running   <span class="m">1</span> <span class="o">(</span>102d ago<span class="o">)</span>   103d
</span></span><span class="line"><span class="cl">rpcx-server-demo-deployment-7f9d85c5dc-s6gh9   1/1     Running   <span class="m">1</span> <span class="o">(</span>25h ago<span class="o">)</span>    103d
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since our copy number is 1, there is only one node here.</p>
<p>Checking the output of the client, you can see that it has called the service successfully:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ kubectl logs rpcx-client-demo-deployment-699bfb8799-wdsww <span class="p">|</span>more
</span></span><span class="line"><span class="cl">dial  10.98.134.3:9981
</span></span><span class="line"><span class="cl">2022/06/02 15:45:17 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:18 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:19 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:20 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:21 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:22 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:23 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span><span class="line"><span class="cl">2022/06/02 15:45:24 <span class="m">10</span> * <span class="nv">20</span> <span class="o">=</span> <span class="m">200</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-mod-private/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go Modules How to Use Private GIT Repository?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/cloki/">
            <span class="next-text nav-default">A Loki built on top of ClickHouse - cLoki</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
