<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How to use Docker on Mac - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Docker on MacOS." /><meta name="keywords" content="docker, MacOS, Colima, Lima" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/docker-macos/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How to use Docker on Mac" />
<meta property="og:description" content="Learn how to use Docker on MacOS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/docker-macos/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-08T19:53:48+08:00" />
<meta property="article:modified_time" content="2022-06-08T19:53:48+08:00" />

<meta itemprop="name" content="How to use Docker on Mac">
<meta itemprop="description" content="Learn how to use Docker on MacOS."><meta itemprop="datePublished" content="2022-06-08T19:53:48+08:00" />
<meta itemprop="dateModified" content="2022-06-08T19:53:48+08:00" />
<meta itemprop="wordCount" content="2090">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to use Docker on Mac"/>
<meta name="twitter:description" content="Learn how to use Docker on MacOS."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How to use Docker on Mac</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-08 19:53:48 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2090 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-objectives">1. Objectives</a></li>
        <li><a href="#2-the-choice-of-tools">2. the choice of tools</a></li>
        <li><a href="#3-virtual-machine-solution">3. Virtual Machine Solution</a></li>
        <li><a href="#4-colima-solution">4. Colima solution</a></li>
        <li><a href="#5-lima-solution">5. Lima Solution</a>
          <ul>
            <li><a href="#51-lima-installation">5.1. Lima installation</a></li>
            <li><a href="#52-using-lima">5.2. Using Lima</a></li>
            <li><a href="#53-lima-configuration-file">5.3. Lima configuration file</a></li>
            <li><a href="#54-starting-a-vm">5.4. Starting a VM</a></li>
            <li><a href="#55-virtual-machine-tuning">5.5. Virtual machine tuning</a></li>
            <li><a href="#56-multi-platform-compatibility">5.6. Multi-platform compatibility</a></li>
          </ul>
        </li>
        <li><a href="#6-summary">6. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-objectives">1. Objectives</h2>
<p>The core goal of this article:</p>
<ul>
<li>Use the full docker cli command on a Mac, including support for basic <code>-v</code> mounts.</li>
<li>Support for x86 emulation, with the ability to build or run images for x86.</li>
<li>CPU architecture switching where possible, preferably for both arm64 and x86.</li>
</ul>
<h2 id="2-the-choice-of-tools">2. the choice of tools</h2>
<p>First of all, we are most familiar with Docker Desktop, the installation package is huge and the UI is very laggy. Not to mention the startup speed and the occasional jam, so Docker Desktop is not considered at all; so the remaining options are as follows.</p>
<ul>
<li>VM solution</li>
<li>Colima solution</li>
<li>Lima solution</li>
</ul>
<p><strong>Let&rsquo;s start with the conclusion: Lima YES! VM solution is expensive and unpleasant, Colima is temporary and unstable. See Section 5 directly for the Lima solution</strong>.</p>
<h2 id="3-virtual-machine-solution">3. Virtual Machine Solution</h2>
<p>Currently, the only available or usable virtual machine on M1 is Parallels Desktop, while others like VBox and VMware are still immature; if pure qemu is a bit too hardcore (if you want to package your own scripts, forget it); for Parallels Desktop, we need to buy the development version of the license , because we need to use <code>prlctl</code> to achieve some automation, several hundred a year&hellip; After testing this solution is also somewhat feasible:</p>
<ol>
<li>first create a virtual machine like Ubuntu through PD</li>
<li>install Docker in the virtual machine</li>
<li>start the virtual machine through cli program, and mount <code>~</code> rw to the virtual machine</li>
</ol>
<p>Based on this solution I personally tried, I wrote a small tool <a href="https://github.com/mritd/pd/blob/010101042308ecbad805cffebb93973b55db4ff2/helper/prlctl_wrapper.go#L332">PD</a> to help with the mounting action. tool to assist in the mounting process. However, this tool has some obvious drawbacks:</p>
<ul>
<li>x86 emulation is not currently supported, which can be mitigated by binfmt, but is not perfect</li>
<li>Virtual machines cost money and require virtual machine cli support</li>
</ul>
<h2 id="4-colima-solution">4. Colima solution</h2>
<p>Colima is claimed to be a solution for Mac platform containerized toolchain, but actual testing found that Colima is not stable, sometimes there may be some small problems; of course, the biggest problem of Colima is: <strong>customizable degree is not high, the underlying layer is based on Lima.</strong> Colima specific use and so on here is not described in detail, is not stable Not really recommended.</p>
<h2 id="5-lima-solution">5. Lima Solution</h2>
<p>Lima is currently an automated VM solution based on QEMU, and thanks to its excellent design, Cloud Init can help us to complete the hook at many stages; so it is easy to install Docker or k8s, or get something else; and many solutions such as docker have official samples, so we can copy them directly and use them.</p>
<h3 id="51-lima-installation">5.1. Lima installation</h3>
<p>Lima is relatively easy to install on Mac, the following command will install the master branch version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install lima --HEAD
</span></span></code></pre></td></tr></table>
</div>
</div><p>Under normal circumstances, the installation of Lima comes with the installation of QEMU, if QEMU is already installed locally, you may need to execute the following command <strong>Upgrade QEMU to 7.0</strong> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew upgrade qemu
</span></span></code></pre></td></tr></table>
</div>
</div><p>In order to use docker, you also need to install the docker cli via brew:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">brew install docker
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-using-lima">5.2. Using Lima</h3>
<p>By default, Lima generates a <code>lima</code> shortcut command after installation, but it is not recommended to use it, because it looks convenient but there is no control over too many parameters, <strong>so it is still recommended to use the standard <code>limactl</code> command to operate.</strong> limactl is used in the following way:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Lima: Linux virtual machines
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl">  limactl <span class="o">[</span>command<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Examples:
</span></span><span class="line"><span class="cl">  Start the default instance:
</span></span><span class="line"><span class="cl">  $ limactl start
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Open a shell:
</span></span><span class="line"><span class="cl">  $ lima
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Run a container:
</span></span><span class="line"><span class="cl">  $ lima nerdctl run -d --name nginx -p 8080:80 nginx:alpine
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Stop the default instance:
</span></span><span class="line"><span class="cl">  $ limactl stop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  See also example YAMLs: /opt/homebrew/share/doc/lima/examples
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Available Commands:
</span></span><span class="line"><span class="cl">  completion    Generate the autocompletion script <span class="k">for</span> the specified shell
</span></span><span class="line"><span class="cl">  copy          Copy files between host and guest
</span></span><span class="line"><span class="cl">  delete        Delete an instance of Lima.
</span></span><span class="line"><span class="cl">  edit          Edit an instance of Lima
</span></span><span class="line"><span class="cl">  factory-reset Factory reset an instance of Lima
</span></span><span class="line"><span class="cl">  <span class="nb">help</span>          Help about any <span class="nb">command</span>
</span></span><span class="line"><span class="cl">  info          Show diagnostic information
</span></span><span class="line"><span class="cl">  list          List instances of Lima.
</span></span><span class="line"><span class="cl">  prune         Prune garbage objects
</span></span><span class="line"><span class="cl">  shell         Execute shell in Lima
</span></span><span class="line"><span class="cl">  show-ssh      Show the ssh <span class="nb">command</span> line
</span></span><span class="line"><span class="cl">  start         Start an instance of Lima
</span></span><span class="line"><span class="cl">  stop          Stop an instance
</span></span><span class="line"><span class="cl">  sudoers       Generate /etc/sudoers.d/lima file <span class="k">for</span> enabling vmnet.framework support
</span></span><span class="line"><span class="cl">  validate      Validate YAML files
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Flags:
</span></span><span class="line"><span class="cl">      --debug     debug mode
</span></span><span class="line"><span class="cl">  -h, --help      <span class="nb">help</span> <span class="k">for</span> limactl
</span></span><span class="line"><span class="cl">  -v, --version   version <span class="k">for</span> limactl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Use <span class="s2">&#34;limactl [command] --help&#34;</span> <span class="k">for</span> more information about a command.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-lima-configuration-file">5.3. Lima configuration file</h3>
<p>Lima determines how to create a virtual machine by reading a yaml configuration description file, which has the following basic structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 定义每个平台架构需要使用的启动镜像</span>
</span></span><span class="line"><span class="cl">images:
</span></span><span class="line"><span class="cl">- location: <span class="s2">&#34;https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img&#34;</span>
</span></span><span class="line"><span class="cl">  arch: <span class="s2">&#34;x86_64&#34;</span>
</span></span><span class="line"><span class="cl">- location: <span class="s2">&#34;https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img&#34;</span>
</span></span><span class="line"><span class="cl">  arch: <span class="s2">&#34;aarch64&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义虚拟机需要使用哪个架构启动(对应上面的镜像)</span>
</span></span><span class="line"><span class="cl">arch: <span class="s2">&#34;x86_64&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CPU 数量</span>
</span></span><span class="line"><span class="cl">cpus: <span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 内存大小</span>
</span></span><span class="line"><span class="cl">memory: <span class="s2">&#34;16G&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 磁盘大小</span>
</span></span><span class="line"><span class="cl">disk: <span class="s2">&#34;100G&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 虚拟机与 macOS 宿主机挂载时使用的挂载技术</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 目前推荐 9p, 可换成 sshfs, 但是 sshfs 会有权限问题</span>
</span></span><span class="line"><span class="cl">mountType: 9p
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义虚拟机和 macOS 宿主机有哪些目录可以共享</span>
</span></span><span class="line"><span class="cl">mounts:
</span></span><span class="line"><span class="cl">- location: <span class="s2">&#34;~&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 定义虚拟机对这个目录是否可写</span>
</span></span><span class="line"><span class="cl">  writable: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  9p:
</span></span><span class="line"><span class="cl">    <span class="c1"># 对于可写的共享目录, cache 推荐类型为 mmap, 不写好像默认 fscache</span>
</span></span><span class="line"><span class="cl">    cache: <span class="s2">&#34;mmap&#34;</span>
</span></span><span class="line"><span class="cl">- location: <span class="s2">&#34;/tmp/lima&#34;</span>
</span></span><span class="line"><span class="cl">  writable: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  9p:
</span></span><span class="line"><span class="cl">    cache: <span class="s2">&#34;mmap&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># containerd is managed by Docker, not by Lima, so the values are set to false here.</span>
</span></span><span class="line"><span class="cl">containerd:
</span></span><span class="line"><span class="cl">  system: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  user: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cloud-init hook</span>
</span></span><span class="line"><span class="cl">provision:
</span></span><span class="line"><span class="cl"><span class="c1"># Define what permissions to execute scripts within the virtual machine</span>
</span></span><span class="line"><span class="cl">- mode: system
</span></span><span class="line"><span class="cl">  <span class="c1"># This script defines the host.docker.internal hostname when hostResolver is disabled.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># It is also needed for lima 0.8.2 and earlier, which does not support hostResolver.hosts.</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Names defined in /etc/hosts inside the VM are not resolved inside containers when</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># using the hostResolver; use hostResolver.hosts instead (requires lima 0.8.3 or later).</span>
</span></span><span class="line"><span class="cl">  script: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#!/bin/sh</span>
</span></span><span class="line"><span class="cl">    sed -i <span class="s1">&#39;s/host.lima.internal.*/host.lima.internal host.docker.internal/&#39;</span> /etc/hosts
</span></span><span class="line"><span class="cl">- mode: system
</span></span><span class="line"><span class="cl">  script: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#!/bin/bash</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> -eux -o pipefail
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">command</span> -v docker &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      docker run --platform<span class="o">=</span>linux/amd64 --privileged --rm tonistiigi/binfmt --install all
</span></span><span class="line"><span class="cl">      <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nb">export</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
</span></span><span class="line"><span class="cl">      curl -fsSL https://get.docker.com <span class="p">|</span> sh
</span></span><span class="line"><span class="cl">      docker run --platform<span class="o">=</span>linux/amd64 --privileged --rm tonistiigi/binfmt --install all
</span></span><span class="line"><span class="cl">      <span class="c1"># NOTE: you may remove the lines below, if you prefer to use rootful docker, not rootless</span>
</span></span><span class="line"><span class="cl">      systemctl disable --now docker
</span></span><span class="line"><span class="cl">      apt-get install -y uidmap dbus-user-session
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">- mode: user
</span></span><span class="line"><span class="cl">  script: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#!/bin/bash</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> -eux -o pipefail
</span></span><span class="line"><span class="cl">    systemctl --user start dbus
</span></span><span class="line"><span class="cl">    dockerd-rootless-setuptool.sh install
</span></span><span class="line"><span class="cl">    docker context use rootless
</span></span><span class="line"><span class="cl">probes:
</span></span><span class="line"><span class="cl">- script: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#!/bin/bash</span>
</span></span><span class="line"><span class="cl">    <span class="nb">set</span> -eux -o pipefail
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! timeout 30s bash -c <span class="s2">&#34;until command -v docker &gt;/dev/null 2&gt;&amp;1; do sleep 3; done&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="s2">&#34;docker is not installed yet&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! timeout 30s bash -c <span class="s2">&#34;until pgrep rootlesskit; do sleep 3; done&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="s2">&#34;rootlesskit (used by rootless docker) is not running&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  hint: See <span class="s2">&#34;/var/log/cloud-init-output.log&#34;</span>. in the guest
</span></span><span class="line"><span class="cl">hostResolver:
</span></span><span class="line"><span class="cl">  <span class="c1"># hostResolver.hosts requires lima 0.8.3 or later. Names defined here will also</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># resolve inside containers, and not just inside the VM itself.</span>
</span></span><span class="line"><span class="cl">  hosts:
</span></span><span class="line"><span class="cl">    host.docker.internal: host.lima.internal
</span></span><span class="line"><span class="cl">portForwards:
</span></span><span class="line"><span class="cl">- guestSocket: <span class="s2">&#34;/run/user/{{.UID}}/docker.sock&#34;</span>
</span></span><span class="line"><span class="cl">  hostSocket: <span class="s2">&#34;{{.Dir}}/sock/docker.sock&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Self-defined post-launch message output</span>
</span></span><span class="line"><span class="cl">message: <span class="p">|</span>
</span></span><span class="line"><span class="cl">  To run <span class="sb">`</span>docker<span class="sb">`</span> on the host <span class="o">(</span>assumes docker-cli is installed<span class="o">)</span>, run the following commands:
</span></span><span class="line"><span class="cl">  ------
</span></span><span class="line"><span class="cl">  docker context create amd64 --docker <span class="s2">&#34;host=unix://{{.Dir}}/sock/docker.sock&#34;</span>
</span></span><span class="line"><span class="cl">  docker context use amd64
</span></span><span class="line"><span class="cl">  ------
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="54-starting-a-vm">5.4. Starting a VM</h3>
<p>The limactl command provides a <code>start</code> subcommand to start a VM, which takes a single argument, the form of which varies depending on the behavior:</p>
<ul>
<li>If the argument is a file path, the file is assumed to be the yaml configuration of a lima virtual machine, which is read and started.</li>
<li>If the argument is a simple string, it first tries to find a virtual machine with the same name among the existing ones, and starts it immediately if it finds one.</li>
<li>If the argument is a simple string and no existing VM with the same name is found, then try to create a new VM using the built-in templates.</li>
</ul>
<p>Using the docker configuration file I defined above as an example, we can create a docker virtual machine by starting this configuration directly:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">limactl start ./docker-amd64.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>After startup, you will be prompted whether to edit and then start again. This is to use the same configuration to start multiple vm&rsquo;s, so just start them without editing.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/08/2f80654438274b119296c424235b67bd.png" alt="limactl"></p>
<p>After a few moments the virtual machine will start successfully:</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/08/312afa0259e5486aba096973469c972e.png" alt="virtual machine start successfully"></p>
<p>After booting, <strong>execute the two commands printed at the bottom to use <code>docker</code> on the host machine.</strong> This essentially uses the docker context feature, and then mounts the sock file from the virtual machine to the host, and configures the docker context for seamless use of docker commands.</p>
<h3 id="55-virtual-machine-tuning">5.5. Virtual machine tuning</h3>
<p>In some cases, we need to customize the configuration of the VM, mainly by adjusting the <code>provision</code> section of the configuration file; in this section, if <code>mode</code> is defined as <code>system</code>, the command will be executed as root user, otherwise it will be executed as normal user. <strong>It is important to note that the scripts we define need to be idempotent, because they will be executed once each time, so generally we need to write the logic for the commands that may cause data erasure actions, to avoid repeated execution.</strong></p>
<p>For file mounting, we recommend using <code>9p</code> type, future lima will switch to this mount mode completely; also after testing <strong>currently only <code>9p</code> mount mode, local directory rw will not have permission problem when mapping to virtual machine, sshfs mount mode will cause permission error if encountering <code>chown</code> or other commands, which may lead to container boot failure (e.g. mysql).</strong></p>
<p>During test VM configuration, you can use <code>limactl delete -f xxxx</code> to force delete the target VM, and then restart it; <strong>The VM name is the same as the yaml file name by default, you can use <code>limactl ls</code> command to check it.</strong></p>
<h3 id="56-multi-platform-compatibility">5.6. Multi-platform compatibility</h3>
<p>In my docker configuration example above, binfmt is automatically installed every time the virtual machine finishes booting:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run --platform<span class="o">=</span>linux/amd64 --privileged --rm tonistiigi/binfmt --install all
</span></span></code></pre></td></tr></table>
</div>
</div><p>This ensures that docker images from other platforms can be run regardless of the original architecture of the Lima VM; typically, some openjdk8 images are only available in amd64, but can still be used if the lima VM is aarch64.</p>
<p>In addition to this &ldquo;faster&rdquo; cross-architecture approach, lima also supports defining the architecture directly in the VM, so that the target architecture is emulated directly from the VM system level when qemu is booted; <strong>this approach has the advantage of being very compatible with the target architecture, but it will run more slowly.</strong> Adjusting the VM architecture is a simple matter of modifying the <code>arch</code> configuration (note that the image of the target architecture must be configured):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># Define the boot images that need to be used for each platform architecture</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">images</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">arch</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;x86_64&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">arch</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;aarch64&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Define which architecture this VM needs to be started with (corresponding to the image of the target architecture above will be used)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">arch</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;aarch64&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-summary">6. Summary</h2>
<p>Overall, Docker Desktop is basically hard to use on mac, Colima is not too mature yet, suitable for light docker users; but heavy docker users with customization needs still recommend Lima virtual machine; Lima also supports many operating systems, there are a lot of official <a href="https://github.com/lima-vm/lima/tree/master/examples">sample templates</a> (including k8s, k3s, podman, etc.), which is very suitable for heavy container users.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/docker-iptables/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Docker and iptables</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/go-heap/">
            <span class="next-text nav-default">The heap in the container package of golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
