<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>unexpected error getting claim reference: selfLink was empty, can&#39;t make reference - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to resolve K8S exceptions: selfLink was empty, can&#39;t make reference" /><meta name="keywords" content="Kubernetes" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/k8s-error/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="unexpected error getting claim reference: selfLink was empty, can&#39;t make reference" />
<meta property="og:description" content="Learn how to resolve K8S exceptions: selfLink was empty, can&#39;t make reference" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/k8s-error/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-21T09:39:30+08:00" />
<meta property="article:modified_time" content="2022-06-21T09:39:30+08:00" />

<meta itemprop="name" content="unexpected error getting claim reference: selfLink was empty, can&#39;t make reference">
<meta itemprop="description" content="Learn how to resolve K8S exceptions: selfLink was empty, can&#39;t make reference"><meta itemprop="datePublished" content="2022-06-21T09:39:30+08:00" />
<meta itemprop="dateModified" content="2022-06-21T09:39:30+08:00" />
<meta itemprop="wordCount" content="275">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="unexpected error getting claim reference: selfLink was empty, can&#39;t make reference"/>
<meta name="twitter:description" content="Learn how to resolve K8S exceptions: selfLink was empty, can&#39;t make reference"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">unexpected error getting claim reference: selfLink was empty, can&#39;t make reference</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-21 09:39:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 275 words </span>
          <span class="more-meta"> 2 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#solution">Solution</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The error log is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">I0620 07:19:39.552037       1 leaderelection.go:185] attempting to acquire leader lease  cephfs/ceph.com-cephfs...
</span></span><span class="line"><span class="cl">E0620 07:19:39.610071       1 event.go:259] Could not construct reference to: &#39;&amp;v1.Endpoints{TypeMeta:v1.TypeMeta{Kind:&#34;&#34;, APIVersion:&#34;&#34;}, ObjectMeta:v1.ObjectMeta{Name:&#34;ceph.com-cephfs&#34;, GenerateName:&#34;&#34;, Namespace:&#34;cephfs&#34;, SelfLink:&#34;&#34;, UID:&#34;4f4ead7b-c097-4074-b56c-76c6888ceed7&#34;, ResourceVersion:&#34;209907&#34;, Generation:0, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:63791306379, loc:(*time.Location)(0x19b4b00)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string{&#34;control-plane.alpha.kubernetes.io/leader&#34;:&#34;{\&#34;holderIdentity\&#34;:\&#34;cephfs-provisioner-688cc75-xgd5g_58e8a7a6-f069-11ec-aba4-c627c8b0022e\&#34;,\&#34;leaseDurationSeconds\&#34;:15,\&#34;acquireTime\&#34;:\&#34;2022-06-20T07:19:39Z\&#34;,\&#34;renewTime\&#34;:\&#34;2022-06-20T07:19:39Z\&#34;,\&#34;leaderTransitions\&#34;:0}&#34;}, OwnerReferences:[]v1.OwnerReference(nil), Initializers:(*v1.Initializers)(nil), Finalizers:[]string(nil), ClusterName:&#34;&#34;}, Subsets:[]v1.EndpointSubset(nil)}&#39; due to: &#39;selfLink was empty, can&#39;t make reference&#39;. Will not report event: &#39;Normal&#39; &#39;LeaderElection&#39; &#39;cephfs-provisioner-688cc75-xgd5g_58e8a7a6-f069-11ec-aba4-c627c8b0022e became leader&#39;
</span></span><span class="line"><span class="cl">I0620 07:19:39.610143       1 leaderelection.go:194] successfully acquired lease cephfs/ceph.com-cephfs
</span></span><span class="line"><span class="cl">I0620 07:19:39.610187       1 controller.go:631] Starting provisioner controller ceph.com/cephfs_cephfs-provisioner-688cc75-xgd5g_58e8a7a6-f069-11ec-aba4-c627c8b0022e!
</span></span><span class="line"><span class="cl">I0620 07:19:39.710456       1 controller.go:680] Started provisioner controller ceph.com/cephfs_cephfs-provisioner-688cc75-xgd5g_58e8a7a6-f069-11ec-aba4-c627c8b0022e!
</span></span><span class="line"><span class="cl">I0620 07:20:00.618780       1 controller.go:987] provision &#34;default/cephfs-abcdocker&#34; class &#34;cephfs&#34;: started
</span></span><span class="line"><span class="cl">E0620 07:20:00.624863       1 controller.go:1004] provision &#34;default/cephfs-abcdocker&#34; class &#34;cephfs&#34;: unexpected error getting claim reference: selfLink was empty, can&#39;t make reference
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we use ceph csi, the cephfs has been created and the storageclass has been created. The error prompted when pvc applies pvc via sc.</p>
<h2 id="solution">Solution</h2>
<p>Prior to Kubernetes 1.24, this could be solved by the following method. but from version 1.24.0, the following parameters are no longer available. The exact solution needs to be updated by ceph.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># The configuration file needs to be added to all apiserver nodes (master nodes)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-01 ~<span class="o">]</span><span class="c1"># vim /etc/kubernetes/manifests/kube-apiserver.yaml</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Add parameters</span>
</span></span><span class="line"><span class="cl">    - --feature-gates<span class="o">=</span><span class="nv">RemoveSelfLink</span><span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/21/7981665721964594bac4d35d51282c3d.png" alt="k8s"></p>
<blockquote>
<p>apiserver component is a static Pod, it will restart Apiserver automatically after changing the configuration file.</p>
</blockquote>
<p>After modifying all apiserver nodes, you need to check if the nodes have any abnormalities. It is recommended to modify them one by one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-01 ~<span class="o">]</span><span class="c1"># kubectl get pod -n kube-system |grep api</span>
</span></span><span class="line"><span class="cl">kube-apiserver-k8s-01            1/1     Running   <span class="m">0</span>             5m15s
</span></span><span class="line"><span class="cl">kube-apiserver-k8s-02            1/1     Running   <span class="m">0</span>             38s
</span></span><span class="line"><span class="cl">kube-apiserver-k8s-03            1/1     Running   <span class="m">0</span>             17s
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/multi-line-logs-with-regular/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to handle multi-line logs with regular expressions</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/track-network-traffic/">
            <span class="next-text nav-default">How to track network traffic</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
