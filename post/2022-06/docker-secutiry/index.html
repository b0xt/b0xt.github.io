<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The Docker service mapped to 127.0.0.1 can be accessed directly from outside the host - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="There is a security risk with Docker that exposing the port with the -p 127.0.0.1:80:80 parameter will still allow external access to the service." /><meta name="keywords" content="docker" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/docker-secutiry/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="The Docker service mapped to 127.0.0.1 can be accessed directly from outside the host" />
<meta property="og:description" content="There is a security risk with Docker that exposing the port with the -p 127.0.0.1:80:80 parameter will still allow external access to the service." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/docker-secutiry/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-25T13:13:05+08:00" />
<meta property="article:modified_time" content="2022-06-25T13:13:05+08:00" />

<meta itemprop="name" content="The Docker service mapped to 127.0.0.1 can be accessed directly from outside the host">
<meta itemprop="description" content="There is a security risk with Docker that exposing the port with the -p 127.0.0.1:80:80 parameter will still allow external access to the service."><meta itemprop="datePublished" content="2022-06-25T13:13:05+08:00" />
<meta itemprop="dateModified" content="2022-06-25T13:13:05+08:00" />
<meta itemprop="wordCount" content="619">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The Docker service mapped to 127.0.0.1 can be accessed directly from outside the host"/>
<meta name="twitter:description" content="There is a security risk with Docker that exposing the port with the -p 127.0.0.1:80:80 parameter will still allow external access to the service."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The Docker service mapped to 127.0.0.1 can be accessed directly from outside the host</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-25 13:13:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 619 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#proof-of-concept">Proof of Concept</a></li>
        <li><a href="#solution">Solution</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>One of the <a href="https://news.ycombinator.com/item?id=31839936">postings</a> on Hacker News that caught attention over the last couple of days was an email sent to the Docker security team that focused on a very outrageous security concern with Docker. <strong>Even if you expose the port to a loopback address with a parameter like <code>-p 127.0.0.1:80:80</code>, the service can still be accessed externally</strong>, what happened?</p>
<p>The reason for this is simple: Docker has added this Iptables rule.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">üê≥  ‚Üí iptables -nvL DOCKER
</span></span><span class="line"><span class="cl">Chain DOCKER <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target prot opt in       out     <span class="nb">source</span>    destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span> <span class="m">0</span>     ACCEPT tcp  --  !docker0 docker0 0.0.0.0/0 172.17.0.2  tcp dpt:80
</span></span></code></pre></td></tr></table>
</div>
</div><p>As long as an external attacker sends traffic through this host to <code>172.17.0.2:80</code>, it will match this rule and successfully access the services in the container; 127.0.0.1 doesn&rsquo;t do much good.</p>
<p>The embarrassing thing is that users who choose to map the port to 127.0.0.1 basically feel so secure that they no longer want to take further security measures. Now comes the question, mapping to 127.0.0.1 <strong>can&rsquo;t be said to be very secure, can it, only irrelevant to security</strong>.</p>
<h2 id="proof-of-concept">Proof of Concept</h2>
<p>Here is an example to verify it.</p>
<ol>
<li>
<p>Run a PostgreSQL container on machine A with port mapped to 127.0.0.1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># IP: 192.168.0.100</span>
</span></span><span class="line"><span class="cl">üê≥  ‚Üí docker run -e <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>password -p 127.0.0.1:5432:5432 postgres
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Machine B on the same LAN adds a routing table that directs all traffic accessing <code>172.16.0.0/12</code> to machine A.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># IP: 192.168.0.200</span>
</span></span><span class="line"><span class="cl">üê≥  ‚Üí ip route add 172.16.0.0/12 via 192.168.0.100
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Scan the port of machine A in machine B.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">üê≥  ‚Üí nmap -p5432 -Pn --open 172.16.0.0/12
</span></span><span class="line"><span class="cl">Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-11-05 15:00 CDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 172.17.0.2
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.00047s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT     STATE SERVICE
</span></span><span class="line"><span class="cl">5432/tcp open  postgresql
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Connect directly to PostgreSQL in machine B.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">üê≥  ‚Üí psql -h 172.17.0.2 -U postgres
</span></span><span class="line"><span class="cl">Password <span class="k">for</span> user postgres:
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="solution">Solution</h2>
<p>The fact that it&rsquo;s not just 127.0.0.1, but that you map the container port to any address on the host, accessible externally, is outrageous!</p>
<p>The author of the email proposed a solution to the Docker team to optimize Docker&rsquo;s iptables rules.</p>
<ol>
<li>
<p>First, strictly restrict the source addresses and network interfaces that are allowed to access the container ports</p>
<p>For example, the <strong>original</strong> iptables rule for <code>docker run -p 127.0.0.1:5432:5432</code> is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Chain DOCKER <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">pkts bytes target prot opt in       out     <span class="nb">source</span>    destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span> <span class="m">0</span>     ACCEPT tcp  --  !docker0 docker0 0.0.0.0/0 172.17.0.2  tcp dpt:5432
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <strong>improved</strong> iptables rules are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Chain DOCKER <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">pkts bytes target prot opt in out     <span class="nb">source</span>      destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span> <span class="m">0</span>     ACCEPT tcp  --  lo docker0 127.0.0.1/8 172.17.0.2 tcp dpt:5432
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similarly, if the address of the host is <code>192.168.0.100</code> and the mask is <code>24</code>, then the iptables rule for <code>docker run -p 192.168.0.100:5432:5432</code> should be as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Chain DOCKER <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">pkts bytes target prot opt in   out     <span class="nb">source</span>         destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span> <span class="m">0</span>     ACCEPT tcp  --  eth0 docker0 192.168.0.0/24 172.17.0.2 tcp dpt:5432
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Finally, the default behavior should be modified to map to 127.0.0.1 by default if no IP address is specified when using the <code>-p</code> parameter.</p>
</li>
</ol>
<p>Although there are many people in the comments section have given the option of adding iptables rules to restrict, but this is unrealistic, there are thousands of users around the world are using the <code>-p</code> parameter to map the container port to 127.0.0.1, the attacker probably found this vulnerability long ago, we can not expect users to add iptables rules to restrict external access, the most reliable The most reliable way is to wait for Docker official to fix this bug and then upgrade it.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-06/webassembly-introduction/">
            <span class="next-text nav-default">Advantages of WebAssembly and use scenarios</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
