<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deploying a production cluster using the Loki microservice model - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to deploy a production cluster using the Loki microservice pattern." /><meta name="keywords" content="Loki, Microservice" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/loki-microservice/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Deploying a production cluster using the Loki microservice model" />
<meta property="og:description" content="Learn how to deploy a production cluster using the Loki microservice pattern." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/loki-microservice/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-24T12:46:32+08:00" />
<meta property="article:modified_time" content="2022-06-24T12:46:32+08:00" />

<meta itemprop="name" content="Deploying a production cluster using the Loki microservice model">
<meta itemprop="description" content="Learn how to deploy a production cluster using the Loki microservice pattern."><meta itemprop="datePublished" content="2022-06-24T12:46:32+08:00" />
<meta itemprop="dateModified" content="2022-06-24T12:46:32+08:00" />
<meta itemprop="wordCount" content="2673">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploying a production cluster using the Loki microservice model"/>
<meta name="twitter:description" content="Learn how to deploy a production cluster using the Loki microservice pattern."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deploying a production cluster using the Loki microservice model</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-24 12:46:32 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2673 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#helm-chart">Helm Chart</a></li>
        <li><a href="#install-minio">Install minio</a></li>
        <li><a href="#installing-loki">Installing Loki</a></li>
        <li><a href="#install-promtail">Install Promtail</a></li>
        <li><a href="#installing-grafana">Installing Grafana</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/3db098d563ef47e8bbc16233b5734dbb.png" alt="Kubernetes"></p>
<p>We mentioned <a href="/post/2022-06/grafana-loki-rw/">earlier</a> the monolithic and read-write separation modes of Loki deployment, and when your daily log size exceeds terabytes, then we may need to use the microservice mode to deploy Loki.</p>
<p>The microservice deployment pattern instantiates Loki&rsquo;s components as distinct processes, each of which is invoked and assigned a target, and each of which generates a gRPC server for internal requests and an HTTP service for external API requests.</p>
<ul>
<li>ingester</li>
<li>distributor</li>
<li>query-frontend</li>
<li>query-scheduler</li>
<li>querier</li>
<li>index-gateway</li>
<li>ruler</li>
<li>compactor</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/026d5dcde84041a7bfba5d2fdd3d19e2.png" alt="microservice"></p>
<p>Running components as separate microservices allows scaling by increasing the number of microservices, and custom clusters have better observability of individual components. Microservice mode deployments are the most efficient Loki installations, however, they are also the most complex to set up and maintain.</p>
<blockquote>
<p>Microservice mode is recommended for very large Loki clusters or clusters that require more control over scaling and cluster operations.</p>
</blockquote>
<p>The microservices model is best suited for deployment in Kubernetes clusters and offers both Jsonnet and Helm Chart installations.</p>
<h2 id="helm-chart">Helm Chart</h2>
<p>Again, we will use Helm Chart to install Loki in microservice mode, but remember to remove the Loki-related services installed in the previous section before installing.</p>
<p>First get the Chart package for the microservice model.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span class="line"><span class="cl">$ helm pull grafana/loki-distributed --untar --version 0.48.4
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> loki-simple-scalable
</span></span></code></pre></td></tr></table>
</div>
</div><p>The Chart package supports the components shown in the table below. The Ingester, distributor, querier, and query-frontend components are always installed, and the other components are optional.</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Optional</th>
<th>Default on?</th>
</tr>
</thead>
<tbody>
<tr>
<td>gateway</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>ingester</td>
<td>❎</td>
<td>n/a</td>
</tr>
<tr>
<td>distributor</td>
<td>❎</td>
<td>n/a</td>
</tr>
<tr>
<td>querier</td>
<td>❎</td>
<td>n/a</td>
</tr>
<tr>
<td>query-frontend</td>
<td>❎</td>
<td>n/a</td>
</tr>
<tr>
<td>table-manager</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>compactor</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>ruler</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>index-gateway</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>memcached-chunks</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>memcached-frontend</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>memcached-index-queries</td>
<td>✅</td>
<td>❎</td>
</tr>
<tr>
<td>memcached-index-writes</td>
<td>✅</td>
<td>❎</td>
</tr>
</tbody>
</table>
<p>This Chart package configures Loki in microservice mode, has been tested and can be used with <code>boltdb-shipper</code> and <code>memberlist</code>, while other storage and discovery options are also available, however, the chart does not support setting up Consul or Etcd for discovery, they need to be configured separately, instead, you can use <code>memberlist</code> which does not require Instead, you can use <code>memberlist</code> that does not require a separate key/value store. By default the Chart package creates a Headless Service for the member list, of which the ingester, distributor, querier and ruler are part.</p>
<h2 id="install-minio">Install minio</h2>
<p>For example, we are using memberlist, boltdb-shipper and minio for storage here, and since this Chart package does not include minio, we need to install minio separately first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm repo add minio https://helm.min.io/
</span></span><span class="line"><span class="cl">$ helm pull minio/minio --untar --version 8.0.10
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> minio
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a values file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># ci/loki-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">accessKey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;myaccessKey&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">secretKey</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;mysecretKey&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;local-path&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">32000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Install minio directly using the values file configured above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install minio -n logging -f ci/loki-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;minio&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: minio
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sun Jun <span class="m">19</span> 16:56:28 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">Minio can be accessed via port <span class="m">9000</span> on the following DNS name from within your cluster:
</span></span><span class="line"><span class="cl">minio.logging.svc.cluster.local
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To access Minio from localhost, run the below commands:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  1. <span class="nb">export</span> <span class="nv">POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods --namespace logging -l <span class="s2">&#34;release=minio&#34;</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].metadata.name}&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  2. kubectl port-forward <span class="nv">$POD_NAME</span> <span class="m">9000</span> --namespace logging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Read more about port forwarding here: http://kubernetes.io/docs/user-guide/kubectl/kubectl_port-forward/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now access Minio server on http://localhost:9000. Follow the below steps to connect to Minio server with mc client:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  1. Download the Minio mc client - https://docs.minio.io/docs/minio-client-quickstart-guide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  2. Get the <span class="nv">ACCESS_KEY</span><span class="o">=</span><span class="k">$(</span>kubectl get secret minio -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.accesskey}&#34;</span> <span class="p">|</span> base64 --decode<span class="k">)</span> and the <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="k">$(</span>kubectl get secret minio -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.secretkey}&#34;</span> <span class="p">|</span> base64 --decode<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  3. mc <span class="nb">alias</span> <span class="nb">set</span> minio-local http://localhost:9000 <span class="s2">&#34;</span><span class="nv">$ACCESS_KEY</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$SECRET_KEY</span><span class="s2">&#34;</span> --api s3v4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  4. mc ls minio-local
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Alternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check the status of the corresponding Pod after the installation is complete.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n logging
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">minio-548656f786-gctk9   1/1     Running   <span class="m">0</span>          2m45s
</span></span><span class="line"><span class="cl">$ kubectl get svc -n logging
</span></span><span class="line"><span class="cl">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
</span></span><span class="line"><span class="cl">minio   NodePort   10.111.58.196   &lt;none&gt;        9000:32000/TCP   3h16m
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can access minio through the specified <code>32000</code> port.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/f773a39d90184d83808518dcdf4d20f4.png" alt="minio"></p>
<p>Then remember to create a bucket named <code>loki-data</code>.</p>
<h2 id="installing-loki">Installing Loki</h2>
<p>Now that we have our object store ready, let&rsquo;s install Loki in microservices mode by first creating a values file as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># ci/minio-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">loki</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">structuredConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ingester</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max_transfer_retries</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">chunk_idle_period</span><span class="p">:</span><span class="w"> </span><span class="l">1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">chunk_target_size</span><span class="p">:</span><span class="w"> </span><span class="m">1536000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max_chunk_age</span><span class="p">:</span><span class="w"> </span><span class="l">1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage_config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">aws</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="l">minio.logging.svc.cluster.local:9000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">insecure</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">bucketnames</span><span class="p">:</span><span class="w"> </span><span class="l">loki-data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">access_key_id</span><span class="p">:</span><span class="w"> </span><span class="l">myaccessKey</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secret_access_key</span><span class="p">:</span><span class="w"> </span><span class="l">mysecretKey</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">s3forcepathstyle</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">boltdb_shipper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">shared_store</span><span class="p">:</span><span class="w"> </span><span class="l">s3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">schema_config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">from</span><span class="p">:</span><span class="w"> </span><span class="ld">2022-06-21</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">store</span><span class="p">:</span><span class="w"> </span><span class="l">boltdb-shipper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">object_store</span><span class="p">:</span><span class="w"> </span><span class="l">s3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">schema</span><span class="p">:</span><span class="w"> </span><span class="l">v12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">index</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">prefix</span><span class="p">:</span><span class="w"> </span><span class="l">loki_index_</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">period</span><span class="p">:</span><span class="w"> </span><span class="l">24h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">distributor</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ingester</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">querier</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">queryFrontend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nginxConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">httpSnippet</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      </span><span class="w">      </span><span class="l">client_max_body_size 100M;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">serverSnippet</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      </span><span class="w">      </span><span class="l">client_max_body_size 100M;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The above configuration optionally overrides the default values in the <code>loki.config</code> template file, and most configuration parameters can be set externally using <code>loki.structuredConfig</code>. <code>loki.config</code>, <code>loki.schemaConfig</code> and <code>loki.storageConfig</code> can also be used in conjunction with <code>loki.structuredConfig</code>. The values in <code>loki.structuredConfig</code> have a higher priority.</p>
<p>Here we specify the minio configuration for storing data via <code>loki.structuredConfig.storage_config.aws</code>. For high availability, we have 2 copies of the core components, <code>ingester</code> and <code>querier</code> for persistent storage.</p>
<p>Now use the values file above for a one-click installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install loki -n logging -f ci/minio-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;loki&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: loki
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Jun <span class="m">21</span> 16:20:10 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl"> Welcome to Grafana Loki
</span></span><span class="line"><span class="cl"> Chart version: 0.48.4
</span></span><span class="line"><span class="cl"> Loki version: 2.5.0
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Installed components:
</span></span><span class="line"><span class="cl">* gateway
</span></span><span class="line"><span class="cl">* ingester
</span></span><span class="line"><span class="cl">* distributor
</span></span><span class="line"><span class="cl">* querier
</span></span><span class="line"><span class="cl">* query-frontend
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above will install several components separately: gateway, ingester, distributor, querier, query-frontend, and the corresponding Pod states are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n logging
</span></span><span class="line"><span class="cl">NAME                                                    READY   STATUS    RESTARTS       AGE
</span></span><span class="line"><span class="cl">loki-loki-distributed-distributor-5dfdd5bd78-nxdq8      1/1     Running   <span class="m">0</span>              2m40s
</span></span><span class="line"><span class="cl">loki-loki-distributed-distributor-5dfdd5bd78-rh4gz      1/1     Running   <span class="m">0</span>              116s
</span></span><span class="line"><span class="cl">loki-loki-distributed-gateway-6f4cfd898c-hpszv          1/1     Running   <span class="m">0</span>              21m
</span></span><span class="line"><span class="cl">loki-loki-distributed-ingester-0                        1/1     Running   <span class="m">0</span>              96s
</span></span><span class="line"><span class="cl">loki-loki-distributed-ingester-1                        1/1     Running   <span class="m">0</span>              2m38s
</span></span><span class="line"><span class="cl">loki-loki-distributed-querier-0                         1/1     Running   <span class="m">0</span>              2m2s
</span></span><span class="line"><span class="cl">loki-loki-distributed-querier-1                         1/1     Running   <span class="m">0</span>              2m33s
</span></span><span class="line"><span class="cl">loki-loki-distributed-query-frontend-6d9845cb5b-p4vns   1/1     Running   <span class="m">0</span>              4s
</span></span><span class="line"><span class="cl">loki-loki-distributed-query-frontend-6d9845cb5b-sq5hr   1/1     Running   <span class="m">0</span>              2m40s
</span></span><span class="line"><span class="cl">minio-548656f786-gctk9                                  1/1     Running   <span class="m">1</span> <span class="o">(</span>123m ago<span class="o">)</span>   47h
</span></span><span class="line"><span class="cl">$ kubectl get svc -n logging
</span></span><span class="line"><span class="cl">NAME                                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">loki-loki-distributed-distributor         ClusterIP   10.102.156.127   &lt;none&gt;        3100/TCP,9095/TCP            22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-gateway             ClusterIP   10.111.73.138    &lt;none&gt;        80/TCP                       22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-ingester            ClusterIP   10.98.238.236    &lt;none&gt;        3100/TCP,9095/TCP            22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-ingester-headless   ClusterIP   None             &lt;none&gt;        3100/TCP,9095/TCP            22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-memberlist          ClusterIP   None             &lt;none&gt;        7946/TCP                     22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-querier             ClusterIP   10.101.117.137   &lt;none&gt;        3100/TCP,9095/TCP            22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-querier-headless    ClusterIP   None             &lt;none&gt;        3100/TCP,9095/TCP            22m
</span></span><span class="line"><span class="cl">loki-loki-distributed-query-frontend      ClusterIP   None             &lt;none&gt;        3100/TCP,9095/TCP,9096/TCP   22m
</span></span><span class="line"><span class="cl">minio                                     NodePort    10.111.58.196    &lt;none&gt;        9000:32000/TCP               47h
</span></span></code></pre></td></tr></table>
</div>
</div><p>The corresponding configuration file for Loki is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get cm -n logging loki-loki-distributed -o yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  config.yaml: <span class="p">|</span>
</span></span><span class="line"><span class="cl">    auth_enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">    chunk_store_config:
</span></span><span class="line"><span class="cl">      max_look_back_period: 0s
</span></span><span class="line"><span class="cl">    compactor:
</span></span><span class="line"><span class="cl">      shared_store: filesystem
</span></span><span class="line"><span class="cl">    distributor:
</span></span><span class="line"><span class="cl">      ring:
</span></span><span class="line"><span class="cl">        kvstore:
</span></span><span class="line"><span class="cl">          store: memberlist
</span></span><span class="line"><span class="cl">    frontend:
</span></span><span class="line"><span class="cl">      compress_responses: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      log_queries_longer_than: 5s
</span></span><span class="line"><span class="cl">      tail_proxy_url: http://loki-loki-distributed-querier:3100
</span></span><span class="line"><span class="cl">    frontend_worker:
</span></span><span class="line"><span class="cl">      frontend_address: loki-loki-distributed-query-frontend:9095
</span></span><span class="line"><span class="cl">    ingester:
</span></span><span class="line"><span class="cl">      chunk_block_size: <span class="m">262144</span>
</span></span><span class="line"><span class="cl">      chunk_encoding: snappy
</span></span><span class="line"><span class="cl">      chunk_idle_period: 1h
</span></span><span class="line"><span class="cl">      chunk_retain_period: 1m
</span></span><span class="line"><span class="cl">      chunk_target_size: <span class="m">1536000</span>
</span></span><span class="line"><span class="cl">      lifecycler:
</span></span><span class="line"><span class="cl">        ring:
</span></span><span class="line"><span class="cl">          kvstore:
</span></span><span class="line"><span class="cl">            store: memberlist
</span></span><span class="line"><span class="cl">          replication_factor: <span class="m">1</span>
</span></span><span class="line"><span class="cl">      max_chunk_age: 1h
</span></span><span class="line"><span class="cl">      max_transfer_retries: <span class="m">0</span>
</span></span><span class="line"><span class="cl">      wal:
</span></span><span class="line"><span class="cl">        dir: /var/loki/wal
</span></span><span class="line"><span class="cl">    limits_config:
</span></span><span class="line"><span class="cl">      enforce_metric_name: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      max_cache_freshness_per_query: 10m
</span></span><span class="line"><span class="cl">      reject_old_samples: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      reject_old_samples_max_age: 168h
</span></span><span class="line"><span class="cl">      split_queries_by_interval: 15m
</span></span><span class="line"><span class="cl">    memberlist:
</span></span><span class="line"><span class="cl">      join_members:
</span></span><span class="line"><span class="cl">      - loki-loki-distributed-memberlist
</span></span><span class="line"><span class="cl">    query_range:
</span></span><span class="line"><span class="cl">      align_queries_with_step: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      cache_results: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      max_retries: <span class="m">5</span>
</span></span><span class="line"><span class="cl">      results_cache:
</span></span><span class="line"><span class="cl">        cache:
</span></span><span class="line"><span class="cl">          enable_fifocache: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">          fifocache:
</span></span><span class="line"><span class="cl">            max_size_items: <span class="m">1024</span>
</span></span><span class="line"><span class="cl">            validity: 24h
</span></span><span class="line"><span class="cl">    ruler:
</span></span><span class="line"><span class="cl">      alertmanager_url: https://alertmanager.xx
</span></span><span class="line"><span class="cl">      external_url: https://alertmanager.xx
</span></span><span class="line"><span class="cl">      ring:
</span></span><span class="line"><span class="cl">        kvstore:
</span></span><span class="line"><span class="cl">          store: memberlist
</span></span><span class="line"><span class="cl">      rule_path: /tmp/loki/scratch
</span></span><span class="line"><span class="cl">      storage:
</span></span><span class="line"><span class="cl">        local:
</span></span><span class="line"><span class="cl">          directory: /etc/loki/rules
</span></span><span class="line"><span class="cl">        type: <span class="nb">local</span>
</span></span><span class="line"><span class="cl">    schema_config:
</span></span><span class="line"><span class="cl">      configs:
</span></span><span class="line"><span class="cl">      - from: <span class="s2">&#34;2022-06-21&#34;</span>
</span></span><span class="line"><span class="cl">        index:
</span></span><span class="line"><span class="cl">          period: 24h
</span></span><span class="line"><span class="cl">          prefix: loki_index_
</span></span><span class="line"><span class="cl">        object_store: s3
</span></span><span class="line"><span class="cl">        schema: v12
</span></span><span class="line"><span class="cl">        store: boltdb-shipper
</span></span><span class="line"><span class="cl">    server:
</span></span><span class="line"><span class="cl">      http_listen_port: <span class="m">3100</span>
</span></span><span class="line"><span class="cl">    storage_config:
</span></span><span class="line"><span class="cl">      aws:
</span></span><span class="line"><span class="cl">        access_key_id: myaccessKey
</span></span><span class="line"><span class="cl">        bucketnames: loki-data
</span></span><span class="line"><span class="cl">        endpoint: minio.logging.svc.cluster.local:9000
</span></span><span class="line"><span class="cl">        insecure: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        s3forcepathstyle: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        secret_access_key: mysecretKey
</span></span><span class="line"><span class="cl">      boltdb_shipper:
</span></span><span class="line"><span class="cl">        active_index_directory: /var/loki/index
</span></span><span class="line"><span class="cl">        cache_location: /var/loki/cache
</span></span><span class="line"><span class="cl">        cache_ttl: 168h
</span></span><span class="line"><span class="cl">        shared_store: s3
</span></span><span class="line"><span class="cl">      filesystem:
</span></span><span class="line"><span class="cl">        directory: /var/loki/chunks
</span></span><span class="line"><span class="cl">    table_manager:
</span></span><span class="line"><span class="cl">      retention_deletes_enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      retention_period: 0s
</span></span><span class="line"><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is also a gateway component that will help us route requests to the correct component, which is also an nginx service, and is configured as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n logging <span class="nb">exec</span> -it loki-loki-distributed-gateway-6f4cfd898c-hpszv -- cat /etc/nginx/nginx.conf
</span></span><span class="line"><span class="cl">worker_processes  5<span class="p">;</span>  <span class="c1">## Default: 1</span>
</span></span><span class="line"><span class="cl">error_log  /dev/stderr<span class="p">;</span>
</span></span><span class="line"><span class="cl">pid        /tmp/nginx.pid<span class="p">;</span>
</span></span><span class="line"><span class="cl">worker_rlimit_nofile 8192<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">events <span class="o">{</span>
</span></span><span class="line"><span class="cl">  worker_connections  4096<span class="p">;</span>  <span class="c1">## Default: 1024</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">http <span class="o">{</span>
</span></span><span class="line"><span class="cl">  client_body_temp_path /tmp/client_temp<span class="p">;</span>
</span></span><span class="line"><span class="cl">  proxy_temp_path       /tmp/proxy_temp_path<span class="p">;</span>
</span></span><span class="line"><span class="cl">  fastcgi_temp_path     /tmp/fastcgi_temp<span class="p">;</span>
</span></span><span class="line"><span class="cl">  uwsgi_temp_path       /tmp/uwsgi_temp<span class="p">;</span>
</span></span><span class="line"><span class="cl">  scgi_temp_path        /tmp/scgi_temp<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  default_type application/octet-stream<span class="p">;</span>
</span></span><span class="line"><span class="cl">  log_format   main <span class="s1">&#39;$remote_addr - $remote_user [$time_local]  $status &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#34;$request&#34; $body_bytes_sent &#34;$http_referer&#34; &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  access_log   /dev/stderr  main<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  sendfile     on<span class="p">;</span>
</span></span><span class="line"><span class="cl">  tcp_nopush   on<span class="p">;</span>
</span></span><span class="line"><span class="cl">  resolver kube-dns.kube-system.svc.cluster.local<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  client_max_body_size 100M<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  server <span class="o">{</span>
</span></span><span class="line"><span class="cl">    listen             8080<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">location</span> <span class="o">=</span> / <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="m">200</span> <span class="s1">&#39;OK&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      auth_basic off<span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">location</span> <span class="o">=</span> /api/prom/push <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">location</span> <span class="o">=</span> /api/prom/tail <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-querier.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      proxy_set_header Connection <span class="s2">&#34;upgrade&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Ruler</span>
</span></span><span class="line"><span class="cl">    location ~ /prometheus/api/v1/alerts.* <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    location ~ /prometheus/api/v1/rules.* <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    location ~ /api/prom/rules.* <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    location ~ /api/prom/alerts.* <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-ruler.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location ~ /api/prom/.* <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-query-frontend.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">location</span> <span class="o">=</span> /loki/api/v1/push <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">location</span> <span class="o">=</span> /loki/api/v1/tail <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-querier.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      proxy_set_header Connection <span class="s2">&#34;upgrade&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location ~ /loki/api/.* <span class="o">{</span>
</span></span><span class="line"><span class="cl">      proxy_pass       http://loki-loki-distributed-query-frontend.logging.svc.cluster.local:3100<span class="nv">$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    client_max_body_size 100M<span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above configuration shows that the corresponding Push endpoints <code>/api/prom/push</code> and <code>/loki/api/v1/push</code> are forwarded to <code>http://loki-loki-distributed-distributor.logging.svc.cluster.local:3100 $request_uri;</code> , which is the corresponding <code>distributor</code> service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n logging -l app.kubernetes.io/component<span class="o">=</span>distributor,app.kubernetes.io/instance<span class="o">=</span>loki,app.kubernetes.io/name<span class="o">=</span>loki-distributed
</span></span><span class="line"><span class="cl">NAME                                                 READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">loki-loki-distributed-distributor-5dfdd5bd78-nxdq8   1/1     Running   <span class="m">0</span>          8m20s
</span></span><span class="line"><span class="cl">loki-loki-distributed-distributor-5dfdd5bd78-rh4gz   1/1     Running   <span class="m">0</span>          7m36s
</span></span></code></pre></td></tr></table>
</div>
</div><p>So if we want to write log data, naturally we are now writing to the Push endpoint of the gateway. To verify that the application is working, next we install Promtail and Grafana to read and write the data.</p>
<h2 id="install-promtail">Install Promtail</h2>
<p>Get the <code>promtail</code> Chart package and unzip it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm pull grafana/promtail --untar
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> promtail
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a values file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># ci/minio-values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pspEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clients</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">http://loki-loki-distributed-gateway/loki/api/v1/push</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Note that we need to configure the Loki address in Promtail to be <code>http://loki-loki-distributed-gateway/loki/api/v1/push</code>, so that Promtail sends the log data to the gateway first, and then the gateway forwards it to the write node based on our Endpoints to forward to the write node, using the values file above to install Promtail.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install promtail -n logging -f ci/minio-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;promtail&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: promtail
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Jun <span class="m">21</span> 16:31:34 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl"> Welcome to Grafana Promtail
</span></span><span class="line"><span class="cl"> Chart version: 5.1.0
</span></span><span class="line"><span class="cl"> Promtail version: 2.5.0
</span></span><span class="line"><span class="cl">***********************************************************************
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Verify the application is working by running these commands:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* kubectl --namespace logging port-forward daemonset/promtail <span class="m">3101</span>
</span></span><span class="line"><span class="cl">* curl http://127.0.0.1:3101/metrics
</span></span></code></pre></td></tr></table>
</div>
</div><p>A promtail will be run on each node after a normal installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n logging -l app.kubernetes.io/name<span class="o">=</span>promtail
</span></span><span class="line"><span class="cl">NAME             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">promtail-gbjzs   1/1     Running   <span class="m">0</span>          38s
</span></span><span class="line"><span class="cl">promtail-gjn5p   1/1     Running   <span class="m">0</span>          38s
</span></span><span class="line"><span class="cl">promtail-z6vhd   1/1     Running   <span class="m">0</span>          38s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normal promtail is already collecting all the container logs on the node, and then pushing the log data to the gateway, which forwards it to the write node, where we can view the gateway logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl logs -f loki-loki-distributed-gateway-6f4cfd898c-hpszv -n logging
</span></span><span class="line"><span class="cl">10.244.2.26 - - <span class="o">[</span>21/Jun/2022:08:41:24 +0000<span class="o">]</span>  <span class="m">204</span> <span class="s2">&#34;POST /loki/api/v1/push HTTP/1.1&#34;</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;promtail/2.5.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">10.244.2.1 - - <span class="o">[</span>21/Jun/2022:08:41:24 +0000<span class="o">]</span>  <span class="m">200</span> <span class="s2">&#34;GET / HTTP/1.1&#34;</span> <span class="m">2</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;kube-probe/1.22&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">10.244.2.26 - - <span class="o">[</span>21/Jun/2022:08:41:25 +0000<span class="o">]</span>  <span class="m">204</span> <span class="s2">&#34;POST /loki/api/v1/push HTTP/1.1&#34;</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;promtail/2.5.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">10.244.1.28 - - <span class="o">[</span>21/Jun/2022:08:41:26 +0000<span class="o">]</span>  <span class="m">204</span> <span class="s2">&#34;POST /loki/api/v1/push HTTP/1.1&#34;</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;promtail/2.5.0&#34;</span> <span class="s2">&#34;-&#34;</span>
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the gateway is now receiving requests directly from <code>/loki/api/v1/push</code>, which is what promtail is sending. Normally, the log data is now distributed to the write node, which stores it in minio, so you can check to see if there is already log data in minio. The minio service was assigned a NodePort of 32000 during the previous installation.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/ba7bbad96ea446788c4db6b283895a81.png" alt="minio"></p>
<p>Here you can see that the data is ready to be written properly.</p>
<h2 id="installing-grafana">Installing Grafana</h2>
<p>Let&rsquo;s verify the read path, install Grafana and interface to Loki.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm pull grafana/grafana --untar
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> grafana
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create the values configuration file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ci/minio-values.yaml</span>
</span></span><span class="line"><span class="cl">service:
</span></span><span class="line"><span class="cl">  type: NodePort
</span></span><span class="line"><span class="cl">  nodePort: <span class="m">32001</span>
</span></span><span class="line"><span class="cl">rbac:
</span></span><span class="line"><span class="cl">  pspEnabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">persistence:
</span></span><span class="line"><span class="cl">  enabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  storageClassName: local-path
</span></span><span class="line"><span class="cl">  accessModes:
</span></span><span class="line"><span class="cl">    - ReadWriteOnce
</span></span><span class="line"><span class="cl">  size: 1Gi
</span></span></code></pre></td></tr></table>
</div>
</div><p>Install Grafana directly using the values file above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm upgrade --install grafana -n logging -f ci/minio-values.yaml .
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;grafana&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: grafana
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue Jun <span class="m">21</span> 16:47:54 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: logging
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">1. Get your <span class="s1">&#39;admin&#39;</span> user password by running:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   kubectl get secret --namespace logging grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2. The Grafana server can be accessed via port <span class="m">80</span> on the following DNS name from within your cluster:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   grafana.logging.svc.cluster.local
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Get the Grafana URL to visit by running these commands in the same shell:
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NODE_PORT</span><span class="o">=</span><span class="k">$(</span>kubectl get --namespace logging -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.spec.ports[0].nodePort}&#34;</span> services grafana<span class="k">)</span>
</span></span><span class="line"><span class="cl">     <span class="nb">export</span> <span class="nv">NODE_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get nodes --namespace logging -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].status.addresses[0].address}&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">     <span class="nb">echo</span> http://<span class="nv">$NODE_IP</span>:<span class="nv">$NODE_PORT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. Login with the password from step <span class="m">1</span> and the username: admin
</span></span></code></pre></td></tr></table>
</div>
</div><p>The login password can be obtained by using the command in the prompt above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get secret --namespace logging grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then log in to Grafana using the password and <code>admin</code> username above.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/6e015a055b1a45b4a9d230bdf5eb99f8.png" alt="Grafana"></p>
<p>After logging in, go to Grafana and add a data source. Here you need to fill in the gateway address <code>http://loki-loki-distributed-gateway</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/11c06212473049f48f532f369725d8dc.png" alt="Grafana"></p>
<p>After saving the data source, you can go to the <code>Explore</code> page to filter the logs, for example, we are here to view the logs of the gateway application in real time, as shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/24/bb4f59146cb2405197a866bd23e3b3cc.png" alt="gatway log"></p>
<p>If you can see the latest log data, it means we have successfully deployed Loki in microservice mode, which is very flexible and can scale up and down different components as needed, but the cost of operation and maintenance will also increase a lot.</p>
<p>In addition, we can also do query and write caching. The Helm Chart we use here supports memcached, or you can switch to redis.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/rust-scoped-thread/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Rust 1.63 will support Scoped Thread</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/ebpf-popular/">
            <span class="next-text nav-default">Why is eBPF so popular?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
