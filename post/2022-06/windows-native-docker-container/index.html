<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Use native Windows Docker containers - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use native Docker containers on Windows and how to troubleshoot port mapping issues." /><meta name="keywords" content="windows, docker" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/windows-native-docker-container/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Use native Windows Docker containers" />
<meta property="og:description" content="Learn how to use native Docker containers on Windows and how to troubleshoot port mapping issues." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/windows-native-docker-container/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-15T13:44:05+08:00" />
<meta property="article:modified_time" content="2022-06-15T13:44:05+08:00" />

<meta itemprop="name" content="Use native Windows Docker containers">
<meta itemprop="description" content="Learn how to use native Docker containers on Windows and how to troubleshoot port mapping issues."><meta itemprop="datePublished" content="2022-06-15T13:44:05+08:00" />
<meta itemprop="dateModified" content="2022-06-15T13:44:05+08:00" />
<meta itemprop="wordCount" content="3562">
<meta itemprop="keywords" content="windows,docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Use native Windows Docker containers"/>
<meta name="twitter:description" content="Learn how to use native Docker containers on Windows and how to troubleshoot port mapping issues."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Use native Windows Docker containers</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-15 13:44:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3562 words </span>
          <span class="more-meta"> 17 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#linux-containers-on-windows">Linux containers on Windows</a></li>
        <li><a href="#exploring-docker-desktop-linuxengine-for-windows">Exploring Docker Desktop LinuxEngine for Windows</a></li>
        <li><a href="#switching-to-use-windows-containers">Switching to use Windows containers</a></li>
        <li><a href="#docker-desktop-under-windowsengine">Docker Desktop under WindowsEngine</a>
          <ul>
            <li><a href="#process-isolation">process isolation</a></li>
            <li><a href="#hyper-v-isolation">Hyper-V isolation</a></li>
          </ul>
        </li>
        <li><a href="#windows-system-and-container-version-compatibility">Windows system and container version compatibility</a></li>
        <li><a href="#aws-support-for-windows-containers">AWS support for Windows containers</a></li>
        <li><a href="#boot-speed-test">Boot speed test</a>
          <ul>
            <li><a href="#windows-containers-in-different-isolation-modes">Windows containers in different isolation modes</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
        <li><a href="#port-mapping-problem-solved">Port mapping problem (solved)</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>When it comes to Docker containers, according to the usual thinking, that is Linux containers (LXC), not much to do with Windows, at best, is to run Docker containers in the Windows Linux virtual machine.</p>
<p>However, since Windows Server 2016, there are Windows-native Docker containers, which are no longer just for Linux, and Docker containers can now run Windows systems, with each Windows container sharing the host Windows kernel (&ndash;isolation= process,) or use a Windows kernel in a highly optimized virtual machine (&ndash;isolation=hyperv).</p>
<p>We say that since Windows Server 2016, including now Windows Server 2019, Windows Server 2022, and Windows 10 and 11 for desktop systems, with the help of <a href="https://store.docker.com/editions/community/docker-ce-desktop-windows">Docker Desktop</a>, you can also run Windows containers.</p>
<p>The original installation of Docker Desktop on Windows desktop can be used to run Linux containers, so it can be seen that on Windows desktop (e.g. Windows 7, 10, 11) two types of containers can be run</p>
<ul>
<li>Linux containers: Each container runs a Linux instance, with resources isolated by the cgcroups namespace. By default, Docker Desktop&rsquo;s LinuxEngine is used.</li>
<li>Windows containers: The containers run Windows instances in process isolation mode, where the containers share the host&rsquo;s Windows kernel, and Hyper-V isolation mode, where the containers use the kernel of a highly optimized virtual machine. You need to enable the Hyper-V feature of Windows and switch Docker Desktop to use WindowsEngine.</li>
</ul>
<p>By adding Windows containers to the traditional LXC concept, Docker&rsquo;s architecture looks like this</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/15/065292f3fcd3427cad229226069658e1.png" alt="Docker&amp;rsquo;s architecture"></p>
<p>Knowledge about Windows Docker containers can be found in Microsoft&rsquo;s official documentation <a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/">Containers on Windows Documentation</a>.</p>
<p>The most basic images for Windows are the following four, listed in order of weight from heaviest to lightest.</p>
<ol>
<li><a href="https://hub.docker.com/_/microsoft-windows">Windows</a>: contains the full set of Windows APIs and system services (but not Server-related), such as Windows 10 image 20H2.</li>
<li><a href="https://hub.docker.com/_/microsoft-windows-server">Windows Server</a>: Contains the full set of Windows APIs and system services, allowing the use of most service features, such as GPU acceleration if you need it.</li>
<li><a href="https://hub.docker.com/_/microsoft-windows-servercore">Windows Server Core</a>: Includes only a subset of Windows Server APIs that are primarily used to support the .NET framework. Most services are also included (e.g. Fax service is not).</li>
<li><a href="https://hub.docker.com/_/microsoft-windows-nanoserver">Nano Server</a>: The lightest Windows Server image, containing only some services that support the .NET Core API.</li>
</ol>
<p>We can build our own image by choosing one of the above base images, or a quicker way is to choose an image where someone else has added the packages we need. For example, to run Python on Windows you can choose 3.10.2-windowsservercore-ltsc2022; <a href="https://mcr.microsoft.com/dotnet/framework/sdk:4.8">https://mcr.microsoft.com/dotnet/framework/sdk:4.8</a> for .net sdk4.8.</p>
<p>For a rough comparison of the image file sizes (which vary greatly by version), here are the image sizes listed with docker images</p>
<ol>
<li>mcr.microsoft.com/windows:20H2 size 16.2G</li>
<li>mcr.microsoft.com/windows/server:ltsc2022 size 11.4 G</li>
<li>mcr.microsoft.com/windows/servercore:ltsc2022 size 4.96 G, mcr.microsoft.com/windows/servercore:ltsc2016 but 12 G</li>
<li>mcr.microsoft.com/windows/nanoserver:ltsc2022 is 295 M in size, like an embedded system</li>
</ol>
<p>It is only possible to pull/run/build Windows images on Windows platforms and requires that the current Windows platform be compatible with the image version, unlike Linux containers which do not have any requirements for the current platform. We will learn more about this later.</p>
<p>To install Docker on Windows Server (including the current Windows 2016, 2019, 2022), execute the following command in PowerShell.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Install-Module -Name DockerMsftProvider -Repository PSGallery -Force
</span></span></code></pre></td></tr></table>
</div>
</div><p>If prompted to install NuGet, select Y. If the above command requires TLS, execute the following command first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>System.Net.ServicePointManager<span class="o">]</span>::SecurityProtocol <span class="o">=</span> <span class="o">[</span>System.Net.SecurityProtocolType<span class="o">]</span>::Tls12<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, install Docker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Install-Package -Name docker -ProviderName DockerMsftProvider
</span></span></code></pre></td></tr></table>
</div>
</div><p>To install <a href="https://store.docker.com/editions/community/docker-ce-desktop-windows">Docker Desktop</a> under Windows 10 or 11.</p>
<p>The next example is Windows 10 (also for Windows 11), to see the difference between the two container types (Linux/Windows), for which a clean system was installed, and the following is the hardware and software environment of the test machine.</p>
<ol>
<li>CPU: Intel i7-7700 @3.60GHz</li>
<li>Memory: 48 GB</li>
<li>Windows 10 Pro, 21H1, OS Version: 10.0.19043</li>
<li>Docker Desktop 4.5.1 (74721), and its requirements for WSL 2</li>
<li>Additional Windows features such as Containers, Hyper-V, Windows Hypervisor Platform are not yet enabled, but Virtual Machine Platform is found to be enabled by default</li>
</ol>
<h2 id="linux-containers-on-windows">Linux containers on Windows</h2>
<p>After just installing Windows 10 Pro + Docker Desktop, by default, LinuxEngine is used, so only Linux containers are supported, run <code>docker version</code> to see the server/client version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker version
</span></span><span class="line"><span class="cl">Client:
</span></span><span class="line"><span class="cl"> Cloud integration: v1.0.22
</span></span><span class="line"><span class="cl"> Version:           20.10.12
</span></span><span class="line"><span class="cl"> API version:       1.41
</span></span><span class="line"><span class="cl"> Go version:        go1.16.12
</span></span><span class="line"><span class="cl"> Git commit:        e91ed57
</span></span><span class="line"><span class="cl"> Built:             Mon Dec <span class="m">13</span> 11:44:07 <span class="m">2021</span>
</span></span><span class="line"><span class="cl"> OS/Arch:           windows/amd64
</span></span><span class="line"><span class="cl"> Context:           default
</span></span><span class="line"><span class="cl"> Experimental:      <span class="nb">true</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Server: Docker Desktop 4.5.1 <span class="o">(</span>74721<span class="o">)</span>
</span></span><span class="line"><span class="cl"> Engine:
</span></span><span class="line"><span class="cl">  Version:          20.10.12
</span></span><span class="line"><span class="cl">  API version:      1.41 <span class="o">(</span>minimum version 1.12<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Go version:       go1.16.12
</span></span><span class="line"><span class="cl">  Git commit:       459d0df
</span></span><span class="line"><span class="cl">  Built:            Mon Dec <span class="m">13</span> 11:43:56 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">  OS/Arch:          linux/amd64
</span></span><span class="line"><span class="cl">  Experimental:     <span class="nb">false</span>
</span></span><span class="line"><span class="cl"> containerd:
</span></span><span class="line"><span class="cl">  Version:          1.4.12
</span></span><span class="line"><span class="cl">  GitCommit:        7b11cfaabd73bb80907dd23182b9347b4245eb5d
</span></span><span class="line"><span class="cl"> runc:
</span></span><span class="line"><span class="cl">  Version:          1.0.2
</span></span><span class="line"><span class="cl">  GitCommit:        v1.0.2-0-g52b36a2
</span></span><span class="line"><span class="cl"> docker-init:
</span></span><span class="line"><span class="cl">  Version:          0.19.0
</span></span><span class="line"><span class="cl">  GitCommit:        de40ad0
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see <code>Server Engine OS/Arch: linux/amd64</code> above. The linux/amd64 of Server means that Docker can only run Linux containers.</p>
<p>At this point we can run the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker pull busybox
</span></span><span class="line"><span class="cl">docker run busybox <span class="nb">echo</span> hello world!
</span></span></code></pre></td></tr></table>
</div>
</div><p>It is also possible to build Linux images, such as Dockerfile content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">FROM ubuntu:20.04
</span></span><span class="line"><span class="cl">CMD <span class="nb">echo</span> hello world!
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then execute the build and test.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker build -t <span class="nb">test</span> .
</span></span><span class="line"><span class="cl">docker run <span class="nb">test</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It is illegal to try to pull or run a Windows container at this point.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt; docker pull mcr.microsoft.com/windows/nanoserver:20H2
</span></span><span class="line"><span class="cl">20H2: Pulling from windows/nanoserver
</span></span><span class="line"><span class="cl">no matching manifest <span class="k">for</span> linux/amd64 in the manifest list entries
</span></span></code></pre></td></tr></table>
</div>
</div><p>Of course, run/build Windows images don&rsquo;t work either, because you have to pull the Windows image before run/build. The reason is that it doesn&rsquo;t match the current linux/amd64.</p>
<h2 id="exploring-docker-desktop-linuxengine-for-windows">Exploring Docker Desktop LinuxEngine for Windows</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">c:<span class="se">\U</span>sers<span class="se">\y</span>abqi&gt;docker context ls
</span></span><span class="line"><span class="cl">NAME                TYPE                DESCRIPTION                               DOCKER ENDPOINT                             KUBERNETES ENDPOINT   ORCHESTRATOR
</span></span><span class="line"><span class="cl">default *           moby                Current DOCKER_HOST based configuration   npipe:////./pipe/docker_engine                                    swarm
</span></span><span class="line"><span class="cl">desktop-linux       moby                                                          npipe:////./pipe/dockerDesktopLinuxEngine
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go to the host of Docker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">c:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker run --net<span class="o">=</span>host --ipc<span class="o">=</span>host --uts<span class="o">=</span>host --pid<span class="o">=</span>host -it --security-opt<span class="o">=</span><span class="nv">seccomp</span><span class="o">=</span>unconfined --privileged --rm -v /:/host alpine chroot /host
</span></span><span class="line"><span class="cl">root@docker-desktop:/# uname -a
</span></span><span class="line"><span class="cl">Linux docker-desktop 5.10.16.3-microsoft-standard-WSL2 <span class="c1">#1 SMP Fri Apr 2 22:23:49 UTC 2021 x86_64 GNU/Linux</span>
</span></span><span class="line"><span class="cl">root@docker-desktop:/# free
</span></span><span class="line"><span class="cl">               total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:        <span class="m">39336428</span>      <span class="m">586016</span>    <span class="m">37845116</span>      <span class="m">377180</span>      <span class="m">905296</span>    <span class="m">37951412</span>
</span></span><span class="line"><span class="cl">Swap:       <span class="m">10485760</span>           <span class="m">0</span>    <span class="m">10485760</span>
</span></span><span class="line"><span class="cl">root@docker-desktop:/# cat /proc/cpuinfo <span class="p">|</span> grep processor
</span></span><span class="line"><span class="cl">processor       : <span class="m">0</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">1</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">2</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">3</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">4</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">5</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">6</span>
</span></span><span class="line"><span class="cl">processor       : <span class="m">7</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>With 48G of physical memory, the Docker host can use up to 39G of memory and all 8 cores of the CPU. This is different from the default allocation of 2G RAM and half the total number of CPU cores in Docker Desktop under Mac OS X.</p>
<p>Note that Hyper-V is not enabled on Windows 10 so far, and the command to view the physical memory is 48G, the Docker host can use up to 39G of memory and all 8 cores of the CPU. This is different from the default allocation of 2G of memory and half the total number of CPU cores for Docker Desktop on Mac OS X.</p>
<p>Note that Hyper-V is not enabled on Windows 10 so far, check with the command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">FeatureName      : Microsoft-Hyper-V
</span></span><span class="line"><span class="cl">DisplayName      : Hyper-V Platform
</span></span><span class="line"><span class="cl">Description      : Provides the services that you can use to create and manage virtual machines and their resources.
</span></span><span class="line"><span class="cl">RestartRequired  : Possible
</span></span><span class="line"><span class="cl">State            : Disabled
</span></span><span class="line"><span class="cl">CustomProperties :
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="switching-to-use-windows-containers">Switching to use Windows containers</h2>
<p>To use Windows containers in Windows 10, first switch to Windows containers for Docker Desktop by tapping Docker Desktop on the system bar and going to its context menu.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/15/2ceb73478b84477a9e3c7401db4cc66e.png" alt="context menu"></p>
<p>Or use the DockerCli command to switch</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="s2">&#34;c:\Program Files\Docker\Docker\DockerCli.exe&#34;</span> -SwitchWindowsEngine
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you want to switch back to LinuxEngine from WindowsEngine, the parameter is <code>-SwitchLinuxEngine</code>.</p>
<p>Or use the <code>-SwitchDaemon</code> parameter to switch back and forth between LinuxEngine and WindowsEngine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">c:<span class="se">\P</span>rogram Files<span class="se">\D</span>ocker<span class="se">\D</span>ocker<span class="se">\D</span>ockerCli.exe<span class="s2">&#34; -SwitchDaemon
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>However, trying to switch to WindowsEngine, either through the UI or by command, now brings up an error container.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/15/c1c66df801514de2a76f05b1a3d5b056.png" alt="error"></p>
<p>The reason for this is that Hyper-V is not turned on, which can be done in the Turn Windows features on or off interface.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/15/69852254c834415b8a478205fa0b7379.png" alt="Turn Windows features on or off interface"></p>
<p>Or use the PowerShell command prompted earlier</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Enable-WindowsOptionalFeature -Online -FeatureName <span class="k">$(</span><span class="s2">&#34;Microsoft-Hyper-V&#34;</span>, <span class="s2">&#34;Containers&#34;</span><span class="k">)</span> -All
</span></span></code></pre></td></tr></table>
</div>
</div><p>Windows will restart automatically after Hyper-V is turned on. After that, you can successfully switch Docker Desktop to Window containers mode by performing the previous step, and then check the <code>docker version</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker version
</span></span><span class="line"><span class="cl">Client:
</span></span><span class="line"><span class="cl"> Cloud integration: v1.0.22
</span></span><span class="line"><span class="cl"> Version:           20.10.12
</span></span><span class="line"><span class="cl"> API version:       1.41
</span></span><span class="line"><span class="cl"> Go version:        go1.16.12
</span></span><span class="line"><span class="cl"> Git commit:        e91ed57
</span></span><span class="line"><span class="cl"> Built:             Mon Dec <span class="m">13</span> 11:44:07 <span class="m">2021</span>
</span></span><span class="line"><span class="cl"> OS/Arch:           windows/amd64
</span></span><span class="line"><span class="cl"> Context:           default
</span></span><span class="line"><span class="cl"> Experimental:      <span class="nb">true</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Server: Docker Desktop 4.5.1 <span class="o">(</span>74721<span class="o">)</span>
</span></span><span class="line"><span class="cl"> Engine:
</span></span><span class="line"><span class="cl">  Version:          20.10.12
</span></span><span class="line"><span class="cl">  API version:      1.41 <span class="o">(</span>minimum version 1.24<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Go version:       go1.16.12
</span></span><span class="line"><span class="cl">  Git commit:       459d0df
</span></span><span class="line"><span class="cl">  Built:            Mon Dec <span class="m">13</span> 11:42:13 <span class="m">2021</span>
</span></span><span class="line"><span class="cl">  OS/Arch:          windows/amd64
</span></span><span class="line"><span class="cl">  Experimental:     <span class="nb">false</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The version information is displayed more simply, and we see that Server / OS/Arch has become windows/amd64.</p>
<p>If you try to run the Linux container at this point it won&rsquo;t work either.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker run busybox
</span></span><span class="line"><span class="cl">Unable to find image <span class="s1">&#39;busybox:latest&#39;</span> locally
</span></span><span class="line"><span class="cl">latest: Pulling from library/busybox
</span></span><span class="line"><span class="cl">docker: no matching manifest <span class="k">for</span> windows/amd64 10.0.19043 in the manifest list entries.
</span></span><span class="line"><span class="cl">See <span class="s1">&#39;docker run --help&#39;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Build and run Windows images/containers</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker run mcr.microsoft.com/windows:20H2 cmd /c <span class="s2">&#34;echo hello world!&#34;</span>
</span></span><span class="line"><span class="cl">hello world!
</span></span></code></pre></td></tr></table>
</div>
</div><p>Build the Windows image with the following Dockerfile contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> mcr.microsoft.com/windows/servercore:ltsc2016</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="nb">echo</span> hello world!<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker build -t <span class="nb">test</span> .
</span></span><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker run <span class="nb">test</span>
</span></span><span class="line"><span class="cl">hello world!
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="docker-desktop-under-windowsengine">Docker Desktop under WindowsEngine</h2>
<p>Switch to WindowsEngine and look at the docker context.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker context ls
</span></span><span class="line"><span class="cl">NAME                TYPE                DESCRIPTION                               DOCKER ENDPOINT                               KUBERNETES ENDPOINT   ORCHESTRATOR
</span></span><span class="line"><span class="cl">default *           moby                Current DOCKER_HOST based configuration   npipe:////./pipe/docker_engine                                      swarm
</span></span><span class="line"><span class="cl">desktop-windows     moby                                                          npipe:////./pipe/dockerDesktopWindowsEngine
</span></span></code></pre></td></tr></table>
</div>
</div><p>A desktop-windows appears instead of the previous desktop-linux.</p>
<p>As for the host of the Windows container, it is related to the isolation mode, there are two types, process isolation and Hyper-V isolation.</p>
<h3 id="process-isolation">process isolation</h3>
<p>It is similar to the cgroups naming isolation of Linux containers, all containers share the current system kernel, the container is actually a process under the current system. The current system is the host of the Windows container, which requires the running container to be of the same version as the current operating system, otherwise the kernel cannot be shared, and the following error will occur.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\y</span>anbin&gt;docker run -it --isolation<span class="o">=</span>process mcr.microsoft.com/windows/servercore:ltsc2016 ping localhost -t
</span></span><span class="line"><span class="cl">docker: Error response from daemon: hcsshim::CreateComputeSystem 2cc0e4e8ce8c0f7e8c82bef76df4a9dbf0672d6ffe29776814891ce27c6bb3fe: The container operating system does not match the host operating system.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similar to the Linux container, processes started with &ndash;isolation=process can be listed with the <code>Get-Process</code> command.</p>
<h3 id="hyper-v-isolation">Hyper-V isolation</h3>
<p>The default value of <code>-isolation</code> in the docker runtime is <code>hyperv</code>, where the container runs in a highly optimized virtual machine, and the container processes do not appear on the current system, but are wrapped in individual <code>vmwp</code> virtual machine processes. That is, that virtual machine is the host of the Windows container. But where can I see the supposedly highly optimized virtual machine? Not in Hyper-V Manager, not with the Get-VM command, too highly optimized.</p>
<p>Learned about the two isolation modes for Windows containers, which might explain why <code>docker run -p 80:8080 ...</code> The default hyperv isolation is 80 to the highly optimized virtual machine, not the current operating system, you should try with <code>-isolation=process</code>, just make sure the current system version and the container system version to be highly consistent. &mdash;&ndash; verified that even with &ndash;isolation=process -p 80:8080, the ports are still not mapped out.</p>
<p>And the speed of starting the container may be related to the choice of isolation mode, and then highly optimized virtual machine should also be slower than the process isolation way to start the container, because process isolation is essentially a local process. &mdash;&ndash; actual test seems to be not much different, anyway, are much slower than the Linux container, at least an order of magnitude difference.</p>
<p>On a particular Windows operating system, not all Windows images support process isolation, Hyper-V isolation is supported, refer to the Windows container version compatibility list <a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/version-compatibility?tabs=windows-server-2022%2Cwindows-10-21H1">Windows container version compatibility</a>.</p>
<h2 id="windows-system-and-container-version-compatibility">Windows system and container version compatibility</h2>
<p>Knowing this can guide us in choosing what version of Windows to build images on and what version of Windows to run containers on. This is not a problem at all for Linux containers, because basically a Linux system that can run docker commands is free to build/run images of any Linux distribution. When you first encounter Windows containers, it is easy to get frustrated when you choose a Windows machine that can run docker commands as WindowsEngine, and you want to pull, run or build an image, but you still have the Linux container mindset in your head.</p>
<p>For example, pull the image of mcr.microsoft.com/windows/servercore:ltsc2022 on Windows 2016.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\d</span>ocker&gt; docker pull mcr.microsoft.com/windows/servercore:ltsc2022
</span></span><span class="line"><span class="cl">ltsc2022: Pulling from windows/servercore
</span></span><span class="line"><span class="cl">8f616e6e9eec: Extracting <span class="o">[==================================================</span>&gt;<span class="o">]</span> 1.252 GB/1.252 GB
</span></span><span class="line"><span class="cl">898469748ff6: Download <span class="nb">complete</span>
</span></span><span class="line"><span class="cl">failed to register layer: re-exec error: <span class="nb">exit</span> status 1: output: ProcessUtilityVMImage C:<span class="se">\P</span>rogramData<span class="se">\d</span>ocker<span class="se">\w</span>indowsfilter<span class="se">\c</span>e66a282a87a379aca443a594025eee342160907305a3f4323f2baaa38d89937<span class="se">\U</span>til
</span></span><span class="line"><span class="cl">ityVM: The system cannot find the path specified.
</span></span></code></pre></td></tr></table>
</div>
</div><p>But pull mcr.microsoft.com/windows/servercore:ltsc2016 is fine. docker run/build based on incompatible image versions is also the same problem, because rub/build needs to be pulled first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\&gt;</span> docker run mcr.microsoft.com/windows/servercore:ltsc2016 cmd /c <span class="s2">&#34;echo hello&#34;</span>
</span></span><span class="line"><span class="cl">docker: Error response from daemon: hcsshim::CreateComputeSystem a9c5b39283e525ca8cbf688f95d7aaabfdd1eb7dd21914d9e587144a455125ca: The container operating system does not match the host operating system.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, a clear understanding of Windows system and container version compatibility is not likely to make us frustrated and even a bit frantic when we come into contact with Windows containers.</p>
<p>For Windows systems that correspond to Windows image versions, and whether Hyper-V or process isolation is supported, please refer to this list <a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/version-compatibility?tabs=windows-server-2022%2Cwindows-10-21H1">Windows container version compatibility</a>. Basically, newer versions are compatible with older versions, e.g. Windows Server 2019 can run Windows Server 2019 and Windows Server 2016 under Windows Server 2019, and Windows Server 2022 can run all versions from Windows 2016 to Windows 2022. However, if process isolation is supported, the platform must be the same as the container version, e.g. Windows Server 2019 can only support Windows Server 2019 if the Windows container is run in process isolation.</p>
<p>Likewise, follow this compatibility table when pulling or building with docker. Build with a higher OS platform for broader compatibility, but use &ndash;isolation=process for the benefit of running containers with the exact same version.</p>
<p>This strict matching of Windows image versions to Windows hosts doesn&rsquo;t defeat the purpose of running Linux containers, we can run other Linux containers in a Linux host without even caring what kernel version or distribution it is. It&rsquo;s a bit like when Windows dabbled with Java and came up with Visual J++, which directly undermined Java&rsquo;s claim to write once and run everywhere.</p>
<h2 id="aws-support-for-windows-containers">AWS support for Windows containers</h2>
<p>I&rsquo;ve been using Linux container services in ECS before, because I had to specify the image when defining the Task, and at that time I was not in the dark about Windows containers, so I always thought ECS didn&rsquo;t support Windows containers at all. Only recently I noticed that AWS has provided a lot of optimized Windows Server ECS AMI to run docker Windows containers, for example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Windows_Server-2016-English-Core-Containers-*
</span></span><span class="line"><span class="cl">Windows_Server-2016-English-Full-ECS_Optimized-*
</span></span><span class="line"><span class="cl">Windows_Server-2019-English-Core-Containers
</span></span><span class="line"><span class="cl">Windows_Server-2019-English-Full-ECS_Optimized-*
</span></span><span class="line"><span class="cl">Windows_Server-2022-English-Core-Containers-*
</span></span><span class="line"><span class="cl">Windows_Server-2022-English-Full-ECS_Optimized-*
</span></span><span class="line"><span class="cl">Windows_Server-20H2-English-Core-Containers
</span></span><span class="line"><span class="cl">Windows_Server-20H2-Core-ECS_Optimized-*
</span></span></code></pre></td></tr></table>
</div>
</div><p>etc.</p>
<p>The version of Windows can be obtained with the <code>ver</code> , <code>systeminfo</code> commands.</p>
<p>Attempting to use <code>docker run --isolation=hyperv</code> on the selected Windows_Server-2016-English-Core-Containers-2016 prompts that there is no hypervisor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\d</span>ocker&gt; docker run --isolation<span class="o">=</span>hyperv mcr.microsoft.com/windows/servercore:ltsc2016 cmd /c <span class="s2">&#34;echo hello&#34;</span>
</span></span><span class="line"><span class="cl">C:<span class="se">\P</span>rogram Files<span class="se">\D</span>ocker<span class="se">\d</span>ocker.exe: Error response from daemon: container fba5ff713c0e9a4fc439747c6792251855c06dfcb1649c3e58d72280b9d62a23 encountered an error during CreateContainer: failure
</span></span><span class="line"><span class="cl">in a Windows system call: No hypervisor is present on this system. <span class="o">(</span>0xc0351000<span class="o">)</span> extra info.......................
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although ECS supports Windows containers, Windows images are very large, starting at 10G, which is a beast compared to Linux images of about 100-200M, which can seriously affect the speed of building, pushing, and pulling images. And it&rsquo;s also slower to start a Windows container after the image is downloaded. So for Windows applications you might want to run past the ECS and let the ELB connect directly to the EC2 Target Group.</p>
<h2 id="boot-speed-test">Boot speed test</h2>
<p>It is not yet possible to test the startup speed in different isolation modes for the same image, because the <code>--isolation=hyperv</code> isolation level cannot be used on Windows Server.</p>
<h3 id="windows-containers-in-different-isolation-modes">Windows containers in different isolation modes</h3>
<p>Test the speed of booting Windows containers on Windows Server 2016 with process isolation and Hyper-V isolation respectively.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\d</span>ocker&gt; Measure-Command <span class="o">{</span>docker run --isolation<span class="o">=</span>process mcr.microsoft.com/windows/servercore:ltsc2016 cmd /c <span class="s2">&#34;echo hello&#34;</span> <span class="p">|</span> Out-Host<span class="o">}</span> <span class="p">|</span> findStr TotalSeconds
</span></span><span class="line"><span class="cl">TotalSeconds      : 6.1539651
</span></span></code></pre></td></tr></table>
</div>
</div><p>The average time taken is 6.15 seconds.</p>
<p>This is not comparable to starting a Linux container under Linux.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">time</span> docker run ubuntu:20.04 <span class="nb">echo</span> hello
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">real    0m0.361s
</span></span><span class="line"><span class="cl">user    0m0.019s
</span></span><span class="line"><span class="cl">sys 0m0.005s
</span></span></code></pre></td></tr></table>
</div>
</div><p>The time to boot a ubuntu:20.04 under Windows 10 is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Measure-Command <span class="o">{</span>docker run ubuntu:20.04 <span class="nb">echo</span> hello <span class="p">|</span> Out-Host<span class="o">}</span> <span class="p">|</span> findStr TotalSeconds
</span></span><span class="line"><span class="cl">TotalSeconds      : 1.7179686
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>The Windows container is not only big, but the Windows container is also slow to start.</p>
<p><del>here is still a problem with -p port mapping that does not start the corresponding port on the machine where the docker command is executed.</del></p>
<p>So we still support Linux where we can use it.</p>
<h2 id="port-mapping-problem-solved">Port mapping problem (solved)</h2>
<p>Running Windows Server Docker container</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker run --name aspnet_sample --rm -it -p 8080:80 mcr.microsoft.com/dotnet/framework/samples:aspnetapp
</span></span></code></pre></td></tr></table>
</div>
</div><p>As usual with Linux containers, first use <code>docker ps</code> to verify that the port mapping is set (only Name and Ports are shown below)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; docker ps --format <span class="s2">&#34;{{.Names}}: {{.Ports}}&#34;</span>
</span></span><span class="line"><span class="cl">aspnet_sample: 0.0.0.0:8080-&gt;80/tcp
</span></span></code></pre></td></tr></table>
</div>
</div><p>The port mapping is fine, from 8080 on the host to 80 on the container</p>
<p>First check if port 8080 is open on the host with a Linux-like <code>netstat -na|grep 8080</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; netstat -na<span class="p">|</span>findstr <span class="m">8080</span>
</span></span><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Found nothing, then added <code>telnet</code> double authentication</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; telnet localhost <span class="m">8080</span>
</span></span><span class="line"><span class="cl">Connecting To localhost...Could not open connection to the host, on port 8080: Connect failed
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, check the IP and port number of the container</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; docker <span class="nb">exec</span> aspnet_sample ipconfig
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Ethernet adapter vEthernet <span class="o">(</span>Container NIC 91439e0f<span class="o">)</span>:
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    Connection-specific DNS Suffix  . : ec2.internal
</span></span><span class="line"><span class="cl">    Link-local IPv6 Address . . . . . : fe80::e878:9772:931:e2cd%19
</span></span><span class="line"><span class="cl">    IPv4 Address. . . . . . . . . . . : 172.25.8.94
</span></span><span class="line"><span class="cl">    Subnet Mask . . . . . . . . . . . : 255.255.240.0
</span></span><span class="line"><span class="cl">    Default Gateway . . . . . . . . . : 172.25.0.1
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; docker <span class="nb">exec</span>  aspnet_sample netstat -na<span class="p">|</span>findstr <span class="m">80</span>
</span></span><span class="line"><span class="cl">TCP 0.0.0.0:80 0.0.0.0:0 LISTENING
</span></span><span class="line"><span class="cl">TCP <span class="o">[</span>::<span class="o">]</span>:80 <span class="o">[</span>::<span class="o">]</span>:0 LISTENING
</span></span></code></pre></td></tr></table>
</div>
</div><p>The port 80 started in the container is fine, so accessing <code>http://172.25.8.94:80</code> through the container IP is fine, but some places introduce access to <code>http://172.25.8.94:8080</code> to access (this path does not work). And one reason is to use container IP in earlier versions, which earlier is not clear.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">After the application starts, navigate to http://localhost:8080 in your web browser. You need to navigate to the application via IP address instead of localhost for earlier Windows versions
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>see <a href="https://hub.docker.com/_/microsoft-dotnet-framework-samples/?tab=description">https://hub.docker.com/_/microsoft-dotnet-framework-samples/?tab=description</a></p>
</blockquote>
<p>The other day I&rsquo;ve been troubled by this illusion, seeing port 8080 from netstat -na and telnet localhost 8080, and instinctively thinking that the Windows Server container port mapping is not working, and that further port mapping with it for ECS will not work. In fact, this is just a display bug, see Open issue: <a href="https://github.com/moby/moby/issues/30300">[Windows] Port binding is not visible with &rsquo;netstat&rsquo; but works correctly. #30300</a></p>
<p>In this case, the port mapping is actually successful, but you can&rsquo;t access it with localhost:8080, use <code>ipconfig</code> to find the host IP, and then access the host IP:8080 is able to pass.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; ipconfig
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">........
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Ethernet adapter Ethernet:
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   Connection-specific DNS Suffix  . : ec2.internal
</span></span><span class="line"><span class="cl">   Link-local IPv6 Address . . . . . : fe80::64ea:22d5:4620:79a8%4
</span></span><span class="line"><span class="cl">   IPv4 Address. . . . . . . . . . . : 10.255.60.241
</span></span><span class="line"><span class="cl">   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class="line"><span class="cl">   Default Gateway . . . . . . . . . : 10.255.60.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">telnet 10.255.60.241 <span class="m">8080</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is no problem, that is, accessing <code>http://10.255.60.241:8080</code> from the remote is possible, so naturally it is not a problem as a port mapping for ECS.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/15/e40c9551663a4394a245985ba10dafdd.png" alt="ECS"></p>
<p>netstat -na is an illusion, localhost:8080 does not work either, nor does 127.0.0.1:8080, which means that <code>docker -p 8080:80</code> when starting a Windows container only listens on port 8080 of the NIC, and is only visible to <code>netstat -na</code>, and even PowerShell command <code>Get-NetTCPConnection</code> are not visible. But one more <code>-p 8080:80</code> will expose the problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; docker run -p 8080:80 mcr.microsoft.com/dotnet/framework/samples:aspnetapp
</span></span><span class="line"><span class="cl">C:<span class="se">\P</span>rogram Files<span class="se">\D</span>ocker<span class="se">\d</span>ocker.exe: Error response from daemon: failed to create endpoint dazzling_clarke on network nat: HNS failed with error : The object already exists.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Port 8080 is occupied, proving that 8080 is bound somewhere we can&rsquo;t see.</p>
<p>Since then, using Windows containers in ECS is worth practicing further, and the following task is about how to control the size of the Windows Docker image and put it in the Docker Registry with a fast network.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/windows/">windows</a>
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/react-ts-env/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Configuring React &#43; TypeScript Development Environment</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/bash-tree-file/">
            <span class="next-text nav-default">Traversing folders with Bash</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
