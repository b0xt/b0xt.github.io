<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Usage of Grafana Loki Query Language LogQL - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Grafana Loki&#39;s query language, LogQL." /><meta name="keywords" content="Grafana Loki, LogQL " />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/logql/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Usage of Grafana Loki Query Language LogQL" />
<meta property="og:description" content="Learn how to use Grafana Loki&#39;s query language, LogQL." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/logql/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-29T12:15:56+08:00" />
<meta property="article:modified_time" content="2022-06-29T12:15:56+08:00" />

<meta itemprop="name" content="Usage of Grafana Loki Query Language LogQL">
<meta itemprop="description" content="Learn how to use Grafana Loki&#39;s query language, LogQL."><meta itemprop="datePublished" content="2022-06-29T12:15:56+08:00" />
<meta itemprop="dateModified" content="2022-06-29T12:15:56+08:00" />
<meta itemprop="wordCount" content="3961">
<meta itemprop="keywords" content="Grafana," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Usage of Grafana Loki Query Language LogQL"/>
<meta name="twitter:description" content="Learn how to use Grafana Loki&#39;s query language, LogQL."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Usage of Grafana Loki Query Language LogQL</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-29 12:15:56 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3961 words </span>
          <span class="more-meta"> 19 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#log-queries">Log queries</a></li>
        <li><a href="#log-stream-selector">Log Stream Selector</a></li>
        <li><a href="#log-pipeline">Log Pipeline</a>
          <ul>
            <li><a href="#log-line-filtering-expressions">Log line filtering expressions</a></li>
            <li><a href="#parser-expressions">Parser expressions</a></li>
            <li><a href="#tag-filtering-expressions">Tag filtering expressions</a></li>
            <li><a href="#log-line-formatting-expressions">Log line formatting expressions</a></li>
            <li><a href="#label-format-expressions">Label format expressions</a></li>
          </ul>
        </li>
        <li><a href="#logging-metrics">Logging Metrics</a>
          <ul>
            <li><a href="#interval-vectors">Interval vectors</a></li>
            <li><a href="#aggregation-functions">Aggregation Functions</a></li>
            <li><a href="#binary-operations">Binary operations</a></li>
            <li><a href="#comments">Comments</a></li>
          </ul>
        </li>
        <li><a href="#query-example">Query Example</a></li>
        <li><a href="#monitoring-panel">Monitoring Panel</a></li>
        <li><a href="#recommendations">Recommendations</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Inspired by PromQL, Loki also has its own query language, called LogQL, which is like a distributed grep that aggregates views of logs. Like PromQL, LogQL is filtered using tags and operators, and has two main types of query functions.</p>
<ul>
<li>Query to return log line contents</li>
<li>Calculating relevant metrics in the log stream by filtering rules</li>
</ul>
<h2 id="log-queries">Log queries</h2>
<p>A basic log query consists of two parts.</p>
<ul>
<li><code>log stream selector</code></li>
<li><code>log pipeline</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/aa70a1d8bc5d4a48864629cc2960d2d9.png" alt="Log queries"></p>
<p>Due to the design of Loki, all LogQL queries must contain a Log Stream selector. A Log Stream represents log entries that have the same metadata (set of Labels).</p>
<p>A <strong>Log Stream Selector</strong> determines how many logs will be searched for. A more granular Log Stream Selector reduces the number of streams searched to a manageable number, which can significantly reduce resource consumption during queries by finely matching log streams.</p>
<p>The log stream selector is optionally followed by a <strong>log pipeline</strong> for further processing and filtering of log stream information, which consists of a set of expressions, each of which performs relevant filtering for each log line in left-to-right order, each of which can filter, parse and change the log line content and its respective label.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/b5e55f7b205c49cc92eb3cd98cecac3c.png" alt="Log queries"></p>
<p>The following example shows the operation of a complete log query.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">{container=&#34;query-frontend&#34;,namespace=&#34;loki-dev&#34;} |= &#34;metrics.go&#34; | logfmt | duration &gt; 10s and throughput_mb &lt; 500
</span></span></code></pre></td></tr></table>
</div>
</div><p>The query statement consists of the following parts.</p>
<ul>
<li>a log stream selector <code>{container=&quot;query-frontend&quot;,namespace=&quot;logi-dev&quot;}</code> that filters logs from the <code>query-frontend</code> container under the <code>loki-dev</code> namespace</li>
<li>then followed by a log pipeline <code>|= &quot;metrics.go&quot; | logfmt | duration &gt; 10s and throughput_mb &lt; 500</code> that will filter out logs containing the word <code>metrics.go</code>, then parse each line to extract more expressions and filter</li>
</ul>
<blockquote>
<p>To avoid escaping the featured character, you can use single quotes instead of double quotes when quoting a string, for example <code>\w+1</code> is the same as &ldquo;\w+&rdquo;.</p>
</blockquote>
<h2 id="log-stream-selector">Log Stream Selector</h2>
<p>The log stream selector determines which log streams should be included in your query results. The selector consists of <strong>one or more key-value pairs</strong>, where each key is a <strong>log tag</strong> and each value is the value of that tag.</p>
<p>Log stream selectors are written by wrapping key-value pairs in a pair of curly brackets, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">{app=&#34;mysql&#34;, name=&#34;mysql-backup&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above example means that all log streams with the tag app and the value mysql and the tag name and the value mysql-backup will be included in the query results.</p>
<p>The <code>=</code> operator after the tag name is a tag matching operator, and there are several tag matching operators supported in LogQL.</p>
<ul>
<li><code>=</code>: exact match</li>
<li><code>! =</code>: unequal</li>
<li><code>=~</code>: regular expression matching</li>
<li><code>! ~</code>: regular expression does not match</li>
</ul>
<p>For example.</p>
<ul>
<li><code>{name=~&quot;mysql.+&quot;}</code></li>
<li><code>{name!~&quot;mysql.+&quot;}</code></li>
<li><code>{name!~&quot;mysql-\\d+&quot;}</code></li>
</ul>
<p>The same rules that apply to the Prometheus tag selector also apply to the Loki log stream selector.</p>
<h2 id="log-pipeline">Log Pipeline</h2>
<p>A log pipeline can be attached to a log stream selector to further process and filter log streams. It typically consists of one or more expressions, each executed in turn for each log line. If a log line is filtered out by an expression, the pipeline will stop there and start processing the next line. Some expressions can change the log content and their respective labels, which can then be used to further filter and process subsequent expressions or metrics queries.</p>
<p>A log pipeline can consist of the following parts.</p>
<ul>
<li>Log line filtering expressions</li>
<li>Parser expressions</li>
<li>Tag filtering expressions</li>
<li>Log line formatting expressions</li>
<li>Tag formatting expressions</li>
<li>Unwrap expression</li>
</ul>
<p>where unwrap expression is a special expression that can only be used in metric queries.</p>
<h3 id="log-line-filtering-expressions">Log line filtering expressions</h3>
<p>Log line filtering expressions are used to perform a distributed grep on aggregated logs in a matching log stream.</p>
<p>After writing in the log stream selector, the resulting log data set can be further filtered using a <strong>search expression</strong>, which can be text or a regular expression, e.g.</p>
<ul>
<li><code>{job=&quot;mysql&quot;} |= &quot;error&quot;</code></li>
<li><code>{name=&quot;kafka&quot;} |~ &quot;tsdb-ops.*io:2003&quot;</code></li>
<li><code>{name=&quot;cassandra&quot;} |~ &quot;error=\\w+&quot;</code></li>
<li><code>{instance=~&quot;kafka-[23]&quot;,name=&quot;kafka&quot;} ! = &quot;kafka.server:type=ReplicaManager&quot;</code></li>
</ul>
<p>The <code>|=</code>, <code>|~</code> and <code>! =</code> are <strong>filter operators</strong> that support the following.</p>
<ul>
<li><code>|=</code>: the string contained in the log line</li>
<li><code>! =</code>: strings not included in the log line</li>
<li><code>|~</code>: log line matching regular expressions</li>
<li><code>! ~</code>: log line does not match a regular expression</li>
</ul>
<p>The filter operators can be chained and will filter expressions in order, and the resulting log lines must satisfy each filter. When using <code>|~</code> and <code>! ~</code>, regular expressions with Golang&rsquo;s RE2 syntax can be used. By default, the matching is case-sensitive and can be switched to be case-insensitive by prefixing the regular expression with <code>(?i)</code>.</p>
<p>While log line filter expressions can be placed anywhere in the pipeline, it is best to place them at the beginning to improve the performance of the query and only do further follow-up when a line matches. For example, while the results are the same, the following query <code>{job=&quot;mysql&quot;} |= &quot;error&quot; |json | line_format &quot;{{.err}}&quot;</code> will be faster than <code>{job=&quot;mysql&quot;} | json | line_format &quot;{{.message}}&quot; |= &quot;error&quot;</code>, <strong>Log line filter expressions are the fastest way to filter logs after log stream selectors</strong> .</p>
<h3 id="parser-expressions">Parser expressions</h3>
<p>Parser expressions parse and extract tags from log content, and these extracted tags can be used in tag filtering expressions for filtering, or for metric aggregation.</p>
<p>The extracted tag keys are automatically formatted by the parser to follow the Prometheus metric name conventions (they can only contain ASCII letters and numbers, as well as underscores and colons, and cannot start with a number).</p>
<p>For example, the following log passing through the pipeline <code>| json</code> will produce the following Map data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span> <span class="nt">&#34;a.b&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&#34;c&#34;</span><span class="p">:</span> <span class="s2">&#34;d&#34;</span> <span class="p">},</span> <span class="nt">&#34;e&#34;</span><span class="p">:</span> <span class="s2">&#34;f&#34;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>-&gt;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="err">a_b_c=</span><span class="nt">&#34;d&#34;</span><span class="p">,</span> <span class="err">e=</span><span class="nt">&#34;f&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the case of an error, for example, if the line is not in the expected format, the log line will not be filtered but a new <code>__error__</code> tag will be added.</p>
<p>Note that if an extracted tag key name already exists in the original log stream, then the extracted tag key will be suffixed with <code>_extracted</code> to distinguish between the two tags. You can use a tag formatting expression to force an override of the original tag, but if an extracted key appears twice, then only the latest tag value will be retained.</p>
<p>The parsers <code>json</code>, <code>logfmt</code>, <code>pattern</code>, <code>regexp</code> and <code>unpack</code> are currently supported.</p>
<p>We should use predefined parsers like <code>json</code> and <code>logfmt</code> whenever possible, it will be easier, and when the log line structure is unusual, you can use <code>regexp</code>, which allows you to use multiple parsers in the same log pipeline, which is useful when you are parsing complex logs.</p>
<h4 id="json">JSON</h4>
<p>The json parser operates in two modes.</p>
<ul>
<li>If the log line is a valid json document, adding <code>| json</code> to your pipeline will extract all json attributes as labels, and nested attributes will be tiled into the label key using the <code>_</code> separator.</li>
</ul>
<blockquote>
<p>Note: Arrays will be ignored.</p>
</blockquote>
<p>For example, use the json parser to extract the tags from the contents of the following files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;HTTP/2.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;servers&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;129.0.1.1&#34;</span><span class="p">,</span> <span class="s2">&#34;10.2.1.3&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;time&#34;</span><span class="p">:</span> <span class="s2">&#34;6.032&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;foo.grafana.net&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="s2">&#34;55&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;headers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;Accept&#34;</span><span class="p">:</span> <span class="s2">&#34;*/*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="s2">&#34;curl/7.68.0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;response&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="s2">&#34;228&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;latency_seconds&#34;</span><span class="p">:</span> <span class="s2">&#34;6.031&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A list of tags can be obtained as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&#34;protocol&#34; =&gt; &#34;HTTP/2.0&#34;
</span></span><span class="line"><span class="cl">&#34;request_time&#34; =&gt; &#34;6.032&#34;
</span></span><span class="line"><span class="cl">&#34;request_method&#34; =&gt; &#34;GET&#34;
</span></span><span class="line"><span class="cl">&#34;request_host&#34; =&gt; &#34;foo.grafana.net&#34;
</span></span><span class="line"><span class="cl">&#34;request_size&#34; =&gt; &#34;55&#34;
</span></span><span class="line"><span class="cl">&#34;response_status&#34; =&gt; &#34;401&#34;
</span></span><span class="line"><span class="cl">&#34;response_size&#34; =&gt; &#34;228&#34;
</span></span><span class="line"><span class="cl">&#34;response_latency_seconds&#34; =&gt; &#34;6.031&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Using <code>|json label=&quot;expression&quot;, another=&quot;expression&quot;</code> in your pipeline will extract only the specified json field as a label, you can specify one or more expressions in this way, same as <code>label_format</code>, all expressions must be quoted.</li>
</ul>
<p>Only field access (<code>my.field</code>, <code>my[&quot;field&quot;]</code>) and array access (<code>list[0]</code>) are currently supported, as well as combinations of these in any level of nesting (<code>my.list[0][&quot;field&quot;]</code>).</p>
<p>For example, <code>|json first_server=&quot;servers[0]&quot;, ua=&quot;request.headers[\&quot;User-Agent\&quot;]</code> will extract tags from the following log files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;HTTP/2.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;servers&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;129.0.1.1&#34;</span><span class="p">,</span> <span class="s2">&#34;10.2.1.3&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;request&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;time&#34;</span><span class="p">:</span> <span class="s2">&#34;6.032&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;method&#34;</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;foo.grafana.net&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="s2">&#34;55&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;headers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;Accept&#34;</span><span class="p">:</span> <span class="s2">&#34;*/*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="s2">&#34;curl/7.68.0&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;response&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="mi">401</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="s2">&#34;228&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;latency_seconds&#34;</span><span class="p">:</span> <span class="s2">&#34;6.031&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The list of extracted tags is.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&#34;first_server&#34; =&gt; &#34;129.0.1.1&#34;
</span></span><span class="line"><span class="cl">&#34;ua&#34; =&gt; &#34;curl/7.68.0&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the expression returns an array or object, it will be assigned to the tag in json format. For example, <code>|json server_list=&quot;services&quot;, headers=&quot;request.headers</code> will extract to the following tags.</p>
<h4 id="logfmt">logfmt</h4>
<p>The <code>logfmt</code> parser can be added by using <code>| logfmt</code>, which will advance all the keys and values from the logfmt formatted log lines.</p>
<p>For example, the following log line data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">at</span><span class="o">=</span>info <span class="nv">method</span><span class="o">=</span>GET <span class="nv">path</span><span class="o">=</span>/ <span class="nv">host</span><span class="o">=</span>grafana.net <span class="nv">fwd</span><span class="o">=</span><span class="s2">&#34;124.133.124.161&#34;</span> <span class="nv">service</span><span class="o">=</span>8ms <span class="nv">status</span><span class="o">=</span><span class="m">200</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The labels will be extracted as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&#34;at&#34; =&gt; &#34;info&#34;
</span></span><span class="line"><span class="cl">&#34;method&#34; =&gt; &#34;GET&#34;
</span></span><span class="line"><span class="cl">&#34;path&#34; =&gt; &#34;/&#34;
</span></span><span class="line"><span class="cl">&#34;host&#34; =&gt; &#34;grafana.net&#34;
</span></span><span class="line"><span class="cl">&#34;fwd&#34; =&gt; &#34;124.133.124.161&#34;
</span></span><span class="line"><span class="cl">&#34;service&#34; =&gt; &#34;8ms&#34;
</span></span><span class="line"><span class="cl">&#34;status&#34; =&gt; &#34;200&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="regexp">regexp</h4>
<p>Unlike <code>logfmt</code> and <code>json</code> (which extract all values implicitly and without arguments), the <code>regexp</code> parser takes a single argument <code>| regexp &quot;&lt;re&gt;&quot;</code> in the form of a regular expression using Golang RE2 syntax.</p>
<p>The regular expression must contain at least one named submatch (e.g. <code>(?P&lt;name&gt;re)</code>), with each submatch extracting a different tag.</p>
<p>For example, the parser <code>| regexp &quot;(?P&lt;method&gt;\\w+) (?P&lt;path&gt;[\\w|/]+) \\((?P&lt;status&gt;\\\d+?) \\\) (?P&lt;duration&gt;. *)&quot;</code> will extract tags from the following lines.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">POST /api/prom/api/v1/query_range (200) 1.5s
</span></span></code></pre></td></tr></table>
</div>
</div><p>The extracted tags are.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&#34;method&#34; =&gt; &#34;POST&#34;
</span></span><span class="line"><span class="cl">&#34;path&#34; =&gt; &#34;/api/prom/api/v1/query_range&#34;
</span></span><span class="line"><span class="cl">&#34;status&#34; =&gt; &#34;200&#34;
</span></span><span class="line"><span class="cl">&#34;duration&#34; =&gt; &#34;1.5s&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pattern">pattern</h4>
<p>The pattern parser allows fields to be extracted explicitly from log lines by defining a pattern expression (<code>| pattern &quot;&lt;pattern-expression&gt;&quot;</code>) that matches the structure of the log line.</p>
<p>For example, let&rsquo;s consider the following NGINX log line data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0.191.12.2 - - [10/Jun/2021:09:14:29 +0000] &#34;GET /api/plugins/versioncheck HTTP/1.1&#34; 200 2 &#34;-&#34; &#34;Go-http-client/2.0&#34; &#34;13.76.247.102, 34.120.177.193&#34; &#34;TLSv1.2&#34; &#34;US&#34; &#34;&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The log line can be parsed with the following expression.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;ip&gt; - - &lt;_&gt; &#34;&lt;method&gt; &lt;uri&gt; &lt;_&gt;&#34; &lt;status&gt; &lt;size&gt; &lt;_&gt; &#34;&lt;agent&gt;&#34; &lt;_&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>After parsing, these attributes can be extracted as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;ip&#34; =&gt; &#34;0.191.12.2&#34;
</span></span><span class="line"><span class="cl">&#34;method&#34; =&gt; &#34;GET&#34;
</span></span><span class="line"><span class="cl">&#34;uri&#34; =&gt; &#34;/api/plugins/versioncheck&#34;
</span></span><span class="line"><span class="cl">&#34;status&#34; =&gt; &#34;200&#34;
</span></span><span class="line"><span class="cl">&#34;size&#34; =&gt; &#34;2&#34;
</span></span><span class="line"><span class="cl">&#34;agent&#34; =&gt; &#34;Go-http-client/2.0&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The capture of a pattern expression is a field name separated by the <code>&lt;</code> and <code>&gt;</code> characters, for example <code>&lt;example&gt;</code> defines the field name as <code>example</code>, unnamed <code>capture</code> is displayed as <code>&lt;_&gt;</code>, and unnamed <code>capture</code> skips the match. By default, the pattern expression is anchored at the beginning of the log line, and you can use <code>&lt;_&gt;</code> at the beginning of the expression to anchor the expression at the beginning.</p>
<p>For example, let&rsquo;s look at the following log line data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">level=debug ts=2021-06-10T09:24:13.472094048Z caller=logging.go:66 traceID=0568b66ad2d9294c msg=&#34;POST /loki/api/v1/push (204) 16.652862ms&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we wish to match only the contents of <code>msg=&quot;</code>, we can use the following expression to do so.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;_&gt; msg=&#34;&lt;method&gt; &lt;path&gt; (&lt;status&gt;) &lt;latency&gt;&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>We don&rsquo;t need most of the preceding log data, we just need to use <code>&lt;_&gt;</code> for placeholders, which is obviously much simpler than regular expressions.</p>
<h4 id="unpack">unpack</h4>
<p>The <code>unpack</code> parser will parse the json log lines and unpack all embedded tags through the packing phase, a special attribute <code>_entry</code> will also be used to replace the original log lines.</p>
<p>For example, using the <code>| unpack</code> parser, you can get tags as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;container&#34;</span><span class="p">:</span> <span class="s2">&#34;myapp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pod&#34;</span><span class="p">:</span> <span class="s2">&#34;pod-3223f&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_entry&#34;</span><span class="p">:</span> <span class="s2">&#34;original log message&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Allows extracting <code>container</code> and <code>pod</code> tags and raw log messages as new log lines.</p>
<blockquote>
<p>If the original embedded log lines are in a specific format, you can use unpack in combination with a json parser (or other parser).</p>
</blockquote>
<h3 id="tag-filtering-expressions">Tag filtering expressions</h3>
<p>A tag filter expression allows to filter log lines using their original and extracted tags, and it can contain multiple predicates.</p>
<p>A predicate contains a tag identifier, operator and a value for comparing tags.</p>
<p>For example <code>cluster=&quot;namespace&quot;</code> where <code>cluster</code> is the tag identifier, the operator is <code>=</code> and the value is <code>&quot;namespace&quot;</code>.</p>
<p>LogQL supports a variety of value types that are automatically inferred from the query input.</p>
<ul>
<li><code>String (string)</code> is caused by double quotes or backquotes, such as <code>&quot;200&quot;</code> or <code>us-central1</code>.</li>
<li><code>Duration (time)</code> is a string of decimal numbers, each with an optional number and unit suffix, such as <code>&quot;300ms&quot;</code>, <code>&quot;1.5h&quot;</code> or <code>&quot;2h45m&quot;</code>, and valid time units are <code>&quot;ns&quot;</code>, <code>&quot;us&quot;</code> (or <code>&quot;µs&quot;</code>), <code>&quot;ms&quot;</code>, <code>&quot;s&quot;</code>, <code>&quot;m&quot;</code>, <code>&quot;h&quot;</code>.</li>
<li><code>Number</code> is a floating point number (64 bits), e.g. 250, 89.923.</li>
<li><code>Bytes</code> is a string of decimal numbers, each with an optional number and unit suffix, such as <code>&quot;42MB&quot;</code>, <code>&quot;1.5Kib&quot;</code> or <code>&quot;20b&quot;</code>, and valid byte units are <code>&quot;b&quot;</code>, <code>&quot;kib&quot;</code>, <code>&quot;kb&quot;</code>, <code>&quot;mib&quot;</code>, <code>&quot;mb&quot;</code>, <code>&quot;gib&quot;</code>, <code>&quot;gb&quot;</code>, <code>&quot;tib &quot;</code>, <code>&quot;tb&quot;</code>, <code>&quot;pib&quot;</code>, <code>&quot;bb&quot;</code>, <code>&quot;eb&quot;</code>.</li>
</ul>
<p>The string type works exactly the same way as the Prometheus tag matcher is used in the log stream selector, which means you can use the same operators (<code>=</code>, <code>! =</code>, <code>=~</code>, <code>! ~</code>).</p>
<p>Using Duration, Number and Bytes will convert the tag values before comparing and supports the following comparators.</p>
<ul>
<li><code>==</code> or <code>=</code> equal comparison</li>
<li><code>! =</code> not equal comparison</li>
<li><code>&gt;</code> and <code>&gt;=</code> for greater-than or greater-than-equal comparisons</li>
<li><code>&lt;</code> and <code>&lt;=</code> for less-than or less-than-equal comparisons</li>
</ul>
<p>For example, <code>logfmt | duration &gt; 1m and bytes_consumed &gt; 20MB</code> filters the expression.</p>
<p>If the conversion of the tag value fails, the log line is not filtered and a <code>__error__</code> tag is added. You can use <code>and</code> and <code>or</code> to concatenate multiple predicates that represent <strong>and</strong> and <strong>or</strong> binary operations, respectively. <code>and</code> can be represented by commas, spaces, or other pipes, and tag filters can be placed anywhere in the log pipeline.</p>
<p>All of the following expressions are equivalent:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">| duration &gt;= 20ms or size == 20kb and method!~&#34;2..&#34;
</span></span><span class="line"><span class="cl">| duration &gt;= 20ms or size == 20kb | method!~&#34;2..&#34;
</span></span><span class="line"><span class="cl">| duration &gt;= 20ms or size == 20kb,method!~&#34;2..&#34;
</span></span><span class="line"><span class="cl">| duration &gt;= 20ms or size == 20kb method!~&#34;2..&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>By default, multiple predicates are prioritized from right to left. You can wrap predicates in parentheses to force a different priority from left to right.</p>
<p>For example, the following is equivalent.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">| duration &gt;= 20ms or method=&#34;GET&#34; and size &lt;= 20KB
</span></span><span class="line"><span class="cl">| ((duration &gt;= 20ms or method=&#34;GET&#34;) and size &lt;= 20KB)
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will first evaluate <code>duration&gt;=20ms or method=&quot;GET&quot;</code> , to first evaluate <code>method=&quot;GET&quot; and size&lt;=20KB</code> , make sure to use the appropriate brackets as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">| duration &gt;= 20ms or (method=&#34;GET&#34; and size &lt;= 20KB)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="log-line-formatting-expressions">Log line formatting expressions</h3>
<p>Log line formatting expressions can be used to rewrite the contents of log lines by using Golang&rsquo;s <code>text/template</code> template format, which takes a string parameter <code>| line_format &quot;{{.label_name}}&quot;</code> as the template format, and all labels are variables injected into the template and can be used with the <code>{.label_name }}</code> notation to be used.</p>
<p>For example, the following expression.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">{container=&#34;frontend&#34;} | logfmt | line_format &#34;{{.query}} {{.duration}}&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The log lines will be extracted and rewritten to contain only <code>query</code> and the requested <code>duration</code>. You can use double-quoted strings or backquotes <code>{{.label_name}}</code> for templates to avoid escaping special characters.</p>
<p>Also <code>line_format</code> supports mathematical functions, e.g.</p>
<p>If we have the following labels <code>ip=1.1.1.1</code>, <code>status=200</code> and <code>duration=3000(ms)</code>, we can divide <code>duration</code> by 1000 to get the value in seconds.</p>
<p>The above query will result in a log line of <code>1.1.1.1 200 3</code>.</p>
<h3 id="label-format-expressions">Label format expressions</h3>
<p>The <code>| label_format</code> expression can rename, modify or add labels. It takes a comma-separated list of operations as arguments, and can perform multiple operations at once.</p>
<p>When both sides are label identifiers, for example <code>dst=src</code>, the operation will rename the <code>src</code> label to <code>dst</code>.</p>
<p>The left side can also be a template string, e.g. <code>dst=&quot;{{.status}} {{.query}}&quot;</code>, in which case the <code>dst</code> tag value will be replaced by the Golang template execution result, which is the same template engine as the <code>| line_format</code> expression, which means that the tag can be used as a variable, or the same function list.</p>
<p>In both cases above, if the target tag does not exist, then a new tag will be created.</p>
<p>The renamed form <code>dst=src</code> will remove the <code>src</code> tag after remapping it to the <code>dst</code> tag, however, the template form will retain the referenced tag, for example <code>dst=&quot;{{.src}}&quot;</code> results in both <code>dst</code> and <code>src</code> having the same value.</p>
<blockquote>
<p>A label name can only appear once in each expression, which means that <code>| label_format foo=bar,foo=&quot;new&quot;</code> is not allowed, but you can use two expressions to achieve the desired effect, such as <code>| label_format foo=bar | label_format foo=&quot;new&quot;</code> .</p>
</blockquote>
<h2 id="logging-metrics">Logging Metrics</h2>
<p>LogQL also supports metrics for log streams as a function, typically we can use it to calculate the error rate of messages or to sort the application log output Top N over time.</p>
<h3 id="interval-vectors">Interval vectors</h3>
<p>LogQL also supports a limited number of interval vector metric statements, similar to PromQL, with the following 4 functions.</p>
<ul>
<li><code>rate</code>: counts log entries per second</li>
<li><code>count_over_time</code>: counts the entries of each log stream within the specified range</li>
<li><code>bytes_rate</code>: calculates the number of bytes per second for a log stream</li>
<li><code>bytes_over_time</code>: the number of bytes used for each log stream in the specified range</li>
</ul>
<p>For example, to calculate the qps of nginx.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">rate({filename=&#34;/var/log/nginx/access.log&#34;}[5m]))
</span></span></code></pre></td></tr></table>
</div>
</div><p>Calculate the number of times the kernel has experienced oom in the last 5 minutes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">count_over_time({filename=&#34;/var/log/message&#34;} |~ &#34;oom_kill_process&#34; [5m]))
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="aggregation-functions">Aggregation Functions</h3>
<p>LogQL also supports aggregation, which can be used to aggregate the elements within a single vector to produce a new vector with fewer elements.</p>
<ul>
<li><code>sum</code>: summation</li>
<li><code>min</code>: minimum value</li>
<li><code>max</code>: maximum value</li>
<li><code>avg</code>: average value</li>
<li><code>stddev</code>: standard deviation</li>
<li><code>stdvar</code>: standard variance</li>
<li><code>count</code>: count</li>
<li><code>bottomk</code>: the smallest k elements</li>
<li><code>topk</code>: the largest k elements</li>
</ul>
<p>The aggregation function we can describe with the following expression.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&lt;aggr-op&gt;<span class="o">([</span>parameter,<span class="o">]</span> &lt;vector expression&gt;<span class="o">)</span> <span class="o">[</span>without<span class="p">|</span>by <span class="o">(</span>&lt;label list&gt;<span class="o">)]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For grouping tags, we can use <code>without</code> or <code>by</code> to distinguish them. For example, to calculate the qps of nginx and group it by pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">sum(rate({filename=&#34;/var/log/nginx/access.log&#34;}[5m])) by (pod)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Only when using the <code>bottomk</code> and <code>topk</code> functions, we can enter the relevant arguments to the functions. For example, to calculate the top 5 qps for nginx and group them by pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">topk(5,sum(rate({filename=&#34;/var/log/nginx/access.log&#34;}[5m])) by (pod)))
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="binary-operations">Binary operations</h3>
<h4 id="mathematical-calculations">mathematical calculations</h4>
<p>Loki stores logs, they are all text, how do you calculate them? Obviously the mathematical operations in LogQL are oriented towards interval vector operations, and the supported binary operators in LogQL are as follows</p>
<ul>
<li><code>+</code>: addition</li>
<li><code>-</code>: subtraction</li>
<li><code>*</code>: multiplication</li>
<li><code>/</code>: division</li>
<li><code>%</code>: modulo</li>
<li><code>^</code>: find the power</li>
</ul>
<p>For example, if we want to find the error rate inside a certain business log, we can calculate it as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">sum(rate({app=&#34;foo&#34;, level=&#34;error&#34;}[1m])) / sum(rate({app=&#34;foo&#34;}[1m]))
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="logical-operations">Logical operations</h4>
<p>Set operations are only valid in the interval vector range, and currently support</p>
<ul>
<li><code>and</code>: and</li>
<li><code>or</code>: or</li>
<li><code>unless</code>: exclude</li>
</ul>
<p>For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">rate({app=~&#34;foo|bar&#34;}[1m]) and rate({app=&#34;bar&#34;}[1m])
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="comparison-operators">Comparison Operators</h4>
<p>LogQL supports the same comparison operators as PromQL, including</p>
<ul>
<li><code>==</code>: equal to</li>
<li><code>! =</code>: not equal</li>
<li><code>&gt;</code>: greater than</li>
<li><code>&gt;=</code>: greater than or equal to</li>
<li><code>&lt;</code>: less than</li>
<li><code>&lt;=</code>: less than or equal to</li>
</ul>
<p>Usually we do a comparison of thresholds after using interval vector calculations, which is useful for alerting, e.g. to count error level log entries greater than 10 within 5 minutes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">count_over_time({app=&#34;foo&#34;, level=&#34;error&#34;}[5m]) &gt; 10
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can also express this through a Boolean calculation, such as a statistic of error level log entries greater than 10 within 5 minutes is true. The opposite is false.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">count_over_time<span class="o">({</span><span class="nv">app</span><span class="o">=</span><span class="s2">&#34;foo&#34;</span>, <span class="nv">level</span><span class="o">=</span><span class="s2">&#34;error&#34;</span><span class="o">}[</span>5m<span class="o">])</span> &gt; bool <span class="m">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="comments">Comments</h3>
<p>LogQL queries can be annotated with the <code>#</code> character, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">{app=&#34;foo&#34;} # anything that comes after will not be interpreted in your query
</span></span></code></pre></td></tr></table>
</div>
</div><p>For multi-row LogQL queries, you can use <code>#</code> to exclude whole or partial rows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{app=&#34;foo&#34;}
</span></span><span class="line"><span class="cl">    | json
</span></span><span class="line"><span class="cl">    # this line will be ignored
</span></span><span class="line"><span class="cl">    | bar=&#34;baz&#34; # this checks if bar = &#34;baz&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="query-example">Query Example</h2>
<p>Here we deploy a sample application that is a fake logger with debug, info and warning logs output to stdout. error level logs will be written to stderr and the actual log messages are generated in JSON format and a new log message will be created every 500 milliseconds. The log message format is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;app&#34;</span><span class="p">:</span><span class="s2">&#34;The fanciest app of mankind&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;executable&#34;</span><span class="p">:</span><span class="s2">&#34;fake-logger&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;is_even&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;level&#34;</span><span class="p">:</span><span class="s2">&#34;debug&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;msg&#34;</span><span class="p">:</span><span class="s2">&#34;This is a debug message. Hope you&#39;ll catch the bug&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;time&#34;</span><span class="p">:</span><span class="s2">&#34;2022-04-04T13:41:50+02:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span><span class="s2">&#34;1.0.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use the following command to create the sample application.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: apps/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: Deployment
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s"> labels:
</span></span></span><span class="line"><span class="cl"><span class="s">  app: fake-logger
</span></span></span><span class="line"><span class="cl"><span class="s">  environment: development
</span></span></span><span class="line"><span class="cl"><span class="s"> name: fake-logger
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s"> selector:
</span></span></span><span class="line"><span class="cl"><span class="s">  matchLabels:
</span></span></span><span class="line"><span class="cl"><span class="s">   app: fake-logger
</span></span></span><span class="line"><span class="cl"><span class="s">   environment: development
</span></span></span><span class="line"><span class="cl"><span class="s"> template:
</span></span></span><span class="line"><span class="cl"><span class="s">  metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">   labels:
</span></span></span><span class="line"><span class="cl"><span class="s">    app: fake-logger
</span></span></span><span class="line"><span class="cl"><span class="s">    environment: development
</span></span></span><span class="line"><span class="cl"><span class="s">  spec:
</span></span></span><span class="line"><span class="cl"><span class="s">   containers:
</span></span></span><span class="line"><span class="cl"><span class="s">   - image: thorstenhans/fake-logger:0.0.2
</span></span></span><span class="line"><span class="cl"><span class="s">     name: fake-logger
</span></span></span><span class="line"><span class="cl"><span class="s">     resources:
</span></span></span><span class="line"><span class="cl"><span class="s">      requests:
</span></span></span><span class="line"><span class="cl"><span class="s">       cpu: 10m
</span></span></span><span class="line"><span class="cl"><span class="s">       memory: 32Mi
</span></span></span><span class="line"><span class="cl"><span class="s">      limits:
</span></span></span><span class="line"><span class="cl"><span class="s">       cpu: 10m
</span></span></span><span class="line"><span class="cl"><span class="s">       memory: 32Mi
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can use <code>{app=&quot;fake-logger&quot;}</code> to query the application&rsquo;s log stream data in Grafana.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/e0088074626f483d9d501be85c2ec0de.png" alt="Grafana"></p>
<p>Since the logs of our sample application are in JSON form, we can use a JSON parser to parse the logs with the expression <code>{app=&quot;fake-logger&quot;} | json</code>, as shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/31c01def302747afb96b4501439575af.png" alt="Grafana"></p>
<p>After parsing the log using the JSON parser, you can see that the Grafana-provided panel is differentiated using different colors depending on the value of <code>level</code>, and that the attributes of our log are now added to the Log tab.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/8451ff64bdee4a93a960903ec62c5dbe.png" alt="Grafana"></p>
<p>Now that the data in JSON is turned into log tags we can naturally use these tags to filter log data. For example, if we want to filter logs with <code>level=error</code>, we just use the expression <code>{app=&quot;fake-logger&quot;} | json | level=&quot;error&quot;</code> to do so.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/ce2ffb9159c14cbcbb2a90a12add0a52.png" alt="Grafana"></p>
<p>In addition, we can format the output logs according to our needs using <code>line_format</code>, for example, we use the query statement <code>{app=&quot;fake-logger&quot;} | json |is_even=&quot;true&quot; | line_format &quot;logs generated in {{.time}} on {{.level}}@ {{.pod}} Pod generated log {{.msg}}&quot;</code> to format the log output.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/e8402de31ac1434bb776c8820dfd3fe1.png" alt="Grafana"></p>
<h2 id="monitoring-panel">Monitoring Panel</h2>
<p>Here we illustrate monitoring Kubernetes events as an example. First you need to install [kubernetes-event-exporter] at <a href="https://github.com/opsgenie/kubernetes-event-exporter/tree/master/deploy">https://github.com/opsgenie/kubernetes-event-exporter/tree/master/deploy</a> and the <code>kubernetes-event- exporter</code> logs will be printed to stdout, and then our promtail will upload the logs to Loki.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/d1ace4fb739b4f4f939b755e61221c99.png" alt="Monitoring Panel"></p>
<p>Then import the Dashboard at <a href="https://grafana.com/grafana/dashboards/14003">https://grafana.com/grafana/dashboards/14003</a>, but be careful to change the filter tag in each chart to <code>job=&quot;monitoring/event-exporter&quot;</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/c1d73ff4c4304d17a6c817d1e104a4f6.png" alt="grafana dashboards"></p>
<p>After the modification, you can normally see the relevant event information in the cluster in Dashboard, but it is recommended to replace the query statement in the panel with a record rule.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/bd5a076bf97f4939a3e9942a7b670c39.png" alt="grafana dashboards"></p>
<h2 id="recommendations">Recommendations</h2>
<ol>
<li>
<p>try to use static labels, the overhead is smaller, usually logs are injected into labels before they are sent to Loki, the recommended static labels contain</p>
<ul>
<li>Host: kubernetes/hosts</li>
<li>Application name: kubernetes/labels/app_kubernetes_io/name</li>
<li>component name: kubernetes/labels/name</li>
<li>Namespace: kubernetes/namespace</li>
<li>Other static tags, such as environment, version, etc.</li>
</ul>
</li>
<li>
<p>Use dynamic tags with caution. Too many tag combinations can create a lot of streams, and it can make Loki store a lot of indexes and small chunks of object files. These can significantly consume Loki&rsquo;s query performance. To avoid these problems, <strong>don&rsquo;t add labels until you know you need them</strong>. Loki&rsquo;s strength lies in parallel querying, using filter expressions (label=&ldquo;text&rdquo;, |~ &ldquo;regex&rdquo;, &hellip;) to query the logs will be more efficient and fast.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/29/45caf201c7344ee2a859d44b5c24f079.png" alt="logql"></p>
</li>
<li>
<p>bounded range of tag values, as Loki users or operators our goal should be to use as few tags as possible to store your logs. This means that <strong>fewer tags lead to smaller indexes, which leads to better performance</strong>, so we should always think twice before adding tags.</p>
</li>
<li>
<p>configure caching, Loki can configure caching for multiple components, either redis or memcached, which can significantly improve performance.</p>
</li>
<li>
<p>use LogQL syntax wisely to dramatically improve query efficiency. label matchers (label matchers) are your first line of defense and are the best way to dramatically reduce the number of logs you search (for example, from 100TB to 1TB). Of course, this means you need to have good label definition specifications on the log collection side.</p>
</li>
</ol>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/grafana/">Grafana</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-func-caller/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to get the caller&#39;s function name, filename, and line number in a Go function</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/nginx-process-auto/">
            <span class="next-text nav-default">How to automatically set worker_processes for nginx containers</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
