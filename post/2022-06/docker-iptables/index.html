<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Docker and iptables - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use iptables as a firewall to restrict external access on a server with Docker." /><meta name="keywords" content="docker, iptables" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/docker-iptables/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Docker and iptables" />
<meta property="og:description" content="Learn how to use iptables as a firewall to restrict external access on a server with Docker." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/docker-iptables/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-09T15:26:57+08:00" />
<meta property="article:modified_time" content="2022-06-09T15:26:57+08:00" />

<meta itemprop="name" content="Docker and iptables">
<meta itemprop="description" content="Learn how to use iptables as a firewall to restrict external access on a server with Docker."><meta itemprop="datePublished" content="2022-06-09T15:26:57+08:00" />
<meta itemprop="dateModified" content="2022-06-09T15:26:57+08:00" />
<meta itemprop="wordCount" content="1411">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docker and iptables"/>
<meta name="twitter:description" content="Learn how to use iptables as a firewall to restrict external access on a server with Docker."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Docker and iptables</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-09 15:26:57 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1411 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#requirements">Requirements</a></li>
        <li><a href="#iptables--docker">Iptables &amp;&amp; Docker</a></li>
        <li><a href="#option-1">Option 1</a>
          <ul>
            <li><a href="#systems-rules">System&rsquo;s rules</a></li>
            <li><a href="#dockers-rules">docker&rsquo;s rules</a></li>
            <li><a href="#rules-for-the-docker-user-chain">Rules for the <code>DOCKER-USER</code> chain</a></li>
            <li><a href="#the-iptables-rule-at-this-point">The iptables rule at this point</a></li>
          </ul>
        </li>
        <li><a href="#option-2">Option 2</a>
          <ul>
            <li><a href="#create-the-iptablesconf-rule-file">Create the iptables.conf rule file</a></li>
            <li><a href="#create-system-services">Create system services</a></li>
            <li><a href="#the-iptables-rule-at-this-point-1">The iptables rule at this point</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="requirements">Requirements</h2>
<blockquote>
<p>Docker Server Version: 20.10.12</p>
</blockquote>
<p>On a server with Docker, I need to restrict external access using iptables as a firewall.</p>
<h2 id="iptables--docker">Iptables &amp;&amp; Docker</h2>
<p>iptables is divided into three levels: tables, chains and rules. We generally only use the filter table, which contains.</p>
<ul>
<li>INPUT, input chain. Packets sent to this machine pass through this chain.</li>
<li>OUTPUT, the output chain. Packets sent from this machine pass through this chain.</li>
<li>FORWARD, the forwarding chain. Packets forwarded by this machine pass through this chain.</li>
</ul>
<p>Since Docker connects the default virtual bridge (docker0) to the container&rsquo;s default gateway (ens33) via NAT (Network Address Translation) by default, setting INPUT is useless and the <strong>FORWARD chain</strong> should be set. And since the FORWARD chain defaults to <code>DROP</code> , all forwarding is blocked by <code>DOCKER-USER</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy DROP<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DOCKER-USER  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">DOCKER-ISOLATION-STAGE-1  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">DOCKER     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0   
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, we have to use the <code>DOCKER-USER</code> chain to set the container access rules, which is implemented as follows.</p>
<p><strong>Note: The firewall manager should be closed.</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Close the firewall manager</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> target in firewalld python-firewall firewalld-filesystem iptables<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  systemctl stop <span class="nv">$target</span> <span class="p">&amp;</span>&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  systemctl disable <span class="nv">$target</span> <span class="p">&amp;</span>&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="option-1">Option 1</h2>
<p>You need to install iptables-services: <code>yum install -y iptables-services</code>.</p>
<h3 id="systems-rules">System&rsquo;s rules</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 先允许所有,这里很重要，不加会被拒绝</span>
</span></span><span class="line"><span class="cl">iptables -P INPUT ACCEPT 
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">iptables -F  <span class="c1"># 清空所有默认规则</span>
</span></span><span class="line"><span class="cl">iptables -X  <span class="c1"># 清空所有自定义规则</span>
</span></span><span class="line"><span class="cl">iptables -Z  <span class="c1"># 所有计数器归0</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 对外开放的端口</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -p tcp -m multiport --dport <span class="m">22</span>  -j ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 允许ping</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -p icmp -j ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 允许主动连接其他主机</span>
</span></span><span class="line"><span class="cl">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 其他入站一律丢弃</span>
</span></span><span class="line"><span class="cl">iptables -P INPUT DROP
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 所有出站一律绿灯</span>
</span></span><span class="line"><span class="cl">iptables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 保存规则</span>
</span></span><span class="line"><span class="cl">service iptables save
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dockers-rules">docker&rsquo;s rules</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Restart docker, generate docker&#39;s rules</span>
</span></span><span class="line"><span class="cl">systemctl restart docker
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="rules-for-the-docker-user-chain">Rules for the <code>DOCKER-USER</code> chain</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 其他入站一律丢弃</span>
</span></span><span class="line"><span class="cl">iptables -I DOCKER-USER -i ens33 ! -s 127.0.0.1 -j DROP
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 允许主动连接其他主机</span>
</span></span><span class="line"><span class="cl">iptables -I DOCKER-USER -m state --state established,related -j ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">iptables -A DOCKER-USER -m conntrack --ctstate established,related -j ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 对外开放的端口</span>
</span></span><span class="line"><span class="cl">iptables -I DOCKER-USER -p tcp -m conntrack --ctorigdstport <span class="m">80</span>  -j ACCEPT
</span></span><span class="line"><span class="cl">iptables -I DOCKER-USER -p tcp -m conntrack --ctorigdstport <span class="m">443</span>  -j ACCEPT
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="c1"># 保存规则</span>
</span></span><span class="line"><span class="cl">service iptables save
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ens33 is my node&rsquo;s external network interface.</p>
</blockquote>
<h3 id="the-iptables-rule-at-this-point">The iptables rule at this point</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -n</span>
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy DROP<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport dports <span class="m">22</span>
</span></span><span class="line"><span class="cl">ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype <span class="m">0</span>
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy DROP<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DOCKER-USER  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">DOCKER-ISOLATION-STAGE-1  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">DOCKER     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            172.17.0.2           tcp dpt:8080
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            172.17.0.2           tcp dpt:80
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            172.17.0.3           tcp dpt:80
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER-ISOLATION-STAGE-1 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DOCKER-ISOLATION-STAGE-2  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER-ISOLATION-STAGE-2 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DROP       all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER-USER <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            ctorigdstport <span class="m">80</span>
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            ctorigdstport <span class="m">443</span>
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">DROP       all  -- !127.0.0.1            0.0.0.0/0                     
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0       
</span></span></code></pre></td></tr></table>
</div>
</div><p>This implementation has a drawback, that is, every time the docker container changes, you need to save the current iptables configuration, otherwise when restarting the iptables service, it will load the old rules, which will lead to confusing iptables rules.</p>
<h2 id="option-2">Option 2</h2>
<p>To solve the above problem, we can</p>
<ul>
<li>Create a new chain called FILTERS into which network traffic from INPUT and DOCKER-USER is placed, and store this configuration in a file.</li>
<li>Create an iptables systemd service to reload the iptables rules.</li>
</ul>
<blockquote>
<p>Here we don&rsquo;t need the system installation of iptables-services, use the command to uninstall it. <code>yum remove -y iptables-services</code></p>
</blockquote>
<h3 id="create-the-iptablesconf-rule-file">Create the iptables.conf rule file</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"> cat <span class="s">&lt;&lt;EOF &gt; /etc/iptables.conf
</span></span></span><span class="line"><span class="cl"><span class="s"> *filter
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> # Reset counters
</span></span></span><span class="line"><span class="cl"><span class="s"> :INPUT ACCEPT [0:0]
</span></span></span><span class="line"><span class="cl"><span class="s"> :FORWARD DROP [0:0]
</span></span></span><span class="line"><span class="cl"><span class="s"> :OUTPUT ACCEPT [0:0]
</span></span></span><span class="line"><span class="cl"><span class="s"> :DOCKER-USER - [0:0]
</span></span></span><span class="line"><span class="cl"><span class="s"> :FILTERS - [0:0]
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> # Flush
</span></span></span><span class="line"><span class="cl"><span class="s"> -F INPUT
</span></span></span><span class="line"><span class="cl"><span class="s"> -F DOCKER-USER
</span></span></span><span class="line"><span class="cl"><span class="s"> -F FILTERS
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> # Select
</span></span></span><span class="line"><span class="cl"><span class="s"> -A INPUT -i lo -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s"> -A INPUT -i ens33 -j FILTERS
</span></span></span><span class="line"><span class="cl"><span class="s"> -A DOCKER-USER -i ens33 -j FILTERS
</span></span></span><span class="line"><span class="cl"><span class="s"> -A DOCKER-USER -j RETURN
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> # Filters
</span></span></span><span class="line"><span class="cl"><span class="s"> ## icmp
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -p icmp --icmp-type any -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> ## Activate established connexions
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -m state --state ESTABLISHED,RELATED -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> ## Allow ssh
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -p tcp -m multiport --dport 22  -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> ## Allow all on http/https
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -p tcp -m tcp -m conntrack --ctorigdstport 80 -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -p tcp -m tcp -m conntrack --ctorigdstport 443 -j ACCEPT
</span></span></span><span class="line"><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="cl"><span class="s"> # Block all external
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -i ens33 -j DROP
</span></span></span><span class="line"><span class="cl"><span class="s"> -A FILTERS -j RETURN
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> ## Commit
</span></span></span><span class="line"><span class="cl"><span class="s"> COMMIT
</span></span></span><span class="line"><span class="cl"><span class="s"> EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ens33 is my node&rsquo;s external network interface</p>
</blockquote>
<h3 id="create-system-services">Create system services</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"> cat <span class="s">&lt;&lt; EOF &gt;  /usr/lib/systemd/system/iptables.service
</span></span></span><span class="line"><span class="cl"><span class="s"> [Unit]
</span></span></span><span class="line"><span class="cl"><span class="s"> Description=Restore iptables firewall rules
</span></span></span><span class="line"><span class="cl"><span class="s"> Before=network-pre.target
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> [Service]
</span></span></span><span class="line"><span class="cl"><span class="s"> Type=oneshot
</span></span></span><span class="line"><span class="cl"><span class="s"> ExecStart=/sbin/iptables-restore -n /etc/iptables.conf
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s"> [Install]
</span></span></span><span class="line"><span class="cl"><span class="s"> WantedBy=multi-user.target
</span></span></span><span class="line"><span class="cl"><span class="s"> EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> systemctl <span class="nb">enable</span> iptables
</span></span><span class="line"><span class="cl"> systemctl start iptables
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>iptables-restore -n turns off implicit global refresh and only performs our manual explicit refresh.</p>
</blockquote>
<h3 id="the-iptables-rule-at-this-point-1">The iptables rule at this point</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">FILTERS    all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy DROP<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DOCKER-USER  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">DOCKER-ISOLATION-STAGE-1  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">DOCKER     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER-ISOLATION-STAGE-1 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DOCKER-ISOLATION-STAGE-2  all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER-ISOLATION-STAGE-2 <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">DROP       all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain DOCKER-USER <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">FILTERS    all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">Chain FILTERS <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination         
</span></span><span class="line"><span class="cl">ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0            icmptype <span class="m">255</span>
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport dports <span class="m">22</span>
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp ctorigdstport <span class="m">80</span>
</span></span><span class="line"><span class="cl">ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp ctorigdstport <span class="m">443</span>
</span></span><span class="line"><span class="cl">DROP       all  --  0.0.0.0/0            0.0.0.0/0           
</span></span><span class="line"><span class="cl">RETURN     all  --  0.0.0.0/0            0.0.0.0/0           
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we need to update the rules, just edit the <code>/etc/iptables.conf</code> file and execute <code>systemctl restart iptables</code> to reload the rules.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/kube-prometheus-namespace/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">kube-prometheus adds a new namespace to the promethues monitor</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/docker-macos/">
            <span class="next-text nav-default">How to use Docker on Mac</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
