<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Basic policies for iptables and firewalld in CentOS - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article briefly describes the basic operation and configuration of iptables and firewalld in CentOS as a test environment." /><meta name="keywords" content="centos, iptables, firewalld" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/iptables-and-firewalld/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Basic policies for iptables and firewalld in CentOS" />
<meta property="og:description" content="This article briefly describes the basic operation and configuration of iptables and firewalld in CentOS as a test environment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/iptables-and-firewalld/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-07T12:39:02+08:00" />
<meta property="article:modified_time" content="2022-06-07T12:39:02+08:00" />

<meta itemprop="name" content="Basic policies for iptables and firewalld in CentOS">
<meta itemprop="description" content="This article briefly describes the basic operation and configuration of iptables and firewalld in CentOS as a test environment."><meta itemprop="datePublished" content="2022-06-07T12:39:02+08:00" />
<meta itemprop="dateModified" content="2022-06-07T12:39:02+08:00" />
<meta itemprop="wordCount" content="4103">
<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Basic policies for iptables and firewalld in CentOS"/>
<meta name="twitter:description" content="This article briefly describes the basic operation and configuration of iptables and firewalld in CentOS as a test environment."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Basic policies for iptables and firewalld in CentOS</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-07 12:39:02 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4103 words </span>
          <span class="more-meta"> 20 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#iptables-basic-concepts-and-operations">iptables basic concepts and operations</a>
          <ul>
            <li><a href="#policy-chain">Policy Chain</a></li>
            <li><a href="#chain-rules">Chain rules</a></li>
            <li><a href="#custom-chains">Custom Chains</a></li>
            <li><a href="#save-and-restore">Save and Restore</a></li>
          </ul>
        </li>
        <li><a href="#firewalld-basic-concepts-and-operations">firewalld Basic Concepts and Operations</a>
          <ul>
            <li><a href="#network-zones-zone">Network zones (ZONE)</a></li>
            <li><a href="#open-ports">Open ports</a></li>
            <li><a href="#forwarding-port">Forwarding Port</a></li>
            <li><a href="#rich-language">Rich Language</a></li>
          </ul>
        </li>
        <li><a href="#firewalld-and-iptables">firewalld and iptables</a>
          <ul>
            <li><a href="#all-tables-of-iptables">All tables of iptables</a></li>
            <li><a href="#filter-table-basic-policy">filter table basic policy</a></li>
            <li><a href="#firewalld-add-port-policy">firewalld add port policy</a></li>
            <li><a href="#nat-table-basic-policy">nat table basic policy</a></li>
            <li><a href="#firewalld-add-port-forwarding-policy">firewalld add port forwarding policy</a></li>
          </ul>
        </li>
        <li><a href="#ending">Ending</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>firewalld in CentOS is built on iptables and some other programs. firewalld uses some more friendly configuration methods to implement iptables operations. It also extends some features that are not supported by iptables itself, such as timed firewall rules. The full program and library dependencies are available on the firewalld website at <a href="https://firewalld.org/">https://firewalld.org/</a>.</p>
<p>iptables processes network packets by manipulating the Linux kernel netfilter module.</p>
<p>Please temporarily disable the firewalld firewall on your machine before operating the command, <em><strong>and make sure you have access to the physical machine</strong></em> (or a physical terminal in a virtual machine), as some rules will block access to SSH port 22 and prevent subsequent operations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># stop firewalld</span>
</span></span><span class="line"><span class="cl">systemctl stop firewalld
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="iptables-basic-concepts-and-operations">iptables basic concepts and operations</h2>
<h3 id="policy-chain">Policy Chain</h3>
<p>The iptables filtering rules are used to determine the processing of packets in different situations by matching the rules in a policy chain, which contains three policy chains.</p>
<ul>
<li><strong>INPUT</strong> : This chain is used to control incoming connections and packets, such as allowing SSH incoming connections from certain IPs.</li>
<li><strong>FORWARD</strong> : Forwarding control link, this chain is used if you need to configure routing features on the machine.</li>
<li><strong>OUTPUT</strong> : Outgoing chain, this chain is matched when the current host sends a request to the outside, and usually no special rules are configured for it when there is no special need.</li>
</ul>
<p>You can view the currently set iptables rules with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-P INPUT ACCEPT
</span></span><span class="line"><span class="cl">-P FORWARD ACCEPT
</span></span><span class="line"><span class="cl">-P OUTPUT ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="policy-chain-default-behavior">Policy Chain Default Behavior</h4>
<p>The corresponding policy chain will have a default behavior. It means that the chain is defined to handle packets when it does not match any rule.</p>
<p>Use the following command to view the behavior of the current policy chain (the number of packets and traffic not matching this chain are also output).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># iptables -L -v | grep policy</span>
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT <span class="m">0</span> packets, <span class="m">0</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy ACCEPT <span class="m">0</span> packets, <span class="m">0</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT <span class="m">821</span> packets, 293K bytes<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the current policy chain does not behave as shown above, the following command can be used to set the behavior of accepting all data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -P INPUT ACCEPT
</span></span><span class="line"><span class="cl">iptables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">iptables -P FORWARD ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following command can be tried to discard packets in all cases.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -P INPUT DROP
</span></span><span class="line"><span class="cl">iptables -P OUTPUT DROP
</span></span><span class="line"><span class="cl">iptables -P FORWARD DROP
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note: At this point, the external host will not be able to access the host, and the internal host will not be able to access the external.</p>
<h4 id="response-of-the-chain">Response of the chain</h4>
<p>With the default policy chain in place, custom rules can be added. When matching a rule that matches the requirements (e.g. target port/source of data) how you want the data to be processed.</p>
<p>The following three &ldquo;responses&rdquo; are commonly used for chaining</p>
<ul>
<li><strong>ACCEPT</strong> : All connections and data are allowed.</li>
<li><strong>DROP</strong> : Drops the connection. The sender will be unaware, as if the host does not exist.</li>
<li><strong>REJECT</strong>: Connection is rejected and an error message is returned. The sender will know that the request was blocked by the firewall.</li>
</ul>
<p>The behavior of the peer machine configured with different INPUT policy chains can be tested with the ping command.</p>
<p>ACCEPT:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -P INPUT ACCEPT</span>
</span></span><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># ping 10.1.1.50 -c 1</span>
</span></span><span class="line"><span class="cl">PING 10.1.1.50 <span class="o">(</span>10.1.1.50<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 10.1.1.50: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.227 ms
</span></span><span class="line"><span class="cl">--- 10.1.1.50 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">1</span> packets transmitted, <span class="m">1</span> received, 0% packet loss, <span class="nb">time</span> 0ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.227/0.227/0.227/0.000 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>DROP:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -P INPUT DROP</span>
</span></span><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># ping 10.1.1.50 -c 1</span>
</span></span><span class="line"><span class="cl">PING 10.1.1.50 <span class="o">(</span>10.1.1.50<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl">--- 10.1.1.50 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">1</span> packets transmitted, <span class="m">0</span> received, 100% packet loss, <span class="nb">time</span> 0ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>REJECT:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -A INPUT -j REJECT</span>
</span></span><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># ping 10.1.1.50 -c 1</span>
</span></span><span class="line"><span class="cl">PING 10.1.1.50 <span class="o">(</span>10.1.1.50<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl">From 10.1.1.50 <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> Destination Port Unreachable
</span></span><span class="line"><span class="cl">--- 10.1.1.50 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">1</span> packets transmitted, <span class="m">0</span> received, +1 errors, 100% packet loss, <span class="nb">time</span> 0ms
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Strictly speaking, ACCEPT and DROP are the target of the chain, while REJECT is the target extension, so REJECT cannot be configured for chains, only REJECT rules can be added to chains.</p>
</blockquote>
<h3 id="chain-rules">Chain rules</h3>
<p>Once the chain is configured, rules can be added to it. For adding a rule, use a command of the following form.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -A &lt;chain name&gt; <span class="o">[</span>optional match rule<span class="o">]</span> -j &lt;target&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The targets include custom chains in addition to the ACCEPT/DROP/REJECT mentioned above, as well as other extended targets.</p>
<p>Before attempting to follow up, keep in mind the following command to reset the firewall.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -X <span class="c1"># Delete all user definitions</span>
</span></span><span class="line"><span class="cl">iptables -F <span class="c1"># Rules for refreshing the chain</span>
</span></span><span class="line"><span class="cl"><span class="c1"># If the policy chain is modified</span>
</span></span><span class="line"><span class="cl">iptables -P INPUT ACCEPT
</span></span><span class="line"><span class="cl">iptables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">iptables -P FORWARD ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="drops-all-icmp-protocols">drops all ICMP protocols</h4>
<p>External pinging of the current host will prompt a timeout. The current machine will not be detected when using the traceroute command for route tracing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -A INPUT -p icmp -j DROP
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="allowed-connection-ports-only">Allowed connection ports only</h4>
<p>Configure the INPUT policy chain to default to DROP first and then configure allow rules for it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -P INPUT DROP
</span></span><span class="line"><span class="cl">iptables -A INPUT -p tcp --dport<span class="o">=</span><span class="m">22</span> -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="discards-data-from-a-specified-source">discards data from a specified source</h4>
<p>Data from a fixed IP can be specified to be discarded.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -A INPUT -s 10.1.1.50 -j DROP
</span></span></code></pre></td></tr></table>
</div>
</div><p>Or, to discard all data under the source segment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -A INPUT -s 10.1.1.0/24 -j DROP
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="custom-chains">Custom Chains</h3>
<p>Chains can be created, and custom chains can be added to INPUT policy chains after adding rules using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -N mychain
</span></span><span class="line"><span class="cl">iptables -A mychain -p ICMP -j DROP
</span></span><span class="line"><span class="cl">iptables -A INPUT -j mychain
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the addition is complete the configuration is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># iptables -L</span>
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">mychain    all  --  anywhere             anywhere
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain mychain <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl">target     prot opt <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">DROP       icmp --  anywhere             anywhere
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the default behavior of the INPUT policy chain is ACCEPT, with an arbitrary matching rule targeting mychain.</p>
<p>So when matching input data, all data tries to match mychain&rsquo;s rules.</p>
<p>In mychain, if the matching protocol is ICMP, the data is discarded.</p>
<h3 id="save-and-restore">Save and Restore</h3>
<p>If you do not execute the command to save the configuration, all changes will be discarded after a system reboot.</p>
<p>Use the iptables-save command to save changes to take effect after a reboot and output the configuration save command.</p>
<p>Use iptables-restore to read in the configuration from standard input and restore it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables-save &gt; myconfig
</span></span><span class="line"><span class="cl">iptables-restore &lt; myconfig
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="firewalld-basic-concepts-and-operations">firewalld Basic Concepts and Operations</h2>
<p>Make sure firewalld is started before operating it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Confirm Status</span>
</span></span><span class="line"><span class="cl">systemctl status firewalld
</span></span><span class="line"><span class="cl"><span class="c1"># start</span>
</span></span><span class="line"><span class="cl">systemctl start firewalld
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="network-zones-zone">Network zones (ZONE)</h3>
<p>The firewall presets a number of network zones, and the system assigns network interfaces to public zones by default.</p>
<blockquote>
<p>The firewall preset configuration files are defined in the <strong>/usr/lib/firewalld/zones</strong> directory, and the user-defined files are in the <strong>/etc/firewalld/zones</strong> directory. The detailed policy and format can be found in firewalld.zone(5), or see the linked article at the end of this article.</p>
</blockquote>
<p>In the initial state, the <strong>firewall-cmd -list-all</strong> command allows you to get the status of the default network zone public.</p>
<blockquote>
<p>To modify the default network zone, edit the DefaultZone field in the <strong>/etc/firewalld/firewalld.conf</strong> file.</p>
</blockquote>
<p>Use <strong>firewall-cmd -list-all-zones</strong> to display all network zone configurations.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># firewall-cmd --list-all</span>
</span></span><span class="line"><span class="cl">public <span class="o">(</span>active<span class="o">)</span>
</span></span><span class="line"><span class="cl">  target: default
</span></span><span class="line"><span class="cl">  icmp-block-inversion: no
</span></span><span class="line"><span class="cl">  interfaces: ens192
</span></span><span class="line"><span class="cl">  sources:
</span></span><span class="line"><span class="cl">  services: dhcpv6-client ssh
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  protocols:
</span></span><span class="line"><span class="cl">  masquerade: no
</span></span><span class="line"><span class="cl">  forward-ports:
</span></span><span class="line"><span class="cl">  source-ports:
</span></span><span class="line"><span class="cl">  icmp-blocks:
</span></span><span class="line"><span class="cl">  rich rules:
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="open-ports">Open ports</h3>
<p>You can open the port by direct command, please use reload command to reload the firewall configuration after the configuration is done.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --add-port<span class="o">=</span>8080/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>Port access can be removed using the corresponding remove-port command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --remove-port<span class="o">=</span>8080/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>Please note</strong>: To set permanent settings, add the <strong>-permanent</strong> option, which will be added to all relevant firewall commands below without exception.</p>
</blockquote>
<p>Open ports by configuring the service file.</p>
<p>In the initial configuration, only two services, dhcpv6-client and ssh, are open for external access in the public network area of firewalld. They are exposed on ports 546/udp/ipv6 and 22/tcp.</p>
<p>A set of service configuration files described in XML is defined in the <strong>/usr/lib/firewalld/services</strong> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">]</span><span class="c1"># cat /usr/lib/firewalld/services/ssh.xml</span>
</span></span><span class="line"><span class="cl">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>?&gt;
</span></span><span class="line"><span class="cl">&lt;service&gt;
</span></span><span class="line"><span class="cl">  &lt;short&gt;SSH&lt;/short&gt;
</span></span><span class="line"><span class="cl">  &lt;port <span class="nv">protocol</span><span class="o">=</span><span class="s2">&#34;tcp&#34;</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&#34;22&#34;</span>/&gt;
</span></span><span class="line"><span class="cl">&lt;/service&gt;
</span></span><span class="line"><span class="cl"><span class="o">]</span><span class="c1"># cat /usr/lib/firewalld/services/dhcpv6-client.xml</span>
</span></span><span class="line"><span class="cl">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>?&gt;
</span></span><span class="line"><span class="cl">&lt;service&gt;
</span></span><span class="line"><span class="cl">  &lt;short&gt;DHCPv6 Client&lt;/short&gt;
</span></span><span class="line"><span class="cl">  &lt;port <span class="nv">protocol</span><span class="o">=</span><span class="s2">&#34;udp&#34;</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&#34;546&#34;</span>/&gt;
</span></span><span class="line"><span class="cl">  &lt;destination <span class="nv">ipv6</span><span class="o">=</span><span class="s2">&#34;fe80::/64&#34;</span>/&gt;
</span></span><span class="line"><span class="cl">&lt;/service&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Copy the SSH service as a template to the user configuration directory. and modify port 22 to 8080, the contents of the file are as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cp /usr/lib/firewalld/services/ssh.xml /etc/firewalld/services/myweb.xml
</span></span><span class="line"><span class="cl"><span class="o">]</span><span class="c1"># cat /etc/firewalld/services/myweb.xml</span>
</span></span><span class="line"><span class="cl">&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>?&gt;
</span></span><span class="line"><span class="cl">&lt;service&gt;
</span></span><span class="line"><span class="cl">  &lt;short&gt;MYWEB&lt;/short&gt;
</span></span><span class="line"><span class="cl">  &lt;port <span class="nv">protocol</span><span class="o">=</span><span class="s2">&#34;tcp&#34;</span> <span class="nv">port</span><span class="o">=</span><span class="s2">&#34;8080&#34;</span>/&gt;
</span></span><span class="line"><span class="cl">&lt;/service&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next step is to open the port by means of a service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># add</span>
</span></span><span class="line"><span class="cl">firewall-cmd --zone public --add-service<span class="o">=</span>myweb --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span><span class="line"><span class="cl"><span class="c1"># remove</span>
</span></span><span class="line"><span class="cl">firewall-cmd --zone public --add-service<span class="o">=</span>myweb --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>A simple HTTP server can be started in Python to test whether port 8080 is open.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Python 2.x</span>
</span></span><span class="line"><span class="cl">python -m SimpleHTTPServer <span class="m">8080</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Python 3.x</span>
</span></span><span class="line"><span class="cl">python -m http.server <span class="m">8080</span>
</span></span><span class="line"><span class="cl">curl -v &lt;host&gt;:8080
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="forwarding-port">Forwarding Port</h3>
<p>By configuring the forwarding port, you can forward the data accessing the specified port to other specified host ports, here is the example of the current host, forwarding all accesses to port 8080 to 8081.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --add-forward-port<span class="o">=</span><span class="nv">port</span><span class="o">=</span>8080:proto<span class="o">=</span>tcp:toport<span class="o">=</span><span class="m">8081</span> --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>The preceding Python command starts an HTTP server with port 8081, at which point external access to the data on port 8080 of the current host will be able to access the content directly.</p>
<p>The corresponding command to remove forwarding is also</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --remove-forward-port<span class="o">=</span><span class="nv">port</span><span class="o">=</span>8080:proto<span class="o">=</span>tcp:toport<span class="o">=</span><span class="m">8081</span> --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="rich-language">Rich Language</h3>
<p>Use Rich Language to create relatively complex rule configurations, such as restricting tcp port 8080 under ipv4 to be accessed only by the 10.1.1.0/2 network segment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># add</span>
</span></span><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --add-rich-rule<span class="o">=</span><span class="s1">&#39;rule family=ipv4 source address=10.1.1.0/24 port port=8080 protocol=tcp accept&#39;</span> --permanent
</span></span><span class="line"><span class="cl"><span class="c1"># remove</span>
</span></span><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --remove-rich-rule<span class="o">=</span><span class="s1">&#39;rule family=ipv4 source address=10.1.1.0/24 port port=8080 protocol=tcp accept&#39;</span> --permanent
</span></span></code></pre></td></tr></table>
</div>
</div><p>Rich Languange is an abstract representation of the iptables utility.</p>
<blockquote>
<p>The full format description can be found in firewalld.zone(5), but in XML format.</p>
</blockquote>
<h2 id="firewalld-and-iptables">firewalld and iptables</h2>
<h3 id="all-tables-of-iptables">All tables of iptables</h3>
<p>Before discussing firewalld in relation to iptables, it is important to briefly understand all the tables in iptables.</p>
<p>iptables supports five tables to provide configuration in various environments.</p>
<h4 id="filter-table">filter table</h4>
<p>The default table with three built-in chains: <strong>INPUT</strong> (for packets destined for local sockets), <strong>FORWARD</strong> (for packets routed through the local machine), <strong>OUTPUT</strong> (for locally generated packets).</p>
<h4 id="nat-table">nat table</h4>
<p>This table is queried when packets are encountered for creating new connections. It contains three built-in chains: <strong>PREROUTING</strong> (for modifying packets as soon as they come in), <strong>OUTPUT</strong> (for modifying locally generated packets before routing), and <strong>POSTROUTING</strong> (for modifying packets before they come out).</p>
<blockquote>
<p>NAT support for IPV6 from Linux kernel version 3.7</p>
</blockquote>
<h4 id="mangle-table">mangle table</h4>
<p>This table is dedicated to packet modifications. Until Linux kernel 2.4.17 only two chains were supported: <strong>PREROUTING</strong> (for modifying incoming packets before routing) and <strong>OUTPUT</strong> (for modifying locally generated packets before routing). Starting with kernel 2.4.18, three additional chains are supported: <strong>INPUT</strong> (for sending to the local machine before), <strong>FORWARD</strong> (for routing packets through the local machine), and <strong>POSTROUTING</strong> (for modifying data before the packet is passed out).</p>
<h4 id="raw-table">raw table</h4>
<p>This table is primarily used to configure <em>exemptions from connection tracking</em> in conjunction with the NOTRACK target. It has a higher priority for netfilter hook registration and is invoked before ip_conntrack and any other IP table. It contains two chains: <strong>PREROUTING</strong> (for packets arriving through any network interface), and <strong>OUTPUT</strong> (for any packets generated by the local program).</p>
<h4 id="security-table">security Table</h4>
<p>Used for Mandatory Access Control (MAC) network rules. It is a security policy, not discussed in detail in the text, which contains two chains: <strong>INPUT</strong> / <strong>OUTPUT</strong>.</p>
<p>The order of the call chains between the regular tables.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/07/e3609123d79649158c900001d48d2b97.png" alt="Order of call chains between regular tables"></p>
<h3 id="filter-table-basic-policy">filter table basic policy</h3>
<p>When the firewalld firewall is in its initial state.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~<span class="o">]</span><span class="c1"># firewall-cmd --list-all</span>
</span></span><span class="line"><span class="cl">public <span class="o">(</span>active<span class="o">)</span>
</span></span><span class="line"><span class="cl">  target: default
</span></span><span class="line"><span class="cl">  icmp-block-inversion: no
</span></span><span class="line"><span class="cl">  interfaces: ens192
</span></span><span class="line"><span class="cl">  sources:
</span></span><span class="line"><span class="cl">  services: dhcpv6-client ssh
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  protocols:
</span></span><span class="line"><span class="cl">  masquerade: no
</span></span><span class="line"><span class="cl">  forward-ports:
</span></span><span class="line"><span class="cl">  source-ports:
</span></span><span class="line"><span class="cl">  icmp-blocks:
</span></span><span class="line"><span class="cl">  rich rules:
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="input-chain">INPUT chain</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/07/32f82b563fbf438ba7c81e30f7a5a34f.png" alt="INPUT chain"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT <span class="m">0</span> packets, <span class="m">0</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">  <span class="m">677</span> <span class="m">46644</span> ACCEPT     all  --  any    any     anywhere             anywhere             ctstate RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     all  --  lo     any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> INPUT_direct  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> INPUT_ZONES_SOURCE  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> INPUT_ZONES  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> DROP       all  --  any    any     anywhere             anywhere             ctstate INVALID
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-host-prohibited
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span class="line"><span class="cl">-A INPUT -i lo -j ACCEPT
</span></span><span class="line"><span class="cl">-A INPUT -j INPUT_direct
</span></span><span class="line"><span class="cl">-A INPUT -j INPUT_ZONES_SOURCE
</span></span><span class="line"><span class="cl">-A INPUT -j INPUT_ZONES
</span></span><span class="line"><span class="cl">-A INPUT -m conntrack --ctstate INVALID -j DROP
</span></span><span class="line"><span class="cl">-A INPUT -j REJECT --reject-with icmp-host-prohibited
</span></span></code></pre></td></tr></table>
</div>
</div><p>It first accepts all established connections, as well as all data from the lo network interface (local loopback).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span class="line"><span class="cl">-A INPUT -i lo -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>The two custom chain rules with target INPUT_direct / INPUT_ZONES_SOURCE are empty and reserved for specific firewalld configuration functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain INPUT_ZONES_SOURCE <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">Chain INPUT_direct <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A INPUT -j INPUT_direct
</span></span><span class="line"><span class="cl">-A INPUT -j INPUT_ZONES_SOURCE
</span></span></code></pre></td></tr></table>
</div>
</div><p>The INPUT_ZONES target contains the configuration of the network zone under.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain INPUT_ZONES <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> IN_public  all  --  ens192 any     anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> IN_public  all  --  +      any     anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>
</span></span><span class="line"><span class="cl">Chain IN_public <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> IN_public_log  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> IN_public_deny  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> IN_public_allow  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     icmp --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">Chain IN_public_allow <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh ctstate NEW,UNTRACKED
</span></span><span class="line"><span class="cl">Chain IN_public_deny <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">Chain IN_public_log <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A INPUT_ZONES -i ens192 -g IN_public
</span></span><span class="line"><span class="cl">-A INPUT_ZONES -g IN_public
</span></span><span class="line"><span class="cl">-A IN_public -j IN_public_log
</span></span><span class="line"><span class="cl">-A IN_public -j IN_public_deny
</span></span><span class="line"><span class="cl">-A IN_public -j IN_public_allow
</span></span><span class="line"><span class="cl">-A IN_public -p icmp -j ACCEPT
</span></span><span class="line"><span class="cl">-A IN_public_allow -p tcp -m tcp --dport <span class="m">22</span> -m conntrack --ctstate NEW,UNTRACKED -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>The INPUT_ZONES chain contains chains named <code>IN_&lt;network_zone&gt;</code>, which will also match the network interface. The default network zone will be the last matching rule.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">-A INPUT_ZONES -i ens192 -g IN_public <span class="c1"># ens192 is assigned to the public network zone</span>
</span></span><span class="line"><span class="cl">-A INPUT_ZONES -g IN_public <span class="c1"># The default network zone is public</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>IN_public contains four rules, adds three chain targets: IN_public_log / IN_public_deny / IN_public_allow, and accepts all ICMP requests. The IN_public_log / IN_public_deny rule is empty and reserved for specific functions.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">-A IN_public -j IN_public_log
</span></span><span class="line"><span class="cl">-A IN_public -j IN_public_deny
</span></span><span class="line"><span class="cl">-A IN_public -j IN_public_allow
</span></span><span class="line"><span class="cl">-A IN_public -p icmp -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>The actual pass rule is contained in IN_public_allow, which allows port 22.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain IN_public_allow <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh ctstate NEW,UNTRACKED
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A IN_public_allow -p tcp -m tcp --dport <span class="m">22</span> -m conntrack --ctstate NEW,UNTRACKED -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>At the end of the chain of INPUT, if no rule is matched, all invalid packets are discarded and all other requests are rejected.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">-A INPUT -m conntrack --ctstate INVALID -j DROP
</span></span><span class="line"><span class="cl">-A INPUT -j REJECT --reject-with icmp-host-prohibited
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="forward-chain">FORWARD chain</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/07/830dba4098764b5780d73e9416676fc4.png" alt="FORWARD chain"></p>
<p>The FORWARD chain is very similar to the INPUT chain in the filter table, except that for network zones, custom chains are distinguished between IN and OUT.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain FORWARD <span class="o">(</span>policy ACCEPT <span class="m">0</span> packets, <span class="m">0</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     all  --  any    any     anywhere             anywhere             ctstate RELATED,ESTABLISHED
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     all  --  lo     any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FORWARD_direct  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FORWARD_IN_ZONES_SOURCE  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FORWARD_IN_ZONES  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FORWARD_OUT_ZONES_SOURCE  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FORWARD_OUT_ZONES  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> DROP       all  --  any    any     anywhere             anywhere             ctstate INVALID
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-host-prohibited
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</span></span><span class="line"><span class="cl">-A FORWARD -i lo -j ACCEPT
</span></span><span class="line"><span class="cl">-A FORWARD -j FORWARD_direct
</span></span><span class="line"><span class="cl">-A FORWARD -j FORWARD_IN_ZONES_SOURCE
</span></span><span class="line"><span class="cl">-A FORWARD -j FORWARD_IN_ZONES
</span></span><span class="line"><span class="cl">-A FORWARD -j FORWARD_OUT_ZONES_SOURCE
</span></span><span class="line"><span class="cl">-A FORWARD -j FORWARD_OUT_ZONES
</span></span><span class="line"><span class="cl">-A FORWARD -m conntrack --ctstate INVALID -j DROP
</span></span><span class="line"><span class="cl">-A FORWARD -j REJECT --reject-with icmp-host-prohibited
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the FORWARD_IN_ZONES chain, match all input data from the web interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain FORWARD_IN_ZONES <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDI_public  all  --  ens192 any     anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDI_public  all  --  +      any     anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>
</span></span><span class="line"><span class="cl">Chain FWDI_public <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDI_public_log  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDI_public_deny  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDI_public_allow  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     icmp --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A FORWARD_IN_ZONES -i ens192 -g FWDI_public
</span></span><span class="line"><span class="cl">-A FORWARD_IN_ZONES -g FWDI_public
</span></span><span class="line"><span class="cl">-A FWDI_public -j FWDI_public_log
</span></span><span class="line"><span class="cl">-A FWDI_public -j FWDI_public_deny
</span></span><span class="line"><span class="cl">-A FWDI_public -j FWDI_public_allow
</span></span><span class="line"><span class="cl">-A FWDI_public -p icmp -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the FORWARD_OUT_ZONES chain, match all outputs to the web interface for all data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -L -v</span>
</span></span><span class="line"><span class="cl">Chain FORWARD_OUT_ZONES <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDO_public  all  --  any    ens192  anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDO_public  all  --  any    +       anywhere             anywhere            <span class="o">[</span>goto<span class="o">]</span>
</span></span><span class="line"><span class="cl">Chain FWDO_public <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDO_public_log  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDO_public_deny  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> FWDO_public_allow  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl"><span class="c1"># iptables -S</span>
</span></span><span class="line"><span class="cl">-A FORWARD_OUT_ZONES -o ens192 -g FWDO_public
</span></span><span class="line"><span class="cl">-A FORWARD_OUT_ZONES -g FWDO_public
</span></span><span class="line"><span class="cl">-A FWDO_public -j FWDO_public_log
</span></span><span class="line"><span class="cl">-A FWDO_public -j FWDO_public_deny
</span></span><span class="line"><span class="cl">-A FWDO_public -j FWDO_public_allow
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, under the initial firewalld configuration, all data under the FORWARD chain is discarded or rejected except for the match in FWDI_public to allow incoming ICMP protocols from the ens192 network interface.</p>
<h4 id="output-chain">OUTPUT chain</h4>
<p>The rules for the OUTPUT chain are simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT <span class="m">699</span> packets, 117K bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">    <span class="m">0</span>     <span class="m">0</span> ACCEPT     all  --  any    lo      anywhere             anywhere
</span></span><span class="line"><span class="cl">  <span class="m">699</span>  117K OUTPUT_direct  all  --  any    any     anywhere             anywhere
</span></span><span class="line"><span class="cl">Chain OUTPUT_direct <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span></code></pre></td></tr></table>
</div>
</div><p>For local loopback data pass directly, otherwise match the OUTPUT_direct link used for the rule configuration of firewalld, with an initial rule of null. If not matched, then use the policy ACCEPT for the OUTPUT chain to allow all data to pass.</p>
<h3 id="firewalld-add-port-policy">firewalld add port policy</h3>
<p>Add ports directly in firewalld via services or commands, and via Rich Language as well.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --add-port<span class="o">=</span>8080/tcp --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --add-rich-rule<span class="o">=</span><span class="s1">&#39;rule family=ipv4 source address=10.1.1.0/24 port port=8081 protocol=tcp accept&#39;</span> --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>It will be added directly to IN_public_allow:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">INPUT
</span></span><span class="line"><span class="cl">  |
</span></span><span class="line"><span class="cl">  | - INPUT_direct
</span></span><span class="line"><span class="cl">  | - INPUT_ZONES_SOURCE
</span></span><span class="line"><span class="cl">  | - INPUT_ZONES
</span></span><span class="line"><span class="cl">         |
</span></span><span class="line"><span class="cl">         | - IN_public (-A INPUT_ZONES -i ens192 -g IN_public)
</span></span><span class="line"><span class="cl">               |
</span></span><span class="line"><span class="cl">               | - IN_public_log
</span></span><span class="line"><span class="cl">               | - IN_public_deny
</span></span><span class="line"><span class="cl">               | - IN_public_allow
</span></span><span class="line"><span class="cl">               |      |
</span></span><span class="line"><span class="cl">               |      | -A IN_public_allow -p tcp -m tcp --dport 8080 -m conntrack --ctstate NEW,UNTRACKED -j ACCEPT
</span></span><span class="line"><span class="cl">               |      | -A IN_public_allow -s 10.1.1.0/24 -p tcp -m tcp --dport 8081 -m conntrack --ctstate NEW,UNTRACKED -j ACCEPT
</span></span><span class="line"><span class="cl">               | - ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alternatively, the table and chain of iptables can be specified using firewalld&rsquo;s direct add rule command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --direct --add-rule ipv4 filter IN_public_allow <span class="m">0</span> -m tcp -p tcp --dport <span class="m">8080</span> -j ACCEPT
</span></span></code></pre></td></tr></table>
</div>
</div><p>It can also be added directly to the INPUT_direct table, which will match rules before the network zone chain INPUT_ZONES.</p>
<h3 id="nat-table-basic-policy">nat table basic policy</h3>
<h4 id="prerouting-and-postrouting-chains">PREROUTING and POSTROUTING chains</h4>
<p>The PREROUTING / POSTROUTING chain in the nat table has a similar configuration policy to the INPUT chain in the filter table, and only PREROUTING is listed here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">PREROUTING (policy ACCEPT)
</span></span><span class="line"><span class="cl">  |
</span></span><span class="line"><span class="cl">  | - PREROUTING_direct
</span></span><span class="line"><span class="cl">  | - PREROUTING_ZONES_SOURCE
</span></span><span class="line"><span class="cl">  | - PREROUTING_ZONES
</span></span><span class="line"><span class="cl">      |
</span></span><span class="line"><span class="cl">      | - PRE_public (-A PREROUTING_ZONES -i ens192 -g PRE_public)
</span></span><span class="line"><span class="cl">            |
</span></span><span class="line"><span class="cl">            | - PRE_public_log
</span></span><span class="line"><span class="cl">            | - PRE_public_deny
</span></span><span class="line"><span class="cl">            | - PRE_public_allow
</span></span><span class="line"><span class="cl">      | - PRE_public (-A POSTROUTING_ZONES -g POST_public)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="input-and-output-chains">INPUT and OUTPUT chains</h4>
<p>The default configuration provided by firewalld in the nat table is simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># iptables -t nat -L -v</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain INPUT <span class="o">(</span>policy ACCEPT <span class="m">0</span> packets, <span class="m">0</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Chain OUTPUT <span class="o">(</span>policy ACCEPT <span class="m">16</span> packets, <span class="m">2377</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl"> pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
</span></span><span class="line"><span class="cl">   <span class="m">16</span>  <span class="m">2377</span> OUTPUT_direct  all  --  any    any     anywhere             anywhere
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="firewalld-add-port-forwarding-policy">firewalld add port forwarding policy</h3>
<p>The preceding port forwarding configuration is an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">firewall-cmd --zone<span class="o">=</span>public --add-forward-port<span class="o">=</span><span class="nv">port</span><span class="o">=</span>8080:proto<span class="o">=</span>tcp:toport<span class="o">=</span><span class="m">8081</span> --permanent
</span></span><span class="line"><span class="cl">firewall-cmd --reload
</span></span></code></pre></td></tr></table>
</div>
</div><p>firewalld adds the following rules to each of the mangle and nat tables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># mangle</span>
</span></span><span class="line"><span class="cl">-A PRE_public_allow -p tcp -m tcp --dport <span class="m">8080</span> -j MARK --set-xmark 0x64/0xffffffff
</span></span><span class="line"><span class="cl"><span class="c1"># nat</span>
</span></span><span class="line"><span class="cl">-A PRE_public_allow -p tcp -m mark --mark 0x64 -j DNAT --to-destination :8081
</span></span></code></pre></td></tr></table>
</div>
</div><p>The mange table marks all packets from port 8080/tcp in the PREROUTING phase with a 0x64/0xffffffff, the former being the value and the latter being the mask. The result is heterogeneously added to <strong>ctmark</strong>. <strong>ctmark</strong> is a 32-bit marker value provided by netfilter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># set-xmark Pseudocode description</span>
</span></span><span class="line"><span class="cl"><span class="nv">xmark</span> <span class="o">=</span> xmark <span class="p">|</span> <span class="o">(</span>0x64 <span class="p">&amp;</span> 0xffffffff<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Adds a packet to the nat table that matches the 0x64/0xffffffff ctmark value if successful and adds it to the DNAT destination. Specify the destination parameter as forwarding to local port 8081.</p>
<p>DNAT targets can only be used in the PREROUTING and OUPUT chains in the nat table and the associated call chains.</p>
<p>Alternatively, try configuring iptables directly for port forwarding without starting firewalld.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -t mangle -A PREROUTING -p tcp -m tcp --dport <span class="m">8080</span> -j MARK --set-xmark 0x64/0xffffffff
</span></span><span class="line"><span class="cl">iptables -t nat -A PREROUTING -p tcp -m mark --mark 0x64 -j DNAT --to-destination :8081
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ending">Ending</h2>
<p>This article briefly describes the basic operation and configuration of iptables and firewalld in CentOS as a test environment.s</p>
<p>firewalld can configure iptables at a high level of abstraction, for example by internally maintaining a ctmark value for port forwarding.</p>
<p>For port openings that do not specify an ip protocol version, firewalld maintains both ipv4 and ipv6 configurations, which can be viewed separately with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iptables -L -v
</span></span><span class="line"><span class="cl">ip6tables -L -v
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are tools similar to firewalld in other Linux distributions, and iptables is present in most distributions.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">linux</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/python-argparse/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python argparse explained in detail</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/linux-tc/">
            <span class="next-text nav-default">Use the Linux built-in tc command to simulate a weak network environment</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
