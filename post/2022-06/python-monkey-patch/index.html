<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Beware of monkey patches and tips for troubleshooting monkey patches in Python - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article explains why you should beware of monkey patches and tips for troubleshooting monkey patches in Python." /><meta name="keywords" content="Python, monkey patches" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/python-monkey-patch/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Beware of monkey patches and tips for troubleshooting monkey patches in Python" />
<meta property="og:description" content="This article explains why you should beware of monkey patches and tips for troubleshooting monkey patches in Python." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/python-monkey-patch/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-23T13:00:57+08:00" />
<meta property="article:modified_time" content="2022-06-23T13:00:57+08:00" />

<meta itemprop="name" content="Beware of monkey patches and tips for troubleshooting monkey patches in Python">
<meta itemprop="description" content="This article explains why you should beware of monkey patches and tips for troubleshooting monkey patches in Python."><meta itemprop="datePublished" content="2022-06-23T13:00:57+08:00" />
<meta itemprop="dateModified" content="2022-06-23T13:00:57+08:00" />
<meta itemprop="wordCount" content="1776">
<meta itemprop="keywords" content="Python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Beware of monkey patches and tips for troubleshooting monkey patches in Python"/>
<meta name="twitter:description" content="This article explains why you should beware of monkey patches and tips for troubleshooting monkey patches in Python."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Beware of monkey patches and tips for troubleshooting monkey patches in Python</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-23 13:00:57 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1776 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#background">Background</a></li>
            <li><a href="#what-is-a-monkey-patch">What is a monkey patch</a></li>
            <li><a href="#a-bunch-of-meaningless-stack-information">A bunch of meaningless stack information</a></li>
            <li><a href="#spot-the-monkey-patch">Spot the monkey patch</a></li>
            <li><a href="#tips-for-troubleshooting-monkey-patches">Tips for troubleshooting monkey patches</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h3 id="background">Background</h3>
<p>Two nights ago, the online system suddenly broke down, and after immediately opening the online error log, I only got a bunch of meaningless program call stack (traceback) output, so the team members were caught in a long and blind problem solving process. The problem was fortunately solved, but I couldn&rsquo;t figure out why the call stack printed in the log was meaningless when, as a rule of thumb, it should print the call stack during the exception generation process. After subsequent source code analysis and troubleshooting, I realized it was actually due to an old piece of code in the project using <strong>monkey patch</strong>, which is what this article is trying to discuss.</p>
<h3 id="what-is-a-monkey-patch">What is a monkey patch</h3>
<p>Monkey patching is a type of programming used to modify (add, change, delete, etc.) the behavior of system software at runtime. There is a wide range of monkey patch applications in dynamic languages, such as Ruby&rsquo;s open class feature that supports extending class definitions and even replacing method implementations at runtime, Python&rsquo;s methods or functions that can be replaced at runtime, and other languages like JavaScript that can also apply monkey patches.</p>
<h4 id="monkey-patching-is-a-double-edged-sword">Monkey patching is a double-edged sword</h4>
<p>Monkey patches are flexible enough to allow complete separation of the patch code from the application code, while allowing the application code to be invoked in a way that remains constant. From the perspective of the application code, it calls the original defined method or function of a module; from the perspective of the called method or function, the presence of the monkey patch is transparent to it, as shown in the following demo in Python.</p>
<p>Let&rsquo;s start with a minimalist example and say hello to a wonderful world.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">greet</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Hello World!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">greet</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the above script is executed, the result will be</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ python demo.py
</span></span><span class="line"><span class="cl">Hello World!
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is easy. Next, let&rsquo;s say we do a monkey patch: we expand the original <code>greet</code> behavior and now print the current time in addition to the message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">greet</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Hello World!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># monkey patch</span>
</span></span><span class="line"><span class="cl"><span class="n">original_greet</span> <span class="o">=</span> <span class="n">greet</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">greet_with_time</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">original_greet</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">greet</span> <span class="o">=</span> <span class="n">greet_with_time</span>  <span class="c1"># replace the implementation</span>
</span></span><span class="line"><span class="cl"><span class="c1"># monkey patch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">greet</span><span class="p">()</span> <span class="c1"># 这里的调用和原来没有变化</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Run it and get the following results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ python demo.py
</span></span><span class="line"><span class="cl">Hello World!
</span></span><span class="line"><span class="cl">2019-09-21 23:40:42.575782
</span></span></code></pre></td></tr></table>
</div>
</div><p>We get the expected result!</p>
<p>From the code analysis, we added a new function <code>greet_with_time</code>, which calls the original <code>greet</code> function, then prints the current time, and finally replaces the <code>greet</code> function by assigning the function to a variable. The final call to the <code>greet</code> function does not require any changes, thus achieving the same call to the <code>greet</code> function but with a very different behavior.</p>
<p>The above demo is just a simplified code for the sake of space, the monkey patch code in a real project is always in a separate module or file. Imagine a large, complex project where your code is flooded with monkey patches, it would be a disastrous challenge to analyze the behavior of the system and troubleshoot problems.</p>
<p>Now that we have some understanding of monkey patches, let&rsquo;s look at an example I encountered in a real project.</p>
<h3 id="a-bunch-of-meaningless-stack-information">A bunch of meaningless stack information</h3>
<p>I reproduced locally the exception we encountered as I mentioned at the beginning, and here are the stack messages consistent with the online environment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">2019-09-19 17:30:11.103|CRITICAL|138:140147476383488|log.py:282|log.log|Task command.celery.crontab_task.some_task[538ddb72-89b0-45fe-811e-107202dc665b] INTERNAL ERROR: AttributeError(&#34;&#39;long&#39; object has no attribute &#39;insert&#39;&#34;,)
</span></span><span class="line"><span class="cl">Traceback (most recent call last):
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/bin/celery&#34;, line 10, in &lt;module&gt;
</span></span><span class="line"><span class="cl">    sys.exit(main())
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/__main__.py&#34;, line 30, in main
</span></span><span class="line"><span class="cl">    main()
</span></span><span class="line"><span class="cl">  ...... 限于篇幅，这里省略很多无意义的内容
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/worker/job.py&#34;, line 384, in on_success
</span></span><span class="line"><span class="cl">    return self.on_failure(ret_value)
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/worker/job.py&#34;, line 443, in on_failure
</span></span><span class="line"><span class="cl">    self._log_error(exc_info, send_failed_event=send_failed_event)
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/worker/job.py&#34;, line 511, in _log_error
</span></span><span class="line"><span class="cl">    &#39;internal&#39;: internal}})
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/utils/log.py&#34;, line 282, in log
</span></span><span class="line"><span class="cl">    return Logger.log(self, *args, **kwargs)
</span></span><span class="line"><span class="cl">None
</span></span></code></pre></td></tr></table>
</div>
</div><p>From this stack message, it actually prints the stack of the <code>Logger.log</code> function called, in which there is no code at all to see the word <code>.insert</code>, which has nothing to do with <code>AttributeError(&quot;'long' object has no attribute 'insert'&quot;,)</code>. Such a stack of information is basically the same with and without. So, I went on to explore more through the editor and the source code.</p>
<p>The first thing I did was to use the stack above to analyze what went wrong, so I looked at the code at <code>celery/worker/job.py:504-511</code> first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl">        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;exc&#39;</span><span class="p">:</span> <span class="n">exception</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;traceback&#39;</span><span class="p">:</span> <span class="n">traceback</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">sargs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">skwargs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">severity</span><span class="p">,</span> <span class="nb">format</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">exc_info</span><span class="o">=</span><span class="n">exc_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">sargs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">skwargs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="s1">&#39;internal&#39;</span><span class="p">:</span> <span class="n">internal</span><span class="p">}})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>logger.log</code> method is called here (the source of the logger can be analyzed in Celery&rsquo;s code, but is not the focus of this article, so I won&rsquo;t expand on it) and two important messages are passed in via the <code>context</code> object: <code>exception</code> and <code>traceback</code>. Further reading of the <code>logger.log</code> source code confirmed that the core of this piece of <strong>log printing relies on a call to the <code>traceback.print_exception</code> function</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">formatException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ei</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        Format and return the specified exception information as a string.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">        This default implementation just uses
</span></span></span><span class="line"><span class="cl"><span class="s2">        traceback.print_exception()
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">tb</span> <span class="o">=</span> <span class="n">ei</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">ei</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ei</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tb</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sio</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So, I went back to the code at <code>celery/worker/job.py:504-511</code> and inserted two codes that print error stack information before <code>logger.log</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># context  = ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">traceback</span> <span class="k">as</span> <span class="nn">_traceback</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Method 1: like what logger.log does</span>
</span></span><span class="line"><span class="cl"><span class="n">_traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Method 2: use `format_exception` instead</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">exc_info</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">################################################################</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">....</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After restarting celery and executing the asynchronous task, the first error stack is identical to the one I posted earlier, which is understandable since the call to the <code>print_exception</code> function here is the core implementation in <code>logger.log</code>. The call to <code>format_exception</code> gives me the real meaningful error stack information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Traceback (most recent call last):
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/app/trace.py&#34;, line 283, in trace_task
</span></span><span class="line"><span class="cl">    uuid, retval, SUCCESS, request=task_request,
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/backends/base.py&#34;, line 271, in store_result
</span></span><span class="line"><span class="cl">    request=request, **kwargs)
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/backends/base.py&#34;, line 505, in _store_result
</span></span><span class="line"><span class="cl">    self.set(self.get_key_for_task(task_id), self.encode(meta))
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/backends/redis.py&#34;, line 161, in set
</span></span><span class="line"><span class="cl">    return self.ensure(self._set, (key, value), **retry_policy)
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/backends/redis.py&#34;, line 150, in ensure
</span></span><span class="line"><span class="cl">    **retry_policy
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/kombu/utils/__init__.py&#34;, line 246, in retry_over_time
</span></span><span class="line"><span class="cl">    return fun(*args, **kwargs)
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/celery/backends/redis.py&#34;, line 170, in _set
</span></span><span class="line"><span class="cl">    pipe.execute()
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/redis/client.py&#34;, line 2879, in execute
</span></span><span class="line"><span class="cl">    return execute(conn, stack, raise_on_error)
</span></span><span class="line"><span class="cl">  File &#34;/usr/local/lib/python2.7/dist-packages/redis/client.py&#34;, line 2785, in _execute_transaction
</span></span><span class="line"><span class="cl">    response.insert(i, e)
</span></span><span class="line"><span class="cl">AttributeError: &#39;long&#39; object has no attribute &#39;insert&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now it&rsquo;s clear, this is where the exception in this code is really coming from!</p>
<p>But then the question arises, why do <code>print_exce ption</code> and <code>format_exception</code> give different stack information? I went to the official documentation with a lot of questions, but the confusion got worse.</p>
<blockquote>
<p><strong>traceback.format_exception(etype, value, tb[, limit])</strong> Format a stack trace and the exception information. The arguments have the same meaning as the corresponding arguments to print_exception(). The return value is a list of strings, each ending in a newline and some containing internal newlines. When these lines are concatenated and printed, exactly the same text is printed as does print_exception().</p>
</blockquote>
<p>Focus on the last sentence, the official Python documentation says that both functions output the same error stack (EXACTLY the same text)!</p>
<h3 id="spot-the-monkey-patch">Spot the monkey patch</h3>
<p>Actually, the real process of troubleshooting the problem took me a lot of time. I hadn&rsquo;t been thinking about the monkey patch, but I finally found the culprit on the subway on my way out to a friend&rsquo;s dinner date, when I looked at the project code on my company&rsquo;s GitLab on my phone.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_patch_print_exception</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">traceback</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">custom_print_exception</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ... omit other source codes </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span> <span class="o">=</span> <span class="n">custom_print_exception</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the patch code, the patch directly overwrites the original code, and the implementation also directly and brutally ignores the several exception message parameters passed in! That&rsquo;s why it&rsquo;s such a big oops, with unrelated exception stack information! (╯‵□′)╯︵┻┻</p>
<h3 id="tips-for-troubleshooting-monkey-patches">Tips for troubleshooting monkey patches</h3>
<p>There are certainly pros and cons to this type of programming technique, monkey patches, and using them necessarily requires extra caution. However, it is not necessary to stay away from them, the focus is on mastering the necessary troubleshooting skills, and I will go back to this lesson to find some methods that may help.</p>
<h4 id="1-check-the-method-or-function-information-through-the-function-or-method-itself-properties">1. Check the method or function information through the function or method itself properties</h4>
<p>As you know, all Python objects have a bunch of <a href="https://docs.python.org/2/library/inspect.html#types-and-members">built-in properties</a>, and functions are no exception.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="c1"># django shell</span>
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="o">.</span><span class="n">func_code</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">code</span> <span class="nb">object</span> <span class="n">custom_print_exception</span> <span class="n">at</span> <span class="mh">0x109e9f030</span><span class="p">,</span> <span class="n">file</span> <span class="s2">&#34;/Users/boy/work_area/project/project-source/lib/common/logger.py&#34;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">295</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A quick look shows that the real code of this function is actually the patch code of the project!</p>
<h4 id="2-inspecting-with-the-inspect-package">2. Inspecting with the inspect package</h4>
<p>Python provides a lot of toolkits, and inspect is naturally one of them, and it can be used to do runtime checks on almost any type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># django shell</span>
</span></span><span class="line"><span class="cl">In <span class="o">[</span>1<span class="o">]</span>: import inspect
</span></span><span class="line"><span class="cl">In <span class="o">[</span>2<span class="o">]</span>: inspect.getfile<span class="o">(</span>traceback.print_exception<span class="o">)</span>
</span></span><span class="line"><span class="cl">Out<span class="o">[</span>2<span class="o">]</span>: <span class="s1">&#39;/Users/boy/work_area/project/project-source/lib/common/logger.py&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">In <span class="o">[</span>3<span class="o">]</span>: inspect.getsource<span class="o">(</span>traceback.print_exception<span class="o">)</span>
</span></span><span class="line"><span class="cl">Out<span class="o">[</span>3<span class="o">]</span>: <span class="s1">&#39;\tdef custom_print_exception(etype, value, tb, limit=None, file=None): ......\n&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">In <span class="o">[</span>4<span class="o">]</span>: print inspect.getsource<span class="o">(</span>traceback.print_exception<span class="o">)</span>
</span></span><span class="line"><span class="cl">Out<span class="o">[</span>4<span class="o">]</span>: def custom_print_exception<span class="o">(</span>etype, value, tb, <span class="nv">limit</span><span class="o">=</span>None, <span class="nv">file</span><span class="o">=</span>None<span class="o">)</span>:disable<span class="o">=</span>redefined-builtin
</span></span><span class="line"><span class="cl">        <span class="k">if</span> file is None:
</span></span><span class="line"><span class="cl">            <span class="nv">file</span> <span class="o">=</span> sys.stderr
</span></span><span class="line"><span class="cl">        <span class="nv">exc_info</span> <span class="o">=</span> sys.exc_info<span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="nv">stack</span> <span class="o">=</span> traceback.extract_stack<span class="o">()</span>
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>In short, if you encounter code behavior does not match the expected but can not correspond with the official documentation or official source code, then it is possible that the dependent method or function was monkey patched, and the quickest way to confirm the monkey patch is to check the actual definition of the function or method called in the first place, that is, to apply the above method!</p>
<h4 id="off-topic-remarks">Off-topic remarks</h4>
<p>I&rsquo;ve encountered the monkey patch trap when doing Ruby development, and there is a similar approach in Ruby.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="n">file</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span><span class="o">.</span><span class="n">source_location</span>
</span></span><span class="line"><span class="cl"><span class="nb">puts</span> <span class="s2">&#34;Method foo is defined in </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">, line </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># =&gt; &#34;Method foo is defined in temp.rb, line 2&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">Python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/dynamic-password-algorith/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Dynamic Password Algorith</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/gulp/">
            <span class="next-text nav-default">Gulp for front-end automated builds</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
