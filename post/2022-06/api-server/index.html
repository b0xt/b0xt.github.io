<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The process of apiserver processing requests - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore how apiserver handles requests." /><meta name="keywords" content="apiserver, handler" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/api-server/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="The process of apiserver processing requests" />
<meta property="og:description" content="Explore how apiserver handles requests." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/api-server/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-19T14:00:09+08:00" />
<meta property="article:modified_time" content="2022-06-19T14:00:09+08:00" />

<meta itemprop="name" content="The process of apiserver processing requests">
<meta itemprop="description" content="Explore how apiserver handles requests."><meta itemprop="datePublished" content="2022-06-19T14:00:09+08:00" />
<meta itemprop="dateModified" content="2022-06-19T14:00:09+08:00" />
<meta itemprop="wordCount" content="1871">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The process of apiserver processing requests"/>
<meta name="twitter:description" content="Explore how apiserver handles requests."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The process of apiserver processing requests</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-19 14:00:09 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1871 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-overview">1. Overview</a></li>
        <li><a href="#2-the-processing-chain-of-requests">2. The processing chain of requests</a>
          <ul>
            <li><a href="#panicrecovery">PanicRecovery</a></li>
            <li><a href="#probabilisticgoaway">ProbabilisticGoaway</a></li>
            <li><a href="#requestinfo">RequestInfo</a></li>
            <li><a href="#waitgroup">WaitGroup</a></li>
            <li><a href="#timeoutfornonlongrunningrequests">TimeoutForNonLongRunningRequests</a></li>
            <li><a href="#cors">CORS</a></li>
            <li><a href="#authentication">Authentication</a></li>
            <li><a href="#failedauthenticationaudit">FailedAuthenticationAudit</a></li>
            <li><a href="#unauthorized">Unauthorized</a></li>
            <li><a href="#audit">Audit</a></li>
            <li><a href="#impersonation">Impersonation</a></li>
            <li><a href="#priorityandfairness--maxinflightlimit">PriorityAndFairness / MaxInFlightLimit</a></li>
            <li><a href="#authorization">Authorization</a></li>
            <li><a href="#director">director</a></li>
            <li><a href="#admission-webhook">admission webhook</a></li>
          </ul>
        </li>
        <li><a href="#3-how-to-read-the-code-related-to-apiserver">3. how to read the code related to apiserver</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-overview">1. Overview</h2>
<p>The apiserver of k8s is the hub of communication for all components, and its importance is self-explanatory. apiserver can provide HTTP-based services to the outside world, so what steps does a request go through from issuing to processing? The following is a brief description of the entire process based on the code so that you can get a general impression of the process.</p>
<p>Since the code structure of apiserver is not simple, we will try to post as little code as possible. The following analysis is based on k8s 1.18</p>
<h2 id="2-the-processing-chain-of-requests">2. The processing chain of requests</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 构建请求的处理链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">DefaultBuildHandlerChain</span><span class="p">(</span><span class="nx">apiHandler</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAuthorization</span><span class="p">(</span><span class="nx">apiHandler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">FlowControl</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithPriorityAndFairness</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">FlowControl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithMaxInFlightLimit</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MaxRequestsInFlight</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MaxMutatingRequestsInFlight</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithImpersonation</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAudit</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">AuditBackend</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">AuditPolicyChecker</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">failedHandler</span> <span class="o">:=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">Unauthorized</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">SupportsBasicAuth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">failedHandler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithFailedAuthenticationAudit</span><span class="p">(</span><span class="nx">failedHandler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">AuditBackend</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">AuditPolicyChecker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAuthentication</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">,</span> <span class="nx">failedHandler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">APIAudiences</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithCORS</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">CorsAllowedOriginList</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithTimeoutForNonLongRunningRequests</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">RequestTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithWaitGroup</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">HandlerChainWaitGroup</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithRequestInfo</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">RequestInfoResolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">SecureServing</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">SecureServing</span><span class="p">.</span><span class="nx">DisableHTTP2</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GoawayChance</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithProbabilisticGoaway</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GoawayChance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithPanicRecovery</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The processing chain of this request is executed from back to front. So the request goes through the handler as follows.</p>
<ul>
<li>PanicRecovery</li>
<li>ProbabilisticGoaway</li>
<li>RequestInfo</li>
<li>WaitGroup</li>
<li>TimeoutForNonLongRunningRequests</li>
<li>CORS</li>
<li>Authentication</li>
<li>failedHandler: FailedAuthenticationAudit</li>
<li>failedHandler: Unauthorized</li>
<li>Audit</li>
<li>Impersonation</li>
<li>PriorityAndFairness / MaxInFlightLimit</li>
<li>Authorization</li>
</ul>
<p>It is then passed to the director, who distributes it to gorestfulContainer or nonGoRestfulMux. gorestfulContainer is the main part of the apiserver.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">director</span> <span class="o">:=</span> <span class="nx">director</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">name</span><span class="p">:</span>               <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nx">goRestfulContainer</span><span class="p">:</span> <span class="nx">gorestfulContainer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nx">nonGoRestfulMux</span><span class="p">:</span>    <span class="nx">nonGoRestfulMux</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="panicrecovery">PanicRecovery</h3>
<p>runtime.HandleCrash prevents panic, and logs the details of the panic request.</p>
<h3 id="probabilisticgoaway">ProbabilisticGoaway</h3>
<p>Because the client and apiserver are using http2 long connections. So even if the apiserver is load balanced, some of the client&rsquo;s requests will keep hitting the same apiserver. goaway configures a small chance that the apiserver will respond GOWAY to the client after receiving the request, so that the client will create a new tcp connection to load balance to a different apiserver. This chance can range from 0 to 0.02</p>
<p>Related PR: <a href="https://github.com/kubernetes/kubernetes/pull/88567">https://github.com/kubernetes/kubernetes/pull/88567</a></p>
<h3 id="requestinfo">RequestInfo</h3>
<p>RequestInfo parses the HTTP request. The following information is obtained.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// RequestInfo holds information parsed from the http.Request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">RequestInfo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// IsResourceRequest indicates whether or not the request is for an API resource or subresource
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">IsResourceRequest</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Path is the URL path of the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Path</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Verb is the kube verb associated with the request for API requests, not the http verb.  This includes things like list and watch.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for non-resource requests, this is the lowercase http verb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Verb</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">APIPrefix</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">APIGroup</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">APIVersion</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Namespace</span>  <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Resource is the name of the resource being requested.  This is not the kind.  For example: pods
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Resource</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Subresource is the name of the subresource being requested.  This is a different resource, scoped to the parent resource, but it may have a different kind.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// For instance, /pods has the resource &#34;pods&#34; and the kind &#34;Pod&#34;, while /pods/foo/status has the resource &#34;pods&#34;, the sub resource &#34;status&#34;, and the kind &#34;Pod&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (because status operates on pods). The binding resource for a pod though may be /pods/foo/binding, which has resource &#34;pods&#34;, subresource &#34;binding&#34;, and kind &#34;Binding&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Subresource</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Name is empty for some verbs, but if the request directly indicates a name (not in body content) then this field is filled in.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Parts are the path parts for the request, always starting with /{resource}/{name}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">Parts</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="waitgroup">WaitGroup</h3>
<p>waitgroup is used to handle short connection exits.</p>
<p>How can we tell if it&rsquo;s a long connection? Here it is determined by the request action or subresource. watch and proxy are determined by the path of the request on requestinfo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">serverConfig</span><span class="p">.</span><span class="nx">LongRunningFunc</span> <span class="p">=</span> <span class="nx">filters</span><span class="p">.</span><span class="nf">BasicLongRunningRequestCheck</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="s">&#34;watch&#34;</span><span class="p">,</span> <span class="s">&#34;proxy&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="s">&#34;attach&#34;</span><span class="p">,</span> <span class="s">&#34;exec&#34;</span><span class="p">,</span> <span class="s">&#34;proxy&#34;</span><span class="p">,</span> <span class="s">&#34;log&#34;</span><span class="p">,</span> <span class="s">&#34;portforward&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// BasicLongRunningRequestCheck returns true if the given request has one of the specified verbs or one of the specified subresources, or is a profiler request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">BasicLongRunningRequestCheck</span><span class="p">(</span><span class="nx">longRunningVerbs</span><span class="p">,</span> <span class="nx">longRunningSubresources</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span><span class="p">)</span> <span class="nx">apirequest</span><span class="p">.</span><span class="nx">LongRunningRequestCheck</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">requestInfo</span> <span class="o">*</span><span class="nx">apirequest</span><span class="p">.</span><span class="nx">RequestInfo</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">longRunningVerbs</span><span class="p">.</span><span class="nf">Has</span><span class="p">(</span><span class="nx">requestInfo</span><span class="p">.</span><span class="nx">Verb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">requestInfo</span><span class="p">.</span><span class="nx">IsResourceRequest</span> <span class="o">&amp;&amp;</span> <span class="nx">longRunningSubresources</span><span class="p">.</span><span class="nf">Has</span><span class="p">(</span><span class="nx">requestInfo</span><span class="p">.</span><span class="nx">Subresource</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">requestInfo</span><span class="p">.</span><span class="nx">IsResourceRequest</span> <span class="o">&amp;&amp;</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">requestInfo</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&#34;/debug/pprof/&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This way, the handler of the waitgroup will be done only after all subsequent handlers have exited, so that it can exit gracefully.</p>
<h3 id="timeoutfornonlongrunningrequests">TimeoutForNonLongRunningRequests</h3>
<p>For non-long connection requests, use ctx&rsquo;s cancel to cancel the request after the timeout.</p>
<h3 id="cors">CORS</h3>
<p>Set some CORS response headers.</p>
<h3 id="authentication">Authentication</h3>
<p>Begin authenticating the user. Successful authentication removes <code>Authorization</code> from the request. Then the request is passed to the next handler, otherwise it is passed to the next failed handler.</p>
<p>There are a number of ways to handle this. These include</p>
<ul>
<li>Requestheader, which takes out X-Remote-User, X-Remote-Group, X-Remote-Extra from the request.</li>
<li>X509 certificate validation.</li>
<li>BearerToken</li>
<li>WebSocket</li>
<li>Anonymous: in case anonymity is allowed</li>
</ul>
<p>There is also a section that provides authentication in the form of a plugin.</p>
<ul>
<li>bootstrap token</li>
<li>Basic auth</li>
<li>password</li>
<li>OIDC</li>
<li>Webhook</li>
</ul>
<p>Authentication is considered successful if one of them succeeds. and if the user is <code>system:anonymous</code> or the user group contains <code>system:unauthenticated</code> and <code>system:authenticated</code>. it returns directly, otherwise it modifies the user information and returns.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">r</span><span class="p">.</span><span class="nx">User</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">.</span><span class="nx">DefaultInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Name</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">UID</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">GetUID</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Groups</span><span class="p">:</span> <span class="nb">append</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">GetGroups</span><span class="p">(),</span> <span class="nx">user</span><span class="p">.</span><span class="nx">AllAuthenticated</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Extra</span><span class="p">:</span>  <span class="nx">r</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nf">GetExtra</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that the user is now part of <code>system:authenticated</code>. That is, it is authenticated.</p>
<h3 id="failedauthenticationaudit">FailedAuthenticationAudit</h3>
<p>This will only be executed after an authentication failure. It mainly provides auditing capabilities.</p>
<h3 id="unauthorized">Unauthorized</h3>
<p>Unauthorized processing, called after FailedAuthenticationAudit</p>
<h3 id="audit">Audit</h3>
<p>Provides the audit function for requests</p>
<h3 id="impersonation">Impersonation</h3>
<p>Impersonation is a feature that assumes the current user as another user, which helps administrators to test whether the permissions of different users are configured correctly, etc. The key to get the header is.</p>
<ul>
<li>Impersonate-User: user</li>
<li>Impersonate-Group: group</li>
<li>Impersonate-Extra-: additional information</li>
</ul>
<p>Users are divided into service account and user. service account is formatted as namespace/name, otherwise it is treated as user.</p>
<p>The final format of a service account is: system:serviceaccount:namespace:name</p>
<h3 id="priorityandfairness--maxinflightlimit">PriorityAndFairness / MaxInFlightLimit</h3>
<p>If flow control is set, PriorityAndFairness is used, otherwise MaxInFlightLimit is used.</p>
<p>PriorityAndFairness: will do priority ranking of requests. Requests of the same priority will have fairness-related controls.</p>
<p>MaxInFlightLimit: The maximum number of immutable requests in progress in a given time. When this value is exceeded, the service will reject all requests. 0 value means no limit. (Default value 400)</p>
<p>Reference: <a href="https://kubernetes.io/zh/docs/concepts/cluster-administration/flow-control/">https://kubernetes.io/zh/docs/concepts/cluster-administration/flow-control/</a></p>
<h3 id="authorization">Authorization</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// AttributesRecord implements Attributes interface.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AttributesRecord</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">User</span>            <span class="nx">user</span><span class="p">.</span><span class="nx">Info</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Verb</span>            <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Namespace</span>       <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">APIGroup</span>        <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">APIVersion</span>      <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Resource</span>        <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Subresource</span>     <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Name</span>            <span class="kt">string</span>
</span></span><span class="line"><span class="cl">   <span class="nx">ResourceRequest</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Path</span>            <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Authentication takes the information needed for this structure above from the context and then authenticates it. The following authentication methods are supported.</p>
<ul>
<li>Always allow</li>
<li>Always deny</li>
<li>Path: Allows partial paths to always be accessible</li>
</ul>
<p>Some other common authentication methods are provided mainly through plugins.</p>
<ul>
<li>Webhook</li>
<li>RBAC</li>
<li>Node</li>
</ul>
<p>Where Node is designed specifically for kubelet, the node authenticator allows kubelet to perform API operations. This includes:</p>
<p>Read operation:</p>
<ul>
<li>services</li>
<li>endpoints</li>
<li>nodes</li>
<li>pods</li>
<li>secrets, configmaps, pvcs, and pod-related persistent volumes bound to kubelet nodes</li>
</ul>
<p>Write operations:</p>
<ul>
<li>Node and node state (enable the <code>NodeRestriction</code> access plugin to restrict the kubelet to only modify its own nodes)</li>
<li>Pods and Pod state (enable the <code>NodeRestriction</code> access plugin to restrict the kubelet to only modify Pods bound to itself)</li>
<li>Events</li>
</ul>
<p>Authentication-related operations.</p>
<ul>
<li>read/write permissions for the certificationsigningrequests API used during TLS-based bootstrapping</li>
<li>Ability to create tokenreviews and subjectaccessreviews for delegated authentication/authorization checks</li>
</ul>
<p>In future releases, the node authenticator may add or remove permissions to ensure that the kubelet has the minimum set of permissions needed to operate correctly.</p>
<p>In order to obtain authorization from the node authenticator, the kubelet must use a credential to indicate that it is in the <code>system:nodes</code> group with the username <code>system:node:&lt;nodeName&gt;</code>. The above group name and username format should match the identity created for each kubelet during the <a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/">kubelet TLS bootstrapping process</a>.</p>
<h3 id="director">director</h3>
<p>The director&rsquo;s ServeHTTP method is defined as follows, i.e. it will be forwarded according to the defined webservice matching rules. Otherwise, it calls nonGoRestfulMux for processing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="nx">director</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check to see if our webservices want to claim this path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ws</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">d</span><span class="p">.</span><span class="nx">goRestfulContainer</span><span class="p">.</span><span class="nf">RegisteredWebServices</span><span class="p">()</span> <span class="p">{</span> <span class="nx">q</span> 
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">RootPath</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#34;/apis&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// if we are exactly /apis or /apis/, then we need special handling in loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// normally these are passed to the nonGoRestfulMux, but if discovery is enabled, it will go directly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We can&#39;t rely on a prefix match since /apis matches everything (see the big comment on Director above)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/apis&#34;</span> <span class="o">||</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/apis/&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;%v: %v %q satisfied by gorestful with webservice %v&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">RootPath</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// don&#39;t use servemux here because gorestful servemuxes get messed up when removing webservices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// TODO fix gorestful, remove TPRs, or stop using gorestful
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">d</span><span class="p">.</span><span class="nx">goRestfulContainer</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">RootPath</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ensure an exact match or a path boundary match
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nf">RootPath</span><span class="p">())</span> <span class="o">||</span> <span class="nx">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nf">RootPath</span><span class="p">())]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;%v: %v %q satisfied by gorestful with webservice %v&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">RootPath</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// don&#39;t use servemux here because gorestful servemuxes get messed up when removing webservices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// TODO fix gorestful, remove TPRs, or stop using gorestful
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">d</span><span class="p">.</span><span class="nx">goRestfulContainer</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// if we didn&#39;t find a match, then we just skip gorestful altogether
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;%v: %v %q satisfied by nonGoRestful&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">.</span><span class="nx">nonGoRestfulMux</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="admission-webhook">admission webhook</h3>
<p>The last step before the request is actually processed is our admission webhook. admission is called in the specific REST processing code. In create, update and delete, mutate is called first, followed by validating. k8s itself has a number of admissions built in, provided as plugins, as follows.</p>
<ul>
<li>AlwaysAdmit</li>
<li>AlwaysPullImages</li>
<li>LimitPodHardAntiAffinityTopology</li>
<li>CertificateApproval/CertificateSigning/CertificateSubjectRestriction</li>
<li>DefaultIngressClass</li>
<li>DefaultTolerationSeconds</li>
<li>ExtendedResourceToleration</li>
<li>OwnerReferencesPermissionEnforcement</li>
<li>ImagePolicyWebhook</li>
<li>LimitRanger</li>
<li>NamespaceAutoProvision</li>
<li>NamespaceExists</li>
<li>NodeRestriction</li>
<li>TaintNodesByCondition</li>
<li>PodNodeSelector</li>
<li>PodPreset</li>
<li>PodTolerationRestriction</li>
<li>Priority</li>
<li>ResourceQuota</li>
<li>RuntimeClass</li>
<li>PodSecurityPolicy</li>
<li>SecurityContextDeny</li>
<li>ServiceAccount</li>
<li>PersistentVolumeLabel</li>
<li>PersistentVolumeClaimResize</li>
<li>DefaultStorageClass</li>
<li>StorageObjectInUseProtection</li>
</ul>
<h2 id="3-how-to-read-the-code-related-to-apiserver">3. how to read the code related to apiserver</h2>
<p>The repository I am looking at is <a href="https://github.com/kubernetes/kubernetes">https://github.com/kubernetes/kubernetes</a>. The apiserver code is mainly scattered in the following locations.</p>
<ul>
<li>cmd/kube-apiserver: apiserver main function entry. It mainly encapsulates a lot of startup parameters.</li>
<li>pkg/kubeapiserver: Provides code shared by kube-apiserver and federation-apiserve, but is not part of the generic API server.</li>
<li>plugin/pkg: The following are all plugins related to authentication, authentication and access control</li>
<li>staging/src/apiserver: This is the core code of apiserver. The pkg/server below it is the service startup portal.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/k8s-reliability-list-data/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/truetime-atomic-clock/">
            <span class="next-text nav-default">TrueTime and Atomic Clocks</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
