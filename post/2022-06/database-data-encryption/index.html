<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>4 common ideas of database data encryption - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article introduces the 4 common ways to encrypt database data, and the comparison between each way." /><meta name="keywords" content="Database Data Encryption" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/database-data-encryption/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="4 common ideas of database data encryption" />
<meta property="og:description" content="This article introduces the 4 common ways to encrypt database data, and the comparison between each way." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/database-data-encryption/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-21T12:20:18+08:00" />
<meta property="article:modified_time" content="2022-06-21T12:20:18+08:00" />

<meta itemprop="name" content="4 common ideas of database data encryption">
<meta itemprop="description" content="This article introduces the 4 common ways to encrypt database data, and the comparison between each way."><meta itemprop="datePublished" content="2022-06-21T12:20:18+08:00" />
<meta itemprop="dateModified" content="2022-06-21T12:20:18+08:00" />
<meta itemprop="wordCount" content="1900">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="4 common ideas of database data encryption"/>
<meta name="twitter:description" content="This article introduces the 4 common ways to encrypt database data, and the comparison between each way."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">4 common ideas of database data encryption</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-21 12:20:18 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1900 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#solution-analysis">Solution Analysis</a>
          <ul>
            <li><a href="#application-layer-encryption-and-decryption-scheme">Application layer encryption and decryption scheme</a></li>
            <li><a href="#database-preprocessing-solution">Database preprocessing solution</a></li>
            <li><a href="#disk-access-session-transparent-data-encryption">Disk Access Session: Transparent Data Encryption</a></li>
            <li><a href="#db-post-processing">DB post-processing</a></li>
          </ul>
        </li>
        <li><a href="#comparison">Comparison</a></li>
        <li><a href="#the-problem-of-coexistence-of-several-options">The problem of coexistence of several options</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Recently, due to work requirements, I did research and study on the European General Data Protection Regulation, in which there is a very important point, which is also common sense, is the need to do a good job of encrypting and storing the user&rsquo;s personal privacy data to avoid the leakage of the user&rsquo;s private plaintext data.</p>
<h2 id="solution-analysis">Solution Analysis</h2>
<p>Thinking about how to do a good job of encrypting user privacy data can start with an analysis of a typical data read/write link.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">_________          query           _________           read           _________
</span></span><span class="line"><span class="cl">|       |     ----------------&gt;    |       |     ----------------&gt;    |       |
</span></span><span class="line"><span class="cl">|  App  |                          |  DB   |                          | Disk  |
</span></span><span class="line"><span class="cl">|       |     &lt;================    |       |     &lt;================    |       |
</span></span><span class="line"><span class="cl">---------           rows           ---------         data page        ---------
</span></span></code></pre></td></tr></table>
</div>
</div><p>According to this link analysis, 4 types of solutions for data encryption can be classified according to the starting point of data encryption.</p>
<ul>
<li>Application layer encryption and decryption: the application itself is responsible for the encryption and decryption of data, which is the most liberal but also the most cumbersome solution.</li>
<li>DB pre-processing: the encryption logic is embedded before the database server starts serving, typically represented by the database proxy service.</li>
<li>Disk access session: The basic idea of this scheme then is to go around behind the database and inject hook processes in the file system, so that the encryption logic can be embedded before the disk data is read or written.</li>
<li>DB post-processing: embedding encryption logic after the database service, relying on triggers provided by the database and function customization functions, etc.</li>
</ul>
<p>The following is an analysis of these types of schemes.</p>
<h3 id="application-layer-encryption-and-decryption-scheme">Application layer encryption and decryption scheme</h3>
<p>With this scheme, data encryption and decryption are database agnostic, and the encryption is done by the application before depositing the data and decryption is done after reading the data. The advantages of this scheme are as follows.</p>
<ul>
<li>Good migration: since it does not depend on any database features or operating system features, only code needs to be deployed to run.</li>
<li>Flexible implementation: the logic is placed in the application layer, various customizations or extensions are very easy to carry out, and the per-table/per-column encrypted storage can be easily implemented.</li>
</ul>
<p>At that time, the disadvantages were also very obvious.</p>
<ul>
<li>Impact on the use of advanced database features: such as database indexes and execution plans, etc;</li>
<li>Significantly affect the performance of database query: for example, the prefix query of Like and the range query of Where can only scan the whole table because of data encryption.</li>
<li>High development and maintenance costs: Every time when new data need to be encrypted, the development and testing need to be completed, and developers need to pay attention to the core business logic as well as the logic of data encryption and decryption in the application.</li>
</ul>
<p>To implement the encryption and decryption scheme in the application layer, we can consider combining the callback function mechanism of various ORMs, such as the Callbacks mechanism provided by gorm, a popular ORM framework in golang, or the Callbacks mechanism of Active Record in Ruby on Rails framework, which can effectively help us isolate the business code and control code from each other.</p>
<h3 id="database-preprocessing-solution">Database preprocessing solution</h3>
<p>The database pre-processing scheme is an optimization of the application layer encryption and decryption scheme. The essence of the idea is to separate the concern of encryption and decryption from the application and serve it independently, while achieving the reusability of the encryption and decryption logic.</p>
<p>Using database preprocessing can integrate some advantages of the application layer encryption scheme, while solving some problems of the latter.</p>
<ol>
<li>flexibility: database proxies have the same good flexibility to achieve column-level encryption and decryption.</li>
<li>better reusability: multiple applications or systems no longer need to be built repeatedly, and the use of database agents with independently maintained services enables fast access to encryption and decryption functions.</li>
<li>higher transparency: application developers do not need to pay attention to the encryption and decryption logic within themselves, but due to the degradation of SQL compatibility of the database agent, the application development process has to maintain an understanding of SQL compatibility.</li>
</ol>
<p>The database pre-processing solution also has some drawbacks of its own.</p>
<ol>
<li>decreased stability and increased operation and maintenance burden: because the overall architecture introduces additional service nodes, it will add burden to the overall service cost and problem troubleshooting scenarios, and when data processing problems are encountered, it is necessary to involve the maintenance staff of database proxy services to troubleshoot together.</li>
<li>inability to utilize advanced database features: similar to the application layer data encryption and decryption scheme, under this scheme, as the data is encrypted and stored and indexed via the database, data retrieval involving range types in query scenarios will lead to table sweeping.</li>
<li>Consistency problem: Due to the need to maintain the meta information of business data tables / or columns in the database agent, it introduces the consistency problem of the configuration information of the agent layer and the business database design.</li>
</ol>
<h3 id="disk-access-session-transparent-data-encryption">Disk Access Session: Transparent Data Encryption</h3>
<p>Currently, all cloud service vendors basically provide services for this scheme, referred to as Transparent Data Encryption (TDE). It works at the operating system level and works on database data files. Through the hook process of i/o, it embeds encryption and decryption logic when the database storage engine reads and writes data to the file system, completes encryption before writing the data, and performs decryption before the data is read and returned to the storage engine process, and the whole process is completely transparent to the database storage engine.</p>
<p>The advantages of this solution are much more enticing.</p>
<ul>
<li>Transparency: since the solution works on the database server, it is completely transparent to the application, which is still directly connected to the database, and there is absolutely no need to worry about SQL compatibility issues, etc.</li>
<li>Support for all advanced database features: since this solution is also completely transparent to the database engine, in the database perspective, it makes no difference whether it is encrypted or decrypted in all aspects of data retrieval logic as well as execution plan optimization, transaction management, etc., so this solution can perfectly preserve the advanced features of the database.</li>
</ul>
<p>Of course, there is no perfect solution, and this solution has certain limitations.</p>
<ul>
<li>Table-level encryption only: Since this scheme is a senseless encryption and decryption of data files, its biggest limitation is that it cannot achieve encryption in the middle part of the specified data table. Of course, if you can design a structure in your business that just about all tables or almost all columns need to be encrypted, this limitation is not a problem at all.</li>
<li>Platform compatibility issues: Since it relies on the design at the operating system level, this solution may only run on top of a specific platform; in addition, if it is under a cloud scenario, you also need to consider the differences in the solutions provided by different public clouds, especially the differences in the details of how to use them, which may lead to the problem of unconformity when the same system is migrated between cloud vendors.</li>
</ul>
<p>In the design of my own business system, we introduced the concept of user privacy domain, and the design will separate user privacy data and business process data, and naturally realize the centralized storage of user privacy data, so full table data encryption is the most suitable choice for us.</p>
<h3 id="db-post-processing">DB post-processing</h3>
<p>DB post-processing is based on database triggers and custom function functions, etc., which trigger the execution of custom encryption and decryption logic during the execution of queries by the database server. This solution can be said to solve the problems of the previous solutions.</p>
<ul>
<li>transparency: DB post-processing, completely transparent to the application.</li>
<li>Advanced database features: fully compatible.</li>
<li>Flexibility: it can be flexible to achieve column-level data encryption, etc.</li>
</ul>
<p>Although this solution also looks beautiful, it is still not perfect.</p>
<ul>
<li>Anti-pattern: I have personally resisted managing functions or triggers, etc. on the database server because they are not easy to manage, let alone implement versioning, etc..</li>
<li>Database compatibility issues: Due to the dependency on the features provided by the database, this solution is basically impossible to achieve fast migration in scenarios such as having to replace the database.</li>
</ul>
<h2 id="comparison">Comparison</h2>
<p>The following table compares several options.</p>
<table>
<thead>
<tr>
<th>No.</th>
<th>The link where the encryption is located</th>
<th>Introduction</th>
<th>Cases</th>
<th>Advantages</th>
<th>Restrictions</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>App</td>
<td>Encrypted by application before storage and decrypted by application after retrieval</td>
<td>orm + various hooks implementation</td>
<td>Flexible/fine granularity/compatible</td>
<td>not transparent to application, increase development burden/additional secret key management burden</td>
</tr>
<tr>
<td>2</td>
<td>Database pre-proxy</td>
<td>Add a layer of proxy service between application and database, and the proxy service is responsible for encryption and decryption</td>
<td>Tencent Cloud CASB</td>
<td>Highly transparent to application, no development burden/support column-level encryption</td>
<td>SQL syntax compatibility decreases, not completely transparent to development/database features such as optimization processing, transaction processing, concurrency processing are not available/introduce additional links, performance and potential troubleshooting burdens/data bloat is huge, ~4.5x space bloat</td>
</tr>
<tr>
<td>3</td>
<td>Database data files</td>
<td>work at the file system level, encryption is completed before the engine is persistently stored, data files are decrypted before they are loaded into memory, and plaintext data is retained in memory</td>
<td>Tencent Cloud Transparent Data Encryption (TDE)</td>
<td>is completely transparent to applications/built-in support for cloud databases, compatible with advanced database features</td>
<td>Tablespace encryption, no support for field-level encryption/no way to avoid the risks associated with SQL injection.</td>
</tr>
<tr>
<td>4</td>
<td>Database post-processing</td>
<td>Using &ldquo;view&rdquo; + &ldquo;trigger&rdquo; + &ldquo;extended index&rdquo; + &ldquo;external call The database post-processing</td>
<td>uses &ldquo;view&rdquo; + &ldquo;trigger&rdquo; + &ldquo;extended index&rdquo; + &ldquo;external call&rdquo; to achieve data encryption while ensuring full application transparency.</td>
<td>-</td>
<td>Completely transparent to the application/database advanced feature compatibility/support for column-level encryption</td>
</tr>
</tbody>
</table>
<h2 id="the-problem-of-coexistence-of-several-options">The problem of coexistence of several options</h2>
<p>The problem that has never been discussed in the previous analysis is a problem that cannot be bypassed no matter which scheme is used.</p>
<ul>
<li>Performance overhead: the additional overhead of data encryption and decryption process, data encryption and decryption requires a large number of computation processes, this will bring about a performance overhead that cannot be ignored, in the choice of encryption and decryption algorithms, it is necessary to choose the most efficient encryption algorithm possible, while ensuring data security.</li>
<li>Space expansion: In addition to the performance overhead will affect the choice of encryption algorithm, the encryption algorithm may also bring the problem of space expansion, that is, the ciphertext becomes longer than the plaintext, if it is space expansion, the database column in the design of various types of length also need to additionally consider the length of the column data after expansion. I learned that the CTR mode of AES encryption algorithm can achieve the same length of ciphertext and plaintext.</li>
<li>key management problem: no matter which encryption scheme, we need to think about the private storage of the key and the regular rotation problem, etc.. Otherwise, once the key is leaked, the encrypted data may also be cracked.</li>
</ul>
<h2 id="summary">Summary</h2>
<p>Data storage security is an increasingly important and important issue that must be considered well in advance during the application design phase, as it involves complex issues of quality of service and cost balance. Data encryption is gradually playing a common-sense role in business compliance and privacy protection. Just as everyone knows that passwords cannot be stored in clear text nowadays, encryption of all kinds of personal privacy data should also become a standard design in systems in the future.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/go-mysql-decimal/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to safely handle decimal type data in Go &#43; Mysql</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/k8s-quque/">
            <span class="next-text nav-default">Workqueue in Kubernetes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
