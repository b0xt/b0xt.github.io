<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Wishbone Bus Protocol - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn about the Wishbone bus protocol." /><meta name="keywords" content="Wishbone" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/wishbone/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Wishbone Bus Protocol" />
<meta property="og:description" content="Learn about the Wishbone bus protocol." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/wishbone/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-19T21:03:13+08:00" />
<meta property="article:modified_time" content="2022-06-19T21:03:13+08:00" />

<meta itemprop="name" content="Wishbone Bus Protocol">
<meta itemprop="description" content="Learn about the Wishbone bus protocol."><meta itemprop="datePublished" content="2022-06-19T21:03:13+08:00" />
<meta itemprop="dateModified" content="2022-06-19T21:03:13+08:00" />
<meta itemprop="wordCount" content="1647">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Wishbone Bus Protocol"/>
<meta name="twitter:description" content="Learn about the Wishbone bus protocol."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Wishbone Bus Protocol</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-19 21:03:13 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1647 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#bus">Bus</a></li>
        <li><a href="#wishbone-classic-standard">Wishbone Classic Standard</a></li>
        <li><a href="#wishbone-classic-pipelined">Wishbone Classic Pipelined</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="background">Background</h2>
<p>I have recently been studying how to introduce the Wishbone bus protocol into my Principles of Computer Composition course, so I took the opportunity to learn about the Wishbone protocol.</p>
<h2 id="bus">Bus</h2>
<p>What is a bus? The bus is usually used to connect CPU and peripherals. For better compatibility and reusability, it is thought that a unified protocol can be designed, where the CPU implementation is the party that initiates the request (also known as master) and the peripheral implementation is the party that receives the request (also known as slave), so that if you want to add peripherals or replace the CPU implementation, it becomes simpler and reduces a lot of adaptation workload.</p>
<p>So, let&rsquo;s think about what a bus protocol needs to include. For the CPU, the program will read and write memory, and reading and writing memory requires the following signals to be transferred to memory.</p>
<ol>
<li>address (<code>addr</code>): for example, a 32-bit processor is a 32-bit address, or the width of the address line is calculated according to the size of the memory</li>
<li>data (<code>w_data</code> and <code>r_data</code>): write data and read data respectively, usually 32 or 64 bits wide, i.e. the amount of data that can be transferred in one clock cycle</li>
<li>read or write (<code>we</code>): high means write, low means read</li>
<li>byte valid (<code>be</code>): for example, to achieve a single-byte write, although <code>w_data</code> may be 32 bits wide, but the actual write is one of the bytes</li>
</ol>
<p>In addition to the content of the request, a <code>valid</code> signal is added to indicate that the CPU wants to send the request: high means send the request, low means don&rsquo;t send the request. In many cases, the peripheral is slow and may not be able to process the request every cycle, so the peripheral can provide a <code>ready</code> signal: when <code>valid=1 &amp;&amp; ready=1</code>, the request is sent and processed; when <code>valid=1 &amp;&amp; ready=0</code>, it means the peripheral is not ready, so the CPU needs to keep <code>valid=1</code>, and when the peripheral is ready, the <code>valid=1 &amp;&amp; ready=1</code> request will take effect.</p>
<p>To briefly summarize the above requirements, we can get the list of signals on the master and slave side respectively. This time, we use <code>_o</code> for output and <code>_i</code> for input to get the signals on the master side (CPU side).</p>
<ol>
<li><code>clock_i</code>: clock input</li>
<li><code>valid_o</code>: high means master wants to send request</li>
<li><code>ready_i</code>: high means the slave is ready to process the request</li>
<li><code>addr_o</code>: the address that master wants to read or write to</li>
<li><code>we_o</code>: master wants to read or write</li>
<li><code>data_o</code>: master wants to write the data</li>
<li><code>be_o</code>: master read/write byte enable, used to implement single byte write, etc.</li>
<li><code>data_i</code>: the data that the slave provides to the master for reading</li>
</ol>
<p>In addition to the clock are input, the rest of the above signals input and output symmetry, you can get the slave side (peripheral side) of the signal.</p>
<ol>
<li><code>clock_i</code>: clock input</li>
<li><code>valid_i</code>: high means master wants to send request</li>
<li><code>ready_o</code>: high means the slave is ready to process the request</li>
<li><code>addr_i</code>: the address that master wants to read or write to</li>
<li><code>we_i</code>: master wants to read or write</li>
<li><code>data_i</code>: the data that master wants to write</li>
<li><code>be_i</code>: master read/write byte enable, used to implement single byte write, etc.</li>
<li><code>data_o</code>: the data that the slave provides to the master for reading</li>
</ol>
<p>Based on the self-research bus we designed above, the following waveform can be plotted (with the master&rsquo;s signal as an example).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/90543758e4794322ab131a9d5c1ebb50.png" alt="waveform"></p>
<ul>
<li><code>a</code> cycle: at this time <code>valid_o=1 &amp;&amp; ready_i=1</code> means there is a request, at this time <code>we_o=1</code> means it is a write operation and the write address is <code>addr_o=0x01</code> and the data written is <code>data_o=0x12</code></li>
<li><code>b</code> cycle: at this point <code>valid_o=0 &amp;&amp; ready_i=0</code> means nothing happened</li>
<li><code>c</code> cycle: at this time <code>valid_o=1 &amp;&amp; ready_i=0</code> means master wants to read data (<code>we_o=0</code>) from address 0x02 (<code>addr_o=0x02</code>), but slave does not accept it (<code>ready_i=0</code>)</li>
<li><code>d</code> cycle: at this point <code>valid_o=1 &amp;&amp; ready_i=1</code> means there is a request, master reads data (<code>we_o=0</code>) from address 0x02 (<code>addr_o=0x02</code>), and the data read is 0x34 (<code>data_i=0x34</code>)</li>
<li><code>e</code> cycle: at this point <code>valid_o=0 &amp;&amp; ready_i=0</code> means nothing happened</li>
<li><code>f</code> cycle: at this time <code>valid_o=1 &amp;&amp; ready_i=1</code> means there is a request, master writes data (<code>we_o=1</code>) to address 0x03 (<code>addr_o=0x03</code>), the written data is 0x56 (<code>data_i=0x56</code>)</li>
<li><code>g</code> cycle: at this time <code>valid_o=1 &amp;&amp; ready_i=1</code> means there is a request, master reads data (<code>we_o=0</code>) from address 0x01 (<code>addr_o=0x01</code>), the data read is 0x12 (<code>data_i=0x12</code>)</li>
<li><code>h</code> cycle: at this point <code>valid_o=1 &amp;&amp; ready_i=1</code> means there is a request, master writes data (<code>we_o=1</code>) to address 0x02 (<code>addr_o=0x02</code>), the data written is 0x9a (<code>data_i=0x9a</code>)</li>
</ul>
<p>From the waveform above, several observations can be made.</p>
<ol>
<li>when the master wants to initiate a request, set <code>valid_o=1</code>; when the slave can accept the request, set <code>ready_i=1</code>; when <code>valid_o=1 &amp;&amp; ready_i=1</code>, it is considered as one request</li>
<li>If the master initiates the request and the slave cannot receive the request, i.e. <code>valid_o=1 &amp;&amp; ready_i=0</code>, the master should keep <code>addr_o</code>, <code>we_o</code>, <code>data_o</code> and <code>be_o</code> unchanged until the request ends</li>
<li>When the master does not initiate a request, i.e. <code>valid_o=0</code>, the signals on the bus are considered invalid and should not be processed; for read operations, the data on <code>data_i</code> is valid only when <code>valid_o=1 &amp;&amp; ready_i=1</code>.</li>
<li>The request can occur for multiple consecutive cycles, i.e. <code>valid_o=1 &amp;&amp; ready_i=1</code> is equal to one for multiple consecutive cycles, which is the ideal situation to achieve the highest transmission speed of the bus</li>
</ol>
<h2 id="wishbone-classic-standard">Wishbone Classic Standard</h2>
<p>First let&rsquo;s look at the simplest version of Wishbone, Wishbone Classic Standard, which is very similar to the above self-research bus, so let&rsquo;s take a look at its signals, such as the master side (CPU side).</p>
<ol>
<li><code>CLK_I</code>: clock input, i.e. <code>clock_i</code> in the self-developed bus</li>
<li><code>STB_O</code>: high means master wants to send a request, i.e. <code>valid_o</code> in the self-research bus</li>
<li><code>ACK_I</code>: High means the slave is processing the request, i.e. <code>ready_i</code> in the self-research bus</li>
<li><code>ADR_O</code>: the address that master wants to read or write, i.e. <code>addr_o</code> in the self-research bus</li>
<li><code>WE_O</code>: whether master wants to read or write, i.e. <code>we_o</code> in the self-study bus</li>
<li><code>DAT_O</code>: the data that master wants to write, i.e. <code>data_o</code> in the self-research bus</li>
<li><code>SEL_O</code>: master&rsquo;s byte read/write enable, i.e. <code>be_o</code> in the self-study bus</li>
<li><code>DAT_I</code>: data read by master from slave, i.e. <code>data_i</code> in the self-study bus</li>
<li><code>CYC_O</code>: enable signal of the bus, no corresponding self-research bus signal</li>
</ol>
<p>There are also some optional signals, so I won&rsquo;t go into them here. As you can see, except for the last one <code>CYC_O</code>, the other signals are actually the self-developed bus we just designed. The <code>CYC_O</code> can be considered as the master wants to occupy the slave&rsquo;s bus interface, and in common usage scenarios, it is directly considered as <code>CYC_O=STB_O</code>. It is used for the following purposes</p>
<ol>
<li>to occupy the bus interface of the slave and not allow other masters to access it</li>
<li>simplify the implementation of interconnect</li>
</ol>
<p>By replacing the waveform of the self-researched bus above with Wishbone Classic Standard, we get.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/d73bb26b65744fe887a6d843e625f0ef.png" alt="Wishbone Classic Standard"></p>
<h2 id="wishbone-classic-pipelined">Wishbone Classic Pipelined</h2>
<p>The Wishbone Classic Standard protocol above is very simple, but it runs into a problem: suppose the implementation is an SRAM controller that has a one-cycle delay for read operations, i.e., the address is given in one cycle and the result is not available until the next cycle. In Wishbone Classic Standard, the following waveform would appear.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/27f5875f6190448e90ef8d4df760e690.png" alt="waveform"></p>
<ul>
<li><code>a</code> cycle: master gives the read address 0x01, then the SRAM controller starts reading, but the data is not read back yet, so <code>ACK_I=0</code>.</li>
<li><code>b</code> cycle: SRAM finishes reading, put the read data 0x12 in <code>DAT_I</code> and set <code>ACK_I=1</code>.</li>
<li><code>c</code> cycle: master gives the next read address 0x02, SRAM has to start reading again</li>
<li><code>d</code> cycle: the SRAM finishes the second read, puts the read data 0x34 in <code>DAT_I</code> and sets <code>ACK_I=1</code>.</li>
</ul>
<p>From the waveform, there is no problem with the function, but only one read operation can be performed every two cycles, which does not bring out the highest performance. So how to solve this problem? We give the first address in <code>a</code> cycle and get the first data in <code>b</code> cycle, then if we can give the second address in <code>b</code> cycle, we can get the second data in <code>c</code> cycle. In this way, a pipelined read operation can be performed once per cycle. However, Wishbone Classic Standard requires that the first request is not finished by the <code>b</code> cycle, so we need to modify the protocol to implement a pipelined request.</p>
<p>The idea is simple: since Wishbone Classic Standard considers the first request to be pending at the <code>b</code> cycle, let the first request be completed earlier in the <code>a</code> cycle, except that its data will not be available until the <code>b</code> cycle. In fact, a read operation at this time can be considered as divided into two parts: first, the master sends a read request to the slave, which is completed in the <code>a</code> cycle; then the slave sends the result of the read to the master, which is completed in the <code>b</code> cycle. To achieve this, we make the following changes.</p>
<ul>
<li>Add <code>STALL_I</code> signal: <code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; STALL_I=0</code> to indicate a read request</li>
<li>Modify the meaning of <code>ACK_I</code> signal: <code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; ACK_I=1</code> means one read response</li>
</ul>
<p>With the above modifications, we have the Wishbone Classic Pipelined bus protocol. The waveforms of the two consecutive read operations above are shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/19/7b48a853c3bc4cac90cbd97a81bffb02.png" alt="waveforms"></p>
<ul>
<li><code>a</code> cycle: master requests read address 0x01, slave receives read request (<code>STALL_O=0</code>)</li>
<li><code>b</code> cycle: slave returns read request result 0x12 and sets <code>ACK_I=1</code>; at the same time master requests read address 0x02, slave receives read request (<code>STALL_O=0</code>)</li>
<li><code>c</code> cycle: slave returns the result of read request 0x34 and sets <code>ACK_I=1</code>; master does not initiate request anymore and sets <code>STB_O=0</code></li>
<li><code>d</code> cycle: all requests complete, master sets <code>CYC_O=0</code></li>
</ul>
<p>This way we have implemented a slave that performs one read operation per cycle.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/k8s-migrating/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The Complete Guide to Migrating Storage Across StorageClass in Kubernetes</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/k8s-reliability-list-data/">
            <span class="next-text nav-default">K8s Clustering Stability: Source Code Analysis of LIST Requests, Performance evaluation and tuning for large-scale base service deployments</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
