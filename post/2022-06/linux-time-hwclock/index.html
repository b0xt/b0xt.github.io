<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Usage of the hwclock command - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the usage scenarios and usage of hwclock command." /><meta name="keywords" content="linux, hwclock" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/linux-time-hwclock/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Usage of the hwclock command" />
<meta property="og:description" content="Learn the usage scenarios and usage of hwclock command." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/linux-time-hwclock/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-07T13:44:39+08:00" />
<meta property="article:modified_time" content="2022-06-07T13:44:39+08:00" />

<meta itemprop="name" content="Usage of the hwclock command">
<meta itemprop="description" content="Learn the usage scenarios and usage of hwclock command."><meta itemprop="datePublished" content="2022-06-07T13:44:39+08:00" />
<meta itemprop="dateModified" content="2022-06-07T13:44:39+08:00" />
<meta itemprop="wordCount" content="1061">
<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Usage of the hwclock command"/>
<meta name="twitter:description" content="Learn the usage scenarios and usage of hwclock command."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Usage of the hwclock command</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-07 13:44:39 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1061 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#time-synchronization">Time synchronization</a></li>
        <li><a href="#error-correction">Error correction</a></li>
        <li><a href="#ref">Ref</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Linux, there are several tools are related to time, recently work encountered them, so I intend to write a few articles related to Linux time.</p>
<p>Today, I&rsquo;d like to talk about <code>hwclock</code>, a tool that is probably used by those who play with the Internet of Things, because it is often used to keep the time of hardware devices, but most of the former devices are often networked, that is, they use NTP.</p>
<p>Also, Ubuntu 15.04 onwards uses <code>systemd</code> to manage time, and it comes with the <code>timedatectl</code> tool instead of <code>hwclock</code>, but it&rsquo;s essentially the same thing, so I won&rsquo;t go into it here.</p>
<h2 id="introduction">Introduction</h2>
<p>When a device is not networked, RTC becomes very important and the system time will rely on the energy of the coin cell battery to maintain. If the device needs to switch on and off frequently, then it will rely more on RTC to keep the device time synchronized.</p>
<p>Its principle is very simple, is to use the coin cell battery to drive the RTC (Real-Time Clock) chip to maintain the time when the device is powered off, so that when the device restarts, it can directly restore the time from the RTC.</p>
<p>First let&rsquo;s take a look at the help information of <code>hwclock</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Usage:
</span></span><span class="line"><span class="cl"> hwclock <span class="o">[</span><span class="k">function</span><span class="o">]</span> <span class="o">[</span>option...<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Time clocks utility.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Functions:
</span></span><span class="line"><span class="cl"> -r, --show           display the RTC <span class="nb">time</span>
</span></span><span class="line"><span class="cl">     --get            display drift corrected RTC <span class="nb">time</span>
</span></span><span class="line"><span class="cl">     --set            <span class="nb">set</span> the RTC according to --date
</span></span><span class="line"><span class="cl"> -s, --hctosys        <span class="nb">set</span> the system <span class="nb">time</span> from the RTC
</span></span><span class="line"><span class="cl"> -w, --systohc        <span class="nb">set</span> the RTC from the system <span class="nb">time</span>
</span></span><span class="line"><span class="cl">     --systz          send timescale configurations to the kernel
</span></span><span class="line"><span class="cl"> -a, --adjust         adjust the RTC to account <span class="k">for</span> systematic drift
</span></span><span class="line"><span class="cl">     --predict        predict the drifted RTC <span class="nb">time</span> according to --date
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl"> -u, --utc            the RTC timescale is UTC
</span></span><span class="line"><span class="cl"> -l, --localtime      the RTC timescale is Local
</span></span><span class="line"><span class="cl"> -f, --rtc &lt;file&gt;     use an alternate file to /dev/rtc0
</span></span><span class="line"><span class="cl">     --directisa      use the ISA bus instead of /dev/rtc0 access
</span></span><span class="line"><span class="cl">     --date &lt;time&gt;    date/time input <span class="k">for</span> --set and --predict
</span></span><span class="line"><span class="cl">     --delay &lt;sec&gt;    delay used when <span class="nb">set</span> new RTC <span class="nb">time</span>
</span></span><span class="line"><span class="cl">     --update-drift   update the RTC drift factor
</span></span><span class="line"><span class="cl">     --noadjfile      <span class="k">do</span> not use /etc/adjtime
</span></span><span class="line"><span class="cl">     --adjfile &lt;file&gt; use an alternate file to /etc/adjtime
</span></span><span class="line"><span class="cl">     --test           dry run<span class="p">;</span> implies --verbose
</span></span><span class="line"><span class="cl"> -v, --verbose        display more details
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -h, --help           display this <span class="nb">help</span>
</span></span><span class="line"><span class="cl"> -V, --version        display version
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here&rsquo;s how to use this command to solve two of our common problems.</p>
<h2 id="time-synchronization">Time synchronization</h2>
<p>First of all, it is necessary to distinguish two times, one is the hardware time, that is, the time in the hardware chip such as RTC, and the other is the system time, that is, the time in the system kernel.</p>
<p>In order to synchronize the time, it is enough to use two of its parameters.</p>
<ol>
<li>before shutdown, write the time from the system to the RTC: <code>hwclock --systohc</code>.</li>
<li>write the time from the RTC back to the system at boot time: <code>hwclock --hctosys</code>.</li>
</ol>
<p>Actually, this step is done to complete the time synchronization in the offline state. The device is able to reach the point where the device time stays synchronized with the real time in most cases.</p>
<p>But, if the time accuracy of the device is important, then you will need to use its correction function.</p>
<h2 id="error-correction">Error correction</h2>
<p>The RTC actually relies on a <code>32.768kHz</code> crystal, which is a quartz crystal, however, quartz crystals are unstable and become error prone especially when the temperature changes, and this error can reach one second or more per day.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/06/07/397c802202ce4cd19ef19b717f663d5c.png" alt="ppm of error"></p>
<p>The above graph is from <a href="https://www.ti.com/lit/ml/slap107/slap107.pdf">https://www.ti.com/lit/ml/slap107/slap107.pdf</a>, you can see from the graph that the temperature is too low or too high will cause the deviation to increase, and our equipment generally cannot be placed in a constant temperature environment, so it is bound to cause errors every day.</p>
<p>How to correct this error? There are hardware solutions and there are software solutions.</p>
<p>Hardware solutions, Texas Instruments gave a <a href="https://www.ti.com/lit/ml/slap107/slap107.pdf">program</a>, you can directly use the temperature sensor to compensate for the accuracy of the RTC, as unfamiliar with this piece of hardware, can not say a lot, just obviously, the hardware cost will increase some.</p>
<p>The software solution would be much plainer, <strong>because we can assume that the environment in which this device is located is constant and the deviation of the hardware time from the system time is systematic, to put it simply, it is fixed every other period, and the deviation of the time between them is actually the same</strong>. So, we use a software engineering perspective to calibrate at low cost, that is, the calibration function of <a href="https://man7.org/linux/man-pages/man8/hwclock.8.html">hwclock</a>.</p>
<p>It will use a file <a href="https://man7.org/linux/man-pages/man5/adjtime.5.html">adjfile</a> to record the status of the calibration, but first it is necessary to explain the format of <code>adjfile</code>, which defaults to <code>/etc/adjtime</code>, and its content contains 3 lines of text.</p>
<ul>
<li>The first line, containing three values.
<ul>
<li>System time offset per day (in seconds)</li>
<li>Last adjustment time (Unix timestamp)</li>
<li>Calibration status</li>
</ul>
</li>
<li>Second line: last calibration time (Unix timestamp)</li>
<li>Third line: &ldquo;UTC&rdquo; or &ldquo;LOCAL&rdquo; (usually only use UTC, don&rsquo;t use LOCAL to give yourself a hard time)</li>
</ul>
<p>The usage of the calibration is also very simple.</p>
<p>But before you start, first you need to make sure that the Linux kernel does not have automatic synchronization of system time to hardware time activated, otherwise it will be automatically synchronized by NTP&rsquo;s <em>11-minute mode</em>. To do this, run <code>adjtimex --print</code> or <code>adjtimex</code>, look at its status value and see if there is <code>UNSYNC</code>, if there is, it is not synchronized, or you need to calculate <code>status &amp; 0x40</code> yourself, if <code>1</code> means not synchronized.</p>
<ol>
<li>disable the ntp background process (if auto-sync is active) and disable it from starting with the system.</li>
<li>manually synchronize the system time once.</li>
<li>synchronize the system time to the RTC: <code>hwclock --systohc</code>, when the timestamp in <code>/etc/adjtime</code> will be updated, but at an offset of 0;</li>
<li>shut down and wait for at least one day.</li>
<li>turn on the computer, then immediately synchronize the system time manually once, then let hwclock synchronize to the RTC while automatically calculating the offset <code>hwclock --systohc --update-drift</code>.</li>
<li>check and confirm the offset in <code>/etc/adjtime</code>.</li>
<li>start and enable the ntp background process (if auto-sync is active)</li>
</ol>
<h2 id="ref">Ref</h2>
<ol>
<li><a href="https://www.ti.com/lit/ml/slap107/slap107.pdf">Implementing a Temperature Compensated RTC, PDF</a></li>
<li><a href="https://man7.org/linux/man-pages/man8/hwclock.8.html">hwclock - time clocks utility</a></li>
<li><a href="https://man7.org/linux/man-pages/man5/adjtime.5.html">adjtime - information about hardware clock setting and drift factor</a></li>
<li><a href="https://github.com/torvalds/linux/blob/9f4ad9e425a1d3b6a34617b8ea226d56a119a717/include/uapi/linux/timex.h">torvalds/linux:include/uapi/linux/timex.h</a></li>
</ol>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/linux/">linux</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/http3/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">IETF announces HTTP/3 standard, No. RFC 9114</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/coroutine-in-python/">
            <span class="next-text nav-default">Coroutine in Python</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
