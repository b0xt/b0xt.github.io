<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>What happens when you delete namespace in k8s - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore what happens when namespace is deleted in k8s." /><meta name="keywords" content="Kubernetes, delete namespace" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-06/k8s-del-namespace/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="What happens when you delete namespace in k8s" />
<meta property="og:description" content="Explore what happens when namespace is deleted in k8s." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-06/k8s-del-namespace/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-23T17:00:20+08:00" />
<meta property="article:modified_time" content="2022-06-23T17:00:20+08:00" />

<meta itemprop="name" content="What happens when you delete namespace in k8s">
<meta itemprop="description" content="Explore what happens when namespace is deleted in k8s."><meta itemprop="datePublished" content="2022-06-23T17:00:20+08:00" />
<meta itemprop="dateModified" content="2022-06-23T17:00:20+08:00" />
<meta itemprop="wordCount" content="1765">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="What happens when you delete namespace in k8s"/>
<meta name="twitter:description" content="Explore what happens when namespace is deleted in k8s."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">What happens when you delete namespace in k8s</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-06-23 17:00:20 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1765 words </span>
          <span class="more-meta"> 9 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-overview">1. Overview</a></li>
        <li><a href="#2-how-api-server-handles-namespace-deletion-requests">2. How api server handles namespace deletion requests</a></li>
        <li><a href="#3-finalizer-mechanism">3. finalizer mechanism</a></li>
        <li><a href="#4-the-working-mechanism-of-discoveryinterface">4. The working mechanism of DiscoveryInterface</a></li>
        <li><a href="#5-why-namespace-stays-in-terminating-state-for-a-long-time">5. Why namespace stays in terminating state for a long time</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-overview">1. Overview</h2>
<p>Namespace is an important concept in kubernetes, an abstraction of a set of resources and objects, often used to isolate different users. namespace has many resources under it, such as our common deployment, pods, service, ingress, configmap, and so on.</p>
<p>Of course, the focus of this article is on what happens when namespace is deleted. A typical scenario is when executing <code>kubectl delete ns test</code> in the terminal, we will observe that after executing the command, the test namespace will immediately enter the terminating state, and will only be actually deleted after a few seconds. This is even though there are no resources in the test namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">NAME              STATUS   AGE
</span></span><span class="line"><span class="cl">default           Active   2d2h
</span></span><span class="line"><span class="cl">docker            Active   2d2h
</span></span><span class="line"><span class="cl">kube-node-lease   Active   2d2h
</span></span><span class="line"><span class="cl">kube-public       Active   2d2h
</span></span><span class="line"><span class="cl">kube-system       Active   2d2h
</span></span><span class="line"><span class="cl">test              Active   4s
</span></span><span class="line"><span class="cl">test              Terminating   18s
</span></span><span class="line"><span class="cl">test              Terminating   23s
</span></span><span class="line"><span class="cl">test              Terminating   23s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, we will explore the following points in the following.</p>
<ul>
<li>How api-server handles namespace deletion requests</li>
<li>How to handle the resources in the namespace when deleting it</li>
</ul>
<h2 id="2-how-api-server-handles-namespace-deletion-requests">2. How api server handles namespace deletion requests</h2>
<p>Unlike other resources, namespace needs to be emptied when it is deleted. When namespace is terminating, it means that the resources under it have not been confirmed to be deleted. Therefore, when the api-server receives a request to delete a namespace, it does not immediately delete it from etcd, but first checks whether the metadata.DeletionTimestamp is empty. If it is empty, metadata.DeletionTimestamp is set to the current time, and then status.Phase is set to terminating. If metadata.DeletionTimestamp is not empty, then we have to determine if spec. If it is empty, then the namespace is actually deleted. This way, the namespace is not deleted if spec. So when is the finalizer added? How does it work?</p>
<h2 id="3-finalizer-mechanism">3. finalizer mechanism</h2>
<p>The finalizer of namespace is actually added at the time of creation. The processing logic can be seen in the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// PrepareForCreate clears fields that are not allowed to be set by end users on creation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">namespaceStrategy</span><span class="p">)</span> <span class="nf">PrepareForCreate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// on create, status is active
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">namespace</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">namespace</span><span class="p">.</span><span class="nx">Status</span> <span class="p">=</span> <span class="nx">api</span><span class="p">.</span><span class="nx">NamespaceStatus</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Phase</span><span class="p">:</span> <span class="nx">api</span><span class="p">.</span><span class="nx">NamespaceActive</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// on create, we require the kubernetes value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we cannot use this in defaults conversion because we let it get removed over life of object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hasKubeFinalizer</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Finalizers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Finalizers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">api</span><span class="p">.</span><span class="nx">FinalizerKubernetes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">hasKubeFinalizer</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">hasKubeFinalizer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Finalizers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">namespace</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Finalizers</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">api</span><span class="p">.</span><span class="nx">FinalizerName</span><span class="p">{</span><span class="nx">api</span><span class="p">.</span><span class="nx">FinalizerKubernetes</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">namespace</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Finalizers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Finalizers</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">FinalizerKubernetes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then the namespace changes to the terminating state when it is deleted and the namespace controller comes into play. The namespace controller is part of the controller manager and listens for namespace add and update events.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// configure the namespace informer event handlers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">namespaceInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandlerWithResyncPeriod</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">AddFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">namespace</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">namespaceController</span><span class="p">.</span><span class="nf">enqueueNamespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">namespace</span> <span class="o">:=</span> <span class="nx">newObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">namespaceController</span><span class="p">.</span><span class="nf">enqueueNamespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">resyncPeriod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And a workqueue is used to store the change events for each namespace. Then it all triggers <code>nm.namespacedResourcesDeleter.Delete(namespace.Name)</code>. Of course, if the namespace does not exist or if namespace.DeletionTimestamp is empty, it will exit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">namespace</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">nsClient</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">nsName</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">GetOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Otherwise the namespace&rsquo;s phase would be set to terminating first anyway.</p>
<p>This means that if a namespace is already terminating, you can&rsquo;t change the state of the namespace by just modifying the phase. I&rsquo;ve had a case before where I manually changed the phase to active when the namespace was terminating, but the namespace immediately became terminating, which is probably why.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// updateNamespaceStatusFunc will verify that the status of the namespace is correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">namespacedResourcesDeleter</span><span class="p">)</span> <span class="nf">updateNamespaceStatusFunc</span><span class="p">(</span><span class="nx">namespace</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">DeletionTimestamp</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="o">||</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="o">==</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">NamespaceTerminating</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">namespace</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newNamespace</span> <span class="o">:=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newNamespace</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="p">=</span> <span class="nx">namespace</span><span class="p">.</span><span class="nx">ObjectMeta</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newNamespace</span><span class="p">.</span><span class="nx">Status</span> <span class="p">=</span> <span class="o">*</span><span class="nx">namespace</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nf">DeepCopy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newNamespace</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Phase</span> <span class="p">=</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">NamespaceTerminating</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">nsClient</span><span class="p">.</span><span class="nf">UpdateStatus</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">newNamespace</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">UpdateOptions</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, an attempt is made to clear all the contents of the namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// there may still be content for us to remove
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">estimate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">deleteAllContent</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">estimate</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ResourcesRemainingError</span><span class="p">{</span><span class="nx">estimate</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-the-working-mechanism-of-discoveryinterface">4. The working mechanism of DiscoveryInterface</h2>
<p>Now we face a problem is how to clean up all the resources under the namespace? Normally, if we want to delete a pod, we can call the PodInterface interface provided by client-go to delete it, which is actually a wrapper for the RESTful HTTP DELETE action. But now, since we don&rsquo;t know what resources are under the namespace, there is no way to call the delete interface directly.</p>
<p>So client-go also provides a DiscoveryInterface, as the name implies, DicoveryInterface can be used to discover the API groups, versions, resources in the cluster. After getting a list of all the interface resources in the cluster, we can query and delete these resources.</p>
<p>The DicoveryInterface interface is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// DiscoveryInterface holds the methods that discover server-supported API groups,
</span></span></span><span class="line"><span class="cl"><span class="c1">// versions and resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">DiscoveryInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RESTClient</span><span class="p">()</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ServerGroupsInterface</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ServerResourcesInterface</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ServerVersionInterface</span>
</span></span><span class="line"><span class="cl">    <span class="nx">OpenAPISchemaInterface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>One of the ServerGroupInterface provides the ability to get all the interface groups in the cluster with the following function signatures.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// ServerGroups returns the supported groups, with information like supported versions and the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// preferred version.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerGroups</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIGroupList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ServerVersionInterface can be used to get the version information of the service, the specific function signature is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// ServerVersion retrieves and parses the server&#39;s version (git version).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerVersion</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">version</span><span class="p">.</span><span class="nx">Info</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we need to focus on the ServerResourcesInterface interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ServerResourcesInterface has methods for obtaining supported resources on the API server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerResourcesInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ServerResourcesForGroupVersion returns the supported resources for a group and version.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerResourcesForGroupVersion</span><span class="p">(</span><span class="nx">groupVersion</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResourceList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ServerResources returns the supported resources for all groups and versions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The returned resource list might be non-nil with partial results even in the case of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// non-nil error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Deprecated: use ServerGroupsAndResources instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerResources</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResourceList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ServerResources returns the supported groups and resources for all groups and versions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The returned group and resource lists might be non-nil with partial results even in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// case of non-nil error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerGroupsAndResources</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIGroup</span><span class="p">,</span> <span class="p">[]</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResourceList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ServerPreferredResources returns the supported resources with the version preferred by the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The returned group and resource lists might be non-nil with partial results even in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// case of non-nil error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerPreferredResources</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResourceList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ServerPreferredNamespacedResources returns the supported namespaced resources with the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// version preferred by the server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The returned resource list might be non-nil with partial results even in the case of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// non-nil error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ServerPreferredNamespacedResources</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResourceList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we can use ServerPreferredNamespacedResources to get a list of all resources that belong to namespace. Then filter out the resources that support DELETE. Finally, we get the GroupVersionResources (GVR for short) of these resources.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">resources</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">discoverResourcesFn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// discovery errors are not fatal.  We often have some set of resources we can operate against even if we don&#39;t have a complete list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">errs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">errs</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conditionUpdater</span><span class="p">.</span><span class="nf">ProcessDiscoverResourcesErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO(sttts): get rid of opCache and pass the verbs (especially &#34;deletecollection&#34;) down into the deleter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">deletableResources</span> <span class="o">:=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">FilteredBy</span><span class="p">(</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">SupportsAllVerbs</span><span class="p">{</span><span class="nx">Verbs</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;delete&#34;</span><span class="p">}},</span> <span class="nx">resources</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">groupVersionResources</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">GroupVersionResources</span><span class="p">(</span><span class="nx">deletableResources</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// discovery errors are not fatal.  We often have some set of resources we can operate against even if we don&#39;t have a complete list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">errs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">errs</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conditionUpdater</span><span class="p">.</span><span class="nf">ProcessGroupVersionErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, traverse these GVRs for deletion.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">gvr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">groupVersionResources</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gvrDeletionMetadata</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">deleteAllContentForGroupVersionResource</span><span class="p">(</span><span class="nx">gvr</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">namespaceDeletedAt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-why-namespace-stays-in-terminating-state-for-a-long-time">5. Why namespace stays in terminating state for a long time</h2>
<p>To find out why namespace stays in terminating state for a long time, let&rsquo;s look at the following very short piece of code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// there may still be content for us to remove
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">estimate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">deleteAllContent</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">estimate</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">ResourcesRemainingError</span><span class="p">{</span><span class="nx">estimate</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If an error is returned when deleting all resources in the namespace, or if the estimated time to finish deleting all resources is greater than 0, the pod will remain in the terminating state. For example, the pod will have a terminationGracePeriodSeconds, so you may have to wait for this period to pass when deleting the pod. But this does not cause any problems, we often encounter the headache that namespace has been unable to delete. Simply put, there must be resources under namespace that cannot be deleted, and there are several possibilities.</p>
<p><strong>Some resources have admissions that prevent deletion</strong>, because all deletion requests have to go through the admission webhook first, so it is possible that some resources cannot be deleted directly because of the admissions.</p>
<p><strong>apiservice is having problems</strong>. This problem can be confirmed by <code>kubectl get apiservice</code>. If there is false in the AVAILABLE column, we need to check why the apiservice is not available. If there is a problem with apiservice, the resources under this apiservice cannot be queried or operated by HTTP requests, so naturally, we cannot confirm whether there are still some resources left, and we cannot delete them completely.</p>
<p>Finally, regarding the solution for namespace can not be deleted, the solution given on the Internet is often to do it by emptying the spec.finalizers of the namespace, but this is the solution to the problem but not the root cause. Because if namespace cannot be deleted, it must mean that there is a defect or problem in your cluster, and the solution is to find out the real cause. You can also try to find out what the problem is with this tool: <a href="https://github.com/thyarles/knsk">https://github.com/thyarles/knsk</a></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-06/k8s-imbalances/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Resolving K8s scheduling imbalances</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-06/k8s-gc/">
            <span class="next-text nav-default">Garbage collection mechanism in kubernetes</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
