<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Stress testing of Prometheus-compatible timing databases - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the Prometheus-benchmark program offered by VictoriaMetrics." /><meta name="keywords" content="Prometheus, Prometheus-benchmark" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/prometheus-test/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Stress testing of Prometheus-compatible timing databases" />
<meta property="og:description" content="Explore the Prometheus-benchmark program offered by VictoriaMetrics." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/prometheus-test/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-22T10:35:54+08:00" />
<meta property="article:modified_time" content="2022-05-22T10:35:54+08:00" />

<meta itemprop="name" content="Stress testing of Prometheus-compatible timing databases">
<meta itemprop="description" content="Explore the Prometheus-benchmark program offered by VictoriaMetrics."><meta itemprop="datePublished" content="2022-05-22T10:35:54+08:00" />
<meta itemprop="dateModified" content="2022-05-22T10:35:54+08:00" />
<meta itemprop="wordCount" content="2663">
<meta itemprop="keywords" content="prometheus," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Stress testing of Prometheus-compatible timing databases"/>
<meta name="twitter:description" content="Explore the Prometheus-benchmark program offered by VictoriaMetrics."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Stress testing of Prometheus-compatible timing databases</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-22 10:35:54 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2663 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#implementation-principle">Implementation principle</a></li>
        <li><a href="#how-it-works">How it works</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>For comparison between different <code>VictoriaMetrics</code> versions or between <code>VictoriaMetrics</code> and other solutions that support the Prometheus remote_write protocol, <code>VictoriaMetrics</code> provides a dedicated <strong><a href="https://github.com/VictoriaMetrics/prometheus-benchmark">Prometheus-benchmark</a></strong> project.</p>
<h2 id="implementation-principle">Implementation principle</h2>
<p>The implementation of this project is actually very simple.</p>
<ul>
<li>Use <code>node_exporter</code> as a source for production-like metrics.</li>
<li>use nginx as a caching proxy in front of <code>node_exporter</code> to reduce the load on <code>node_exporter</code> when it crawls too many metrics.</li>
<li>Use <code>vmagent</code> to grab <code>node_exporter</code> metrics and forward them to the configured target using the Prometheus remote_write protocol. If multiple targets are set, multiple <code>vmagent</code> instances push the crawled data to those targets independently.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/22/6136b3c96c5c45aaa17fe47469701f4e.png" alt="Prometheus-benchmark"></p>
<p>However, note that the test does not collect metrics from the configured <code>remote_write</code> target, it only collects metrics from the internal components <code>vmagent</code> and <code>vmalert</code>, he will assume that the monitoring of the Prometheus storage system under test is done separately, for example, here we take a single node VictoriaMetrics as the target of <code>remote_write</code>, then we can monitor it ourselves.</p>
<p>The core implementation of the project is to continuously update the configuration file for grabbing metrics based on a set of incoming parameters, and then <code>vmagent</code> gets its configuration <code>-promscrape.config</code> to grab the metrics based on the interface exposed by the project, and the core code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="s">&#34;gopkg.in/yaml.v2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"> <span class="nx">listenAddr</span>                 <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;httpListenAddr&#34;</span><span class="p">,</span> <span class="s">&#34;:8436&#34;</span><span class="p">,</span> <span class="s">&#34;TCP address for incoming HTTP requests&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nx">targetsCount</span>               <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;targetsCount&#34;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">&#34;The number of scrape targets to return from -httpListenAddr. Each target has the same address defined by -targetAddr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nx">targetAddr</span>                 <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;targetAddr&#34;</span><span class="p">,</span> <span class="s">&#34;demo.robustperception.io:9090&#34;</span><span class="p">,</span> <span class="s">&#34;Address with port to use as target address the scrape config returned from -httpListenAddr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nx">scrapeInterval</span>             <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;scrapeInterval&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="s">&#34;The scrape_interval to set at the scrape config returned from -httpListenAddr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nx">scrapeConfigUpdateInterval</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;scrapeConfigUpdateInterval&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="s">&#34;The -scrapeConfigUpdatePercent scrape targets are updated in the scrape config returned from -httpListenAddr every -scrapeConfigUpdateInterval&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nx">scrapeConfigUpdatePercent</span>  <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;scrapeConfigUpdatePercent&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;The -scrapeConfigUpdatePercent scrape targets are updated in the scrape config returned from -httpListenAddr ever -scrapeConfigUpdateInterval&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="nx">flag</span><span class="p">.</span><span class="nf">VisitAll</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">flag</span><span class="p">.</span><span class="nx">Flag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;-%s=%s&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="nx">c</span> <span class="o">:=</span> <span class="nf">newConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">targetsCount</span><span class="p">,</span> <span class="o">*</span><span class="nx">scrapeInterval</span><span class="p">,</span> <span class="o">*</span><span class="nx">targetAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="kd">var</span> <span class="nx">cLock</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl"> <span class="nx">p</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">scrapeConfigUpdatePercent</span> <span class="o">/</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"> <span class="nx">r</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">NewSource</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"> <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">rev</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="k">range</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Tick</span><span class="p">(</span><span class="o">*</span><span class="nx">scrapeConfigUpdateInterval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rev</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">   <span class="nx">revStr</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;r%d&#34;</span><span class="p">,</span> <span class="nx">rev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">cLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ScrapeConfigs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">stc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">StaticConfigs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Float64</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nx">p</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">stc</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[</span><span class="s">&#34;revision&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">revStr</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">cLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="p">}()</span>
</span></span><span class="line"><span class="cl"> <span class="nx">rh</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cLock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">data</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">marshalYAML</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cLock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;text/yaml&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="nx">hf</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">rh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;starting scrape config updater at http://%s/&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">listenAddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="o">*</span><span class="nx">listenAddr</span><span class="p">,</span> <span class="nx">hf</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;unexpected error when running the http server: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">config</span><span class="p">)</span> <span class="nf">marshalYAML</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">yaml</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;BUG: unexpected error when marshaling config: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nx">data</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newConfig</span><span class="p">(</span><span class="nx">targetsCount</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">scrapeInterval</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">targetAddr</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">config</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">scs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">staticConfig</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">targetsCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">targetsCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">scs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">scs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">staticConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Targets</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">targetAddr</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Labels</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;instance&#34;</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;host-%d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;revision&#34;</span><span class="p">:</span> <span class="s">&#34;r0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Global</span><span class="p">:</span> <span class="nx">globalConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">ScrapeInterval</span><span class="p">:</span> <span class="nx">scrapeInterval</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ScrapeConfigs</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">scrapeConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">JobName</span><span class="p">:</span>       <span class="s">&#34;node_exporter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">StaticConfigs</span><span class="p">:</span> <span class="nx">scs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// config represents essential parts from Prometheus config defined at https://prometheus.io/docs/prometheus/latest/configuration/configuration/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">config</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">Global</span>        <span class="nx">globalConfig</span>    <span class="s">`yaml:&#34;global&#34;`</span>
</span></span><span class="line"><span class="cl"> <span class="nx">ScrapeConfigs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">scrapeConfig</span> <span class="s">`yaml:&#34;scrape_configs&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// globalConfig represents essential parts for `global` section of Prometheus config.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See https://prometheus.io/docs/prometheus/latest/configuration/configuration/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">globalConfig</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">ScrapeInterval</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="s">`yaml:&#34;scrape_interval&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// rapeConfig represents essential parts for `scrape_config` section of Prometheus config.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">scrapeConfig</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">JobName</span>       <span class="kt">string</span>          <span class="s">`yaml:&#34;job_name&#34;`</span>
</span></span><span class="line"><span class="cl"> <span class="nx">StaticConfigs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">staticConfig</span> <span class="s">`yaml:&#34;static_configs&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// staticConfig represents essential parts for `static_config` section of Prometheus config.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#static_config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">staticConfig</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nx">Targets</span> <span class="p">[]</span><span class="kt">string</span>          <span class="s">`yaml:&#34;targets&#34;`</span>
</span></span><span class="line"><span class="cl"> <span class="nx">Labels</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span> <span class="s">`yaml:&#34;labels&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can control the stress test by configuring some of the following parameters.</p>
<ul>
<li>
<p>targetsCount</p>
<p><code>targetsCount</code> defines how many <code>node_exporter</code> crawl targets are added to the <code>vmagent</code> crawl configuration, each containing a unique <code>instance</code> tag, and this parameter affects the number and base of crawl metrics. Typically, a <code>node_exporter</code> will generate about 815 unique indicators, so when <code>targetsCount</code> is set to 1000, the test will generate about <code>815*100=815K</code> of active time series.</p>
</li>
<li>
<p>scrapeInterval</p>
<p><code>scrapeInterval</code> defines the frequency of crawling each target, this parameter affects the data ingestion rate, the smaller the interval, the higher the data ingestion rate.</p>
</li>
<li>
<p>remoteStorage</p>
<p><code>remoteStorages</code> contains a list of systems to test and push the crawled metrics to, if multiple targets are set, multiple <code>vmagent</code> instances will push the same data to multiple targets respectively.</p>
</li>
<li>
<p>Churn rate</p>
<p><code>scrapeConfigUpdatePercent</code> and <code>scrapeConfigUpdateInterval</code> can be used to generate a non-zero time series churn rate, which is a very typical scenario in Kubernetes monitoring.</p>
</li>
</ul>
<h2 id="how-it-works">How it works</h2>
<p>A typical scenario is to run multiple VictoriaMetrics and then list their addresses in the <code>remoteStorages</code> section. The default configuration for this test is <code>targetsCount=1000</code> and <code>scrapeInterval=10s</code> resulting in approximately <code>80k samples/second</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="m">800</span> metrics-per-target * 1k targets / <span class="nv">10s</span> <span class="o">=</span> 80k samples/s
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can then compare resource usage, data compression, and overall performance with VictoriaMetrics&rsquo; official Grafana dasbhoards.</p>
<p>The project is installed by default via Helm Chart, which by default installs a single instance of VictoriaMetrics in single mode, directly Clone the project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git clone https://github.com/VictoriaMetrics/prometheus-benchmark
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> prometheus-benchmark
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then you can modify the <code>chart/values.yaml</code> configuration parameters according to your needs, my configuration here is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">vmtag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;v1.77.1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># targetsCount defines the number of nodeexporter instances to scrape.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This option allows to configure the number of active time series to push</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># to remoteStorages.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Every nodeexporter exposes around 815 unique metrics, so when targetsCount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># is set to 1000, then the benchmark generates around 815*100=815K active time series.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">targetsCount</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># scrapeInterval defines how frequently to scrape nodeexporter targets.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This option allows to configure data ingestion rate per every remoteStorages.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># For example, if the benchmark generates 815K active time series and scrapeInterval</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># is set to 10s, then the data ingestion rate equals to 815K/10s = 81.5K samples/sec.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scrapeInterval</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># queryInterval is how often to send queries from files/alerts.yaml to remoteStorages.readURL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This option can be used for tuning read load at remoteStorages.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># It is a good rule of thumb to keep it in sync with scrapeInterval.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">queryInterval</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># scrapeConfigUpdatePercent is the percent of nodeexporter targets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># which are updated with unique label on every scrape config update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># (see scrapeConfigUpdateInterval).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This option allows tuning time series churn rate.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># For example, if scrapeConfigUpdatePercent is set to 1 for targetsCount=1000,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># then around 10 targets gets updated labels on every scrape config update.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This generates around 815*10=8150 new time series every scrapeConfigUpdateInterval.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scrapeConfigUpdatePercent</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># scrapeConfigUpdateInterval specifies how frequently to update labels</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># across scrapeConfigUpdatePercent nodeexporter targets.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This option allows tuning time series churn rate.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># For example, if scrapeConfigUpdateInterval is set to 10m for targetsCount=1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># and scrapeConfigUpdatePercent=1, then around 10 targets gets updated labels every 10 minutes.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This generates around 815*10=8150 new time series every 10 minutes.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scrapeConfigUpdateInterval</span><span class="p">:</span><span class="w"> </span><span class="l">10m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># writeConcurrenty is the number of concurrent tcp connections to use</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># for sending the data to the tested remoteStorages.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Increase this value if there is a high network latency between prometheus-benchmark</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># components and the tested remoteStorages.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">writeConcurrency</span><span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># remoteStorages contains a named list of Prometheus-compatible systems to test.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># These systems must support data ingestion via Prometheus remote_write protocol.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># These systems must also support Prometheus querying API if query performance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># needs to be measured additionally to data ingestion performance.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">remoteStorages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vm-0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># writeURL 表示用来接收 Prometheus remote_write 协议的远程存储</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 例如：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># - 单节点VictoriaMetrics模式：http://&lt;victoriametrics-addr&gt;:8428/api/v1/write for single-node </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># - 集群VictoriaMetrics模式：http://&lt;vminsert-addr&gt;:8480/insert/0/prometheus/api/v1/write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">writeURL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://my-bench-prometheus-benchmark-vmsingle.default.svc.cluster.local:8428/api/v1/write&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># readURL 是可选的，如果需要测试测试的性能则需要配置，通过发送报警规则（files/alerts.yaml）给 readURL 进行测试</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 例如：</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># - 单节点VictoriaMetrics模式：http://&lt;victoriametrics-addr&gt;:8428/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># - 集群VictoriaMetrics模式：http://&lt;vmselect-addr&gt;:8481/select/0/prometheus/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">readURL</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://my-bench-prometheus-benchmark-vmsingle.default.svc.cluster.local:8428/&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">writeBearerToken</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">readBearerToken</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># vm-1:  # 如果有多个远程存储系统可以继续配置即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   writeURL: &#34;http://victoria-metrics-victoria-metrics-cluster-vminsert.default.svc.cluster.local:8480/insert/1/prometheus/api/v1/write&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#   readURL: &#34;http://victoria-metrics-victoria-metrics-cluster-vmselect.default.svc.cluster.local:8481/select/1/prometheus/&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The project code now comes with a single-node VictoriaMetrics by default, but the Charts template does not have a Service object added to it, which is not very convenient to operate. Let&rsquo;s add a chart/templates/vmsingle/service.yaml file with the following content.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">include &#34;prometheus-benchmark.fullname&#34; . }}-vmsingle</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Release.Namespace }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>{{- <span class="l">include &#34;prometheus-benchmark.labels&#34; . | nindent 4 }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l">vmsingle</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>{{- <span class="l">include &#34;prometheus-benchmark.selectorLabels&#34; . | nindent 4 }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8428</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8428</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After the configuration, execute the following command in the project root directory to start testing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ make install
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command will use Helm for installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods         
</span></span><span class="line"><span class="cl">NAME                                                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">grafana-db468ccf9-mtn87                                       1/1     Running   <span class="m">0</span>          90m
</span></span><span class="line"><span class="cl">my-bench-prometheus-benchmark-nodeexporter-76c497cf59-m5k66   2/2     Running   <span class="m">0</span>          49m
</span></span><span class="line"><span class="cl">my-bench-prometheus-benchmark-vmagent-vm-0-6bcbbb5fd8-8rhcx   2/2     Running   <span class="m">0</span>          49m
</span></span><span class="line"><span class="cl">my-bench-prometheus-benchmark-vmalert-vm-0-6f6b565ccc-snsk5   2/2     Running   <span class="m">0</span>          49m
</span></span><span class="line"><span class="cl">my-bench-prometheus-benchmark-vmsingle-585579fbf5-cpzhg       1/1     Running   <span class="m">0</span>          49m
</span></span><span class="line"><span class="cl">$ kubectl get svc 
</span></span><span class="line"><span class="cl">NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
</span></span><span class="line"><span class="cl">my-bench-prometheus-benchmark-nodeexporter   ClusterIP   10.96.156.144   &lt;none&gt;        9102/TCP   50m
</span></span><span class="line"><span class="cl">my-bench-prometheus-benchmark-vmsingle       ClusterIP   10.96.75.242    &lt;none&gt;        8428/TCP   50m
</span></span></code></pre></td></tr></table>
</div>
</div><p>One of the node-exporter applications contains two containers, one for the application itself and another for nginx wrapped with a layer to relieve the pressure on node-exporter. We can then configure Grafana to monitor the data source <code>http://my-bench-prometheus-benchmark-vmsingle:8428</code> and import a few of the official Grafana Dashboards provided by VictorialMetrics: <code>https://grafana.com/orgs/victoriametrics</code>.</p>
<p>The graph below shows the monitoring chart for <code>vmagent</code>, from the chart you can see that the metrics target for the crawl is now 2000, which is consistent with the above configuration, and no one has any errors, proving that <code>vmagent</code> is still within the pressure range.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/22/16cf23a5d6e944cda44620f29d5460fe.png" alt="vmagent"></p>
<p>We can also look at the monitoring charts for VictoriaMetrics, a single-node remote storage, and see that it is currently working properly and has over a million active time series.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/22/da452bc4caa64b8e987775927a9b1a6a.png" alt="VictoriaMetrics"></p>
<p>In addition to the above monitoring charts to see the results of the stress test, we can also go through some of the indicators below to verify that the stress level has been reached.</p>
<ul>
<li>Data ingestion rate</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sum<span class="o">(</span>rate<span class="o">(</span>vm_promscrape_scraped_samples_sum<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;vmagent&#34;</span><span class="o">}))</span> by <span class="o">(</span>remote_storage_name<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Number of packets discarded when sending packets to the configured remote store. If the value is greater than zero, the remote store rejects the incoming data. In this case, it is recommended to check the remote storage logs and vmagent logs.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sum<span class="o">(</span>rate<span class="o">(</span>vmagent_remotewrite_packets_dropped_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;vmagent&#34;</span><span class="o">}))</span> by <span class="o">(</span>remote_storage_name<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>The number of retries when sending data to the remote storage. If this value is greater than zero, then this indicates that the remote storage is unable to handle the workload. In this case, it is recommended to check the remote storage logs and vmagent logs.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sum<span class="o">(</span>rate<span class="o">(</span>vmagent_remotewrite_retries_count_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;vmagent&#34;</span><span class="o">}))</span> by <span class="o">(</span>remote_storage_name<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>The amount of pending data that has not yet been sent to the remote storage on the vmagent side. If the graph grows, the remote storage cannot keep up with the given data ingestion rate. You can try adding <code>writeConcurrency</code> to <code>chart/values.yaml</code>, which may help if there is high network latency between the vmagent of the prometheus benchmark.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sum<span class="o">(</span>vm_persistentqueue_bytes_pending<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;vmagent&#34;</span><span class="o">})</span> by <span class="o">(</span>remote_storage_name<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>The number of errors when executing queries from <code>chart/files/alerts.yaml</code>. If this value is greater than zero, the remote storage is unable to handle the query workload. In this case, it is recommended to check the remote storage logs and vmalert logs.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sum<span class="o">(</span>rate<span class="o">(</span>vmalert_execution_errors_total<span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&#34;vmalert&#34;</span><span class="o">}))</span> by <span class="o">(</span>remote_storage_name<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>These metrics can be queried by executing the <code>make monitor</code> command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ make monitor
</span></span><span class="line"><span class="cl">kubectl port-forward <span class="sb">`</span>kubectl -n default get pods -n default -l <span class="s1">&#39;job=vmsingle,chart-name=my-bench-prometheus-benchmark&#39;</span> -o name<span class="sb">`</span> <span class="m">8428</span>
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:8428 -&gt; <span class="m">8428</span>
</span></span><span class="line"><span class="cl">Forwarding from <span class="o">[</span>::1<span class="o">]</span>:8428 -&gt; <span class="m">8428</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above indicator can then be verified by visiting <code>http://127.0.0.1:8428/vmui</code> in your browser as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/22/2b47afa7295c48acbfa0012751fcc7f3.png" alt="indicator"></p>
<p>From our testing here 2000 crawl targets does not reach the upper limit, so we can continue to increase the value for testing, for example to 2500, and if the components are still working properly, then increase it to 3000 and continue testing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ make install
</span></span></code></pre></td></tr></table>
</div>
</div><p>For example, I tested 4000 crawled directories here, which means <code>800 metrics-per-target * 4k targets / 10s = 320k samples/s</code> still works fine, so it seems that VictoriaMetrics&rsquo; official claim that single-node mode can support one million samples per second is still relatively reliable.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/22/33f8da047c664bb3af95b6e7d69db82d.png" alt="VictoriaMetrics"></p>
<p>The test can be terminated by using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">make delete
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>When comparing different solutions or different versions of the same solution by stress testing the data accepted by the Prometheus remote_write protocol, we should be able to draw a general conclusion. For example, how do solutions such as Prometheus itself, Cortex, Thanos, M3DB and TimescaleDB perform, but we always recommend not to simply trust these benchmarks, but to verify the amount of production data and resource usage.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/prometheus/">prometheus</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/redis-handles-client/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How Redis handles client requests?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/tsl-1-3/">
            <span class="next-text nav-default">Should we use TLS1.3?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
