<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>In-depth look at the caching mechanism of http - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="With HTTP caching, you can reduce waiting time and network traffic, so what types of HTTP caches are available and how to implement these caching mechanisms?" /><meta name="keywords" content="Http Cache, Expires, cache-control, last-modified, etag" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/http-cache/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="In-depth look at the caching mechanism of http" />
<meta property="og:description" content="With HTTP caching, you can reduce waiting time and network traffic, so what types of HTTP caches are available and how to implement these caching mechanisms?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/http-cache/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-09T19:42:37+08:00" />
<meta property="article:modified_time" content="2022-05-09T19:42:37+08:00" />

<meta itemprop="name" content="In-depth look at the caching mechanism of http">
<meta itemprop="description" content="With HTTP caching, you can reduce waiting time and network traffic, so what types of HTTP caches are available and how to implement these caching mechanisms?"><meta itemprop="datePublished" content="2022-05-09T19:42:37+08:00" />
<meta itemprop="dateModified" content="2022-05-09T19:42:37+08:00" />
<meta itemprop="wordCount" content="2693">
<meta itemprop="keywords" content="http," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In-depth look at the caching mechanism of http"/>
<meta name="twitter:description" content="With HTTP caching, you can reduce waiting time and network traffic, so what types of HTTP caches are available and how to implement these caching mechanisms?"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">In-depth look at the caching mechanism of http</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-09 19:42:37 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2693 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-strong-caching">1. Strong caching</a>
          <ul>
            <li><a href="#11-expires">1.1 Expires</a></li>
            <li><a href="#12-cache-control">1.2 cache-control</a></li>
            <li><a href="#13-other-uses-of-cache-control">1.3 Other uses of cache-control</a></li>
            <li><a href="#14-priority-of-cache-control-and-expires">1.4 Priority of cache-control and Expires</a></li>
            <li><a href="#15-difference-between-memory-cache-and-disk-cache">1.5 Difference between memory cache and disk cache</a></li>
          </ul>
        </li>
        <li><a href="#2-negotiating-the-cache">2. Negotiating the cache</a>
          <ul>
            <li><a href="#21-last-modified">2.1 last-modified</a></li>
            <li><a href="#22-etag">2.2 etag</a></li>
            <li><a href="#221-caching-with-etags">2.2.1 Caching with etags</a></li>
            <li><a href="#222-etag-and-last-modified">2.2.2 etag and last-modified</a></li>
          </ul>
        </li>
        <li><a href="#3-summary">3. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>By reusing previously acquired resources, you can significantly improve the performance of your website and applications. Web caching reduces wait times and network traffic. By using HTTP caching, it becomes more responsive.</p>
<p>Typically http caching is divided into strong caching and negotiated caching.</p>
<h2 id="1-strong-caching">1. Strong caching</h2>
<p>Use browser local cache directly within the agreed fixed time. This approach is suitable for resources that are not updated frequently, such as js,css,image and other static resources; also this is a disadvantage, if the cache time is set too long, the updated content is not timely; if the cache time is set too short, it causes the problem that the content is not updated, but the cache time is up.</p>
<p>There are two general ways to set strong caching.</p>
<ol>
<li>setting the expiration point of the current resource through Expires.</li>
<li>setting the cache time from the first request through cache-control.</li>
</ol>
<h3 id="11-expires">1.1 Expires</h3>
<p>Set this field on the server side to indicate the expiration time of this resource.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Expires: Wed, 21 Oct 2017 07:28:00 GMT
</span></span></code></pre></td></tr></table>
</div>
</div><p>The browser then takes its local time and compares it to the time in this field, and if it has not yet reached its expiration time, it continues to use the cache, otherwise it generates a new request.</p>
<p>This presents a problem in that the length of that resource cache is related to its local time, e.g. setting the local computer time in 2039 for all resources currently being sent down, cannot be cached.</p>
<h3 id="12-cache-control">1.2 cache-control</h3>
<p>Expires is a field that existed since HTTP 1.0. To solve the above problem with Expires, the <code>cache-control</code> field was introduced in HTTP 1.1. Instead of using a uniform expiration time, this field tells the browser how long to cache the request, starting from the first time it is received.</p>
<p>If we build a simple http service with nodejs, setting this field is also simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">http</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;get static request:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;cache-control&#39;</span><span class="o">:</span> <span class="s1">&#39;public, max-age=31536000&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;console.log(Date.now())&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3031</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you use <code>express</code>, you can set it up like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;get static request:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 下面的3种方式都可以
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">,</span> <span class="s1">&#39;public, max-age=600&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// res.header(&#39;cache-control&#39;, &#39;public, max-age=600&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// res.set({ &#39;cache-control&#39;: &#39;public, max-age=600&#39; });
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;console.log(Date.now())&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3031</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the cache works, the resource is prompted <code>from memory cache</code> or <code>from disk cache</code> and the server no longer receives the request.</p>
<p>In Chrome, when refreshing a page, you will see that cache-control or Expires is disabled. This is because Google Chrome ignores the header Cache-Control or Expires header if the request is made immediately after another request for the same URI in the same tab (by clicking the refresh button, or F5, or something like that). It may have an algorithm to guess what the user really wants to do. One way to test the Cache-Control header is to return an HTML document with a link to itself. When that link is clicked, Chrome drops the document from its cache.</p>
<p>So how can I see the effect? Open a new window, open the console, then request the link again and you&rsquo;ll see that it&rsquo;s gone cached, <a href="https://stackoverflow.com/questions/11245767/is-chrome-ignoring-cache-control-max-age">Is Chrome ignoring Cache-Control: max-age?</a>.</p>
<h3 id="13-other-uses-of-cache-control">1.3 Other uses of cache-control</h3>
<h4 id="131-components-of-cache-control">1.3.1 Components of cache-control</h4>
<p>The value of cache-control consists of 3 main parts, any of which can be used individually or in combination (see the document <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control">Cache-Control</a>).</p>
<ul>
<li>
<p>Cacheability: i.e., how the resource is cached</p>
<ul>
<li>public: indicates that the response can be cached by any object (including: the client sending the request, the proxy server, etc.), even if the content is not normally cacheable. (For example: 1. the response does not have a max-age directive or Expires message header; 2. the response corresponds to a request method that is POST.) private: indicates that the response can only be cached.</li>
<li>private: indicates that the response can only be cached by a single user, not as a shared cache (i.e., the proxy server cannot cache it). A private cache can cache the content of the response, e.g., the local browser of the corresponding user.</li>
<li>no-cache: forces the cache to submit the request to the original server for validation (negotiated cache validation) before publishing a cached copy.</li>
<li>no-store: The cache should not store anything about the client request or the server response, i.e., no cache is used. This <code>no-store</code> is stricter than <code>no-cache</code>, where no-cache is a no-go strong cache, but negotiated cache can still be used, but no-store is a no-cache of any content.</li>
</ul>
</li>
<li>
<p>Expiration time</p>
<ul>
<li><code>max-page=&lt;seconds&gt;</code>: Sets the maximum period of cache storage beyond which the cache is considered expired (in seconds). In contrast to Expires, the time is relative to the time of the request.</li>
<li><code>s-maxage=&lt;seconds&gt;</code>: overrides the max-age or Expires header, but only for shared caches (such as individual proxies); private caches will ignore it.</li>
</ul>
</li>
<li>
<p>Revalidate and reload</p>
<ul>
<li>must-revalidate: Once a resource has expired (e.g. has exceeded max-age), the cache cannot respond to subsequent requests with that resource until it has successfully validated with the original server.</li>
<li>proxy-revalidate: Works the same as must-revalidate, but it only applies to shared caches (such as proxies) and is ignored by private caches.</li>
<li>immutable Experimental: Indicates that the response body does not change over time. The resource (if not expired) does not change on the server, so the client should not send a revalidation request header (such as If-None-Match or If-Modified-Since) to check for updates, even if the user explicitly refreshes the page. In Firefox, immutable can only be used for <code>https://</code> transactions.</li>
</ul>
</li>
</ul>
<h4 id="132-example-of-use">1.3.2 Example of use</h4>
<p>These values can be used in any combination, e.g.</p>
<p>Files that are generally not too altered can be cached in all segments for 600s (↓).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cache-control: public, max-age<span class="o">=</span>600<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Close the cache, no storage anywhere (↓).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cache-control: no-store<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Clients can cache resources, but must re-validate them each time (↓), e.g. by specifying <code>no-cache</code> or <code>max-age=0</code> , <code>must-revalidate</code>, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Cache-Control: no-cache;
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Cache-Control: max-age=0, must-revalidate;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="14-priority-of-cache-control-and-expires">1.4 Priority of cache-control and Expires</h3>
<p>Both of these fields determine the expiration time of a resource, so if both are present, which one will the browser choose?</p>
<p>As defined in <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9.3">RFC2616</a>.</p>
<blockquote>
<p>If a response includes both an Expires header and a max-age directive, the max-age directive overrides the Expires header, even if the Expires header is more restrictive. This rule allows an origin server to provide, for a given response, a longer expiration time to an HTTP/1.1 (or later) cache than to an HTTP/1.0 cache. This might be useful if certain HTTP/1.0 caches improperly calculate ages or expiration times, perhaps due to desynchronized clocks.</p>
</blockquote>
<p>When both are present, max-age has higher priority.</p>
<h3 id="15-difference-between-memory-cache-and-disk-cache">1.5 Difference between memory cache and disk cache</h3>
<p>Memory cache is the cache in memory, which mainly contains the resources that have been crawled in the current page, such as styles, scripts, images, etc. that have been downloaded from the page. Although the memory cache is efficient for reading, the cache is short-lived and will be released with the release of the process. Once we close the Tab page, the in-memory cache is also released.</p>
<p>So since the in-memory cache is so efficient, can&rsquo;t we just keep all the data in memory?</p>
<p>This is not possible. The memory in a computer must be much smaller than the hard disk, and the operating system needs to be careful about how much memory it uses, so we must not have much memory to use.</p>
<p>When we refresh the page again after visiting it, we can find that much of the data comes from the memory cache.</p>
<p>An important cached resource in the memory cache is the resource downloaded by the preloader directive (for example). The preloader directive is known to be a common means of page optimization, parsing js/css files while the next resource is requested on the network.</p>
<p>One thing to note is that <strong>memory cache does not care about the value of the HTTP cache header Cache-Control of the returned resource when caching it, and the matching of resources is not just for URLs, but may also be for other features such as Content-Type, CORS, etc.</strong>.</p>
<p>Disk Cache is also a cache stored in the hard disk, the read speed is slower, but everything can be stored to disk, compared to Memory Cache wins in capacity and storage timeliness.</p>
<p>Of all browser caches, Disk Cache has basically the largest coverage. It determines which resources need to be cached based on fields in HTTP Herder, which resources can be used directly without requesting them, and which resources have expired and need to be re-requested. And even in the case of cross-site, once a resource at the same address is cached by the drive, it will not be requested again. The vast majority of caching comes from Disk Cache, which is described in more detail below in the protocol header field for HTTP.</p>
<p>What files does the browser throw into memory? What goes to the hard drive?</p>
<p>There are different opinions on this, but the following are more reliable.</p>
<ul>
<li>For large files, the probability is that they are not stored in memory, and the reverse takes precedence.</li>
<li>files are stored into the hard disk first if the current system memory usage is high.</li>
</ul>
<p>The process of requesting data under strong cache.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/09/4dbd6b4557d546429477c043d9eeb08e.png" alt="process of requesting data"></p>
<h2 id="2-negotiating-the-cache">2. Negotiating the cache</h2>
<p>Based on the content&rsquo;s last-modified time (Last-Modified), or identifier (ETag), to determine if the content has changed, and if not, tell the browser to just use the cache, otherwise return the latest content.</p>
<p>Negotiating the cache is done each time the server is requested, and then the server verifies whether to go to the cache, or to send down new content. When the client-side cache can be used, it simply returns the <code>304</code> status code.</p>
<h3 id="21-last-modified">2.1 last-modified</h3>
<p><code>last-modified</code> is a response header that indicates when a resource was last modified and is used to determine if the received or stored resources are consistent with each other.</p>
<h4 id="211-using-last-modified-to-implement-caching">2.1.1 Using last-modified to implement caching</h4>
<p>If the last response has a <code>last-modified</code> field, then later requests for resources will automatically have an <code>If-Modified-Since</code> field in the header with the value returned by the last-modified. Our server can compare this <code>If-Modified-Since</code> field with the modification time of the resource, and if there is no change, it will return <code>304</code> directly, and if there is a change, it will send the new content and the new <code>last-modified</code> field.</p>
<p>Let&rsquo;s take express framework as an example to implement this caching logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">lastModifiedTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;get static request:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取请求头中的 if-modified-since ，若有该字段，且能与上次的修改时间相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 则直接返回304
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">ifModifiedSince</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;if-modified-since&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">ifModifiedSince</span> <span class="o">&amp;&amp;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">ifModifiedSince</span><span class="p">).</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">===</span> <span class="nx">lastModifiedTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">304</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;./app/static/hunger.js&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 读取文件时，实际上应当使用 createReadStream ，我们使用readFile仅是为了方便演示，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 因为使用readFile在高并发时，会产生内存积压的问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// readFile会将所有的内容都读取到内存中，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 而 createReadStream 则是分片读取，只要读取了内容就会传向下一个管道
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span> <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf8&#39;</span> <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;read file error&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">mtimeMs</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 存储该文件最后的修改时间，并将其设置为响应头进行返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lastModifiedTime</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">mtimeMs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;last-modified&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">lastModifiedTime</span><span class="p">).</span><span class="nx">toGMTString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3031</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This allows you to determine whether to use caching by the modification time of a resource.</p>
<h4 id="212-defects-of-last-modified">2.1.2 Defects of last-modified</h4>
<p>However, this field is not very accurate when determining consistency for the following reasons.</p>
<ol>
<li>last-modified is only accurate to the second level at most, so if there are multiple modifications within 1 second, it will be considered as no changes.</li>
<li>if there are duplicate uploads of the file, or if the document is opened and then saved, this may result in a modification of the time, but the content does not actually change.</li>
</ol>
<p>In response to these problems, another <code>etag</code> response field has appeared in the http protocol.</p>
<h3 id="22-etag">2.2 etag</h3>
<p>An etag is an identifier, such as hash value, for the content of a resource. This makes caching more efficient and saves bandwidth, since the web server does not need to send a full response if the content has not changed. And if the content changes, using an ETag helps prevent simultaneous updates to resources from overwriting each other (&ldquo;collisions in the air&rdquo;).</p>
<p>If the content of a resource in a given URL changes, a new Etag value must be generated. Etags are therefore similar to fingerprints and may also be used by some servers for tracking purposes. Comparing etags can quickly determine if this resource has changed, but it may also be permanently retained by the tracking server.</p>
<h3 id="221-caching-with-etags">2.2.1 Caching with etags</h3>
<p>If the last response had an <code>etag</code> field, then subsequent requests for resources will automatically have an <code>If-None-Match</code> field in the header with the value returned by the last etag. Our server can compare this <code>If-None-Match</code> field with the tag of the resource, and if there is no change, it will return <code>304</code> directly, and if there is a change, it will send the new content and the new <code>etag</code> field.</p>
<p>Let&rsquo;s take express framework as an example to implement this caching logic.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">md5</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">etag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;get static request:&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取请求头中的 if-none-match ，若有该字段，且能与上次的etag相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 则直接返回304
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">ifNoneMatch</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;if-none-match&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">ifNoneMatch</span> <span class="o">&amp;&amp;</span> <span class="nx">ifNoneMatch</span> <span class="o">===</span> <span class="nx">etag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">304</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;./app/static/hunger.js&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 同理这里实际上我们最好使用 createReadStream
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span> <span class="nx">encoding</span><span class="o">:</span> <span class="s1">&#39;utf8&#39;</span> <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;read file error&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里我们使用md5来生成etag标识
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">etag</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;etag&#39;</span><span class="p">,</span> <span class="nx">etag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3031</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="222-etag-and-last-modified">2.2.2 etag and last-modified</h3>
<p>When both etag and last-modified are present, etag has higher priority; similarly, if-none-match has higher priority than if-modified-since.</p>
<p>Also, etag has better granularity of control over resource updates than last-modified, so no matter how the source file is modified, as long as the content remains the same, etag remains the same and the cache can be used forever.</p>
<p>The request flow under negotiated caching.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/09/33ef1770850c454d885dc3af33c172b3.png" alt="request flow under negotiated caching"></p>
<h2 id="3-summary">3. Summary</h2>
<p>We have explained the mechanism and implementation of mandatory caching and negotiated caching, and you can decide which caching method to use and how long to cache based on the caching characteristics of your resources.</p>
<p>In general, mandatory caching has a higher priority than negotiated caching, giving priority to determining whether mandatory caching exists.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/09/41c4240c268b4bfab9c6e8d85898c2c6.png" alt="http caching mechanism"></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/http/">http</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/docker-context/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Connecting to remote nodes using Docker Context</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/victoriametrics-bloomfilter/">
            <span class="next-text nav-default">VictoriaMetrics Source Code Analysis - Bloom Filter</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
