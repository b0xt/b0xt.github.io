<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Webassembly Basics - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the basics of webassembly." /><meta name="keywords" content="Webassembly" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/webassembly/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Webassembly Basics" />
<meta property="og:description" content="Learn the basics of webassembly." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/webassembly/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-17T18:52:05+08:00" />
<meta property="article:modified_time" content="2022-05-17T18:52:05+08:00" />

<meta itemprop="name" content="Webassembly Basics">
<meta itemprop="description" content="Learn the basics of webassembly."><meta itemprop="datePublished" content="2022-05-17T18:52:05+08:00" />
<meta itemprop="dateModified" content="2022-05-17T18:52:05+08:00" />
<meta itemprop="wordCount" content="2363">
<meta itemprop="keywords" content="Webassembly," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Webassembly Basics"/>
<meta name="twitter:description" content="Learn the basics of webassembly."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Webassembly Basics</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-17 18:52:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2363 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-what-is-webassembly">1. What is webassembly?</a></li>
        <li><a href="#2-why-use-webassembly">2. Why use webassembly</a></li>
        <li><a href="#3-webassembly-vs-javascript">3. webassembly vs javascript</a>
          <ul>
            <li><a href="#31-jit-just-in-time-in-v8">3.1 JIT (just in time) in v8</a></li>
            <li><a href="#32-why-webassembly-is-faster">3.2 Why webassembly is faster</a></li>
            <li><a href="#33-what-does-webassembly-look-like-wasm-format-and-wat-format">3.3 What does webassembly look like? (wasm format and wat format)</a></li>
            <li><a href="#34-communication-in-webassembly-and-js">3.4 Communication in webassembly and js</a></li>
          </ul>
        </li>
        <li><a href="#4-write-a-webassembly-demo">4. write a webassembly demo</a>
          <ul>
            <li><a href="#41-c-implementation-of-an-accumulation-function">4.1 c++ implementation of an accumulation function</a></li>
            <li><a href="#42-generating-wasm-files-with-emscripten">4.2 Generating .wasm files with emscripten</a></li>
            <li><a href="#43-how-to-call-the-generated-wasm-file-in-js">4.3 How to call the generated .wasm file in js</a></li>
            <li><a href="#44-rough-comparison-of-computational-performance">4.4 Rough comparison of computational performance</a></li>
          </ul>
        </li>
        <li><a href="#5-runtime-for-webassembly">5. runtime for webassembly</a>
          <ul>
            <li><a href="#wasmer">wasmer</a></li>
          </ul>
        </li>
        <li><a href="#6-webassembly-now-in-use-scenarios">6. webassembly now in use scenarios</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-what-is-webassembly">1. What is webassembly?</h2>
<p>Historically, virtual machines used to load only JavaScript, and that&rsquo;s good enough for us, because JavaScript is powerful enough to solve most of the problems people have on the web today. However, when trying to apply JavaScript to areas such as 3D games, virtual reality, augmented reality, computer vision, image/video editing, and a host of other areas that require native performance, we run into performance issues (copied above from mdn).</p>
<p>webassembly, which we analyze semantically as web + assembly, is an assembly language applied on the web, it is not a replacement for javascript, I think they are complementary, using webassembly for the strong computational part. The interaction with the page can take advantage of the simplicity and ease of use of javascript.</p>
<p>webassembly is the fourth w3c standard after css, html, and javascript. webassembly is not <strong>expected</strong> to be used by developers to write code directly in webassembly, but rather to be able to compile other high-level languages such as C/C++/Rust into webassembly. webassembly.** As of today, all browsers and node.js (even v8) already have a webassembly virtual machine, which means that webassembly is supported in these environments.</p>
<h2 id="2-why-use-webassembly">2. Why use webassembly</h2>
<ol>
<li>
<p>Make &ldquo;native&rdquo; modules less complex</p>
<p>Runtimes (such as Node or Python&rsquo;s CPython) often allow you to write modules in low-level languages (such as C++). This is because these low-level languages are usually much faster. So you can use native modules in Node, or extended modules in Python. But these modules are often hard to use because they need to be compiled on the user&rsquo;s device. With WebAssembly&rsquo;s &ldquo;native&rdquo; modules, you can get about the same speed and avoid the complexity.</p>
</li>
<li>
<p>Easier sandboxing to run native code</p>
<p>On the other hand, low-level languages like Rust won&rsquo;t expect WebAssembly to run faster, but they will use WebAssembly for security. But they will use WebAssembly for security, and as we discussed in the WASI announcement, WebAssembly provides you with lightweight sandboxing by default. So, a voice like Rust can sandbox native code modules with WebAssembly.</p>
</li>
<li>
<p>Share Native Code Across Platforms</p>
<p>Developers can save development time and reduce maintenance costs if they can share the same code base across different platforms (for example, in Web and desktop applications). This is true for both scripting languages and low-level languages, and WebAssembly gives you a way to do this without degrading the performance of these platforms.</p>
</li>
</ol>
<h2 id="3-webassembly-vs-javascript">3. webassembly vs javascript</h2>
<p>The development of js speed is shown below. In 2008, JIT technology was introduced, which made javascript almost 10 times faster, which allowed us to write server-side content in js. And in 2017, webassembly came along, which will be another turning point.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/29d2ae53efd4402c98bcc4eaf860b6e6.png" alt="webassembly"></p>
<h3 id="31-jit-just-in-time-in-v8">3.1 JIT (just in time) in v8</h3>
<p>To talk about why webassembly is fast, we need to talk about how javascript works and JIT technology. It is well known that javascript is a high-level language, and if you want a machine to understand it, you need a &ldquo;translator&rdquo; &mdash;- interpreter or compiler to translate the high-level language into machine language, simply understand the interpreter is a real-time translation machine, like simultaneous interpretation, while the compiler is to translate all the high-level language in advance, and then handed to the machine, javascript is an interpreted language, meaning that the translation process is a &ldquo;translation&rdquo; process. meaning that the translation process is &ldquo;on the fly&rdquo;, line by line translation, line by line execution. A language like c++ is translated in advance using a compiler and then run.</p>
<p>Interpreter</p>
<ul>
<li>The advantage is that it starts fast, because you don&rsquo;t need to compile it in advance.</li>
<li>The downside is that let&rsquo;s say you have a for loop, which means you have to translate the same line of code over and over again, doing the same thing, without being able to do some optimization.</li>
</ul>
<p>Compiler</p>
<ul>
<li>The advantage is that because it is translated in advance, the code can be optimized before running, which speeds up the runtime.</li>
<li>The disadvantage is that it is too slow to start and has to be compiled first.</li>
</ul>
<h4 id="compiler-optimization">Compiler optimization</h4>
<p>Then JIT technology is the original JS only Interpreter technology added to the Compiler! In the process of real-time translation with interpreter added some features of the compiler, such as a line of code is executed many times, js engine will set it to &quot; Warm&quot; for a series of super-optimization, and then &ldquo;Hot&rdquo; for the ultimate optimization when it is executed again.</p>
<h4 id="type-specialization">Type specialization</h4>
<p>For example, in js, because types are dynamic, the type of each element in an array is not certain, it could be object, it could be string, it could be number, which means that when you iterate each element of the array, you have to do a series of type checks and so on. When JIT technology is introduced, our js engine may run into the case that the first ten elements are all number, and then boldly predict that the next ones will also be number (of course, they will be checked later).</p>
<h3 id="32-why-webassembly-is-faster">3.2 Why webassembly is faster</h3>
<p>Ok, after the JIT of js, let&rsquo;s summarize the process of executing js and webassembly.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/adccec9336da4032abb03cbeb99c5377.png" alt="webassembly"></p>
<ol>
<li>
<p>first look at the fetching part, webassembly code is more compact, because js to be more human-readable, so the code mentioned compared to assembly language will be larger. 2. parse/decode process, js need to first into ast, and then through ast to generate IR (intermediate representation), IR and then generate machine code (x86 or arm).</p>
</li>
<li>
<p>parse/decode process, js needs to be converted into ast, then through ast to IR (intermediate representation), IR then generate machine code (x86 or arm). webassembly does not need this conversion process. See the figure below. You can see that webassembly can generate machine code directly.
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/3b647af9b7cd41778a273fe7aa4af0f2.png" alt="webassembly"></p>
</li>
<li>
<p>the process of compile + optimize is described in the JIT section, the js engine has to optimize while running, let&rsquo;s say watch the type of data change or something like that, while webassembly is closer to the underlying machine code, the data type or something is fixed.</p>
</li>
<li>
<p>In addition, there is also the process of reoptimization in JS. In the type specialization section of the JIT, it is mentioned that the js engine has to predict the type in order to improve performance, and there are definitely times when it fails, so there is a need for reoptimization in the execution of js.</p>
</li>
<li>
<p>As for the execution part, because webassembly is more low-level (see the following subsection for the two formats of webassembly, wasm and wat formats) than js, even if the final machine code is generated, the degree of optimization that the code written by the webassembly developer must be greater than the optimization that can be done by js.</p>
</li>
<li>
<p>the GC process is easy to understand. gc in high-level languages that can be converted to webassembly requires manual processing by the developer, while it is automatic in js.</p>
</li>
</ol>
<h3 id="33-what-does-webassembly-look-like-wasm-format-and-wat-format">3.3 What does webassembly look like? (wasm format and wat format)</h3>
<p>After all this talk, what does webassembly really look like?</p>
<p>Let&rsquo;s write a simple c++ method as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// test.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">addAll</span><span class="p">(</span><span class="kt">int</span> <span class="n">times</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">n</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>wasm suffix file: the executable file format that is put directly on the webassembly virtual machine, we use the <code>Emscripten</code> tool to generate a wasm file from the above c++ file, the command is: <code>emcc -O3 -s &quot;EXPORTED_FUNCTIONS=['_addAll']&quot; -o test .wasm test.c --no-entry</code>, which exports the addAll method in the wasm file, and the resulting wasm is a binary (actually hexadecimal) file. Open the text.wasm file as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">00 61 73 6D 0D 00 00 00 01 86 80 80 80 00 01 60
</span></span><span class="line"><span class="cl">01 7F 01 7F 03 82 80 80 80 00 01 00 04 84 80 80
</span></span><span class="line"><span class="cl">80 00 01 70 00 00 05 83 80 80 80 00 01 00 01 06
</span></span><span class="line"><span class="cl">81 80 80 80 00 00 07 96 80 80 80 00 02 06 6D 65
</span></span><span class="line"><span class="cl">6D 6F 72 79 02 00 09 5F 5A 35 61 64 64 34 32 69
</span></span><span class="line"><span class="cl">00 00 0A 8D 80 80 80 00 01 87 80 80 80 00 00 20
</span></span><span class="line"><span class="cl">00 41 2A 6A 0B
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>files with wat suffix: files that are easily human-readable and can be coded on this format, using the <a href="https://github.com/webassembly/wabt">wasm2wat</a> tool to convert the generated wasm to wat format, <code>wasm2wat test.wasm</code> generates The contents of wat are as follows: it is more human-readable. For a brief introduction, there are only four data types supported in webassembly.</p>
<ul>
<li>i32: 32-bit integer</li>
<li>i64: 64-bit integer</li>
<li>f32: 32-bit float</li>
<li>f64: 64-bit float</li>
</ul>
<p>Like <code>i32.sub</code> This is an arithmetic instruction, the first two variables pushed into the stack are the two arguments of the arithmetic instruction, so you can see that this instruction is concise enough.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">    (module
</span></span><span class="line"><span class="cl">(type (;0;) (func (result i32)))
</span></span><span class="line"><span class="cl">(type (;1;) (func (param i32) (result i32)))
</span></span><span class="line"><span class="cl">(type (;2;) (func))
</span></span><span class="line"><span class="cl">(type (;3;) (func (param i32)))
</span></span><span class="line"><span class="cl">(func (;0;) (type 2)
</span></span><span class="line"><span class="cl">    nop)
</span></span><span class="line"><span class="cl">(func (;1;) (type 1) (param i32) (result i32)
</span></span><span class="line"><span class="cl">    local.get 0
</span></span><span class="line"><span class="cl">    i32.const 1
</span></span><span class="line"><span class="cl">    i32.lt_s
</span></span><span class="line"><span class="cl">    if  ;; label = @1
</span></span><span class="line"><span class="cl">    i32.const 0
</span></span><span class="line"><span class="cl">    return
</span></span><span class="line"><span class="cl">    end
</span></span><span class="line"><span class="cl">    local.get 0
</span></span><span class="line"><span class="cl">    i32.const 1
</span></span><span class="line"><span class="cl">    i32.sub
</span></span><span class="line"><span class="cl">    i64.extend_i32_u
</span></span><span class="line"><span class="cl">    local.get 0
</span></span><span class="line"><span class="cl">    i32.const 2
</span></span><span class="line"><span class="cl">    i32.sub
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    // Omitted
</span></span></code></pre></td></tr></table>
</div>
</div><p>Of course wasm and wat formats are interchangeable, depending on whether you want to read it or use it.</p>
</li>
</ol>
<h3 id="34-communication-in-webassembly-and-js">3.4 Communication in webassembly and js</h3>
<p>As we said in the previous summary, there are only four data types in webassembly, and they are all numeric. Our c++ accumulation function only passes the number n, which represents the number of accumulations, so how do we pass complex data structures like string or object between webassembly and js? The answer is to pass a buffer of memory, which is kind of like passing a pointer of a number type between the two, and then putting the content to be passed into this shared memory. See mdn&rsquo;s <code>WebAssembly.Memory</code> api for more details <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly">here</a>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/c491134464a34e18a127aa6ff59be437.png" alt="WebAssembly"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//创建一个6.4MiB大的内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">wasmMemory</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Memory</span><span class="p">({</span> <span class="nx">initial</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">maximum</span><span class="o">:</span> <span class="mi">100</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">wasmBinary</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 告诉webassembly这片内存咱俩一起用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">memory</span><span class="o">:</span> <span class="nx">wasmMemory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In js, you can manipulate binary data buffer by typedArray.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// 把想要传递的数据转成 ArrayBuffer (假设是 Uint8Array)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">dataBuffer</span> <span class="o">=</span> <span class="nx">encodeDataByJS</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* my data */</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 向 wasm 申请一段内存，由 wasm 代码负责实现并返回内存内存起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">applyMemoryFormWasm</span><span class="p">(</span><span class="nx">dataBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 以 unit8 的格式操作 wasm 的内存 (格式应该与 dataBuffer 的格式相同)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">heapUint8</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">wasmMemory</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">dataBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 把数据写入 wasm 内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">heapUint8</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">dataBuffer</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-write-a-webassembly-demo">4. write a webassembly demo</h2>
<h3 id="41-c-implementation-of-an-accumulation-function">4.1 c++ implementation of an accumulation function</h3>
<p>We use the above demo to implement a 1 + 2 + 3 + &hellip; + n in c++.</p>
<h3 id="42-generating-wasm-files-with-emscripten">4.2 Generating .wasm files with emscripten</h3>
<p>The above section mentions the use of <a href="https://emscripten.org/">emscripten</a> to generate the test.wasm file.</p>
<h3 id="43-how-to-call-the-generated-wasm-file-in-js">4.3 How to call the generated .wasm file in js</h3>
<p>We try to use the exported <code>addAll</code> method of this wasm file in node as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">&#34;./test.wasm&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">module</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;In the native WebAssembly function&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s2">&#34;performance1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">addAll</span><span class="p">(</span><span class="mi">50000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="s2">&#34;performance1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because webassembly is now a web standard, various js engines have the corresponding api (WebAssembly) to call webassembly. the usage is very simple, if you are interested go to mdn and search for additional information.</p>
<h3 id="44-rough-comparison-of-computational-performance">4.4 Rough comparison of computational performance</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addAll</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;In the Javascript&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">time</span><span class="p">(</span><span class="s2">&#34;performance2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span> <span class="o">+=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">timeEnd</span><span class="p">(</span><span class="s2">&#34;performance2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>js and webassembly execute <code>0 + 1 + 2 + ... + 50000</code> on my computer is webassembly: 0.07ms; js: 4.886ms; just a simple calculation shows the performance difference.</p>
<h2 id="5-runtime-for-webassembly">5. runtime for webassembly</h2>
<h3 id="wasmer">wasmer</h3>
<p>In addition to the browser and node, we talk about two webassembly runtimes, the first one is <a href="https://github.com/wasmerio/wasmer">wasmer</a>, the official website says that this runtime can run on any device, it looks more like a docker container and can run wasm. use it to run our cumulative wasm.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/f4b9fc7d81b94390bd318ca0ec19aa0a.png" alt="wasmer"></p>
<p>In addition, wasmr also provides a tool called wapm, which is a bit like npm, and some users on its community will upload their own compiled wasm toolkit, which you can download and run directly in wasmer.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/ccc29c1da62d4dd3a28637d13dc176f2.png" alt="wapm"></p>
<p>There will even be a <code>wapm_packages</code> and a <code>.lock</code> file under the wapm project, similar to our package.lock.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/727e548812604fdaa956190eb1503153.png" alt="wapm project"></p>
<h4 id="wasm-micro-runtime">wasm-micro-runtime</h4>
<p>This <a href="https://github.com/bytecodealliance/wasm-micro-runtime">runtime</a> was developed by the Chinese team at intel and is intended to run on top of iot devices with the following supported platform architectures.</p>
<ol>
<li>
<p>X86-64, X86-32</p>
</li>
<li>
<p>ARM, THUMB (ARMV7 Cortex-M7 and Cortex-A15 are tested)</p>
</li>
<li>
<p>AArch64 (Cortex-A57 and Cortex-A53 are tested)</p>
</li>
<li>
<p>MIPS</p>
</li>
<li>
<p>XTENSA</p>
<p>The runtime was compiled locally according to the tutorial and was able to run our cumulative wasm method successfully.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/a4889e04f9f9472f98768b3077f62db9.png" alt="runtime"></p>
<p>The generated runtime command line file iwasm is only 212k.</p>
</li>
</ol>
<h2 id="6-webassembly-now-in-use-scenarios">6. webassembly now in use scenarios</h2>
<p>In the w3c <a href="https://www.w3.org/2020/08/29-chinese-web-wasm.minutes.html">online conference on August 29, 2020</a>, several technology majors introduced their scenarios with webassembly respectively:</p>
<ol>
<li>
<p>Typical scenario 1: bilibili, using webassembly to check video content when users upload videos and generate recommended covers based on the videos, all these operations are implemented in the user&rsquo;s browser (front-end).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/8953ca2a9ddb4396bc7bf19921340dc3.png" alt="bilibili"></p>
</li>
<li>
<p>intel on embedded devices, using Webassembly to implement a set of application frameworks.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/17/2c8721ac471a4d11b7d0451523a9e539.png" alt="intel"></p>
</li>
<li>
<p>Unity game engine also has webassembly implementation.</p>
</li>
<li>
<p>Emulator (emulator) such as game boy emulator.</p>
</li>
<li>
<p>some media processing sites, squoosh, ogv.js, Photon, etc.</p>
</li>
</ol>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/webassembly/">Webassembly</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/linux-swap/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Adding swap partitions manually for Linux</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/cilium-cluster-mesh/">
            <span class="next-text nav-default">Usage of Cilium Cluster Mesh, a Kubernetes multi-cluster solution</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
