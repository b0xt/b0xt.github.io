<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>In-depth understanding of OC/C&#43;&#43; closures - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article, we briefly compare OC&#39;s Block and C&#43;&#43;&#39;s lambda in 4 dimensions, and then focus on OC/C&#43;&#43;&#39;s hybrid closure capture problem." /><meta name="keywords" content="objective-c, Objective-C&#43;&#43;, c&#43;&#43;, closures" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/occ-closures/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="In-depth understanding of OC/C&#43;&#43; closures" />
<meta property="og:description" content="In this article, we briefly compare OC&#39;s Block and C&#43;&#43;&#39;s lambda in 4 dimensions, and then focus on OC/C&#43;&#43;&#39;s hybrid closure capture problem." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/occ-closures/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-06T13:25:01+08:00" />
<meta property="article:modified_time" content="2022-05-06T13:25:01+08:00" />

<meta itemprop="name" content="In-depth understanding of OC/C&#43;&#43; closures">
<meta itemprop="description" content="In this article, we briefly compare OC&#39;s Block and C&#43;&#43;&#39;s lambda in 4 dimensions, and then focus on OC/C&#43;&#43;&#39;s hybrid closure capture problem."><meta itemprop="datePublished" content="2022-05-06T13:25:01+08:00" />
<meta itemprop="dateModified" content="2022-05-06T13:25:01+08:00" />
<meta itemprop="wordCount" content="3014">
<meta itemprop="keywords" content="objective-c,c&#43;&#43;," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In-depth understanding of OC/C&#43;&#43; closures"/>
<meta name="twitter:description" content="In this article, we briefly compare OC&#39;s Block and C&#43;&#43;&#39;s lambda in 4 dimensions, and then focus on OC/C&#43;&#43;&#39;s hybrid closure capture problem."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">In-depth understanding of OC/C&#43;&#43; closures</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-06 13:25:01 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3014 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#basic-understanding">Basic Understanding</a>
          <ul>
            <li><a href="#syntax">Syntax</a></li>
            <li><a href="#principle">Principle</a></li>
            <li><a href="#capturing-variables">Capturing variables</a></li>
            <li><a href="#memory-management">Memory management</a></li>
          </ul>
        </li>
        <li><a href="#closures-mixed-capture-problem">Closures mixed capture problem</a>
          <ul>
            <li><a href="#cs-lambda-captures-oc-objects">C++&rsquo;s <code>lambda</code> captures <code>OC</code> objects</a></li>
            <li><a href="#how-does-ocs-block-capture-c-objects">How does OC&rsquo;s Block capture C++ objects?</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Apple&rsquo;s Objective-C compiler allows users to freely mix C++ and Objective-C in the same source file, and the resulting language is called Objective-C++. Compared to other languages (e.g. Swift, Kotlin, Dart, etc.) that use file isolation and bridge communication with C++ (e.g. Kotlin uses <code>JNI</code> and Dart uses <code>FFI</code>), Objective-C and C++&rsquo;s same-file mashup is certainly comfortable. Although <code>OC/C++</code> mashups can be written in a single file, there are some caveats to understand: Objective-C++ does not add C++ functionality to OC classes, nor does it add OC functionality to C++, e.g., you cannot call C++ objects with OC syntax, nor can you add constructors and destructors to OC objects. Nor can <code>this</code> and <code>self</code> be used interchangeably. The class architecture is independent, C++ classes cannot inherit OC classes, and OC classes cannot inherit C++ classes.</p>
<p>This article explores the previously confusing issue of OC&rsquo;s <code>Block</code> and C++&rsquo;s <code>lambda</code> <strong>mix</strong>.</p>
<blockquote>
<p>Experimental environment: C++ version is C++14, OC is limited to ARC only.</p>
</blockquote>
<h2 id="basic-understanding">Basic Understanding</h2>
<p>Before exploring in depth, understand the two by way of comparison.</p>
<h3 id="syntax">Syntax</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">^(int x, NSString *y){} // ObjC, take int and NSString*
</span></span><span class="line"><span class="cl">[](int x, std::string y){} // C++, take int and std::string
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">^{ return 42; } // ObjC, returns int
</span></span><span class="line"><span class="cl">[]{ return 42; } // C++, returns int
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">^int { if(something) return 42; else return 43; }
</span></span><span class="line"><span class="cl">[]()-&gt;int { if(something) return 42; else return 43; }
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="principle">Principle</h3>
<p>Here is not to do a deeper exploration of the bottom of the <code>Block</code> of OC, just to expand the code to achieve a comparative effect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">- (void)viewDidLoad {
</span></span><span class="line"><span class="cl">    [super viewDidLoad];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    int x = 3;
</span></span><span class="line"><span class="cl">    void(^block)(int) = ^(int a) {
</span></span><span class="line"><span class="cl">        NSLog(@&#34;%d&#34;, x);
</span></span><span class="line"><span class="cl">    };
</span></span><span class="line"><span class="cl">    block(5);
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>By rewriting <code>clang -rewrite-objc</code>, you can get the following result.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">__ViewController__viewDidLoad_block_impl_0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">__block_impl</span> <span class="n">impl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">__ViewController__viewDidLoad_block_desc_0</span><span class="o">*</span> <span class="n">Desc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">__ViewController__viewDidLoad_block_impl_0</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__ViewController__viewDidLoad_block_desc_0</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">_x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">x</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">impl</span><span class="p">.</span><span class="n">isa</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_NSConcreteStackBlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">impl</span><span class="p">.</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">impl</span><span class="p">.</span><span class="n">FuncPtr</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__ViewController__viewDidLoad_block_func_0</span><span class="p">(</span><span class="k">struct</span> <span class="n">__ViewController__viewDidLoad_block_impl_0</span> <span class="o">*</span><span class="n">__cself</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">__cself</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span> <span class="c1">// bound by copy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">NSLog</span><span class="p">((</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">__NSConstantStringImpl__var_folders_st_jhg68rvj7sj064ft0rznckfh0000gn_T_ViewController_d02516_mii_0</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">__ViewController__viewDidLoad_block_desc_0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">reserved</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">Block_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">__ViewController__viewDidLoad_block_desc_0_DATA</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__ViewController__viewDidLoad_block_impl_0</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">_I_ViewController_viewDidLoad</span><span class="p">(</span><span class="n">ViewController</span> <span class="o">*</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">_cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">__rw_objc_super</span> <span class="o">*</span><span class="p">,</span> <span class="n">SEL</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSendSuper</span><span class="p">)((</span><span class="n">__rw_objc_super</span><span class="p">){(</span><span class="n">id</span><span class="p">)</span><span class="n">self</span><span class="p">,</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">objc_getClass</span><span class="p">(</span><span class="s">&#34;ViewController&#34;</span><span class="p">))},</span> <span class="n">sel_registerName</span><span class="p">(</span><span class="s">&#34;viewDidLoad&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">block</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span><span class="o">&amp;</span><span class="n">__ViewController__viewDidLoad_block_impl_0</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">__ViewController__viewDidLoad_block_func_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__ViewController__viewDidLoad_block_desc_0_DATA</span><span class="p">,</span> <span class="n">x</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))((</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">FuncPtr</span><span class="p">)((</span><span class="n">__block_impl</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>C++ <code>lambda</code> takes a very different implementation mechanism and converts the <code>lambda</code> expression into an anonymous C++ class. Here is a look at the C++ <code>lambda</code> implementation with the help of <code>cppinsights</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">A</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">add</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">](</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span><span class="o">-&gt;</span><span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">m</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">A</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span> <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">__lambda_12_15</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="kr">inline</span> <span class="kt">int</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">((</span><span class="n">m</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">A</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">__lambda_12_15</span><span class="p">(</span><span class="n">A</span> <span class="o">&amp;</span> <span class="n">_a</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span> <span class="n">_m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="n">a</span><span class="p">{</span><span class="n">_a</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">,</span> <span class="n">m</span><span class="p">{</span><span class="n">_m</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">__lambda_12_15</span> <span class="n">add</span> <span class="o">=</span> <span class="n">__lambda_12_15</span><span class="p">{</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">.</span><span class="k">operator</span><span class="p">()(</span><span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that: the <code>lambda</code> expression <code>add</code> is converted to class <code>__lambda_12_15</code> and the operator <code>()</code> is overloaded, and calls to <code>add</code> are converted to calls to <code>add.operator()</code>.</p>
<h3 id="capturing-variables">Capturing variables</h3>
<p>OC <code>Block</code> is only possible to capture variables in the normal way and in the <code>__block</code> way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">block</span><span class="p">();</span> <span class="c1">// prints 42
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__block</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">block</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">43</span><span class="p">;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">block</span><span class="p">();</span> <span class="c1">// x is now 43
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>C++ <code>lambda</code> brings more flexibility to capture variables in these ways.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="p">[]</span> <span class="n">Capture</span> <span class="n">nothing</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="n">Capture</span> <span class="n">any</span> <span class="n">referenced</span> <span class="n">variable</span> <span class="n">by</span> <span class="n">reference</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="n">Capture</span> <span class="n">any</span> <span class="n">referenced</span> <span class="n">variable</span> <span class="n">by</span> <span class="n">making</span> <span class="n">a</span> <span class="n">copy</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">=</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">foo</span><span class="p">]</span> <span class="n">Capture</span> <span class="n">any</span> <span class="n">referenced</span> <span class="n">variable</span> <span class="n">by</span> <span class="n">making</span> <span class="n">a</span> <span class="n">copy</span><span class="p">,</span> <span class="n">but</span> <span class="n">capture</span> <span class="n">variable</span> <span class="n">foo</span> <span class="n">by</span> <span class="n">reference</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">bar</span><span class="p">]</span> <span class="n">Capture</span> <span class="n">bar</span> <span class="n">by</span> <span class="n">making</span> <span class="n">a</span> <span class="n">copy</span><span class="p">;</span> <span class="n">don</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">copy</span> <span class="n">anything</span> <span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="k">this</span><span class="p">]</span> <span class="n">Capture</span> <span class="n">the</span> <span class="k">this</span> <span class="n">pointer</span> <span class="n">of</span> <span class="n">the</span> <span class="n">enclosing</span> <span class="k">class</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">1001</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">lambda</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// can&#39;t modify x or y here, but we can read them
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">z</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d, %d, %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="n">lambda</span><span class="p">();</span> <span class="c1">// prints 42, 99, 1002
</span></span></span><span class="line"><span class="cl"><span class="c1">// z is now 1002
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="memory-management">Memory management</h3>
<p>OC <code>Block</code> and C++ <code>lambda</code> both have their roots in stack objects, but their subsequent development is very different. OC <code>Block</code> are essentially OC objects, they are stored by reference, never by value. OC <code>Blocks</code> must be copied to the heap in order to extend their lifecycle. OC <code>Blocks</code> follow the OC reference counting rules, and <code>copy</code> and <code>release</code> must be balanced (same for <code>Block_copy</code> and <code>Block_release</code>). The first copy will move <code>Block</code> from the stack to the heap, and another copy will increase its reference count. When the reference count reaches 0, <code>Block</code> is destroyed and the object it captures is <code>released</code>.</p>
<p>C++ <code>lambda</code> stores by value, not by reference. All captured variables are stored in the anonymous class object as member variables of the anonymous class object. When <code>lambda</code> expressions are copied, all of these variables are copied as well, simply by triggering the appropriate constructors and destructors. There is an extremely important point here: variables are captured by reference. These variables are stored as references in anonymous objects and they don&rsquo;t get any special treatment. This means that after the lifetime of these variables is over, <code>lambda</code> may still access them, resulting in undefined behavior or crashes, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lambda</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">x</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">&#34;x = %d&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">touchesBegan</span><span class="p">:(</span><span class="n">NSSet</span><span class="o">&lt;</span><span class="n">UITouch</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="n">touches</span> <span class="nl">withEvent</span><span class="p">:(</span><span class="n">UIEvent</span> <span class="o">*</span><span class="p">)</span><span class="n">event</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">lambda</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 从输出结果中可以看到x是一个随机值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">2022</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">12</span> <span class="mi">23</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">01.375925</span><span class="o">+</span><span class="mi">0800</span> <span class="n">BlockTest</span><span class="p">[</span><span class="mi">63517</span><span class="o">:</span><span class="mi">1006998</span><span class="p">]</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">32767</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In contrast, <code>this</code> points to a store on the heap, which has a guaranteed lifetime, but even so, it is not absolutely guaranteed to be life-safe, and in some cases it is necessary to extend the lifetime with the help of smart pointers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">strongThis</span> <span class="o">=</span> <span class="n">shared_from_this</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">doSomethingAsynchronously</span><span class="p">([</span><span class="n">strongThis</span><span class="p">,</span> <span class="n">this</span><span class="p">]()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">someMember_</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="closures-mixed-capture-problem">Closures mixed capture problem</h2>
<p>The previous discussion is all independent of each other, OC&rsquo;s <code>Block</code> does not involve C++ objects, and C++&rsquo;s <code>lambda</code> does not involve OC objects, which is probably what we would like to see, but the mixup process will reveal that this is just wishful thinking on our part. The two tend to extend their magic wands into each other&rsquo;s domain, which can lead to some rather puzzling problems.</p>
<h3 id="cs-lambda-captures-oc-objects">C++&rsquo;s <code>lambda</code> captures <code>OC</code> objects</h3>
<p>Can C++&rsquo;s <code>lambda</code> capture OC variables? If so, is there a circular reference problem? If there is a circular reference problem, how should I handle it?</p>
<h4 id="value-capture-oc-object">value capture OC object</h4>
<p>As the code shows, there is a C++ field <code>cppObj</code> in the <code>OCClass</code> class, and in the initialization method of <code>OCClass</code>, <code>cppObj</code> is initialized and its field <code>callback</code> is assigned a value. You can see that <code>self</code> is captured in <code>lambda</code>, which can be considered value capture according to the previous rules.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">class</span> <span class="n">CppClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">public</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">CppClass</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">CppClass</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">public</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">@</span><span class="n">implementation</span> <span class="n">OCClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span> <span class="n">cppObj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dealloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cppObj</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">cppObj</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">[</span><span class="n">self</span> <span class="n">executeTask</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">executeTask</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="err">@</span><span class="s">&#34;execute task&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">OCClass</span> <span class="o">*</span><span class="n">ocObj</span> <span class="o">=</span> <span class="p">[[</span><span class="n">OCClass</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Unfortunately, such a capture occurs by circular reference: the <code>OCClass</code> object <code>ocObj</code> holds <code>cppObj</code>, and <code>cppObj</code> holds <code>ocObj</code> via <code>callback</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/6e015ee9a00a42be895994068ba02e4d.png" alt="OCClass"></p>
<p>Looking at the corresponding assembly code, you can see that the capture triggers the <code>ARC</code> semantics and automatically <code>retain</code> on <code>self</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/bbdb2dbfe0da48ab87648e6413b99971.png" alt="assembly"></p>
<p>These lines of assembly code add a reference count to <code>self</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x10cab31ea &lt;+170&gt;: movq   -0x8(%rbp), %rdi
</span></span><span class="line"><span class="cl">0x10cab31ee &lt;+174&gt;: movq   0x5e7b(%rip), %rax        ; (void *)0x00007fff2018fa80: objc_retain
</span></span><span class="line"><span class="cl">0x10cab31f5 &lt;+181&gt;: callq  *%rax
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, looking at the parameters of the anonymous class, you can see that <code>self</code> is of type <code>OCClass *</code>, which is a pointer type.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/d1d16232e9ba4aed8913597e2f1aaf18.png" alt="self is of type OCClass *"></p>
<p>Then it can be simply assumed that the capture pseudocode is as follows, and that the <code>retain</code> behavior occurs under <code>ARC</code> semantics.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__strong</span> <span class="nf">__typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">capture_self</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 展开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__strong</span> <span class="n">OCClass</span> <span class="o">*</span> <span class="n">capture_self</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To solve the problem of circular references, <code>__weak</code> can be used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">cppObj</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">__weak</span> <span class="nf">__typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="n">wself</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">cppObj</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="p">[</span><span class="n">wself</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">wself</span> <span class="n">executeTask</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/091ee4416f2245668fe69a18b12f258e.png" alt="assembly"></p>
<p>Looking at the assembly code again, I see that the previous <code>objc_retain</code> logic has disappeared and is replaced by <code>objc_copyWeak</code>.</p>
<h4 id="capture-oc-objects-by-reference">Capture OC objects by reference</h4>
<p>So is it possible to capture <code>self</code> by reference capture?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">cppObj</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">cppObj</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">self</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">self</span> <span class="n">executeTask</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that there is also no <code>objc_retain</code> logic in the assembly code.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/541137e9efda438491e9dbb476afc498.png" alt="objc_retain"></p>
<p>Finally, looking at the parameters of the anonymous class, we can see that <code>self</code> is of type <code>OCClass *&amp;</code>, which is a pointer reference type.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/12b4f91290194c6386a51cf274e9ce56.png" alt="self is of type OCClass *&amp;"></p>
<p>You can see that reference capture does not retain <code>self</code>, and you can simply assume that the capture pseudocode is as follows, and no retainment behavior occurs under <code>ARC</code> semantics.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__unsafe_unretained</span> <span class="nf">__typeof</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">&amp;</span> <span class="n">capture_self</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 展开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__unsafe_unretained</span> <span class="n">OCClass</span> <span class="o">*&amp;</span><span class="n">capture_self</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="when-is-the-captured-oc-object-released">When is the captured OC object released?</h4>
<p>Take this code snippet as an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">cppObj</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">OCClass2</span> <span class="o">*</span><span class="n">oc2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">OCClass2</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">cppObj</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="p">[</span><span class="n">oc2</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">oc2</span> <span class="n">class</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/ab3e35b5ac57468299bd20a2b9a10267.png" alt="When is the captured OC object released?"></p>
<p>You can see that <code>std::function</code> is destructed in the destructor of <code>CppClass</code>, and <code>std::function</code> releases the OC variable oc2 that it captures.</p>
<h4 id="conclusion">Conclusion</h4>
<p>The essence of C++ <code>lambda</code> is to create an anonymous struct type to store captured variables. <code>ARC</code> will ensure that C++ struct types containing OC object fields follow <code>ARC</code> semantics:</p>
<ol>
<li>the constructor of the C++ structure initializes the OC object field to <code>nil</code>;</li>
<li>when the OC object field is assigned a value, it <code>releases</code> the previous value and <code>retain</code> the new value (or <code>copy</code> if it is a <code>block</code>).</li>
<li>when the destructor of a C++ struct is called, it <code>release</code> the OC object field.</li>
</ol>
<p>C++ <code>lambda</code> captures OC objects by value or by reference.</p>
<ol>
<li>capturing OC objects by reference is equivalent to using <code>__unsafe_unretained</code>, which has lifecycle issues and is inherently dangerous and not recommended.</li>
<li>value capture is equivalent to using <code>__strong</code>, which may cause circular references, so you can use <code>__weak</code> if necessary.</li>
</ol>
<h3 id="how-does-ocs-block-capture-c-objects">How does OC&rsquo;s Block capture C++ objects?</h3>
<p>Take a look at how OC&rsquo;s <code>Block</code> captures C++ objects.</p>
<p>The <code>HMRequestMonitor</code> in the code is a C++ structure with <code>WaitForDone</code> and <code>SignalDone</code> methods that are mainly for synchronization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">HMRequestMonitor</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">public</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">WaitForDone</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">is_done_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">SignalDone</span><span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">)</span> <span class="p">{</span> <span class="n">done_with_success_</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">success</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResponseStruct</span><span class="o">&amp;</span> <span class="n">GetResponse</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">response_</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">private</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">.....</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>upload</code> method uses the <code>HMRequestMonitor</code> object for the purpose of waiting for network request results synchronously (the code has been adjusted for typography).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">hermas</span><span class="o">::</span><span class="n">ResponseStruct</span> <span class="n">HMUploader</span><span class="o">::</span><span class="n">upload</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">request_data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="kt">int64_t</span> <span class="n">len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">header_content_type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">header_content_encoding</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HMRequestModel</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="p">[[</span><span class="n">HMRequestModel</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">monitor</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">hermas</span><span class="o">::</span><span class="n">HMRequestMonitor</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">hermas</span><span class="o">::</span><span class="n">HMRequestMonitor</span><span class="o">&gt;</span> <span class="n">weakMonitor</span><span class="p">(</span><span class="n">monitor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">DataResponseBlock</span> <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="n">id</span> <span class="n">data</span><span class="p">,</span> <span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">weakMonitor</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SignalDone</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">m_session_manager</span> <span class="nl">requestWithModel</span><span class="p">:</span><span class="n">model</span> <span class="nl">callBackWithResponse</span><span class="p">:</span><span class="n">block</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">WaitForDone</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">GetResponse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here, <code>std::weak_ptr</code> is used directly.</p>
<h4 id="does-not-use-__block">does not use <code>__block</code></h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/637db2869cda4260bf4566e716fd9cff.png" alt="does not use __block">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/25a04fa7722c465aa4f207ffb8dffe6a.png" alt="does not use __block"></p>
<p>The following conclusions can be drawn from experiments.</p>
<ol>
<li>
<p>C++ objects are captured by OC&rsquo;s <code>Block</code> and by value passing. A breakpoint shows that the copy constructor of <code>std::weak_ptr</code> is called.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">template</span><span class="o">&lt;</span><span class="n">class</span> <span class="n">_Tp</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kr">inline</span>
</span></span><span class="line"><span class="cl"><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">_Tp</span><span class="o">&gt;::</span><span class="n">weak_ptr</span><span class="p">(</span><span class="n">weak_ptr</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">__r</span><span class="p">)</span> <span class="nl">_NOEXCEPT</span>
</span></span><span class="line"><span class="cl">    <span class="p">:</span> <span class="n">__ptr_</span><span class="p">(</span><span class="n">__r</span><span class="p">.</span><span class="n">__ptr_</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">__cntrl_</span><span class="p">(</span><span class="n">__r</span><span class="p">.</span><span class="n">__cntrl_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">__cntrl_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">__cntrl_</span><span class="o">-&gt;</span><span class="n">__add_weak</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The weak reference count of <code>monitor</code> changes as follows.</p>
<ul>
<li>Initialize <code>monitor</code> with <code>weak_count = 1</code> ;</li>
<li>When initializing <code>weakMonitor</code>, <code>weak_count = 2</code>, which increases by 1.</li>
<li>After OC Block capture, <code>weak_count = 4</code>, increased by 2. By looking at the assembly code, there are 2 places.
<ul>
<li><code>weakMinotor</code> was copied on the first capture, at line 142 of the assembly code.</li>
<li><code>weakMinotor</code> is copied again when <code>Block</code> is copied from the stack to the heap, in assembly line 144.</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>Here we need to pay attention to: C++ <code>weak_count</code> is strange, its value = number of weak references + 1, the reason for this design is more complicated, please refer to: <a href="https://stackoverflow.com/questions/5671241/how-does-weak-ptr-work">https://stackoverflow.com/questions/5671241/how-does-weak-ptr-work</a></p>
</blockquote>
<p>If instead of using <code>std::weak_ptr</code>, <code>std::shared_ptr</code> is caught and its strong reference count is 3, the logic is the same as for <code>std::weak_ptr</code> above. (Essentially, <code>std::shared_ptr</code> and <code>std::weak_ptr</code> are both C++ classes)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">hermas</span><span class="o">::</span><span class="n">HMRequestMonitor</span><span class="o">&gt;</span> <span class="n">monitor</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">hermas</span><span class="o">::</span><span class="n">HMRequestMonitor</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">DataResponseBlock</span> <span class="n">block</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">error</span><span class="p">,</span> <span class="n">id</span>  <span class="n">_Nonnull</span> <span class="n">data</span><span class="p">,</span> <span class="n">NSURLResponse</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">monitor</span><span class="o">-&gt;</span><span class="n">SignalDone</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">po</span> <span class="n">monitor</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">__1</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">hermas</span><span class="o">::</span><span class="n">HMRequestMonitor</span><span class="o">&gt;::</span><span class="n">element_type</span> <span class="err">@</span> <span class="mh">0x00006000010dda58</span> <span class="n">strong</span><span class="o">=</span><span class="mi">3</span> <span class="n">weak</span><span class="o">=</span><span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="using-__block">using <code>__block</code></h4>
<p>So is it possible to use <code>__block</code> to modify a captured C++ variable? Experimentation has shown that it is possible.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/b8437d27614643119afc0347bce8dab3.png" alt="using __block">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/e64f31fce2014db38897f7c4d90dd64f.png" alt="using __block"></p>
<p>The following conclusions can be drawn.</p>
<ol>
<li>the <code>Block</code> of OC can capture C++ objects by reference passing.</li>
<li>the <code>weak</code> reference count of <code>monitor</code> is as follows.
<ul>
<li>Initialize <code>monitor</code> with <code>weak_count = 1</code> ;</li>
<li>Initialize <code>weakMonitor</code> with <code>weak_count = 2</code>, increasing by 1.</li>
<li>After OC <code>Block</code> capture, <code>weak_count = 2</code>, mainly because the move constructor is triggered, which is only a transfer of ownership and does not change the reference count.</li>
</ul>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/15452ab1504f4e85b5650cbdb2a56a79.png" alt="using __block"></p>
<h4 id="questions-about-__block">Questions about <code>__block</code></h4>
<p>Those who know C++ may wonder, since the move constructor is triggered here, only the ownership has been transferred, meaning that <code>monitor</code> is passed in as the right value and has become <code>nullptr</code> to be extinguished, then why is <code>monitor</code> still accessible in the example? It can be verified that.</p>
<ol>
<li>
<p>When the following code is executed for the first time</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/314f7cca412e4a4cb5566afb64e92947.png" alt="code"></p>
<p>will find the address of the monitor variable as</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">(lldb) po &amp;monitor
</span></span><span class="line"><span class="cl">0x0000700001d959e8
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>When the assignment of <code>block</code> is executed, the move constructor of <code>std::shared_ptr</code> is called.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/535b4cd2b30a458aabdb132beda88e69.png" alt="std::shared_ptr">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/f5fa4a083c7044e78ae1a03b4518f6bf.png" alt="std::shared_ptr"></p>
<ul>
<li>The address of <code>this</code> in the move constructor is <code>0x0000600003b0c830</code> ;</li>
<li>The address of <code>__r</code> is also <code>0x0000700001d959e8</code>, which is the same as the address of <code>monitor</code>.</li>
</ul>
</li>
<li>
<p>When the execution of <code>block</code> is finished, print the address of <code>monitor</code> again, you will find that the address of <code>monitor</code> has changed and is consistent with <code>this</code> in step 2, which means that <code>monitor</code> has changed to <code>this</code> in step 2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">(lldb) po &amp;monitor
</span></span><span class="line"><span class="cl">0x0000600003b0c830
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>During the whole process, the address of <code>monitor</code> changes before and after 2 different <code>std::shared_ptr</code> objects. So <code>monitor</code> can still be accessed.</p>
<h4 id="when-is-a-captured-c-object-released">When is a captured C++ object released?</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/06/a9537589d06b49f3bdd96e2d453e032c.png" alt="a captured C++ object released"></p>
<p>Also when OC&rsquo;s <code>Block</code> is released, it is released for the C++ object it captures.</p>
<h4 id="captures-shared_from_this">captures shared_from_this</h4>
<p>C++&rsquo;s <code>this</code> is a pointer, which is essentially an integer. OC&rsquo;s <code>Block</code> capturing <code>this</code> is not fundamentally different from capturing an integer, so we won&rsquo;t discuss it in detail here. The focus here is on C++&rsquo;s <code>shared_from_this</code> class, which is a smart pointer version of this.</p>
<blockquote>
<p>If a C++ class wants to access <code>shared_from_this</code>, it must inherit from class <code>enable_shared_from_this</code> and pass its own class name as a template parameter.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">class</span> <span class="nl">CppClass</span> <span class="p">:</span> <span class="n">public</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_shared_from_this</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">public</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">CppClass</span><span class="p">(){}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">CppClass</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="n">attachOCBlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nl">public</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">OCClass2</span> <span class="o">*</span><span class="n">ocObj2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">dosomething</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CppClass</span><span class="o">::</span><span class="n">attachOCBlock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ocObj2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">OCClass2</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">shared_this</span> <span class="o">=</span> <span class="n">shared_from_this</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ocObj2</span><span class="p">.</span><span class="n">ocBlock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">shared_this</span><span class="o">-&gt;</span><span class="n">dosomething</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">@</span><span class="n">interface</span> <span class="nl">OCClass2</span> <span class="p">:</span> <span class="n">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">property</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">ocBlock</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">cppObj</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">cppObj</span><span class="o">-&gt;</span><span class="n">attachOCBlock</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>According to the previous conclusion, in the <code>CppClass</code> member function <code>attachOCBlock</code>, <code>ocBlock</code> captures <code>shared_from_this</code> directly, which also triggers a circular reference, and also takes <code>std::weak_ptr</code> to resolve it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">CppClass</span><span class="o">::</span><span class="n">attachOCBlock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ocObj2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">OCClass2</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">CppClass</span><span class="o">&gt;</span> <span class="n">weak_this</span> <span class="o">=</span> <span class="n">shared_from_this</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">ocObj2</span><span class="p">.</span><span class="n">ocBlock</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">weak_this</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">dosomething</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="conclusion-1">Conclusion</h4>
<p>OC&rsquo;s <code>Block</code> can capture C++ objects.</p>
<ol>
<li>if a C++ object on the stack is captured in the normal way, the copy constructor is called.</li>
<li>If a C++ object on the stack is captured using the <code>__block</code> method, the move constructor is called, and the <code>__block</code>-modified C++ object is redirected when it is captured.</li>
</ol>
<h2 id="summary">Summary</h2>
<p>This article started with a brief comparison between OC&rsquo;s <code>Block</code> and C++&rsquo;s <code>lambda</code> in 4 dimensions: syntax, principles, variable capture and memory management, and then focused more on <code>OC/C++</code>&rsquo;s closure hybrid capture. The reason why I went to such great lengths is that I don&rsquo;t want to &ldquo;guess&rdquo; and &ldquo;try and fail&rdquo; in a confusing way, but only by understanding the mechanism behind it can I write better <code>OC/C++</code> mixed code, and I also hope to bring some help to readers who have the same confusion. However, this is only the tip of the iceberg for the whole field of <code>OC/C++</code> mashups, and there are still a lot of difficult issues to be explored in the future.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/objective-c/">objective-c</a>
          <a href="/tags/c&#43;&#43;/">c&#43;&#43;</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/changes-in-atomic-package/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">New changes to the atomic package</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/javascript-containers/">
            <span class="next-text nav-default">The father of Node.js talks about JavaScript containers</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
