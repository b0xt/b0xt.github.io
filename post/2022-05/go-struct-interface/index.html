<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go struct/interface best practices - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore best practices for struct/interface in golang." /><meta name="keywords" content="golang, Struct, Interface" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/go-struct-interface/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go struct/interface best practices" />
<meta property="og:description" content="Explore best practices for struct/interface in golang." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/go-struct-interface/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-03T13:28:19+08:00" />
<meta property="article:modified_time" content="2022-05-03T13:28:19+08:00" />

<meta itemprop="name" content="Go struct/interface best practices">
<meta itemprop="description" content="Explore best practices for struct/interface in golang."><meta itemprop="datePublished" content="2022-05-03T13:28:19+08:00" />
<meta itemprop="dateModified" content="2022-05-03T13:28:19+08:00" />
<meta itemprop="wordCount" content="1916">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go struct/interface best practices"/>
<meta name="twitter:description" content="Explore best practices for struct/interface in golang."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go struct/interface best practices</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-03 13:28:19 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1916 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#structures-struct">Structures Struct</a>
          <ul>
            <li><a href="#fugitive-analysis">Fugitive analysis</a></li>
            <li><a href="#memory-alignment">Memory alignment</a></li>
          </ul>
        </li>
        <li><a href="#interface">Interface</a>
          <ul>
            <li><a href="#embedded-struct">Embedded struct</a></li>
            <li><a href="#new-func-type">New func type</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I&rsquo;ve been using Go for a year now and am deeply immersed in its simplicity of design, as described on its website.</p>
<blockquote>
<p>Go is expressive, concise, clean, and efficient. It&rsquo;s a fast, statically typed, compiled language that feels like a dynamically typed, interpreted language.</p>
</blockquote>
<p>Rob Pike in <a href="https://talks.golang.org/2015/simplicity-is-complicated.slide">Simplicity is Complicated</a> also mentions Go&rsquo;s simplicity as an important reason for its popularity. Simplicity does not mean simplicity, and Go has a number of design features that ensure that complexity is hidden behind the scenes. In this article, I discuss the design philosophy and best practices of struct/interface in Go to help readers write robust and efficient Go programs.</p>
<h2 id="structures-struct">Structures Struct</h2>
<p>Go is designed to replace C/C++, so struct in Go is similar to C, and is a <strong>value type</strong> like int/float, which is memory compact, fixed size, and GC and memory access friendly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Point</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">X</span><span class="p">,</span> <span class="nx">Y</span> <span class="kt">int</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Rect1</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Min</span><span class="p">,</span> <span class="nx">Max</span> <span class="nx">Point</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Rect2</span> <span class="kd">struct</span> <span class="p">{</span> <span class="nx">Min</span><span class="p">,</span> <span class="nx">Max</span> <span class="o">*</span><span class="nx">Point</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/03/a56582809b6e4c2396f6eaf30a0500c5.png" alt="go struct"></p>
<p>As you can see from the figure above, <code>Point</code> <code>Rect1</code> <code>Rect2</code> are all contiguous in memory. The value types need to be used with the following two points in mind.</p>
<ol>
<li>
<p>When an assignment is made, a copy of the value is made, unlike the reference-based Object in Java.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/03/d584d348a75e48f78b616d41326b31e3.png" alt="The difference between Java objects and Go struct assignment"></p>
</li>
<li>
<p>Because the assignment of a value type makes a copy, it needs to be defined as a pointer type when its value needs to be changed.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="kd">type</span> <span class="nx">student</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">foo</span> <span class="o">:=</span> <span class="nx">student</span><span class="p">{</span><span class="nx">name</span><span class="p">:</span> <span class="s">&#34;foo&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bar</span> <span class="o">:=</span> <span class="nx">foo</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bar</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&#34;bar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">foo</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>  <span class="c1">// 输出 foo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">bar2</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">foo</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bar2</span><span class="p">.</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&#34;bar&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">foo</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>  <span class="c1">// 输出 bar
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>The above example is relatively simple, but it is easy to overlook when nesting structs within other structures, such as when using for range to traverse <code>[]struct</code>, <code>map[xx]struct</code>. there are some pitfalls when using for range.</p>
<p>Also, in some cases, Go directly restricts the modification of structs at the language level. Here is an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">student</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="nx">name</span><span class="p">:</span> <span class="s">&#34;1&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span> <span class="p">=</span> <span class="s">&#34;2&#34;</span> <span class="c1">// 编译错误： cannot assign to struct field m[1].name in map
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, it is not possible to assign a value to the struct in map directly. This is because <code>m[1]</code> gets a copy of the original struct, and even if the compiler allows the assignment here, the value of the struct in the map will not change, so the compiler directly disallows it. Second, the assignment here is a <code>read-modify-write</code> operation, which makes it difficult to guarantee atomicity, as discussed in <a href="https://github.com/golang/go/issues/3117">#3117</a>. There are two ways to resolve this.</p>
<p>I have encountered this &ldquo;trap&rdquo; many times, so does it mean that all structs are defined as pointers? Here we need to understand Go&rsquo;s escape analysis to answer this question.</p>
<h3 id="fugitive-analysis">Fugitive analysis</h3>
<p>The main role of escape analysis is to determine where objects are allocated in memory, Go tries to allocate them on the stack, which has obvious benefits: easy recycling and less GC pressure. This can be seen with <code>go build -gcflags -m xx.go</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">returnByValue</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">student</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">student</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">returnByPointer</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">student</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">student</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="o">/</span><span class="nx">snippet</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">student</span> <span class="nx">literal</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the return value of the <code>returnByPointer</code> method escapes and ends up on the heap. For more information on the performance difference between variables assigned on stack / heap, see: <a href="https://github.com/jiacai2050/blog-snippets/blob/master/go-struct-interface/bench_test.go">bench_test.go</a></p>
<p>Test results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">go <span class="nb">test</span> -run ^NOTHING -bench Struct *.go
</span></span><span class="line"><span class="cl">goos: darwin
</span></span><span class="line"><span class="cl">goarch: amd64
</span></span><span class="line"><span class="cl">BenchmarkPointerVSStruct/return_pointer-8               <span class="m">33634951</span>                34.3 ns/op            <span class="m">16</span> B/op          <span class="m">1</span> allocs/op
</span></span><span class="line"><span class="cl">BenchmarkPointerVSStruct/return__value-8                <span class="m">530202802</span>                2.23 ns/op            <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
</span></span><span class="line"><span class="cl">BenchmarkPointerVSStruct/value_receiver-8               <span class="m">433067940</span>                2.77 ns/op            <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
</span></span><span class="line"><span class="cl">BenchmarkPointerVSStruct/pointer_receiver-8             <span class="m">431380804</span>                2.72 ns/op            <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
</span></span><span class="line"><span class="cl">PASS
</span></span><span class="line"><span class="cl">ok      command-line-arguments  5.889s
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see.</p>
<ul>
<li>When the method returns a pointer, there is a heap allocation</li>
<li>When the method returns value, there is no heap allocation, which means that all variables are allocated on the stack</li>
<li>There is little difference in performance between a receiver being a pointer or a value, because s has no escape in either case, and copying the struct itself costs about the same as copying a pointer (8 bytes)</li>
</ul>
<p>This test also shows that the location of the variable allocation in memory is independent of whether it is a pointer or not. Combining the results of the above test, the following process can be followed to determine whether to use pointers.</p>
<ol>
<li>If you need to change the state (e.g. to include waitgroup/sync.Poll/sync.</li>
<li>As a function return value, <code>unsafe.Sizeof(struct)</code> is greater than a certain threshold, the time to copy is greater than the time to allocate on the heap, and the pointer is chosen</li>
<li>As a function parameter, for range objects (all will copy the value), if the object is large, use the pointer</li>
<li>In addition, struct can be</li>
</ol>
<p>To determine the threshold in 2, you can add an array to the struct (arrays are also value types) and run the above test. In my machine, the threshold is about 72K.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">student</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dummy</span>  <span class="p">[</span><span class="mi">9000</span><span class="p">]</span><span class="kt">int64</span>  <span class="c1">// 添加一数组元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkPointerVSStruct</span><span class="o">/</span><span class="nx">return_pointer</span><span class="o">-</span><span class="mi">8</span>                 <span class="mi">150147</span>              <span class="mi">8147</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>           <span class="mi">73728</span> <span class="nx">B</span><span class="o">/</span><span class="nx">op</span>          <span class="mi">1</span> <span class="nx">allocs</span><span class="o">/</span><span class="nx">op</span>
</span></span><span class="line"><span class="cl"><span class="nx">BenchmarkPointerVSStruct</span><span class="o">/</span><span class="nx">return__value</span><span class="o">-</span><span class="mi">8</span>                  <span class="mi">138591</span>              <span class="mi">8146</span> <span class="nx">ns</span><span class="o">/</span><span class="nx">op</span>               <span class="mi">0</span> <span class="nx">B</span><span class="o">/</span><span class="nx">op</span>          <span class="mi">0</span> <span class="nx">allocs</span><span class="o">/</span><span class="nx">op</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Few structs are of this magnitude, due to the fact that slice/map/string, which are commonly used in Go, are composite types, which are characterized by a fixed size, e.g. string takes up only 16 bytes (for 64-bit systems), similar to the structure below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">StringHeader</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Data</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Len</span>  <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/03/5fd28c51a1be45ca85d168773923b71a.png" alt="Memory allocation for Go strings"></p>
<p>The following table summarizes the classification of data types in Go.</p>
<table>
<thead>
<tr>
<th>value type</th>
<th>composite type</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>slice</td>
</tr>
<tr>
<td>numeric</td>
<td>map</td>
</tr>
<tr>
<td>(unsafe)pointer</td>
<td>channel</td>
</tr>
<tr>
<td>struct</td>
<td>function</td>
</tr>
<tr>
<td>array</td>
<td>interface</td>
</tr>
<tr>
<td></td>
<td>string</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">uint64</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;ptr&#34;</span><span class="p">:</span>       <span class="nb">uint64</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="o">&amp;</span><span class="kd">struct</span><span class="p">{}{})),</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;map&#34;</span><span class="p">:</span>       <span class="nb">uint64</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">bool</span><span class="p">]</span><span class="kt">bool</span><span class="p">{})),</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;slice&#34;</span><span class="p">:</span>     <span class="nb">uint64</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">([]</span><span class="kd">struct</span><span class="p">{}{})),</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;chan&#34;</span><span class="p">:</span>      <span class="nb">uint64</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}))),</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;func&#34;</span><span class="p">:</span>      <span class="nb">uint64</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{})),</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;interface&#34;</span><span class="p">:</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">interface</span><span class="p">{}(</span><span class="mi">0</span><span class="p">))),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">map</span><span class="p">[</span><span class="kd">chan</span><span class="p">:</span><span class="mi">8</span> <span class="kd">func</span><span class="p">:</span><span class="mi">8</span> <span class="kd">interface</span><span class="p">:</span><span class="mi">16</span> <span class="kd">map</span><span class="p">:</span><span class="mi">8</span> <span class="nx">ptr</span><span class="p">:</span><span class="mi">8</span> <span class="nx">slice</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that</p>
<ul>
<li>chan/func/map/ptr are all 8 bytes, i.e. one pointer to concrete data</li>
<li>interface is 16, two pointers, one to a specific type and one to specific data. See Russ Cox&rsquo;s <a href="https://research.swtch.com/interfaces">Go Data Structures: Interfaces</a> for details</li>
<li>slice is 24, including a pointer to the underlying array, two integers, and the distributions cap, len</li>
</ul>
<p>It was mentioned above that you can&rsquo;t directly modify the struct in a map, so is the following procedure legal? Why?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">m</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="mi">11</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="memory-alignment">Memory alignment</h3>
<p>Fields in struct are aligned by machine word length, so where performance is critical, you can try to put fields of the same type together.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">a</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">            <span class="nx">b</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">        <span class="p">}{}),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">a</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">            <span class="nx">b</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">        <span class="p">}{}),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code will output <code>32 24</code> in sequence, and the following illustration clearly shows the layout of the two sequential structs in memory: (<a href="https://stackoverflow.com/a/38034334/2163429">image source</a>)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/03/56c81d03e6fc42cb959cb90d29af544e.png" alt="field_align"></p>
<p>Finally, the reader can consider the results of the following code run.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">interface</span><span class="p">{}(</span><span class="mi">0</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="kd">struct</span><span class="p">{}{}),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="interface">Interface</h2>
<p>If struct is the encapsulation of state, then interface is the encapsulation of behavior, and is the basis for constructing abstractions in Go. Since there is no concept of oop in Go, the integration of different components, such as Reader/Writer under the io package, is achieved through combination rather than inheritance. But there is no advantage to combination, which is also possible in Java, but the implicit &ldquo;inheritance&rdquo; in Go makes combination very flexible.</p>
<h3 id="embedded-struct">Embedded struct</h3>
<p>This is illustrated by an example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">RecordWriter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">code</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rw</span> <span class="o">*</span><span class="nx">RecordWriter</span><span class="p">)</span> <span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">statusCode</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw</span><span class="p">.</span><span class="nx">code</span> <span class="p">=</span> <span class="nx">statusCode</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rw</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">URLStat</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if w.WriteHeader isn&#39;t called inside handlerFunc, 200 is the default code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rw</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">RecordWriter</span><span class="p">{</span><span class="nx">ResponseWriter</span><span class="p">:</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">code</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">next</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">metrics</span><span class="p">.</span><span class="nx">HTTPReqs</span><span class="p">.</span><span class="nf">WithLabelValues</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatInt</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">rw</span><span class="p">.</span><span class="nx">code</span><span class="p">),</span> <span class="mi">10</span><span class="p">)).</span><span class="nf">Inc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code snippet is a middleware in <a href="https://github.com/urfave/negroni">negroni</a> to record the http code. The custom Writer implements the ResponseWriter interface by embedding the ResponseWriter and then The entire implementation is very simple and concise, as it uses the pointer type <code>*RecordWriter</code> as a receiver since it needs to change state.</p>
<h3 id="new-func-type">New func type</h3>
<p>The second example is about how to simplify err handling by customizing the type. In net/http, handlerFunc has no return value, which leads to a null return after each exception to abort the logic, which is not only tedious but also easy to miss.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">viewRecord</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">appengine</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">key</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NewKey</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="s">&#34;Record&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">FormValue</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">record</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">record</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">viewTemplate</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">record</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The problem can then be solved by customizing the new type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">appError</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Error</span>   <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Message</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Code</span>    <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">appHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="nx">appError</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">fn</span> <span class="nx">appHandler</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">);</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// e is *appError, not os.Error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">appengine</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">http</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">viewRecord</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="nx">appError</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">appengine</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">key</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">NewKey</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="s">&#34;Record&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">FormValue</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">record</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">datastore</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">record</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">appError</span><span class="p">{</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Record not found&#34;</span><span class="p">,</span> <span class="mi">404</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">viewTemplate</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">record</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">appError</span><span class="p">{</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Can&#39;t display record&#34;</span><span class="p">,</span> <span class="mi">500</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">appError</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/view&#34;</span><span class="p">,</span> <span class="nf">appHandler</span><span class="p">(</span><span class="nx">viewRecord</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the above example achieves the need to centralize err handling by defining a new function type for appHandler and implicitly &ldquo;inheriting&rdquo; from the <a href="https://golang.org/pkg/net/http/#Handler">http.Handler</a> The nice thing about this implementation is that it adds new types to the functions and the function signatures are consistent with ServeHTTP, so that the parameters can be reused directly. For beginners, it may not occur to you to define methods for func types as well, but in Go, you can add methods to any type.</p>
<p>I&rsquo;ve seen some frameworks on the web that use <a href="https://github.com/gogf/gf/blob/506552c3a93a9094c96699bdf62c533b5b4f42c6/net/ghttp/ghttp_request.go#L84">panic</a> to simplify err handling, but I think this is a misuse of panic, not to mention the loss of performance, but mainly because it breaks the if err ! = nil processing. I hope readers will consider how to abstract new types to solve the problem when dealing with tedious logic in the future.</p>
<h2 id="summary">Summary</h2>
<p>The subtle design of Go ensures that its features are simple and may be different from traditional oop, so it&rsquo;s not wrong for readers who have switched from these languages to think in old ways. But as a good Go programmer, you need to think more in terms of Go&rsquo;s own features, so that you don&rsquo;t have to wonder &ldquo;why are there no XX features in Go? You should know that the authors of Go are Rob Pike, Ken Thompson :-) If you have read/implemented the interface-based design, please feel free to share.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/go-java/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to call Go code in Java?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/linux-file-system/">
            <span class="next-text nav-default">Linux File System</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
