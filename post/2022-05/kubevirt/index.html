<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kubevirt - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Kubevirt to manage virtual machines as if they were containers." /><meta name="keywords" content="Kubevirt, kubernetes" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/kubevirt/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Kubevirt" />
<meta property="og:description" content="Learn how to use Kubevirt to manage virtual machines as if they were containers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/kubevirt/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-01T17:23:17+08:00" />
<meta property="article:modified_time" content="2022-05-01T17:23:17+08:00" />

<meta itemprop="name" content="Kubevirt">
<meta itemprop="description" content="Learn how to use Kubevirt to manage virtual machines as if they were containers."><meta itemprop="datePublished" content="2022-05-01T17:23:17+08:00" />
<meta itemprop="dateModified" content="2022-05-01T17:23:17+08:00" />
<meta itemprop="wordCount" content="6335">
<meta itemprop="keywords" content="kubevirt," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubevirt"/>
<meta name="twitter:description" content="Learn how to use Kubevirt to manage virtual machines as if they were containers."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kubevirt</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-01 17:23:17 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 6335 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a>
          <ul>
            <li><a href="#crd-design">CRD Design</a></li>
            <li><a href="#architecture-design">Architecture Design</a></li>
            <li><a href="#vm-process">VM process</a></li>
          </ul>
        </li>
        <li><a href="#deployment-process">Deployment Process</a>
          <ul>
            <li><a href="#node-initialization">Node initialization</a></li>
            <li><a href="#install-kubevirt">Install kubevirt</a></li>
            <li><a href="#deploy-containerized-data-importer">Deploy Containerized Data Importer</a></li>
            <li><a href="#deploy-hostpath-provisioner">Deploy HostPath Provisioner</a></li>
            <li><a href="#configuring-harddisk">Configuring HardDisk</a></li>
            <li><a href="#client-preparation">Client preparation</a></li>
            <li><a href="#creating-a-linux-virtual-machine">Creating a Linux Virtual Machine</a></li>
            <li><a href="#create-a-windows-virtual-machine">Create a Windows virtual machine</a></li>
          </ul>
        </li>
        <li><a href="#storage">Storage</a></li>
        <li><a href="#global-route-mode-bridge-network-principle">global route mode bridge network principle</a>
          <ul>
            <li><a href="#outbound-destination-is-an-out-of-cluster-address">Outbound: destination is an out-of-cluster address</a></li>
            <li><a href="#inbound-accessing-the-vm-from-the-node">Inbound: accessing the VM from the node</a></li>
          </ul>
        </li>
        <li><a href="#vpc-cni-mode-bridge-network-principle">VPC CNI mode bridge network principle</a></li>
        <li><a href="#networking-code-reading">Networking Code Reading</a>
          <ul>
            <li><a href="#phase1">Phase1</a></li>
            <li><a href="#phase2">Phase2</a></li>
            <li><a href="#bindmechanism">BindMechanism</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><code>kubevirt</code> connects the VM management interface to kubernetes in the form of a CRD, using libvirtd to manage VMs by means of a pod to achieve a one-to-one correspondence between pods and VMs, to manage VMs as containers do, and to do the same resource management and scheduling planning as containers do. All the code involved in this article can be found in my <a href="https://github.com/SimpCosm/manifest/tree/master/kubevirt">Github</a>.</p>
<h2 id="background">Background</h2>
<h3 id="crd-design">CRD Design</h3>
<p>Kubevirt implements the following main resources to enable the management of virtual machines.</p>
<ul>
<li><code>VirtualMachineInstance (VMI)</code> : Similar to a kubernetes Pod, it is the <strong>minimum resource for managing virtual machines</strong> . A <code>VirtualMachineInstance</code> object represents a running instance of a virtual machine and contains all the configuration needed for a virtual machine. Usually users do not create VMI objects directly, but rather create higher-level objects, i.e. VMs and VMRS.</li>
<li><code>VirtualMachine(VM)</code> : Provides management functions for <code>VirtualMachineInstance</code> in the cluster, such as powering on/off/restarting VMs, ensuring the startup state of VM instances, and has a 1:1 relationship with VM instances, similar to a StatefulSet with <code>spec.replica</code> of 1. .</li>
<li><code>VirtualMachineInstanceReplicaSet</code> : similar to <code>ReplicaSet</code>, can start a specified number of <code>VirtualMachineInstance</code> and keep a specified number of <code>VirtualMachineInstance</code> running, can be configured with HPA.</li>
</ul>
<h3 id="architecture-design">Architecture Design</h3>
<p>Why does kube-virt allow seamless access to K8S for virtual machines?</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/f986742f117a4fc9830d8f938cd86e6f.png" alt="kube-virt"></p>
<h4 id="virt-api"><code>virt-api</code></h4>
<ul>
<li>kubevirt is a CRD to manage vm pods, virt-api is the entry point for all virtualization operations, including regular CRD update verification and vm start, stop</li>
</ul>
<h4 id="virt-controller"><code>virt-controller</code></h4>
<ul>
<li>Virt-controller will generate the corresponding virt-lancher pod based on the vmi CRD and maintain the status of the CRD</li>
</ul>
<h4 id="virt-handler"><code>virt-handler</code></h4>
<ul>
<li><code>virt-handler</code> will be deployed on each node as Daemonset, responsible for monitoring the state changes of each VM instance on the node, and once a state change is detected, it will respond and ensure that the corresponding operation can reach the required (desired) state.</li>
<li><code>virt-handler</code> keeps the cluster-level VMI Spec synchronized with the corresponding libvirt domain; reports changes in Libvirt domain state and cluster Spec; invokes node-centric plugins to meet the network and storage requirements defined by the VMI Spec.</li>
</ul>
<h4 id="virt-lanuncher"><code>virt-lanuncher</code></h4>
<ul>
<li>Each <code>virt-lanuncher pod</code> corresponds to a VMI. kubelet is only responsible for the running state of the <code>virt-lanuncher pod</code> and does not care about VMI creation.</li>
<li><code>virt-handler</code> will notify virt-lanuncher to start the VMI with a local libvirtd instance based on CRD parameters, virt-lanuncher will manage the VMI by pid, and virt-lanuncher will notify the VMI to terminate if the pod life cycle ends.</li>
<li>Each virt-lanuncher pod corresponds to a libvirtd, and virt-lanuncher manages the VM lifecycle through libvirtd, so that it is decentralized, instead of the old VM practice where one libvirtd manages multiple VMs.</li>
</ul>
<h4 id="libvirtd"><code>libvirtd</code></h4>
<p>An instance of <code>libvirtd</code> is present in every VMI pod. <code>virt-launcher</code> uses libvirtd to manage the life-cycle of the VMI process.</p>
<h4 id="virtctl"><code>virtctl</code></h4>
<ul>
<li>virctl is kubevirt comes with a command similar to kubectl, it goes beyond the virt-lancher pod layer to manage the vm directly, and can control the start, stop and restart of the vm.</li>
</ul>
<h3 id="vm-process">VM process</h3>
<p>The above architecture has in fact partially outlined the VM creation process, the following process combing.</p>
<ol>
<li>K8S API creates VMI CRD object</li>
<li><code>virt-controller</code> listens to <code>VMI</code> creation, generates pod spec file based on VMI configuration, and creates <code>virt-launcher pods</code>.</li>
<li><code>virt-controller</code> will update the VMI CRD status when it finds the virt-launcher pods are created.</li>
<li><code>virt-handler</code> listens to the VMI status change, communicates with <code>virt-launcher</code> to create VMs, and is responsible for VM lifecycle management</li>
</ol>
<p>As shown in the following figure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Client                     K8s API     VMI CRD  Virt Controller         VMI Handler
</span></span><span class="line"><span class="cl">-------------------------- ----------- ------- ----------------------- ----------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                           listen &lt;----------- WATCH /virtualmachines
</span></span><span class="line"><span class="cl">                           listen &lt;----------------------------------- WATCH /virtualmachines
</span></span><span class="line"><span class="cl">                                                  |                       |
</span></span><span class="line"><span class="cl">POST /virtualmachines ---&gt; validate               |                       |
</span></span><span class="line"><span class="cl">                           create ---&gt; VMI ---&gt; observe --------------&gt; observe
</span></span><span class="line"><span class="cl">                             |          |         v                       v
</span></span><span class="line"><span class="cl">                           validate &lt;--------- POST /pods              defineVMI
</span></span><span class="line"><span class="cl">                           create       |         |                       |
</span></span><span class="line"><span class="cl">                             |          |         |                       |
</span></span><span class="line"><span class="cl">                           schedPod ---------&gt; observe                    |
</span></span><span class="line"><span class="cl">                             |          |         v                       |
</span></span><span class="line"><span class="cl">                           validate &lt;--------- PUT /virtualmachines       |
</span></span><span class="line"><span class="cl">                           update ---&gt; VMI ---------------------------&gt; observe
</span></span><span class="line"><span class="cl">                             |          |         |                    launchVMI
</span></span><span class="line"><span class="cl">                             |          |         |                       |
</span></span><span class="line"><span class="cl">                             :          :         :                       :
</span></span><span class="line"><span class="cl">                             |          |         |                       |
</span></span><span class="line"><span class="cl">DELETE /virtualmachines -&gt; validate     |         |                       |
</span></span><span class="line"><span class="cl">                           delete ----&gt; * ---------------------------&gt; observe
</span></span><span class="line"><span class="cl">                             |                    |                    shutdownVMI
</span></span><span class="line"><span class="cl">                             |                    |                       |
</span></span><span class="line"><span class="cl">                             :                    :                       :
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="deployment-process">Deployment Process</h2>
<p>This experiment is conducted on Tencent Cloud to create a TKE cluster containing Blackrock models.</p>
<h3 id="node-initialization">Node initialization</h3>
<p>The <code>libvirt</code> and <code>qemu</code> packages need to be installed on the node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Ubuntu</span>
</span></span><span class="line"><span class="cl">$ apt install -y qemu-kvm libvirt-bin bridge-utils virt-manager
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CentOS</span>
</span></span><span class="line"><span class="cl">$ yum install -y qemu-kvm libvirt virt-install bridge-utils
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check if the node supports KVM hardware virtualization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># virt-host-validate qemu</span>
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> hardware virtualization                                 : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">if</span> device /dev/kvm exists                                   : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">if</span> device /dev/kvm is accessible                            : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">if</span> device /dev/vhost-net exists                             : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">if</span> device /dev/net/tun exists                               : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> cgroup <span class="s1">&#39;cpu&#39;</span> controller support                         : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> cgroup <span class="s1">&#39;cpuacct&#39;</span> controller support                     : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> cgroup <span class="s1">&#39;cpuset&#39;</span> controller support                      : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> cgroup <span class="s1">&#39;memory&#39;</span> controller support                      : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> cgroup <span class="s1">&#39;devices&#39;</span> controller support                     : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> cgroup <span class="s1">&#39;blkio&#39;</span> controller support                       : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> device assignment IOMMU support                         : PASS
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">if</span> IOMMU is enabled by kernel                               : WARN <span class="o">(</span>IOMMU appears to be disabled in kernel. Add <span class="nv">intel_iommu</span><span class="o">=</span>on to kernel cmdline arguments<span class="o">)</span>
</span></span><span class="line"><span class="cl">  QEMU: Checking <span class="k">for</span> secure guest support                                    : WARN <span class="o">(</span>Unknown <span class="k">if</span> this platform has Secure Guest support<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check that <code>kvm</code> is loaded on the node at this point.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># lsmod | grep kvm</span>
</span></span><span class="line"><span class="cl">kvm_intel             <span class="m">315392</span>  <span class="m">15</span>
</span></span><span class="line"><span class="cl">kvm                   <span class="m">847872</span>  <span class="m">1</span> kvm_intel
</span></span><span class="line"><span class="cl">irqbypass              <span class="m">16384</span>  <span class="m">17</span> kvm
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="install-kubevirt">Install kubevirt</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s https://api.github.com/repos/kubevirt/kubevirt/releases <span class="p">|</span> grep tag_name <span class="p">|</span> grep -v -- <span class="s1">&#39;-rc&#39;</span> <span class="p">|</span> head -1 <span class="p">|</span> awk -F<span class="s1">&#39;: &#39;</span> <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,//&#39;</span> <span class="p">|</span> xargs<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span>/kubevirt-operator.yaml
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/<span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span>/kubevirt-cr.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note: If the previous node does not support hardware virtualization, you can enable software emulation mode by modifying <code>kubevirt-cr</code>, refer to <a href="https://kubevirt.io/user-guide/operations/installation/#installing-kubevirt-on-kubernetes">software emulation fallback</a></p>
<p>Deployment results</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl -n kubevirt get pod
</span></span><span class="line"><span class="cl">NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">virt-api-64999f7bf5-n9kcl          1/1     Running   <span class="m">0</span>          6d
</span></span><span class="line"><span class="cl">virt-api-64999f7bf5-st5qv          1/1     Running   <span class="m">0</span>          6d8h
</span></span><span class="line"><span class="cl">virt-controller-8696ccdf44-v5wnq   1/1     Running   <span class="m">0</span>          6d
</span></span><span class="line"><span class="cl">virt-controller-8696ccdf44-vjvsw   1/1     Running   <span class="m">0</span>          6d8h
</span></span><span class="line"><span class="cl">virt-handler-85rdn                 1/1     Running   <span class="m">3</span>          7d19h
</span></span><span class="line"><span class="cl">virt-handler-bpgzp                 1/1     Running   <span class="m">21</span>         7d19h
</span></span><span class="line"><span class="cl">virt-handler-d55c7                 1/1     Running   <span class="m">1</span>          7d19h
</span></span><span class="line"><span class="cl">virt-operator-78fbcdfdf4-sf5dv     1/1     Running   <span class="m">0</span>          6d8h
</span></span><span class="line"><span class="cl">virt-operator-78fbcdfdf4-zf9qr     1/1     Running   <span class="m">0</span>          6d
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="deploy-containerized-data-importer">Deploy Containerized Data Importer</h3>
<p>The <code>Containerized Data Importer</code> (CDI) project provides functionality for making PVCs available as KubeVirt VM disks. See <a href="https://github.com/kubevirt/containerized-data-importer#deploy-it">Github: Containerized Data Importer</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s https://github.com/kubevirt/containerized-data-importer/releases/latest <span class="p">|</span> grep -o <span class="s2">&#34;v[0-9]\.[0-9]*\.[0-9]*&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/<span class="nv">$VERSION</span>/cdi-operator.yaml
</span></span><span class="line"><span class="cl">$ kubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/<span class="nv">$VERSION</span>/cdi-cr.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="deploy-hostpath-provisioner">Deploy HostPath Provisioner</h3>
<p>In this experiment, we use PVC as persistent storage, but when we use CBS as PVC in Tencent Cloud Blackrock server cluster, we found that there is a problem that PVC cannot mount Pod, so we choose to use <code>hostpath-provisioner</code> provided by kubevirt as the provisioner of PVC.</p>
<p>Referring to <a href="https://github.com/kubevirt/hostpath-provisioner">Github: kubevirt.io.hostpath-provisioner</a>, <code>hostpath-provisioner</code> runs as DaemonSet on on each node, which can be deployed via <a href="https://github.com/kubevirt/hostpath-provisioner-operator">hostpath-provisioner-operator</a> in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># hostpath provisioner operator 依赖于 cert manager 提供鉴权能力</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建 hostpah-provisioner namespace</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f https://raw.githubusercontent.com/kubevirt/hostpath-provisioner-operator/main/deploy/namespace.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 部署 operator</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f https://raw.githubusercontent.com/kubevirt/hostpath-provisioner-operator/main/deploy/operator.yaml -n hostpath-provisioner
</span></span><span class="line"><span class="cl">$ kubectl create -f https://raw.githubusercontent.com/kubevirt/hostpath-provisioner-operator/main/deploy/webhook.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, the CR is created as the back-end storage, where <code>/var/hpvolumes</code> on the Node is specified as the actual data storage location.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">hostpathprovisioner.kubevirt.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HostPathProvisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storagePools</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/var/hpvolumes&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workload</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kubernetes.io/os</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After the PVC is actually created, you can see the stored image in the corresponding directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos hostpath-provisioner<span class="o">]</span><span class="c1"># tree /var/hpvolumes/csi/</span>
</span></span><span class="line"><span class="cl">/var/hpvolumes/csi/
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- pvc-11d671f7-efe3-4cb0-873b-ebd877af53fe
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="sb">`</span>-- disk.img
</span></span><span class="line"><span class="cl"><span class="p">|</span>-- pvc-a484dae6-720e-4cc4-b1ab-8c59eec7a963
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="sb">`</span>-- disk.img
</span></span><span class="line"><span class="cl"><span class="sb">`</span>-- pvc-de897334-cb72-4272-bd76-725663d3f515
</span></span><span class="line"><span class="cl">    <span class="sb">`</span>-- disk.img
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span> directories, <span class="m">3</span> files
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos hostpath-provisioner<span class="o">]</span><span class="c1"># kubectl get pvc</span>
</span></span><span class="line"><span class="cl">NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span class="line"><span class="cl">iso-win10     Bound    pvc-de897334-cb72-4272-bd76-725663d3f515   439Gi      RWO            hostpath-csi   23h
</span></span><span class="line"><span class="cl">iso-win10-2   Bound    pvc-a484dae6-720e-4cc4-b1ab-8c59eec7a963   439Gi      RWO            hostpath-csi   23h
</span></span><span class="line"><span class="cl">iso-win10-3   Bound    pvc-11d671f7-efe3-4cb0-873b-ebd877af53fe   439Gi      RWO            hostpath-csi   22h
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, you need to create the corresponding storageclass, note that the <code>storagePool</code> here is the <code>local</code> inside the CR you just created.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">storage.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hostpath-csi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt.io.hostpath-provisioner</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">reclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Delete</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">volumeBindingMode</span><span class="p">:</span><span class="w"> </span><span class="l">WaitForFirstConsumer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storagePool</span><span class="p">:</span><span class="w"> </span><span class="l">local</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="configuring-harddisk">Configuring HardDisk</h3>
<p>Refer to <a href="https://kubevirt.io/user-guide/operations/activating_feature_gates/">Kubevirt: Activating feature gates</a> to turn on the <code>HardDisk</code> mode of kubevirt.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat <span class="s">&lt;&lt; END &gt; enable-feature-gate.yaml
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">apiVersion: kubevirt.io/v1
</span></span></span><span class="line"><span class="cl"><span class="s">kind: KubeVirt
</span></span></span><span class="line"><span class="cl"><span class="s">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s">  name: kubevirt
</span></span></span><span class="line"><span class="cl"><span class="s">  namespace: kubevirt
</span></span></span><span class="line"><span class="cl"><span class="s">spec:
</span></span></span><span class="line"><span class="cl"><span class="s">  configuration:
</span></span></span><span class="line"><span class="cl"><span class="s">    developerConfiguration: 
</span></span></span><span class="line"><span class="cl"><span class="s">      featureGates:
</span></span></span><span class="line"><span class="cl"><span class="s">        - HardDisk
</span></span></span><span class="line"><span class="cl"><span class="s">        - DataVolumes
</span></span></span><span class="line"><span class="cl"><span class="s">END</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl apply -f enable-feature-gate.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="client-preparation">Client preparation</h3>
<p>Kubevirt provides a command line tool <code>virtctl</code> that can be downloaded directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s https://api.github.com/repos/kubevirt/kubevirt/releases <span class="p">|</span> grep tag_name <span class="p">|</span> grep -v -- <span class="s1">&#39;-rc&#39;</span> <span class="p">|</span> head -1 <span class="p">|</span> awk -F<span class="s1">&#39;: &#39;</span> <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,//&#39;</span> <span class="p">|</span> xargs<span class="k">)</span>
</span></span><span class="line"><span class="cl">$ curl -L -o /usr/local/bin/virtctl https://github.com/kubevirt/kubevirt/releases/download/<span class="nv">$VERSION</span>/virtctl-<span class="nv">$VERSION</span>-linux-amd64
</span></span><span class="line"><span class="cl">$ chmod +x /usr/local/bin/virtctl
</span></span></code></pre></td></tr></table>
</div>
</div><p>It can also be installed as a plugin for kubectl via krew.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl krew install virt
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="creating-a-linux-virtual-machine">Creating a Linux Virtual Machine</h3>
<p>The following is an example of a VMI for creating a Linux virtual machine, based on which a VM is automatically created. in this CR, several key elements are specified that are required for a virtual machine:</p>
<ul>
<li>Domain: domain is the root element required by a VM, specifying all the resources required by the VM. kubevirt will create the VM based on this domain spec into a libvirt XML file.</li>
<li>Storage: <code>spec.volumes</code> indicates the real storage backend, and <code>spec.domain.devices.disks</code> indicates what storage this VM will use. See the section on storage for details.</li>
<li>Network: <code>spec.networks</code> indicates the real network backend, <code>spec.domain.devices.interfaces</code> indicates what type of NIC devices this VM uses.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualMachineInstance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">testvmi-nocloud2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">domain</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1024M</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">devices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">disks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">containerdisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">disk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">bus</span><span class="p">:</span><span class="w"> </span><span class="l">virtio</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">emptydisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">disk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">bus</span><span class="p">:</span><span class="w"> </span><span class="l">virtio</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">disk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">bus</span><span class="p">:</span><span class="w"> </span><span class="l">virtio</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudinitdisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interfaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">bridge</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">containerdisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">containerDisk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt/fedora-cloud-container-disk-demo:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">emptydisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">emptyDisk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudinitdisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cloudInitNoCloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">userData</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        #cloud-config
</span></span></span><span class="line"><span class="cl"><span class="sd">        password: fedora
</span></span></span><span class="line"><span class="cl"><span class="sd">        chpasswd: { expire: False }</span><span class="w">        
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After creating the following VirtualMachineInstance CR, you can see that the Pod virt-launcher-testvmi-nocloud2-jbbhs is launched in the cluster. view Pod and virtual machine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># kubectl get po -owide</span>
</span></span><span class="line"><span class="cl">NAME                                   READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">virt-launcher-testvmi-nocloud2-jbbhs   2/2     Running   <span class="m">0</span>          24h   172.16.0.24   10.3.4.27   &lt;none&gt;           1/1
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># kubectl get vmi</span>
</span></span><span class="line"><span class="cl">NAME               AGE   PHASE     IP            NODENAME    READY
</span></span><span class="line"><span class="cl">testvmi-nocloud2   24h   Running   172.16.0.24   10.3.4.27   True
</span></span></code></pre></td></tr></table>
</div>
</div><p>Log in to the virtual machine with fedora as the account and password.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># ssh fedora@172.16.0.24</span>
</span></span><span class="line"><span class="cl">fedora@172.16.0.24<span class="err">&#39;</span>s password:
</span></span><span class="line"><span class="cl">Last login: Wed Feb <span class="m">23</span> 06:30:38 <span class="m">2022</span> from 172.16.0.1
</span></span><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ uname -a
</span></span><span class="line"><span class="cl">Linux testvmi-nocloud2 5.6.6-300.fc32.x86_64 <span class="c1">#1 SMP Tue Apr 21 13:44:19 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ ip a
</span></span><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq_codel state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 5e:04:61:17:c1:c9 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    altname enp1s0
</span></span><span class="line"><span class="cl">    inet 172.16.0.24/26 brd 172.16.0.63 scope global dynamic noprefixroute eth0
</span></span><span class="line"><span class="cl">       valid_lft 86226231sec preferred_lft 86226231sec
</span></span><span class="line"><span class="cl">    inet6 fe80::5c04:61ff:fe17:c1c9/64 scope link
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-a-windows-virtual-machine">Create a Windows virtual machine</h3>
<h4 id="uploading-an-image">Uploading an image</h4>
<p>CDI provides the option to use PVCs as virtual machine disks. CDI supports the following modes to import images to PVCs.</p>
<ul>
<li>Import a virtual machine image to a PVC via URL, which can be an http link, s3 link</li>
<li>Clone an existing PVC</li>
<li>Import VM disk to PVC via container registry, need to use with <code>ContainerDisk</code>.</li>
<li>Uploading a local image to a PVC via a client</li>
</ul>
<p>Here we use the fourth way, upload local image to PVC via <code>virtctl</code> command line tool, combined with CDI project.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ virtctl image-upload <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --image-path<span class="o">=</span><span class="s1">&#39;Win10_20H2_Chinese(Simplified)_x64.iso&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --storage-class hostpath-csi <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --pvc-name<span class="o">=</span>iso-win10 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --pvc-size<span class="o">=</span>10Gi <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --uploadproxy-url<span class="o">=</span>https://&lt;cdi-uploadproxy_svc_ip&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --insecure <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --wait-secs<span class="o">=</span><span class="m">240</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PersistentVolumeClaim default/iso-win10 created
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> PVC iso-win10 upload pod to be ready...
</span></span><span class="line"><span class="cl">Pod now ready
</span></span><span class="line"><span class="cl">Uploading data to https://10.111.29.156
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 5.63 GiB / 5.63 GiB <span class="o">[======================================================================================================================================================]</span> 100.00% 27s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Uploading data completed successfully, waiting <span class="k">for</span> processing to complete, you can hit ctrl-c without interrupting the progress
</span></span><span class="line"><span class="cl">Processing completed successfully
</span></span><span class="line"><span class="cl">Uploading Win10_20H2_Chinese<span class="o">(</span>Simplified<span class="o">)</span>_x64.iso completed successfully
</span></span></code></pre></td></tr></table>
</div>
</div><p>Parameter explanation.</p>
<ul>
<li><strong>-image-path</strong> : the local address of the OS image</li>
<li><strong>-pvc-name</strong> : Specify the PVC to store the OS image, this PVC does not need to be prepared in advance, it will be created automatically during the image upload process.</li>
<li><strong>-pvc-size</strong> : the size of the PVC, set according to the size of the OS image, usually slightly larger than a G</li>
<li><strong>-uploadproxy-url</strong> : Service IP of cdi-uploadproxy, you can check it by command <code>kubectl -n cdi get svc -l cdi.kubevirt.io=cdi-uploadproxy</code>.</li>
</ul>
<h4 id="creating-virtual-machines">Creating Virtual Machines</h4>
<p>After creating the <code>VirtualMachine</code> CR, you can see that the corresponding Pods and virtual machines are created in the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt.io/v1alpha3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VirtualMachine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">win10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">running</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">kubevirt.io/domain</span><span class="p">:</span><span class="w"> </span><span class="l">win10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">domain</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">cores</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">devices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">disks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">bootOrder</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">disk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">bus</span><span class="p">:</span><span class="w"> </span><span class="l">virtio</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harddrive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">bootOrder</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cdrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">bus</span><span class="p">:</span><span class="w"> </span><span class="l">sata</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cdromiso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">cdrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">bus</span><span class="p">:</span><span class="w"> </span><span class="l">sata</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtiocontainerdisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">interfaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">masquerade</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="l">e1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">q35</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">16G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">networks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cdromiso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">iso-win10-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harddrive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostDisk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="l">50Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data/disk.img</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DiskOrCreate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtiocontainerdisk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">containerDisk</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt/virtio-container-disk</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>There are 3 volumes used here.</p>
<ul>
<li><strong>harddrive</strong> : The disk used by the virtual machine, i.e. the OS will be mounted on that disk. Here you choose <code>hostDisk</code> to mount directly to the host for better performance, which is a very bad experience if you use distributed storage.</li>
<li><strong>cdromiso</strong> : Provides the OS installation image, i.e. the PVC <code>iso-win10</code> generated after uploading the image above.</li>
<li><strong>virtiocontainerdisk</strong> : Since Windows does not recognize raw format disks by default, you need to install a virtio drive. containerDisk can mount the packaged virtio-driven container image into a virtual machine.</li>
</ul>
<p>Start the virtual machine instance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ virtctl start win10
</span></span><span class="line"><span class="cl"><span class="c1"># 如果 virtctl 安装为 kubectl 的插件，命令格式如下：</span>
</span></span><span class="line"><span class="cl">$ kubectl virt start win10
</span></span></code></pre></td></tr></table>
</div>
</div><p>Checking the started VM instance, the Windows VM is up and running.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># kubectl get vmi</span>
</span></span><span class="line"><span class="cl">NAME               AGE   PHASE     IP            NODENAME    READY
</span></span><span class="line"><span class="cl">win10              23h   Running   172.16.0.32   10.3.4.27   True
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># kubectl get vm</span>
</span></span><span class="line"><span class="cl">NAME    AGE   STATUS    READY
</span></span><span class="line"><span class="cl">win10   23h   Running   True
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="configuring-vnc-access">Configuring VNC access</h4>
<p>Refer to <a href="https://kubevirt.io/2019/Access-Virtual-Machines-graphic-console-using-noVNC.html">Access Virtual Machines&rsquo; graphic console using noVNC</a> you can deploy virtVNC to access the booted Windows server. The main point here is to expose a NodePort service that can be accessed via the</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">subresources.kubevirt.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachineinstances/console</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachineinstances/vnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">kubevirt.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachines</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachineinstances</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachineinstancepresets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachineinstancereplicasets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">virtualmachineinstancemigrations</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">get</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">list</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#type: LoadBalancer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubevirt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">virtvnc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">quay.io/samblade/virtvnc:v0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ kubectl apply -f virtvnc.yaml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>By accessing this NodePort service, you can both</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/22df3e1dd7bc4459a59da0e340423b7f.png" alt="NodePort"></p>
<p>Next you can install the Windows operating system as instructed in <a href="https://www.cnblogs.com/ryanyangcs/p/14079144.html">kubernetes creating a windows 10 virtual machine using kubevirt</a>.</p>
<h4 id="configuring-remote-connections">Configuring remote connections</h4>
<p>Although VNC can access the Windows graphical interface remotely, the operating experience is rather unpleasant. Once the system is installed, you can use Windows&rsquo; Remote Connection Protocol, RDP, by selecting <strong>Start</strong> &gt; <strong>Settings</strong> &gt; <strong>System</strong> &gt; <strong>Remote Desktop</strong> and turning on <strong>Enable Remote Desktop</strong>.</p>
<p>Now you can test the connectivity of RDP port 3389 via telnet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># telnet 172.16.0.32 3389</span>
</span></span><span class="line"><span class="cl">Trying 172.16.0.32...
</span></span><span class="line"><span class="cl">Connected to 172.16.0.32.
</span></span><span class="line"><span class="cl">Escape character is <span class="s1">&#39;^]&#39;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>If your local computer can connect directly to the <code>Pod IP</code> and <code>SVC IP</code>, you can now connect directly to Windows remotely via the RDP client. If your local computer cannot connect directly to the <code>Pod IP</code> and <code>SVC IP</code>, but can connect directly to the <code>Node IP</code> of the Kubernetes cluster, you can expose the RDP port via <code>NodePort</code>. This is done by creating a Service with the type NodePort.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># virtctl expose vm win10  --name win10-rdp --port 3389 --target-port 3389 --type NodePort</span>
</span></span><span class="line"><span class="cl">Service win10-rdp successfully exposed <span class="k">for</span> vm win10
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># kubectl get svc</span>
</span></span><span class="line"><span class="cl">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
</span></span><span class="line"><span class="cl">kube-user    LoadBalancer   172.16.253.39   10.3.4.28     443:31525/TCP    27h
</span></span><span class="line"><span class="cl">kubernetes   ClusterIP      172.16.252.1    &lt;none&gt;        443/TCP          42h
</span></span><span class="line"><span class="cl">win10-rdp    NodePort       172.16.255.78   &lt;none&gt;        3389:32200/TCP   8s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then you can connect to Windows remotely via <code>Node IP</code>. If your local operating system is <strong>Windows 10</strong>, you can type &quot; <strong>Remote Desktop Connection</strong>&quot; in the search box in the taskbar, and then select &quot; <strong>Remote Desktop Connection</strong>&quot;. In &ldquo;Remote Desktop Connection&rdquo;, type the name of the computer you want to connect to (from step 1), and then select &ldquo;<strong>Connect</strong>&rdquo;. If your local operating system is <code>macOS</code>, you need to install <code>Microsoft Remote Desktop</code> in the App Store.</p>
<h4 id="windows-to-access-the-external-network">windows to access the external network</h4>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/1e1368ad367a43cd857f9e0a24143e4f.png" alt="nginx"></p>
<h4 id="extranet-access-to-windows">extranet access to windows</h4>
<p>Installing the nginx service in a Windows virtual machine allows you to access it in Windows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/5997f3d67cd542caba88a01654045deb.png" alt="nginx"></p>
<p>At this point, you can access the Nginx service within the cluster by directly accessing the IP corresponding to the Windows virtual machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">[root@VM-4-27-centos ~]# kubectl get vmi win10
</span></span><span class="line"><span class="cl">NAME    AGE    PHASE     IP            NODENAME    READY
</span></span><span class="line"><span class="cl">win10   5d5h   Running   172.16.0.32   10.3.4.27   True
</span></span><span class="line"><span class="cl">[root@VM-4-27-centos ~]# curl 172.16.0.32:80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Welcome to nginx!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">body</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">width</span><span class="p">:</span> <span class="mi">35</span><span class="kt">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">margin</span><span class="p">:</span> <span class="mi">0</span> <span class="kc">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">font-family</span><span class="p">:</span> <span class="n">Tahoma</span><span class="p">,</span> <span class="n">Verdana</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome to nginx!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>If you see this page, the nginx web server is successfully installed and
</span></span><span class="line"><span class="cl">working. Further configuration is required.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>For online documentation and support please refer to
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;http://nginx.org/&#34;</span><span class="p">&gt;</span>nginx.org<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">Commercial support is available at
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;http://nginx.com/&#34;</span><span class="p">&gt;</span>nginx.com<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">em</span><span class="p">&gt;</span>Thank you for using nginx.<span class="p">&lt;/</span><span class="nt">em</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To be able to expose the services of this Windows virtual machine to the extranet, create the following Service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">win10-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">externalTrafficPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubevirt.io/domain</span><span class="p">:</span><span class="w"> </span><span class="l">win10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the NodePort service was created.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># kubectl get svc</span>
</span></span><span class="line"><span class="cl">win10-nginx   NodePort       172.16.255.171   &lt;none&gt;        80:31251/TCP     3s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Accessing the NodePort service at this point gives access to the services provided by the Windows VM.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/a2adeea5092843ec803d14a3b33c783e.png" alt="NodePort service"></p>
<h2 id="storage">Storage</h2>
<p>Virtual machine images (disks) are an essential part of starting a virtual machine, and KubeVirt provides a variety of ways to use virtual machine disks, and virtual machine images (disks) are very flexible. Here are some of the more common ones.</p>
<ul>
<li><strong>PersistentVolumeClaim</strong> : Use PVC as backend storage, suitable for data persistence, i.e. data still exists after VM reboot or rebuild. The PV type used can be block and filesystem
<ul>
<li>When using filesystem, the /disk.img file on the PVC in RAW format is used as the hard disk.</li>
<li>When block mode is used, the block volume is provided directly to the virtual machine as a raw block device.</li>
</ul>
</li>
<li><strong>ephemeral</strong> : Make a copy-on-write (COW) mirror layer locally based on the backend storage, all writes are in the mirror on the local storage, the write layer is removed when the VM instance is stopped and the mirror on the backend storage does not change.</li>
<li><strong>containerDisk</strong> : A docker image built based on scratch, the image contains the VM image needed for VM boot, you can push the docker image to registry, pull the image from registry when using, use containerDisk directly as VMI disk, the data is not persistent.</li>
<li><strong>hostDisk</strong> : Use the disk image on the node, similar to <code>hostpath</code>, you can also create an empty image at initialization time.</li>
<li><strong>dataVolume</strong> : Provides the ability to automatically import VM disks into a pvc during the VM boot process. without DataVolume, the user must first prepare the pvc with the disk image and then assign it to the VM or VMI. dataVolume pulls the image from a source such as http, object storage, another PVC, etc.</li>
</ul>
<p>See <a href="https://kubevirt.io/user-guide/virtual_machines/disks_and_volumes/">Kubevirt: Disks and Volumes</a> for more information.</p>
<h2 id="global-route-mode-bridge-network-principle">global route mode bridge network principle</h2>
<p>The virtual machine network is pod network, the NIC of virt-launcher pod network no longer hangs with pod ip, but acts as a handover physical NIC for virtual machine&rsquo;s virtual NIC to communicate with external network. virt-launcher implements a simple single ip dhcp server, that is, you need to start dhclient in virtual machine, virt- launcher service will be assigned to the virtual machine.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/9aeda2079de7479ab6ece95a8b4a8cc2.png" alt="global route mode bridge network principle"></p>
<h3 id="outbound-destination-is-an-out-of-cluster-address">Outbound: destination is an out-of-cluster address</h3>
<p>To view the route in the virtual machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ ip route
</span></span><span class="line"><span class="cl">default via 172.16.0.1 dev eth0 proto dhcp metric <span class="m">100</span>
</span></span><span class="line"><span class="cl">172.16.0.0/26 dev eth0 proto kernel scope link src 172.16.0.24 metric <span class="m">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>All Pods on virtual machine Node1 belong to the same IP subnet 172.20.0.0/26, and these Pods are connected to virtual bridge cbr0. As shown in the second routing entry in the routing table above, traffic destined for subnet 172.20.0.0/26 will be sent out through eth0 of the virtual machine. The Veth pair of eth0 is on the bridge, so the bridge will receive the packet. After the bridge receives the packet, it will send the packet out through Layer 2 forwarding from the port on the bridge connected to the destination Pod, and the data will reach the Veth pair pair on that end, i.e. the destination Pod of the packet.</li>
<li>If the IP is sent to the outside world, it is sent to the gateway 172.16.0.1 by default. here the gateway is the address of cbr0 on top of the host.</li>
</ul>
<p>In fact, the routes of the virtual machine here all come from the routing information in the launcher Pod. If you look at the routing information in the <code>launcher Pod</code>, it is empty.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># ip r</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># ip n</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Checking the virtual machine IP information, you can see that the virtual machine IP is 172.16.0.24 and the MAC is 5e:04:61:17:c1:c9, which is also taken from the launcher Pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 ::1/128 scope host
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq_codel state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 5e:04:61:17:c1:c9 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    altname enp1s0
</span></span><span class="line"><span class="cl">    inet 172.16.0.24/26 brd 172.16.0.63 scope global dynamic noprefixroute eth0
</span></span><span class="line"><span class="cl">       valid_lft 85794782sec preferred_lft 85794782sec
</span></span><span class="line"><span class="cl">    inet6 fe80::5c04:61ff:fe17:c1c9/64 scope link
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>View the existing interfaces in the launcher Pod.</p>
<ul>
<li><code>eth0-nic</code> is the original eth0 interface of the Pod</li>
<li><code>tap0</code> is the tap device corresponding to eth0 of the virtual machine</li>
<li><code>k6t-eth0</code> is the bridge in the launcher Pod</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class="line"><span class="cl">    inet 127.0.0.1/8 scope host lo
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">3: eth0-nic@if28: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue master k6t-eth0 state UP group default
</span></span><span class="line"><span class="cl">    link/ether 5e:04:61:bf:d4:04 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
</span></span><span class="line"><span class="cl">4: eth0: &lt;BROADCAST,NOARP&gt; mtu <span class="m">1500</span> qdisc noop state DOWN group default
</span></span><span class="line"><span class="cl">    link/ether 0a:80:97🇩🇪c2:56 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 172.16.0.24/26 brd 172.16.0.63 scope global eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">5: k6t-eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default
</span></span><span class="line"><span class="cl">    link/ether 1a:2b:ab:44:18:07 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 169.254.75.10/32 scope global k6t-eth0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">6: tap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq_codel master k6t-eth0 state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 36:9c:11:71:fa:d6 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that eth0-nic and tap0 are both mounted on the bridge k6t-eth0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># ip link show master k6t-eth0</span>
</span></span><span class="line"><span class="cl">3: eth0-nic@if28: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue master k6t-eth0 state UP mode DEFAULT group default
</span></span><span class="line"><span class="cl">    link/ether 5e:04:61:bf:d4:04 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
</span></span><span class="line"><span class="cl">6: tap0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc fq_codel master k6t-eth0 state UP mode DEFAULT group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 36:9c:11:71:fa:d6 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></td></tr></table>
</div>
</div><p>For information about cbr0 on the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">5: cbr0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP group default qlen <span class="m">1000</span>
</span></span><span class="line"><span class="cl">    link/ether 92:3f:13:e2:55:c9 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 172.16.0.1/26 brd 172.16.0.63 scope global cbr0
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::903f:13ff:fee2:55c9/64 scope link
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>Access the external segment from the virtual machine, e.g. <code>8.8.8.8</code>, and capture the packet in the launcher Pod, here on the tap device.</p>
<ul>
<li>Source IP: IP of virtual machine eth0</li>
<li>Source Mac: the MAC of the virtual machine eth0</li>
<li>Destination IP: IP of the virtual machine gateway, that is, the IP of cbr0 on the host</li>
<li>Destination Mac: MAC of cbr0 on the host</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># tcpdump -itap0 -nnvve host 8.8.8.8</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on tap0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">20:19:58.369799 5e:04:61:17:c1:c9 &gt; 92:3f:13:e2:55:c9, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x0, ttl 64, id 54189, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    172.16.0.24 &gt; 8.8.8.8: ICMP <span class="nb">echo</span> request, id 10, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">20:19:58.371143 92:3f:13:e2:55:c9 &gt; 5e:04:61:17:c1:c9, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x64, ttl 117, id 0, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    8.8.8.8 &gt; 172.16.0.24: ICMP <span class="nb">echo</span> reply, id 10, seq 1, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tap device is connected to the bridge and captures packets on the bridge k6t-eth0 device, source and destination addresses are unchanged</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># tcpdump -ik6t-eth0 -nnvve host 8.8.8.8</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on k6t-eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">20:28:28.945397 5e:04:61:17:c1:c9 &gt; 92:3f:13:e2:55:c9, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x0, ttl 64, id 21796, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    172.16.0.24 &gt; 8.8.8.8: ICMP <span class="nb">echo</span> request, id 11, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">20:28:28.946743 92:3f:13:e2:55:c9 &gt; 5e:04:61:17:c1:c9, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x64, ttl 117, id 0, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    8.8.8.8 &gt; 172.16.0.24: ICMP <span class="nb">echo</span> reply, id 11, seq 1, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The next step is to catch the packet on the Pod&rsquo;s original network port <code>eth0-nic</code>, with both source and destination addresses unchanged.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># tcpdump -ieth0-nic -nnvve host 8.8.8.8</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on eth0-nic, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">20:30:02.087639 5e:04:61:17:c1:c9 &gt; 92:3f:13:e2:55:c9, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x0, ttl 64, id 2902, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    172.16.0.24 &gt; 8.8.8.8: ICMP <span class="nb">echo</span> request, id 11, seq 94, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">20:30:02.088959 92:3f:13:e2:55:c9 &gt; 5e:04:61:17:c1:c9, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x64, ttl 117, id 0, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    8.8.8.8 &gt; 172.16.0.24: ICMP <span class="nb">echo</span> reply, id 11, seq 94, length <span class="m">64</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>How does the bridge <code>k6t-eth0</code> know that the packets should go to <code>eth0-nic</code>? Here is the flood done here on the k6t-eth0 bridge, all interfaces hooked up to the bridge can catch access to <code>8.8.8.8</code>.</p>
<p>How does the virtual machine know the MAC corresponding to <code>172.16.0.1</code>? Check the ARP in the virtual machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ ip n
</span></span><span class="line"><span class="cl">172.16.0.1 dev eth0 lladdr 92:3f:13:e2:55:c9 REACHABLE
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is the MAC of cbr0, after taking out this table entry, you can catch the corresponding arp packet</p>
<p>After reaching <code>eth0-nic</code>, you can reach the veth port on the opposite side of the Pod and go out from the node according to the global routing pattern.</p>
<h3 id="inbound-accessing-the-vm-from-the-node">Inbound: accessing the VM from the node</h3>
<p>In the global routing mode, for the IP of the global routing segment of this node, the default route is the bridge on the node cbr0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@VM-4-27-centos ~<span class="o">]</span><span class="c1"># ip r</span>
</span></span><span class="line"><span class="cl">172.16.0.0/26 dev cbr0 proto kernel scope link src 172.16.0.1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The cbr0 bridge mounts the veth of the Pod, for accessing the IP of the virtual machine, the IP is forwarded to the veth pair corresponding to the Pod through the bridge layer 2 by default. after reaching the Pod, it takes the bridge inside the Pod, gives it to the tap device, and finally reaches the virtual machine.</p>
<h2 id="vpc-cni-mode-bridge-network-principle">VPC CNI mode bridge network principle</h2>
<p>For VPC CNI network mode, the basic principle is similar to global routing for VMs using bridge, but you will find that you cannot access the external network from the VM. From the tap device, it can not catch the corresponding ip packets, but only ARP packets.</p>
<p>In VPC CNI mode, there is a default route to the default gateway 169.254.1.1 in the Pod, and a static ARP entry is set.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ k <span class="nb">exec</span> network-tool-549c7756bd-6tfkf -- route -n
</span></span><span class="line"><span class="cl">Kernel IP routing table
</span></span><span class="line"><span class="cl">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class="line"><span class="cl">0.0.0.0         169.254.1.1     0.0.0.0         UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> eth0
</span></span><span class="line"><span class="cl">169.254.1.1     0.0.0.0         255.255.255.255 UH    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> eth0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜  ~ k <span class="nb">exec</span> network-tool-549c7756bd-6tfkf -- arp     
</span></span><span class="line"><span class="cl">Address                  HWtype  HWaddress           Flags Mask            Iface
</span></span><span class="line"><span class="cl">169.254.1.1              ether   e2:62:fb:d2:cb:28   CM                    eth0
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, in the virtual machine, there is only the default route and no static ARP.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ ip r
</span></span><span class="line"><span class="cl">default via 169.254.1.1 dev eth0 proto dhcp metric <span class="m">100</span>
</span></span><span class="line"><span class="cl">169.254.1.1 dev eth0 proto dhcp scope link metric <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ ip n
</span></span><span class="line"><span class="cl">10.3.1.6 dev eth0 lladdr d2:e9:79:c9:e6:2d STALE
</span></span><span class="line"><span class="cl">169.254.1.1 dev eth0  INCOMPLETE
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can catch the corresponding ARP packets from the bridge in the VM and Pod, but there is no place to give a response, so</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 进入 launcher pod netns</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-1-6-centos ~<span class="o">]</span><span class="c1"># tcpdump -itap0 -nnvve arp</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on tap0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">15:46:20.627859 d2:e9:79:c9:e6:2d &gt; 92:7b:a5:ca:24:5a, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 10.3.4.17 tell 10.3.1.6, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">15:46:20.628185 92:7b:a5:ca:24:5a &gt; d2:e9:79:c9:e6:2d, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Reply 10.3.4.17 is-at 92:7b:a5:ca:24:5a, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-1-6-centos ~<span class="o">]</span><span class="c1"># tcpdump -ik6t-eth0 -nnvve arp</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on k6t-eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">15:47:12.653020 92:7b:a5:ca:24:5a &gt; ff:ff:ff:ff:ff:ff, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 169.254.1.1 tell 10.3.4.17, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">15:47:13.676948 92:7b:a5:ca:24:5a &gt; ff:ff:ff:ff:ff:ff, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 169.254.1.1 tell 10.3.4.17, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-1-6-centos ~<span class="o">]</span><span class="c1"># tcpdump -ieth0-nic -nnvve arp</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on eth0-nic, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">15:47:23.918394 92:7b:a5:ca:24:5a &gt; ff:ff:ff:ff:ff:ff, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 169.254.1.1 tell 10.3.4.17, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">15:47:24.940922 92:7b:a5:ca:24:5a &gt; ff:ff:ff:ff:ff:ff, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 169.254.1.1 tell 10.3.4.17, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在宿主机 node netns，针对 pod 的 veth pair 抓包</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-1-6-centos ~<span class="o">]</span><span class="c1"># tcpdump -ienib7c8df57e35 -nnvve arp</span>
</span></span><span class="line"><span class="cl">dropped privs to tcpdump
</span></span><span class="line"><span class="cl">tcpdump: listening on enib7c8df57e35, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">15:48:03.853968 92:7b:a5:ca:24:5a &gt; ff:ff:ff:ff:ff:ff, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 169.254.1.1 tell 10.3.4.17, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">15:48:04.876960 92:7b:a5:ca:24:5a &gt; ff:ff:ff:ff:ff:ff, ethertype ARP <span class="o">(</span>0x0806<span class="o">)</span>, length 42: Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 169.254.1.1 tell 10.3.4.17, length <span class="m">28</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you add this static route to a virtual machine, you can get through to the virtual machine network, where the mac is the mac address of the Pod&rsquo;s veth pair.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ sudo ip n replace 169.254.1.1 lladdr d2:e9:79:c9:e6:2d dev eth0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>fedora@testvmi-nocloud2 ~<span class="o">]</span>$ ping baidu.com
</span></span><span class="line"><span class="cl">PING baidu.com <span class="o">(</span>220.181.38.251<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 220.181.38.251 <span class="o">(</span>220.181.38.251<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">48</span> <span class="nv">time</span><span class="o">=</span>46.2 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 220.181.38.251 <span class="o">(</span>220.181.38.251<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">48</span> <span class="nv">time</span><span class="o">=</span>46.5 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="networking-code-reading">Networking Code Reading</h2>
<p>Referring to <a href="https://github.com/kubevirt/kubevirt/blob/main/docs/devel/networking.md">Kubevirt: VMI Networking</a>, the configuration of Interface for VMs in Kubevirt is divided into two Phase.</p>
<ul>
<li><a href="https://github.com/kubevirt/kubevirt/blob/main/docs/devel/networking.md#privileged-vmi-networking-configuration">privileged networking configuration</a>: Implemented in the virt-handler process</li>
<li><a href="https://github.com/kubevirt/kubevirt/blob/main/docs/devel/networking.md#unprivileged-vmi-networking-configuration">unprivileged networking configuration</a>: occurs in the virt-launcher process</li>
</ul>
<h3 id="phase1">Phase1</h3>
<p>The first step in Phase1 is to decide which BindMechanism to use instead, and each BindMechanism implements the following methods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">BindMechanism</span> <span class="kd">interface</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">discoverPodNetworkInterface</span><span class="o">()</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">    <span class="nf">preparePodNetworkInterfaces</span><span class="o">()</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">loadCachedInterface</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">name</span> <span class="n">string</span><span class="o">)</span> <span class="o">(</span><span class="n">bool</span><span class="o">,</span> <span class="n">error</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">setCachedInterface</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">name</span> <span class="n">string</span><span class="o">)</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">loadCachedVIF</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">name</span> <span class="n">string</span><span class="o">)</span> <span class="o">(</span><span class="n">bool</span><span class="o">,</span> <span class="n">error</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">setCachedVIF</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">name</span> <span class="n">string</span><span class="o">)</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The following entry points require domain initialized for the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// binding and can be used in phase2 only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">decorateConfig</span><span class="o">()</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">    <span class="nf">startDHCP</span><span class="o">(</span><span class="n">vmi</span> <span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="na">VirtualMachineInstance</span><span class="o">)</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once BindMechanism is determined, the following methods are called in turn.</p>
<ul>
<li>discoverPodNetworkInterface: Get the information about the Pod NIC device, including IP address, route, gateway, etc.</li>
<li>preparePodNetworkInterfaces: Configure the network based on the information obtained earlier.</li>
<li>setCachedInterface: cache the interface information in memory</li>
<li>setCachedVIF: persist VIF objects in the file system at <code>/proc/&lt;virt-launcher-pid&gt;/root/var/run/kubevirt-private/vif-cache-&lt;iface_name&gt;.json</code>.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">podNIC</span><span class="p">)</span> <span class="nf">PlugPhase1</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// There is nothing to plug for SR-IOV devices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">vmiSpecIface</span><span class="p">.</span><span class="nx">SRIOV</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">state</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">state</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="nx">state</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">PodIfaceNetworkPreparationStarted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">CreateCriticalNetworkError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;pod interface %s network preparation cannot be resumed&#34;</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">podInterfaceName</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">PodIfaceNetworkPreparationFinished</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">setPodInterfaceCache</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">infraConfigurator</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">infraConfigurator</span><span class="p">.</span><span class="nf">DiscoverPodNetworkInterface</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">podInterfaceName</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dhcpConfig</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">infraConfigurator</span><span class="p">.</span><span class="nf">GenerateNonRecoverableDHCPConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">dhcpConfig</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;The generated dhcpConfig: %s&#34;</span><span class="p">,</span> <span class="nx">dhcpConfig</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="p">=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">WriteDHCPInterfaceCache</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">cacheCreator</span><span class="p">,</span> <span class="nf">getPIDString</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">launcherPID</span><span class="p">),</span> <span class="nx">l</span><span class="p">.</span><span class="nx">podInterfaceName</span><span class="p">,</span> <span class="nx">dhcpConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to save DHCP configuration: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">domainIface</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">infraConfigurator</span><span class="p">.</span><span class="nf">GenerateNonRecoverableDomainIfaceSpec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">domainIface</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;The generated libvirt domain interface: %+v&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">domainIface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">storeCachedDomainIface</span><span class="p">(</span><span class="o">*</span><span class="nx">domainIface</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to save libvirt domain interface: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">PodIfaceNetworkPreparationStarted</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed setting state to PodIfaceNetworkPreparationStarted: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// preparePodNetworkInterface must be called *after* the Generate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// methods since it mutates the pod interface from which those
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// generator methods get their info from.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">infraConfigurator</span><span class="p">.</span><span class="nf">PreparePodNetworkInterface</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to prepare pod networking&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">CreateCriticalNetworkError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">PodIfaceNetworkPreparationFinished</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed setting state to PodIfaceNetworkPreparationFinished&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">CreateCriticalNetworkError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="phase2">Phase2</h3>
<p>Phase2 runs in virt-launcher and has many more privileges than phase1, with only <code>CAP_NET_ADMIN</code> privileges in the network. object). Based on the VIF information, proceed to decorate the domain xml configuration of the VM it will encapsulate</p>
<ul>
<li><code>loadCachedInterface</code></li>
<li><code>loadCachedVIF</code></li>
<li><code>decorateConfig</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">podNIC</span><span class="p">)</span> <span class="nf">PlugPhase2</span><span class="p">(</span><span class="nx">domain</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">Domain</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">precond</span><span class="p">.</span><span class="nf">MustNotBeNil</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// There is nothing to plug for SR-IOV devices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">vmiSpecIface</span><span class="p">.</span><span class="nx">SRIOV</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">domainGenerator</span><span class="p">.</span><span class="nf">Generate</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Critical</span><span class="p">(</span><span class="s">&#34;failed to create libvirt configuration&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">dhcpConfigurator</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dhcpConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">dhcpConfigurator</span><span class="p">.</span><span class="nf">Generate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get a dhcp configuration for: %s&#34;</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">podInterfaceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;The imported dhcpConfig: %s&#34;</span><span class="p">,</span> <span class="nx">dhcpConfig</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">dhcpConfigurator</span><span class="p">.</span><span class="nf">EnsureDHCPServerStarted</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">podInterfaceName</span><span class="p">,</span> <span class="o">*</span><span class="nx">dhcpConfig</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">vmiSpecIface</span><span class="p">.</span><span class="nx">DHCPOptions</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Criticalf</span><span class="p">(</span><span class="s">&#34;failed to ensure dhcp service running for: %s&#34;</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">podInterfaceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bindmechanism">BindMechanism</h3>
<h4 id="discoverpodnetworkinterface">DiscoverPodNetworkInterface</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">BridgePodNetworkConfigurator</span><span class="p">)</span> <span class="nf">DiscoverPodNetworkInterface</span><span class="p">(</span><span class="nx">podIfaceName</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">link</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">LinkByName</span><span class="p">(</span><span class="nx">podIfaceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get a link for interface: %s&#34;</span><span class="p">,</span> <span class="nx">podIfaceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span> <span class="p">=</span> <span class="nx">link</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">addrList</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">AddrList</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">,</span> <span class="nx">netlink</span><span class="p">.</span><span class="nx">FAMILY_V4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Reason</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get an ip address for %s&#34;</span><span class="p">,</span> <span class="nx">podIfaceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">addrList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">.</span><span class="nx">ipamEnabled</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">.</span><span class="nx">podIfaceIP</span> <span class="p">=</span> <span class="nx">addrList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">.</span><span class="nx">ipamEnabled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">learnInterfaceRoutes</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">tapDeviceName</span> <span class="p">=</span> <span class="nx">virtnetlink</span><span class="p">.</span><span class="nf">GenerateTapDeviceName</span><span class="p">(</span><span class="nx">podIfaceName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">vmMac</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">virtnetlink</span><span class="p">.</span><span class="nf">RetrieveMacAddressFromVMISpecIface</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">vmiSpecIface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">vmMac</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">.</span><span class="nx">vmMac</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">.</span><span class="nf">Attrs</span><span class="p">().</span><span class="nx">HardwareAddr</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="preparepodnetworkinterface">PreparePodNetworkInterface</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">BridgePodNetworkConfigurator</span><span class="p">)</span> <span class="nf">PreparePodNetworkInterface</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Set interface link to down to change its MAC address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">LinkSetDown</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">ipamEnabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Remove IP from POD interface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">AddrDel</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">.</span><span class="nx">podIfaceIP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">b</span><span class="p">.</span><span class="nf">switchPodInterfaceWithDummy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Set arp_ignore=1 to avoid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the dummy interface being seen by Duplicate Address Detection (DAD).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Without this, some VMs will lose their ip address after a few
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// minutes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">ConfigureIpv4ArpIgnore</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">SetRandomMac</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">.</span><span class="nf">Attrs</span><span class="p">().</span><span class="nx">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">createBridge</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">tapOwner</span> <span class="o">:=</span> <span class="nx">netdriver</span><span class="p">.</span><span class="nx">LibvirtUserAndGroupId</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">util</span><span class="p">.</span><span class="nf">IsNonRootVMI</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">vmi</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tapOwner</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">NonRootUID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">createAndBindTapToBridge</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tapDeviceName</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">bridgeInterfaceName</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">launcherPID</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">.</span><span class="nf">Attrs</span><span class="p">().</span><span class="nx">MTU</span><span class="p">,</span> <span class="nx">tapOwner</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">vmi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">LinkSetUp</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nf">LinkSetLearningOff</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">podNicLink</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>Reference <code>https://houmin.cc/posts/b2eff5e7/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubevirt/">kubevirt</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-05/network-virtualization-vlan/">
            <span class="next-text nav-default">[Network Virtualization] VLAN</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
