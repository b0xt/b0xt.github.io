<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>K3s Tools Advanced Guide - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn to use K3s tools with ease by understanding the official documentation in depth!" /><meta name="keywords" content="k3s" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/k3s-advice/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="K3s Tools Advanced Guide" />
<meta property="og:description" content="Learn to use K3s tools with ease by understanding the official documentation in depth!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/k3s-advice/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-25T13:00:23+08:00" />
<meta property="article:modified_time" content="2022-05-25T13:00:23+08:00" />

<meta itemprop="name" content="K3s Tools Advanced Guide">
<meta itemprop="description" content="Learn to use K3s tools with ease by understanding the official documentation in depth!"><meta itemprop="datePublished" content="2022-05-25T13:00:23+08:00" />
<meta itemprop="dateModified" content="2022-05-25T13:00:23+08:00" />
<meta itemprop="wordCount" content="10246">
<meta itemprop="keywords" content="k3s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K3s Tools Advanced Guide"/>
<meta name="twitter:description" content="Learn to use K3s tools with ease by understanding the official documentation in depth!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">K3s Tools Advanced Guide</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-25 13:00:23 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 10246 words </span>
          <span class="more-meta"> 21 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-introduction-to-k3s-tools">1. Introduction to K3s tools</a></li>
        <li><a href="#2-k3s-quick-start">2. K3s Quick Start</a>
          <ul>
            <li><a href="#k3s-architecture">K3s architecture</a></li>
            <li><a href="#k8s-architecture">K8s architecture</a></li>
          </ul>
        </li>
        <li><a href="#3-k3s-installation">3. K3s Installation</a>
          <ul>
            <li><a href="#configuration-requirements">Configuration requirements</a></li>
            <li><a href="#command-parameters">Command parameters</a></li>
            <li><a href="#network-options">Network options</a></li>
            <li><a href="#external-database">External database</a></li>
            <li><a href="#private-image-repository">Private image repository</a></li>
            <li><a href="#off-line-installation">Off-line installation</a></li>
            <li><a href="#dashboard-and-uninstallation">Dashboard and uninstallation</a></li>
            <li><a href="#notes">Notes</a></li>
          </ul>
        </li>
        <li><a href="#4-k3s-cluster-upgrade">4. K3s Cluster Upgrade</a>
          <ul>
            <li><a href="#manual-upgrade---upgrade-k3s-using-the-install-script">Manual upgrade - Upgrade K3s using the install script</a></li>
            <li><a href="#manual-upgrade---upgrade-k3s-manually-using-binaries">Manual upgrade - Upgrade K3s manually using binaries</a></li>
            <li><a href="#automatic-upgrade---manually-upgrade-k3s-using-binary-files">Automatic upgrade - manually upgrade K3s using binary files</a></li>
          </ul>
        </li>
        <li><a href="#5-k3s-backup-recovery">5. K3s Backup Recovery</a>
          <ul>
            <li><a href="#backup-and-restore-with-embedded-sqlite-datastore">Backup and restore with embedded SQLite datastore</a></li>
            <li><a href="#use-external-data-storage-for-backup-and-recovery">Use external data storage for backup and recovery</a></li>
            <li><a href="#backup-and-restore-with-embedded-etcd-datastore">Backup and restore with embedded etcd datastore</a></li>
          </ul>
        </li>
        <li><a href="#6-k3s-volumes-and-storage">6. K3s volumes and storage</a>
          <ul>
            <li><a href="#setting-up-local-storage-provider-support">Setting up Local Storage Provider support</a></li>
            <li><a href="#setting-up-longhorn-support">Setting up Longhorn support</a></li>
          </ul>
        </li>
        <li><a href="#7-k3s-network-related">7. K3s network related</a>
          <ul>
            <li><a href="#coredns">CoreDNS</a></li>
            <li><a href="#traefik-ingress-controller">Traefik Ingress Controller</a></li>
            <li><a href="#service-load-balancer">Service Load Balancer</a></li>
          </ul>
        </li>
        <li><a href="#8-k3s-and-helm">8. K3s and Helm</a>
          <ul>
            <li><a href="#automatically-deploy-helm-charts">Automatically deploy Helm charts</a></li>
            <li><a href="#using-helm-crd">Using Helm CRD</a></li>
          </ul>
        </li>
        <li><a href="#9-k3s-advanced-options">9. K3s Advanced Options</a>
          <ul>
            <li><a href="#certificate-rotation">Certificate Rotation</a></li>
            <li><a href="#additional-preparation-for-red-hat-and-centos">Additional preparation for Red Hat and CentOS</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><code>K3s</code> is a lightweight <code>Kubernetes</code> distribution that is highly optimized for edge computing, IoT, and other scenarios.</p>
<ul>
<li><code>Kubernetes</code> distribution certified by <code>CNCF</code>.</li>
<li>Support for <code>X86_64</code> , <code>ARM64</code> , <code>ARMv7</code> platforms.</li>
<li>A single process containing <code>Kubernetes master</code> , <code>kubelet</code> and <code>containerd</code>.</li>
</ul>
<h2 id="1-introduction-to-k3s-tools">1. Introduction to K3s tools</h2>
<p><code>K3s</code> has the following enhancements.</p>
<ul>
<li>Package as a single binary.
<ul>
<li>Package <code>K8S</code> related components such as <code>kube-api</code> / <code>kube-manager</code> into a single binary, so that you can quickly start the corresponding components by simply launching the file.</li>
</ul>
</li>
<li>Use the default storage mechanism based on sqlite3.
<ul>
<li>Support for using <code>etcd3</code>, <code>MySQL</code> and <code>PostgreSQL</code> as storage mechanisms.</li>
</ul>
</li>
<li>Secure by default
<ul>
<li>There is a default certificate management mechanism in <code>K3s</code> (default one year validity) and also a feature to rotate certificates (that is, if you restart <code>K3s</code> in less than ninety days, it will automatically renew for one year).</li>
</ul>
</li>
<li>Powerful <code>batteries-included</code> feature.
<ul>
<li>Although some services are not provided by the binary file itself, you can use the built-in service to put the configuration file in the specified directory to start the service or replace the default component when you start it.</li>
</ul>
</li>
<li>All <code>K8S control-plane</code> components are encapsulated in a single binary and process.
<ul>
<li>Because they are encapsulated in a binary, there is only one process at startup. The advantage is that only this single process needs to be managed, and it also has the ability to operate complex clusters.</li>
</ul>
</li>
<li>Minimizes external dependencies.
<ul>
<li>i.e. a slightly newer <code>Linux</code> kernel is sufficient (requires <code>kernel</code> and <code>cgroup</code> mounts).</li>
</ul>
</li>
</ul>
<p>It&rsquo;s called <code>K3s</code> because you want the installed <code>K8S</code> to be half the size in terms of memory footprint, and half the size is a <code>5</code> letter word, abbreviated as <code>K3s</code>.</p>
<ul>
<li>Life cycle
<ul>
<li>Simultaneous support for <code>3</code> versions of <code>K8s</code>, with the same lifecycle as <code>K8s</code></li>
<li>See : <a href="https://kubernetes.io/zh/docs/setup/release/version-skew-policy/">Kubernetes Versions and Version Deviation Support Policy</a> for more information</li>
</ul>
</li>
<li>Update cycle
<ul>
<li>When <code>K8s</code> is updated with a new version, generally <code>K3s</code> is updated within a week</li>
<li>You can get <strong><code>latest</code> / <code>stable</code> / <code>testing</code></strong> versions via this <a href="https://update.k3s.io/v1-release/channels">link</a></li>
<li>We have the <code>stable</code> version installed by default, which can be viewed by running the command</li>
</ul>
</li>
<li>Naming convention
<ul>
<li><strong>v1.20.4+k3s1</strong> : <code>v1.20.4</code> is the <code>K8s</code> version, <code>k3s1</code> is the patch version</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># K3s软件包需要的依赖项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">containerd </span><span class="w"> </span><span class="c"># 容器运行时(可以使用docker替代)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">Flannel    </span><span class="w"> </span><span class="c"># 网络</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">CoreDNS    </span><span class="w"> </span><span class="c"># DNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">CNI        </span><span class="w"> </span><span class="c"># CNI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">Traefik    </span><span class="w"> </span><span class="c"># 默认的controller服务(apisix/ingress-controller)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">iptables   </span><span class="w"> </span><span class="c"># 主机实用程序</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">service load balancer    </span><span class="w"> </span><span class="c"># 嵌入式服务负载均衡器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">network policy controller</span><span class="w"> </span><span class="c"># 嵌入式网络策略控制器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># K3s适用于以下场景</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">CI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">Development</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">ARM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">嵌入 K8s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">物联网-IoT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">边缘计算-Edge</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>At the same time, the <code>Rancher</code> team in China has launched an efficiency tool for <code>K3s</code>: <strong>AutoK3s</strong> . You can quickly create a <code>K3s</code> cluster and add a specified number of <code>master</code> nodes and <code>worker</code> nodes with a single command.</p>
<h2 id="2-k3s-quick-start">2. K3s Quick Start</h2>
<p>The principle is to encapsulate the components of <code>K8S</code> into the <code>K3s</code> binary, and then start the binary to start a full-fledged <code>K8S</code> cluster. We can see that the architecture of <code>K3s</code> and <code>K8S</code> is basically the same, where <code>k3s-server</code> corresponds to the <code>control-plane</code> and <code>k3s-agent</code> corresponds to the <code>node</code> node.</p>
<p>You can see that the default storage used in <code>k3s</code> is <code>SQLite</code> (self-contained) and the default network is <code>Flannel</code> (self-contained). When both the server and the client are started, they communicate through the <code>Tunnel-Proxy</code> component, which manages the network traffic through this channel. In the <code>agent</code> node, the corresponding <code>Pod</code> is created through the <code>kubelet</code> operation <code>contaninerd</code>.</p>
<h3 id="k3s-architecture">K3s architecture</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/25/6c109a21bf314ebb82e89458acfedfbb.png" alt="K3s architecture"></p>
<h3 id="k8s-architecture">K8s architecture</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/25/0458f79233a841f7aae55293e27e1a84.png" alt="K8s architecture"></p>
<p>In China, it is recommended to use the official <a href="https://mirror.rancher.cn/">mirror address</a>, which not only speeds up the local <code>K3s</code> time, but also facilitates the deployment and update of the service. This is also why it is recommended to use <code>k3s-install.sh</code> to deploy the service in China, because the addresses used internally are obtained from China.</p>
<h2 id="3-k3s-installation">3. K3s Installation</h2>
<p>Although it is possible to run server-side and working nodes by downloading the binaries ( <code>. /k3s server</code> ), but once we exit the process, the previously created nodes are also immediately destroyed, so it is still recommended to use a script for installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 主节点</span>
</span></span><span class="line"><span class="cl">$ ./k3s server
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 工作节点</span>
</span></span><span class="line"><span class="cl">$ ./k3s agent <span class="nv">K3s_URL</span><span class="o">=</span>xxx <span class="nv">K3s_TOKEN</span><span class="o">=</span>xxx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 清除垃圾文件</span>
</span></span><span class="line"><span class="cl">$ rm -rf /etc/rancher /var/lib/rancher
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Speed up by mirroring sites</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 添加配置</span>
</span></span><span class="line"><span class="cl">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">mirrors:
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;docker.io&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s">    endpoint:
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#34;https://fogjl973.mirror.aliyuncs.com&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#34;https://registry-1.docker.io&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启服务</span>
</span></span><span class="line"><span class="cl">$ sudo systemctl restart k3s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 是否生效</span>
</span></span><span class="line"><span class="cl">$ sudo crictl info <span class="p">|</span> grep -A <span class="m">2</span> <span class="s2">&#34;endpoint&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>K3s</code> provides an installation script that can be easily installed as a service on systems with <code>systemd</code> or <code>openrc</code>. After running this installation, the <code>K3s</code> service will be configured to restart automatically after a node reboot or if a process crashes or is killed.</p>
<ul>
<li>
<p>Contents of the installation</p>
<ul>
<li><code>kubectl</code>, <code>crictl</code>, <code>ctr</code></li>
<li><code>k3s-killall.sh</code> , <code>k3s-uninstall.sh</code></li>
</ul>
</li>
<li>
<p>Execute the operation</p>
<ul>
<li>Write the <code>kubeconfig</code> file to <code>/etc/rancher/k3s/k3s.yaml</code></li>
<li>The <code>kubectl</code> tool installed by <code>K3s</code> will automatically run with the configuration of this file</li>
<li>Other machines can operate the <code>K3s</code> cluster by copying this configuration file and changing the <code>server</code> address</li>
</ul>
</li>
</ul>
<p>Master Node - 192.168.100.100</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 安装脚本</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://get.k3s.io</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 建议使用这个安装脚本(国内化了)</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_NODE_NAME</span><span class="o">=</span>k3s1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_KUBECONFIG_OUTPUT</span><span class="o">=</span>/home/escape/.kube/config <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--docker&#34;</span> sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查找stable分支版本信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Finding release <span class="k">for</span> channel stable
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Using v1.23.6+k3s1 as release
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取国内镜像版本地址</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Downloading <span class="nb">hash</span> https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/sha256sum-amd64.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Downloading binary https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Verifying binary download
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装k3s二进制工具并链接相关工具(内置)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Installing k3s to /usr/local/bin/k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Skipping installation of SELinux RPM
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating /usr/local/bin/kubectl symlink to k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating /usr/local/bin/crictl symlink to k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Skipping /usr/local/bin/ctr symlink to k3s, <span class="nb">command</span> exists in PATH at /usr/bin/ctr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装清除和卸载k3s生成的配置和工具</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating killall script /usr/local/bin/k3s-killall.sh
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 常见了两个systemd的配置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  env: Creating environment file /etc/systemd/system/k3s.service.env
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  systemd: Creating service file /etc/systemd/system/k3s.service
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  systemd: Enabling k3s unit
</span></span><span class="line"><span class="cl">Created symlink /etc/systemd/system/multi-user.target.wants/k3s.service → /etc/systemd/system/k3s.service.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动k3s服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  systemd: Starting k3s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Work node - 192.168.100.101</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 工作节点上安装并将它们添加到集群</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://docs.rancher.cn/docs/k3s/architecture/_index#注册-agent-节点</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_URL</span><span class="o">=</span>https://myserver:6443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_TOKEN</span><span class="o">=</span>mynodetoken sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 建议使用这个安装命令(国内化了)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># K3s_URL: 会使K3s以worker模式运行</span>
</span></span><span class="line"><span class="cl"><span class="c1"># K3s_TOKEN: 使用的值存储在你的服务器节点上</span>
</span></span><span class="line"><span class="cl"><span class="c1"># K3s_NODE_NAME: 为每个节点提供一个有效且唯一的主机名</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_NODE_NAME</span><span class="o">=</span>k3s2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_KUBECONFIG_OUTPUT</span><span class="o">=</span>/home/escape/.kube/config <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_URL</span><span class="o">=</span>https://192.168.100.100:6443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_TOKEN</span><span class="o">=</span>mynodetoken sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># mynodetoken</span>
</span></span><span class="line"><span class="cl">$ sudo cat /var/lib/rancher/k3s/server/token
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查找stable分支版本信息</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Finding release <span class="k">for</span> channel stable
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Using v1.23.6+k3s1 as release
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取国内镜像版本地址</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Downloading <span class="nb">hash</span> https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/sha256sum-amd64.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Downloading binary https://rancher-mirror.rancher.cn/k3s/v1.23.6-k3s1/k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Verifying binary download
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装k3s二进制工具并链接相关工具(内置)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Installing k3s to /usr/local/bin/k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating /usr/local/bin/kubectl symlink to k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating /usr/local/bin/crictl symlink to k3s
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Skipping /usr/local/bin/ctr symlink to k3s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装清除和卸载k3s生成的配置和工具</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating killall script /usr/local/bin/k3s-agent-killall.sh
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  Creating uninstall script /usr/local/bin/k3s-agent-uninstall.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 常见了两个systemd的配置</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  env: Creating environment file /etc/systemd/system/k3s-agent.service.env
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  systemd: Creating service file /etc/systemd/system/k3s-agent.service
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  systemd: Enabling k3s-agent unit
</span></span><span class="line"><span class="cl">Created symlink /etc/systemd/system/multi-user.target.wants/k3s-agent.service → /etc/systemd/system/k3s-agent.service.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动k3s服务</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>INFO<span class="o">]</span>  systemd: Starting k3s-agent
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="configuration-requirements">Configuration requirements</h3>
<h4 id="prerequisites">Prerequisites</h4>
<ul>
<li>On selection, two nodes cannot have the same hostname</li>
<li>No hostname changes can be made by adding a random suffix or specifying a hostname</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 为每个节点添加随机后缀</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_URL</span><span class="o">=</span>https://192.168.100.100:6443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_TOKEN</span><span class="o">=</span>xxx sh -s - --with-node-id
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为每个节点指定主机名</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_NODE_NAME</span><span class="o">=</span><span class="s2">&#34;k3s2&#34;</span> <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_URL</span><span class="o">=</span>https://192.168.64.3:6443 <span class="nv">K3s_TOKEN</span><span class="o">=</span>xxx sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为每个节点指定主机名</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_URL</span><span class="o">=</span>https://192.168.64.3:6443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_TOKEN</span><span class="o">=</span>xxx sh -s - --node-name k3s2
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="hardware-information">Hardware Information</h4>
<ul>
<li>Operating system: Can run on most modern <code>Linux</code> systems.</li>
<li>Disk device: <code>K3s</code> performance depends on the performance of the database (<code>SSD</code> hard drives are recommended).</li>
<li>Network related: <code>K3s Server</code> node inbound rules, all outbound traffic is allowed.</li>
</ul>
<table>
<thead>
<tr>
<th>protocol</th>
<th>port</th>
<th>source</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>6443</td>
<td>K3s agent node</td>
<td>Kubernetes API Server</td>
</tr>
<tr>
<td>UDP</td>
<td>8472</td>
<td>K3s server and agent nodes</td>
<td>Required for Flannel VXLAN only</td>
</tr>
<tr>
<td>TCP</td>
<td>10250</td>
<td>K3s server and agent nodes</td>
<td>Kubelet metrics</td>
</tr>
<tr>
<td>TCP</td>
<td>2379-2380</td>
<td>K3s server node</td>
<td>Required only for embedded etcd high availability</td>
</tr>
</tbody>
</table>
<h4 id="installation-options">Installation Options</h4>
<ul>
<li><a href="https://docs.rancher.cn/docs/k3s/autok3s/_index">Official installation parameters documentation</a></li>
</ul>
<table>
<thead>
<tr>
<th>Environment Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSTALL_K3s_EXEC</td>
<td>Subsequent subcommands used to start K3s in the service</td>
</tr>
<tr>
<td>K3s_CONFIG_FILE</td>
<td>Specifies the location of the configuration file</td>
</tr>
<tr>
<td>K3s_TOKEN</td>
<td>shared secret value for adding server/agent to the cluster</td>
</tr>
<tr>
<td>K3s_TOKEN_FILE</td>
<td>shared secret file for adding the server/agent to the cluster</td>
</tr>
<tr>
<td>INSTALL_K3s_VERSION</td>
<td>specifies the version of K3s to download</td>
</tr>
<tr>
<td>K3s_TOKEN_FILE</td>
<td>specifies the cluster-secret/token file directory</td>
</tr>
<tr>
<td>INSTALL_K3s_SKIP_START</td>
<td>will not start the K3s service</td>
</tr>
<tr>
<td>INSTALL_K3s_SKIP_DOWNLOAD</td>
<td>for offline installation; remote tools will not be downloaded after setting</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 其实就把对应参数加到systemd配置文件里面去了</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--docker&#34;</span> sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 自动化部署(不用获取token值了)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 主节点和工作节点使用我们指定的key来通信</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_TOKEN</span><span class="o">=</span>rancher-k3s sh -
</span></span><span class="line"><span class="cl">$ sudo cat /var/lib/rancher/k3s/server/token
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="other-notes">Other notes</h4>
<ul>
<li><code>K3s_TOKEN</code> must also be set when running <code>agent</code>.</li>
<li>Environment variables starting with <code>K3s_</code> will be reserved for use by <code>systemd/openrc</code>.</li>
<li>If <code>exec</code> is not explicitly set and <code>K3s_URL</code> is set, the command will default to the working node.</li>
</ul>
<h3 id="command-parameters">Command parameters</h3>
<p>Throughout the K3s documentation, you will see options that can be passed in as command flags and environment variables, so how do you use flags and environment variables?</p>
<h4 id="using-flags-and-environment-variables">Using flags and environment variables</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 使用标志</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="nv">K3s_KUBECONFIG_MODE</span><span class="o">=</span><span class="s2">&#34;644&#34;</span> sh -s -
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> sh -s - --write-kubeconfig-mode <span class="m">644</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 环境变量</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--flannel-backend none&#34;</span> sh -s -
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -s - server --flannel-backend none
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="k3s-serveragent---common-configuration">K3s Server/Agent - Common Configuration</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># write-kubeconfig</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 将管理客户端的kubeconfig写入这个文件</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_KUBECONFIG_OUTPUT</span><span class="o">=</span>/root/.kube/config <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 使用docker作为容器运行时</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--docker&#34;</span> sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 指定运行时工具</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--container-runtime-endpoint containerd&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置私有镜像仓库配置文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 默认配置文件: /etc/rancher/k3s/registries.yaml</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--private-registry xxx&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 针对多网卡主机安装K3s集群</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 默认多网卡会使用默认网关的那个卡</span>
</span></span><span class="line"><span class="cl">$ rout -n
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># K3s server</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--node-ip=192.168.100.100&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># K3s agent</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_URL</span><span class="o">=</span>https://192.168.99.211:6443 <span class="nv">K3s_TOKEN</span><span class="o">=</span>xxx <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--node-ip=192.168.100.100&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># --tls-san</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在TLS证书中添加其他主机名或IP作为主机备用名称</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 即在公网环境下允许通过公网IP访问控制、操作远程集群</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 或者部署多个Server并使用LB进行负责，就需要保留公网地址</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s2">&#34;--tls-san 1.1.1.1&#34;</span>  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取配置</span>
</span></span><span class="line"><span class="cl">$ kubectl get secret k3s-serving -n kube-system -o yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 然后本机复制公网主节点对应的yaml文件即可本地操作了</span>
</span></span><span class="line"><span class="cl">$ scp ci@1.1.1.1:/etc/rancher/k3s/k3s.yaml ~/.kube/config
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 修改启动的服务对应配置(调整节点的启动的最大Pod数量)</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--kubelet-arg=max-pods=200&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改启动的服务对应配置(使用ipvs作为服务调度工具)</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--kube-proxy-arg=proxy-mode=ipvs&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改启动的服务对应配置(调整服务启动的端口范围)</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--kube-apiserver-arg=service-node-port-range=40000-50000&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># kubelet-arg     --kubelet-arg</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kube-apiserver  --kube-apiserver-arg</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kube-proxy-arg  --kube-proxy-arg</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kube-proxy-arg  --kube-proxy-arg=proxy-mode=ipvs</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># --data-dir</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 修改K3s数据存储目录</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--data-dir=/opt/k3s-data&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 禁用组件</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--disable traefik&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 自己加自己需要的服务</span>
</span></span><span class="line"><span class="cl">$ ls /var/lib/rancher/k3s/server/manifests
</span></span><span class="line"><span class="cl">$ kubectl get pods -A <span class="p">|</span> grep traefik
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 添加label和taint标识</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--node-label foo=bar,hello=world \
</span></span></span><span class="line"><span class="cl"><span class="s1">        --node-taint key1=value1:NoExecute&#39;</span>
</span></span><span class="line"><span class="cl">    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看一下</span>
</span></span><span class="line"><span class="cl">$ kubectl describe nodes
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="k3s-serveragent---database-options">K3s Server/Agent - Database Options</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 指定数据源名称</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 标志位: --datastore-endpoint&amp;nbsp;value</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 环境变量: K3s_DATASTORE_ENDPOINT</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--datastore-endpoint&amp;nbsp;etcd&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># cron规范中的快照间隔时间</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --etcd-snapshot-schedule-cron&amp;nbsp;value</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--etcd-snapshot-schedule-cron *&amp;nbsp;*/5&amp;nbsp;*&amp;nbsp;*&amp;nbsp;*&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="network-options">Network options</h3>
<p>By default, <code>K3s</code> will run with <code>flannel</code> as the <code>CNI</code> and use <code>VXLAN</code> as the default backend, both the <code>CNI</code> and the default backend can be modified via parameters. To enable encryption, use the <code>IPSec</code> or <code>WireGuard</code> options below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 默认安装K3s之后的网络配置</span>
</span></span><span class="line"><span class="cl">$ sudo cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Network&#34;</span>: <span class="s2">&#34;10.42.0.0/16&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;EnableIPv6&#34;</span>: false,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;EnableIPv4&#34;</span>: true,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;IPv6Network&#34;</span>: <span class="s2">&#34;::/0&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Backend&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Type&#34;</span>: <span class="s2">&#34;vxlan&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>CLI Flag and Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ndash;flannel-backend=vxlan</td>
<td>Use VXLAN backend (default)</td>
</tr>
<tr>
<td>&ndash;flannel-backend=host-gw</td>
<td>Use the host-gw backend</td>
</tr>
<tr>
<td>&ndash;flannel-backend=ipsec</td>
<td>Use IPSEC backend; encrypt network traffic</td>
</tr>
<tr>
<td>&ndash;flannel-backend=wireguard</td>
<td>Use WireGuard backend; encrypt network traffic</td>
</tr>
</tbody>
</table>
<h4 id="configuring-flannel-options">Configuring Flannel Options</h4>
<p>This allows me to modify the default backend network configuration options for <code>Flannel</code> (reboots will override this) when I install <code>K3s</code> or modify the corresponding configuration file afterwards. Here we show how to change it to <code>host-gw</code> mode.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 主节点</span>
</span></span><span class="line"><span class="cl"><span class="c1"># flannel-backend使用host-gw</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 该模式会把对端主机的IP当做默认网管(多Server情况)</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--flannel-backend=host-gw&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 工作节点</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_URL</span><span class="o">=</span>https://192.168.100.100:6443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_TOKEN</span><span class="o">=</span>xxx sh -
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 默认的路由信息</span>
</span></span><span class="line"><span class="cl">$ route -n
</span></span><span class="line"><span class="cl">0.0.0.0         172.16.64.1     0.0.0.0         UG    <span class="m">100</span>    <span class="m">0</span>        <span class="m">0</span> enp0s2
</span></span><span class="line"><span class="cl">10.42.1.0       172.16.64.9     255.255.255.0   UG    <span class="m">0</span>      <span class="m">0</span>        <span class="m">0</span> enp0s2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看配置之后的网络配置</span>
</span></span><span class="line"><span class="cl">$ sudo cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Network&#34;</span>: <span class="s2">&#34;10.42.0.0/16&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Backend&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Type&#34;</span>: <span class="s2">&#34;host-gw&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="enabling-directrouting-features">Enabling Directrouting Features</h4>
<p><strong>Flannel&rsquo;s own feature</strong>: Enable <code>direct routes</code> (e.g. <code>host-gw</code>) when hosts are on the same subnet. <code>vxlan</code> is only used to encapsulate packets to hosts on different subnets, <code>host-gw</code> is used between hosts on the same subnet and the default value is <code>false</code>.</p>
<p>To add it, we can&rsquo;t modify the corresponding network configuration file, because a reinstallation or reboot will flush out the configuration (and turn it into the default configuration), so we need to compromise. We create our own network configuration file and then execute the corresponding configuration file to be loaded from at boot time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># k3s的master和agent</span>
</span></span><span class="line"><span class="cl">$ sudo cat /etc/flannel/net-conf.json
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Network&#34;</span>: <span class="s2">&#34;10.42.0.0/16&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Backend&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Type&#34;</span>: <span class="s2">&#34;vxlan&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Directrouting&#34;</span>: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># k3s master</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--flannel-backend=host-gw&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="customizing-cni">Customizing CNI</h4>
<p>Run <code>K3s</code> with <code>--flannel-backend=none</code> (disabled) and then install the <code>CNI</code> of your choice. Follow the Calico CNI Plugin <a href="https://docs.projectcalico.org/master/reference/cni-plugin/configuration">Guide</a> to modify the <code>YAML</code> configuration file for <code>Calico</code> to allow <code>IP</code> forwarding in the <code>container_settings</code> section.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 加到Calico的YAML文件中</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 允许IP转发(这个是K3s的一个限制；需要开启)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;container_settings&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;allow_ip_forwarding&#34;</span>: <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- name: CALICO_IPV4POOL_CIDR
</span></span><span class="line"><span class="cl">  value: <span class="s2">&#34;192.168.200.0/24&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 通过在主机上运行以下命令，确保设置已被应用(true)</span>
</span></span><span class="line"><span class="cl">$ sudo cat /etc/cni/net.d/10-canal.conflist
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># calico</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 其中--cluster-cidr可不设置</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--flannel-backend=none \
</span></span></span><span class="line"><span class="cl"><span class="s1">        --cluster-cidr=192.168.200.0/24&#34;&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动网络服务</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f ./calico.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="external-database">External database</h3>
<h4 id="highly-available-installations-using-external-databases">Highly available installations using external databases</h4>
<ul>
<li>Two or more <code>server</code> nodes</li>
<li>Zero or more <code>agent</code> nodes</li>
<li>External data store ( <code>Etcd/MySQL/PostgRES</code> )</li>
<li>Fixed registered address ( <code>LB</code> )</li>
</ul>
<p>While a single node <code>k3s server</code> cluster can satisfy various use cases, for critical environments that need stable operation to run <code>K3s</code> in an <code>HA</code> configuration, how can I install a highly available <code>K3s</code> cluster using an external database?</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/25/d69376be8fd443d8a60d78f1239c847f.png" alt="k3s server"></p>
<p>K3s Installation Matters - External Database:</p>
<table>
<thead>
<tr>
<th>host name</th>
<th>role</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>k3s-server-1</td>
<td>k3s master</td>
<td>172.31.2.134</td>
</tr>
<tr>
<td>k3s-server-2</td>
<td>k3s master</td>
<td>172.31.2.42</td>
</tr>
<tr>
<td>k3s-db</td>
<td>DB</td>
<td>172.31.10.251</td>
</tr>
<tr>
<td>k3s-lb</td>
<td>LB</td>
<td>172.31.13.97</td>
</tr>
<tr>
<td>k3s-agent</td>
<td>k3s agent</td>
<td>172.31.15.130</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 1.创建一个外部数据存储</span>
</span></span><span class="line"><span class="cl">$ docker run --name some-mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --restart<span class="o">=</span>unless-stopped -p 3306:3306 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>password -d mysql:5.7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2.启动k3s-server节点(有读写权限不用加库名)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mysql://username:password@tcp(hostname:3306)/database-name</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可加污点 --node-taint CriticalAddonsOnly=true:NoExecute</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn sh - server <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --datastore-endpoint<span class="o">=</span><span class="s2">&#34;mysql://root:password@ip:3306/k3s&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --tls-san 172.31.13.97
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 3.配置固定的注册地址(k3s-lb节点)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Agent节点需要一个URL来注册(LB)</span>
</span></span><span class="line"><span class="cl">$ cat &gt;&gt; /etc/nginx.conf <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">worker_processes 4;
</span></span></span><span class="line"><span class="cl"><span class="s">worker_rlimit_nofile 40000;
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">events {
</span></span></span><span class="line"><span class="cl"><span class="s">    worker_connections 8192;
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">stream {
</span></span></span><span class="line"><span class="cl"><span class="s">    upstream k3s_api {
</span></span></span><span class="line"><span class="cl"><span class="s">        least_conn;
</span></span></span><span class="line"><span class="cl"><span class="s">        server 172.31.2.134:6443 max_fails=3 fail_timeout=5s;
</span></span></span><span class="line"><span class="cl"><span class="s">        server 172.31.2.42:6443 max_fails=3 fail_timeout=5s;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">    server {
</span></span></span><span class="line"><span class="cl"><span class="s">        listen     6443;
</span></span></span><span class="line"><span class="cl"><span class="s">        proxy_pass k3s_api;
</span></span></span><span class="line"><span class="cl"><span class="s">    }
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动服务</span>
</span></span><span class="line"><span class="cl">$ docker run -d --restart<span class="o">=</span>unless-stopped <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -p 6443:6443 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -v /etc/nginx.conf:/etc/nginx/nginx.conf <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  nginx:1.14
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 4.加入Agent节点</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Agent会保存LB节点和每个Server节点的IP信息</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cat /var/lib/rancher/k3s/agent/etc/k3s-agent-load-balancer.json</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn
</span></span><span class="line"><span class="cl">    <span class="nv">K3s_URL</span><span class="o">=</span>https://172.31.13.97:6443 <span class="nv">K3s_TOKEN</span><span class="o">=</span>mynodetoken <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 5.通过kubeconfig访问K3s集群</span>
</span></span><span class="line"><span class="cl">$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME           STATUS   ROLES                  AGE   VERSION
</span></span><span class="line"><span class="cl">k3s-server-1   Ready    control-plane,master   68s   v1.20.7+k3s1
</span></span><span class="line"><span class="cl">k3s-server-2   Ready    control-plane,master   66s   v1.20.7+k3s1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="high-availability-for-embedded-db">High Availability for Embedded DB</h4>
<p>To run <code>K3s</code> in this mode, you must have an odd number of server nodes, it is recommended to start with three nodes. In embedded, the default is to use <code>Etcd</code> as the highly available database.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 服务器节点(启动etcd集群)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># SECRET我们预定一个key值</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用cluster-init标志来启用集群</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 并使用一个标记作为共享的密钥来加入其他服务器到集群中</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_TOKEN</span><span class="o">=</span>SECRET <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -s - --cluster-init
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看类型</span>
</span></span><span class="line"><span class="cl">$ sudo  kubectl get nodes
</span></span><span class="line"><span class="cl">NAME    STATUS  ROLES                      AGE  VERSION
</span></span><span class="line"><span class="cl">ip-xxx  Ready   control-plane,etcd,master  19h  v1.23.6+k3s1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 其他服务器节点(2/3)</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="nv">K3s_TOKEN</span><span class="o">=</span>SECRET <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -s - --server https://&lt;ip-or-host-server&gt;:6443
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查询ETCD集群状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># etcd证书默认目录：/var/lib/rancher/k3s/server/tls/etcd</span>
</span></span><span class="line"><span class="cl"><span class="c1"># etcd数据默认目录：/var/lib/rancher/k3s/server/db/etcd</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">ETCDCTL_ENDPOINTS</span><span class="o">=</span><span class="s1">&#39;https://172.31.12.136:2379,\
</span></span></span><span class="line"><span class="cl"><span class="s1">    https://172.31.4.43:2379,\
</span></span></span><span class="line"><span class="cl"><span class="s1">    https://172.31.4.190:2379&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="nv">ETCDCTL_CACERT</span><span class="o">=</span><span class="s1">&#39;/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="nv">ETCDCTL_CERT</span><span class="o">=</span><span class="s1">&#39;/var/lib/rancher/k3s/server/tls/etcd/server-client.crt&#39;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="nv">ETCDCTL_KEY</span><span class="o">=</span><span class="s1">&#39;/var/lib/rancher/k3s/server/tls/etcd/server-client.key&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span> etcdctl endpoint status --write-out<span class="o">=</span>table
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="clustered-datastore-options">Clustered Datastore Options</h4>
<p>The ability to run <code>K8S</code> with a datastore other than <code>etcd</code> distinguishes <code>K3s</code> from other <code>K8S</code> distributions. This feature provides flexibility for <code>K8S</code> operators, and the available datastore options allow you to select a datastore that best fits the use case.</p>
<p>If your team does not have the expertise to operate <code>etcd</code>, you can choose an enterprise <code>SQL</code> database such as <code>MySQL</code> or <code>PostgreSQL</code>. If you need to run a simple, short-lived cluster in a <code>CI/CD</code> environment, you can use an embedded <code>SQLite</code> database.</p>
<p>If you want to use an external datastore such as <code>PostgreSQL</code>, <code>MySQL</code> or <code>etcd</code>, you must set the <code>datastore-endpoint</code> parameter so that <code>K3s</code> knows how to connect to it, and you can also specify parameters to configure authentication and encryption for the connection. The following table summarizes these parameters, which can be passed as <code>CLI</code> flags or environment variables.</p>
<table>
<thead>
<tr>
<th>CLI Flag</th>
<th>Environment Variables</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ndash;datastore-endpoint</td>
<td>K3s_DATASTORE_ENDPOINT</td>
<td>Specifies a PostgresSQL, MySQL, or etcd connection string. This is used to describe the connection to the datastore. The structure of this string is specific to each backend, as detailed below.</td>
</tr>
<tr>
<td>&ndash;datastore-cafile</td>
<td>K3s_DATASTORE_CAFILE</td>
<td>A TLS Certificate Authority (CA) file to help secure communication with the datastore. If your datastore requests through the TLS service using a certificate signed by a custom Certificate Authority, you can use this parameter to specify that CA so that the K3s client can properly validate the certificate.</td>
</tr>
<tr>
<td>&ndash;datastore-certfile</td>
<td>K3s_DATASTORE_CERTFILE</td>
<td>TLS certificate file for client certificate based authentication of the datastore. To use this feature, your datastore must be configured to support client certificate based authentication. If you specify this parameter, you must also specify the datastore-keyfile parameter.</td>
</tr>
<tr>
<td>&ndash;datastore-keyfile</td>
<td>K3s_DATASTORE_KEYFILE</td>
<td>TLS key file for client certificate based authentication of the datastore. See the datastore-certfile parameter earlier for more details.</td>
</tr>
</tbody>
</table>
<p>As a best practice, we recommend setting these parameters as environment variables rather than command line parameters, so that your database credentials or other sensitive information is not exposed as part of the process information.</p>
<h3 id="private-image-repository">Private image repository</h3>
<p><code>K3s</code> uses <code>containerd</code> as the container runtime by default, so configuring the image repository on <code>docker</code> does not take effect. The <code>K3s</code> image repository configuration file consists of two main parts: <code>mirrors</code> and <code>configs</code>.</p>
<ul>
<li><code>Mirrors</code> is a directive that defines the name and <code>endpoint</code> of a dedicated mirror repository</li>
<li>The <code>Configs</code> section defines the <code>TLS</code> and certificate configuration for each <code>mirror</code>.</li>
<li>For each <code>mirror</code>, you can define <code>auth</code> and <code>/</code> or <code>tls</code></li>
</ul>
<p>The <code>K3s registry</code> configuration directory is: <code>/etc/rancher/k3s/registries.yaml</code>. When <code>K3s</code> starts, it will check if the <code>registries.yaml</code> file exists in <code>/etc/rancher/k3s/</code> and instruct <code>containerd</code> to use the mirror repository defined in the file. If you want to use a private mirror repository, then you need to create this file as <code>root</code> on each node that uses the mirror repository.</p>
<p>Note that <code>server</code> nodes are schedulable by default. If you do not have taint on the <code>server</code> nodes, then the workload will be run on them, make sure to create <code>registries.yaml</code> files on each <code>server</code> node.</p>
<p><code>containerd</code> uses a concept similar to <code>svc</code> and <code>endpoint</code> in <code>K8S</code>. <code>svc</code> can be understood as the access name, which resolves to the corresponding <code>endpoint</code>. It can also be understood that the <code>mirror</code> configuration is a reverse proxy that proxies client requests to the <code>endpoint</code> configuration&rsquo;s back-end mirror repository. The <code>mirror</code> name is optional, but it must match the <code>IP</code> or domain name definition rules. And you can configure multiple <code>endpoints</code>, which resolve to the first <code>endpoint</code> by default, and if the first <code>endpoint</code> does not return data, it automatically switches to the second <code>endpoint</code>, and so on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># /etc/rancher/k3s/registries.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 同时可以设置多个mirrors地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 可以对mirrors设置权限和证书</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mirrors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;172.31.6.200:5000&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;http://172.31.6.200:5000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;http://x.x.x.x:5000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;http://y.y.y.y:5000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;rancher.ksd.top:5000&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;http://172.31.6.200:5000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;docker.io&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;https://fogjl973.mirror.aliyuncs.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;https://registry-1.docker.io&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;172.31.6.200:5000&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">Harbor@12345</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cert_file</span><span class="p">:</span><span class="w"> </span><span class="l">/home/ubuntu/harbor2.escapelife.site.cert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">key_file</span><span class="p">:</span><span class="w"> </span><span class="l">/home/ubuntu/harbor2.escapelife.site.key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ca_file</span><span class="p">:</span><span class="w"> </span><span class="l">/home/ubuntu/ca.crt</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 镜像都是从同一个仓库获取到的</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ sudo systemctl restart k3s.service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ sudo crictl pull 172.31.6.200:5000/library/alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ sudo crictl pull rancher.ksd.top:5000/library/alpine</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Here we describe how to use the <code>TLS</code> configuration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 证书颁发机构颁发的证书</span>
</span></span><span class="line"><span class="cl">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">mirrors:
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;harbor.escapelife.site&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s">    endpoint:
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#34;https://harbor.escapelife.site&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">configs:
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;harbor.escapelife.site&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s">    auth:
</span></span></span><span class="line"><span class="cl"><span class="s">      username: admin
</span></span></span><span class="line"><span class="cl"><span class="s">      password: Harbor@12345
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ sudo systemctl restart k3s
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 自签名证书</span>
</span></span><span class="line"><span class="cl">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">mirrors:
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;harbor2.escapelife.site&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s">    endpoint:
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#34;https://harbor2.escapelife.site&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">configs:
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;harbor2.escapelife.site&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s">    auth:
</span></span></span><span class="line"><span class="cl"><span class="s">      username: admin
</span></span></span><span class="line"><span class="cl"><span class="s">      password: Harbor@12345
</span></span></span><span class="line"><span class="cl"><span class="s">    tls:
</span></span></span><span class="line"><span class="cl"><span class="s">      cert_file: /home/ubuntu/harbor2.escapelife.site.cert
</span></span></span><span class="line"><span class="cl"><span class="s">      key_file:  /home/ubuntu/harbor2.escapelife.site.key
</span></span></span><span class="line"><span class="cl"><span class="s">      ca_file:   /home/ubuntu/ca.crt
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ sudo systemctl restart k3s
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 不使用TLS证书</span>
</span></span><span class="line"><span class="cl">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">mirrors:
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;docker.io&#34;:
</span></span></span><span class="line"><span class="cl"><span class="s">    endpoint:
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#34;https://fogjl973.mirror.aliyuncs.com&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">      - &#34;https://registry-1.docker.io&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ sudo systemctl restart k3s
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>K3s</code> will generate <code>config.toml</code> for <code>containerd</code> in <code>/var/lib/rancher/k3s/agent/etc/containerd/config.toml</code>. For advanced settings of this file, you can create another file named <code>config.toml.tmpl</code> in the same directory and this file will replace the default settings.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 完整示例</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ cat &gt;&gt; /etc/rancher/k3s/registries.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mirrors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;harbor.escapelife.site&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;https://harbor.escapelife.site&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;harbor2.escapelife.site&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;https://harbor2.escapelife.site&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;172.31.19.227:5000&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;http://172.31.19.227:5000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;docker.io&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;https://fogjl973.mirror.aliyuncs.com&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="s2">&#34;https://registry-1.docker.io&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;harbor.escapelife.site&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">Harbor@12345</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;harbor2.escapelife.site&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">Harbor@12345</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">cert_file</span><span class="p">:</span><span class="w"> </span><span class="l">/home/ubuntu/harbor2.escapelife.site.cert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">key_file</span><span class="p">:</span><span class="w">  </span><span class="l">/home/ubuntu/harbor2.escapelife.site.key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">ca_file</span><span class="p">:</span><span class="w">   </span><span class="l">/home/ubuntu/ca.crt</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="off-line-installation">Off-line installation</h3>
<p>The offline installation process is divided into the following two main steps.</p>
<ul>
<li>
<p>Step 1: Deploy the image</p>
<ul>
<li>Deploying a private mirror repository</li>
<li>Manually deploy the image</li>
</ul>
</li>
<li>
<p>Step 2: Install K3s tools</p>
<ul>
<li>Single-node installation</li>
</ul>
</li>
<li>
<p>Highly available installation</p>
</li>
</ul>
<h4 id="install-k3s-from-a-private-image-repository">Install K3s from a private image repository</h4>
<ul>
<li><code>k3s-images.txt</code> contains the image files for the corresponding version dependencies.</li>
<li><code>k3s-airgap-images-amd64.tar</code> contains the image file for the corresponding version.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 将所需镜像上传到私有镜像仓库</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># https://github.com/k3s-io/k3s/releases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">可以从K3s镜像列表获取到版本，下载上传到私有镜像仓库</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 创建镜像仓库(YAML)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 按照私有镜像仓库配置指南创建并配置registry.yaml文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ mkdir -p /etc/rancher/k3s/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">cat &gt;&gt; /etc/rancher/k3s/registries.yaml &lt;&lt;EOF</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mirrors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;docker.io&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">endpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;https://harbor.escapelife.site&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s2">&#34;docker.io&#34;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">Harbor@12345</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">EOF</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 安装单节点K3s集群</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># https://github.com/k3s-io/k3s/releases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">可以从K3s仓库获取到版本(二进制文件)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 获取K3s安装脚本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ wget https://get.k3s.io -o ./install.sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ wget http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 安装K3s-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ INSTALL_K3s_SKIP_DOWNLOAD=true ./install.sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 将agent加入到K3s集群</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ INSTALL_K3s_SKIP_DOWNLOAD=true \</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">K3s_URL=https://myserver:6443 K3s_TOKEN=mynodetoken \</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">./install.sh</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="install-k3s-via-manual-deployment-image">Install K3s via manual deployment image</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 从Github页面获取你所运行的K3s版本及文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/rancher/k3s/releases</span>
</span></span><span class="line"><span class="cl">k3s二进制文件+镜像tar文件
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将tar文件放在images目录下</span>
</span></span><span class="line"><span class="cl">$ sudo mkdir -p /var/lib/rancher/k3s/agent/images/
</span></span><span class="line"><span class="cl">$ sudo cp ./k3s-airgap-images-<span class="nv">$ARCH</span>.tar /var/lib/rancher/k3s/agent/images/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将k3s二进制文件放在/usr/local/bin/k3s路径上</span>
</span></span><span class="line"><span class="cl">$ mv ./k3s /usr/local/bin/
</span></span><span class="line"><span class="cl">$ chmod <span class="m">755</span> /usr/local/bin/k3s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装K3s-server</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">INSTALL_K3s_SKIP_DOWNLOAD</span><span class="o">=</span><span class="nb">true</span> ./install.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将agent加入到K3s集群</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">INSTALL_K3s_SKIP_DOWNLOAD</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">K3s_URL</span><span class="o">=</span>https://myserver:6443 <span class="nv">K3s_TOKEN</span><span class="o">=</span>mynodetoken <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./install.sh
</span></span></code></pre></td></tr></table>
</div>
</div><p>Upgrade the <code>K3s</code> version offline. After completing the offline installation of <code>K3s</code>, you can also upgrade the <code>K3s</code> version through a script or enable the automatic upgrade feature to keep the <code>K3s</code> version in the offline environment in sync with the latest <code>K3s</code> version.</p>
<h4 id="upgrade-k3s-version">Upgrade K3s version</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 通过脚本升级</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># https://github.com/rancher/k3s/releases</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">从Github页面下载要升级到的K3s版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 替换</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 复制并替换每个节点上/usr/local/bin中的旧K3s二进制文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ mv ./k3s /usr/local/bin/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ chmod 755 /usr/local/bin/k3s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ wget http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 重启K3s服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ sudo systemctl restart k3s.service</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dashboard-and-uninstallation">Dashboard and uninstallation</h3>
<p>Three dashboard tools are recommended, corresponding to <code>Kubernetes Dashboard</code>, <code>kube-explorer</code> and <code>Rancher UI</code>, each with its own advantages and disadvantages.</p>
<h4 id="kubernetes-dashboard">Kubernetes Dashboard</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 部署Kubernetes仪表盘</span>
</span></span><span class="line"><span class="cl">$ <span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/kubernetes/dashboard/releases
</span></span><span class="line"><span class="cl">$ <span class="nv">VERSION_KUBE_DASHBOARD</span><span class="o">=</span><span class="k">$(</span>curl -w <span class="s1">&#39;%{url_effective}&#39;</span> -I -L -s -S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="si">${</span><span class="nv">GITHUB_URL</span><span class="si">}</span>/latest -o /dev/null <span class="p">|</span> sed -e <span class="s1">&#39;s|.*/||&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/<span class="si">${</span><span class="nv">VERSION_KUBE_DASHBOARD</span><span class="si">}</span>/aio/deploy/recommended.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 仪表盘RBAC配置</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 本指南中创建的admin-user将在仪表盘中拥有管理权限</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl create <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -f dashboard.admin-user.yml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -f dashboard.admin-user-role.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dashboard.admin-user.yml</span>
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ServiceAccount
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: admin-user
</span></span><span class="line"><span class="cl">  namespace: kubernetes-dashboard
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dashboard.admin-user-role.yml</span>
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: ClusterRoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: admin-user
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: ClusterRole
</span></span><span class="line"><span class="cl">  name: cluster-admin
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">  - kind: ServiceAccount
</span></span><span class="line"><span class="cl">    name: admin-user
</span></span><span class="line"><span class="cl">    namespace: kubernetes-dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 获得Bearer-Token</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl -n kubernetes-dashboard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    describe secret admin-user-token <span class="p">|</span> grep <span class="s1">&#39;^token&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 本地访问仪表盘</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://192.168.100.100:8443</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://www.escapelife.site/posts/180e93f1.html</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://www.escapelife.site/posts/538ec6b1.html</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl proxy
</span></span><span class="line"><span class="cl">$ sudo kubectl -n kubernetes-dashboard port-forward <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --address 0.0.0.0 svc/kubernets-dashboard 8443:443
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 升级仪表盘</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl delete ns kubernetes-dashboard
</span></span><span class="line"><span class="cl">$ <span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/kubernetes/dashboard/releases
</span></span><span class="line"><span class="cl">$ <span class="nv">VERSION_KUBE_DASHBOARD</span><span class="o">=</span><span class="k">$(</span>curl -w <span class="s1">&#39;%{url_effective}&#39;</span> -I -L -s -S <span class="si">${</span><span class="nv">GITHUB_URL</span><span class="si">}</span>/latest -o /dev/null <span class="p">|</span> sed -e <span class="s1">&#39;s|.*/||&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/<span class="si">${</span><span class="nv">VERSION_KUBE_DASHBOARD</span><span class="si">}</span>/aio/deploy/recommended.yaml -f dashboard.admin-user.yml -f dashboard.admin-user-role.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ## 删除仪表盘和admin-user配置</span>
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl delete ns kubernetes-dashboard
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl delete clusterrolebinding kubernetes-dashboard
</span></span><span class="line"><span class="cl">$ sudo k3s kubectl delete clusterrole kubernetes-dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kube-explorer">kube-explorer</h4>
<ul>
<li><code>kube-explorer</code> is a portable resource manager for <code>K8S</code> without any dependencies.</li>
<li>and provides an almost completely stateless <code>K8S</code> resource manager.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 从发布页面下载二进制文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/cnrancher/kube-explorer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 运行</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --kubeconfig 可以不配置(自己可以找到)</span>
</span></span><span class="line"><span class="cl">$ ./kube-explorer --kubeconfig<span class="o">=</span>/etc/rancher/k3s/kube.yaml <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --http-listen-port<span class="o">=</span><span class="m">9898</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --https-listen-port<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 打开浏览器访问</span>
</span></span><span class="line"><span class="cl">http://192.168.100.100:9898
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="rancher-ui">Rancher UI</h4>
<ul>
<li>You can import <code>K3s</code> into <code>Rancher UI</code> to manage</li>
<li>Official website Importing K3s <a href="http://docs.rancher.cn/docs/rancher2/cluster-provisioning/imported-clusters/_index/#%E5%AF%BC%E5%85%A5-k3s-%E9%9B%86%E7%BE%A4">clusters</a> guidance document</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 导入K3s集群时，Rancher会将其识别为K3s类型，并且附件额外功能</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1.能够升级K3s版本</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2.可配置升级集群时升级的最大节点数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3.在主机详情页能够查看启动K3s集群时每个节点的配置参数和环境变量</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置K3s集群以允许导入到Rancher</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn sh -s - <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --write-kubeconfig-mode <span class="m">644</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="uninstall-the-k3s-service">Uninstall the K3s service</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 主节点</span>
</span></span><span class="line"><span class="cl">$ /usr/local/bin/k3s-uninstall.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 工作节点</span>
</span></span><span class="line"><span class="cl">$ /usr/local/bin/k3s-agent-uninstall.sh
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 包括docker等信息一并清理</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#!/bin/bash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">KUBE_SVC</span><span class="o">=</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">kubelet
</span></span></span><span class="line"><span class="cl"><span class="s1">kube-scheduler
</span></span></span><span class="line"><span class="cl"><span class="s1">kube-proxy
</span></span></span><span class="line"><span class="cl"><span class="s1">kube-controller-manager
</span></span></span><span class="line"><span class="cl"><span class="s1">kube-apiserver
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> kube_svc in <span class="si">${</span><span class="nv">KUBE_SVC</span><span class="si">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 停止服务</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>systemctl is-active <span class="si">${</span><span class="nv">kube_svc</span><span class="si">}</span><span class="sb">`</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    systemctl stop <span class="si">${</span><span class="nv">kube_svc</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 禁止服务开机启动</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> <span class="sb">`</span>systemctl is-enabled <span class="si">${</span><span class="nv">kube_svc</span><span class="si">}</span><span class="sb">`</span> <span class="o">==</span> <span class="s1">&#39;enabled&#39;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    systemctl disable <span class="si">${</span><span class="nv">kube_svc</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 停止所有容器</span>
</span></span><span class="line"><span class="cl">docker stop <span class="k">$(</span>docker ps -aq<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除所有容器</span>
</span></span><span class="line"><span class="cl">docker rm -f <span class="k">$(</span>docker ps -qa<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除所有容器卷</span>
</span></span><span class="line"><span class="cl">docker volume rm <span class="k">$(</span>docker volume ls -q<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 卸载mount目录</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> mount in <span class="k">$(</span>mount <span class="p">|</span> grep tmpfs <span class="p">|</span> grep <span class="s1">&#39;/var/lib/kubelet&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $3 }&#39;</span><span class="k">)</span> /var/lib/kubelet /var/lib/rancher<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">  umount <span class="nv">$mount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 备份目录</span>
</span></span><span class="line"><span class="cl">mv /etc/kubernetes /etc/kubernetes-bak-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">mv /var/lib/etcd /var/lib/etcd-bak-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">mv /var/lib/rancher /var/lib/rancher-bak-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">mv /opt/rke /opt/rke-bak-<span class="k">$(</span>date +<span class="s2">&#34;%Y%m%d%H%M&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除残留路径</span>
</span></span><span class="line"><span class="cl">rm -rf /etc/ceph <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /etc/cni <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /opt/cni <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /run/secrets/kubernetes.io <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /run/calico <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /run/flannel <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/lib/calico <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/lib/cni <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/lib/kubelet <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/log/containers <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/log/kube-audit <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/log/pods <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /var/run/calico <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    /usr/libexec/kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 清理网络接口</span>
</span></span><span class="line"><span class="cl"><span class="nv">no_del_net_inter</span><span class="o">=</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">lo
</span></span></span><span class="line"><span class="cl"><span class="s1">docker0
</span></span></span><span class="line"><span class="cl"><span class="s1">eth
</span></span></span><span class="line"><span class="cl"><span class="s1">ens
</span></span></span><span class="line"><span class="cl"><span class="s1">bond
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">network_interface</span><span class="o">=</span><span class="sb">`</span>ls /sys/class/net<span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> net_inter in <span class="nv">$network_interface</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> ! <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">no_del_net_inter</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> grep -qE <span class="si">${</span><span class="nv">net_inter</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">3</span><span class="si">}</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    ip link delete <span class="nv">$net_inter</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 清理残留进程</span>
</span></span><span class="line"><span class="cl"><span class="nv">port_list</span><span class="o">=</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">80
</span></span></span><span class="line"><span class="cl"><span class="s1">443
</span></span></span><span class="line"><span class="cl"><span class="s1">6443
</span></span></span><span class="line"><span class="cl"><span class="s1">2376
</span></span></span><span class="line"><span class="cl"><span class="s1">2379
</span></span></span><span class="line"><span class="cl"><span class="s1">2380
</span></span></span><span class="line"><span class="cl"><span class="s1">8472
</span></span></span><span class="line"><span class="cl"><span class="s1">9099
</span></span></span><span class="line"><span class="cl"><span class="s1">10250
</span></span></span><span class="line"><span class="cl"><span class="s1">10254
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> port in <span class="nv">$port_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="nv">pid</span><span class="o">=</span><span class="sb">`</span>netstat -atlnup <span class="p">|</span> grep <span class="nv">$port</span> <span class="p">|</span> awk <span class="s1">&#39;{print $7}&#39;</span> <span class="p">|</span> awk -F <span class="s1">&#39;/&#39;</span> <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> grep -v - <span class="p">|</span> sort -rnk2 <span class="p">|</span> uniq<span class="sb">`</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[[</span> -n <span class="nv">$pid</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">kill</span> -9 <span class="nv">$pid</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">kube_pid</span><span class="o">=</span><span class="sb">`</span>ps -ef <span class="p">|</span> grep -v grep <span class="p">|</span> grep kube <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> -n <span class="nv">$kube_pid</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">kill</span> -9 <span class="nv">$kube_pid</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 清理Iptables表</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 注意：如果节点Iptables有特殊配置，以下命令请谨慎操作</span>
</span></span><span class="line"><span class="cl">sudo iptables --flush
</span></span><span class="line"><span class="cl">sudo iptables --flush --table nat
</span></span><span class="line"><span class="cl">sudo iptables --flush --table filter
</span></span><span class="line"><span class="cl">sudo iptables --table nat --delete-chain
</span></span><span class="line"><span class="cl">sudo iptables --table filter --delete-chain
</span></span><span class="line"><span class="cl">systemctl restart docker
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="notes">Notes</h3>
<ul>
<li>
<p><strong>Helm</strong></p>
<ul>
<li>If you need to use <code>helm</code> to operate the <code>K3s</code> cluster, you need to create the <code>~/.kube/conf</code> directory.</li>
<li>The command <code>cp /etc/rancher/k3s/k3s.yaml ~/.kube/config</code> needs to be executed.</li>
</ul>
</li>
<li>
<p><strong>Manifest for automatic deployment</strong></p>
<ul>
<li>Will be installed by <code>rancher/helm-controller</code> at runtime.</li>
<li>Directory path: <code>/var/lib/rancher/k3s/server/manifests</code>.</li>
<li>Each <code>yaml</code> under the directory represents a service that needs to be started.</li>
</ul>
</li>
</ul>
<p>For the components we want to use, we can disable the default components at startup and deploy the components you need manually (usually under a specified directory that is automatically pulled up as the service starts) for flexibility.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看所有Pod服务</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 比如helm/coredns也不是自带的就是通过这个方式创建的</span>
</span></span><span class="line"><span class="cl">$ sudo kubectl get pods -A
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="register-agent-node">Register Agent node</h4>
<ul>
<li>Working node password storage: <code>/etc/rancher/node/password</code>.</li>
<li>Password storage for master node: <code>/var/lib/rancher/k3s/server/cred/node-passwd</code>.</li>
</ul>
<p>Running the registration command at the <code>agent</code> node will initiate a <code>websocket</code> connection with the <code>server</code> node, which will then create a random password on top of the worker node. Then it will take this password and the hostname of the worker node and send it to the master node. The master node then saves this information ( <code>k8s secrets</code>) and any subsequent attempts must use the same password.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 工作节点的密码信息(password+hostname)</span>
</span></span><span class="line"><span class="cl">$ sudo cat /etc/rancher/node/password
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看主节点的密码信息</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://docs.rancher.cn/docs/k3s/architecture/_index#注册-agent-节点</span>
</span></span><span class="line"><span class="cl">$ sudo kubectl get secret k3s2.node-password.k3s -o yaml -n kube-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以查看日志信息验证这个信息的存在</span>
</span></span><span class="line"><span class="cl">$ sudo tail -200f /var/log/syslog <span class="p">|</span> grep k3s
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 发现节点信息提示NotReady状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以尝试删除节点的密码存储信息，之后会自动获取新的</span>
</span></span><span class="line"><span class="cl">$ sudo kubectl delete secret k3s2.node-password.k3s -n kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="custom-storage-types">Custom Storage Types</h4>
<p>After the cluster starts, a <code>local-path</code> component is started by default to provide service mount storage in the form of <code>PVC</code> by default. Afterwards, it is stored under the <code>/var/lib/rancher/k3s/server/storageclass</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看组件</span>
</span></span><span class="line"><span class="cl">$ sudo kubectl get pods -A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看对应存储</span>
</span></span><span class="line"><span class="cl">$ sudo kubectl get storageclass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 可以使用参数修改默认存储地址</span>
</span></span><span class="line"><span class="cl"><span class="c1"># --default-local-storage-path&amp;nbsp;value</span>
</span></span><span class="line"><span class="cl">$ curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_MIRROR</span><span class="o">=</span>cn <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">INSTALL_K3s_EXEC</span><span class="o">=</span><span class="s1">&#39;--etcd-snapshot-schedule-cron *&amp;nbsp;*/5&amp;nbsp;*&amp;nbsp;*&amp;nbsp;*&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sh -
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-k3s-cluster-upgrade">4. K3s Cluster Upgrade</h2>
<p>When upgrading <code>K3s</code>, the <code>K3s</code> service will restart or stop, but the <code>K3s</code> containers will continue to run. To stop all <code>K3s</code> containers and reset their state, you can use the <code>k3s-killall.sh</code> script. The <code>killall</code> script cleans up the containers, the <code>K3s</code> directory, and the network components, and also removes the <code>iptables</code> chain and all associated rules. Cluster data is not deleted.</p>
<h3 id="manual-upgrade---upgrade-k3s-using-the-install-script">Manual upgrade - Upgrade K3s using the install script</h3>
<p>You can upgrade <code>K3s</code> by using the install script, or manually install the binaries for the desired version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 升级到最新stable版本</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 升级到latest版本</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="nv">INSTALL_K3s_CHANNEL</span><span class="o">=</span>latest sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 升级到v1.20的最新版本</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="nv">INSTALL_K3s_CHANNEL</span><span class="o">=</span><span class="s2">&#34;v1.20&#34;</span> sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 升级到指定版本</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="nv">INSTALL_K3s_VERSION</span><span class="o">=</span>vX.Y.Z-rc1 sh -
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="manual-upgrade---upgrade-k3s-manually-using-binaries">Manual upgrade - Upgrade K3s manually using binaries</h3>
<p>You can upgrade <code>K3s</code> by using the install script, or manually install the binaries for the desired version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 从发布下载所需版本的K3s二进制文件</span>
</span></span><span class="line"><span class="cl">https://github.com/rancher/k3s/releases
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将下载的二进制文件复制到/usr/local/bin/k3s</span>
</span></span><span class="line"><span class="cl">$ mv ./k3s /usr/local/bin/k3s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 停止旧的K3s二进制文件</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="nv">INSTALL_K3s_CHANNEL</span><span class="o">=</span><span class="s2">&#34;v1.20&#34;</span> sh -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 启动新的K3s二进制文件</span>
</span></span><span class="line"><span class="cl">$ curl -sfL https://get.k3s.io <span class="p">|</span> <span class="nv">INSTALL_K3s_VERSION</span><span class="o">=</span>vX.Y.Z-rc1 sh -
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can use <code>Rancher</code>&rsquo;s <code>system-upgrade-controller</code> to manage <code>K3s</code> cluster upgrades. This is a <code>Kubernetes</code> native approach to cluster upgrades. It uses custom resource definitions ( <code>CRD</code>), schedules, and controllers to schedule upgrades based on configured schedules.</p>
<p>The controller schedules upgrades by monitoring the plan and selecting the nodes on which to run upgrade <code>jobs</code>, and the plan defines which nodes should be upgraded via a tag selector. When a <code>job</code> completes successfully, the controller tags the node it is running on accordingly.</p>
<h3 id="automatic-upgrade---manually-upgrade-k3s-using-binary-files">Automatic upgrade - manually upgrade K3s using binary files</h3>
<ul>
<li><a href="https://github.com/rancher/k3s-upgrade">k3s-upgrade</a></li>
<li><a href="https://github.com/rancher/system-upgrade-controller">system-upgrade-controller</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 将system-upgrade-controller安装到您的集群中</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f https://github.com/rancher/system-upgrade-controller/releases/download/v0.6.2/system-upgrade-controller.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 配置计划</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 建议您最少创建两个计划</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 升级server节点的计划和升级agent节点的计划</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Server plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">upgrade.cattle.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">server-plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">system-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">concurrency</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cordon</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w"> </span><span class="c"># 选择主节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">system-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">upgrade</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">rancher/k3s-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.20.4+k3s1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Agent plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">upgrade.cattle.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">agent-plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">system-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">concurrency</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cordon</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w"> </span><span class="c"># 选择工作节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">DoesNotExist</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">prepare</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">prepare</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">server-plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">rancher/k3s-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">system-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">upgrade</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">rancher/k3s-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1.20.4+k3s1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 自动升级到最新版本(不指定版本)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">upgrade.cattle.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Plan</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">upgrade</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">rancher/k3s-upgrade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">channel</span><span class="p">:</span><span class="w"> </span><span class="l">https://update.k3s.io/v1-release/channels/stable</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-k3s-backup-recovery">5. K3s Backup Recovery</h2>
<h3 id="backup-and-restore-with-embedded-sqlite-datastore">Backup and restore with embedded SQLite datastore</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 方式1：备份/恢复数据目录</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 备份</span>
</span></span><span class="line"><span class="cl">$ cp -rf /var/lib/rancher/k3s/server/db /opt/db
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 恢复</span>
</span></span><span class="line"><span class="cl">$ systemctl stop k3s
</span></span><span class="line"><span class="cl">$ rm -rf /var/lib/rancher/k3s/server/db
</span></span><span class="line"><span class="cl">$ cp -rf /opt/db /var/lib/rancher/k3s/server/db
</span></span><span class="line"><span class="cl">$ systemctl start k3s
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 方式2：通过 SQLite cli</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 备份</span>
</span></span><span class="line"><span class="cl">sqlite3 /var/lib/rancher/k3s/server/db/state.db
</span></span><span class="line"><span class="cl">SQLite version 3.22.0 2018-01-22 18:45:57
</span></span><span class="line"><span class="cl">Enter <span class="s2">&#34;.help&#34;</span> <span class="k">for</span> usage hints.
</span></span><span class="line"><span class="cl">sqlite&gt; .backup <span class="s2">&#34;/opt/kine.db&#34;</span>
</span></span><span class="line"><span class="cl">sqlite&gt; .exit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 恢复</span>
</span></span><span class="line"><span class="cl">$ sudo systemctl stop k3s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sqlite3 /var/lib/rancher/k3s/server/db/state.db
</span></span><span class="line"><span class="cl">SQLite version 3.22.0 2018-01-22 18:45:57
</span></span><span class="line"><span class="cl">Enter <span class="s2">&#34;.help&#34;</span> <span class="k">for</span> usage hints.
</span></span><span class="line"><span class="cl">sqlite&gt; .restore <span class="s1">&#39;/opt/kine.db&#39;</span>
</span></span><span class="line"><span class="cl">sqlite&gt; .exit
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ sudo systemctl start k3s
</span></span></code></pre></td></tr></table>
</div>
</div><p>When using an external data store, backup and restore operations are handled outside of <code>K3s</code>. The database administrator needs to perform backups of the external database or restore from snapshots or dumps. We recommend that the database be configured to perform periodic snapshots.</p>
<h3 id="use-external-data-storage-for-backup-and-recovery">Use external data storage for backup and recovery</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 备份</span>
</span></span><span class="line"><span class="cl">$ mysqldump -uroot -p --all-databases --master-data &gt; k3s-dbdump.db
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 恢复</span>
</span></span><span class="line"><span class="cl">$ systemctl stop k3s
</span></span><span class="line"><span class="cl">$ mysql -uroot -p  &lt; k3s-dbdump.db
</span></span><span class="line"><span class="cl">$ systemctl start k3s
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="backup-and-restore-with-embedded-etcd-datastore">Backup and restore with embedded etcd datastore</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 创建快照(K3s默认启用快照)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 快照目录默认: /var/lib/rancher/k3s/server/db/snapshots</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 要配置快照间隔或保留的快照数量</span>
</span></span><span class="line"><span class="cl">--etcd-disable-snapshots       禁用自动etcd快照
</span></span><span class="line"><span class="cl">--etcd-snapshot-schedule-cron  定时快照的时间点；认值为每12小时触发一次
</span></span><span class="line"><span class="cl">--etcd-snapshot-retention      保留的快照数量；默认值为5
</span></span><span class="line"><span class="cl">--etcd-snapshot-dir            保存数据库快照的目录路径
</span></span><span class="line"><span class="cl">--cluster-reset                忘记所有的对等体；成为新集群的唯一成员
</span></span><span class="line"><span class="cl">--cluster-reset-restore-path   要恢复的快照文件的路径
</span></span></code></pre></td></tr></table>
</div>
</div><p>When <code>K3s</code> restores from a backup, the old data directory will be moved to <code>/var/lib/rancher/k3s/server/db/etcd-old/</code> . Then <code>K3s</code> will try to restore the snapshot by creating a new data directory, and then start <code>etcd</code> from a new <code>K3s</code> cluster with one <code>etcd</code> member.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 从快照恢复集群</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用--cluster-reset选项运行K3s</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 同时给出--cluster-reset-restore-path</span>
</span></span><span class="line"><span class="cl">$ ./k3s server <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --cluster-reset <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --cluster-reset-restore-path<span class="o">=</span>&lt;PATH-TO-SNAPSHOT&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-k3s-volumes-and-storage">6. K3s volumes and storage</h2>
<p>When deploying an application that needs to retain data, you need to create persistent storage. Persistent storage allows you to store application data from outside the <code>pod</code> running the application. This type of storage allows you to maintain application data even if the application&rsquo;s <code>pod</code> fails.</p>
<h3 id="setting-up-local-storage-provider-support">Setting up Local Storage Provider support</h3>
<p><code>K3s</code> comes with <code>Rancher</code>&rsquo;s <code>Local Path Provisioner</code> (<code>LPP</code>), which enables the creation of <code>pvc</code> out-of-the-box using local storage on the respective node. Depending on the user configuration, <code>LPP</code> will automatically create <code>hostPath</code>-based persistent volumes on the node. It takes advantage of the features introduced by the <code>Local Persistent Volume</code> feature of <code>K8s</code>, but it is a simpler solution than the <code>local pv</code> feature built into <code>K8s</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># pvc.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">local-path-pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># pod.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:stable-alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">local-path-pvc</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 应用yaml服务</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f pvc.yaml pod.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确认PV和PVC已创建</span>
</span></span><span class="line"><span class="cl">$ kubectl get pv
</span></span><span class="line"><span class="cl">$ kubectl get pvc
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="setting-up-longhorn-support">Setting up Longhorn support</h3>
<p><code>K3s</code> supports <code>Longhorn</code> (which is an open source distributed block storage system for <code>K8s</code>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 安装Longhorn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 将被安装在命名空间longhorn-system中</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ kubectl apply -f https://raw.githubusercontent.com/longhorn/longhorn/master/deploy/longhorn.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># pvc.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">longhorn-volv-pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">longhorn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># pod.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volume-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:stable-alpine</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">longhorn-volv-pvc</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 应用yaml服务</span>
</span></span><span class="line"><span class="cl">$ kubectl create -f pvc.yaml pod.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确认PV和PVC已创建</span>
</span></span><span class="line"><span class="cl">$ kubectl get pv
</span></span><span class="line"><span class="cl">$ kubectl get pvc
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="7-k3s-network-related">7. K3s network related</h2>
<h3 id="coredns">CoreDNS</h3>
<p><code>CoreDNS</code> is deployed when the <code>agent</code> node is started. To disable it, run the <code>-disable coredns</code> option on each server. If you do not install <code>CoreDNS</code>, you will need to install a clustered <code>DNS</code> provider yourself.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 如何修改coredns参数</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /var/lib/rancher/k3s/server/manifests/coredns.yaml</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 该文件重启K3s服务的话会导致coredns配置重新初始化</span>
</span></span><span class="line"><span class="cl">1.将coredns.yaml保存到其他目录
</span></span><span class="line"><span class="cl">2.通过 --disable coredns 禁用coredns
</span></span><span class="line"><span class="cl">3.复制coredns.yaml到/var/lib/rancher/k3s/server/manifests/目录并修改参数
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="traefik-ingress-controller">Traefik Ingress Controller</h3>
<p>When starting the <code>server</code>, <code>Traefik</code> will be deployed by default and any changes to this file will be automatically deployed to <code>Kubernetes</code> in a similar way to <code>kubectl apply</code>, which will use ports <code>80</code> and <code>443</code> on the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 操作和上面基本是一致的</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 请使用 --disable traefik 选项启动每个server</span>
</span></span><span class="line"><span class="cl"><span class="c1"># /var/lib/rancher/k3s/server/manifests/traefik.yaml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 如何启用 treafik2 dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># http://traefik.example.com/dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># To create an encoded user:password pair, the following command can be used:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># htpasswd -nb admin admin | openssl base64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authsecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">users</span><span class="p">:</span><span class="w"> </span><span class="l">|2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">YWRtaW46JGFwcjEkLkUweHd1Z0EkUjBmLi85WndJNXZWRFMyR2F2LmtELwoK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IngressRoute</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">traefik-dashboard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">match</span><span class="p">:</span><span class="w"> </span><span class="l">Host(`traefik.example.com`) &amp;&amp; (PathPrefix(`/api`) || PathPrefix(`/dashboard`))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Rule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api@internal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TraefikService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">middlewares</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">traefik.containo.us/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Middleware</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">basicAuth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l">authsecret</span><span class="w"> </span><span class="c"># Kubernetes secret named &#34;secretName&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="service-load-balancer">Service Load Balancer</h3>
<p><code>K3s</code> provides a load balancer called <code>Klipper Load Balancer</code> that can use the available host ports. It is allowed to create <code>Service</code> of type <code>LoadBalancer</code>, but does not include an implementation of <code>LB</code>. Some <code>LB</code> services require a cloud provider, such as <code>Amazon EC2</code>. In contrast, <code>K3s service LB</code> makes it possible to use <code>LB</code> services without a cloud provider.</p>
<h2 id="8-k3s-and-helm">8. K3s and Helm</h2>
<p><code>Helm</code> is a package management tool for <code>Kubernetes</code>. <code>Helm Chart</code> provides a templated syntax for <code>Kubernetes YAML</code> manifest files, and the corresponding <code>chart</code> can be installed via <code>Helm</code>. <code>K3s</code> does not require any special configuration to use the <code>Helm</code> command line tool.</p>
<h3 id="automatically-deploy-helm-charts">Automatically deploy Helm charts</h3>
<p>Any <code>Kubernetes</code> manifests found in <code>/var/lib/rancher/k3s/server/manifests</code> will be automatically deployed to <code>K3s</code> in a manner similar to <code>kubectl apply</code>. <code>manifests</code> deployed in this way are managed as <code>AddOn</code> custom resources. You will find <code>AddOns</code> for packaged components such as <code>CoreDNS</code>, <code>Local-Storage</code>, etc. The <code>AddOns</code> are automatically created by the deployment controller and named according to their filenames in the <code>manifests</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看运行AddOn资源</span>
</span></span><span class="line"><span class="cl">$ kubectl get addon -A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以将Helm-Chart作为AddOns部署</span>
</span></span><span class="line"><span class="cl">https://github.com/rancher/helm-controller/
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="using-helm-crd">Using Helm CRD</h3>
<p>The <code>HelmChart CRD</code> captures most of the options that you would normally pass to the <code>helm</code> command line tool. Here is an example of how to deploy <code>Grafana</code> from the default <code>Chart</code> repository, overriding some of the default <code>Chart</code> values. Note that the <code>HelmChart</code> resource itself is in the <code>kube-system</code> namespace, but the <code>Chart</code> resource will be deployed to the <code>monitoring</code> namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">helm.cattle.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HelmChart</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grafana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">chart</span><span class="p">:</span><span class="w"> </span><span class="l">stable/grafana</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">targetNamespace</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">set</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">adminPassword</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;NotVerySafePassword&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">valuesContent</span><span class="p">:</span><span class="w"> </span><span class="p">|-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    image:
</span></span></span><span class="line"><span class="cl"><span class="sd">      tag: master
</span></span></span><span class="line"><span class="cl"><span class="sd">    env:
</span></span></span><span class="line"><span class="cl"><span class="sd">      GF_EXPLORE_ENABLED: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    adminUser: admin
</span></span></span><span class="line"><span class="cl"><span class="sd">    sidecar:
</span></span></span><span class="line"><span class="cl"><span class="sd">      datasources:
</span></span></span><span class="line"><span class="cl"><span class="sd">        enabled: true</span><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="9-k3s-advanced-options">9. K3s Advanced Options</h2>
<h3 id="certificate-rotation">Certificate Rotation</h3>
<p>By default, a certificate for <code>K3s</code> expires in <code>12</code> months. If the certificate has expired or has less than <code>90</code> days remaining, the certificate is rotated when <code>K3s</code> is restarted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查询K3s证书过期时间</span>
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in <span class="sb">`</span>ls /var/lib/rancher/k3s/server/tls/*.crt<span class="sb">`</span><span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="k">do</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    openssl x509 -enddate -noout -in <span class="nv">$i</span><span class="p">;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改系统时间为证书过期前90天或证书过期后</span>
</span></span><span class="line"><span class="cl">$ timedatectl set-ntp no
</span></span><span class="line"><span class="cl">$ date -s <span class="m">20220807</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启K3s服务</span>
</span></span><span class="line"><span class="cl">$ service k3s restart
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="additional-preparation-for-red-hat-and-centos">Additional preparation for Red Hat and CentOS</h3>
<p>It is recommended to run the following command to disable the <code>firewalld</code> firewall.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">### Additional preparation for Red Hat and CentOS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">It is recommended to run the following <span class="nb">command</span> to disable the <span class="sb">`</span>firewalld<span class="sb">`</span> firewall.
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k3s/">k3s</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-05/packer-vsphere-example/">
            <span class="next-text nav-default">Building Virtual Machine Images with Packer</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
