<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Use vmagent instead of Prometheus to collect monitoring metrics - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use vmagent to collect monitoring metrics." /><meta name="keywords" content="Vmagent, Prometheus" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/vmagent/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Use vmagent instead of Prometheus to collect monitoring metrics" />
<meta property="og:description" content="Learn how to use vmagent to collect monitoring metrics." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/vmagent/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-11T13:27:27+08:00" />
<meta property="article:modified_time" content="2022-05-11T13:27:27+08:00" />

<meta itemprop="name" content="Use vmagent instead of Prometheus to collect monitoring metrics">
<meta itemprop="description" content="Learn how to use vmagent to collect monitoring metrics."><meta itemprop="datePublished" content="2022-05-11T13:27:27+08:00" />
<meta itemprop="dateModified" content="2022-05-11T13:27:27+08:00" />
<meta itemprop="wordCount" content="1972">
<meta itemprop="keywords" content="vmagent,prometheus," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Use vmagent instead of Prometheus to collect monitoring metrics"/>
<meta name="twitter:description" content="Learn how to use vmagent to collect monitoring metrics."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Use vmagent instead of Prometheus to collect monitoring metrics</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-11 13:27:27 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1972 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#features">Features</a></li>
        <li><a href="#deployment">Deployment</a>
          <ul>
            <li><a href="#clustered-mode">Clustered mode</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>vmagent can help us collect metrics from various sources and store them in VMs or any other Prometheus-compatible storage system that supports the remote write protocol.</p>
<h2 id="features">Features</h2>
<p><a href="https://docs.victoriametrics.com/vmagent.html">vmagent</a> has more flexibility than <a href="https://prometheus.io/">Prometheus</a> for scraping metrics, such as the ability to push metrics in addition to pull metrics, and many other features.</p>
<ul>
<li>Can replace the scraping target of prometheus</li>
<li>Support for reading and writing data from Kafka</li>
<li>Supports adding, removing, and modifying labels based on prometheus relabeling patterns, and filtering data before it is sent to remote storage.</li>
<li>Supports multiple data protocols, including influx line protocol, graphite text protocol, opentsdb protocol, prometheus remote write protocol, json lines protocol, csv data, etc.</li>
<li>Support for data collection and replication to multiple remote storage systems at the same time</li>
<li>Support unreliable remote storage, if remote storage is not available, the collected metrics will be buffered in <code>-remoteWrite.tmpDataPath</code>, once the connection to remote storage is repaired, the buffered metrics will be sent to remote storage, the maximum disk usage of the buffer can be specified with <code>-remoteWrite. maxDiskUsagePerURL</code> to limit it.</li>
<li>Uses less memory, cpu, disk io, and network bandwidth than prometheus</li>
<li>When a large number of targets need to be crawled, the crawl targets can be spread across multiple vmagent instances</li>
<li>High base and churn can be handled by limiting the number of unique time series before crawling time and sending them to remote storage systems</li>
<li>scrape configuration can be loaded from multiple files</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/11/74e6a8a1eb6d4bc4959b228d4bb4a83f.png" alt="vmagent"></p>
<h2 id="deployment">Deployment</h2>
<p>Next, we&rsquo;ll use the example of grabbing Kubernetes cluster metrics to illustrate how to use vmagent, which we&rsquo;ll configure here using auto-discovery. vmagent is compatible with the <code>kubernetes_sd_configs</code> configuration in prometheus, so we can use that as well.</p>
<p>To make vmagent auto-discover monitored resource objects, you need to access the APIServer to get the resource objects, so first you need to configure the rbac permissions and create the resource list as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmagent-rbac.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;networking.k8s.io&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;extensions&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">nodes/metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">services</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">endpointslices</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ingresses</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;list&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;watch&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">namespaces</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">configmaps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">nonResourceURLs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/metrics&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/metrics/resources&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;get&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then to add the vmagent configuration, we first configure only the task of auto-discovering Kubernetes nodes, creating the ConfigMap object as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmagent-config.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scrape.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    global:
</span></span></span><span class="line"><span class="cl"><span class="sd">      scrape_interval: 15s
</span></span></span><span class="line"><span class="cl"><span class="sd">      scrape_timeout: 15s
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    scrape_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">    - job_name: nodes
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubernetes_sd_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - role: node
</span></span></span><span class="line"><span class="cl"><span class="sd">      relabel_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - source_labels: [__address__]
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: &#34;(.*):10250&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        replacement: &#34;${1}:9111&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: __address__
</span></span></span><span class="line"><span class="cl"><span class="sd">        action: replace
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: labelmap
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: __meta_kubernetes_node_label_(.+)</span><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Here we get the node monitoring metrics by auto-discovering the Kubernetes node. Note that the default auto-discovery for the <code>node</code> role is to get the node&rsquo;s <code>10250</code> port, here we need to <code>replace</code> it to <code>9111</code> via <code>relabel</code>.</p>
<p>Then add the vmagent deployment resource list as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmagent-deploy.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;victoriametrics/vmagent:v1.77.0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">promscrape.config=/config/scrape.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">remoteWrite.tmpDataPath=/tmpData</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">remoteWrite.url=http://vminsert:8480/insert/0/prometheus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">envflag.enable=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">envflag.prefix=VM_</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">loggerFormat=json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8429</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmpdata</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmpData</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmpdata</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-pvc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-config</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We mount the vmagent configuration to the container <code>/config/scrape.yml</code> via ConfigMap, and specify the remote write address via <code>-remoteWrite.url=http://vminsert:8480/insert/0/prometheus</code>, where we write to the previous There is another parameter <code>-remoteWrite.tmpDataPath</code> which will be used to cache the collected metrics when the remote storage is not available, and when the remote storage is repaired, the cached metrics will be sent to the remote write normally, so it is better to persist the directory.</p>
<h3 id="clustered-mode">Clustered mode</h3>
<p>A single vmagent instance can crawl tens of thousands of crawl targets, but sometimes this is not enough due to CPU, network, memory, etc. limitations. In this case, the crawl targets can be split between multiple vmagent instances. Each vmagent instance in the cluster must use the same <code>-promscrape.config</code> profile with a different <code>-promscrape.cluster.memberNum</code> value, which must be in the <code>0 ... N-1</code> range, where <code>N</code> is the number of vmagent instances in the cluster. The number of vmagent instances in the cluster must be passed to the <code>-promscrape.cluster.membersCount</code> command line flag. For example, the following command propagates crawl targets across a cluster of two vmagent instances.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vmagent -promscrape.cluster.membersCount<span class="o">=</span><span class="m">2</span> -promscrape.cluster.memberNum<span class="o">=</span><span class="m">0</span> -promscrape.config<span class="o">=</span>/path/config.yml ...
</span></span><span class="line"><span class="cl">vmagent -promscrape.cluster.membersCount<span class="o">=</span><span class="m">2</span> -promscrape.cluster.memberNum<span class="o">=</span><span class="m">1</span> -promscrape.config<span class="o">=</span>/path/config.yml ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the vmagent is running in Kubernetes, you can set <code>-promscrape.cluster.memberNum</code> to the StatefulSet pod name, and the pod name must end with <code>0 ... promscrape.cluster.memberNum-1</code>, for example, <code>-promscrape.cluster.memberNum=vmagent-0</code>.</p>
<p>By default, each crawl target is only crawled by a single vmagent instance in the cluster. If you need to replicate the crawl target between multiple vmagent instances, you can set the <code>-promscrape.cluster.replicationFactor</code> parameter to the required number of replicas. For example, the following command starts a cluster with three vmagent instances, where each target is crawled by two vmagent instances.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vmagent -promscrape.cluster.membersCount<span class="o">=</span><span class="m">3</span> -promscrape.cluster.replicationFactor<span class="o">=</span><span class="m">2</span> -promscrape.cluster.memberNum<span class="o">=</span><span class="m">0</span> -promscrape.config<span class="o">=</span>/path/to/config.yml ...
</span></span><span class="line"><span class="cl">vmagent -promscrape.cluster.membersCount<span class="o">=</span><span class="m">3</span> -promscrape.cluster.replicationFactor<span class="o">=</span><span class="m">2</span> -promscrape.cluster.memberNum<span class="o">=</span><span class="m">1</span> -promscrape.config<span class="o">=</span>/path/to/config.yml ...
</span></span><span class="line"><span class="cl">vmagent -promscrape.cluster.membersCount<span class="o">=</span><span class="m">3</span> -promscrape.cluster.replicationFactor<span class="o">=</span><span class="m">2</span> -promscrape.cluster.memberNum<span class="o">=</span><span class="m">2</span> -promscrape.config<span class="o">=</span>/path/to/config.yml ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that if each target is crawled by multiple vmagent instances, deduplication must be enabled on the remote storage pointed to by <code>-remoteWrite.url</code>.</p>
<p>So if you are crawling very large monitoring targets, then we recommend using vmagent clustering mode, then you can use the StatefulSet method for deployment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmagent-sts.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prometheus.io/scrape</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prometheus.io/port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;8429&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8429</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">StatefulSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">agent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">victoriametrics/vmagent:v1.77.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">promscrape.config=/config/scrape.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">remoteWrite.tmpDataPath=/tmpData</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">promscrape.cluster.membersCount=2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c"># - -promscrape.cluster.replicationFactor=2 # </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">promscrape.cluster.memberNum=$(POD_NAME)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">remoteWrite.url=http://vminsert:8480/insert/0/prometheus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">envflag.enable=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">envflag.prefix=VM_</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- -<span class="l">loggerFormat=json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8429</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmpdata</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmpData</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmpdata</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll manage the vmagent here in the form of a StatefulSet, applying the above resources directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># First stop the prometheus in the previous example </span>
</span></span><span class="line"><span class="cl">  kubectl scale deploy prometheus --replicas<span class="o">=</span><span class="m">0</span> -n kube-vm
</span></span><span class="line"><span class="cl">  kubectl apply -f vmagent-rbac.yaml
</span></span><span class="line"><span class="cl">  kubectl apply -f vmagent-config.yaml
</span></span><span class="line"><span class="cl">  kubectl apply -f vmagent-sts.yaml
</span></span><span class="line"><span class="cl">  kubectl get pods -n kube-vm -l <span class="nv">app</span><span class="o">=</span>vmagent
</span></span><span class="line"><span class="cl">NAME        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">vmagent-0   1/1     Running   <span class="m">0</span>          3m43s
</span></span><span class="line"><span class="cl">vmagent-1   1/1     Running   <span class="m">0</span>          2m9s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we have deployed two instances of vmagent to capture monitoring metrics, we have 3 nodes in total.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  kubectl get nodes
</span></span><span class="line"><span class="cl">NAME      STATUS   ROLES                  AGE   VERSION
</span></span><span class="line"><span class="cl">master1   Ready    control-plane,master   44d   v1.22.8
</span></span><span class="line"><span class="cl">node1     Ready    &lt;none&gt;                 44d   v1.22.8
</span></span><span class="line"><span class="cl">node2     Ready    &lt;none&gt;                 44d   v1.22.8
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the two vmagent instances will collect some of the metrics separately, and we can verify it by checking the logs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  kubectl logs -f vmagent-0 -n kube-vm
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2022-05-10T04:44:44.004Z&#34;</span>,<span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;caller&#34;</span>:<span class="s2">&#34;VictoriaMetrics/lib/promscrape/scraper.go:393&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;static_configs: added targets: 1, removed targets: 0; total targets: 1&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2022-05-10T04:44:44.006Z&#34;</span>,<span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;caller&#34;</span>:<span class="s2">&#34;VictoriaMetrics/lib/promscrape/scraper.go:393&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;kubernetes_sd_configs: added targets: 2, removed targets: 0; total targets: 2&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">  kubectl logs -f vmagent-1 -n kube-vm
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2022-05-10T04:46:17.893Z&#34;</span>,<span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;caller&#34;</span>:<span class="s2">&#34;VictoriaMetrics/lib/promscrape/scraper.go:393&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;kubernetes_sd_configs: added targets: 1, removed targets: 0; total targets: 1&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the logs, we can see that the <code>vmagent-0</code> instance found 2 targets and the <code>vmagent-1</code> instance found 1 target, which is what we expected.</p>
<p>Next, we will add other content monitoring, such as APIServer, containers, etc. The configuration is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmagent-config2.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-vm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scrape.yml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    global:
</span></span></span><span class="line"><span class="cl"><span class="sd">      scrape_interval: 15s
</span></span></span><span class="line"><span class="cl"><span class="sd">      scrape_timeout: 15s
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    scrape_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    - job_name: nodes
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubernetes_sd_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - role: node
</span></span></span><span class="line"><span class="cl"><span class="sd">      relabel_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - source_labels: [__address__]
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: &#34;(.*):10250&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        replacement: &#34;${1}:9111&#34;
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: __address__
</span></span></span><span class="line"><span class="cl"><span class="sd">        action: replace
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: labelmap
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    - job_name: apiserver
</span></span></span><span class="line"><span class="cl"><span class="sd">      scheme: https
</span></span></span><span class="line"><span class="cl"><span class="sd">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span class="line"><span class="cl"><span class="sd">      tls_config:
</span></span></span><span class="line"><span class="cl"><span class="sd">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span class="line"><span class="cl"><span class="sd">        insecure_skip_verify: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubernetes_sd_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - role: endpoints
</span></span></span><span class="line"><span class="cl"><span class="sd">      relabel_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: keep
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: default;kubernetes;https
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_namespace
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_name
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_endpoint_port_name
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    - job_name: cadvisor
</span></span></span><span class="line"><span class="cl"><span class="sd">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span></span><span class="line"><span class="cl"><span class="sd">      scheme: https
</span></span></span><span class="line"><span class="cl"><span class="sd">      tls_config:
</span></span></span><span class="line"><span class="cl"><span class="sd">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span><span class="line"><span class="cl"><span class="sd">        insecure_skip_verify: true
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubernetes_sd_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - role: node
</span></span></span><span class="line"><span class="cl"><span class="sd">      relabel_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: labelmap
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: __meta_kubernetes_node_label_(.+)
</span></span></span><span class="line"><span class="cl"><span class="sd">      - replacement: /metrics/cadvisor
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: __metrics_path__
</span></span></span><span class="line"><span class="cl"><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    - job_name: endpoints
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubernetes_sd_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - role: endpoints
</span></span></span><span class="line"><span class="cl"><span class="sd">      relabel_configs:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: drop
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: true
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_pod_container_init
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: keep_if_equal
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_annotation_prometheus_io_port
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_pod_container_port_number
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: keep
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: true
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_annotation_prometheus_io_scrape
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: replace
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: (https?)
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_annotation_prometheus_io_scheme
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: __scheme__
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: replace
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: (.+)
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_annotation_prometheus_io_path
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: __metrics_path__
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: replace
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: ([^:]+)(?::\d+)?;(\d+)
</span></span></span><span class="line"><span class="cl"><span class="sd">        replacement: $1:$2
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __address__
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_annotation_prometheus_io_port
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: __address__
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: labelmap
</span></span></span><span class="line"><span class="cl"><span class="sd">        regex: __meta_kubernetes_service_label_(.+)
</span></span></span><span class="line"><span class="cl"><span class="sd">      - source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_pod_name
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: pod
</span></span></span><span class="line"><span class="cl"><span class="sd">      - source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_namespace
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: namespace
</span></span></span><span class="line"><span class="cl"><span class="sd">      - source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_name
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: service
</span></span></span><span class="line"><span class="cl"><span class="sd">      - replacement: ${1}
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_service_name
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: job
</span></span></span><span class="line"><span class="cl"><span class="sd">      - action: replace
</span></span></span><span class="line"><span class="cl"><span class="sd">        source_labels:
</span></span></span><span class="line"><span class="cl"><span class="sd">        - __meta_kubernetes_pod_node_name
</span></span></span><span class="line"><span class="cl"><span class="sd">        target_label: node</span><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Most of the configurations are described in the previous Prometheus chapters, and the core is to control the task of crawling through <code>relabel_configs</code>. vmagent is compatible with the traditional prometheus relabeling rules, but there are some unique actions, for example, in the above configuration we use a <code>keep_if_ equal</code> action, which means that if the specified tag values are equal, the data will be kept.</p>
<p>Sometimes, if an indicator contains two tags with the same value, it needs to be deleted. This can be done with the <code>drop_if_equal</code> operation supported by vmagent. For example, if the following relabel rule contains the same label value for <code>real_port</code> and <code>required_port</code>, it will delete the indicator.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">drop_if_equal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">real_port, needed_port]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This rule will remove the following indicator: <code>foo{real_port=&quot;123&quot;,needed_port=&quot;123&quot;}</code>, but will keep the following indicator: <code>foo{real_port=&quot;123&quot;,needed_port=&quot;456&quot;}</code>.</p>
<p>Sometimes it may be necessary to apply relabel to only a subset of indicators, in which case the <code>if</code> option can be added to the <code>relabel_configs</code> rule. For example, the following rule adds the <code>{foo=&quot;bar&quot;}</code> label only to indicators that match the <code>metric{label=~&quot;x|y&quot;}</code> sequence selector.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;metric{label=~&#34;x|y&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;foo&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;bar&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>if</code> option simplifies traditional <code>relabel_configs</code> rules, for example, the following rule removes indicators that match the <code>foo{bar=&quot;baz&quot;}</code> sequential selector.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;foo{bar=&#34;baz&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This corresponds to the following traditional rules.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl">- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__name__, bar]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;foo;baz&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>However, note that Prometheus does not yet support the <code>if</code> option and now only supports VictoriaMetrics.</p>
<p>Now update the vmagent configuration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  kubectl apply -f vmagent-config2.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are two ways to configure a refresh.</p>
<ul>
<li>Sending a SUGHUP signal to the vmagent process</li>
<li>send an http request to <code>http://vmagent:8429/-/reload</code></li>
</ul>
<p>After refreshing, we can start collecting the above metrics, and we can also access vmui via <code>http://vmselect/select/0/vmui/</code>. For example, if we want to query the memory usage of the pod, we can use the following query statement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sum<span class="o">(</span>container_memory_working_set_bytes<span class="o">{</span>image!<span class="o">=</span><span class="s2">&#34;&#34;</span><span class="o">})</span> by<span class="o">(</span>namespace, pod<span class="o">)</span> / sum<span class="o">(</span>container_spec_memory_limit_bytes<span class="o">{</span>image!<span class="o">=</span><span class="s2">&#34;&#34;</span><span class="o">})</span> by<span class="o">(</span>namespace, pod<span class="o">)</span> * <span class="m">100</span> !<span class="o">=</span> +inf
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/11/770e62e2564b4832940e3fa6345f6ea9.png" alt="memory usage of the pod"></p>
<p>vmagent is an important part of collecting metrics, and of course, monitoring it is indispensable. vmagent exposes many metrics through <code>http://vmagent:8429/metrics</code>, such as <code>vmagent_remotewrite_conns</code> remote storage connections, <code>vm_allowed_memory _bytes</code> the amount of memory that can be used. We have collected some important metrics and presented them through Grafana to better help us analyze the state of vmagent.</p>
<p>We can use <a href="https://grafana.com/grafana/dashboards/12683">Vmagentby DASHBOARD</a> to show the status of the vmagent.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/11/22e162c8bb30459f9950bc8cbe47c3e5.png" alt="Vmagentby DASHBOARD"></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vmagent/">vmagent</a>
          <a href="/tags/prometheus/">prometheus</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/tilelink/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">TileLink Bus Protocol Analysis</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/svelte-native-vs-react-native/">
            <span class="next-text nav-default">Svelte Native VS React Native</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
