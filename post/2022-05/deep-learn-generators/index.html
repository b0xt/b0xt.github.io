<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>In-depth understanding of Generators - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article provides an introduction to Generators, with a focus on how Generators operate and how they are implemented in ES5." /><meta name="keywords" content="Generators, javascript" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/deep-learn-generators/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="In-depth understanding of Generators" />
<meta property="og:description" content="This article provides an introduction to Generators, with a focus on how Generators operate and how they are implemented in ES5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/deep-learn-generators/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-15T17:13:15+08:00" />
<meta property="article:modified_time" content="2022-05-15T17:13:15+08:00" />

<meta itemprop="name" content="In-depth understanding of Generators">
<meta itemprop="description" content="This article provides an introduction to Generators, with a focus on how Generators operate and how they are implemented in ES5."><meta itemprop="datePublished" content="2022-05-15T17:13:15+08:00" />
<meta itemprop="dateModified" content="2022-05-15T17:13:15+08:00" />
<meta itemprop="wordCount" content="2181">
<meta itemprop="keywords" content="javascript," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In-depth understanding of Generators"/>
<meta name="twitter:description" content="This article provides an introduction to Generators, with a focus on how Generators operate and how they are implemented in ES5."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">In-depth understanding of Generators</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-15 17:13:15 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2181 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#generators-in-c">Generators in C</a>
          <ul>
            <li><a href="#c-iterator-introduction">C# Iterator Introduction</a></li>
            <li><a href="#c-iterator-principle">C# Iterator Principle</a></li>
          </ul>
        </li>
        <li><a href="#generators-in-javascript">Generators in Javascript</a>
          <ul>
            <li><a href="#javascript-generators-principle">Javascript Generators Principle</a></li>
            <li><a href="#how-generators-work-in-es5">How Generators work in ES5</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>As the Javascript language has evolved, the ES6 specification has brought many new things to the table, and one of the key features is the generator Generators. With this feature, we can simplify the creation of iterators, and even more excitingly, Generators allow us to pause a function during execution and resume execution at some point in the future. This feature is a change from the old feature that functions had to finish executing before they returned, and applying this feature to asynchronous code can effectively simplify writing asynchronous methods while avoiding callback hell.</p>
<p>In this article, we will briefly introduce Generators, and then focus on the operation mechanism of Generators and its implementation in ES5 with my experience in C#.</p>
<h2 id="introduction">Introduction</h2>
<p>A simple Generator function example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span><span class="o">*</span> <span class="nx">example</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">example</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// {value:1，done:false}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// {value:2，done:false}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// {value:3，done:false}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// {value:undefined，done:true}
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The above code defines a generator function that is not executed immediately when the generator function example() is called, but instead returns a generator object. Whenever the .next() method of the generator object is called, the function will run to the next yield expression, return the result of the expression, and pause itself. When the end of the generator function is reached, the value of done is true and the value of value is undefined. we will call the above example() function a generator function, and the difference between the two is as follows</p>
<ul>
<li>Normal functions use function declaration, generator functions use function* declaration.</li>
<li>Normal functions use return, generator functions use yield.</li>
<li>Normal functions are in run to completion mode, i.e., they are executed until all statements of the function are completed, during which time other code statements are not executed; generator functions are in run-pause-run mode, i.e., generator functions can be paused once or more during function execution and resumed later, during which allows other code statements to be executed</li>
</ul>
<h2 id="generators-in-c">Generators in C</h2>
<p>Generators are not a new concept, I was first introduced to them when I was learning to use C#, which introduced the yield keyword from version 2.0, making it easier to create enumerated numbers and enumerable types. The difference is that instead of calling them generators Generators in C#, they are called iterators.</p>
<p>This article will not cover the C# enumerable class IEnumerable and the enumerator IEnumerator, for that we recommend reading the chapter &ldquo;C# 4.0 Illustrated Tutorial&rdquo;.</p>
<h3 id="c-iterator-introduction">C# Iterator Introduction</h3>
<p>Let&rsquo;s start with an example where the following method declaration implements an iterator that generates and returns an enumeration number.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">public</span> <span class="n">IEnumerable</span> <span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span> <span class="n">Example</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The method definition is very close to the ES6 Generators definition in that it declares a generic enumerable type that returns an int type, and the method body returns the value and suspends itself via a yield return statement.</p>
<p>Iterators are used to create classes of enumerable types.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">YieldClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">Example</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// 迭代器</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="k">return</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">yield</span> <span class="k">return</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">YieldClass</span> <span class="n">yc</span> <span class="p">=</span> <span class="k">new</span> <span class="n">YieldClass</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">a</span> <span class="k">in</span> <span class="n">yc</span><span class="p">.</span><span class="n">Example</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code will produce the following output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">1
</span></span><span class="line"><span class="cl">2
</span></span><span class="line"><span class="cl">3
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="c-iterator-principle">C# Iterator Principle</h3>
<p>Net runtime feature, but rather a syntactic sugar that is compiled into simple IL code by the C# compiler when the code is compiled.</p>
<p>Continuing with the above example, we can see through the Reflector decompiler tool that the compiler generates an internal class for us with the following declaration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="na">[CompilerGenerated]</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">YieldEnumerator</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;,</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Fields字段</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">int</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">YieldClass</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">int</span> <span class="n">initialThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods方法</span>
</span></span><span class="line"><span class="cl"><span class="na">    [DebuggerHidden]</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">YieldEnumerator</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">bool</span> <span class="n">MoveNext</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="na">    [DebuggerHidden]</span>
</span></span><span class="line"><span class="cl">    <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="na">    [DebuggerHidden]</span>
</span></span><span class="line"><span class="cl">    <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="na">    [DebuggerHidden]</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">IEnumerator</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">IDisposable</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Properties属性</span>
</span></span><span class="line"><span class="cl">    <span class="kt">object</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;.</span><span class="n">Current</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="p">[</span><span class="n">DebuggerHidden</span><span class="p">]</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">object</span> <span class="n">IEnumerator</span><span class="p">.</span><span class="n">Current</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> <span class="p">[</span><span class="n">DebuggerHidden</span><span class="p">]</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The original Example() method returns only an instance of YieldEnumerator and passes the initial state -2 to itself and its referrer, each iterator saving one state indication.</p>
<ul>
<li>-2: initialized to the iterable class Enumerable</li>
<li>-1: End of iteration</li>
<li>0: initialized to iterator Enumerator</li>
<li>1-n: yield return index value in the original Example() method</li>
</ul>
<p>The code in the Example() method is converted to YieldingEnumerator.MoveNext(), and in our example the converted code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cs" data-lang="cs"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">MoveNext</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="m">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">current</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="m">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">current</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="m">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">current</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="m">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Using the above code transformation, the compiler generates a state machine for us and it is based on this state machine model that the properties of the yield keyword are implemented.</p>
<p>The iterator state machine model can be shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/33fab37fc19e45d5a27e5c212fee7c2e.png" alt="iterator state machine model"></p>
<ul>
<li>Before is the initial state of the iterator</li>
<li>Running is the state entered after calling MoveNext. In this state, the enumerator detects and sets the position of the next item. When yield return, yield break or end of iteration is encountered, this state is exited</li>
<li>Suspended is the state where the state machine waits for the next call to MoveNext.</li>
<li>After is the state where the iteration ends</li>
</ul>
<h2 id="generators-in-javascript">Generators in Javascript</h2>
<p>By reading the above, we understand the use of Generator in C#, and by looking at the IL code generated by the compiler, we know that the compiler generates an internal class to hold the context information, and then converts the yield return expression into a switch case, which implements the yield keyword through the state machine model.</p>
<h3 id="javascript-generators-principle">Javascript Generators Principle</h3>
<p>How is the yield keyword implemented in Javascript?</p>
<p>First, generators are not threaded. In threaded languages, multiple pieces of code can run at the same time, which often leads to competition for resources and can provide a nice performance boost when used properly. Generators are completely different. The Javascript execution engine is still a single-threaded environment based on an event loop, and when a generator runs, it runs in the same thread called the caller. The order of execution is ordered, deterministic, and never concurrent. Unlike the system threads, the generator will only be hung when it is used internally to yield.</p>
<p>Since generators are not additionally supported by the engine from the ground up, we can follow our experience in exploring the principles of the yield feature in C# above and consider generators as a syntactic sugar, using a helper to convert generator functions to ordinary Javascript code, with two key points in the converted code, namely preserving the contextual information of the function and implementing The two key points in the transformed code are to preserve the function&rsquo;s context information and to implement a sound iteration method that allows multiple yield expressions to be executed in order, thus realizing the properties of generators.</p>
<h3 id="how-generators-work-in-es5">How Generators work in ES5</h3>
<p>The Regenerator tool already implements the above idea, and with the Regenerator tool we can already use generator functions in native ES5. In this section, we&rsquo;ll analyze the Regenerator implementation to get a deeper understanding of how Generators work.</p>
<p>This <a href="http://babeljs.io/repl/">online address</a> allows you to easily view the converted code, still using the article as an initial example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span><span class="o">*</span> <span class="nx">example</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">yield</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">example</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After conversion, it is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">marked0$0</span> <span class="o">=</span> <span class="p">[</span><span class="nx">example</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">regeneratorRuntime</span><span class="p">.</span><span class="nx">mark</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">example</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">regeneratorRuntime</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nx">example$</span><span class="p">(</span><span class="nx">context$1$0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">((</span><span class="nx">context$1$0</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="nx">context$1$0</span><span class="p">.</span><span class="nx">next</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">context$1$0</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">context$1$0</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">context$1$0</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">case</span> <span class="s1">&#39;end&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">context$1$0</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">marked0$0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">iter</span> <span class="o">=</span> <span class="nx">example</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">iter</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the converted code, similar to the C# compiler&rsquo;s conversion of yield return expressions, Regenerator rewrites the yield expressions in the generator functions as switch cases, and uses context110 in each case to preserve the current context state of the function.</p>
<p>In addition to the switch case, the iterator function example is wrapped by regeneratorRuntime.mark and returns an iterator object wrapped by regeneratorRuntime.wrap.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">runtime</span><span class="p">.</span><span class="nx">mark</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">genFun</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Object</span><span class="p">.</span><span class="nx">setPrototypeOf</span><span class="p">(</span><span class="nx">genFun</span><span class="p">,</span> <span class="nx">GeneratorFunctionPrototype</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">genFun</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="nx">GeneratorFunctionPrototype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">genFun</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">Gp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">genFun</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The example is wrapped in the following object by mark wrapping.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/2b4f6b0ee9c84c028be1b53fb6f25b9e.png" alt="js object"></p>
<p>When the generator function example() is called, an iterator object wrapped by the wrap function is returned.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">runtime</span><span class="p">.</span><span class="nx">wrap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">innerFn</span><span class="p">,</span> <span class="nx">outerFn</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">tryLocsList</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// If outerFn provided, then outerFn.prototype instanceof Generator.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">var</span> <span class="nx">generator</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">((</span><span class="nx">outerFn</span> <span class="o">||</span> <span class="nx">Generator</span><span class="p">).</span><span class="nx">prototype</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Context</span><span class="p">(</span><span class="nx">tryLocsList</span> <span class="o">||</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// The ._invoke method unifies the implementations of the .next,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// .throw, and .return methods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">generator</span><span class="p">.</span><span class="nx">_invoke</span> <span class="o">=</span> <span class="nx">makeInvokeMethod</span><span class="p">(</span><span class="nx">innerFn</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">generator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The returned iterator object is shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/f41f7dc44b104d1898d81646bd161347.png" alt="js object"></p>
<p>When calling the iterator object iter.next() method, the _invoke method is executed because of the following code, and according to the previous wrap method code, the makeInvokeMethod(innerFn, self, context); method of the iterator object is finally called.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// Helper for defining the .next, .throw, and .return methods of the
</span></span></span><span class="line"><span class="cl"><span class="c1">// Iterator interface in terms of a single ._invoke method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">defineIteratorMethods</span><span class="p">(</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;throw&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_invoke</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The makeInvokeMethod method has a lot of content, so here is a partial analysis. First, we find that the generator initializes its state to &ldquo;Suspended Start&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">makeInvokeMethod</span><span class="p">(</span><span class="nx">innerFn</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">GenStateSuspendedStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kd">function</span> <span class="nx">invoke</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>makeInvokeMethod returns the invoke function, and when we execute the .next method, the following statement in the invoke method is actually called.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">tryCatch</span><span class="p">(</span><span class="nx">innerFn</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the tryCatch method, fn is the converted example$ method and arg is the context object context, because the reference to context inside the invoke function forms a closure reference, so the context context is maintained throughout the iteration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">tryCatch</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="nx">arg</span><span class="o">:</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;throw&#39;</span><span class="p">,</span> <span class="nx">arg</span><span class="o">:</span> <span class="nx">err</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The tryCatch method actually calls the example$ method, which enters the converted switch case and executes the code logic. If the result is a normal type value, we wrap it in an iterable object format and update the generator state to GenStateCompleted or GenStateSuspendedYield.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">tryCatch</span><span class="p">(</span><span class="nx">innerFn</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">&#34;normal&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// If an exception is thrown from innerFn, we leave state ===
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// GenStateExecuting and loop back for another invocation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">state</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">done</span>
</span></span><span class="line"><span class="cl">    <span class="o">?</span> <span class="nx">GenStateCompleted</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="nx">GenStateSuspendedYield</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span><span class="o">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">arg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">done</span><span class="o">:</span> <span class="nx">context</span><span class="p">.</span><span class="nx">done</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>By analyzing the Regenerator transformed generator code and tool source code, we have explored the operation of the generator, which wraps the generator function with tool functions, adding methods such as next/return. It also wraps the returned generator object so that calls to methods such as next end up in a state machine model consisting of switch case. In addition, the closure technique is used to preserve the generator function context information.</p>
<p>The above process is basically the same as the implementation of the yield keyword in C#, which uses the compile conversion idea, the state machine model, and the preservation of function context information to realize the new language features brought by the new yield keyword.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/javascript/">javascript</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/js-event-loop/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Event Loop mechanism</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/writing-high-quality-python/">
            <span class="next-text nav-default">Writing high-quality Python code</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
