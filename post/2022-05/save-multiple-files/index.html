<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Save files in batch in the browser - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to save files in bulk in your browser." /><meta name="keywords" content="File System Access API, Chrome" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/save-multiple-files/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Save files in batch in the browser" />
<meta property="og:description" content="Learn how to save files in bulk in your browser." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/save-multiple-files/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-29T11:19:24+08:00" />
<meta property="article:modified_time" content="2022-05-29T11:19:24+08:00" />

<meta itemprop="name" content="Save files in batch in the browser">
<meta itemprop="description" content="Learn how to save files in bulk in your browser."><meta itemprop="datePublished" content="2022-05-29T11:19:24+08:00" />
<meta itemprop="dateModified" content="2022-05-29T11:19:24+08:00" />
<meta itemprop="wordCount" content="742">
<meta itemprop="keywords" content="Chrome," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Save files in batch in the browser"/>
<meta name="twitter:description" content="Learn how to save files in bulk in your browser."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Save files in batch in the browser</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-29 11:19:24 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 742 words </span>
          <span class="more-meta"> 4 mins read </span>
        
      </div>
    </header>

    
    <div class="post-content">
      <p>Recently, I received a business requirement that I need a batch export image function. It was suggested that the download task should be submitted to the server side, which would complete the packaging and then give the download link. I personally feel that this function can be implemented directly in the browser. So I did some research and found a feasible solution. Today, I will share it with you.</p>
<p><strong>The solution presented in this article uses Chrome&rsquo;s proprietary API, so it will not work properly with Firefox ðŸ˜‚.</strong></p>
<p>The first thing I thought of was using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API">File System Access API</a>. I thought I could use the File System Access API to get write access to a local folder, and then create and save the exported images in that folder via JavaScript. But after researching, I found that the File System Access API can only save files via <code>showSaveFilePicker()</code>, and every time I call it, a file selection dialog will pop up for the user to confirm. So it is not possible to achieve the function of batch saving.</p>
<p>Since you can only save one file at a time, you have to package all the images into one file to save them. So I came up with the Zip file format. However, the business side suggested that the total size of the images exported at one time could reach several G&rsquo;s in size. If we operate purely in memory, then we might run out of system memory. So we must design a streaming solution. So I came up with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">Streams API</a>.</p>
<p>Before trying to use streams, I also had to find out if the Zip file format supported streams. After a bit of searching, I found the structure of a Zip file.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/29/e41183f2a242427e9e4e7a6938e5425b.png" alt="Zip file structure diagram"></p>
<p>Image from Florian Buchholz&rsquo;s article <a href="https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip-printable.html">The structure of a PKZip file</a>.</p>
<p>Simply put, a Zip is a packing pattern in which each file contains three parts.</p>
<ol>
<li>local file header</li>
<li>File data</li>
<li>data descriptor</li>
</ol>
<p>After all the data is saved, there are three additional sections of information at the end of the file:</p>
<ol>
<li>Archive description header</li>
<li>Archive extra data record</li>
<li>central directory</li>
</ol>
<p>The last of these is the Central directory, which holds information about the directory of each file. They are referenced as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/29/780bd626468b46539af1f3750098a965.png" alt="Zip file structure reference relationship diagram"></p>
<p>Image from David Fifield&rsquo;s article <a href="https://www.bamsoftware.com/hacks/zipbomb/">A better zip bomb</a></p>
<p>By this point, I was able to determine that Zip files do support streaming.</p>
<p>Now the idea is clear. First, we create a new file via the <code>showSaveFilePicker</code> interface and get the corresponding WriteStream, then we create a Zip file Stream and bind to it, and finally we download the image using fetch in turn, redirecting the corresponding ReadeStream to the previous Zip Stream.</p>
<p>The operation of creating a file is relatively simple.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">types</span><span class="o">:</span> <span class="p">[{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">description</span><span class="o">:</span> <span class="s1">&#39;Zip file&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">accept</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;application/zip&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;.zip&#39;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">  <span class="p">}],</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">file</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">showSaveFilePicker</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">writeStream</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">file</span><span class="p">.</span><span class="nx">createWritable</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then it&rsquo;s time to create the Zip file stream. Here I borrowed the <a href="https://github.com/jimmywarting/StreamSaver.js/blob/master/examples/zip-stream.js">implementation</a> from StreamSaver.js.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">zipStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ZIP</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="kr">async</span> <span class="nx">pull</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;https://d8d913s460fub.cloudfront.net/videoserver/cat-test-video-320x240.mp4&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">body</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;streamsaver-zip-example/cat.mp4&#39;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">ctrl</span><span class="p">.</span><span class="nx">enqueue</span><span class="p">({</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">stream</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">ctrl</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">zipStream</span><span class="p">.</span><span class="nx">pipeTo</span><span class="p">(</span><span class="nx">writeStream</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since it is pure front-end code, you can experience the effect of using this solution in Chrome.</p>
<p>Since Firefox does not support the File System Access API, the solution presented in this article will not work within Firefox. If you must support Firefox, you can use the aforementioned StreamSaver.js.</p>
<p>The idea of StreamSaver.js is also very <a href="https://github.com/jimmywarting/StreamSaver.js#how-does-it-work">clever</a>. It uses a service worker to intercept the fetch call and write the Zip stream to the file to be downloaded via respondWith. The advantage of this solution is that it supports browsers such as Firefox, but the disadvantage is also obvious: the whole implementation is very complex and needs to deal with logic such as communication with the service worker and worker retention. In comparison, the solution based on the File System Access API is significantly cleaner.</p>
<p>Finally, a reminder that the Zip format does not specify the encoding of the file name. If the exported file name has Chinese characters, it may be garbled. Therefore, for Windows platform, it is recommended to convert to GBK encoding. The zip-stream library used in this article only supports UTF-8 encoding.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/chrome/">Chrome</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/linux-blocking-io/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Linux Blocking IO</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/gomacro/">
            <span class="next-text nav-default">Using the Go language as a script - gomacro</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
