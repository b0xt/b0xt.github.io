<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>libvirt Principles and Practices - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the principles of libvirt and put them into practice." /><meta name="keywords" content="libvirt" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/libvirt/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="libvirt Principles and Practices" />
<meta property="og:description" content="Learn the principles of libvirt and put them into practice." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/libvirt/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-01T18:44:01+08:00" />
<meta property="article:modified_time" content="2022-05-01T18:44:01+08:00" />

<meta itemprop="name" content="libvirt Principles and Practices">
<meta itemprop="description" content="Learn the principles of libvirt and put them into practice."><meta itemprop="datePublished" content="2022-05-01T18:44:01+08:00" />
<meta itemprop="dateModified" content="2022-05-01T18:44:01+08:00" />
<meta itemprop="wordCount" content="5952">
<meta itemprop="keywords" content="libvirt," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="libvirt Principles and Practices"/>
<meta name="twitter:description" content="Learn the principles of libvirt and put them into practice."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">libvirt Principles and Practices</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-01 18:44:01 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 5952 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-libvirt">What is Libvirt</a>
          <ul>
            <li><a href="#libvirt-c-api">Libvirt C API</a></li>
            <li><a href="#libvirt-xml-definitions">Libvirt XML Definitions</a></li>
            <li><a href="#libvirt-api-implementation">Libvirt API implementation</a></li>
          </ul>
        </li>
        <li><a href="#principle-implementation">Principle implementation</a>
          <ul>
            <li><a href="#overall-architecture">Overall architecture</a></li>
            <li><a href="#code-implementation">Code Implementation</a></li>
            <li><a href="#cross-reference">Cross-reference</a></li>
          </ul>
        </li>
        <li><a href="#practice">Practice</a>
          <ul>
            <li><a href="#installing-a-kvm-environment">Installing a kvm environment</a></li>
            <li><a href="#install-the-virtual-machine">Install the virtual machine</a></li>
            <li><a href="#view-the-virtual-machine">View the virtual machine</a></li>
            <li><a href="#basic-virtual-machine-operations">Basic virtual machine operations</a></li>
            <li><a href="#create-virtual-machines-by-mirroring">Create virtual machines by mirroring</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Libvirt is a set of open source software tools developed by Redhat. The goal is to provide a common and stable software library to manage virtual machines on a node efficiently and securely, and to support remote operations. Libvirt shields different virtualization implementations and provides a unified management interface. Users only care about the high-level functions, and the implementation details of VMM should be transparent to end users. libvirt then acts as a bridge between VMM and high-level functions, receiving user requests and then calling the interface provided by VMM to do the final work.</p>
<h2 id="what-is-libvirt">What is Libvirt</h2>
<p>Why do I need Libvirt?</p>
<ol>
<li>Hypervisor such as qemu-kvm has many parameters for command line virtual machine management tools and is difficult to use.</li>
<li>There are many different Hypervisors and no unified programming interface to manage them, which is very important for cloud environments.</li>
<li>there is no uniform way to easily define the various manageable objects associated with VMs.</li>
</ol>
<p>What does Libvirt provide?</p>
<ol>
<li>It provides a unified, stable, open-source application programming interface (API), a daemon (libvirtd), and a default command-line management tool (virsh).</li>
<li>It provides management of the virtualized client and its virtualized devices, network and storage.</li>
<li>It provides a more stable set of application programming interfaces in C. Currently, bindings to libvirt are provided in a number of other popular programming languages, and there are already libvirt libraries available directly in Python, Perl, Java, Ruby, PHP, OCaml, and other high-level programming languages.</li>
<li>Its support for many different Hypervisors is implemented through a driver-based architecture. libvirt provides different drivers for different Hypervisors, including a driver for Xen, a QEMU driver for QEMU/KVM, a VMware driver, and so on. Driver source code files like qemu_driver.c, xen_driver.c, xenapi_driver.c, vmware_driver.c, vbox_driver.c can be easily found in the libvirt source code.</li>
<li>It acts as an intermediate adaptation layer, allowing the underlying Hypervisor to be completely transparent to the management tools in the upper user space, because libvirt shields the details of the underlying Hypervisor and provides a unified, more stable interface (API) for the upper management tools.</li>
<li>It uses XML to define various virtual machine-related managed objects.</li>
</ol>
<p>Currently, libvirt has become the most widely used tool and API for managing various virtual machines, and some common virtual machine management tools (e.g. virsh, virt-install, virt-manager, etc.) and cloud computing framework platforms (e.g. OpenStack, OpenNebula, Eucalyptus, etc.) all use libvirt APIs on the underlying.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/8174da6fb46a42549fa356ab2a953432.png" alt="libvirt">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/3472e3901d9746f782c6e51b921e52bd.png" alt="libvirt"></p>
<h3 id="libvirt-c-api">Libvirt C API</h3>
<h4 id="main-objects-managed-by-the-libvirti-api">Main objects managed by the Libvirti API</h4>
<table>
<thead>
<tr>
<th>Object</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Domain</td>
<td>refers to an instance of an operating system (often a virtual machine) running on a virtual machine provided by the Hypervisor or the configuration used to start the virtual machine.</td>
</tr>
<tr>
<td>Hypervisor</td>
<td>a software layer of a virtualized host</td>
</tr>
<tr>
<td>Node (host)</td>
<td>a physical server.</td>
</tr>
<tr>
<td>Storage pool</td>
<td>A collection of storage media, such as physical hard drives. A storage pool is divided into small containers called volumes. Volumes are distributed to one or more virtual machines.</td>
</tr>
<tr>
<td>Volume</td>
<td>A storage space allocated from a storage pool. A volume is divided into one or more domains, often becoming a virtual hard drive within a domain.</td>
</tr>
</tbody>
</table>
<h4 id="management-model-of-objects">Management model of objects</h4>
<table>
<thead>
<tr>
<th>Object Name</th>
<th>Object</th>
<th>Python Class</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Connect</td>
<td>Connection to Hypervisor</td>
<td>virConnectPtr</td>
<td>Before any API can be called to manage a local or remote Hypervisor, a connection to that Hypervisor must be established.</td>
</tr>
<tr>
<td>Domain</td>
<td>Guest domain</td>
<td>virDomainPtr</td>
<td>Used to enumerate and manage existing virtual machines, or to create new ones. Unique identifier: ID,Name, UUID. a domain may be temporary or persistent. A temporary domain can only be managed for the duration of its operation. A persistent domain has its configuration stored on the host.</td>
</tr>
<tr>
<td>Virtual Network</td>
<td>Virtual Network</td>
<td>virNetworkPtr</td>
<td>The network device used to manage the virtual machines. A virtual network may be temporary or persistent. When libvirt is installed on each host, it has a default network device, &ldquo;default&rdquo;. It provides DHCP services to the virtual machines running on that host, and connects to the host via NAT.</td>
</tr>
<tr>
<td>Storage Pool</td>
<td>Storage Pool</td>
<td>virStoragePoolPtr</td>
<td>Used to manage all storage within a virtual machine. This includes local disk, logical volume group, iSCSI target, FibreChannel HBA and local/network file system. unique identifier: Name, UUID. a storage pool may be temporary or persistent. the type of Pool can be be dir, fs, netfs, disk, iscsi, logical, scsi,mpath, rbd, sheepdog, gluster or zfs.</td>
</tr>
<tr>
<td>Storage Volume</td>
<td>Storage Volume</td>
<td>virStorageVolPtr</td>
<td>Used to manage storage blocks within a storage pool, including blocks allocated within a pool, disk partitions, logical volumes, SCSI/iSCSI Lun, or files within a local or network file system, etc. Unique identifier: Name, Key, Path</td>
</tr>
<tr>
<td>Host device</td>
<td>Host device</td>
<td>virNodeDevPtr</td>
<td>Used to manage the physical hardware devices on the host, including NIC, disk, diskcontroller, sound card, etc. Unique identifier: Name.</td>
</tr>
</tbody>
</table>
<h3 id="libvirt-xml-definitions">Libvirt XML Definitions</h3>
<p>Libvirt uses XML to define various objects, detailed XML definitions are described at <a href="https://libvirt.org/format.html">https://libvirt.org/format.html</a> Several major objects are listed here.</p>
<h4 id="disk">disk</h4>
<p>Any disk device, including floppy, hard disk, cdrom, or semi-virtualized drives are defined using the elements.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;**&#39;</span> <span class="na">device=</span><span class="s">&#39;**&#39;</span><span class="nt">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Where.</p>
<ul>
<li><code>type</code> is used to specify the type of device source: <code>file</code> , <code>block</code> , <code>dir</code> , <code>network</code> or <code>volume</code>. The specific source is defined by the tag.</li>
<li><code>device</code> is used to specify the type of device target: <code>floppy</code> , <code>disk</code> , <code>cdrom</code> , and &ldquo;lun&rdquo;, default is <code>disk</code>. The specific target is defined by the label.</li>
</ul>
<h5 id="volume-type-disk">volume type disk</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;volume&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;source</span> <span class="na">pool=</span><span class="s">&#39;blk-pool0&#39;</span> <span class="na">volume=</span><span class="s">&#39;blk-pool0-vol0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hdk&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/disk&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="file-type-disk">file type disk</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">snapshot=</span><span class="s">&#39;external&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#34;tap&#34;</span> <span class="na">type=</span><span class="s">&#34;aio&#34;</span> <span class="na">cache=</span><span class="s">&#34;default&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/var/lib/xen/images/fv0&#39;</span> <span class="na">startupPolicy=</span><span class="s">&#39;optional&#39;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hda&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/disk&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="block-type-disk">block type disk</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;block&#39;</span> <span class="na">device=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hdd&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span> <span class="na">tray=</span><span class="s">&#39;open&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;readonly/&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/disk&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="network-type-disk">network type disk</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span> <span class="na">device=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;source</span> <span class="na">protocol=</span><span class="s">&#34;http&#34;</span> <span class="na">name=</span><span class="s">&#34;url_path&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&lt;host</span> <span class="na">name=</span><span class="s">&#34;hostname&#34;</span> <span class="na">port=</span><span class="s">&#34;80&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hde&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span> <span class="na">tray=</span><span class="s">&#39;open&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;readonly/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/disk&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="host-device-assignment">host device assignment</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">&#39;subsystem&#39;</span> <span class="na">type=</span><span class="s">&#39;usb&#39;</span><span class="nt">&gt;</span> #USB 设备直接分配
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;source</span> <span class="na">startupPolicy=</span><span class="s">&#39;optional&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;vendor</span> <span class="na">id=</span><span class="s">&#39;0x1234&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;product</span> <span class="na">id=</span><span class="s">&#39;0xbeef&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;boot</span> <span class="na">order=</span><span class="s">&#39;2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/hostdev&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">&#39;subsystem&#39;</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">managed=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span> #PCI 设备直接分配
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;source&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x06&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x02&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;boot</span> <span class="na">order=</span><span class="s">&#39;1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;rom</span> <span class="na">bar=</span><span class="s">&#39;on&#39;</span> <span class="na">file=</span><span class="s">&#39;/etc/fake/boot.bin&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&lt;/hostdev&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="network-interface">network interface</h4>
<p>There are several interface types.</p>
<ol>
<li>
<p>type = &rsquo;network&rsquo; defines an interface that connects to the Virtual network</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;devices&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;default&#39;</span><span class="nt">/&gt;</span> #虚拟网络的名称为 &#39;default&#39;
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;default&#39;</span> <span class="na">portgroup=</span><span class="s">&#39;engineering&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vnet7&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#34;00:11:22:33:44:55&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;virtualport&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;parameters</span> <span class="na">instanceid=</span><span class="s">&#39;09b11c53-8b5c-4eeb-8f00-d84eaa0aaa4f&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/virtualport&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/devices&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virsh：attach-interface --domain d-2 --type network --source isolatednet1 --mac 52:53:00:4b:75:6f --config</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>type=&lsquo;birdge&rsquo; Define a Bridge to LAN (bridge to physical network) interface: provided that a bridge exists on the host and the bridge is already connected to the physical LAN.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span> #连接到 br0
</span></span><span class="line"><span class="cl"><span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">&#39;br0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span> #连接到br1
</span></span><span class="line"><span class="cl"><span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">&#39;br1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vnet7&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#34;00:11:22:33:44:55&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span> #连接到 Open vSwithc bridge ovsbr
</span></span><span class="line"><span class="cl"><span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">&#39;ovsbr&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;virtualport</span> <span class="na">type=</span><span class="s">&#39;openvswitch&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;parameters</span> <span class="na">profileid=</span><span class="s">&#39;menial&#39;</span> <span class="na">interfaceid=</span><span class="s">&#39;09b11c53-8b5c-4eeb-8f00-d84eaa0aaa4f&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/virtualport&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/interface&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1">#virsh：attach-interface --domain d-2 --type bridge --source virbr0 --mac 52:22:33:44:55:66 --config</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>type=&lsquo;ethernet&rsquo; Define an interface that connects to the LAN using the specified script</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;devices&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;ethernet&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vnet7&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;script</span> <span class="na">path=</span><span class="s">&#39;/etc/qemu-ifup-mynet&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/devices&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>type=&lsquo;direct&rsquo; Define a direct attachment to physical interface: requires Linux macvtap driver support</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;direct&#39;</span> <span class="na">trustGuestRxFilters=</span><span class="s">&#39;no&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">&#39;eth0&#39;</span> <span class="na">mode=</span><span class="s">&#39;vepa&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/interface&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>type=&lsquo;hostdev&rsquo; Defines an interface that is directly assigned by the host PCI NIC (PCI Passthrough): assigns the host NIC to the virtual machine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;devices&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;hostdev&#39;</span> <span class="na">managed=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;vfio&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;source&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x07&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;52:54:00:6d:90:02&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;virtualport</span> <span class="na">type=</span><span class="s">&#39;802.1Qbh&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;parameters</span> <span class="na">profileid=</span><span class="s">&#39;finance&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/virtualport&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/devices&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="network">network</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">&#34;virbr0&#34;</span> <span class="na">stp=</span><span class="s">&#34;on&#34;</span> <span class="na">delay=</span><span class="s">&#34;5&#34;</span> <span class="na">macTableManager=</span><span class="s">&#34;libvirt&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;domain</span> <span class="na">name=</span><span class="s">&#34;example.com&#34;</span> <span class="na">localOnly=</span><span class="s">&#34;no&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#34;nat&#34;</span> <span class="na">dev=</span><span class="s">&#34;eth0&#34;</span><span class="nt">/&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>bridge: Define a bridge used to construct this virtual network.</li>
<li>domain: Define the DNS domain of the DHCP server.</li>
<li>forward: Defines how the virtual network connects directly to the physical LAN. &ldquo;mode&rdquo; means forwarding mode.</li>
</ul>
<ol>
<li>
<p>mode=&lsquo;nat&rsquo;: All virtual networks connected to this virtual network will pass through the physical machine&rsquo;s NIC and be converted to the physical NIC&rsquo;s address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;network&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>default<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">&#34;virbr0&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#34;nat&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ip</span> <span class="na">address=</span><span class="s">&#34;192.168.122.1&#34;</span> <span class="na">netmask=</span><span class="s">&#34;255.255.255.0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dhcp&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;range</span> <span class="na">start=</span><span class="s">&#34;192.168.122.2&#34;</span> <span class="na">end=</span><span class="s">&#34;192.168.122.254&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dhcp&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ip&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ip</span> <span class="na">family=</span><span class="s">&#34;ipv6&#34;</span> <span class="na">address=</span><span class="s">&#34;2001:db8:ca2:2::1&#34;</span> <span class="na">prefix=</span><span class="s">&#34;64&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/network&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can also specify a public IP address and port number.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#39;nat&#39;</span><span class="nt">&gt;&lt;nat&gt;&lt;address</span> <span class="na">start=</span><span class="s">&#39;1.2.3.4&#39;</span> <span class="na">end=</span><span class="s">&#39;1.2.3.10&#39;</span><span class="nt">/&gt;</span> <span class="nt">&lt;/nat&gt;</span> <span class="nt">&lt;/forward&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#39;nat&#39;</span><span class="nt">&gt;&lt;nat&gt;&lt;port</span> <span class="na">start=</span><span class="s">&#39;500&#39;</span> <span class="na">end=</span><span class="s">&#39;1000&#39;</span><span class="nt">/&gt;&lt;/nat&gt;&lt;/forward&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>mode=&lsquo;route&rsquo;: similar to NAT, but instead of using NAT, you use routing table.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;network&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>local<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">&#34;virbr1&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#34;route&#34;</span> <span class="na">dev=</span><span class="s">&#34;eth1&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ip</span> <span class="na">address=</span><span class="s">&#34;192.168.122.1&#34;</span> <span class="na">netmask=</span><span class="s">&#34;255.255.255.0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dhcp&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;range</span> <span class="na">start=</span><span class="s">&#34;192.168.122.2&#34;</span> <span class="na">end=</span><span class="s">&#34;192.168.122.254&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dhcp&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ip&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ip</span> <span class="na">family=</span><span class="s">&#34;ipv6&#34;</span> <span class="na">address=</span><span class="s">&#34;2001:db8:ca2:2::1&#34;</span> <span class="na">prefix=</span><span class="s">&#34;64&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/network&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>mode=&lsquo;bridge&rsquo;: use a bridge that is not managed by libvirt, such as an existing bridge on the host; open vswitch bridge; use macvtap&rsquo;s &ldquo;bridge&rdquo; mode</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;network&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;name&gt;</span>host-bridge<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#34;bridge&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">&#34;br0&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/network&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>mode=&lsquo;passthrough&rsquo;: Use a macvtap &ldquo;direct&rdquo; connection in &ldquo;passthrough&rdquo; mode to specify a specific NIC on the host for virtual networking</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#39;passthrough&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">dev=</span><span class="s">&#39;eth10&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">dev=</span><span class="s">&#39;eth11&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">dev=</span><span class="s">&#39;eth12&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">dev=</span><span class="s">&#39;eth13&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">dev=</span><span class="s">&#39;eth14&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/forward&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>mode=&lsquo;hostdev&rsquo;: Directly assign the network device on the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;forward</span> <span class="na">mode=</span><span class="s">&#39;hostdev&#39;</span> <span class="na">managed=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;vfio&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;4&#39;</span> <span class="na">slot=</span><span class="s">&#39;0&#39;</span> <span class="na">function=</span><span class="s">&#39;1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;4&#39;</span> <span class="na">slot=</span><span class="s">&#39;0&#39;</span> <span class="na">function=</span><span class="s">&#39;2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;4&#39;</span> <span class="na">slot=</span><span class="s">&#39;0&#39;</span> <span class="na">function=</span><span class="s">&#39;3&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/forward&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="libvirt-api-implementation">Libvirt API implementation</h3>
<p>The libvirt API is implemented in the individual Hypervisor drivers and Storage dirver.</p>
<p>The Hypervisor drivers include.</p>
<ul>
<li><strong><a href="https://libvirt.org/drvlxc.html">LXC</a></strong> - Linux Containers</li>
<li><strong><a href="https://libvirt.org/drvopenvz.html">OpenVZ</a></strong></li>
<li><strong><a href="https://libvirt.org/drvqemu.html">QEMU</a></strong></li>
<li><strong><a href="https://libvirt.org/drvtest.html">Test</a></strong> - Used for testing</li>
<li><strong><a href="https://libvirt.org/drvuml.html">UML</a></strong> - User Mode Linux</li>
<li><strong><a href="https://libvirt.org/drvvbox.html">VirtualBox</a></strong></li>
<li><strong><a href="https://libvirt.org/drvesx.html">VMware ESX</a></strong></li>
<li><strong><a href="https://libvirt.org/drvvmware.html">VMware Workstation/Player</a></strong></li>
<li><strong><a href="https://libvirt.org/drvxen.html">Xen</a></strong></li>
<li><strong><a href="https://libvirt.org/drvhyperv.html">Microsoft Hyper-V</a></strong></li>
<li><strong><a href="https://libvirt.org/drvphyp.html">IBM PowerVM (phyp)</a></strong></li>
<li><strong><a href="https://libvirt.org/drvparallels.html">Parallels</a></strong></li>
<li><strong><a href="https://libvirt.org/drvbhyve.html">Bhyve</a></strong> - The BSD Hypervisor</li>
</ul>
<h2 id="principle-implementation">Principle implementation</h2>
<h3 id="overall-architecture">Overall architecture</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/881d5a427e02400cabf409be47384702.png" alt="Overall architecture"></p>
<h4 id="kvm">kvm</h4>
<p>kvm is a module of the linux kernel that requires hardware-assisted virtualization technologies, such as Intel-VT for cpu, AMD-V; memory-related technologies such as Intel&rsquo;s EPT and AMD&rsquo;s RVI. guest OS CPU instructions do not have to be translated by Qemu and run directly, greatly increasing speed. kvm exposes the interface through <code>/dev/kvm</code>. User programs can access this interface via the ioctl function. See the following pseudo-code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="nb">open</span><span class="p">(</span><span class="s2">&#34;/dev/kvm&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ioctl</span><span class="p">(</span><span class="n">KVM_CREATE_VM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ioctl</span><span class="p">(</span><span class="n">KVM_CREATE_VCPU</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ioctl</span><span class="p">(</span><span class="n">KVM_RUN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">switch</span> <span class="p">(</span><span class="n">exit_reason</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">case</span> <span class="n">KVM_EXIT_IO</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="n">case</span> <span class="n">KVM_EXIT_HLT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The kvm <strong>kernel module itself can only provide virtualization of cpu and memory</strong>, so it must be paired with QEMU to form a complete virtualization technology, which is the following qemu-kvm.</p>
<h4 id="qemu">qemu</h4>
<p>Qemu is an emulator that simulates hardware to the Guest OS, which thinks it is dealing directly with the hardware, but is actually dealing with the hardware simulated by Qemu, which translates these instructions to the real hardware. Since all the hardware has to pass through Qemu, the performance is poor.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/04003dd37280462ca1994d6465f12637.png" alt="qemu"></p>
<h4 id="qemu-kvm">qemu-kvm</h4>
<p>Qemu integrates kvm, calls the /dev/kvm interface via ioctl, and leaves the cpu instructions to the kernel module. kvm is responsible for cpu virtualization + memory virtualization, but kvm cannot emulate other devices. qemu emulates IO devices (NICs, disks, etc.), and kvm with Qemu makes it possible to virtualize servers in the true sense. It is called qemu-kvm because it uses both of these things.</p>
<h4 id="virtio">virtio</h4>
<p>Qemu emulates I/O devices, which also affects the performance of these devices, so semi-virtualized devices virtio_blk and virtio_net are created to improve device performance.</p>
<h4 id="libvirt">Libvirt</h4>
<p>libvirt is the most widely used tool and API for managing kvm virtual machines</p>
<ul>
<li>Libvirtd is a daemon process that can be called locally by virsh or remotely by virsh</li>
<li>Libvirtd calls qemu-kvm to operate the KVM virtual machine</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/40922123a3cf4bab89aaac34e727574b.png" alt="Libvirt"></p>
<h3 id="code-implementation">Code Implementation</h3>
<p>The main objects defined in the Libvirt code are shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/9df9fdc22a7e4b0789e8d361c2606008.png" alt="main objects"></p>
<ol>
<li>VirConnectPtr: represents a connection established by a specific VMM. Every Libvirt-based application should first provide a URI to specify a particular VMM locally or remotely to get a VirConnectPtr connection. For example, xen+ssh: //host-virt/ represents a Xen VMM running on a host-virt machine via ssh. After getting a virConnectPtr connection, the application can manage the virtual machines of this VMM and the corresponding virtualization resources, such as storage and network.</li>
<li>VirDomainPtr: represents a virtual machine, which may be active or just defined.</li>
<li>VirNetworkPtr: represents a network</li>
<li>VirStorageVolPtr: represents a storage volume, usually used as a block device by a virtual machine.</li>
<li>VirStoragePoolPtr: represents a storage pool, which is used to allocate and manage logical areas of storage volumes.</li>
</ol>
<h4 id="communication-between-local-machines">Communication between local machines</h4>
<p>During the initialization process, all drivers are enumerated and registered. Each Driver loads specific functions to be called by the Libvirt API. As shown in the figure below, the Application calls the Public API through a URI, and then the Public API is implemented by calling the real Driver using the API interface provided by the Driver.</p>
<h4 id="communication-between-remote-hosts">Communication between remote hosts</h4>
<p>Libvirt aims to support remote management, so access to Libvirt&rsquo;s drivers is handled by the Libvirt daemon libvirtd, which is deployed on the node running the virtual machine and managed by the remote Driver on the opposite end via RPC, as shown in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/01/04a911eafe3e49a4b4bb4342825e2ca2.png" alt="Libvirt"></p>
<p>In remote management mode, virConnectionPtr actually connects the local remote Driver to the remote specific Driver. all calls reach libvirtd on the cloud first via the remote Driver, and libvirtd accesses the corresponding Driver.</p>
<h3 id="cross-reference">Cross-reference</h3>
<p><a href="http://wiki.libvirt.org/page/QEMUSwitchToLibvirt">here</a> has a cross-reference to the virsh command, the Libvirt C API, the QEMU driver method and the QEMU Monitor command (in part).</p>
<table>
<thead>
<tr>
<th>virsh command</th>
<th>Public API</th>
<th>QEMU driver function</th>
<th>Monitor command</th>
</tr>
</thead>
<tbody>
<tr>
<td>virsh create XMLFILE</td>
<td>virDomainCreateXML()</td>
<td>qemudDomainCreate()</td>
<td>info cpus, cont, change vnc password, balloon (all indirectly)</td>
</tr>
<tr>
<td>virsh suspend GUEST</td>
<td>virDomainSuspend()</td>
<td>qemudDomainSuspend()</td>
<td>stop</td>
</tr>
<tr>
<td>virsh resume GUEST</td>
<td>virDomainResume()</td>
<td>qemudDomainResume()</td>
<td>cont</td>
</tr>
<tr>
<td>virsh shutdown GUEST</td>
<td>virDomainShutdown()</td>
<td>qemudDomainShutdown()</td>
<td>system_powerdown</td>
</tr>
<tr>
<td>virsh setmem GUEST MEM-KB</td>
<td>virDomainSetMemory()</td>
<td>qemudDomainSetMemory()</td>
<td>balloon (indirectly)</td>
</tr>
<tr>
<td>virsh dominfo GUEST</td>
<td>virDomainGetInfo()</td>
<td>qemudDomainGetInfo()</td>
<td>info balloon (indirectly)</td>
</tr>
<tr>
<td>virsh save GUEST FILENAME</td>
<td>virDomainSave()</td>
<td>qemudDomainSave()</td>
<td>stop, migrate exec</td>
</tr>
<tr>
<td>virsh restore FILENAME</td>
<td>virDomainRestore()</td>
<td>qemudDomainRestore()</td>
<td>cont</td>
</tr>
<tr>
<td>virsh dumpxml GUEST</td>
<td>virDomainDumpXML()</td>
<td>qemudDomainDumpXML()</td>
<td>info balloon (indirectly)</td>
</tr>
<tr>
<td>virsh attach-device GUEST XMLFILE</td>
<td>virDomainAttachDevice()</td>
<td>qemudDomainAttachDevice()</td>
<td>change, eject, usb_add, pci_add (all indirectly)</td>
</tr>
<tr>
<td>virsh detach-device GUEST XMLFILE</td>
<td>virDomainDetachDevice()</td>
<td>qemudDomainDetachDevice()</td>
<td>pci_del (indirectly)</td>
</tr>
<tr>
<td>virsh migrate GUEST DEST-URI</td>
<td>virDomainMigrate()</td>
<td>qemudDomainMigratePerform()</td>
<td>stop, migrate_set_speed, migrate, cont</td>
</tr>
<tr>
<td>virsh domblkstat GUEST</td>
<td>virDomainBlockStats()</td>
<td>qemudDomainBlockStats()</td>
<td>info blockstats</td>
</tr>
<tr>
<td>-</td>
<td>virDomainBlockPeek()</td>
<td>qemudDomainMemoryPeek()</td>
<td>memsave</td>
</tr>
</tbody>
</table>
<h2 id="practice">Practice</h2>
<h3 id="installing-a-kvm-environment">Installing a kvm environment</h3>
<p>KVM is an open source, Linux-native, fully virtualized solution for X86 hardware based on virtualization extensions (Intel VT or AMD-V). in KVM, virtual machines are implemented as regular Linux processes that are scheduled by standard Linux schedulers; each virtual CPU of a virtual machine is implemented as a regular Linux process. This allows the KMV to use the existing functionality of the Linux kernel. However, KVM itself does not perform any hardware emulation and requires a client space application to set up a client virtual server&rsquo;s address space via the /dev/kvm interface, provide it with emulated I/O, and map its video display back to the host&rsquo;s display. This application is currently QEMU.</p>
<p>Kvm related installation packages and their roles:</p>
<ul>
<li>qemu-kvm The main kvm package</li>
<li>python-virtinst Command line tools and libraries needed to create virtual machines</li>
<li>virt-manager GUI interface for managing virtual machines (can manage remote kvm hosts)</li>
<li>virt-viewer: Interact directly with the virtual machine through the GUI interface (can manage remote kvm hosts)</li>
<li>virsh: libvirt-based command line tool (CLI)</li>
<li>virt-top virtual machine statistics command</li>
<li>virt-viewer GUI connection to a configured virtual machine</li>
<li>libvirt: Provides simple and unified tools and APIs for managing virtual machines, shielding the underlying complex structure. (supports qemu-kvm/virtualbox/vmware)</li>
<li>libvirt-client A c-language toolkit for virtual clients</li>
<li>virt-install Virtual machine creation command based on libvirt services</li>
<li>bridge-utils Tools for creating and managing bridged devices</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 安装qemu libvirt</span>
</span></span><span class="line"><span class="cl">yum -y install qemu-kvm qemu-img libvirt virt-install bridge-utils virt-manager
</span></span><span class="line"><span class="cl"><span class="c1"># yum -y install qemu-kvm-tools 没找到</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看kvm模块是否被正确加载</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos ~<span class="o">]</span><span class="c1"># lsmod | grep kvm</span>
</span></span><span class="line"><span class="cl">kvm_intel             <span class="m">315392</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">kvm                   <span class="m">847872</span>  <span class="m">1</span> kvm_intel
</span></span><span class="line"><span class="cl">irqbypass              <span class="m">16384</span>  <span class="m">1</span> kvm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 开启kvm服务,并且设置其开自动启动</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos ~<span class="o">]</span><span class="c1"># systemctl enable libvirtd</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos ~<span class="o">]</span><span class="c1"># systemctl start libvirtd</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos ~<span class="o">]</span><span class="c1"># systemctl status libvirtd</span>
</span></span><span class="line"><span class="cl">● libvirtd.service - Virtualization daemon
</span></span><span class="line"><span class="cl">   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/libvirtd.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Active: active <span class="o">(</span>running<span class="o">)</span> since Thu 2022-02-24 16:58:36 CST<span class="p">;</span> 6s ago
</span></span><span class="line"><span class="cl">     Docs: man:libvirtd<span class="o">(</span>8<span class="o">)</span>
</span></span><span class="line"><span class="cl">           https://libvirt.org
</span></span><span class="line"><span class="cl"> Main PID: <span class="m">16881</span> <span class="o">(</span>libvirtd<span class="o">)</span>
</span></span><span class="line"><span class="cl">    Tasks: <span class="m">19</span> <span class="o">(</span>limit: 32768<span class="o">)</span>
</span></span><span class="line"><span class="cl">   Memory: 14.8M
</span></span><span class="line"><span class="cl">   CGroup: /system.slice/libvirtd.service
</span></span><span class="line"><span class="cl">           ├─16881 /usr/sbin/libvirtd --timeout <span class="m">120</span>
</span></span><span class="line"><span class="cl">           ├─17009 /usr/sbin/dnsmasq --conf-file<span class="o">=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span class="o">=</span>/&gt;
</span></span><span class="line"><span class="cl">           └─17011 /usr/sbin/dnsmasq --conf-file<span class="o">=</span>/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script<span class="o">=</span>/&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置一下语言环境</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos ~<span class="o">]</span><span class="c1"># LANG=&#34;en_US.UTF-8&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Create a directory /data under the root, (do not put the virtual machine files in /root or root mainly because after the virtual machine starts qemu these users do not have permission to read the virtual machine configuration files under /root or root)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># mkdir /data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cd /data</span>
</span></span><span class="line"><span class="cl"><span class="c1"># wget http://mirrors.ustc.edu.cn/centos/7/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="install-the-virtual-machine">Install the virtual machine</h3>
<p>Before installation, set the environment language to English LANG=&ldquo;en_US.UTF-8&rdquo;, if it is Chinese, some versions may report an error.</p>
<p>kvm to create a virtual machine, pay special attention to the .iso image file must be placed in /data or root directory to recreate the directory, otherwise it will be unable to create a virtual machine because of permission errors.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 创建一个虚拟磁盘, -f指定格式, 路径是/data/kvm.qcow2 ,大小为30G</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos data<span class="o">]</span><span class="c1"># qemu-img create -f qcow2 -o preallocation=metadata /data/kvm.qcow2 30G</span>
</span></span><span class="line"><span class="cl">Formatting <span class="s1">&#39;/data/kvm.qcow2&#39;</span>, <span class="nv">fmt</span><span class="o">=</span>qcow2 <span class="nv">size</span><span class="o">=</span><span class="m">32212254720</span> <span class="nv">cluster_size</span><span class="o">=</span><span class="m">65536</span> <span class="nv">preallocation</span><span class="o">=</span>metadata <span class="nv">lazy_refcounts</span><span class="o">=</span>off <span class="nv">refcount_bits</span><span class="o">=</span><span class="m">16</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>First learn the virt-install command, use -help to view it here, and learn only the important ones, the others can be learned later.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virt-install -help</span>
</span></span><span class="line"><span class="cl">-n <span class="o">(</span>name<span class="o">)</span> : 指定虚拟机的名称
</span></span><span class="line"><span class="cl">-memory <span class="o">(</span>-raw<span class="o">)</span> : 指定内存大小
</span></span><span class="line"><span class="cl">-cpu : 指定CPU的核数<span class="o">(</span>默认为1<span class="o">)</span>
</span></span><span class="line"><span class="cl">-cdrom : 指定镜像
</span></span><span class="line"><span class="cl">-disk: 指定磁盘路径<span class="o">(</span>即预先创建的虚拟磁盘<span class="o">)</span>
</span></span><span class="line"><span class="cl">-virt-type : 指定虚拟机类型<span class="o">(</span>kvm, qemu , xen<span class="o">)</span>
</span></span><span class="line"><span class="cl">-network : 指定网络类型
</span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the create virtual machine command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virt-install --virt-type=kvm --name=centos --vcpus=2 --memory=4096 --location=/data/CentOS-7-x86_64-Minimal-2009.iso --disk path=/data/kvm.qcow2,size=20,format=qcow2 --network network=default  --graphics none --extra-args=&#39;console=ttyS0&#39; --force</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Starting install...
</span></span><span class="line"><span class="cl">Retrieving file vmlinuz...                                                                     <span class="p">|</span> 6.5 MB  00:00:00
</span></span><span class="line"><span class="cl">Retrieving file initrd.img...                                                                  <span class="p">|</span>  <span class="m">53</span> MB  00:00:00
</span></span><span class="line"><span class="cl">Connected to domain centos
</span></span><span class="line"><span class="cl">Escape character is ^<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.020055<span class="o">]</span> Freeing initrd memory: 53840k freed
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.032322<span class="o">]</span> PCI-DMA: Using software bounce buffering <span class="k">for</span> IO <span class="o">(</span>SWIOTLB<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.033010<span class="o">]</span> software IO TLB <span class="o">[</span>mem 0x78b3c000-0x7cb3c000<span class="o">]</span> <span class="o">(</span>64MB<span class="o">)</span> mapped at <span class="o">[</span>ffff9a54f8b3c000-ffff9a54fcb3bfff<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.034101<span class="o">]</span> RAPL PMU: API unit is 2^-32 Joules, <span class="m">3</span> fixed counters, <span class="m">10737418240</span> ms ovfl timer
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.034969<span class="o">]</span> RAPL PMU: hw unit of domain pp0-core 2^-0 Joules
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.035550<span class="o">]</span> RAPL PMU: hw unit of domain package 2^-0 Joules
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.036131<span class="o">]</span> RAPL PMU: hw unit of domain dram 2^-16 Joules
</span></span><span class="line"><span class="cl"><span class="o">[</span>    4.037025<span class="o">]</span> sha1_ssse3: Using AVX2 optimized SHA-1 implementation
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above create virtual machine command eventually needs to configure the system base settings with <code>[!]</code> are basically to be configured, after the configuration is complete, you can enter the virtual machine installation process.</p>
<h3 id="view-the-virtual-machine">View the virtual machine</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看在运行的虚拟机</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@VM-64-223-centos ~<span class="o">]</span><span class="c1"># virsh list</span>
</span></span><span class="line"><span class="cl"> Id   Name     State
</span></span><span class="line"><span class="cl">------------------------
</span></span><span class="line"><span class="cl"> <span class="m">2</span>    centos   running
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># 连接到虚拟机的命令</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 如果报错,可能是安装完成之后已经在界面进入了,需要退出那个界面,再登录就好了</span>
</span></span><span class="line"><span class="cl"><span class="c1"># virsh console centos</span>
</span></span><span class="line"><span class="cl">Connected to domain centos
</span></span><span class="line"><span class="cl">Escape character is ^<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CentOS Linux <span class="m">7</span> <span class="o">(</span>Core<span class="o">)</span>
</span></span><span class="line"><span class="cl">Kernel 3.10.0-1160.el7.x86_64 on an x86_64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">localhost login: root
</span></span><span class="line"><span class="cl">Password:
</span></span><span class="line"><span class="cl">Last login: Fri Feb <span class="m">25</span> 15:39:48 on ttyS0
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1">#</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="basic-virtual-machine-operations">Basic virtual machine operations</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">virt-install          <span class="c1"># 生成kvm虚拟机</span>
</span></span><span class="line"><span class="cl">virsh list            <span class="c1"># 查看在运行的虚拟机</span>
</span></span><span class="line"><span class="cl">virsh list -all       <span class="c1"># 查看所有虚拟机</span>
</span></span><span class="line"><span class="cl">virsh dumpxml name    <span class="c1"># 查看kvm虚拟机配置文件</span>
</span></span><span class="line"><span class="cl">virsh start name      <span class="c1"># 启动kvm虚拟机</span>
</span></span><span class="line"><span class="cl">virsh shutdown name   <span class="c1"># 正常关机：</span>
</span></span><span class="line"><span class="cl">virsh destroy name    <span class="c1"># 非正常关机（相当于物理机直接拔掉电源）</span>
</span></span><span class="line"><span class="cl">virsh undefine name   <span class="c1"># 删除虚拟机，（彻底删除，找不回来了，如果想找回来，需要备份/etc/libvirt/qemu的xml文件） </span>
</span></span><span class="line"><span class="cl">virsh define file.xml <span class="c1"># 根据配置文件定义虚拟机</span>
</span></span><span class="line"><span class="cl">virsh <span class="nb">suspend</span> name    <span class="c1"># 挂起，终止</span>
</span></span><span class="line"><span class="cl">virsh resumed name    <span class="c1"># 恢复挂起状态</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">[root@VM-64-223-centos ~]# virsh dumpxml centos
</span></span><span class="line"><span class="cl"><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">&#39;kvm&#39;</span> <span class="na">id=</span><span class="s">&#39;2&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;name&gt;</span>centos<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;uuid&gt;</span>556c2f19-2c66-42c3-bedb-5e1cbc469bee<span class="nt">&lt;/uuid&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;metadata&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;libosinfo:libosinfo</span> <span class="na">xmlns:libosinfo=</span><span class="s">&#34;http://libosinfo.org/xmlns/libvirt/domain/1.0&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;libosinfo:os</span> <span class="na">id=</span><span class="s">&#34;http://centos.org/centos/7.0&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/libosinfo:libosinfo&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/metadata&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;memory</span> <span class="na">unit=</span><span class="s">&#39;KiB&#39;</span><span class="nt">&gt;</span>4194304<span class="nt">&lt;/memory&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;currentMemory</span> <span class="na">unit=</span><span class="s">&#39;KiB&#39;</span><span class="nt">&gt;</span>4194304<span class="nt">&lt;/currentMemory&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;vcpu</span> <span class="na">placement=</span><span class="s">&#39;static&#39;</span><span class="nt">&gt;</span>2<span class="nt">&lt;/vcpu&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;resource&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;partition&gt;</span>/machine<span class="nt">&lt;/partition&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/resource&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;os&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;type</span> <span class="na">arch=</span><span class="s">&#39;x86_64&#39;</span> <span class="na">machine=</span><span class="s">&#39;pc-q35-rhel8.2.0&#39;</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">&#39;hd&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/os&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;features&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;acpi/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;apic/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/features&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;cpu</span> <span class="na">mode=</span><span class="s">&#39;custom&#39;</span> <span class="na">match=</span><span class="s">&#39;exact&#39;</span> <span class="na">check=</span><span class="s">&#39;full&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;model</span> <span class="na">fallback=</span><span class="s">&#39;forbid&#39;</span><span class="nt">&gt;</span>Cascadelake-Server<span class="nt">&lt;/model&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;vendor&gt;</span>Intel<span class="nt">&lt;/vendor&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;ss&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;vmx&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;pdcm&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;hypervisor&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;tsc_adjust&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;umip&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;pku&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;md-clear&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;stibp&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;arch-capabilities&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;xsaves&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;ibpb&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;ibrs&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;amd-stibp&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;amd-ssbd&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;rdctl-no&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;ibrs-all&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;skip-l1dfl-vmentry&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;mds-no&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;pschange-mc-no&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;require&#39;</span> <span class="na">name=</span><span class="s">&#39;tsx-ctrl&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;disable&#39;</span> <span class="na">name=</span><span class="s">&#39;hle&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;disable&#39;</span> <span class="na">name=</span><span class="s">&#39;rtm&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;feature</span> <span class="na">policy=</span><span class="s">&#39;disable&#39;</span> <span class="na">name=</span><span class="s">&#39;mpx&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/cpu&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;clock</span> <span class="na">offset=</span><span class="s">&#39;utc&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;timer</span> <span class="na">name=</span><span class="s">&#39;rtc&#39;</span> <span class="na">tickpolicy=</span><span class="s">&#39;catchup&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;timer</span> <span class="na">name=</span><span class="s">&#39;pit&#39;</span> <span class="na">tickpolicy=</span><span class="s">&#39;delay&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;timer</span> <span class="na">name=</span><span class="s">&#39;hpet&#39;</span> <span class="na">present=</span><span class="s">&#39;no&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/clock&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;on_poweroff&gt;</span>destroy<span class="nt">&lt;/on_poweroff&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;on_reboot&gt;</span>restart<span class="nt">&lt;/on_reboot&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;on_crash&gt;</span>destroy<span class="nt">&lt;/on_crash&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;pm&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;suspend-to-mem</span> <span class="na">enabled=</span><span class="s">&#39;no&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;suspend-to-disk</span> <span class="na">enabled=</span><span class="s">&#39;no&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/pm&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;devices&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;emulator&gt;</span>/usr/libexec/qemu-kvm<span class="nt">&lt;/emulator&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;qcow2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/data/kvm.qcow2&#39;</span> <span class="na">index=</span><span class="s">&#39;2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;backingStore/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vda&#39;</span> <span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;virtio-disk0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x04&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/disk&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;sda&#39;</span> <span class="na">bus=</span><span class="s">&#39;sata&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;readonly/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;sata0-0-0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;drive&#39;</span> <span class="na">controller=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;0&#39;</span> <span class="na">target=</span><span class="s">&#39;0&#39;</span> <span class="na">unit=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/disk&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;usb&#39;</span> <span class="na">index=</span><span class="s">&#39;0&#39;</span> <span class="na">model=</span><span class="s">&#39;qemu-xhci&#39;</span> <span class="na">ports=</span><span class="s">&#39;15&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;usb&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x02&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;sata&#39;</span> <span class="na">index=</span><span class="s">&#39;0&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;ide&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x1f&#39;</span> <span class="na">function=</span><span class="s">&#39;0x2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;0&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pcie.0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;virtio-serial&#39;</span> <span class="na">index=</span><span class="s">&#39;0&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;virtio-serial0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x03&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;1&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;1&#39;</span> <span class="na">port=</span><span class="s">&#39;0x8&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span> <span class="na">multifunction=</span><span class="s">&#39;on&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;2&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;2&#39;</span> <span class="na">port=</span><span class="s">&#39;0x9&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;3&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;3&#39;</span> <span class="na">port=</span><span class="s">&#39;0xa&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.3&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x2&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;4&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;4&#39;</span> <span class="na">port=</span><span class="s">&#39;0xb&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.4&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x3&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;5&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;5&#39;</span> <span class="na">port=</span><span class="s">&#39;0xc&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.5&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x4&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;6&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;6&#39;</span> <span class="na">port=</span><span class="s">&#39;0xd&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.6&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x5&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;controller</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">index=</span><span class="s">&#39;7&#39;</span> <span class="na">model=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;pcie-root-port&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">chassis=</span><span class="s">&#39;7&#39;</span> <span class="na">port=</span><span class="s">&#39;0xe&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;pci.7&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x01&#39;</span> <span class="na">function=</span><span class="s">&#39;0x6&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/controller&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;52:54:00:22:2c:d0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;default&#39;</span> <span class="na">portid=</span><span class="s">&#39;e3de6751-8de8-473c-b2a3-8c06679faea8&#39;</span> <span class="na">bridge=</span><span class="s">&#39;virbr0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vnet1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;net0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x01&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;serial</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">path=</span><span class="s">&#39;/dev/pts/1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">&#39;isa-serial&#39;</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">&#39;isa-serial&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/target&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;serial0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/serial&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;console</span> <span class="na">type=</span><span class="s">&#39;pty&#39;</span> <span class="na">tty=</span><span class="s">&#39;/dev/pts/1&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">path=</span><span class="s">&#39;/dev/pts/1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">&#39;serial&#39;</span> <span class="na">port=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;serial0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/console&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;channel</span> <span class="na">type=</span><span class="s">&#39;unix&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">mode=</span><span class="s">&#39;bind&#39;</span> <span class="na">path=</span><span class="s">&#39;/var/lib/libvirt/qemu/channel/target/domain-2-centos/org.qemu.guest_agent.0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">type=</span><span class="s">&#39;virtio&#39;</span> <span class="na">name=</span><span class="s">&#39;org.qemu.guest_agent.0&#39;</span> <span class="na">state=</span><span class="s">&#39;disconnected&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;channel0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;virtio-serial&#39;</span> <span class="na">controller=</span><span class="s">&#39;0&#39;</span> <span class="na">bus=</span><span class="s">&#39;0&#39;</span> <span class="na">port=</span><span class="s">&#39;1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/channel&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;mouse&#39;</span> <span class="na">bus=</span><span class="s">&#39;ps2&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;input0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/input&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;keyboard&#39;</span> <span class="na">bus=</span><span class="s">&#39;ps2&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;input1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/input&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;memballoon</span> <span class="na">model=</span><span class="s">&#39;virtio&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;balloon0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x05&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/memballoon&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;rng</span> <span class="na">model=</span><span class="s">&#39;virtio&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;backend</span> <span class="na">model=</span><span class="s">&#39;random&#39;</span><span class="nt">&gt;</span>/dev/urandom<span class="nt">&lt;/backend&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;rng0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x06&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/rng&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/devices&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;seclabel</span> <span class="na">type=</span><span class="s">&#39;dynamic&#39;</span> <span class="na">model=</span><span class="s">&#39;dac&#39;</span> <span class="na">relabel=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;label&gt;</span>+107:+107<span class="nt">&lt;/label&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;imagelabel&gt;</span>+107:+107<span class="nt">&lt;/imagelabel&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/seclabel&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/domain&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="edit-kvms-xml-file-change-vm-cpu-configuration">Edit kvm&rsquo;s xml file, change VM CPU configuration</h4>
<p>Edit the xml file of kvm to change the CPU configuration of the virtual machine. There are two ways to configure the CPU of a virtual machine</p>
<ul>
<li>Specify the number of cores at boot time</li>
<li>Change the xml</li>
</ul>
<p>In order to hot add CPUs, you need to change the maximum number of CPUs, and the number of hot adds cannot exceed the maximum.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virsh list --all  # 查看虚拟机</span>
</span></span><span class="line"><span class="cl"><span class="c1"># virsh edit centos # 打开虚拟机的xml文件,找到如下项 vcpu 配置</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Current is 2, change to automatic bracketing, maximum is 4</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">&lt;vcpu <span class="nv">placement</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span> <span class="nv">current</span><span class="o">=</span><span class="s2">&#34;2&#34;</span>&gt;4&lt;/vcpu&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Restart the virtual machine, check the CPU information, confirm the number of CPUs, and then hot add CPUs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virsh shutdown centos</span>
</span></span><span class="line"><span class="cl"><span class="c1"># virsh start centos</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, check the virtual machine CPU.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep processor</span>
</span></span><span class="line"><span class="cl">processor   : <span class="m">0</span>
</span></span><span class="line"><span class="cl">processor   : <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Dynamic modification of the virtual machine CPU.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virsh setvcpus centos --live --count</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go back to the virtual machine and check the CPU information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cat /proc/cpuinfo | grep processor</span>
</span></span><span class="line"><span class="cl">processor   : <span class="m">0</span>
</span></span><span class="line"><span class="cl">processor   : <span class="m">1</span>
</span></span><span class="line"><span class="cl">processor   : <span class="m">2</span>
</span></span><span class="line"><span class="cl">processor   : <span class="m">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="edit-kvm-xml-file-change-vm-memory-configuration">Edit kvm xml file, change VM memory configuration</h4>
<p>The memory settings have a balloon mechanism, which can be increased or decreased, but also set a maximum value, which is not set by default, and can be specified during installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virsh dominfo centos # 查看虚拟机信息</span>
</span></span><span class="line"><span class="cl">Id:             <span class="m">3</span>
</span></span><span class="line"><span class="cl">Name:           centos
</span></span><span class="line"><span class="cl">UUID:           556c2f19-2c66-42c3-bedb-5e1cbc469bee
</span></span><span class="line"><span class="cl">OS Type:        hvm
</span></span><span class="line"><span class="cl">State:          running
</span></span><span class="line"><span class="cl">CPU<span class="o">(</span>s<span class="o">)</span>:         <span class="m">4</span>
</span></span><span class="line"><span class="cl">CPU time:       14.8s
</span></span><span class="line"><span class="cl">Max memory:     <span class="m">4194304</span> KiB
</span></span><span class="line"><span class="cl">Used memory:    <span class="m">4194304</span> KiB
</span></span><span class="line"><span class="cl">Persistent:     yes
</span></span><span class="line"><span class="cl">Autostart:      disable
</span></span><span class="line"><span class="cl">Managed save:   no
</span></span><span class="line"><span class="cl">Security model: none
</span></span><span class="line"><span class="cl">Security DOI:   <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can modify XML to change the virtual machine memory configuration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># virsh edit centos</span>
</span></span><span class="line"><span class="cl">  &lt;memory <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span>&gt;6000640&lt;/memory&gt; <span class="o">(</span>最大内存为6G<span class="o">)</span>
</span></span><span class="line"><span class="cl">  &lt;currentMemory <span class="nv">unit</span><span class="o">=</span><span class="s1">&#39;KiB&#39;</span>&gt;4194304&lt;/currentMemory&gt;  <span class="o">(</span>当前内存为4G<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># virsh  setmem centos 5G   (增大或减小)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 能够在线调整的最大内存不能超过为虚拟机分配的最大内存，否则需要关闭虚拟机上调最大内存</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="create-virtual-machines-by-mirroring">Create virtual machines by mirroring</h3>
<p>Mirroring creation principles</p>
<ul>
<li>When partitioning, only one / root partition, do not need swap partition, because the performance of the virtual machine&rsquo;s disk is bad, if you set up a swap partition, when the swap works, the performance will be even worse. Ali cloud hosting, for example, there is no swap partition.</li>
<li>Mirroring requires removing the UUID from the NIC (eth0)</li>
<li>Turn off selinux, turn off iptables</li>
<li>Install the package for the base software: net-tools lrzsz screen tree vim wget</li>
</ul>
<h4 id="create-a-virtual-machine-image-file">Create a virtual machine image file</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 复制第一次安装的干净系统镜像，作为基础镜像文件，后面创建虚拟机使用这个基础镜像.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /data/centos.qcow2  /data/centos7.base.qcow2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用基础镜像文件,创建新的虚拟机镜像</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /data/centos7.base.qcow2   /data/centos7.113.qcow2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建虚拟机配置文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 复制第一次安装的干净的系统镜像,作为基础配置文件.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># virsh dumpxml centos &gt; /data/centos7.base.xml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用基础虚拟机镜像配置文件,创建新的虚拟机配置文件</span>
</span></span><span class="line"><span class="cl"><span class="c1"># cp /data/centos7.base.xml  /data/centos.new.xml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="edit-the-new-virtual-machine-configuration-file">Edit the new virtual machine configuration file</h4>
<p>The main changes are the virtual machine file name, UUID, image address and NIC address, where the UUID can be generated using the uuidgen command under Linux.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;name&gt;</span>centos-new<span class="nt">&lt;/name&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;uuid&gt;</span>1e86167a-33a9-4ce8-929e-58013fbf9122<span class="nt">&lt;/uuid&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;devices&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/home/vms/centos.113.img&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/disk&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;00:00:00:00:00:04&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/interface&gt;</span>    
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/devices&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/domain&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># virsh define /data/centos.new.xml
</span></span></code></pre></td></tr></table>
</div>
</div><p>How to define a virtual machine based on XML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;domain</span> <span class="na">type=</span><span class="s">&#39;kvm&#39;</span><span class="nt">&gt;</span>  //如果是Xen，则type=&#39;xen&#39;
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;name&gt;</span>vm0<span class="nt">&lt;/name&gt;</span> //虚拟机名称，同一物理机唯一
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;uuid&gt;</span>fd3535db-2558-43e9-b067-314f48211343<span class="nt">&lt;/uuid&gt;</span>  //同一物理机唯一，可用uuidgen生成
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;memory&gt;</span>524288<span class="nt">&lt;/memory&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;currentMemory&gt;</span>524288<span class="nt">&lt;/currentMemory&gt;</span>  //memory这两个值最好设成一样
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;vcpu&gt;</span>2<span class="nt">&lt;/vcpu&gt;</span>            //虚拟机可使用的cpu个数，查看物理机可用CPU个数：cat /proc/cpuinfo |grep processor | wc -l 
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;os&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;type</span> <span class="na">arch=</span><span class="s">&#39;x86_64&#39;</span> <span class="na">machine=</span><span class="s">&#39;pc-i440fx-vivid&#39;</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span> //arch指出系统架构类型，machine 则是机器类型，查看机器类型：qemu-system-x86_64 -M ?
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">&#39;hd&#39;</span><span class="nt">/&gt;</span>  //启动介质，第一次需要装系统可以选择cdrom光盘启动
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;bootmenu</span> <span class="na">enable=</span><span class="s">&#39;yes&#39;</span><span class="nt">/&gt;</span>  //表示启动按F12进入启动菜单
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/os&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;features&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;acpi/&gt;</span>  //Advanced Configuration and Power Interface,高级配置与电源接口
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;apic/&gt;</span>  //Advanced Programmable Interrupt Controller,高级可编程中断控制器
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;pae/&gt;</span>   //Physical Address Extension,物理地址扩展
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/features&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;clock</span> <span class="na">offset=</span><span class="s">&#39;localtime&#39;</span><span class="nt">/&gt;</span>  //虚拟机时钟设置，这里表示本地本机时间
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;on_poweroff&gt;</span>destroy<span class="nt">&lt;/on_poweroff&gt;</span>  //突发事件动作
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;on_reboot&gt;</span>restart<span class="nt">&lt;/on_reboot&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;on_crash&gt;</span>restart<span class="nt">&lt;/on_crash&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;devices&gt;</span>   //设备配置
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;emulator&gt;</span>/usr/bin/kvm<span class="nt">&lt;/emulator&gt;</span> //如果是Xen则是/usr/lib/xen/binqemu-dm
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span> //硬盘
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/opt/vm/vmdev/fdisk.img&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vda&#39;</span> <span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x06&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span> //域、总线、槽、功能号，slot值同一虚拟机上唯一
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/disk&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;disk&#39;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span> 
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/opt/vm/vmdev/fdisk2.img&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vdb&#39;</span> <span class="na">bus=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/disk&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#39;file&#39;</span> <span class="na">device=</span><span class="s">&#39;cdrom&#39;</span><span class="nt">&gt;</span>//光盘
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#39;qemu&#39;</span> <span class="na">type=</span><span class="s">&#39;raw&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">file=</span><span class="s">&#39;/opt/vm/vmiso/ubuntu-15.10-server-amd64.iso&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;hdc&#39;</span> <span class="na">bus=</span><span class="s">&#39;ide&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;readonly/&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/disk&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   /* 利用Linux网桥连接网络 */
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span>   
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;fa:92:01:33:d4:fa&#39;</span><span class="nt">/&gt;</span> 
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">&#39;br100&#39;</span><span class="nt">/&gt;</span>  //配置的网桥网卡名称
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vnet0&#39;</span><span class="nt">/&gt;</span>     //同一网桥下相同
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;net0&#39;</span><span class="nt">/&gt;</span>      //别名，同一网桥下相同
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x03&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>  //注意slot值唯一
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   /* 利用ovs网桥连接网络 */
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;bridge&#39;</span><span class="nt">&gt;</span>  
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">bridge=</span><span class="s">&#39;br-ovs0&#39;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;virtualport</span> <span class="na">type=</span><span class="s">&#39;openvswitch&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;tap0&#39;</span><span class="nt">/&gt;</span>     
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    /* 配置成pci直通虚拟机连接网络，SR-IOV网卡的VF场景 */
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;hostdev</span> <span class="na">mode=</span><span class="s">&#39;subsystem&#39;</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">managed=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;source&gt;</span>
</span></span><span class="line"><span class="cl">       <span class="nt">&lt;address</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x03&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x00&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;/source&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/hostdev&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   /* 利用vhostuser连接ovs端口 */
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;vhostuser&#39;</span><span class="nt">&gt;</span>   
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;fa:92:01:33:d4:fa&#39;</span><span class="nt">/&gt;</span> 
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;source</span> <span class="na">type=</span><span class="s">&#39;unix&#39;</span> <span class="na">path=</span><span class="s">&#39;/var/run/vhost-user/tap0&#39;</span> <span class="na">mode=</span><span class="s">&#39;client&#39;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;model</span> <span class="na">type=</span><span class="s">&#39;virtio&#39;</span><span class="nt">/&gt;</span>     
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;driver</span> <span class="na">vringbuf=</span><span class="s">&#39;2048&#39;</span><span class="nt">/&gt;</span>     
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x03&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>  
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;interface</span> <span class="na">type=</span><span class="s">&#39;network&#39;</span><span class="nt">&gt;</span>   //基于虚拟局域网的网络
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;mac</span> <span class="na">address=</span><span class="s">&#39;52:54:4a:e1:1c:84&#39;</span><span class="nt">/&gt;</span>  //可用命令生成，见下面的补充
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;source</span> <span class="na">network=</span><span class="s">&#39;default&#39;</span><span class="nt">/&gt;</span> //默认
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;target</span> <span class="na">dev=</span><span class="s">&#39;vnet1&#39;</span><span class="nt">/&gt;</span>  //同一虚拟局域网的值相同
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;alias</span> <span class="na">name=</span><span class="s">&#39;net1&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="nt">&lt;address</span> <span class="na">type=</span><span class="s">&#39;pci&#39;</span> <span class="na">domain=</span><span class="s">&#39;0x0000&#39;</span> <span class="na">bus=</span><span class="s">&#39;0x00&#39;</span> <span class="na">slot=</span><span class="s">&#39;0x04&#39;</span> <span class="na">function=</span><span class="s">&#39;0x0&#39;</span><span class="nt">/&gt;</span>  //注意slot值
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;/interface&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;graphics</span> <span class="na">type=</span><span class="s">&#39;vnc&#39;</span> <span class="na">port=</span><span class="s">&#39;5900&#39;</span> <span class="na">autoport=</span><span class="s">&#39;yes&#39;</span> <span class="na">listen=</span><span class="s">&#39;0.0.0.0&#39;</span> <span class="na">keymap=</span><span class="s">&#39;en-us&#39;</span><span class="nt">/&gt;</span>  //配置vnc，windows下可以使用vncviewer登录，获取vnc端口号：virsh vncdisplay vm0
</span></span><span class="line"><span class="cl">   <span class="nt">&lt;listen</span> <span class="na">type=</span><span class="s">&#39;address&#39;</span> <span class="na">address=</span><span class="s">&#39;0.0.0.0&#39;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/graphics&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/devices&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/domain&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>Reference <code>https://houmin.cc/posts/efda97c6/</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/libvirt/">libvirt</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/gcc-12-cpp-features/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">GCC 12 introduces more C&#43;&#43;23-oriented implementations</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/grpc-cpp-async/">
            <span class="next-text nav-default">C&#43;&#43; Asynchronous Programming in gRPC</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
