<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Building Virtual Machine Images with Packer - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Packer to build a virtual machine image on a VMware vSphere environment, and how to run a k3s cluster in this virtual machine." /><meta name="keywords" content="Packer" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/packer-vsphere-example/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Building Virtual Machine Images with Packer" />
<meta property="og:description" content="Learn how to use Packer to build a virtual machine image on a VMware vSphere environment, and how to run a k3s cluster in this virtual machine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/packer-vsphere-example/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-25T12:18:09+08:00" />
<meta property="article:modified_time" content="2022-05-25T12:18:09+08:00" />

<meta itemprop="name" content="Building Virtual Machine Images with Packer">
<meta itemprop="description" content="Learn how to use Packer to build a virtual machine image on a VMware vSphere environment, and how to run a k3s cluster in this virtual machine."><meta itemprop="datePublished" content="2022-05-25T12:18:09+08:00" />
<meta itemprop="dateModified" content="2022-05-25T12:18:09+08:00" />
<meta itemprop="wordCount" content="8876">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Building Virtual Machine Images with Packer"/>
<meta name="twitter:description" content="Learn how to use Packer to build a virtual machine image on a VMware vSphere environment, and how to run a k3s cluster in this virtual machine."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Building Virtual Machine Images with Packer</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-25 12:18:09 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 8876 words </span>
          <span class="more-meta"> 18 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#prerequisites">Prerequisites</a></li>
        <li><a href="#packer">Packer</a>
          <ul>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#installation">Installation</a></li>
            <li><a href="#configuration">Configuration</a></li>
            <li><a href="#post-processors">post-processors</a></li>
            <li><a href="#build">Build</a></li>
          </ul>
        </li>
        <li><a href="#build-process">Build process</a>
          <ul>
            <li><a href="#building-a-base-virtual-machine-with-vsphere-iso">Building a Base Virtual Machine with vsphere-iso</a></li>
            <li><a href="#build-business-vm-and-export-ovfova-via-vsphere-clone">Build business VM and export OVF/OVA via vsphere-clone</a></li>
          </ul>
        </li>
        <li><a href="#argo-workflow-and-k3s">argo-workflow and k3s</a>
          <ul>
            <li><a href="#argo-workflow">argo-workflow</a></li>
            <li><a href="#k8s-and-k3s">k8s and k3s</a></li>
          </ul>
        </li>
        <li><a href="#other">Other</a>
          <ul>
            <li><a href="#feeling-of-using">Feeling of using</a></li>
            <li><a href="#ova-format">OVA format</a></li>
            <li><a href="#the-installation-of-open-vm-tool-failed">The installation of open-vm-tool failed</a></li>
            <li><a href="#reducing-exported-vmdk-file-size">Reducing exported vmdk file size</a></li>
            <li><a href="#photon3">Photon3</a></li>
            <li><a href="#goss">goss</a></li>
            <li><a href="#pod-status-abnormal-after-importing-ova-vms">Pod status abnormal after importing OVA VMs</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article shares a scenario on how to build a VM image on a <a href="https://www.vmware.com/products/vsphere.html">VMware vSphere</a> environment using <a href="https://www.packer.io/">Packer</a>, and how to Run a k3s cluster and then run <a href="https://github.com/">redfish-esxi-os-installer</a> through the <a href="https://github.com/argoproj/argo-workflows">argo-workflow</a> workflow engine muzi502/redfish-esxi-os-installer) to automate the installation of ESXi OS on the bare metal server.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Download the ISO image of Base OS in advance, for example <a href="https://images.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a>.</li>
<li>A <a href="https://www.vmware.com/products/vcenter-server.html">vCenter Server</a> and a <a href="https://www.vmware.com/products/esxi-and">VMware ESXi</a> are required -esx.html) host.</li>
<li>A DHCP server is required on the ESXi&rsquo;s VM Network network to assign IPs to the VMs.</li>
</ul>
<h2 id="packer">Packer</h2>
<p>When I was playing with VMware ESXi a long time ago, I didn&rsquo;t have access to Packer, so I had to use the manual installation of virtual machine templates, which was time-consuming and error-prone. Here&rsquo;s an introduction to this tool for automating the construction of virtual machine images.</p>
<h3 id="introduction">Introduction</h3>
<p><a href="https://github.com/hashicorp/packer">Packer</a> is an open source VM image builder from <a href="https://www.hashicorp.com/">hashicorp</a>, similar to <a href="https://github.com/openstack/diskimage-builder">OpenStack diskimage -builder</a>, <a href="https://aws.amazon.com/image-builder/">AWS EC2 Image Builder</a>, but these two only support their own platforms. Packer can support mainstream public, private and hybrid clouds, which is much higher than both of them. It is interesting to note that Packer is as important in IaaS virtualization as Docker is in PaaS container virtualization, one for building virtual machine images and the other for building container images, both of which were founded in 2013.</p>
<p>The Kubernetes community&rsquo;s <a href="https://github.com/kubernetes-sigs/image-builder">image-builder</a> project is a project that uses Packer to build some of the public and private cloud VM templates provided to [cluster-api](https: //github.com/kubernetes-sigs/cluster-api) project, I highly recommend you to take a look at the code of this project, I just started to get familiar with Packer from this project, and learned a lot from it.</p>
<p>The following is an introduction to the basic use of Packer</p>
<h3 id="installation">Installation</h3>
<p>For Linux distributions, it is recommended to download the binary installation package directly to install it, installation via package manager feels a bit cumbersome.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ wget https://releases.hashicorp.com/packer/1.8.0/packer_1.8.0_linux_amd64.zip
</span></span><span class="line"><span class="cl">$ unzip packer_1.8.0_linux_amd64.zip
</span></span><span class="line"><span class="cl">$ mv packer /usr/local/bin/packer
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you are a macOS user, the <code>brew install packer</code> command will install it directly.</p>
<h3 id="configuration">Configuration</h3>
<p>Unlike Docker, which has a Dockerfile file that defines how to build container images, Packer builds VM images by stitching together a series of configuration files, mainly consisting of <a href="https://www.packer.io/docs/terminology#builders">Builders</a>, <a href="https://www.packer.io/docs/terminology#provisioners">Provisioners</a>, <a href="https://www.packer.io/docs/terminology#post-processors">Post-processors</a>. The Builder is mainly the parameters related to the IaaS Provider builder; Provisioner is used to configure some tasks to be run during the build process; Post-processors is used to configure some post-processing operations after the build action is completed; the following is a detailed description of the use of these configurations in turn.</p>
<p>In addition, Packer&rsquo;s recommended configuration syntax is <a href="https://www.packer.io/guides/hcl">HCL2</a>, but I personally feel that the syntax style of HCL is strange, not as neat and nice as json, so I use json to configure the following unified, in fact, the parameters are the same, but the format is not the same.</p>
<h4 id="varsvar-file">vars/var-file</h4>
<p>Packer&rsquo;s variable profiles are somewhat similar to vars in Ansible, and it makes sense to sort each parameter by its scope and put them in a separate profile, which is easier to maintain. After referring to the <a href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi/packer/ova">ova</a> build in the image-builder project, I have divided the parameters into the following profiles according to their different roles Several configuration files.</p>
<ul>
<li>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/vcenter.json">vcenter.json</a>: mainly used to configure some parameters related to vCenter, such as datastore, datacenter, resource_pool, vcenter_server, etc.; in addition, it is recommended to use environment variables for the username and password of vcenter to avoid encoding them in plain text in the file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;folder&#34;</span><span class="p">:</span> <span class="s2">&#34;Packer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;resource_pool&#34;</span><span class="p">:</span> <span class="s2">&#34;Packer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;Packer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;datacenter&#34;</span><span class="p">:</span> <span class="s2">&#34;Packer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;datastore&#34;</span><span class="p">:</span> <span class="s2">&#34;Packer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;convert_to_template&#34;</span><span class="p">:</span> <span class="s2">&#34;false&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;create_snapshot&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;linked_clone&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;VM Network&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;administrator@vsphere.local&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;vcenter_server&#34;</span><span class="p">:</span> <span class="s2">&#34;vcenter.k8s.li&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;insecure_connection&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/centos7.json">centos7.json</a>: mainly used to configure some parameters for installing CentOS via ISO, such as the ISO download address, ISO checksum, kickstart file path, shutdown command, isolinux boot parameters, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_command_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;tab&gt; text ks=hd:fd0:&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_command_suffix&#34;</span><span class="p">:</span> <span class="s2">&#34;/7/ks.cfg&lt;enter&gt;&lt;wait&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_media_path&#34;</span><span class="p">:</span> <span class="s2">&#34;/HTTP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;build_name&#34;</span><span class="p">:</span> <span class="s2">&#34;centos-7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;distro_arch&#34;</span><span class="p">:</span> <span class="s2">&#34;amd64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;distro_name&#34;</span><span class="p">:</span> <span class="s2">&#34;centos&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;distro_version&#34;</span><span class="p">:</span> <span class="s2">&#34;7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;floppy_dirs&#34;</span><span class="p">:</span> <span class="s2">&#34;./kickstart/{{user `distro_name`}}/http/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;centos7-64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;iso_checksum&#34;</span><span class="p">:</span> <span class="s2">&#34;07b94e6b1a0b0260b94c83d6bb76b26bf7a310dc78d7a9c7432809fb9bc6194a&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;iso_checksum_type&#34;</span><span class="p">:</span> <span class="s2">&#34;sha256&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;iso_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://images.edge.kernel.org/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;os_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;CentOS 7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;shutdown_command&#34;</span><span class="p">:</span> <span class="s2">&#34;shutdown -h now&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;vsphere_guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;centos7_64Guest&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/photon3.json">photon3.json</a>: mainly used to configure some parameters for installing Photon3 OS via ISO, same as above centos7.json above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_command_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;esc&gt;&lt;wait&gt; vmlinuz initrd=initrd.img root/dev/ram0 loglevel=3 photon.media=cdrom ks=&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_command_suffix&#34;</span><span class="p">:</span> <span class="s2">&#34;/3/ks.json&lt;enter&gt;&lt;wait&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_media_path&#34;</span><span class="p">:</span> <span class="s2">&#34;http://{{ .HTTPIP }}:{{ .HTTPPort }}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;build_name&#34;</span><span class="p">:</span> <span class="s2">&#34;photon-3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;distro_arch&#34;</span><span class="p">:</span> <span class="s2">&#34;amd64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;distro_name&#34;</span><span class="p">:</span> <span class="s2">&#34;photon&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;distro_version&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;vmware-photon-64&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;http_directory&#34;</span><span class="p">:</span> <span class="s2">&#34;./kickstart/{{user `distro_name`}}/http/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;iso_checksum&#34;</span><span class="p">:</span> <span class="s2">&#34;c2883a42e402a2330d9c39b4d1e071cf9b3b5898&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;iso_checksum_type&#34;</span><span class="p">:</span> <span class="s2">&#34;sha1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;iso_url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://packages.vmware.com/photon/3.0/Rev3/iso/photon-minimal-3.0-a383732.iso&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;os_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;VMware Photon OS 64-bit&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;shutdown_command&#34;</span><span class="p">:</span> <span class="s2">&#34;shutdown now&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;vsphere_guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;vmwarePhoton64Guest&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/common.json">common.json</a>: some public parameters, such as the ssh username and password of the virtual machine (to be consistent with those set in kickstart), some hardware configuration of the virtual machine such as CPU, memory, hard disk, virtual machine version, NIC type, storage controller type, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;ssh_username&#34;</span><span class="p">:</span> <span class="s2">&#34;root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;ssh_password&#34;</span><span class="p">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;boot_wait&#34;</span><span class="p">:</span> <span class="s2">&#34;15s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;disk_controller_type&#34;</span><span class="p">:</span> <span class="s2">&#34;lsilogic&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;disk_thin_provisioned&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;disk_type_id&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;firmware&#34;</span><span class="p">:</span> <span class="s2">&#34;bios&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;cpu&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;cpu_cores&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;memory&#34;</span><span class="p">:</span> <span class="s2">&#34;4096&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;disk_size&#34;</span><span class="p">:</span> <span class="s2">&#34;65536&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;network_card&#34;</span><span class="p">:</span> <span class="s2">&#34;e1000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;ssh_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;3m&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;vmx_version&#34;</span><span class="p">:</span> <span class="s2">&#34;14&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;base_build_version&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `template`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;build_timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;{{timestamp}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;build_name&#34;</span><span class="p">:</span> <span class="s2">&#34;k3s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;build_version&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `ova_name`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;export_manifest&#34;</span><span class="p">:</span> <span class="s2">&#34;none&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;output_dir&#34;</span><span class="p">:</span> <span class="s2">&#34;./output/{{user `build_version`}}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="builder">Builder</h4>
<p>A Builder is a configuration that tells the Packer what type of builder to use to build what kind of virtual machine image, mainly related to the underlying IaaS resource provider. For example, there are two builders in <a href="https://www.packer.io/plugins/builders/vsphere">vSphere Builder</a> as follows.</p>
<ul>
<li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> builds from an ISO installation OS, typically built as a virtual machine or VM template</li>
<li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a> builds by cloning the virtual machine, usually as an exported OVF/OVA file</li>
</ul>
<p>The configuration parameters of different types of Builders may vary, so please refer to the <a href="https://www.packer.io/plugins">Packer official documentation</a> for the detailed usage and description of each parameter. Because the configuration of Packer parameters is too complicated, it is difficult to explain them clearly in a few words. The best way is to read the official documentation and some other projects&rsquo; implementations, and just learn from the gourd.</p>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/builder.json">builders.json</a>: most of the configuration parameters are referenced from the var-file. The advantage of pulling these parameters out separately is that some common parameters can be reused between different builders. For example, vsphere-iso and vsphere-clone are two different builders with the same datacenter, datastore, vcenter_server, and other parameters related to vCenter.</p>
<ul>
<li>
<p><a href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> : Build a virtual machine or VM template with an ISO installation OS.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;builders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;CPUs&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cpu`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;RAM&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `memory`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;boot_command&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;{{user `boot_command_prefix`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;{{user `boot_media_path`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;{{user `boot_command_suffix`}}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;boot_wait&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `boot_wait`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cluster`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;communicator&#34;</span><span class="p">:</span> <span class="s2">&#34;ssh&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;convert_to_template&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `convert_to_template`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cpu_cores&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cpu_cores`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;create_snapshot&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `create_snapshot`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;datacenter&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `datacenter`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;datastore&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `datastore`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;disk_controller_type&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `disk_controller_type`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;firmware&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `firmware`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;floppy_dirs&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ user `floppy_dirs`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;folder&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `folder`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `vsphere_guest_os_type`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `host`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;http_directory&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ user `http_directory`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;insecure_connection&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `insecure_connection`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;iso_checksum&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `iso_checksum_type`}}:{{user `iso_checksum`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;iso_urls&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `iso_url`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;vsphere-iso-base&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;network_adapters&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `network`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;network_card&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `network_card`}}&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `password`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;shutdown_command&#34;</span><span class="p">:</span> <span class="s2">&#34;echo &#39;{{user `ssh_password`}}&#39; | sudo -S -E sh -c &#39;{{user `shutdown_command`}}&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_clear_authorized_keys&#34;</span><span class="p">:</span> <span class="s2">&#34;false&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_password&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `ssh_password`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;4h&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_username&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `ssh_username`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;storage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;disk_size&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `disk_size`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;disk_thin_provisioned&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `disk_thin_provisioned`}}&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;vsphere-iso&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `username`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;vcenter_server&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `vcenter_server`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;vm_name&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `base_build_version`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;vm_version&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `vmx_version`}}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><a href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a>: Build a virtual machine by clone VM and export VM OVF templates.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nt">&#34;builders&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;CPUs&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cpu`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;RAM&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `memory`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cluster`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;communicator&#34;</span><span class="p">:</span> <span class="s2">&#34;ssh&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;convert_to_template&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `convert_to_template`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cpu_cores&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cpu_cores`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;create_snapshot&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `create_snapshot`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;datacenter&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `datacenter`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;datastore&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `datastore`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;export&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;force&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;manifest&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ user `export_manifest`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;output_directory&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `output_dir`}}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;folder&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `folder`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `host`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;insecure_connection&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `insecure_connection`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;linked_clone&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `linked_clone`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;vsphere-clone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;network&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `network`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `password`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;shutdown_command&#34;</span><span class="p">:</span> <span class="s2">&#34;echo &#39;{{user `ssh_password`}}&#39; | sudo -S -E sh -c &#39;{{user `shutdown_command`}}&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_password&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `ssh_password`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;4h&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ssh_username&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `ssh_username`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;template&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `template`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;vsphere-clone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `username`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;vcenter_server&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `vcenter_server`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;vm_name&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `build_version`}}&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="provisioner">Provisioner</h4>
<p><a href="https://www.packer.io/docs/provisioners">Provisioner</a> is to tell Packer how to build the image, somewhat similar to the RUN/_COPY/ADD commands in Dockerile, used to execute some commands/scripts, add some files to the virtual machine, call third-party plugins to perform some operations, etc.</p>
<p>In this configuration file, I use the file module to upload some scripts and dependencies to the VM, and then use the shell module to execute the install.sh installation script in the VM. If you are building a large number of builders, such as multiple Linux distributions, it is recommended to use Ansible for this scenario, as I have already done some OS distribution related operations in the ISO install OS build process. The operations performed with the shell here do not need to distinguish between Linux distributions, so ansible is not used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;provisioners&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;scripts&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;destination&#34;</span><span class="p">:</span> <span class="s2">&#34;/root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;except&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;vsphere-iso-base&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;resources&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;destination&#34;</span><span class="p">:</span> <span class="s2">&#34;/root&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;except&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;vsphere-iso-base&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;shell&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;environment_vars&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;INSECURE_REGISTRY={{user `insecure_registry`}}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;inline&#34;</span><span class="p">:</span> <span class="s2">&#34;bash /root/scripts/install.sh&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;except&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;vsphere-iso-base&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="post-processors">post-processors</h3>
<p>Some post-processors, such as <code>&quot;type&quot;: &quot;manifest&quot;</code>, can export some of the configuration parameters of the build process for use in other operations. Another example is <code>&quot;type&quot;: &quot;shell-local&quot;</code> which executes some shell scripts, in this case a Python script to convert OVF to OVA.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;post-processors&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;custom_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;release_version&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `release_version`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;build_date&#34;</span><span class="p">:</span> <span class="s2">&#34;{{isotime}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;build_name&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `build_name`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;build_timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `build_timestamp`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;build_type&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;cpu&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `cpu`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;memory&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `memory`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;disk_size&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `disk_size`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;distro_arch&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ user `distro_arch` }}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;distro_name&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ user `distro_name` }}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;distro_version&#34;</span><span class="p">:</span> <span class="s2">&#34;{{ user `distro_version` }}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;firmware&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `firmware`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `guest_os_type`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;os_name&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `os_display_name`}}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;vsphere_guest_os_type&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `vsphere_guest_os_type`}}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;packer-manifest&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;output&#34;</span><span class="p">:</span> <span class="s2">&#34;{{user `output_dir`}}/packer-manifest.json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;strip_path&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;manifest&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;except&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;vsphere-iso-base&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;inline&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;python3 ./scripts/ova.py --vmx {{user `vmx_version`}} --ovf_template {{user `ovf_template`}} --build_dir={{user `output_dir`}}&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;except&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;vsphere-iso-base&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;vsphere&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;shell-local&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="build">Build</h3>
<p><a href="https://github.com/muzi502/packer-vsphere-example">packer-vsphere-example</a> The directory structure of the project is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">../packer-vsphere-example
</span></span><span class="line"><span class="cl">├── kickstart        # kickstart 配置文件存放目录
</span></span><span class="line"><span class="cl">├── Makefile         # makefile，make 命令的操作的入口
</span></span><span class="line"><span class="cl">├── packer           # packer 配置文件
</span></span><span class="line"><span class="cl">│   ├── builder.json # packer builder 配置文件
</span></span><span class="line"><span class="cl">│   ├── centos7.json # centos iso 安装 os 的配置
</span></span><span class="line"><span class="cl">│   ├── common.json  # 一些公共配置参数
</span></span><span class="line"><span class="cl">│   ├── photon3.json # photon3 iso 安装 os 的配置
</span></span><span class="line"><span class="cl">│   └── vcenter.json # vcenter 相关的配置
</span></span><span class="line"><span class="cl">├── resources        # 一些 k8s manifests 文件
</span></span><span class="line"><span class="cl">└── scripts          # 构建过程中需要用到的脚本文件
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similar to docker, packer&rsquo;s subcommand to perform build operations is also build, <code>packer build</code>, but the options supported by packer build are not as rich as those of docker. The core options are -except, -only, -var, and -var-file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ packer build
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># 控制终端颜色输出</span>
</span></span><span class="line"><span class="cl">  -color<span class="o">=</span><span class="nb">false</span>                  Disable color output. <span class="o">(</span>Default: color<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># debug 模式，类似于断点的方式运行</span>
</span></span><span class="line"><span class="cl">  -debug                        Debug mode enabled <span class="k">for</span> builds.
</span></span><span class="line"><span class="cl">  <span class="c1"># 排除一些 builder，有点类似于 ansible 的 --skip-tags</span>
</span></span><span class="line"><span class="cl">  -except<span class="o">=</span>foo,bar,baz           Run all builds and post-processors other than these.
</span></span><span class="line"><span class="cl">  <span class="c1"># 指定运行某些 builder，有点类似于 ansible 的 --tags</span>
</span></span><span class="line"><span class="cl">  -only<span class="o">=</span>foo,bar,baz             Build only the specified builds.
</span></span><span class="line"><span class="cl">  <span class="c1"># 强制构建，如果构建目标已经存在则强制删除重新构建</span>
</span></span><span class="line"><span class="cl">  -force                        Force a build to <span class="k">continue</span> <span class="k">if</span> artifacts exist, deletes existing artifacts.
</span></span><span class="line"><span class="cl">  -machine-readable             Produce machine-readable output.
</span></span><span class="line"><span class="cl">  <span class="c1"># 出现错误之后的动作，cleanup 清理所有操作、abort 中断执行、ask 询问、</span>
</span></span><span class="line"><span class="cl">  -on-error<span class="o">=[</span>cleanup<span class="p">|</span>abort<span class="p">|</span>ask<span class="p">|</span>run-cleanup-provisioner<span class="o">]</span> If the build fails <span class="k">do</span>: clean up <span class="o">(</span>default<span class="o">)</span>, abort, ask, or run-cleanup-provisioner.
</span></span><span class="line"><span class="cl">  <span class="c1"># 并行运行的 builder 数量，默认没有限制，有点类似于 ansible 中的 --forks 参数</span>
</span></span><span class="line"><span class="cl">  -parallel-builds<span class="o">=</span><span class="m">1</span>            Number of builds to run in parallel. <span class="m">1</span> disables parallelization. <span class="m">0</span> means no limit <span class="o">(</span>Default: 0<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># UI 输出的时间戳</span>
</span></span><span class="line"><span class="cl">  -timestamp-ui                 Enable prefixing of each ui output with an RFC3339 timestamp.
</span></span><span class="line"><span class="cl">  <span class="c1"># 变量参数，有点类似于 ansible 的 -e 选项</span>
</span></span><span class="line"><span class="cl">  -var <span class="s1">&#39;key=value&#39;</span>              Variable <span class="k">for</span> templates, can be used multiple times.
</span></span><span class="line"><span class="cl">  <span class="c1"># 变量文件，有点类似于 ansible 的 -e@ 选项</span>
</span></span><span class="line"><span class="cl">  -var-file<span class="o">=</span>path                JSON or HCL2 file containing user variables.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 指定一些 var 参数以及 var-file 文件，最后一个参数是 builder 的配置文件路径</span>
</span></span><span class="line"><span class="cl">$ packer build  --var <span class="nv">ova_name</span><span class="o">=</span>k3s-photon3-c4ca93f --var <span class="nv">release_version</span><span class="o">=</span>c4ca93f --var <span class="nv">ovf_template</span><span class="o">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/scripts/ovf_template.xml --var <span class="nv">template</span><span class="o">=</span>base-os-photon3 --var <span class="nv">username</span><span class="o">=</span><span class="si">${</span><span class="nv">VCENTER_USERNAME</span><span class="si">}</span> --var <span class="nv">password</span><span class="o">=</span><span class="si">${</span><span class="nv">VCENTER_PASSWORD</span><span class="si">}</span> --var <span class="nv">vcenter_server</span><span class="o">=</span><span class="si">${</span><span class="nv">VCENTER_SERVER</span><span class="si">}</span> --var <span class="nv">build_name</span><span class="o">=</span>k3s-photon3 --var <span class="nv">output_dir</span><span class="o">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f -only vsphere-clone -var-file<span class="o">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/vcenter.json -var-file<span class="o">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/photon3.json -var-file<span class="o">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/common.json /root/usr/src/github.com/muzi502/packer-vsphere-example/packer/builder.json
</span></span></code></pre></td></tr></table>
</div>
</div><p>The long and stinky packer build command above is wrapped in <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/Makefile">Makefile</a>. It&rsquo;s a lot of parameters to enter manually, which can drive people crazy.</p>
<ul>
<li>
<p>First define some default parameters, such as build version, build time, base template name, export ova file name, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Ensure Make is run with bash shell as some syntax below is bash-specific</span>
</span></span><span class="line"><span class="cl">SHELL:<span class="o">=</span>/usr/bin/env bash
</span></span><span class="line"><span class="cl">.DEFAULT_GOAL:<span class="o">=</span><span class="nb">help</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Full directory of where the Makefile resides</span>
</span></span><span class="line"><span class="cl">ROOT_DIR :<span class="o">=</span> <span class="k">$(</span>shell dirname <span class="k">$(</span>realpath <span class="k">$(</span>firstword <span class="k">$(</span>MAKEFILE_LIST<span class="k">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RELEASE_VERSION       ?<span class="o">=</span> <span class="k">$(</span>shell git describe --tags --always --dirty<span class="k">)</span>
</span></span><span class="line"><span class="cl">RELEASE_TIME          ?<span class="o">=</span> <span class="k">$(</span>shell date -u +<span class="s1">&#39;%Y-%m-%dT%H:%M:%SZ&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">PACKER_IMAGE          ?<span class="o">=</span> hashicorp/packer:1.8
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_CONFIG_DIR</span>     <span class="o">=</span> <span class="k">$(</span>ROOT_DIR<span class="k">)</span>/packer
</span></span><span class="line"><span class="cl">PACKER_FORCE          ?<span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">PACKER_OVA_PREFIX     ?<span class="o">=</span> k3s
</span></span><span class="line"><span class="cl">PACKER_BASE_OS        ?<span class="o">=</span> centos7
</span></span><span class="line"><span class="cl">PACKER_OUTPUT_DIR     ?<span class="o">=</span> <span class="k">$(</span>ROOT_DIR<span class="k">)</span>/output
</span></span><span class="line"><span class="cl">PACKER_TEMPLATE_NAME  ?<span class="o">=</span> base-os-<span class="k">$(</span>PACKER_BASE_OS<span class="k">)</span>
</span></span><span class="line"><span class="cl">OVF_TEMPLATE          ?<span class="o">=</span> <span class="k">$(</span>ROOT_DIR<span class="k">)</span>/scripts/ovf_template.xml
</span></span><span class="line"><span class="cl">PACKER_OVA_NAME       ?<span class="o">=</span> <span class="k">$(</span>PACKER_OVA_PREFIX<span class="k">)</span>-<span class="k">$(</span>PACKER_BASE_OS<span class="k">)</span>-<span class="k">$(</span>RELEASE_VERSION<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Then define the vars and var-file parameters</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 是否为强制构建，增加 force 参数</span>
</span></span><span class="line"><span class="cl">ifeq <span class="o">(</span><span class="k">$(</span>PACKER_FORCE<span class="k">)</span>, <span class="nb">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_FORCE_ARG</span> <span class="o">=</span> --force<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">endif
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义 vars 可变参数，比如 vcenter 用户名、密码 等参数</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_VARS</span> <span class="o">=</span> <span class="k">$(</span>PACKER_FORCE_ARG<span class="k">)</span> <span class="se">\ </span>           <span class="c1"># 是否强制构建</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">ova_name</span><span class="o">=</span><span class="k">$(</span>PACKER_OVA_NAME<span class="k">)</span> <span class="se">\ </span>         <span class="c1"># OVA 文件名</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">release_version</span><span class="o">=</span><span class="k">$(</span>RELEASE_VERSION<span class="k">)</span> <span class="se">\ </span>  <span class="c1"># 发布版本</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">ovf_template</span><span class="o">=</span><span class="k">$(</span>OVF_TEMPLATE<span class="k">)</span> <span class="se">\ </span>        <span class="c1"># OVF 模版文件</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">template</span><span class="o">=</span><span class="k">$(</span>PACKER_TEMPLATE_NAME<span class="k">)</span> <span class="se">\ </span>    <span class="c1"># OVA 的 base 虚拟机模版名称</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">username</span><span class="o">=</span><span class="nv">$$</span><span class="o">{</span>VCENTER_USERNAME<span class="o">}</span> <span class="se">\ </span>       <span class="c1"># vCenter 用户名（环境变量）</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">password</span><span class="o">=</span><span class="nv">$$</span><span class="o">{</span>VCENTER_PASSWORD<span class="o">}</span> <span class="se">\ </span>       <span class="c1"># vCenter 密码（环境变量）</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">vcenter_server</span><span class="o">=</span><span class="nv">$$</span><span class="o">{</span>VCENTER_SERVER<span class="o">}</span> <span class="se">\ </span>   <span class="c1"># vCenter 访问地址（环境变量）</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">build_name</span><span class="o">=</span><span class="k">$(</span>PACKER_OVA_PREFIX<span class="k">)</span>-<span class="k">$(</span>PACKER_BASE_OS<span class="k">)</span> <span class="se">\ </span> <span class="c1"># 构建名称</span>
</span></span><span class="line"><span class="cl">    --var <span class="nv">output_dir</span><span class="o">=</span><span class="k">$(</span>PACKER_OUTPUT_DIR<span class="k">)</span>/<span class="k">$(</span>PACKER_OVA_NAME<span class="k">)</span>   <span class="c1"># OVA 导出的目录</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 定义 var-file 参数</span>
</span></span><span class="line"><span class="cl"><span class="nv">PACKER_VAR_FILES</span> <span class="o">=</span> -var-file<span class="o">=</span><span class="k">$(</span>PACKER_CONFIG_DIR<span class="k">)</span>/vcenter.json <span class="se">\ </span><span class="c1"># vCenter 的参数配置</span>
</span></span><span class="line"><span class="cl">    -var-file<span class="o">=</span><span class="k">$(</span>PACKER_CONFIG_DIR<span class="k">)</span>/<span class="k">$(</span>PACKER_BASE_OS<span class="k">)</span>.json <span class="se">\ </span>       <span class="c1"># OS 的参数配置</span>
</span></span><span class="line"><span class="cl">    -var-file<span class="o">=</span><span class="k">$(</span>PACKER_CONFIG_DIR<span class="k">)</span>/common.json                     <span class="c1"># 一些公共配置</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Finally define make targrt</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">.PHONY: build-template
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 ISO 安装 OS 构建一个 base 虚拟机</span>
</span></span><span class="line"><span class="cl">build-template: <span class="c1">## build the base os template by iso</span>
</span></span><span class="line"><span class="cl">    packer build <span class="k">$(</span>PACKER_VARS<span class="k">)</span> -only vsphere-iso-base <span class="k">$(</span>PACKER_VAR_FILES<span class="k">)</span> <span class="k">$(</span>PACKER_CONFIG_DIR<span class="k">)</span>/builder.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">.PHONY: build-ovf
</span></span><span class="line"><span class="cl"><span class="c1"># 通过 clone 方式构建并导出 OVF/OVA</span>
</span></span><span class="line"><span class="cl">build-ovf: <span class="c1">## build the ovf template by clone the base os template</span>
</span></span><span class="line"><span class="cl">    packer build <span class="k">$(</span>PACKER_VARS<span class="k">)</span> -only vsphere-clone <span class="k">$(</span>PACKER_VAR_FILES<span class="k">)</span> <span class="k">$(</span>PACKER_CONFIG_DIR<span class="k">)</span>/builder.json
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Building BASE templates</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 通过 PACKER_BASE_OS 参数设置 base os 是 photon3 还是 centos7</span>
</span></span><span class="line"><span class="cl">$ make build-template <span class="nv">PACKER_BASE_OS</span><span class="o">=</span>photon3
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Build OVF templates and export to OVA</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 通过 PACKER_BASE_OS 参数设置 base os 是 photon3 还是 centos7</span>
</span></span><span class="line"><span class="cl">$ make build-ovf <span class="nv">PACKER_BASE_OS</span><span class="o">=</span>photon3
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="build-process">Build process</h2>
<p>After wrapping the Packer configuration file and Makefile, we can run the <code>make build-template</code> and <code>make build-ovf</code> commands to build the VM template, and the overall build process is as follows.</p>
<ul>
<li>First build a business-independent base VM using ISO</li>
<li>Build the business VM on top of the base VM by vsphere-clone</li>
<li>Export the OVF virtual machine file and package it as a virtual machine template in OVA format</li>
</ul>
<h3 id="building-a-base-virtual-machine-with-vsphere-iso">Building a Base Virtual Machine with vsphere-iso</h3>
<p>The base virtual machine is a bit like the FROM base image in Dockerfile. In Packer, we can make a base virtual machine of something that will rarely be changed. Then we can clone a new virtual machine from this base virtual machine to complete the build process, which saves the overall build time and makes the build more efficient.</p>
<ul>
<li>
<p>centos7 build output log</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">vsphere-iso-base: output will be in this color.
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: File /root/.cache/packer/e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already uploaded; continuing
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: File [Packer] packer_cache//e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already exists; skipping upload.
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: the vm/template Packer/base-os-centos7 already exists, but deleting it due to -force flag
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Creating VM...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Customizing hardware...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Mounting ISO images...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Adding configuration parameters...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Creating floppy disk...
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Copying files flatly from floppy_files
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Done copying files from floppy_files
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Collecting paths from floppy_dirs
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Resulting paths from floppy_dirs : [./kickstart/centos/http/]
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Recursively copying : ./kickstart/centos/http/
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Done copying paths from floppy_dirs
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Copying files from floppy_content
</span></span><span class="line"><span class="cl">    vsphere-iso-base: Done copying files from floppy_content
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Uploading created floppy image
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Adding generated Floppy...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Set boot order temporary...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Power on VM...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Waiting 15s for boot...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Typing boot command...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Waiting for IP...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: IP address: 192.168.29.46
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.46
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Waiting for SSH to become available...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Connected to SSH!
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Executing shutdown command...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Deleting Floppy drives...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Deleting Floppy image...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Eject CD-ROM drives...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Creating snapshot...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Clear boot order...
</span></span><span class="line"><span class="cl">Build &#39;vsphere-iso-base&#39; finished after 6 minutes 42 seconds.
</span></span><span class="line"><span class="cl">==&gt; Wait completed after 6 minutes 42 seconds
</span></span><span class="line"><span class="cl">==&gt; Builds finished. The artifacts of successful builds are:
</span></span><span class="line"><span class="cl">--&gt; vsphere-iso-base: base-os-centos7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d] ls packer_cache/
</span></span><span class="line"><span class="cl">51511394170e64707b662ca8db012be4d23e121f.iso  d3e175624fc2d704975ce9a149f8f270e4768727.iso  e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso
</span></span><span class="line"><span class="cl">[root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d] ls -alh base-os-centos7/
</span></span><span class="line"><span class="cl">total 4281536
</span></span><span class="line"><span class="cl">drwxr-xr-x    1 root     root       72.0K Apr  1 09:17 .
</span></span><span class="line"><span class="cl">drwxr-xr-t    1 root     root       76.0K Apr  1 09:17 ..
</span></span><span class="line"><span class="cl">-rw-------    1 root     root        4.0G Apr  1 09:17 base-os-centos7-3ea6b205.vswp
</span></span><span class="line"><span class="cl">-rw-r--r--    1 root     root         253 Apr  1 09:17 base-os-centos7-65ff34a3.hlog
</span></span><span class="line"><span class="cl">-rw-------    1 root     root       64.0G Apr  1 09:17 base-os-centos7-flat.vmdk
</span></span><span class="line"><span class="cl">-rw-------    1 root     root        8.5K Apr  1 09:17 base-os-centos7.nvram
</span></span><span class="line"><span class="cl">-rw-------    1 root     root         482 Apr  1 09:17 base-os-centos7.vmdk
</span></span><span class="line"><span class="cl">-rw-r--r--    1 root     root           0 Apr  1 09:17 base-os-centos7.vmsd
</span></span><span class="line"><span class="cl">-rwxr-xr-x    1 root     root        2.3K Apr  1 09:17 base-os-centos7.vmx
</span></span><span class="line"><span class="cl">-rw-------    1 root     root           0 Apr  1 09:17 base-os-centos7.vmx.lck
</span></span><span class="line"><span class="cl">-rwxr-xr-x    1 root     root        2.2K Apr  1 09:17 base-os-centos7.vmx~
</span></span><span class="line"><span class="cl">-rw-------    1 root     root        1.4M Apr  1 09:17 packer-tmp-created-floppy.flp
</span></span><span class="line"><span class="cl">-rw-r--r--    1 root     root       96.1K Apr  1 09:17 vmware.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@devbox-fedora:/root # scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">root@devbox-fedora:/root # mount packer-tmp-created-floppy.flp /mnt
</span></span><span class="line"><span class="cl">root@devbox-fedora:/root # readlink /dev/disk/by-label/packer
</span></span><span class="line"><span class="cl">../../loop2
</span></span><span class="line"><span class="cl">root@devbox-fedora:/root # ls /mnt/HTTP/7/KS.CFG
</span></span><span class="line"><span class="cl">KS.CFG
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Photon3 Build Output Log</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">vsphere-iso-base: output will be in this color.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: File /root/.cache/packer/d3e175624fc2d704975ce9a149f8f270e4768727.iso already uploaded; continuing
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: File [Packer] packer_cache//d3e175624fc2d704975ce9a149f8f270e4768727.iso already exists; skipping upload.
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: the vm/template Packer/base-os-photon3 already exists, but deleting it due to -force flag
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Creating VM...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Customizing hardware...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Mounting ISO images...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Adding configuration parameters...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Starting HTTP server on port 8674
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Set boot order temporary...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Power on VM...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Waiting 15s for boot...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: HTTP server is working at http://192.168.29.171:8674/
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Typing boot command...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Waiting for IP...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: IP address: 192.168.29.208
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.208
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Waiting for SSH to become available...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Connected to SSH!
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Executing shutdown command...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Deleting Floppy drives...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Eject CD-ROM drives...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Creating snapshot...
</span></span><span class="line"><span class="cl">==&gt; vsphere-iso-base: Clear boot order...
</span></span><span class="line"><span class="cl">Build &#39;vsphere-iso-base&#39; finished after 5 minutes 24 seconds.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">==&gt; Wait completed after 5 minutes 24 seconds
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">==&gt; Builds finished. The artifacts of successful builds are:
</span></span><span class="line"><span class="cl">--&gt; vsphere-iso-base: base-os-photon3
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>From the output of the <code>packer build</code> command, we can roughly deduce the main steps and principles of building a Base virtual machine with vsphere-iso.</p>
<ul>
<li>Download the ISO file to the local ${HOME}/.cache/packer directory and save it as checksum.iso, which has the advantage of making it easier to cache the ISO file and avoid repeated downloads.</li>
<li>Upload the local ISO file to the datastore of vCenter, which is saved in the packer_cache directory of the datastore by default, skipping the upload process if the ISO file already exists.</li>
<li>Create the virtual machine, configure the virtual machine hardware, mount the uploaded ISO file to the CD/ROM on the virtual machine, and set the boot boot entry to CD/ROM</li>
<li>If <a href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso#boot-configuration">boot_media_path</a> is of type http, then listen to a random TCP port locally to run an http service to provide HTTP downloads of kickstart files; if it is a directory type, create the kickstart file as a floppy file, upload the file to the datastore, and insert the floppy file into the virtual machine.</li>
<li>The virtual machine boots up to the ISO boot page and sends keyboard input via the vCenter API to insert the path to the kickstart file.</li>
<li>Send a carriage return keyboard input through the vCenter API and the OS installer in the ISO reads kickstart for OS installation.</li>
<li>Install the <a href="https://github.com/vmware/open-vm-tools">open-vm-tools</a> utility in the kickstart script.</li>
<li>Wait for the OS installation to finish, reboot into the installed OS after the installation is complete, and get the IP address via DHCP after the OS boots.</li>
<li>Get the IP address of the virtual machine through vm-tools, then ssh to the virtual machine to execute the shutdown command.</li>
<li>Shutting down the virtual machine and uninstalling unneeded devices such as ISOs and floppy drives.</li>
<li>creating snapshots or converting virtual machines to templates.</li>
</ul>
<p>Personally, I find it interesting that you can actually use vCenter or ESXi&rsquo;s <a href="https://vdc-repo.vmware.com/vmwb-repository/dcr-public/1ef6c336-7bef-477d-b9bb-caa1767d7e30/82521f49-9d9a-42b7-b19b-9e6cd9b30db1/vim.VirtualMachine.html#putUsbScanCodes">PutUsbScanCodes</a> API to send some keyboard input commands to the virtual machine, which is amazing. Previously our project was to build the kickstart file as an ISO file and then modify the isolinux startup parameters by rebuilding the source ISO. We felt that this was a stupid way to rebuild the ISO, so we took Packer&rsquo;s idea and used the built-in <a href="https://github.com/vmware/govmomi/blob/master/govc/vm/keystrokes.go">vm.keystrokes</a> command in govc to send keyboard commands to the virtual machine to complete the operation of specifying the kickstart file path parameter. The specific govc commands can be found below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 发送 tab 键，进入到 ISO 启动参数编辑页面</span>
</span></span><span class="line"><span class="cl">$ govc vm.keystrokes -vm<span class="o">=</span><span class="s1">&#39;centos-vm-192&#39;</span> -c<span class="o">=</span><span class="s1">&#39;KEY_TAB&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发送 Right Control + U 键清空输入框</span>
</span></span><span class="line"><span class="cl">$ govc vm.keystrokes -vm<span class="o">=</span><span class="s1">&#39;centos-vm-192&#39;</span> -rc<span class="o">=</span><span class="nb">true</span> -c<span class="o">=</span><span class="s1">&#39;KEY_U&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 输入 isolinux 的启动参数配置，通过 ks=hd:LABEL=KS:/ks.cfg 指定 kickstart 路径，LABEL 为构建 ISO 时设置的 lable</span>
</span></span><span class="line"><span class="cl">$ govc vm.keystrokes -vm<span class="o">=</span><span class="s1">&#39;centos-vm-192&#39;</span> -s<span class="o">=</span><span class="s1">&#39;vmlinuz initrd=initrd.img ks=hd:LABEL=KS:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet console=ttyS0&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 按下回车键，开始安装 OS</span>
</span></span><span class="line"><span class="cl">$ govc vm.keystrokes -vm<span class="o">=</span><span class="s1">&#39;centos-vm-192&#39;</span> -c<span class="o">=</span><span class="s1">&#39;KEY_ENTER&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="build-business-vm-and-export-ovfova-via-vsphere-clone">Build business VM and export OVF/OVA via vsphere-clone</h3>
<p>After building the Base VM via vsphere-iso, we use this base VM to clone a new VM to build our business VM image, packing in a bunch of tools like k3s, argo-workflow, redfish-esxi-os-installer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">vsphere-clone: output will be in this color.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Cloning VM...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Customizing hardware...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Power on VM...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Waiting <span class="k">for</span> IP...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: IP address: 192.168.30.112
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Using SSH communicator to connect: 192.168.30.112
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Waiting <span class="k">for</span> SSH to become available...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Connected to SSH!
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Uploading <span class="nv">scripts</span> <span class="o">=</span>&gt; /root
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Uploading <span class="nv">resources</span> <span class="o">=</span>&gt; /root
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Provisioning with shell script: /tmp/packer-shell557168976
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Executing shutdown command...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Creating snapshot...
</span></span><span class="line"><span class="cl">    vsphere-clone: Starting export...
</span></span><span class="line"><span class="cl">    vsphere-clone: Downloading: k3s-photon3-c4ca93f-disk-0.vmdk
</span></span><span class="line"><span class="cl">    vsphere-clone: Exporting file: k3s-photon3-c4ca93f-disk-0.vmdk
</span></span><span class="line"><span class="cl">    vsphere-clone: Writing ovf...
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Running post-processor: packer-manifest <span class="o">(</span><span class="nb">type</span> manifest<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone: Running post-processor: vsphere <span class="o">(</span><span class="nb">type</span> shell-local<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: Running <span class="nb">local</span> shell script: /tmp/packer-shell2376077966
</span></span><span class="line"><span class="cl">    vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: image-build-ova: <span class="nb">cd</span> /root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f
</span></span><span class="line"><span class="cl">    vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: image-build-ova: create ovf k3s-photon3-c4ca93f.ovf
</span></span><span class="line"><span class="cl">    vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: image-build-ova: create ova manifest k3s-photon3-c4ca93f.mf
</span></span><span class="line"><span class="cl">    vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: image-build-ova: creating OVA using tar
</span></span><span class="line"><span class="cl">    vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: image-build-ova: <span class="o">[</span><span class="s1">&#39;tar&#39;</span>, <span class="s1">&#39;-c&#39;</span>, <span class="s1">&#39;-f&#39;</span>, <span class="s1">&#39;k3s-photon3-c4ca93f.ova&#39;</span>, <span class="s1">&#39;k3s-photon3-c4ca93f.ovf&#39;</span>, <span class="s1">&#39;k3s-photon3-c4ca93f.mf&#39;</span>, <span class="s1">&#39;k3s-photon3-c4ca93f-disk-0.vmdk&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    vsphere-clone <span class="o">(</span>shell-local<span class="o">)</span>: image-build-ova: create ova checksum k3s-photon3-c4ca93f.ova.sha256
</span></span><span class="line"><span class="cl">Build <span class="s1">&#39;vsphere-clone&#39;</span> finished after <span class="m">14</span> minutes <span class="m">16</span> seconds.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; Wait completed after <span class="m">14</span> minutes <span class="m">16</span> <span class="nv">seconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==</span>&gt; Builds finished. The artifacts of successful builds are:
</span></span><span class="line"><span class="cl">--&gt; vsphere-clone: k3s-photon3-c4ca93f
</span></span><span class="line"><span class="cl">--&gt; vsphere-clone: k3s-photon3-c4ca93f
</span></span><span class="line"><span class="cl">--&gt; vsphere-clone: k3s-photon3-c4ca93f
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the output of the packer build command, we can roughly infer the build process.</p>
<ul>
<li>clone the virtual machine, modify the hardware configuration of the virtual machine</li>
<li>boot up the virtual machine and get the IP address of the virtual machine through vm-tools</li>
<li>Get the IP address of the virtual machine and wait for ssh to connect properly.</li>
<li>Once ssh is connected, upload files via scp</li>
<li>ssh remotely execute the <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/install.sh">install.sh</a> script in the virtual machine</li>
<li>Execute virtual machine shutdown commands</li>
<li>Create a snapshot of the virtual machine</li>
<li>Export virtual machine OVF files</li>
<li>Export the manifest.json file of the build configuration parameters</li>
<li>Execute the <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/ova.py">ova.py</a> script to convert the OVF format to OVA based on the manifest.json configuration parameters</li>
</ul>
<p>At this point, the entire VM template building process is complete, and we end up with an OVA-formatted VM template. When you use it, you only need to install VMware Workstation or Oracle VirtualBox on your local machine to import the virtual machine with one click, and then you can use it after booting, which is out of the box.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">output
</span></span><span class="line"><span class="cl">└── k3s-photon3-c4ca93f
</span></span><span class="line"><span class="cl">    ├── k3s-photon3-c4ca93f-disk-0.vmdk
</span></span><span class="line"><span class="cl">    ├── k3s-photon3-c4ca93f.mf
</span></span><span class="line"><span class="cl">    ├── k3s-photon3-c4ca93f.ova
</span></span><span class="line"><span class="cl">    ├── k3s-photon3-c4ca93f.ova.sha256
</span></span><span class="line"><span class="cl">    ├── k3s-photon3-c4ca93f.ovf
</span></span><span class="line"><span class="cl">    └── packer-manifest.json
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="argo-workflow-and-k3s">argo-workflow and k3s</h2>
<p>Using redfish-esxi-os-installer inside the VM is a bit special, it is executed inside the Pod of argo-workflow. In the workflow template file <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/workflow.yaml">workflow.yaml</a> we define several steps to run redfish-esxi-os-installer.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Workflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generateName</span><span class="p">:</span><span class="w"> </span><span class="l">redfish-esxi-os-installer-</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l">redfish-esxi-os-installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">templates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redfish-esxi-os-installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- - <span class="nt">arguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">pre-check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Precheck</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- - <span class="nt">arguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">build-iso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">BuildISO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- - <span class="nt">arguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">mount-iso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MountISO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- - <span class="nt">arguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">reboot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Reboot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- - <span class="nt">arguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">post-check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Postcheck</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- - <span class="nt">arguments</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">umount-iso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">UmountISO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">container</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ghcr.io/muzi502/redfish-esxi-os-installer:v0.1.0-alpha.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- -<span class="l">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        </span><span class="w">        </span><span class="l">make inventory &amp;&amp; make {{inputs.parameters.command}}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">POD_NAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">HOST_IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">status.hostIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">SRC_ISO_DIR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/data/iso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP_DIR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">/data/iso/redfish</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">HTTP_URL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">http://$(HOST_IP)/files/iso/redfish</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ESXI_ISO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redfish-esxi-os-installer-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">esxi_iso</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/ansible/config.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l">config.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">inputs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">parameters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">command</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">installer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">retryStrategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">limit</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">retryPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">items</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">config.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">redfish-esxi-os-installer-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">DirectoryOrCreate</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Since there is no Web UI and backend Server, you still need to edit <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/configmap.yaml">/root/resources/workflow/configmap.yaml</a> configuration file, and then execute <code>kubectl create -f /root/resources/workflow</code> to create the workflow workflow.</p>
<p>Once the workflow is created, you can view the progress and status of the workflow execution with the argo command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">root@localhost <span class="o">[</span> ~/resources/workflow <span class="o">]</span><span class="c1"># argo get redfish-esxi-os-installer-tjjqz</span>
</span></span><span class="line"><span class="cl">Name:                redfish-esxi-os-installer-tjjqz
</span></span><span class="line"><span class="cl">Namespace:           default
</span></span><span class="line"><span class="cl">ServiceAccount:      <span class="nb">unset</span> <span class="o">(</span>will run with the default ServiceAccount<span class="o">)</span>
</span></span><span class="line"><span class="cl">Status:              Succeeded
</span></span><span class="line"><span class="cl">Conditions:
</span></span><span class="line"><span class="cl"> PodRunning          False
</span></span><span class="line"><span class="cl"> Completed           True
</span></span><span class="line"><span class="cl">Created:             Mon May <span class="m">23</span> 11:07:31 +0000 <span class="o">(</span><span class="m">16</span> minutes ago<span class="o">)</span>
</span></span><span class="line"><span class="cl">Started:             Mon May <span class="m">23</span> 11:07:31 +0000 <span class="o">(</span><span class="m">16</span> minutes ago<span class="o">)</span>
</span></span><span class="line"><span class="cl">Finished:            Mon May <span class="m">23</span> 11:23:38 +0000 <span class="o">(</span><span class="m">19</span> seconds ago<span class="o">)</span>
</span></span><span class="line"><span class="cl">Duration:            <span class="m">16</span> minutes <span class="m">7</span> seconds
</span></span><span class="line"><span class="cl">Progress:            6/6
</span></span><span class="line"><span class="cl">ResourcesDuration:   29m45s*<span class="o">(</span><span class="m">1</span> cpu<span class="o">)</span>,29m45s*<span class="o">(</span>100Mi memory<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">STEP                                TEMPLATE                   PODNAME                                     DURATION  MESSAGE
</span></span><span class="line"><span class="cl"> ✔ redfish-esxi-os-installer-tjjqz  redfish-esxi-os-installer
</span></span><span class="line"><span class="cl"> ├───✔ Precheck<span class="o">(</span>0<span class="o">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-647555770   11s
</span></span><span class="line"><span class="cl"> ├───✔ BuildISO<span class="o">(</span>0<span class="o">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-3078771217  14s
</span></span><span class="line"><span class="cl"> ├───✔ MountISO<span class="o">(</span>0<span class="o">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-4099695623  19s
</span></span><span class="line"><span class="cl"> ├───✔ Reboot<span class="o">(</span>0<span class="o">)</span>                    installer                  redfish-esxi-os-installer-tjjqz-413209187   7s
</span></span><span class="line"><span class="cl"> ├───✔ Postcheck<span class="o">(</span>0<span class="o">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-2674696793  14m
</span></span><span class="line"><span class="cl"> └───✔ UmountISO<span class="o">(</span>0<span class="o">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-430254503   13s
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="argo-workflow">argo-workflow</h3>
<p>The reason why we use argo-workflow instead of command line tools like docker or nerdctl to run redfish-esxi-os-installer is that it is easier to schedule our installation and deployment tasks through argo-workflow to run multiple tasks at the same time, get the and logs, get task execution time, stop and retry, and so on. Using argo-workflow to orchestrate our installation and deployment tasks and getting the progress logs of the deployment tasks through argo-workflow&rsquo;s RESTful API is a bit more cloud-native.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/25/1fa10273a66d4e04a542cb968a2e01bd.png" alt="argo-workflow"></p>
<p>Our ultimate goal is to make this solution a product tool, providing a web UI to configure deployment parameters and displaying deployment progress logs. When we designed the solution, we also referred to the <a href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu Community Edition</a>: to deploy Tanzu management cluster, you need to have an existing k8s cluster, or a new k8s cluster through Tanzu. kind cluster. You can deploy a tanzu management cluster either through the tanzu command line or through the Tanzu Web UI, which is actually a product-oriented tool.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/25/aecd9892b67745168694e8739518752c.png" alt="VMware Tanzu Community Edition"></p>
<p>This solution is mainly for some productization scenarios, and the overall technology stack will be a bit complicated due to the introduction of K8s, a huge thing, but there are some benefits.</p>
<h3 id="k8s-and-k3s">k8s and k3s</h3>
<p>argo-workflow relies on a k8s cluster to run, and we have tested kubekey, sealos, kubespray, and k3s as common deployment tools internally. The k3s cluster takes up the least amount of resources. Referring to the resource requirements given in <a href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s Resource Analysis</a>, a minimum of 768M RAM is required to run. For laptops with less than adequate hardware resources, k3s is undoubtedly the best solution available.</p>
<p>Another very important reason is that k3s server makes it easy to change the IP address of a single control plan node, which is not perceptible to the user. This allows the installation of k3s to be done at the time of building the OVA, rather than manually executing the installation script at the time of use.</p>
<p>As long as the boot virtual machine can be assigned an intranet IPv4 address via DHCP or manually configured with a static IP, k3s will be up and running out of the box, rather than having to fill out a complicated configuration file like kubekey, sealos, or kubespray, and then run some commands to install k8s cluster. This is a very user-friendly way of importing virtual machines out-of-the-box.</p>
<p>Of course, it is not impossible to use kubekey, sealos, or kubespray to install a k8s cluster when building a virtual machine, but the IP address of the virtual machine when we build it (for example, 10.172.20.223) and the IP address when we use it (for example, 192.168.20.11) are basically not the same.</p>
<p>In fact, the idea of installing k8s when building a VM template was originally borrowed from the <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> project. I built some of the files and container images that k8s depends on into the VM template, so that when deploying k8s, you don&rsquo;t need to download these dependencies online. The difference is that we deploy the k8s cluster directly in advance with k3s, eliminating the need for the user to perform the deployment operation.</p>
<p>In summary, k3s is the best K8s base for this solution.</p>
<h2 id="other">Other</h2>
<h3 id="feeling-of-using">Feeling of using</h3>
<p>After using Packer for a while, I feel that it is an order of magnitude more complex and difficult to get started than Docker to build container images. This is probably because virtual machines do not have a unified industry standard for building, distributing, and running <a href="https://opencontainers.org/">OCI</a> like container images do. The creation and cloning of virtual machines is very tightly coupled with the underlying IaaS provider, which means that there are not many configuration parameters that can be reused between different IaaS providers such as vSphere, kvm/qemu. For example, vSphere has the concepts of datastore, datacenter, resource_pool, folder, etc., but kvm/qemu does not, which makes it difficult to unify them into one configuration.</p>
<h3 id="ova-format">OVA format</h3>
<p>OVA is used instead of other formats like vagrant.box, vmdk, raw, qcow2, etc. because OVA supports the one-click import feature, which is easier to use on Windows. After all, installing Vagrant or qemu/KVM on Windows is enough of a hassle for you, <a href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> or <a href="https://www.virtualbox.org/">Oracle VirtualBox</a> are more widely used.</p>
<p>In addition, Packer does not support exporting virtual machines to OVA directly, but only to ovf via vCenter&rsquo;s API by default.</p>
<p>There is also feedback in ISSUE <a href="https://github.com/hashicorp/packer/issues/9645">Add support for exporting to OVA in vsphere-iso builder #9645</a> about the need to support OVA export, but Packer does not support it yet. To convert OVF to OVA I refer to the image-builder project&rsquo;s <a href="https://github.com/kubernetes-sigs/image-builder/blob/master/images/capi/hack/image-build-ova.py"><strong>image-build-ova.py</strong></a> to do this.</p>
<h3 id="the-installation-of-open-vm-tool-failed">The installation of open-vm-tool failed</h3>
<p>Since the ISO does not contain the open-vm-tool package, it is necessary to install open-vm-tools over the network during the ISO installation of the OS. open-vm-tools installation may fail if the network jittered during the installation. open-vm-tools installation failure cannot be sensed by the packer and can only be executed after The packer cannot sense the failure of open-vm-tools installation, and can only wait until it times out to get the virtual machine IP and then exit. There is no good way to do this, but to retry when installing open-vm-tools in kickstart until open-vm-tools is successfully installed.</p>
<h3 id="reducing-exported-vmdk-file-size">Reducing exported vmdk file size</h3>
<p>The size of the exported vmdk file of a virtual machine can be significantly reduced by zeroing the dd.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">464M Aug <span class="m">28</span> 16:15 Ubuntu1804-2.ova <span class="c1"># 置零后的大小</span>
</span></span><span class="line"><span class="cl">1.3G Aug <span class="m">28</span> 15:48 Ubuntu1804.ova   <span class="c1"># 置零前的大小</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It should be noted that you should stop the k3s service before dd zeroing, otherwise the root root partition will be full when zeroing, which will cause kubelet to start GC and delete some images. I found some images missing after exporting a virtual machine before, and it took me a long time to find out that the kubelet GC deleted my images.</p>
<p>In addition, you can also delete some unnecessary files, such as containerd <code>io.containerd.content.v1.content/blobs/sha256</code> some image layer of the original blob file is not needed, you can delete them, so as to reduce part of the disk space occupation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">function</span> cleanup<span class="o">(){</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># stop k3s server for for prevent it starting the garbage collection to delete images</span>
</span></span><span class="line"><span class="cl">  systemctl stop k3s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Ensure on next boot that network devices get assigned unique IDs.</span>
</span></span><span class="line"><span class="cl">  sed -i <span class="s1">&#39;/^\(HWADDR\|UUID\)=/d&#39;</span> /etc/sysconfig/network-scripts/ifcfg-* 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Clean up network interface persistence</span>
</span></span><span class="line"><span class="cl">  find /var/log -type f -exec truncate --size<span class="o">=</span><span class="m">0</span> <span class="o">{}</span> <span class="se">\;</span>
</span></span><span class="line"><span class="cl">  rm -rf /tmp/* /var/tmp/*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># cleanup all blob files of registry download image</span>
</span></span><span class="line"><span class="cl">  find /var/lib/rancher/k3s/agent/containerd/io.containerd.content.v1.content/blobs/sha256 -size +1M -type f -delete
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># zero out the rest of the free space using dd, then delete the written file.</span>
</span></span><span class="line"><span class="cl">  dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/EMPTY <span class="nv">bs</span><span class="o">=</span>4M <span class="nv">status</span><span class="o">=</span>progress <span class="o">||</span> rm -f /EMPTY
</span></span><span class="line"><span class="cl">  dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/data/EMPTY <span class="nv">bs</span><span class="o">=</span>4M <span class="nv">status</span><span class="o">=</span>progress <span class="o">||</span> rm -f /data/EMPTY
</span></span><span class="line"><span class="cl">  <span class="c1"># run sync so Packer doesn&#39;t quit too early, before the large file is deleted.</span>
</span></span><span class="line"><span class="cl">  sync
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  yum clean all
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="photon3">Photon3</h3>
<p>VMware&rsquo;s Linux distribution <a href="https://vmware.github.io/photon/assets/files/html/3.0/">Photon</a>. Unlike traditional Linux distributions, Photon&rsquo;s system is very lean, so using it instead of CentOS can reduce system resources to a certain extent, and the exported vmdk file is smaller than CentOS.</p>
<h3 id="goss">goss</h3>
<p>During the build process we installed some other components on the k3s cluster, such as filebrowser, which provides file upload and download services, and argo-workflow, the workflow workflow engine, to ensure that these services are running properly, we need to check if they are working in different ways. Generally, we use commands like kubectl get to see if deployment, pod, daemonset, etc. are running properly, or curl to access the health check APIs for these services.</p>
<p>Because of the number and complexity of the checks, it is not very convenient to use traditional shell scripts to do this, which require parsing the exit codes and return values of each command. So we use <a href="https://github.com/aelsabbahy/goss">goss</a> to define some checks via YAML formatted configuration files and let it perform them in bulk, instead of writing a bunch of awk/grep commands to check each check in the shell.</p>
<ul>
<li>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/k3s.yaml">k3s.yaml</a>: check if k3s and the services it comes with by default are running properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># DNS 类型的检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 coredns 是否能够正常解析到 kubernetes apiserver 的 service IP 地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetes.default.svc.cluster.local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resolvable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">addrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">10.43.0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">10.43.0.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># TCP/UDP 端口类型的检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">addr</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 coredns 的 UDP 53 端口是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">udp://10.43.0.10:53</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">reachable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 cni0 网桥是否存在</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">interface</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">cni0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exists</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">addrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">10.42.0.1</span><span class="l">/24</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 本机端口类型的检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">port</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 ssh 22 端口是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tcp:22</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listening</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ip</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">0.0.0.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 kubernetes apiserver 6443 端口是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tcp6:6443</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">listening</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查一些 systemd 服务的检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 默认禁用 firewalld 服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">firewalld</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">running</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 确保 sshd 服务正常运行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">sshd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">running</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 k3s 服务是否正常运行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">k3s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">running</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 定义一些 shell 命令执行的检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 kubernetes cheduler 组件是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_k8s_scheduler_health</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">curl -k https://127.0.0.1:10259/healthz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 退出码是否为 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 标准输出中是否包含正确的输出值</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ok&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 kubernetes controller-manager 是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_k8s_controller-manager_health</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">curl -k https://127.0.0.1:10257/healthz</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ok&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 cluster-info  中输出的组件运行状态是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_cluster_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl cluster-info | grep &#39;is running&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">CoreDNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Kubernetes control plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查节点是否处于 Ready 状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_node_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl get node -o jsonpath=&#39;{.items[].status}&#39; | jq -r &#39;.conditions[-1].type&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">Ready</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查节点 IP 是否正确</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_node_address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl get node -o wide -o json | jq -r &#39;.items[0].status.addresses[] | select(.type == &#34;InternalIP&#34;) | .address&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Vars.ip_address }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 traefik loadBalancer 的 IP 地址是否正确</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_traefik_address</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl -n kube-system get svc traefik -o json | jq -r &#39;.status.loadBalancer.ingress[].ip&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- {{<span class="w"> </span><span class="l">.Vars.ip_address }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 containerd 容器运行是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_container_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">crictl ps --output=json | jq -r &#39;.containers[].metadata.name&#39; | sort -u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">coredns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">/lb-.*-443/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">/lb-.*-80/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 kube-system namespace 下的 pod 是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_kube_system_namespace_pod_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl get pod -n kube-system -o json | jq -r &#39;.items[] | select((.status.phase != &#34;Running&#34;) and (.status.phase != &#34;Succeeded&#34;) and (.status.phase != &#34;Completed&#34;))&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;!string&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 k8s deployment 服务是否都正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_k8s_deployment_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl get deploy --all-namespaces -o json | jq -r &#39;.items[]| select(.status.replicas == .status.availableReplicas) | .metadata.name&#39; | sort -u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">coredns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 svclb-traefik daemonset 是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_k8s_daemonset_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl get daemonset --all-namespaces -o json | jq -r &#39;.items[]| select(.status.replicas == .status.availableReplicas) | .metadata.name&#39; | sort -u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">svclb-traefik</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/goss.yaml">goss.yaml</a>: used to check if some of the services we deployed are working</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 通过 include 其他 gossfile 方式将上面定义的 k3s.yaml 检查项也包含进来</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">gossfile</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">k3s.yaml</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查部署的 filebrowser deployment 的 service IP 是否能正常解析到</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">filebrowser.default.svc.cluster.local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resolvable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">10.43.0.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查部署的 argo-workflow deployment 的 service IP 是否能正常解析到</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">argo-workflow-argo-workflows-server.default.svc.cluster.local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resolvable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">10.43.0.10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 一些 HTTP 请求方式的检查</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 filebrowser 服务是否正常运行，类似于 pod 里的存活探针</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">http://{{ .Vars.ip_address }}/filebrowser/:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查 argo-workflow 是否正常运行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">http://{{ .Vars.ip_address }}/workflows/api/v1/version:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="m">200</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l">GET</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 同样也是一些 shell 命令的检查项目</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查容器镜像是否齐全，避免缺镜像的问题</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_container_images</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">crictl images --output=json | jq -r &#39;.images[].repoTags[]&#39; | awk -F &#39;/&#39; &#39;{print $NF}&#39; | awk -F &#39;:&#39; &#39;{print $1}&#39; | sort -u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">argocli</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">argoexec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">workflow-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">filebrowser</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查容器运行的状态是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_container_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">crictl ps --output=json | jq -r &#39;.containers[].metadata.name&#39; | sort -u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">argo-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">filebrowser</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 检查一些 deployment 的状态是否正常</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_k8s_deployment_status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl get deploy -n default -o json | jq -r &#39;.items[]| select(.status.replicas == .status.availableReplicas) | .metadata.name&#39; | sort -u</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exit-status</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stderr</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stdout</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">argo-workflow-argo-workflows-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">argo-workflow-argo-workflows-workflow-controller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">filebrowser</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">skip</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 一些硬件参数的检查，比如 CPU 核心数、内存大小、可用内存大小</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">matching</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_vm_cpu_core</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Vars.cpu_core_number }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gt</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_vm_memory_size</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Vars.memory_size }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gt</span><span class="p">:</span><span class="w"> </span><span class="m">1880000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">check_available_memory_size</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Vars.available_memory_size }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gt</span><span class="p">:</span><span class="w"> </span><span class="m">600000</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>In addition, goss is also better suited to do some inspection work. For example, in a k8s cluster: check the status of the pods in the cluster, the status of kubernetes components, the running status of CNI, the network of nodes, disk storage space, CPU load, kernel parameters, daemonset service status, etc. You can define a series of checks in the above way, and use goss to do them automatically for us.</p>
<h3 id="pod-status-abnormal-after-importing-ova-vms">Pod status abnormal after importing OVA VMs</h3>
<p>After importing an OVA virtual machine on VMware Workstation, some Pods may be in an abnormal state due to changes in the virtual machine IP, which requires a forced removal and reboot of the Pods to restore them to normal. Therefore, you need to add a <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/prepare.sh">prepare.sh</a> script to the virtual machine to restart these Pods in an abnormal state. When the OVA VM is imported, run this script to get all Pods up and running, and then call goss to check if the other services are up and running.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o errexit
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o nounset
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pods --no-headers -n kube-system <span class="p">|</span> grep -E <span class="s1">&#39;0/2|0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> xargs -t -I <span class="o">{}</span> kubectl delete pod -n kube-system --grace-period<span class="o">=</span><span class="m">0</span> --force <span class="o">{}</span> &gt; /dev/null  2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">kubectl get pods --no-headers -n default <span class="p">|</span> grep -E <span class="s1">&#39;0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> xargs -t -I <span class="o">{}</span> kubectl delete pod -n default --grace-period<span class="o">=</span><span class="m">0</span> --force <span class="o">{}</span> &gt; /dev/null  2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> kubectl get pods --no-headers --all-namespaces <span class="p">|</span> grep -Ev <span class="s1">&#39;Running|Completed&#39;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Waiting for service readiness&#34;</span>
</span></span><span class="line"><span class="cl">    sleep <span class="m">10</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">break</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> <span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/.goss
</span></span><span class="line"><span class="cl">cat &gt; vars.yaml <span class="s">&lt;&lt; EOF
</span></span></span><span class="line"><span class="cl"><span class="s">ip_address: $(ip r get 1 | sed &#34;s/ uid.*//g&#34; | awk &#39;{print $NF}&#39; | head -n1)
</span></span></span><span class="line"><span class="cl"><span class="s">cpu_core_number: $(grep -c ^processor /proc/cpuinfo)
</span></span></span><span class="line"><span class="cl"><span class="s">memory_size: $(grep &#39;^MemTotal:&#39; /proc/meminfo | awk &#39;{print $2}&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s">available_memory_size: $(grep &#39;^MemAvailable:&#39; /proc/meminfo | awk &#39;{print $2}&#39;)
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">goss --vars vars.yaml -g goss.yaml validate --retry-timeout<span class="o">=</span>10s
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/k3s-advice/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">K3s Tools Advanced Guide</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/open-ebs/">
            <span class="next-text nav-default">OpenEBS Usage Guide</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
