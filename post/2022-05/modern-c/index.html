<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Features of Modern C and the experience of using it - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article describes the features of the modern C language and the experience of using it." /><meta name="keywords" content="c, Modern" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/modern-c/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Features of Modern C and the experience of using it" />
<meta property="og:description" content="This article describes the features of the modern C language and the experience of using it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/modern-c/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-02T11:03:25+08:00" />
<meta property="article:modified_time" content="2022-05-02T11:03:25+08:00" />

<meta itemprop="name" content="Features of Modern C and the experience of using it">
<meta itemprop="description" content="This article describes the features of the modern C language and the experience of using it."><meta itemprop="datePublished" content="2022-05-02T11:03:25+08:00" />
<meta itemprop="dateModified" content="2022-05-02T11:03:25+08:00" />
<meta itemprop="wordCount" content="3728">
<meta itemprop="keywords" content="c," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Features of Modern C and the experience of using it"/>
<meta name="twitter:description" content="This article describes the features of the modern C language and the experience of using it."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Features of Modern C and the experience of using it</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-02 11:03:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3728 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background-introduction">Background introduction</a></li>
        <li><a href="#toolchain">Toolchain</a>
          <ul>
            <li><a href="#package-management">Package management</a></li>
            <li><a href="#makefile">Makefile</a></li>
          </ul>
        </li>
        <li><a href="#language-features">Language features</a>
          <ul>
            <li><a href="#interpreting-pointer-declarations">Interpreting pointer declarations</a></li>
            <li><a href="#memory-management">Memory management</a></li>
            <li><a href="#strings">Strings</a></li>
            <li><a href="#raw-string">Raw String</a></li>
            <li><a href="#designated-initializers">Designated Initializers</a></li>
            <li><a href="#static_assert">static_assert</a></li>
            <li><a href="#generic-selection">Generic selection</a></li>
            <li><a href="#multi-threading">Multi-threading</a></li>
          </ul>
        </li>
        <li><a href="#coding-style">Coding style</a>
          <ul>
            <li><a href="#error-handling">Error handling</a></li>
            <li><a href="#api-packaging">API Packaging</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/bf50f8f60de54b6e8ed9ddc97195609d.png" alt="c history"></p>
<p>Even if we count from K&amp;R C in 1978, C will be 44 years old in 2022.</p>
<p>I don&rsquo;t know what C looks like in the reader&rsquo;s mind, but I have the impression that C has poor expressiveness, only two high-level data structures, arrays and pointers, a small standard library and many historical problems, and no package management mechanism. The most fatal thing is that memory needs to be managed manually. It is difficult for modern young programmers to be interested in C. There are too many high-level languages to choose from, such as Java, the rising star Go/Rust, so why choose C.</p>
<h2 id="background-introduction">Background introduction</h2>
<p>In order to experience the development experience of C, I first read the book 21st Century C. This book is relatively short, so I can finish it quickly, but the book is also relatively shallow, so if you don&rsquo;t understand the tool chain of C before, reading this book will help, but it is limited to help write C code, so I revisited C Programming Language (2nd Edition - New Edition). I have to say, even after all these years, this book is still the best textbook for learning C. The content is concise and concise, with typical cases and not a word of nonsense in the whole book. The book is also relatively short, so you can read it in a week without doing exercises. If there is a drawback to this book, it is that the variable names do not need to be defined at the beginning of the function, now the C compiler is much more advanced than before.</p>
<p>With the bottom of K&amp;R C, you can directly start the real world. I recently developed a 2K line project with C: <a href="https://github.com/jiacai2050/oh-my-github">jiacai2050/oh-my-github</a>, not too trivial, mainly to experience the following content from this project.</p>
<ul>
<li>C development process, familiar with the relevant tool chain</li>
<li>C99/C11 language features</li>
<li>C coding style essentials, how to design APIs to avoid users stepping on potholes</li>
</ul>
<p>The following section summarizes what we have learned in the past few months, focusing on these three points. Due to the limited contact time, there are inevitably shortcomings in the text, and readers are welcome to criticize and correct them.</p>
<h2 id="toolchain">Toolchain</h2>
<p>Let&rsquo;s talk about the toolchain first. Before developing a formal project, there are some rather tedious things to do, such as configuring the development and debugging environment, installing dependencies, etc.. The language server I use is <a href="https://clangd.llvm.org/">clangd</a>, which supports variable definitions, references, auto-completion, etc. clangd uses <a href="https://clang.llvm.org/docs/JSONCompilationDatabase.html">compile_commands.json</a> file for configuration, some build tools can generate it directly, for simple personal projects, you can also directly use <code>compile_flags.txt</code> for configuration, sample usage:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">-I
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/jansson/2.14/include
</span></span><span class="line"><span class="cl">-I
</span></span><span class="line"><span class="cl">/opt/homebrew/Cellar/pcre2/10.40/include
</span></span></code></pre></td></tr></table>
</div>
</div><p>For veteran C programmers, they may be more familiar with <a href="https://github.com/universal-ctags/ctags">universal-ctags/ctags</a> and try it when they encounter a situation where LSP is not up to the task.</p>
<h3 id="package-management">Package management</h3>
<p>After the development tools are configured, it is often necessary to install dependencies before formally writing code, which brings us to an important topic: package management.</p>
<p>The most important point of package management is to ensure that the dependencies are fixed for each project, i.e. <a href="https://reproducible-builds.org/">reprodubile build</a>, which is not a simple matter of choosing the right version when directly or indirectly depending on multiple versions of a library, <a href="https://npm.github.io/how-npm-works-docs/npm2/how-npm2-works.html">npm2</a> that downloading each library dependency separately is one solution, and Go&rsquo;s <a href="https://go.dev/ref/mod#minimal-version-selection">Minimal version selection</a> is also a solution.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/5c09aea5847442dc98ec1776711ddd89.png" alt="npm2"></p>
<p>In NPM, there may be multiple versions of the same library.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/4d567c2828c24bac8a322cc6a7c2522a.png" alt="NPM relies on on disk"></p>
<p>This is the structure that NPM relies on on disk.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/01dc286ee9314ed7a54fcc6e2baa063b.png" alt="go mod"></p>
<p>In Go, under the same major version, the largest minor version that meets the requirements is selected.</p>
<p>Before describing how C does package management, let&rsquo;s review how C code is organized. A C project has two main types of files.</p>
<ul>
<li><code>.h</code> header files, which are mainly used for declarations, including function signatures, types, etc.</li>
<li><code>.c</code> source files, which are mainly used to provide implementation of the declarations in the header files</li>
</ul>
<p>These two types of files are used at different stages of the build, and can be found in the following image (<a href="https://www3.ntu.edu.sg/home/ehchua/programming/cpp/cp0_Introduction.html">source</a>).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/4c287fbaf2214e359a22722883f66a49.png" alt="C Build, Execute Process"></p>
<p>As you can see, the header files will only be used in the second phase (i.e. preprocessing), the source files will only be used in the third phase (i.e. compilation), and the fourth and fifth phases will link the user&rsquo;s own code together with the code of third-party dependencies to form the final executable.</p>
<p>When a project is used as a class library, the source code is generally not provided directly. Instead, a <code>.so</code> shared library or <code>.a</code> static library (created using the archive command) is provided corresponding to the source code file</p>
<p>This is to protect the source code from leaks on the one hand and to speed up the build process on the other. Users only need to compile their own code, and three-party dependencies do not need to be compiled repeatedly.</p>
<p>For C, there is no strict package organization, as long as the corresponding file can be found during compilation and linking. There are package managers in the community, such as <a href="https://vcpkg.io/en/index.html">vcpkg</a>, <a href="https://github.com/conan-io/conan">conan-io/conan</a>, <a href="https://cmake.org/">CMake</a>, etc. For personal projects, you can also choose the following approach: install the dependencies through the tools provided by the operating system (brew or apt, etc.) and then write the Makefile by hand to configure the compilation and linking parameters.</p>
<p>This approach may seem rudimentary, but it solves the problem more effectively, and with the addition of container technology, it also does a better job of version isolation. The only drawback is that it is not possible to specify the exact dependency version.</p>
<h3 id="makefile">Makefile</h3>
<p>The following is an introduction to the basic use of Makefile, a fully functional example can be found at: <a href="https://github.com/jiacai2050/oh-my-github/blob/master/Makefile">Makefile</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">P</span> <span class="o">=</span> program_name
</span></span><span class="line"><span class="cl"><span class="nv">OBJECTS</span> <span class="o">=</span> main.o
</span></span><span class="line"><span class="cl"><span class="nv">CFLAGS</span> <span class="o">=</span> -g -Wall -O3
</span></span><span class="line"><span class="cl"><span class="nv">LDLIBS</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">CC</span> <span class="o">=</span> gcc
</span></span><span class="line"><span class="cl"><span class="nf">$(P)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJECTS</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>OBJECTS<span class="k">)</span> <span class="k">$(</span>LDFLAGS<span class="k">)</span> -o <span class="k">$(</span>P<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is a relatively basic Makefile template. Makefile has default rules for converting <code>.c</code> files to <code>.o</code> files, with the following general commands.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nf">%.o</span><span class="o">:</span> %.<span class="n">c</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c $&lt; -o <span class="nv">$@</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, compile-time parameters can be defined via <code>CFLAGS</code>. There are several common <a href="https://www.gnu.org/software/make/manual/make.html#Automatic-Variables">variables</a> in the Makefile.</p>
<ul>
<li><code>$@</code> for target name</li>
<li><code>$*</code> for target name without suffix</li>
<li><code>$&lt;</code> for target dependencies, i.e., what comes after the colon</li>
</ul>
<p>You can use <a href="https://www.freedesktop.org/wiki/Software/pkg-config/">pkg-config</a> to simplify the manual configuration of CFLAGS, for example, if you have installed the dependency <code>libcurl</code>, you can use the following way to find Its compilation parameters and link parameters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># pkg-config --cflags --libs libcurl</span>
</span></span><span class="line"><span class="cl">-I/usr/include/aarch64-linux-gnu -lcurl
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>-I</code> is used to set the search directory for header files</li>
<li><code>-l</code> to specify the library to be linked by the linker</li>
</ul>
<p>Generally C libraries are distributed with the corresponding header files and compiled shared or static libraries. On Debian systems, you can find the files installed by <code>libcurl4-openssl-dev</code> with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">dpkg -L libcurl4-openssl-dev
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/usr/include/aarch64-linux-gnu/curl/curl.h
</span></span><span class="line"><span class="cl">/usr/include/aarch64-linux-gnu/curl/easy.h
</span></span><span class="line"><span class="cl">/usr/lib/aarch64-linux-gnu/libcurl.a
</span></span><span class="line"><span class="cl">/usr/lib/aarch64-linux-gnu/libcurl.so
</span></span></code></pre></td></tr></table>
</div>
</div><p>As for whether the linker chooses static or shared libraries, each linker does it differently, so refer to the documentation for the corresponding platform.</p>
<p>GNU ld does it by specifying static libraries by means of <code>-l:</code>, for example: <code>-l:libXYZ.a</code> will only go for <code>libXYZ.a</code>, while <code>-lXYZ</code> will expand to <code>libXYZ.so</code> or <code>libXYZ.a</code>. Reference.</p>
<ul>
<li><a href="https://stackoverflow.com/a/20728782/2163429">Telling gcc directly to link a library statically</a></li>
</ul>
<h2 id="language-features">Language features</h2>
<h3 id="interpreting-pointer-declarations">Interpreting pointer declarations</h3>
<p>Pointers, as the most important type of C, often cause a lot of trouble for beginners, not only in terms of usage, but also in terms of deciphering pointer definitions. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ptr</code> is better understood as a pointer to an int type, but what about <code>ptr2</code>? Is it a pointer to an array, or an array whose elements are pointers?</p>
<p>Actually, there is a nod to this question in the K&amp;R C book, namely</p>
<blockquote>
<p>The syntax of the declaration for a variable mimics the syntax of expressions in which the variable might appear.</p>
</blockquote>
<p>That is, the declaration syntax of a variable clarifies the type of that variable in the expression. It seems a bit difficult to understand, so look at a few examples to understand.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>*ptr</code> is an expression of type int, so ptr must be a pointer to int.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">arr</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>arr[i]</code> is an expression of type int, so arr must be an array and the elements of the array are int.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="o">*</span><span class="n">arr</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>*arr[i]</code> is an expression of type int, so <code>arr[i]</code> must be a pointer, so arr must be an array with elements that are pointers to int.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)[</span><span class="mi">100</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>(*ptr)[100]</code> is an expression of type int, so <code>ptr</code> must be a pointer to an array of type int.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="o">*</span><span class="n">comp</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>*comp()</code> is an expression of type int, so <code>comp()</code> must return an int pointer, so comp is a function that returns a pointer to an int.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">comp</span><span class="p">)()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>(*comp)()</code> is an expression of type int, so <code>*comp</code> must be a function, so comp is a function pointer</p>
<p>If you don&rsquo;t understand the above explanation, it doesn&rsquo;t matter, you can think about it when you write code. For complex declarations, it is generally recommended to use the typedef approach. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">int</span> <span class="o">*</span><span class="n">int_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="n">int_ptr</span> <span class="n">array_of_ten</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">array_of_ten</span> <span class="n">a1</span> <span class="o">=</span> <span class="p">...;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>a1</code> defined in this way is not much more difficult to understand; it is first an array whose elements are pointers to int. K&amp;R C has a program that converts complex declarations into textual descriptions: <a href="https://stackoverflow.com/questions/40388241/kr-recursive-descent-parser-strcat">K&amp;R - Recursive descent parser</a>.</p>
<h3 id="memory-management">Memory management</h3>
<p>C, being a system-level language, does not have runtime, and memory requested through functions like malloc needs to be freed manually by the programmer. This is something that high-level languages try to avoid nowadays, because programmers are very unreliable compared to computers. Fortunately, C has also evolved, and in the GNU99 extension (also supported by clang), a <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html#Common-Variable-Attributes">cleanup</a> attribute to simplify memory freeing.</p>
<p>Let&rsquo;s look at how memory releases were handled before cleanup was used (<a href="https://github.com/akheron/jansson/blob/master/doc/github_commits.c#L48">full code</a>).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">request</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CURL</span> <span class="o">*</span><span class="n">curl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CURLcode</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">curl_slist</span> <span class="o">*</span><span class="n">headers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">curl_global_init</span><span class="p">(</span><span class="n">CURL_GLOBAL_ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">curl</span> <span class="o">=</span> <span class="n">curl_easy_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">......</span> <span class="c1">// 省略中间逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">curl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">curl_easy_cleanup</span><span class="p">(</span><span class="n">curl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">curl_slist_free_all</span><span class="p">(</span><span class="n">headers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">curl_global_cleanup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>request</code> function is a relatively common practice in C, where the function getso to a unified place when it errors out, and cleans up memory there at the same time. Personally, I find this approach rather ugly, and it is easier to miss the release of a variable. Here&rsquo;s a look at how it looks after using cleanup.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free_char</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;free %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="n">__attribute</span><span class="p">((</span><span class="n">cleanup</span><span class="p">(</span><span class="n">free_char</span><span class="p">)))</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&#34;hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 依次输出：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// hello
</span></span></span><span class="line"><span class="cl"><span class="c1">// free hello
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, <code>str</code> executes <code>free_char</code> for resource usage before the main function exits. For ease of use, the following macro can be defined with <code>#define</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define auto_char_t char* __attribute((cleanup(free_char)))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// 使用方式：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">auto_char_t</span> <span class="n">str</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>One thing needs to be clear: cleanup can only be used in local variables, not in function parameters or return values. Therefore, a complete C project also needs to use other means to ensure memory safety, the main tools are <a href="https://clang.llvm.org/docs/AddressSanitizer.html">ASAN</a>, <a href="https://valgrind.org/">valgrind</a>, both of which are currently not The reader can choose according to the situation. Here is an example of the use of valgrind.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">valgrind</span> <span class="o">--</span><span class="n">tool</span><span class="o">=</span><span class="n">memcheck</span> <span class="o">--</span><span class="n">leak</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="n">full</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">leak</span><span class="o">-</span><span class="n">kinds</span><span class="o">=</span><span class="n">all</span> <span class="p">.</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">CLI</span><span class="p">)</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the case of a memory leak, something along the following lines will be reported.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span> HEAP SUMMARY:
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>     in use at exit: <span class="m">276</span> bytes in <span class="m">37</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>   total heap usage: 35,019 allocs, 34,982 frees, 279,075,706 bytes <span class="nv">allocated</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span> <span class="m">48</span> bytes in <span class="m">6</span> blocks are still reachable in loss record <span class="m">1</span> of <span class="nv">3</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    at 0x4849E4C: malloc <span class="o">(</span>vg_replace_malloc.c:307<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DB83F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DCE2F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x5843C5B: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DB73F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DC8DB: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57D8443: gcry_control <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x4CE9BC3: libssh2_init <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libssh2.so.1.0.1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x48D58CF: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libcurl.so.4.7.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x48831FB: curl_global_init <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libcurl.so.4.7.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10A0AB: omg_setup_context <span class="o">(</span>omg.c:184<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10DD0B: main <span class="o">(</span>cli.c:19<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span> <span class="m">84</span> bytes in <span class="m">25</span> blocks are definitely lost in loss record <span class="m">2</span> of <span class="nv">3</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    at 0x4849E4C: malloc <span class="o">(</span>vg_replace_malloc.c:307<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10D86B: omg_parse_trending <span class="o">(</span>omg.c:1116<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10DBEF: omg_query_trending <span class="o">(</span>omg.c:1176<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10DD6B: main <span class="o">(</span>cli.c:38<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span> <span class="m">144</span> bytes in <span class="m">6</span> blocks are still reachable in loss record <span class="m">3</span> of <span class="nv">3</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    at 0x4849E4C: malloc <span class="o">(</span>vg_replace_malloc.c:307<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DB83F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DCE2F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x5843C4F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DB73F: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57DC8DB: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x57D8443: gcry_control <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libgcrypt.so.20.2.8<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x4CE9BC3: libssh2_init <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libssh2.so.1.0.1<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x48D58CF: ??? <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libcurl.so.4.7.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x48831FB: curl_global_init <span class="o">(</span>in /usr/lib/aarch64-linux-gnu/libcurl.so.4.7.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10A0AB: omg_setup_context <span class="o">(</span>omg.c:184<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    by 0x10DD0B: main <span class="o">(</span>cli.c:19<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span> LEAK SUMMARY:
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    definitely lost: <span class="m">84</span> bytes in <span class="m">25</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    indirectly lost: <span class="m">0</span> bytes in <span class="m">0</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>      possibly lost: <span class="m">0</span> bytes in <span class="m">0</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>    still reachable: <span class="m">192</span> bytes in <span class="m">12</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">609</span><span class="o">==</span>         suppressed: <span class="m">0</span> bytes in <span class="m">0</span> blocks
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see the leaks very clearly, and then just follow the diagram to fix the corresponding logic. Report after repair.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">==</span><span class="nv">481</span><span class="o">==</span> LEAK SUMMARY:
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">481</span><span class="o">==</span>    definitely lost: <span class="m">0</span> bytes in <span class="m">0</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">481</span><span class="o">==</span>    indirectly lost: <span class="m">0</span> bytes in <span class="m">0</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">481</span><span class="o">==</span>      possibly lost: <span class="m">0</span> bytes in <span class="m">0</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">481</span><span class="o">==</span>    still reachable: <span class="m">192</span> bytes in <span class="m">12</span> <span class="nv">blocks</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="nv">481</span><span class="o">==</span>         suppressed: <span class="m">0</span> bytes in <span class="m">0</span> blocks
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition to using tools to avoid memory problems, a more elegant way is to design the API to ensure as few allocations as possible and to distinguish boundaries, which will be discussed later in the API design and not repeated here. The following links have more discussion on cleanup.</p>
<ul>
<li><a href="https://stackoverflow.com/questions/1828550/portable-equivalent-to-gccs-attribute-cleanup">Portable equivalent to gcc&rsquo;s <strong>attribute</strong>(cleanup)</a></li>
<li><a href="https://stackoverflow.com/questions/34574933/a-good-and-idiomatic-way-to-use-gcc-and-clang-attribute-cleanup-and-point">A good and idiomatic way to use GCC and clang <strong>attribute</strong>((cleanup)) and pointer declarations</a></li>
</ul>
<h3 id="strings">Strings</h3>
<p>There is no string type in C. It is only defined that when the last element of a character array is <code>NULL</code>, this array can be used as a string, and strings in this way are called <a href="https://en.cppreference.com/w/c/string/byte">Null-terminated byte strings</a>. Since the string length is not recorded, many operations take <code>O(n)</code> time, a more famous recent example being <a href="https://arstechnica.com/gaming/2021/03/hacker-reduces-gta-online-load-times-by-over-70-percent/">GTA developers</a>, which improves performance by 50% by removing <a href="http://www.cplusplus.com/reference/cstdio/sscanf/">sscanf</a>.</p>
<p>Moreover, there is no variable string like StringBuilder in C, so you need to manually request memory when performing some operations like replace/split, which is not only hard to use, but more importantly, prone to memory leaks and security problems. Here I have two recommended ways to simplify string handling in C.</p>
<ul>
<li>
<p>Try to use fixed-size local variables</p>
<p>When doing some string operations, sometimes you don&rsquo;t need to dynamically request memory, just use a fixed size of stack memory, which also saves you the trouble of free. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">url</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">sprintf</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&#34;%s/user/repos?type=all&amp;per_page=%zu&amp;page=%zu&amp;sort=created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">API_ROOT</span><span class="p">,</span> <span class="n">PER_PAGE</span><span class="p">,</span> <span class="n">page_num</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Try to use mature string libraries from the community instead of <code>string.h</code></p>
<p>such as Redis author&rsquo;s <a href="https://github.com/antirez/sds">Simple Dynamic Strings</a>, for more see: <a href="https://stackoverflow.com/questions/4688041/good-c-string-library">Good C string library - Stack Overflow</a></p>
</li>
<li>
<p>Similarly, there is an implementation of hashtable in C.</p>
<ul>
<li><a href="https://github.com/nothings/stb/blob/master/stb_ds.h">stb/stb_ds.h at master · nothings/stb</a></li>
</ul>
</li>
</ul>
<h3 id="raw-string">Raw String</h3>
<p>In the real world, there are inevitably more complex string scenarios, and other programming languages provide raw strings to simplify the process. In the current C standard, this usage is not supported, but the GNU99 extension provides this functionality:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">printf</span><span class="p">(</span><span class="n">R</span><span class="s">&#34;(hello</span><span class="se">\n</span><span class="s">world</span><span class="se">\n</span><span class="s">)&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition to this use of the GNU99 extension, the xxd command can also be used to embed the contents of a file into C code in the following manner.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">echo</span> <span class="n">hello</span> <span class="o">&gt;</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span>
</span></span><span class="line"><span class="cl"><span class="n">xxd</span> <span class="o">-</span><span class="n">i</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp"># -i 参数会输出 C 头文件格式的变量定义
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hello_txt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x0a</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hello_txt_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that <code>hello_txt</code> does not end with <code>NULL</code>, which is not very convenient in some cases, and can be appended with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">xxd</span> <span class="o">-</span><span class="n">i</span> <span class="n">hello</span><span class="p">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">tac</span> <span class="o">|</span> <span class="n">sed</span> <span class="err">&#39;</span><span class="mi">3</span><span class="n">s</span><span class="o">/</span><span class="err">$$</span><span class="o">/</span><span class="p">,</span> <span class="mh">0x00</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">tac</span> <span class="o">&gt;</span> <span class="n">hello</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="n">cat</span> <span class="n">hello</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl"><span class="cp"># 输出
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hello_txt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x0a</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hello_txt_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="designated-initializers">Designated Initializers</h3>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Designated-Inits.html">Designated Initializers</a>. It is no exaggeration to say that this is the most exciting feature of ISO C99, making C more like a modern language and more useful at the same time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">29</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 等价于
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 嵌套的结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">a</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">b</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="n">e</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">float</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">g</span> <span class="o">=</span> <span class="p">{.</span><span class="n">e</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When using this type of assignment, fields that are not assigned to a value are automatically initialized to zero, which is a very important point for pointers, which point to <code>NULL</code> instead of an arbitrary address.</p>
<h3 id="static_assert">static_assert</h3>
<p>This is a feature added to C11 to check the truth of an assertion at compile time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">static_assert</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#34;2+2 isn&#39;t 4&#34;</span><span class="p">);</span>      <span class="c1">// well-formed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">static_assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;this program requires that int is less than char&#34;</span><span class="p">);</span> <span class="c1">// compile-time error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="generic-selection">Generic selection</h3>
<p><a href="https://en.cppreference.com/w/c/language/generic">Generic selection</a>. This feature of C11 supports generic programming to a certain extent.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Possible implementation of the tgmath.h macro cbrt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define cbrt(X) _Generic((X),                   \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         long double: cbrtl,    \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         default: cbrt,         \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         float: cbrtf           \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         )(X)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">8.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">3.375</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;cbrt(8.0) = %f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cbrt</span><span class="p">(</span><span class="n">x</span><span class="p">));</span> <span class="c1">// selects the default cbrt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;cbrtf(3.375) = %f</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cbrt</span><span class="p">(</span><span class="n">y</span><span class="p">));</span> <span class="c1">// converts const float to float,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// then selects cbrtf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="multi-threading">Multi-threading</h3>
<p>C11 has added the following two header files for multi-threading support.</p>
<ul>
<li><a href="https://en.cppreference.com/w/c/thread">threads.h</a>, similar to the pthread library</li>
<li><a href="https://en.cppreference.com/w/c/atomic">stdatomic.h</a>, providing atomic variables and a C++-like <a href="https://en.cppreference.com/w/c/atomic/memory_order">memory order</a></li>
</ul>
<h2 id="coding-style">Coding style</h2>
<h3 id="error-handling">Error handling</h3>
<p>In traditional C, it is common practice for functions to return an integer error code, and the error message is obtained by reading a global variable. For example <a href="https://glibcdocs.readthedocs.io/en/latest/error_reporting.html">libc</a>, the processing logic is roughly as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">some_arg_t</span> <span class="n">args</span><span class="p">,</span> <span class="n">out_t</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">error_code</span> <span class="n">err</span> <span class="o">=</span> <span class="n">do_task1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="n">do_task2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">err</span> <span class="o">=</span> <span class="n">do_task3</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="nl">error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The real return value is passed through the last pointer parameter. This practice has a long history but has two drawbacks, as follows.</p>
<ul>
<li>Handling verbosity. Each function call requires error handling and cannot be chained</li>
<li>Forcing a single memory allocation. Because the return value needs to be assigned to a pointer argument, a memory allocation is inevitable</li>
</ul>
<p>A recommended approach, modeled after the <a href="https://doc.rust-lang.org/std/result/">Result</a> type in Rust, is to simply return a struct containing both the real data and the error message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">isize_t</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">valid_t</span> <span class="n">valid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">file_contents_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">file_contents_t</span> <span class="nf">read_file_contents</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Other functions use the <code>contents.valid</code> judgment when using the results, this way the above two problems are solved, the use of the effect is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">file_contents_t</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">read_file_contents</span><span class="p">(</span><span class="s">&#34;milo.cat&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">image_t</span> <span class="n">img</span> <span class="o">=</span> <span class="n">load_image_from_file_contents</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">texture_t</span> <span class="n">texture</span> <span class="o">=</span> <span class="n">load_texture_from_image</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">texture</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since the value type <code>struct</code> is returned directly, this indirectly reduces the stress of manually managing memory. And since there are no pointers to pointers, the program will theoretically run faster.</p>
<h3 id="api-packaging">API Packaging</h3>
<p>In the above introduction to C package management, it was mentioned that when C programs use a library, they only need to care about the header file, which defines the public interface to use the library, i.e. the implementation and the interface are separate.</p>
<p>However, in the general sense, the header file only encapsulates the function, only the declaration of the function, not the implementation, but in fact, it can also encapsulate the struct. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Opaque pointer representing an Emacs Lisp value.
</span></span></span><span class="line"><span class="cl"><span class="cm">   BEWARE: Do not assume NULL is a valid value!  */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">emacs_value_tag</span> <span class="o">*</span><span class="n">emacs_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">emacs_value</span> <span class="nf">init_value</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>emacs_value</code> is the encapsulation of the structure <code>emacs_value_tag</code>, the real definition of the structure in the source code file, the class library only needs to provide the constructor of the structure can be, the user does not need to sense the structure size and implementation.</p>
<p>For more information about the C API design, see this document (PDF), which is a <a href="https://news.ycombinator.com/item?id=21837920">discussion</a> of.</p>
<ul>
<li><a href="http://www.metamodulaire.org/Computing/modular-c.pdf">How to Write Reusable and Maintainable Code using the C Language.</a></li>
</ul>
<h2 id="summary">Summary</h2>
<p>As a language with a long history, C is not obsolete, but on the contrary, it has evolved gradually as the times progress. For programmers who have been using high-level languages for a long time, when they first switch to C, they may feel that it is too rudimentary and inefficient for development, but this is really just a superficial phenomenon that will fade away through familiarity with the whole ecosystem. And with less black magic, programmers will have a greater sense of control over the entire code base.</p>
<blockquote>
<p>In the beginning you always want results.</p>
<p>In the end all you want is CONTROL.</p>
</blockquote>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c/">c</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/linux-file-system/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Linux File System</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/state-management-in-risingwave/">
            <span class="next-text nav-default">State Management in RisingWave</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
