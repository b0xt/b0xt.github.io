<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How do I change the Kubernetes node IP address? - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Discover how to change the IP address of a Kubernetes node." /><meta name="keywords" content="k8s, Change Ip" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/change-k8s-node-ip/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How do I change the Kubernetes node IP address?" />
<meta property="og:description" content="Discover how to change the IP address of a Kubernetes node." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/change-k8s-node-ip/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-14T11:38:06+08:00" />
<meta property="article:modified_time" content="2022-05-14T11:38:06+08:00" />

<meta itemprop="name" content="How do I change the Kubernetes node IP address?">
<meta itemprop="description" content="Discover how to change the IP address of a Kubernetes node."><meta itemprop="datePublished" content="2022-05-14T11:38:06+08:00" />
<meta itemprop="dateModified" content="2022-05-14T11:38:06+08:00" />
<meta itemprop="wordCount" content="2737">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How do I change the Kubernetes node IP address?"/>
<meta name="twitter:description" content="Discover how to change the IP address of a Kubernetes node."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How do I change the Kubernetes node IP address?</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-14 11:38:06 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2737 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#environment">Environment</a></li>
        <li><a href="#operation-steps">Operation steps</a>
          <ul>
            <li><a href="#master-node">master node</a></li>
            <li><a href="#node-nodes">node nodes</a></li>
          </ul>
        </li>
        <li><a href="#recommended-operation">Recommended operation</a></li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Yesterday there was a problem with the network environment, the local virtual machine built Kubernetes environment does not have a fixed IP, the result of the node IP changed, of course the easiest way is to re-fix the node back to the previous IP address, but I stubbornly want to modify the IP address of the cluster, the results encountered a lot of problems, and not as simple as I thought.</p>
<h2 id="environment">Environment</h2>
<p>First look at the previous environment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ cat /etc/hosts
</span></span><span class="line"><span class="cl">192.168.0.111 master1
</span></span><span class="line"><span class="cl">192.168.0.109 node1
</span></span><span class="line"><span class="cl">192.168.0.110 node2
</span></span></code></pre></td></tr></table>
</div>
</div><p>New IP address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜  ~ cat /etc/hosts
</span></span><span class="line"><span class="cl">192.168.0.106 master1
</span></span><span class="line"><span class="cl">192.168.0.101 node1
</span></span><span class="line"><span class="cl">192.168.0.105 node2
</span></span></code></pre></td></tr></table>
</div>
</div><p>So we need to change the IP addresses of all nodes.</p>
<h2 id="operation-steps">Operation steps</h2>
<p>First change the <code>/etc/hosts</code> of all nodes to the new addresses.</p>
<blockquote>
<p>Before manipulating any files <strong>it is highly recommended to backup</strong> .</p>
</blockquote>
<h3 id="master-node">master node</h3>
<ol>
<li>
<p>Back up the <code>/etc/kubernetes</code> directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ cp -Rf /etc/kubernetes/ /etc/kubernetes-bak
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Replace the APIServer address of all configuration files in <code>/etc/kubernetes</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nv">oldip</span><span class="o">=</span>192.168.0.111
</span></span><span class="line"><span class="cl">➜ <span class="nv">newip</span><span class="o">=</span>192.168.0.106
</span></span><span class="line"><span class="cl"><span class="c1"># 查看之前的</span>
</span></span><span class="line"><span class="cl">➜ find . -type f <span class="p">|</span> xargs grep <span class="nv">$oldip</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 替换IP地址</span>
</span></span><span class="line"><span class="cl">➜ find . -type f <span class="p">|</span> xargs sed -i <span class="s2">&#34;s/</span><span class="nv">$oldip</span><span class="s2">/</span><span class="nv">$newip</span><span class="s2">/&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 检查更新后的</span>
</span></span><span class="line"><span class="cl">➜ find . -type f <span class="p">|</span> xargs grep <span class="nv">$newip</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Identify the certificate in <code>/etc/kubernetes/pki</code> that has the old IP address as the <code>alt name</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">cd</span> /etc/kubernetes/pki
</span></span><span class="line"><span class="cl">➜ <span class="k">for</span> f in <span class="k">$(</span>find -name <span class="s2">&#34;*.crt&#34;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">openssl x509 -in <span class="nv">$f</span> -text -noout &gt; <span class="nv">$f</span>.txt<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">➜ grep -Rl <span class="nv">$oldip</span> .
</span></span><span class="line"><span class="cl">➜ <span class="k">for</span> f in <span class="k">$(</span>find -name <span class="s2">&#34;*.crt&#34;</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span> rm <span class="nv">$f</span>.txt<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Find the ConfigMap in the <code>kube-system</code> namespace that references the old IP.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 获取所有的 kube-system 命名空间下面所有的 ConfigMap</span>
</span></span><span class="line"><span class="cl">➜ <span class="nv">configmaps</span><span class="o">=</span><span class="k">$(</span>kubectl -n kube-system get cm -o name <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>cut -d <span class="s1">&#39;/&#39;</span> -f 2<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 获取所有的ConfigMap资源清单</span>
</span></span><span class="line"><span class="cl">➜ <span class="nv">dir</span><span class="o">=</span><span class="k">$(</span>mktemp -d<span class="k">)</span>
</span></span><span class="line"><span class="cl">➜ <span class="k">for</span> cf in <span class="nv">$configmaps</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">kubectl -n kube-system get cm <span class="nv">$cf</span> -o yaml &gt; <span class="nv">$dir</span>/<span class="nv">$cf</span>.yaml
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 找到所有包含旧 IP 的 ConfigMap</span>
</span></span><span class="line"><span class="cl">➜ grep -Hn <span class="nv">$dir</span>/* -e <span class="nv">$oldip</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 然后编辑这些 ConfigMap，将旧 IP 替换成新的 IP</span>
</span></span><span class="line"><span class="cl">➜ kubectl -n kube-system edit cm kubeadm-config
</span></span><span class="line"><span class="cl">➜ kubectl -n kube-system edit cm kube-proxy
</span></span></code></pre></td></tr></table>
</div>
</div><p>This step is very, very important. I neglected this step when I was working on it, which caused Flannel CNI to fail to start and keep reporting errors, similar to the log message below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ kubectl logs -f kube-flannel-ds-pspzf -n kube-system
</span></span><span class="line"><span class="cl">I0512 14:46:26.044229       <span class="m">1</span> main.go:205<span class="o">]</span> CLI flags config: <span class="o">{</span>etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:<span class="o">[</span>ens33<span class="o">]</span> ifaceRegex:<span class="o">[]</span> ipMasq:true subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true<span class="o">}</span>
</span></span><span class="line"><span class="cl">W0512 14:46:26.044617       <span class="m">1</span> client_config.go:614<span class="o">]</span> Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
</span></span><span class="line"><span class="cl">E0512 14:46:56.142921       <span class="m">1</span> main.go:222<span class="o">]</span> Failed to create SubnetManager: error retrieving pod spec <span class="k">for</span> <span class="s1">&#39;kube-system/kube-flannel-ds-pspzf&#39;</span>: Get <span class="s2">&#34;https://10.96.0.1:443/api/v1/namespaces/kube-system/pods/kube-flannel-ds-pspzf&#34;</span>: dial tcp 10.96.0.1:443: i/o timeout
</span></span></code></pre></td></tr></table>
</div>
</div><p>Actually, I couldn&rsquo;t connect to the apiserver, and it took me a long time to check the kube-proxy logs, which showed the following error message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">E0512 14:53:03.260817       <span class="m">1</span> reflector.go:138<span class="o">]</span> k8s.io/client-go/informers/factory.go:134: Failed to watch *v1.EndpointSlice: failed to list *v1.EndpointSlice: Get <span class="s2">&#34;https://192.168.0.111:6443/apis/discovery.k8s.io/v1/endpointslices?labelSelector=%21service.kubernetes.io%2Fheadless%2C%21service.kubernetes.io%2Fservice-proxy-name&amp;limit=500&amp;resourceVersion=0&#34;</span>: dial tcp 192.168.0.111:6443: connect: no route to host
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is because the apiserver address configured in kube-proxy&rsquo;s ConfigMap is the old IP address, so be sure to replace it with the new one.</p>
</li>
<li>
<p>Delete the certificate and private key grep&rsquo;d in step 3 and regenerate them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">cd</span> /etc/kubernetes/pki
</span></span><span class="line"><span class="cl">➜ rm apiserver.crt apiserver.key
</span></span><span class="line"><span class="cl">➜ kubeadm init phase certs apiserver
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ rm etcd/peer.crt etcd/peer.key
</span></span><span class="line"><span class="cl">➜ kubeadm init phase certs etcd-peer
</span></span></code></pre></td></tr></table>
</div>
</div><p>It is of course possible to regenerate all of them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ kubeadm init phase certs all
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Generate a new kubeconfig file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">cd</span> /etc/kubernetes
</span></span><span class="line"><span class="cl">➜ rm -f admin.conf kubelet.conf controller-manager.conf scheduler.conf
</span></span><span class="line"><span class="cl">➜ kubeadm init phase kubeconfig all
</span></span><span class="line"><span class="cl">I0513 15:33:34.404780   <span class="m">52280</span> version.go:255<span class="o">]</span> remote version is much newer: v1.24.0<span class="p">;</span> falling back to: stable-1.22
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Using kubeconfig folder <span class="s2">&#34;/etc/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;kubelet.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="c1"># 覆盖默认的 kubeconfig 文件</span>
</span></span><span class="line"><span class="cl">➜ cp /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Restart the kubelet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ systemctl restart containerd
</span></span><span class="line"><span class="cl">➜ systemctl restart kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><p>The normal Kubernetes clusters are now accessible.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME      STATUS     ROLES                  AGE   VERSION
</span></span><span class="line"><span class="cl">master1   Ready      control-plane,master   48d   v1.22.8
</span></span><span class="line"><span class="cl">node1     NotReady   &lt;none&gt;                 48d   v1.22.8
</span></span><span class="line"><span class="cl">node2     NotReady   &lt;none&gt;                 48d   v1.22.8
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="node-nodes">node nodes</h3>
<p>Although the cluster is now accessible, we can see that the Node node is now in the <code>NotReady</code> state, and we can go check the kubelet logs for the node2 node.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ journalctl -u kubelet -f
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">May <span class="m">13</span> 15:47:55 node2 kubelet<span class="o">[</span>1194<span class="o">]</span>: E0513 15:47:55.470896    <span class="m">1194</span> kubelet.go:2412<span class="o">]</span> <span class="s2">&#34;Error getting node&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;node \&#34;node2\&#34; not found&#34;</span>
</span></span><span class="line"><span class="cl">May <span class="m">13</span> 15:47:55 node2 kubelet<span class="o">[</span>1194<span class="o">]</span>: E0513 15:47:55.531695    <span class="m">1194</span> reflector.go:138<span class="o">]</span> k8s.io/client-go/informers/factory.go:134: Failed to watch *v1.Service: failed to list *v1.Service: Get <span class="s2">&#34;https://192.168.0.111:6443/api/v1/services?limit=500&amp;resourceVersion=0&#34;</span>: dial tcp 192.168.0.111:6443: connect: no route to host
</span></span><span class="line"><span class="cl">May <span class="m">13</span> 15:47:55 node2 kubelet<span class="o">[</span>1194<span class="o">]</span>: E0513 15:47:55.571958    <span class="m">1194</span> kubelet.go:2412<span class="o">]</span> <span class="s2">&#34;Error getting node&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;node \&#34;node2\&#34; not found&#34;</span>
</span></span><span class="line"><span class="cl">May <span class="m">13</span> 15:47:55 node2 kubelet<span class="o">[</span>1194<span class="o">]</span>: E0513 15:47:55.673379    <span class="m">1194</span> kubelet.go:2412<span class="o">]</span> <span class="s2">&#34;Error getting node&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;node \&#34;node2\&#34; not found&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the previous APIServer address is still being accessed, so where is the APIServer address being used explicitly? We can check the kubelet startup parameters with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ systemctl status kubelet
</span></span><span class="line"><span class="cl">● kubelet.service - kubelet: The Kubernetes Node Agent
</span></span><span class="line"><span class="cl">   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/kubelet.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
</span></span><span class="line"><span class="cl">  Drop-In: /usr/lib/systemd/system/kubelet.service.d
</span></span><span class="line"><span class="cl">           └─10-kubeadm.conf
</span></span><span class="line"><span class="cl">   Active: active <span class="o">(</span>running<span class="o">)</span> since Fri 2022-05-13 14:37:31 CST<span class="p">;</span> 1h 13min ago
</span></span><span class="line"><span class="cl">     Docs: https://kubernetes.io/docs/
</span></span><span class="line"><span class="cl"> Main PID: <span class="m">1194</span> <span class="o">(</span>kubelet<span class="o">)</span>
</span></span><span class="line"><span class="cl">    Tasks: <span class="m">15</span>
</span></span><span class="line"><span class="cl">   Memory: 126.9M
</span></span><span class="line"><span class="cl">   CGroup: /system.slice/kubelet.service
</span></span><span class="line"><span class="cl">           └─1194 /usr/bin/kubelet --bootstrap-kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span class="o">=</span>/etc/kubernetes/kub...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">May <span class="m">13</span> 15:51:08 node2 kubelet<span class="o">[</span>1194<span class="o">]</span>: E0513 15:51:08.787677    <span class="m">1194</span> kubelet.go:2412<span class="o">]</span> <span class="s2">&#34;Error getting node&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;node \&#34;node2... found&#34;</span>
</span></span><span class="line"><span class="cl">May <span class="m">13</span> 15:51:08 node2 kubelet<span class="o">[</span>1194<span class="o">]</span>: E0513 15:51:08.888194    <span class="m">1194</span> kubelet.go:2412<span class="o">]</span> <span class="s2">&#34;Error getting node&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;node \&#34;node2... found&#34;</span>
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>The core configuration file is <code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code> and its contents are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ cat /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span><span class="line"><span class="cl"><span class="c1"># Note: This dropin only works with kubeadm and kubelet v1.11+</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Service<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span>
</span></span><span class="line"><span class="cl"><span class="nv">EnvironmentFile</span><span class="o">=</span>-/var/lib/kubelet/kubeadm-flags.env
</span></span><span class="line"><span class="cl"><span class="c1"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span>
</span></span><span class="line"><span class="cl"><span class="c1"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span>
</span></span><span class="line"><span class="cl"><span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/kubelet
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kubelet <span class="nv">$KUBELET_KUBECONFIG_ARGS</span> <span class="nv">$KUBELET_CONFIG_ARGS</span> <span class="nv">$KUBELET_KUBEADM_ARGS</span> <span class="nv">$KUBELET_EXTRA_ARGS</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There is a configuration <code>KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet. conf</code>, where two configuration files <code>bootstrap-kubelet.conf</code> and <code>kubelet.conf</code> are mentioned, the first of which does not exist.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ cat /etc/kubernetes/bootstrap-kubelet.conf
</span></span><span class="line"><span class="cl">cat: /etc/kubernetes/bootstrap-kubelet.conf: No such file or directory
</span></span></code></pre></td></tr></table>
</div>
</div><p>The second configuration file is in the form of a kubeconfig file, and this file specifies the address of the APIServer, which you can see is still the same IP address as before.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ cat /etc/kubernetes/kubelet.conf
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">clusters:
</span></span><span class="line"><span class="cl">- cluster:
</span></span><span class="line"><span class="cl">    certificate-authority-data: &lt;......&gt;
</span></span><span class="line"><span class="cl">    server: https://192.168.0.111:6443
</span></span><span class="line"><span class="cl">  name: default-cluster
</span></span><span class="line"><span class="cl">contexts:
</span></span><span class="line"><span class="cl">- context:
</span></span><span class="line"><span class="cl">    cluster: default-cluster
</span></span><span class="line"><span class="cl">    namespace: default
</span></span><span class="line"><span class="cl">    user: default-auth
</span></span><span class="line"><span class="cl">  name: default-context
</span></span><span class="line"><span class="cl">current-context: default-context
</span></span><span class="line"><span class="cl">kind: Config
</span></span><span class="line"><span class="cl">preferences: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">users:
</span></span><span class="line"><span class="cl">- name: default-auth
</span></span><span class="line"><span class="cl">  user:
</span></span><span class="line"><span class="cl">    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
</span></span><span class="line"><span class="cl">    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>So our first thought must be to change the APIServer address here to a new IP address, but this is obviously problematic because the relevant certificate is still the same as before and needs to be regenerated, so how do we regenerate the file?</p>
<p>The first step is to backup the kubelet working directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ cp /etc/kubernetes/kubelet.conf /etc/kubernetes/kubelet.conf.bak
</span></span><span class="line"><span class="cl">➜ cp -rf /var/lib/kubelet/ /var/lib/kubelet-bak
</span></span></code></pre></td></tr></table>
</div>
</div><p>Remove the kubelet client certificate.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ rm /var/lib/kubelet/pki/kubelet-client*
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then go generate the kubelet.conf file at the master1 node (the node with the <code>/etc/kubernetes/pki/ca.key</code> file).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在master1节点</span>
</span></span><span class="line"><span class="cl">➜ kubeadm kubeconfig user --org system:nodes --client-name system:node:node2 --config kubeadm.yaml &gt; kubelet.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then copy the kubelet.conf file to the node2 node <code>/etc/kubernetes/kubelet.conf</code>, then restart the kubelet on the node2 node and wait for <code>/var/lib/kubelet/pki/kubelet-client-current. pem</code> is recreated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ systemctl restart kubelet
</span></span><span class="line"><span class="cl"><span class="c1"># 重启后等待重新生成 kubelet 客户端证书</span>
</span></span><span class="line"><span class="cl">➜ ll /var/lib/kubelet/pki/
</span></span><span class="line"><span class="cl">total <span class="m">12</span>
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root root <span class="m">1106</span> May <span class="m">13</span> 16:32 kubelet-client-2022-05-13-16-32-35.pem
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root   <span class="m">59</span> May <span class="m">13</span> 16:32 kubelet-client-current.pem -&gt; /var/lib/kubelet/pki/kubelet-client-2022-05-13-16-32-35.pem
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">2229</span> Mar <span class="m">26</span> 14:39 kubelet.crt
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> root root <span class="m">1675</span> Mar <span class="m">26</span> 14:39 kubelet.key
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ideally we can point to the rotating kubelet client certificate by manually editing <code>kubelet.conf</code>, replacing <code>client-certificate-data</code> and <code>client-key-data</code> in the file with <code>/var/lib/kubelet/pki/kubelet- client-current.pem</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
</span></span><span class="line"><span class="cl">client-key: /var/lib/kubelet/pki/kubelet-client-current.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p>Restart the kubelet again and the node2 node will now be Ready. Just configure the node1 node again in the same way.</p>
<h2 id="recommended-operation">Recommended operation</h2>
<p>The above operation can accomplish our needs normally, but it requires some knowledge of the relevant certificates. There is a simpler way to do this.</p>
<p>First, stop the kubelet and back up the directory you want to work on.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ systemctl stop kubelet
</span></span><span class="line"><span class="cl">➜ mv /etc/kubernetes /etc/kubernetes-bak
</span></span><span class="line"><span class="cl">➜ mv /var/lib/kubelet/ /var/lib/kubelet-bak
</span></span></code></pre></td></tr></table>
</div>
</div><p>Preserve the pki certificate directory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ mkdir -p /etc/kubernetes
</span></span><span class="line"><span class="cl">➜ cp -r /etc/kubernetes-bak/pki /etc/kubernetes
</span></span><span class="line"><span class="cl">➜ rm /etc/kubernetes/pki/<span class="o">{</span>apiserver.*,etcd/peer.*<span class="o">}</span>
</span></span><span class="line"><span class="cl">rm: remove regular file <span class="s1">&#39;/etc/kubernetes/pki/apiserver.crt&#39;</span>? y
</span></span><span class="line"><span class="cl">rm: remove regular file <span class="s1">&#39;/etc/kubernetes/pki/apiserver.key&#39;</span>? y
</span></span><span class="line"><span class="cl">rm: remove regular file <span class="s1">&#39;/etc/kubernetes/pki/etcd/peer.crt&#39;</span>? y
</span></span><span class="line"><span class="cl">rm: remove regular file <span class="s1">&#39;/etc/kubernetes/pki/etcd/peer.key&#39;</span>? y
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we use the following command to reinitialize the control plane nodes, but the most important point is to <strong>use etcd&rsquo;s data directory</strong>, which can be done by telling kubeadm to use pre-existing etcd data with the <code>--ignore-preflight-errors=DirAvailable--var-lib-etcd</code> flag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ kubeadm init --config kubeadm.yaml --ignore-preflight-errors<span class="o">=</span>DirAvailable--var-lib-etcd
</span></span><span class="line"><span class="cl"><span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.22.8
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="cl">        <span class="o">[</span>WARNING DirAvailable--var-lib-etcd<span class="o">]</span>: /var/lib/etcd is not empty
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Pulling images required <span class="k">for</span> setting up a Kubernetes cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> You can also perform this action in beforehand using <span class="s1">&#39;kubeadm config images pull&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using certificateDir folder <span class="s2">&#34;/etc/kubernetes/pki&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing ca certificate authority
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;apiserver&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> apiserver serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>api.k8s.local kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master1<span class="o">]</span> and IPs <span class="o">[</span>10.96.0.1 192.168.0.106<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing apiserver-kubelet-client certificate and key on disk
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing front-proxy-ca certificate authority
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing front-proxy-client certificate and key on disk
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing etcd/ca certificate authority
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing etcd/server certificate and key on disk
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Generating <span class="s2">&#34;etcd/peer&#34;</span> certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> etcd/peer serving cert is signed <span class="k">for</span> DNS names <span class="o">[</span>localhost master1<span class="o">]</span> and IPs <span class="o">[</span>192.168.0.106 127.0.0.1 ::1<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing etcd/healthcheck-client certificate and key on disk
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using existing apiserver-etcd-client certificate and key on disk
</span></span><span class="line"><span class="cl"><span class="o">[</span>certs<span class="o">]</span> Using the existing <span class="s2">&#34;sa&#34;</span> key
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Using kubeconfig folder <span class="s2">&#34;/etc/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;admin.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;kubelet.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;controller-manager.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubeconfig<span class="o">]</span> Writing <span class="s2">&#34;scheduler.conf&#34;</span> kubeconfig file
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Using manifest folder <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-apiserver&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-controller-manager&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>control-plane<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="s2">&#34;kube-scheduler&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>etcd<span class="o">]</span> Creating static Pod manifest <span class="k">for</span> <span class="nb">local</span> etcd in <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>wait-control-plane<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="s2">&#34;/etc/kubernetes/manifests&#34;</span>. This can take up to 4m0s
</span></span><span class="line"><span class="cl"><span class="o">[</span>apiclient<span class="o">]</span> All control plane components are healthy after 12.003599 seconds
</span></span><span class="line"><span class="cl"><span class="o">[</span>upload-config<span class="o">]</span> Storing the configuration used in ConfigMap <span class="s2">&#34;kubeadm-config&#34;</span> in the <span class="s2">&#34;kube-system&#34;</span> Namespace
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet<span class="o">]</span> Creating a ConfigMap <span class="s2">&#34;kubelet-config-1.22&#34;</span> in namespace kube-system with the configuration <span class="k">for</span> the kubelets in the cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>upload-certs<span class="o">]</span> Skipping phase. Please see --upload-certs
</span></span><span class="line"><span class="cl"><span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node master1 as control-plane by adding the labels: <span class="o">[</span>node-role.kubernetes.io/master<span class="o">(</span>deprecated<span class="o">)</span> node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>mark-control-plane<span class="o">]</span> Marking the node master1 as control-plane by adding the taints <span class="o">[</span>node-role.kubernetes.io/master:NoSchedule<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Using token: abcdef.0123456789abcdef
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow Node Bootstrap tokens to get nodes
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span class="k">for</span> nodes to get long term certificate credentials
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> configured RBAC rules to allow certificate rotation <span class="k">for</span> all node client certificates in the cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>bootstrap-token<span class="o">]</span> Creating the <span class="s2">&#34;cluster-info&#34;</span> ConfigMap in the <span class="s2">&#34;kube-public&#34;</span> namespace
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-finalize<span class="o">]</span> Updating <span class="s2">&#34;/etc/kubernetes/kubelet.conf&#34;</span> to point to a rotatable kubelet client certificate and key
</span></span><span class="line"><span class="cl"><span class="o">[</span>addons<span class="o">]</span> Applied essential addon: CoreDNS
</span></span><span class="line"><span class="cl"><span class="o">[</span>addons<span class="o">]</span> Applied essential addon: kube-proxy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Your Kubernetes control-plane has initialized successfully!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Alternatively, <span class="k">if</span> you are the root user, you can run:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm join 192.168.0.106:6443 --token abcdef.0123456789abcdef <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:27993cae9c76d18a1b82b800182c4c7ebc7a704ba1093400ed886f65e709ec04
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above operation is almost the same as when we go to initialize the cluster, the only difference is the addition of the <code>--ignore-preflight-errors=DirAvailable--var-lib-etcd</code> parameter, which means that the data from the previous etcd is used. Then we can verify that the IP address of the APIServer has changed to the new address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">cp: overwrite <span class="s1">&#39;/root/.kube/config&#39;</span>? y
</span></span><span class="line"><span class="cl">➜ kubectl cluster-info
</span></span><span class="line"><span class="cl">Kubernetes control plane is running at https://192.168.0.106:6443
</span></span><span class="line"><span class="cl">CoreDNS is running at https://192.168.0.106:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To further debug and diagnose cluster problems, use <span class="s1">&#39;kubectl cluster-info dump&#39;</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><p>For node nodes we can reset and rejoin the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在node节点操作</span>
</span></span><span class="line"><span class="cl">➜ kubeadm reset
</span></span></code></pre></td></tr></table>
</div>
</div><p>Just reset and rejoin the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在node节点操作</span>
</span></span><span class="line"><span class="cl">➜ kubeadm join 192.168.0.106:6443 --token abcdef.0123456789abcdef <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:27993cae9c76d18a1b82b800182c4c7ebc7a704ba1093400ed886f65e709ec04
</span></span></code></pre></td></tr></table>
</div>
</div><p>This way is much easier than the above way. The cluster is also normal after normal operation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME      STATUS   ROLES                  AGE     VERSION
</span></span><span class="line"><span class="cl">master1   Ready    control-plane,master   48d     v1.22.8
</span></span><span class="line"><span class="cl">node1     Ready    &lt;none&gt;                 48d     v1.22.8
</span></span><span class="line"><span class="cl">node2     Ready    &lt;none&gt;                 4m50s   v1.22.8
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>It is best to use static IP addresses for Kubernetes cluster nodes to avoid the impact of IP changes on the business. If it is not a static IP, it is also highly recommended to add a custom domain name for signing, so that when the IP changes, you can directly remap the domain name. You only need to configure <code>apiServer.certSANs</code> in the kubeadm configuration file via <code>ClusterConfiguration</code>, as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">certSANs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">api.k8s.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">master1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="m">192.168.0.106</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Add the address that needs to be signed to the certSANs configuration. For example, here we have added an additional <code>api.k8s.local</code> address so that even if the IP changes in the future you can directly map this domain name to the new IP address, also if you want to access your cluster via an external access IP, then you need to add your external IP address for signature authentication.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/docker-desktop/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Docker Desktop announces support for Linux</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/sctp/">
            <span class="next-text nav-default">Stream Control Transmission Protocol</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
