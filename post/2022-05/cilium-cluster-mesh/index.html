<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Usage of Cilium Cluster Mesh, a Kubernetes multi-cluster solution - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Cilium Cluster Mesh, a Kubernetes multicluster solution." /><meta name="keywords" content="Kubernetes Multi-Cluster, Cilium Cluster Mesh" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/cilium-cluster-mesh/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Usage of Cilium Cluster Mesh, a Kubernetes multi-cluster solution" />
<meta property="og:description" content="Learn how to use Cilium Cluster Mesh, a Kubernetes multicluster solution." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/cilium-cluster-mesh/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-16T20:42:20+08:00" />
<meta property="article:modified_time" content="2022-05-16T20:42:20+08:00" />

<meta itemprop="name" content="Usage of Cilium Cluster Mesh, a Kubernetes multi-cluster solution">
<meta itemprop="description" content="Learn how to use Cilium Cluster Mesh, a Kubernetes multicluster solution."><meta itemprop="datePublished" content="2022-05-16T20:42:20+08:00" />
<meta itemprop="dateModified" content="2022-05-16T20:42:20+08:00" />
<meta itemprop="wordCount" content="2164">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Usage of Cilium Cluster Mesh, a Kubernetes multi-cluster solution"/>
<meta name="twitter:description" content="Learn how to use Cilium Cluster Mesh, a Kubernetes multicluster solution."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Usage of Cilium Cluster Mesh, a Kubernetes multi-cluster solution</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-16 20:42:20 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2164 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-usage-scenarios">1 Usage Scenarios</a>
          <ul>
            <li><a href="#11-high-availability">1.1 High Availability</a></li>
            <li><a href="#12-shared-services">1.2 Shared Services</a></li>
            <li><a href="#13-splitting-stateful-and-stateless-services">1.3 Splitting Stateful and Stateless Services</a></li>
          </ul>
        </li>
        <li><a href="#2-architecture">2 Architecture</a></li>
        <li><a href="#3-prerequisites">3 Prerequisites</a>
          <ul>
            <li><a href="#31-installation-of-related-software">3.1 Installation of related software</a></li>
            <li><a href="#32-environment-requirements">3.2 Environment Requirements</a></li>
          </ul>
        </li>
        <li><a href="#4-preparing-the-kubernetes-environment">4 Preparing the Kubernetes Environment</a></li>
        <li><a href="#5-installing-cilium">5 Installing Cilium</a></li>
        <li><a href="#6-install-metallb-optional">6 Install Metallb (optional)</a></li>
        <li><a href="#7-enabling-cluster-mesh">7 Enabling Cluster Mesh</a></li>
        <li><a href="#8-connecting-to-a-cluster">8 Connecting to a cluster</a></li>
        <li><a href="#9-load-balancing">9 Load balancing</a>
          <ul>
            <li><a href="#91-global-load-balancing">9.1 Global Load Balancing</a></li>
            <li><a href="#92-disable-global-service-sharing">9.2 Disable global service sharing</a></li>
          </ul>
        </li>
        <li><a href="#10-network-policy">10 Network Policy</a></li>
        <li><a href="#11-troubleshooting">11 Troubleshooting</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Cluster Mesh is a multi-cluster implementation of Cilium that helps Cilium achieve multi-Kubernetes cluster management across data centers and VPCs. Cluster Mesh has the following main features.</p>
<ol>
<li>Pod IP routing between multiple Kubernetes clusters through tunneling or direct routing without any gateway or proxy.</li>
<li>Use standard Kubernetes service discovery mechanisms.</li>
<li>Network policies across multiple clusters. Policies can use Kubernetes native NetworkPolicy resources or the extended CiliumNetworkPolicy CRD.</li>
<li>Transparent encryption of all traffic communicated within and across cluster nodes.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/ae6ae98175d443e28fc88b8d84654d82.png" alt="Kubernetes Multi-Cluster"></p>
<p>Let&rsquo;s take a look at some specific usage scenarios for Cilium Cluster Mesh.</p>
<h2 id="1-usage-scenarios">1 Usage Scenarios</h2>
<h3 id="11-high-availability">1.1 High Availability</h3>
<p>For most people, high availability is the most common usage scenario. Multiple Kubernetes clusters can be run in multiple regions or availability zones, with copies of the same services running in each cluster. In the event of an exception, requests can be failover to other clusters.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/0b6a963f3b6c4d7ba0f9f5c7068f7d44.png" alt="High Availability"></p>
<h3 id="12-shared-services">1.2 Shared Services</h3>
<p>Certain public infrastructure services can be shared across clusters (e.g. key management, logging, monitoring or DNS services, etc.) to avoid additional resource overhead.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/57a24f9e815642ebab6a4e06be345c9f.png" alt="Shared Services"></p>
<h3 id="13-splitting-stateful-and-stateless-services">1.3 Splitting Stateful and Stateless Services</h3>
<p>The operational complexity of running a stateful or stateless service is very different. Stateless services are easy to scale, migrate and upgrade. Running a cluster entirely with stateless services allows the cluster to remain flexible and agile. Stateful services (e.g. MySQL, Elasticsearch, Etcd, etc.) can introduce potentially complex dependencies, and migrating stateful services usually involves the migration of storage. Running separate clusters for stateless and stateful services can isolate dependency complexity to a smaller number of clusters.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/ca1fcf27d6844ce29252729e39dc5dcf.png" alt="Splitting Stateful and Stateless Services"></p>
<h2 id="2-architecture">2 Architecture</h2>
<p>The architecture of Cilium Cluster Mesh is as follows.</p>
<ul>
<li>Each Kubernetes cluster maintains its own etcd cluster that keeps the state of its own cluster. State from multiple clusters is never obfuscated in the etcd of this cluster.</li>
<li>Each cluster exposes its own etcd through a set of <strong>etcd agents</strong>, and Cilium agents running in other clusters connect to the etcd agents to monitor changes.</li>
<li>Cilium uses the <strong>clustermesh-apiserver</strong> Pod to establish multi-cluster interconnections. There are two containers in the <strong>clustermesh-apiserver</strong> Pod: the apiserver container is responsible for writing multi-cluster related information to the etcd container; the etcd container (etcd agent) is used to store Cluster Mesh-related configuration information.</li>
<li><strong>Access from one cluster to another is always read-only</strong> . This ensures that the failure domain remains unchanged, i.e. a failure in one cluster is never propagated to other clusters.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/9e97891bd9f741929bd26253d788f333.png" alt="architecture of Cilium Cluster Mesh"></p>
<h2 id="3-prerequisites">3 Prerequisites</h2>
<h3 id="31-installation-of-related-software">3.1 Installation of related software</h3>
<ul>
<li>Install Kubectl: <a href="https://kubernetes.io/zh/docs/tasks/tools/">https://kubernetes.io/zh/docs/tasks/tools/</a></li>
<li>Install Kind: <a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation">https://kind.sigs.k8s.io/docs/user/quick-start/#installation</a></li>
<li>Installation of Helm: <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></li>
<li>Install Cilium Cli: <a href="https://github.com/cilium/cilium-cli">https://github.com/cilium/cilium-cli</a></li>
</ul>
<p><strong><a href="https://kind.sigs.k8s.io/">Kind</a></strong> (Kubernetes in Docker) is a tool for running local Kubernetes clusters using Docker containers. To facilitate experimentation, this article uses Kind to build a Kubernetes multicluster environment.</p>
<h3 id="32-environment-requirements">3.2 Environment Requirements</h3>
<ul>
<li>All Kubernetes worker nodes must be assigned unique IP addresses and IP routing between nodes must be reachable.</li>
<li>Each cluster must be assigned a unique Pod CIDR.</li>
<li>Cilium must use etcd as kv storage.</li>
<li>The network between clusters must be interoperable, see <strong><a href="https://docs.cilium.io/en/stable/operations/system_requirements/#firewall-requirements">Firewall Rules</a></strong> for the specific port numbers for communication.</li>
</ul>
<p>The configuration file for this experiment is available at: <strong><a href="https://github.com/cr7258/kubernetes-guide/tree/master/cilium/cluster_mesh">cluster_mesh</a></strong>.</p>
<h2 id="4-preparing-the-kubernetes-environment">4 Preparing the Kubernetes Environment</h2>
<p>Prepare two Kind configuration files for building a Kubernetes cluster.</p>
<p>c1 Cluster configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># kind-config1.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kind.x-k8s.io/v1alpha4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">disableDefaultCNI</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 禁用默认的 CNI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.10.0.0/16&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.11.0.0/16&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>c2 cluster configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># kind-config2.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kind.x-k8s.io/v1alpha4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">disableDefaultCNI</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 禁用默认的 CNI</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.20.0.0/16&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.21.0.0/16&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Use the <code>kind create cluster</code> command to create two Kubernetes clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kind create cluster --config kind-config1.yaml --name c1
</span></span><span class="line"><span class="cl">kind create cluster --config kind-config2.yaml --name c2
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/268d42d4b43c43f79037087d2b38209c.png" alt="kind create cluster"></p>
<p>View two Kubernetes clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get node --context kind-c1 -o wide
</span></span><span class="line"><span class="cl">kubectl get node --context kind-c2 -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/a0d84f5030be4005884fd92e31a71628.png" alt="kubectl get node"></p>
<h2 id="5-installing-cilium">5 Installing Cilium</h2>
<p>Add Helm Repo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm repo add cilium https://helm.cilium.io/
</span></span></code></pre></td></tr></table>
</div>
</div><p>Install Cilium on the c1 cluster, using the <code>-kube-context</code> parameter to specify a different cluster context. Each cluster must be assigned a unique name and cluster id, the <code>-cluster.id</code> parameter specifies the cluster id in the range 1-255, and the <code>-cluster.name</code> parameter specifies the cluster name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm install --kube-context kind-c1 cilium cilium/cilium --version 1.11.4 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set ipam.mode<span class="o">=</span>kubernetes <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set cluster.id<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set cluster.name<span class="o">=</span>cluster1
</span></span></code></pre></td></tr></table>
</div>
</div><p>Install Cilium on the c2 cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm install --kube-context kind-c2 cilium cilium/cilium --version 1.11.4 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set ipam.mode<span class="o">=</span>kubernetes <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set cluster.id<span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set cluster.name<span class="o">=</span>cluster2
</span></span></code></pre></td></tr></table>
</div>
</div><p>View Cilium Pod status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --context kind-c1 get pod -A
</span></span><span class="line"><span class="cl">kubectl --context kind-c2 get pod -A
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/5d574c46c01c447a97ac877da7a24f1e.png" alt="kubectl &amp;ndash;context"></p>
<p>View Cilium status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium status --context kind-c1
</span></span><span class="line"><span class="cl">cilium status --context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/4526d8d0286f4258b817625e0d7cfa5b.png" alt="cilium status"></p>
<h2 id="6-install-metallb-optional">6 Install Metallb (optional)</h2>
<p>In the <strong>7 Enabling Cluster Mesh</strong> section, the Service type used to publish the <strong>clustermesh-apiserver</strong> service is described. In Kubernetes clusters provided by public clouds, LoadBalancer type services are usually distributed through load balancing devices in public clouds (e.g., AWS&rsquo;s ELB, Aliyun&rsquo;s SLB, etc.). In a private environment, you can use <strong><a href="https://metallb.universe.tf/">MetalLB</a></strong> to implement it.</p>
<p>Prepare the Metallb configuration files for both clusters. c1 Cluster configuration file. Note that the assigned network should be in the same network segment as the node IPs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># metallb-config1.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">configInline</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">peers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">address-pools</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">layer2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">addresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">172.22.0.50-172.22.0.100</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>c2 cluster configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">configInline</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">peers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">address-pools</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">layer2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">addresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">172.22.0.101-172.22.0.150</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Use the following command to deploy Metallb in the c1 and c2 clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span class="line"><span class="cl">helm install --kube-context kind-c1 metallb bitnami/metallb <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -f metallb-config1.yaml
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">helm install --kube-context kind-c2 metallb bitnami/metallb <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  -f metallb-config2.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>View Metallb Pod status.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/72ef52054a59449ca664f98c52a88f1a.png" alt="Metallb Pod status"></p>
<h2 id="7-enabling-cluster-mesh">7 Enabling Cluster Mesh</h2>
<p>Use the <code>cilium clustermesh enable</code> command to enable Cluster Mesh on the c1 cluster.</p>
<ul>
<li>The <code>-create-ca</code> parameter indicates that a CA certificate is automatically created, which needs to be shared between clusters to ensure that mTLS works properly across clusters.</li>
<li>The <code>-service-type</code> parameter specifies the way to publish the <strong>clustermesh-apiserver</strong> service, which has the following 3 ways.
<ul>
<li><strong>LoadBalancer</strong> (recommended): Use a LoadBalancer type Service to publish the service, which allows the use of a stable LoadBalancer IP and is usually the best choice.</li>
<li><strong>NodePort</strong> : Use NodePort type Service to publish services, if a node disappears, Cluster Mesh will have to reconnect to another node, which may cause network outages.</li>
<li><strong>ClusterIP</strong> : Use a ClusterIP type Service to publish services, which requires that the ClusterIP is routable between clusters.</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium clustermesh <span class="nb">enable</span> --create-ca --context kind-c1 --service-type LoadBalancer
</span></span></code></pre></td></tr></table>
</div>
</div><p>Executing the command will deploy the clustermesh-apiserver service in the cluster and generate the relevant necessary certificates.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/a857bc69bf9c444bb288861cd01ad7f2.png" alt="cilium clustermesh enable"></p>
<p>The created CA is stored in the cilium-ca Secret under the <code>kube-system</code> Namespace.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl --context kind-c1 get secret -n kube-system cilium-ca -o yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  ca.crt: <span class="nv">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNFekNDQWJxZ0F3SUJBZ0lVZmVPNHlYbVZSSU1ZZVppSjZyODJ6L05FejBVd0NnWUlLb1pJemowRUF3SXcKYURFTE1Ba0dBMVVFQmhNQ1ZWTXhGakFVQmdOVkJBZ1REVk5oYmlCR2NtRnVZMmx6WTI4eEN6QUpCZ05WQkFjVApBa05CTVE4d0RRWURWUVFLRXdaRGFXeHBkVzB4RHpBTkJnTlZCQXNUQmtOcGJHbDFiVEVTTUJBR0ExVUVBeE1KClEybHNhWFZ0SUVOQk1CNFhEVEl5TURVd09UQXpNemt3TUZvWERUSTNNRFV3T0RBek16a3dNRm93YURFTE1Ba0cKQTFVRUJoTUNWVk14RmpBVUJnTlZCQWdURFZOaGJpQkdjbUZ1WTJselkyOHhDekFKQmdOVkJBY1RBa05CTVE4dwpEUVlEVlFRS0V3WkRhV3hwZFcweER6QU5CZ05WQkFzVEJrTnBiR2wxYlRFU01CQUdBMVVFQXhNSlEybHNhWFZ0CklFTkJNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVTQVNHRERDdnhsUmpYNTEwMEpCQnoxdXIKb29sMktUNVh6MUNYS1paVk5Pc1M5ZmVrOEJUOTRqTXpZcHpsZW5hZXdwczVDZGhWckkvSU9mK2RtaTR3UjZOQwpNRUF3RGdZRFZSMFBBUUgvQkFRREFnRUdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGTlVwCjBBRVROZ0JHd2ZEK0paRDFWV2w2elNvVk1Bb0dDQ3FHU000OUJBTUNBMGNBTUVRQ0lHZUszUklreUJzQnFxL0MKdzRFTU9nMjk1T244WDFyYVM5QVZMZmlzS2JJVEFpQW5Da3NQTm9BYmZVZ1lyMkVGaFZZaDU0bjlZMVlyU0NlZAprOEZ3Nnl2MWNBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">  ca.key: <span class="nv">LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU9uWG9WTmhIdEJ0TTFaMFFlTWE5UWlLV1QvdXVNMk9jUXNmU252bXEwL2RvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFU0FTR0REQ3Z4bFJqWDUxMDBKQkJ6MXVyb29sMktUNVh6MUNYS1paVk5Pc1M5ZmVrOEJUOQo0ak16WXB6bGVuYWV3cHM1Q2RoVnJJL0lPZitkbWk0d1J3PT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: <span class="s2">&#34;2022-05-09T03:44:03Z&#34;</span>
</span></span><span class="line"><span class="cl">  name: cilium-ca
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;20625&#34;</span>
</span></span><span class="line"><span class="cl">  uid: 7e4b2f21-815d-4191-974b-316c629e325c
</span></span><span class="line"><span class="cl">type: Opaque
</span></span></code></pre></td></tr></table>
</div>
</div><p>Import the Cilium CA certificate of cluster c1 to cluster c2.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 将 c1 集群的 Cilium CA 证书导出</span>
</span></span><span class="line"><span class="cl">kubectl get secret --context kind-c1 -n kube-system cilium-ca -o yaml &gt; cilium-ca.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># 将 CA 证书导入 c2 集群</span>
</span></span><span class="line"><span class="cl">kubectl apply -f cilium-ca.yaml --context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p>Enable Cluster Mesh on the c2 cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium clustermesh <span class="nb">enable</span> --context kind-c2 --service-type LoadBalancer
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/9e45a9c9e4da40ff9cb6821677ce8b4a.png" alt="Enable Cluster Mesh on the c2 cluster"></p>
<p>View the clustermesh-apiserver Pod status for clusters c1 and c2.</p>
<p>Looking at the clustermesh-apiserver service for clusters c1 and c2, you can see that the Servie type is LoadBalancer, which is the IP address assigned by Metallb.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --context kind-c1 get svc -A 
</span></span><span class="line"><span class="cl">kubectl --context kind-c2 get svc -A 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/ca59eb19a2e543a88a622c36a3855465.png" alt="kubectl &amp;ndash;context"></p>
<p>View Cilium status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium status --context kind-c1
</span></span><span class="line"><span class="cl">cilium status --context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/441821268fbb49c89fa23e8e1ecdce82.png" alt="View Cilium status"></p>
<p>Check the Cluster Mesh status of the c1 and c2 clusters. Both clusters are currently successfully enabled for Cluster Mesh, but are not yet connected to each other.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium clustermesh status --context kind-c1
</span></span><span class="line"><span class="cl">cilium clustermesh status --context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/85691ae52d1e4b90bbb58becb7ce6610.png" alt="cilium clustermesh status"></p>
<h2 id="8-connecting-to-a-cluster">8 Connecting to a cluster</h2>
<p>Execute the <code>cilium clustermesh connect</code> command on the c1 cluster to connect to the c2 cluster. This only needs to be executed on one cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium clustermesh connect --context kind-c1 --destination-context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/05b23b633e0b4f0984c8204e79424eea.png" alt="cilium clustermesh connect"></p>
<p>Check the Cilium Cluster Mesh status, at which point the c1 and c1 clusters have established a Cluster Mesh connection.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium clustermesh status --context kind-c1
</span></span><span class="line"><span class="cl">cilium clustermesh status --context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/15c0cb66acc740e4ba0777396c357fa9.png" alt="cilium clustermesh status"></p>
<p>Now that we have successfully established the interconnection between clusters, let&rsquo;s verify the load balancing and network policies in Cluster Mesh mode.</p>
<h2 id="9-load-balancing">9 Load balancing</h2>
<h3 id="91-global-load-balancing">9.1 Global Load Balancing</h3>
<p>Deploy two applications in a cluster, where x-wing is the client and rebel-base is the server, and require global load balancing for the rebel-base service. You need to ensure that the rebel-base service in each cluster has the same name and is in the same namespace, then add <code>io.cilium/global-service: &quot;true&quot;</code> to declare it as a global service so that Cilium will automatically perform load balancing on the Pods in both clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rebel-base</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">io.cilium/global-service</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># 启用全局负载均衡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rebel-bas</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Create application services in c1 and c2 clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f cluster1.yaml --context kind-c1
</span></span><span class="line"><span class="cl">kubectl apply -f cluster2.yaml --context kind-c2
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check out the service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --context kind-c1 get pod
</span></span><span class="line"><span class="cl">kubectl --context kind-c1 get svc
</span></span><span class="line"><span class="cl">kubectl --context kind-c2 get pod
</span></span><span class="line"><span class="cl">kubectl --context kind-c2 get svc
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/9e72ff41579749399e06ae190cd46507.png" alt="Check out the service"></p>
<p>Accessing the rebel-base service from either cluster, you can see that traffic is distributed to both clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> kubectl <span class="nb">exec</span> --context kind-c1 -ti deployment/x-wing -- curl rebel-base<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/fb18ebbd1273406fade33bec69f98dae.png" alt="kubectl"></p>
<h3 id="92-disable-global-service-sharing">9.2 Disable global service sharing</h3>
<p>By default, global services will be load balanced across backends in multiple clusters. If you want to disable services from this cluster from being shared to other clusters, you can do so by setting the <code>io.cilium/shared-services: &quot;false&quot;</code> annotation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl annotate service rebel-base <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>io.cilium/shared-service<span class="o">=</span><span class="s2">&#34;false&#34;</span> --overwrite --context kind-c1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The rebel-base service is accessible to both clusters in the c1 cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> kubectl <span class="nb">exec</span> --context kind-c1 -ti deployment/x-wing -- curl rebel-base<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/843bacb40da54467a5be6f98f88407e5.png" alt="rebel-base service"></p>
<p>But then the c2 cluster will only be able to access the rebel-base service of this cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> kubectl <span class="nb">exec</span> --context kind-c2 -ti deployment/x-wing -- curl rebel-base<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/57b9d7ef5a9f42daae154f47dc129cfd.png" alt="c2 cluster"></p>
<p>Remove the annotation <code>io.cilium/shared-service</code> from the c1 cluster rebel-base service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl annotate service rebel-base io.cilium/shared-service- --context kind-c1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The c2 cluster can now re-access the rebel-base service for both clusters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span> kubectl <span class="nb">exec</span> --context kind-c2 -ti deployment/x-wing -- curl rebel-base<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/f29cd9e0f17c48688e5b7ac2239f79bc.png" alt="rebel-base service"></p>
<h2 id="10-network-policy">10 Network Policy</h2>
<p>Create a CiliumNetworkPolicy policy to allow only Pods in cluster c1 with the x-wing tag to access Pods in cluster c2 with the rebel-base tag. cluster names are specified in the <strong>5 Installing Cilium</strong> chapter with the <code>-cluster-name</code> parameter, and can also be found in <strong>cilium- config</strong> Configmap. In addition to the traffic between application services, care should be taken to release the DNS traffic, otherwise it cannot be accessed directly by the Service name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># networkpolicy.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cilium.io/v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;allow-dns&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpointSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">toEndpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">io.kubernetes.pod.namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-dns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">toPorts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;53&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">dns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">matchPattern</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumNetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;allow-cross-cluster&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Allow x-wing in cluster1 to contact rebel-base in cluster2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpointSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">x-wing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">io.cilium.k8s.policy.cluster</span><span class="p">:</span><span class="w"> </span><span class="l">cluster1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">toEndpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rebel-base</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">io.cilium.k8s.policy.cluster</span><span class="p">:</span><span class="w"> </span><span class="l">cluster2</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Kubernetes network policies are not automatically published to all clusters; you need to issue <code>NetworkPolicy</code> or <code>CiliumNetworkPolicy</code> on each cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --context kind-c1 apply -f networkpolicy.yaml
</span></span><span class="line"><span class="cl">kubectl --context kind-c2 apply -f networkpolicy.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>When you access the rebel-base service on cluster c1, you can see that only requests distributed to cluster c2 are successfully responded to.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> --context kind-c1 -ti deployment/x-wing -- curl rebel-base
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/5d79d69890f8412aafb39c63b686c75b.png" alt="kubectl exec"></p>
<h2 id="11-troubleshooting">11 Troubleshooting</h2>
<p>The following exception was encountered while enabling Cluster Mesh.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cilium clustermesh status --context kind-c1
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/8814a418e0e44d338ef0a06ffe2c6eea.png" alt="cilium clustermesh status"></p>
<p>Checking the Pod information reveals that the pulled image does not exist.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl --context kind-c1 describe pod -n kube-system  clustermesh-apiserver-754c5479dd-zsg8t
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/a5c8860cf30f460e833b612bd7f42c80.png" alt="Checking the Pod information"></p>
<p>I went to the Cilium image repository and found that the sha256 value behind the image did not match.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/df2571148bba47deaafcb2485e158fc9.png" alt="image repository"></p>
<p>Edit the image of clustermesh-apiserver Deployment and remove the shasum value after the image version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl edit --context kind-c1 deployment -n kube-system clustermesh-apiserver
</span></span><span class="line"><span class="cl">kubectl edit --context kind-c2 deployment -n kube-system clustermesh-apiserver
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/16/ab7d8a1b2f6c45c18d4cfdf79ed292b4.png" alt="Edit the image of clustermesh-apiserver Deployment"></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/webassembly/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Webassembly Basics</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/ace/">
            <span class="next-text nav-default">ACE Cache Coherence Protocol Analysis</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
