<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>A Go developer&#39;s experience with Rust - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article describes the experience of a Go developer using Rust." /><meta name="keywords" content="rust, golang" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/rust-view-from-a-gopher/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="A Go developer&#39;s experience with Rust" />
<meta property="og:description" content="This article describes the experience of a Go developer using Rust." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/rust-view-from-a-gopher/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-20T13:29:39+08:00" />
<meta property="article:modified_time" content="2022-05-20T13:29:39+08:00" />

<meta itemprop="name" content="A Go developer&#39;s experience with Rust">
<meta itemprop="description" content="This article describes the experience of a Go developer using Rust."><meta itemprop="datePublished" content="2022-05-20T13:29:39+08:00" />
<meta itemprop="dateModified" content="2022-05-20T13:29:39+08:00" />
<meta itemprop="wordCount" content="3127">
<meta itemprop="keywords" content="rust,golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Go developer&#39;s experience with Rust"/>
<meta name="twitter:description" content="This article describes the experience of a Go developer using Rust."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">A Go developer&#39;s experience with Rust</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-20 13:29:39 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3127 words </span>
          <span class="more-meta"> 15 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>I&rsquo;ve been following the development of Rust as a language, but I haven&rsquo;t actually used it. Recently, I was interested in writing something, so I implemented a basic module in both Rust and Go. This article is some of the results of this implementation.</p>
<p>I have a long experience with Go, so this article will be relatively accurate about Go, but I have been following Rust for a long time, but the code is basically the result of the last week or so, so my opinion may be biased.</p>
<p>This comparison is about implementing a string optimized for short strings. When deserializing, the unknown length of the string causes the deserialization to create a section of memory to hold the content based on the received string. In general, however, the length of the string at deserialization is small, and the resulting repeated requests to free memory can consume a lot of performance. The optimization for short strings is to allocate memory in advance for strings of a certain length, and if the deserialized length is less than this length, the allocated memory is used directly to store the content, and no more memory is requested, and there is no release process, thus increasing efficiency.</p>
<p>Since I am more familiar with Go, I first implemented this function using Go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">prealloc_size</span> <span class="p">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">String</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">data</span> <span class="p">[</span><span class="nx">prealloc_size</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">  <span class="nx">buf</span>  <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">String</span><span class="p">)</span> <span class="nf">fill</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">uint</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="nx">prealloc_size</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">[:</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">String</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">string</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">buf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This code is fairly straightforward and will not be described too much. The only thing worth mentioning is the <code>String.String()</code> method, which uses <code>unsafe</code> to treat <code>buf</code> directly as a string to avoid reallocating memory. For details, see the official library&rsquo;s <code>strings.Builder.String()</code> method.</p>
<p>Since we want to test performance, we must have the relevant performance test code. For the sake of brevity, we will not show the contents of the unit tests here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shortStr</span> <span class="p">=</span> <span class="s">&#34;short str&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">longStr</span>  <span class="p">=</span> <span class="s">&#34;loooooooooonnnnnnnnnngggggggg string&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkShortString</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">str</span> <span class="nx">String</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">shortStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span> <span class="o">:=</span> <span class="nb">uint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">str</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">str</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkLongString</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">str</span> <span class="nx">String</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">longStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span> <span class="o">:=</span> <span class="nb">uint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">str</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">str</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The test results are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go <span class="nb">test</span> -bench . -benchmem
</span></span><span class="line"><span class="cl">goos: darwin
</span></span><span class="line"><span class="cl">goarch: amd64
</span></span><span class="line"><span class="cl">pkg: github.com/googollee/rtnx/rtmp/amf
</span></span><span class="line"><span class="cl">BenchmarkShortString-4      <span class="m">50000000</span>            25.1 ns/op         <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
</span></span><span class="line"><span class="cl">BenchmarkLongString-4       <span class="m">20000000</span>            67.0 ns/op        <span class="m">48</span> B/op          <span class="m">1</span> allocs/op
</span></span><span class="line"><span class="cl">PASS
</span></span><span class="line"><span class="cl">ok      github.com/googollee/rtnx/rtmp/amf  3.189s
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the short strings really did not reallocate memory in the test and showed a significant performance improvement compared to the long strings.</p>
<p>After that, the code was first translated directly to Rust, but there were a number of problems during the translation process.</p>
<p>The first problem was, of course, ownership! The <code>buf</code> in the Go structure actually has two kinds of references: either a reference to a section of internal <code>data</code> memory, or a reference to an allocated section of memory. Rust forces all references to be organized in a tree of ownership, and internal references are equivalent to a node referencing itself, with no way to form a tree of ownership. So the domain needs to be split into two, one indicating how long an address needs to be referenced when referencing <code>data</code>, and the other indicating a reference to a section of allocated memory, if necessary. The first attempt is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">pub</span> <span class="kd">struct</span> <span class="nx">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">:</span> <span class="p">[</span><span class="nx">u8</span><span class="p">;</span> <span class="mi">20</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">heap</span><span class="p">:</span> <span class="nx">Option</span><span class="p">&lt;</span><span class="nx">Box</span><span class="p">&lt;[</span><span class="nx">u8</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">len</span><span class="p">:</span> <span class="nx">usize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Originally, I wanted to use Rust&rsquo;s template to parameterize the length of pre-allocated memory. After trying for a long time, it turned out that Rust does not yet support constant templates, so the length of 20 is directly hard-coded here. The good thing is that later implementations will not directly rely on the number 20, so no further changes were made.</p>
<p>The Rust community uses something like <code>String&lt;[u8; 20]&gt;</code> to implement constant modal parameters. This is a workaround. There is now an official Rust [proposal] for constant templates (<a href="https://github.com/rust-lang/rust/issues/44580">https://github.com/rust-lang/rust/issues/44580</a>).</p>
<p>where <code>data</code>, as before, is a pre-allocated piece of memory. <code>len</code> is used to record, in the case of short strings, how long the contents of <code>data</code> were used. Since the reference relation is removed, there is no violation of Rust ownership.</p>
<p>But the next question is how <code>heap</code> should be defined; Rust states that all references must point to the corresponding reference object, and there can be no reference variables without references, so <code>&amp; T</code> cannot be empty. And I want <code>heap</code> to be empty under normal circumstances. So <code>Option&lt;_&gt;</code> is used here to represent a type that is either <code>None</code> or has a value.</p>
<p>The next <code>Box&lt;_&gt;</code> indicates that it holds a type that is allocated on the heap. Unlike Go, Rust makes a very clear distinction between heap and stack variables, whereas Go, through compiler escape analysis, will decide for itself whether a variable needs to be placed on the heap and later reclaimed by GC. This reflects a completely different mindset between the two languages: Go attempts to reduce the amount of implementation details a programmer needs to know, providing as little but enough infrastructure as possible to ensure ease of use while guaranteeing performance, while Rust exposes a lot of details to the programmer and forces the programmer to follow the constraints and use them to make sure the program is correct. Since Rust exposes implementation details, experienced users can make more radical optimizations based on those details. Go, on the other hand, is very often limited by the compiler&rsquo;s ability to implement (and in many cases is unaware that it can do) such optimizations. For example, Go often opens a section of temporary memory for storage when reading links.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">var</span> <span class="nx">data</span> <span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">  <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">data</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>where <code>data</code> is the temporarily allocated memory. Theoretically, this memory is fine if it is only used in <code>Handle</code>, only on the stack, and is automatically freed as <code>Handle</code> exits. But since the escape analysis cannot know if the reference <code>data[:]</code> was held at the time of <code>r.Read()</code>, here it will be assumed that <code>data</code> has escaped, so it will be allocated on the heap and lead to the involvement of gc later.</p>
<p>Going back to Rust, eventually, <code>heap</code> is defined as <code>Option&lt;Box&lt;[u8]&gt;&gt;</code>, indicating an <code>[u8]</code> that can be <code>None</code> or an allocation on the heap. The type <code>[u8]</code> is similar to Go&rsquo;s slice from concept to implementation, and is a reference to an array. It is worth noting that <code>[u8]</code> cannot create a variable of <code>[u8]</code> directly on the stack since the length of the reference cannot be predicted at compile time.</p>
<p>Next is the <code>fill()</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fill</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">io</span>::<span class="n">Read</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">set_len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">into_boxed_slice</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">as_mut</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">panic!</span><span class="p">(</span><span class="s">&#34;should not here&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="n">n</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">read_full</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Rust guarantees by default that variables must be initialized when used, and here <code>Vec::with_capacity()</code> allocates memory without determining the content of the data, which is subsequently filled with concrete data, so <code>unsafe { v.set_len(n) }</code> is used to force the use of the uninitialized memory. It is worth noting that after using <code>v.into_boxed_slice()</code> to give ownership of this memory to <code>self.heap</code>, there needs to be a way to retrieve the reference to this memory and assign it to the <code>buf</code> variable. The type of <code>self.heap</code> is <code>Option&lt;Box&lt;[u8]&gt;&gt;</code>, and by convention, you need to get the reference in the order <code>Option&lt;Box&lt;[u8]&gt;&gt; -&gt; Box&lt;[u8]&gt;&gt; -&gt; [u8] -&gt; &amp;mut [u8]</code>. But there is a problem here, if it turns out to be <code>Box&lt;[u8]&gt;</code>, it proves that it is a variable type with its own life cycle, not a reference. So the order of taking references here is <code>Option&lt;Box&lt;[u8]&gt;&gt; -&gt; Option&lt;&amp;mut Box&lt;[u8]&gt;&gt; -&gt; &amp;mut Box&lt;[u8]&gt;&gt; -&gt; &amp;mut [u8]</code>. And the first step is to get the reference via <code>self.heap.as_mut()</code>.</p>
<p>Since Rust doesn&rsquo;t have an official <code>io.ReadFull()</code>, here&rsquo;s an implementation: as <a href="https://twitter.com/upsuper">@upsuper</a> reminds us, Rust officially has a similar implementation of <code>std::io::Read::read_exact</code>. However, we still use our own implementation here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">fn</span> <span class="nf">read_full</span><span class="p">(</span><span class="nx">r</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">mut</span> <span class="nx">impl</span> <span class="nx">io</span><span class="p">::</span><span class="nx">Read</span><span class="p">,</span> <span class="nx">b</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">mut</span> <span class="p">[</span><span class="nx">u8</span><span class="p">])</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">io</span><span class="p">::</span><span class="nx">Result</span><span class="p">&lt;()&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">let</span> <span class="nx">mut</span> <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">while</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nb">len</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">match</span> <span class="nx">r</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mut</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">..])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">Err</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nf">Ok</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Ok</span><span class="p">(())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>io::Result&lt;()&gt;</code> is a very Rust-specific type. This type represents a type value that is either <code>()</code> or <code>io::Error&lt;_&gt;</code>. The <code>()</code> type is some sort of meta-type in Rust, and can be thought of as a <code>nil</code> type to some extent or to indicate a return value that does not need to be cared about. <code>io::Error&lt;_&gt;</code> is simply a representation of some kind of io error, the exact type of error being determined by the template type <code>_</code>. Contrast this with the Go type.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ReadFull</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Obviously, Go&rsquo;s types cannot syntactically guarantee that <code>ReadFull()</code> returns both <code>int</code> and <code>error</code>. And returning two values at the same time can cause confusion for the caller: is this a normal return, or an error? Don&rsquo;t think that because the <code>error</code> postconvention is commonly used in Go, this won&rsquo;t happen. In fact, none of the Go standard libraries can prevent this <a href="https://pkg.go.dev/io#Reader">from occurring</a>.</p>
<blockquote>
<p>When Read encounters an error or end-of-file condition after successfully reading n &gt; 0 bytes, it returns the number of bytes read. It may return the (non-nil) error from the same call or return the error (and n == 0) from a subsequent call. An instance of this general case is that a Reader returning a non-zero number of bytes at the end of the input stream may return either err == EOF or err == nil. The next Read should return 0, EOF.</p>
</blockquote>
<p>Whereas simple handling of this type of error can be handled directly with <code>unwrap()</code> (as will be shown later), the use of <code>match</code> here is a more fine-grained handling. Since <code>match</code> is an expression rather than a statement, the error can be handled in the following way.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">let</span> <span class="nx">ret</span> <span class="p">=</span> <span class="nx">match</span> <span class="nf">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Err</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// handle err
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nf">Ok</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">r</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Comparison with Go&rsquo;s error handling.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">ret</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">function</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// handle err
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Rust error handling has the advantage of not having <code>err</code> variables defined all over the place, though Go code is much less voluminous. However, with the help of Rust&rsquo;s macros, if you don&rsquo;t need to specifically handle returning the error err, but rather return it directly, Rust can be abbreviated as follows</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="o">?</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This makes it look much better than Go. Even the expected <a href="https://github.com/gopherchina/conference/blob/3a0f94003da58e09c5acfa926a604643f6846491/2018/3.%20Rethinking%20Errors%20for%20Go%202.pdf">error handling in Go2</a> are no better than this.</p>
<p>Next is the performance testing part. I don&rsquo;t know how Rust understands the <em>engineering</em> thing, but when I was experimenting anyway, the Cargo project supported the <code>bench</code> command in the stable branch, but relied on a testing package from nightly to work. The current Rust project is full of these strange features that are claimed to be provided by stable but rely on nightly, making it a pain to build the complete project. Compared to the very stable <code>testing.B</code> feature that comes with Go, this aspect of Rust doesn&rsquo;t feel at all like a well-planned project that has been claiming to be stable for three years.</p>
<p>In the end, the entire performance test was done using the <a href="https://github.com/japaric/criterion.rs">Criterion</a> project, at the cost of having the performance test code in a different directory than the <code>String</code> definition code, and no way to reference private methods of type <code>String</code>. This is the reason why <code>fill()</code> is defined as <code>pub</code> above. The test code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[macro_use]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">criterion</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">rtnx</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">criterion</span>::<span class="n">Criterion</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">rtnx</span>::<span class="n">rtmp</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">string</span><span class="p">(</span><span class="n">c</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Criterion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">&#34;short str&#34;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;short str&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">str</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">str</span><span class="p">.</span><span class="n">string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">&#34;long str&#34;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;loooooooooooooooooonnnnnnnnnnnnng str&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">str</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">str</span><span class="p">.</span><span class="n">string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">});</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Rust itself implements <code>Read</code> for the <code>&amp;[u8]</code> type, so you can use <code>data.as_bytes()</code> as a <code>Read</code> directly. Since <code>fill()</code> requires <code>&amp;mut Read</code>, <code>&amp;mut data.as_bytes()</code> will be used here. And <code>'static</code> means static lifecycle, i.e. constant string.</p>
<p>Test results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cargo bench
</span></span><span class="line"><span class="cl">    Finished release <span class="o">[</span>optimized<span class="o">]</span> target<span class="o">(</span>s<span class="o">)</span> in 0.27s
</span></span><span class="line"><span class="cl">     Running target/release/deps/rtnx-b3fb2c92c52ff0ff
</span></span><span class="line"><span class="cl">running <span class="m">1</span> <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> rtmp::amf::string_test::test_string ... ignored
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">0</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">1</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out
</span></span><span class="line"><span class="cl">     Running target/release/deps/rtnx-b073d7725e43e2cb
</span></span><span class="line"><span class="cl">running <span class="m">1</span> <span class="nb">test</span>
</span></span><span class="line"><span class="cl"><span class="nb">test</span> rtmp::amf::string_test::test_string ... ignored
</span></span><span class="line"><span class="cl"><span class="nb">test</span> result: ok. <span class="m">0</span> passed<span class="p">;</span> <span class="m">0</span> failed<span class="p">;</span> <span class="m">1</span> ignored<span class="p">;</span> <span class="m">0</span> measured<span class="p">;</span> <span class="m">0</span> filtered out
</span></span><span class="line"><span class="cl">     Running target/release/deps/string-e1abdea77166d91b
</span></span><span class="line"><span class="cl">Gnuplot not found, disabling plotting
</span></span><span class="line"><span class="cl">short str               time:   <span class="o">[</span>8.8030 ns 8.8762 ns 8.9604 ns<span class="o">]</span>                       
</span></span><span class="line"><span class="cl">                        change: <span class="o">[</span>-2.0804% +0.0430% +1.9924%<span class="o">]</span> <span class="o">(</span><span class="nv">p</span> <span class="o">=</span> 0.96 &gt; 0.05<span class="o">)</span>
</span></span><span class="line"><span class="cl">                        No change in performance detected.
</span></span><span class="line"><span class="cl">Found <span class="m">12</span> outliers among <span class="m">100</span> measurements <span class="o">(</span>12.00%<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="m">8</span> <span class="o">(</span>8.00%<span class="o">)</span> high mild
</span></span><span class="line"><span class="cl">  <span class="m">4</span> <span class="o">(</span>4.00%<span class="o">)</span> high severe
</span></span><span class="line"><span class="cl">long str                time:   <span class="o">[</span>29.893 ns 30.005 ns 30.156 ns<span class="o">]</span>                      
</span></span><span class="line"><span class="cl">                        change: <span class="o">[</span>-0.1391% +0.6297% +1.4001%<span class="o">]</span> <span class="o">(</span><span class="nv">p</span> <span class="o">=</span> 0.12 &gt; 0.05<span class="o">)</span>
</span></span><span class="line"><span class="cl">                        No change in performance detected.
</span></span><span class="line"><span class="cl">Found <span class="m">6</span> outliers among <span class="m">100</span> measurements <span class="o">(</span>6.00%<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="m">3</span> <span class="o">(</span>3.00%<span class="o">)</span> high mild
</span></span><span class="line"><span class="cl">  <span class="m">3</span> <span class="o">(</span>3.00%<span class="o">)</span> high severe
</span></span><span class="line"><span class="cl">Gnuplot not found, disabling plotting
</span></span></code></pre></td></tr></table>
</div>
</div><p>Comparison with the results of previous Go tests.</p>
<table>
<thead>
<tr>
<th>language</th>
<th>short string</th>
<th>long string</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rust</td>
<td>8.8762ns</td>
<td>30.005ns</td>
</tr>
<tr>
<td>Go</td>
<td>25.1ns</td>
<td>67.0ns</td>
</tr>
</tbody>
</table>
<p>Rust takes less than half the time of Go in both cases, and Rust really beats Go in terms of performance.</p>
<p>There are a few things not mentioned above.</p>
<p>First, there is concurrency. go comes with concurrency, and you can simply use <code>go/chan</code> to achieve efficient and resource-inefficient concurrency. rust does not have this support at the language level, but with its flexible type system, it provides the infrastructure for concurrency with the Future type. On top of that, <a href="https://tokio.rs/">tokio</a> implements a goroutine-like set of concurrency mechanisms. Since Go&rsquo;s type system is too simple, there is no way to implement concurrency as a library. This is something that Rust does beautifully.</p>
<p>Regarding packages, Rust is full of unnecessary complexity compared to Go&rsquo;s directory-based packages, where <code>mod name</code> can introduce another compilation unit, name, either as a file <code>name.rs</code> in the same directory or as a file <code>name/mod.rs</code> in a subdirectory. The <code>mod</code> itself also generates a namespace of <code>name</code>, so if you want to refer to symbols in a package, either introduce the symbols via <code>use</code> or give the namespace with <code>name::</code> as the symbol prefix. This makes it extremely complicated when trying to split the code in a package into different files. Basically, to split files and still be able to refer to each other, you need to write code like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">mod</span> <span class="nx">part1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">mod</span> <span class="nx">part2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">pub</span> <span class="nx">use</span> <span class="nx">self</span><span class="p">::</span><span class="nx">part1</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">pub</span> <span class="nx">use</span> <span class="nx">self</span><span class="p">::</span><span class="nx">part2</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This also causes the private symbols in <code>part1</code> and <code>part2</code> to be invisible to each other. The <code>mod/use</code> feature seems flexible, but in practice it ends up forcing the contents of a package to be written to a single file. This is much harder to understand and use than Go&rsquo;s natural &ldquo;one package, one directory&rdquo; format. Rust 2018 also tries to improve this problem, as detailed in <a href="https://rust-lang-nursery.github.io/edition-guide/2018/transitioning/modules/path-clarity.html">Path clarity</a>.</p>
<p>Rust&rsquo;s control over compilation units relies on macro directives to do this. For example, if a part of the code is said to be compiled only at test time, you need to write:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[cfg(test)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This way the code inside <code>mod tests</code> will only be compiled at <code>test</code>. Go uses a file suffix to make this distinction. For example, <code>xxx_test.go</code> only compiles on tests by default. Here I think the Go approach is more natural. You can tell which compile control is in a package and which file will be used in which state by looking directly at the file name. Similarly <code>xxx_unix.go/yyy_windows.go</code> also provides convenience for maintenance. rust can only know the compilation rules by looking at them file by file if there is no proper tool.</p>
<p>When it comes to tools, the quality of the Rust tool chain is dismal compared to that of Go. The performance tests mentioned above are one example. a large number of Rust tools are currently in preview or only available nightly (it seems that clippy has just recently entered into stable preview status). the Rust community hopes that 2018 will provide a stable productivity version <a href="https://rust-lang-nursery.github.io/edition-guide/2018/index.html">Rust 2018</a>, but now that 2018 is halfway through, there is still some syntax work that has not been merged into stable. this has to be remembered when C++ 98 was dragged to C++ 00 and then to C++ 0x. hopefully Rust will The Rust community has set the release of the 2018 version for October, and the projects are now in line with the expected progress. We hope to see a more productive stable release by the end of this year, not just of the language features but also of the key toolchain.</p>
<p>Go&rsquo;s current <code>GOPATH</code> model is probably only good for Google itself. The good thing is that Go modules have been <a href="https://groups.google.com/forum/#!topic/golang-dev/a5PqQuBljF4">arrow on the string</a>, so you won&rsquo;t have to put up with such a hard-to-use feature soon.</p>
<p>Rust and Go are two completely different languages, with Go trying to optimize the development process, reduce the number of concepts exposed to programmers, and have a stable enough interface. Rust, on the other hand, exposes all the features to the programmer as a choice, and the language community is responsible for the core compiler, solidifying best practices into language features, and leaving the toolchain to the community for refinement.</p>
<p>I recommend that all Go programmers give Rust a try and experience how the compiler forces the details of the program to be understood. These details are the complexity that Go tries to hide, but understanding them can be very helpful in writing programs, even Go programs. On the other hand, Go is by far the better choice for companies that want to build a &ldquo;hard core&rdquo;, assemble a team of different skill levels, leverage the strength of the existing community, and simplify engineering complexity.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/rust/">rust</a>
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/es-module-dynamically/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How to dynamically import ECMAScript modules</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/go-swagger/">
            <span class="next-text nav-default">Using Go Swagger to generate OpenAPI definitions</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
