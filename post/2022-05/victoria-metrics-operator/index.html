<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Manage VM clusters with Victoria Metrics Operator - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to manage VM clusters with Victoria Metrics Operator." /><meta name="keywords" content="Victoria Metrics Operator, VM clusters" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/victoria-metrics-operator/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Manage VM clusters with Victoria Metrics Operator" />
<meta property="og:description" content="Learn how to manage VM clusters with Victoria Metrics Operator." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/victoria-metrics-operator/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-18T14:17:30+08:00" />
<meta property="article:modified_time" content="2022-05-18T14:17:30+08:00" />

<meta itemprop="name" content="Manage VM clusters with Victoria Metrics Operator">
<meta itemprop="description" content="Learn how to manage VM clusters with Victoria Metrics Operator."><meta itemprop="datePublished" content="2022-05-18T14:17:30+08:00" />
<meta itemprop="dateModified" content="2022-05-18T14:17:30+08:00" />
<meta itemprop="wordCount" content="3236">
<meta itemprop="keywords" content="Kubernetes," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Manage VM clusters with Victoria Metrics Operator"/>
<meta name="twitter:description" content="Learn how to manage VM clusters with Victoria Metrics Operator."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Manage VM clusters with Victoria Metrics Operator</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-18 14:17:30 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3236 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install">Install</a></li>
        <li><a href="#deploy-a-vm-cluster">Deploy a VM cluster</a></li>
        <li><a href="#verifying-vm-clustering">Verifying VM Clustering</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>The Operator, as we know, is a great tool for Kubernetes, greatly simplifying the installation, configuration and management of applications, and for VictoriaMetrics there is an official counterpart to the Operator for management - <strong><code>vm-operator</code></strong>, which is inspired by <strong><code>prometheus-operator</code></strong> and is a great tool for managing application monitoring configurations.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/fc8628c2ce224ed08ad8ec2811808f08.png" alt="vm-operator"></p>
<p>The vm-operator defines some CRDs as follows.</p>
<ul>
<li><code>VMCluster</code>: defines VM clusters</li>
<li><code>VMAgent</code> : defines vmagent instances</li>
<li><code>VMServiceScrape</code>: defines the metrics configuration for grabbing from Service supported Pods</li>
<li><code>VMPodScrape</code> : Defines the metrics configuration to be grabbed from Pods</li>
<li><code>VMRule</code> : Define alarm and logging rules</li>
<li><code>VMProbe</code> : Define probe configuration for target using blackbox exporter</li>
</ul>
<p>The Operator also recognizes the <code>ServiceMonitor</code>, <code>PodMonitor</code>, <code>PrometheusRule</code> and <code>Probe</code> objects in the prometheus-operator by default, and allows you to use CRD objects to manage VM applications within a Kubernetes cluster.</p>
<h2 id="install">Install</h2>
<p>The Helm Charts package is provided with vm-operator, so you can use Helm to do a one-click installation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ helm repo add vm https://victoriametrics.github.io/helm-charts/
</span></span><span class="line"><span class="cl">☸ ➜ helm repo update
</span></span></code></pre></td></tr></table>
</div>
</div><p>Customize the values to suit your needs. The default <code>values.yaml</code> can be obtained with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ helm show values vm/victoria-metrics-operator &gt; values.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>We have made only the following changes here.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rbac</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">pspEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># 不创建psp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">operator</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- 默认情况下，vm-operator会转换prometheus-operator对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">disable_prometheus_converter</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- 默认情况下，vm-operator会为它的对象创建psp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">psp_auto_creation_enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- 启用转换后的 prometheus-operator 对象的所有权引用，如果删除 prometheus 对象，它将删除相应的 victoria-metrics 对象。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enable_converter_ownership</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># -- Enables custom config-reloader, bundled with operator.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># It should reduce  vmagent and vmauth config sync-time and make it predictable.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">useCustomConfigReloader</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># -- 是否开启资源校验的准入控制器(生产环境建议开启)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># admissionWebhooks:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   # -- Enables validation webhook.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   enabled: false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   # -- What to do in case, when operator not available to validate request.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   policy: Fail</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   # -- Enables custom ca bundle, if you are not using cert-manager.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   # -- in case of custom ca, you have to create secret - {{chart-name}}-validation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   # -- with keys: tls.key, tls.crt, ca.crt</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   caBundle: &#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   certManager:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#     # -- Enables cert creation and injection by cert-manager.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#     enabled: false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#     # --If needed, provide own issuer. Operator will create self-signed if empty.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#     issuer: {}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The vm-operator can then be installed with one click using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ helm upgrade --install victoria-metrics-operator vm/victoria-metrics-operator -f values.yaml -n vm-operator --create-namespace
</span></span><span class="line"><span class="cl">NAME: victoria-metrics-operator
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue May <span class="m">17</span> 15:51:40 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: vm-operator
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">victoria-metrics-operator has been installed. Check its status by running:
</span></span><span class="line"><span class="cl">  kubectl --namespace vm-operator get pods -l <span class="s2">&#34;app.kubernetes.io/instance=victoria-metrics-operator&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Get more information on https://github.com/VictoriaMetrics/helm-charts/tree/master/charts/victoria-metrics-operator.
</span></span><span class="line"><span class="cl">See <span class="s2">&#34;Getting started guide for VM Operator&#34;</span> on https://docs.victoriametrics.com/guides/getting-started-with-vm-operator.html .
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can check the status of vm-operator after the installation is complete to verify that the installation was successful.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ helm ls -n vm-operator
</span></span><span class="line"><span class="cl">NAME                            NAMESPACE       REVISION        UPDATED                                 STATUS       CHART                           APP VERSION
</span></span><span class="line"><span class="cl">victoria-metrics-operator       vm-operator     <span class="m">1</span>               2022-05-17 15:53:14.60667 +0800 CST     deployed     victoria-metrics-operator-0.9.0 0.24.0
</span></span><span class="line"><span class="cl">☸ ➜ kubectl --namespace vm-operator get pods -l <span class="s2">&#34;app.kubernetes.io/instance=victoria-metrics-operator&#34;</span>
</span></span><span class="line"><span class="cl">NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">victoria-metrics-operator-d467cf69c-glh6v   1/1     Running   <span class="m">0</span>          2m58s
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="deploy-a-vm-cluster">Deploy a VM cluster</h2>
<p>The Operator installation will contain a number of CRDs as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl get crd <span class="p">|</span>grep victoriametrics
</span></span><span class="line"><span class="cl">vmagents.operator.victoriametrics.com                2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmalertmanagerconfigs.operator.victoriametrics.com   2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmalertmanagers.operator.victoriametrics.com         2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmalerts.operator.victoriametrics.com                2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmauths.operator.victoriametrics.com                 2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmclusters.operator.victoriametrics.com              2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmnodescrapes.operator.victoriametrics.com           2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmpodscrapes.operator.victoriametrics.com            2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmprobes.operator.victoriametrics.com                2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmrules.operator.victoriametrics.com                 2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmservicescrapes.operator.victoriametrics.com        2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmsingles.operator.victoriametrics.com               2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmstaticscrapes.operator.victoriametrics.com         2022-05-17T07:51:42Z
</span></span><span class="line"><span class="cl">vmusers.operator.victoriametrics.com                 2022-05-17T07:51:42Z
</span></span></code></pre></td></tr></table>
</div>
</div><p>For example, if we want to deploy VMs in single node mode, we can use the <code>VMSingle</code> object. If we want to deploy a cluster of VMs, we can just use <code>VMCluster</code> to define an object. We don&rsquo;t need to create the components manually, Operator will pull up a cluster for us based on our definition.</p>
<p>For example, here we define a <code>VMCluster</code> object as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmcluster-demo.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">operator.victoriametrics.com/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VMCluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmcluster-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicationFactor</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">retentionPeriod</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1w&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmstorage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicaCount</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeClaimTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">10G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storageDataPath</span><span class="p">:</span><span class="w"> </span><span class="l">/vm-data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vmselect</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicaCount</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cacheMountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeClaimTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">nfs-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">1G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vminsert</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicaCount</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Here we specify the length of data retention as 1 week via <code>spec.retentionPeriod</code>, <code>replicaCount</code> to specify the number of copies for each component as 2, and the PVC template for data persistence via <code>storage.volumeClaimTemplate</code>. can be obtained via <code>kubectl explain</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl explain VMCluster.spec
</span></span><span class="line"><span class="cl">KIND:     VMCluster
</span></span><span class="line"><span class="cl">VERSION:  operator.victoriametrics.com/v1beta1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RESOURCE: spec &lt;Object&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DESCRIPTION:
</span></span><span class="line"><span class="cl">     VMClusterSpec defines the desired state of VMCluster
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   clusterVersion       &lt;string&gt;
</span></span><span class="line"><span class="cl">     ClusterVersion defines default images tag <span class="k">for</span> all components. it can be
</span></span><span class="line"><span class="cl">     overwritten with component specific image.tag value.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   imagePullSecrets     &lt;<span class="o">[]</span>Object&gt;
</span></span><span class="line"><span class="cl">     ImagePullSecrets An optional list of references to secrets in the same
</span></span><span class="line"><span class="cl">     namespace to use <span class="k">for</span> pulling images from registries see
</span></span><span class="line"><span class="cl">     http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   podSecurityPolicyName        &lt;string&gt;
</span></span><span class="line"><span class="cl">     PodSecurityPolicyName - defines name <span class="k">for</span> podSecurityPolicy in <span class="k">case</span> of empty
</span></span><span class="line"><span class="cl">     value, prefixedName will be used.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   replicationFactor    &lt;integer&gt;
</span></span><span class="line"><span class="cl">     ReplicationFactor defines how many copies of data make among distinct
</span></span><span class="line"><span class="cl">     storage nodes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   retentionPeriod      &lt;string&gt; -required-
</span></span><span class="line"><span class="cl">     RetentionPeriod <span class="k">for</span> the stored metrics Note VictoriaMetrics has data/ and
</span></span><span class="line"><span class="cl">     indexdb/ folders metrics from data/ removed eventually as soon as partition
</span></span><span class="line"><span class="cl">     leaves retention period reverse index data at indexdb rotates once at the
</span></span><span class="line"><span class="cl">     half of configured retention period
</span></span><span class="line"><span class="cl">     https://docs.victoriametrics.com/Single-server-VictoriaMetrics.html#retention
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   serviceAccountName   &lt;string&gt;
</span></span><span class="line"><span class="cl">     ServiceAccountName is the name of the ServiceAccount to use to run the
</span></span><span class="line"><span class="cl">     VMSelect Pods.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   vminsert     &lt;Object&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   vmselect     &lt;Object&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   vmstorage    &lt;Object&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similarly to get the properties that can be defined by the component you can also get them in this way. For example, to see the properties that can be configured for the <code>vmstorage</code> object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl explain VMCluster.spec.vmstorage
</span></span><span class="line"><span class="cl">KIND:     VMCluster
</span></span><span class="line"><span class="cl">VERSION:  operator.victoriametrics.com/v1beta1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RESOURCE: vmstorage &lt;Object&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DESCRIPTION:
</span></span><span class="line"><span class="cl">     &lt;empty&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FIELDS:
</span></span><span class="line"><span class="cl">   affinity     &lt;&gt;
</span></span><span class="line"><span class="cl">     Affinity If specified, the pod<span class="s1">&#39;s scheduling constraints.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   configMaps   &lt;[]string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     ConfigMaps is a list of ConfigMaps in the same namespace as the VMSelect
</span></span></span><span class="line"><span class="cl"><span class="s1">     object, which shall be mounted into the VMSelect Pods. The ConfigMaps are
</span></span></span><span class="line"><span class="cl"><span class="s1">     mounted into /etc/vm/configs/&lt;configmap-name&gt;.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   containers   &lt;[]&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Containers property allows to inject additions sidecars or to patch
</span></span></span><span class="line"><span class="cl"><span class="s1">     existing containers. It can be useful for proxies, backup, etc.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   dnsConfig    &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Specifies the DNS parameters of a pod. Parameters specified here will be
</span></span></span><span class="line"><span class="cl"><span class="s1">     merged to the generated DNS configuration based on DNSPolicy.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   dnsPolicy    &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     DNSPolicy sets DNS policy for the pod
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   extraArgs    &lt;map[string]string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   extraEnvs    &lt;[]&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     ExtraEnvs that will be added to VMSelect pod
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   hostNetwork  &lt;boolean&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     HostNetwork controls whether the pod may use the node network namespace
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   image        &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Image - docker image settings for VMStorage
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   initContainers       &lt;[]&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     InitContainers allows adding initContainers to the pod definition. Those
</span></span></span><span class="line"><span class="cl"><span class="s1">     can be used to e.g. fetch secrets for injection into the VMSelect
</span></span></span><span class="line"><span class="cl"><span class="s1">     configuration from external sources. Any errors during the execution of an
</span></span></span><span class="line"><span class="cl"><span class="s1">     initContainer will lead to a restart of the Pod. More info:
</span></span></span><span class="line"><span class="cl"><span class="s1">     https://kubernetes.io/docs/concepts/workloads/pods/init-containers/ Using
</span></span></span><span class="line"><span class="cl"><span class="s1">     initContainers for any use case other then secret fetching is entirely
</span></span></span><span class="line"><span class="cl"><span class="s1">     outside the scope of what the maintainers will support and by doing so, you
</span></span></span><span class="line"><span class="cl"><span class="s1">     accept that this behaviour may break at any time without notice.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   livenessProbe        &lt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     LivenessProbe that will be added CRD pod
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   logFormat    &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     LogFormat for VMSelect to be configured with. default or json
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   logLevel     &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     LogLevel for VMSelect to be configured with.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   maintenanceInsertNodeIDs     &lt;[]integer&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     MaintenanceInsertNodeIDs - excludes given node ids from insert requests
</span></span></span><span class="line"><span class="cl"><span class="s1">     routing, must contain pod suffixes - for pod-0, id will be 0 and etc. lets
</span></span></span><span class="line"><span class="cl"><span class="s1">     say, you have pod-0, pod-1, pod-2, pod-3. to exclude pod-0 and pod-3 from
</span></span></span><span class="line"><span class="cl"><span class="s1">     insert routing, define nodeIDs: [0,3]. Useful at storage expanding, when
</span></span></span><span class="line"><span class="cl"><span class="s1">     you want to rebalance some data at cluster.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   maintenanceSelectNodeIDs     &lt;[]integer&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     MaintenanceInsertNodeIDs - excludes given node ids from select requests
</span></span></span><span class="line"><span class="cl"><span class="s1">     routing, must contain pod suffixes - for pod-0, id will be 0 and etc.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   name &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Name is deprecated and will be removed at 0.22.0 release
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   nodeSelector &lt;map[string]string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     NodeSelector Define which Nodes the Pods are scheduled on.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   podDisruptionBudget  &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     PodDisruptionBudget created by operator
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   podMetadata  &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     PodMetadata configures Labels and Annotations which are propagated to the
</span></span></span><span class="line"><span class="cl"><span class="s1">     VMSelect pods.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   port &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Port for health check connetions
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   priorityClassName    &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Priority class assigned to the Pods
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   readinessProbe       &lt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     ReadinessProbe that will be added CRD pod
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   replicaCount &lt;integer&gt; -required-
</span></span></span><span class="line"><span class="cl"><span class="s1">     ReplicaCount is the expected size of the VMStorage cluster. The controller
</span></span></span><span class="line"><span class="cl"><span class="s1">     will eventually make the size of the running cluster equal to the expected
</span></span></span><span class="line"><span class="cl"><span class="s1">     size.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   resources    &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Resources container resource request and limits,
</span></span></span><span class="line"><span class="cl"><span class="s1">     https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   rollingUpdateStrategy        &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     RollingUpdateStrategy defines strategy for application updates Default is
</span></span></span><span class="line"><span class="cl"><span class="s1">     OnDelete, in this case operator handles update process Can be changed for
</span></span></span><span class="line"><span class="cl"><span class="s1">     RollingUpdate
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   runtimeClassName     &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     RuntimeClassName - defines runtime class for kubernetes pod.
</span></span></span><span class="line"><span class="cl"><span class="s1">     https://kubernetes.io/docs/concepts/containers/runtime-class/
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   schedulerName        &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     SchedulerName - defines kubernetes scheduler name
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   secrets      &lt;[]string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Secrets is a list of Secrets in the same namespace as the VMSelect object,
</span></span></span><span class="line"><span class="cl"><span class="s1">     which shall be mounted into the VMSelect Pods. The Secrets are mounted into
</span></span></span><span class="line"><span class="cl"><span class="s1">     /etc/vm/secrets/&lt;secret-name&gt;.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   securityContext      &lt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     SecurityContext holds pod-level security attributes and common container
</span></span></span><span class="line"><span class="cl"><span class="s1">     settings. This defaults to the default PodSecurityContext.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   serviceScrapeSpec    &lt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     ServiceScrapeSpec that will be added to vmselect VMServiceScrape spec
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   serviceSpec  &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     ServiceSpec that will be create additional service for vmstorage
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   startupProbe &lt;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     StartupProbe that will be added to CRD pod
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   storage      &lt;Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Storage - add persistent volume for StorageDataPath its useful for
</span></span></span><span class="line"><span class="cl"><span class="s1">     persistent cache
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   storageDataPath      &lt;string&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     StorageDataPath - path to storage data
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   terminationGracePeriodSeconds        &lt;integer&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     TerminationGracePeriodSeconds period for container graceful termination
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">   tolerations  &lt;[]Object&gt;
</span></span></span><span class="line"><span class="cl"><span class="s1">     Tolerations If specified, the pod&#39;</span>s tolerations.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   topologySpreadConstraints    &lt;<span class="o">[]</span>&gt;
</span></span><span class="line"><span class="cl">     TopologySpreadConstraints embedded kubernetes pod configuration option,
</span></span><span class="line"><span class="cl">     controls how pods are spread across your cluster among failure-domains such
</span></span><span class="line"><span class="cl">     as regions, zones, nodes, and other user-defined topology domains
</span></span><span class="line"><span class="cl">     https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   vmBackup     &lt;Object&gt;
</span></span><span class="line"><span class="cl">     VMBackup configuration <span class="k">for</span> backup
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   vmInsertPort &lt;string&gt;
</span></span><span class="line"><span class="cl">     VMInsertPort <span class="k">for</span> VMInsert connections
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   vmSelectPort &lt;string&gt;
</span></span><span class="line"><span class="cl">     VMSelectPort <span class="k">for</span> VMSelect connections
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   volumeMounts &lt;<span class="o">[]</span>Object&gt;
</span></span><span class="line"><span class="cl">     VolumeMounts allows configuration of additional VolumeMounts on the output
</span></span><span class="line"><span class="cl">     Deployment definition. VolumeMounts specified will be appended to other
</span></span><span class="line"><span class="cl">     VolumeMounts in the VMSelect container, that are generated as a result of
</span></span><span class="line"><span class="cl">     StorageSpec objects.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   volumes      &lt;<span class="o">[]</span>&gt;
</span></span><span class="line"><span class="cl">     Volumes allows configuration of additional volumes on the output Deployment
</span></span><span class="line"><span class="cl">     definition. Volumes specified will be appended to other volumes that are
</span></span><span class="line"><span class="cl">     generated as a result of StorageSpec objects.
</span></span></code></pre></td></tr></table>
</div>
</div><p>Directly apply the object defined above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl apply -f vmcluster-demo.yaml
</span></span><span class="line"><span class="cl">☸ ➜ kubectl get vmcluster
</span></span><span class="line"><span class="cl">NAME             INSERT COUNT   STORAGE COUNT   SELECT COUNT   AGE     STATUS
</span></span><span class="line"><span class="cl">vmcluster-demo   <span class="m">2</span>              <span class="m">2</span>               <span class="m">2</span>              7m21s   expanding
</span></span></code></pre></td></tr></table>
</div>
</div><p>After application, vm-operator will watch that we have created the CRD object and will automatically create the corresponding VM clusters according to our definition, which are the component services mentioned earlier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl get pods
</span></span><span class="line"><span class="cl">NAME                                       READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">vminsert-vmcluster-demo-84956d98b5-5ckft   1/1     Running   <span class="m">0</span>             93s
</span></span><span class="line"><span class="cl">vminsert-vmcluster-demo-84956d98b5-kpcj6   1/1     Running   <span class="m">0</span>             93s
</span></span><span class="line"><span class="cl">vmselect-vmcluster-demo-0                  1/1     Running   <span class="m">0</span>             3m7s
</span></span><span class="line"><span class="cl">vmselect-vmcluster-demo-1                  1/1     Running   <span class="m">0</span>             3m7s
</span></span><span class="line"><span class="cl">vmstorage-vmcluster-demo-0                 1/1     Running   <span class="m">0</span>             4m54s
</span></span><span class="line"><span class="cl">vmstorage-vmcluster-demo-1                 1/1     Running   <span class="m">0</span>             4m54s
</span></span><span class="line"><span class="cl">☸ ➜ kubectl get svc
</span></span><span class="line"><span class="cl">NAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
</span></span><span class="line"><span class="cl">vminsert-vmcluster-demo    ClusterIP   10.102.145.24   &lt;none&gt;        8480/TCP                     4m57s
</span></span><span class="line"><span class="cl">vmselect-vmcluster-demo    ClusterIP   None            &lt;none&gt;        8481/TCP                     6m31s
</span></span><span class="line"><span class="cl">vmstorage-vmcluster-demo   ClusterIP   None            &lt;none&gt;        8482/TCP,8400/TCP,8401/TCP   8m18s
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can manage the VM cluster by defining a simple <code>VMCluster</code> object, which is very convenient, especially when you have a large number of component copies and don&rsquo;t need to manually configure the <code>-storageNode</code> parameter.</p>
<p>Now the VM cluster is installed successfully, but there is no data yet, so we still need to configure the monitoring metrics capture, here we can just go ahead and create a <code>VMAgent</code> object, create an object as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmagent-demo.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">operator.victoriametrics.com/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VMAgent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vmagent-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceScrapeNamespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podScrapeNamespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podScrapeSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceScrapeSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeScrapeSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeScrapeNamespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">staticScrapeSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">staticScrapeNamespaceSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicaCount</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">remoteWrite</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://vminsert-vmcluster-demo.default.svc.cluster.local:8480/insert/0/prometheus/api/v1/write&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Again to get all the configurable properties of <code>VMAgent</code> you can use <code>kubectl explain VMAgent.spec</code> to get them, the main configuration here is to specify the URL address of the remote write via <code>remoteWrite.url</code>, which is the service address of the <code>vminsert</code> component. Several other properties can be used to filter on the metrics to be fetched.</p>
<p>Apply the above <code>VMAgent</code> object directly to start capturing the monitoring data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl apply -f vmagent-demo.yaml
</span></span><span class="line"><span class="cl">☸ ➜ kubectl get vmagent
</span></span><span class="line"><span class="cl">NAME           AGE
</span></span><span class="line"><span class="cl">vmagent-demo   6s
</span></span></code></pre></td></tr></table>
</div>
</div><p>After creation, vm-operator will create a corresponding <code>vmagent</code> instance based on the corresponding description.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl get pods -l app.kubernetes.io/name<span class="o">=</span>vmagent
</span></span><span class="line"><span class="cl">NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">vmagent-vmagent-demo-6dcc7f9dfd-hxsff   2/2     Running   <span class="m">0</span>          4m24s
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that <code>vmagent</code> has two containers, one is the <code>vmagent</code> application container and the other is the <code>config-reloader</code> container used to mount the Secret object, which watches for configuration changes and sends a signal to <code>vmagent</code> to reload the configuration. In this Secret object is the configuration content of the defined <code>vmagent</code> crawl metric.</p>
<p>We can run the following command to make the port of <code>vmagent</code> accessible from the local machine.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl port-forward svc/vmagent-vmagent-demo 8429:8429
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:8429 -&gt; <span class="m">8429</span>
</span></span><span class="line"><span class="cl">Forwarding from <span class="o">[</span>::1<span class="o">]</span>:8429 -&gt; <span class="m">8429</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can check the cluster metrics collected by <code>vmagent</code> by visiting <code>http://127.0.0.1:8429/targets</code> in the browser.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/9bd021db5743451ea72b097df3ecebae.png" alt="cluster metrics collected by vmagent"></p>
<p>The <code>vmagent</code> will go through the Kubernetes service discovery to get the target to be crawled, which is controlled by the vm-operator.</p>
<h2 id="verifying-vm-clustering">Verifying VM Clustering</h2>
<p>Next we install Grafana to validate the VM cluster, here we will just use Helm Chart for simplicity.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span class="line"><span class="cl">☸ ➜ helm repo update
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can define the data source and some built-in dashboard in values in advance, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | helm install grafana grafana/grafana -f -
</span></span></span><span class="line"><span class="cl"><span class="s">  datasources:
</span></span></span><span class="line"><span class="cl"><span class="s">    datasources.yaml:
</span></span></span><span class="line"><span class="cl"><span class="s">      apiVersion: 1
</span></span></span><span class="line"><span class="cl"><span class="s">      datasources:
</span></span></span><span class="line"><span class="cl"><span class="s">        - name: victoriametrics
</span></span></span><span class="line"><span class="cl"><span class="s">          type: prometheus
</span></span></span><span class="line"><span class="cl"><span class="s">          orgId: 1
</span></span></span><span class="line"><span class="cl"><span class="s">          url: http://vmselect-vmcluster-demo.default.svc.cluster.local:8481/select/0/prometheus/
</span></span></span><span class="line"><span class="cl"><span class="s">          access: proxy
</span></span></span><span class="line"><span class="cl"><span class="s">          isDefault: true
</span></span></span><span class="line"><span class="cl"><span class="s">          updateIntervalSeconds: 10
</span></span></span><span class="line"><span class="cl"><span class="s">          editable: true
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  dashboardProviders:
</span></span></span><span class="line"><span class="cl"><span class="s">   dashboardproviders.yaml:
</span></span></span><span class="line"><span class="cl"><span class="s">     apiVersion: 1
</span></span></span><span class="line"><span class="cl"><span class="s">     providers:
</span></span></span><span class="line"><span class="cl"><span class="s">     - name: &#39;default&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">       orgId: 1
</span></span></span><span class="line"><span class="cl"><span class="s">       folder: &#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">       type: file
</span></span></span><span class="line"><span class="cl"><span class="s">       disableDeletion: true
</span></span></span><span class="line"><span class="cl"><span class="s">       editable: true
</span></span></span><span class="line"><span class="cl"><span class="s">       options:
</span></span></span><span class="line"><span class="cl"><span class="s">         path: /var/lib/grafana/dashboards/default
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">  dashboards:
</span></span></span><span class="line"><span class="cl"><span class="s">    default:
</span></span></span><span class="line"><span class="cl"><span class="s">      victoriametrics:
</span></span></span><span class="line"><span class="cl"><span class="s">        gnetId: 11176
</span></span></span><span class="line"><span class="cl"><span class="s">        revision: 18
</span></span></span><span class="line"><span class="cl"><span class="s">        datasource: victoriametrics
</span></span></span><span class="line"><span class="cl"><span class="s">      vmagent:
</span></span></span><span class="line"><span class="cl"><span class="s">        gnetId: 12683
</span></span></span><span class="line"><span class="cl"><span class="s">        revision: 7
</span></span></span><span class="line"><span class="cl"><span class="s">        datasource: victoriametrics
</span></span></span><span class="line"><span class="cl"><span class="s">      kubernetes:
</span></span></span><span class="line"><span class="cl"><span class="s">        gnetId: 14205
</span></span></span><span class="line"><span class="cl"><span class="s">        revision: 1
</span></span></span><span class="line"><span class="cl"><span class="s">        datasource: victoriametrics
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">NAME: grafana
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue May <span class="m">17</span> 17:13:14 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: default
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">1. Get your <span class="s1">&#39;admin&#39;</span> user password by running:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   kubectl get secret --namespace default grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2. The Grafana server can be accessed via port <span class="m">80</span> on the following DNS name from within your cluster:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   grafana.default.svc.cluster.local
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Get the Grafana URL to visit by running these commands in the same shell:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="nb">export</span> <span class="nv">POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods --namespace default -l <span class="s2">&#34;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana&#34;</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].metadata.name}&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">     kubectl --namespace default port-forward <span class="nv">$POD_NAME</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">3. Login with the password from step <span class="m">1</span> and the username: admin
</span></span><span class="line"><span class="cl"><span class="c1">#################################################################################</span>
</span></span><span class="line"><span class="cl"><span class="c1">######   WARNING: Persistence is disabled!!! You will lose your data when   #####</span>
</span></span><span class="line"><span class="cl"><span class="c1">######            the Grafana pod is terminated.                            #####</span>
</span></span><span class="line"><span class="cl"><span class="c1">#################################################################################</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the installation is complete, you can expose the Grafana service locally using the command prompted above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ <span class="nb">export</span> <span class="nv">POD_NAME</span><span class="o">=</span><span class="k">$(</span>kubectl get pods --namespace default -l <span class="s2">&#34;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana&#34;</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.items[0].metadata.name}&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">     kubectl --namespace default port-forward <span class="nv">$POD_NAME</span> <span class="m">3000</span>
</span></span><span class="line"><span class="cl">Forwarding from 127.0.0.1:3000 -&gt; <span class="m">3000</span>
</span></span><span class="line"><span class="cl">Forwarding from <span class="o">[</span>::1<span class="o">]</span>:3000 -&gt; <span class="m">3000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The login user name is <code>admin</code> and the password can be obtained with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl get secret --namespace default grafana -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.admin-password}&#34;</span> <span class="p">|</span> base64 --decode <span class="p">;</span> <span class="nb">echo</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can check the dashboard of the victoriametrics cluster.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/d40c9284158d4f67a4bb42aac99da61a.png" alt="dashboard of the victoriametrics cluster"></p>
<p>The normal page can be seen as shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/8fbe144f3dfd447183e441c75f29f4c9.png" alt="normal page"></p>
<p>This is because by default <code>VMAgent</code> collects metrics from VM cluster related components, including <code>vmagent</code> itself, so we can see the VM cluster Dashboard normally, but not other metrics such as node-exporter, we can import the dashboard <code>16098</code> in Grafana.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/cc585be62e394db880f40dd4ab5625e1.png" alt="Dashboard"></p>
<p>This time we can define it through the <code>VMNodeScrape</code> CRD object. The <code>VMNodeScrape</code> object can be used to automatically discover Kubernetes nodes, creating the resource object shown below to capture node-exporter metrics.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># vmnode-exporter-scrape.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">operator.victoriametrics.com/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">VMNodeScrape</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">node-exporter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;9111&#34;</span><span class="w"> </span><span class="c"># 指定 node-exporter 的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scrape_interval</span><span class="p">:</span><span class="w"> </span><span class="l">15s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   relabelConfigs：  # relabel配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   selector:  # 过滤节点</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>It is sufficient to apply the above objects directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">☸ ➜ kubectl apply -f vmnode-exporter-scrape.yaml
</span></span><span class="line"><span class="cl">☸ ➜ kubectl get vmnodescrape
</span></span><span class="line"><span class="cl">NAME            AGE
</span></span><span class="line"><span class="cl">node-exporter   19s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once created, the vmagent will automatically recognize the object to crawl the node-exporter.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/0ba378aa788c4de7891d688ce8e73c72.png" alt="Dashboard"></p>
<p>At this point, the node-exporter dashboard will be fine.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/18/472a557725b74cc1bc79800a7c36ee86.png" alt="node-exporter dashboard"></p>
<p>In addition, you can define the service services (Endpoints) to be crawled through <code>VMServiceScrape</code>, which generates the crawl configuration for <code>vmagent</code> based on the selector, and if you want to crawl the metrics of Pods without Service defined, you can define them through <code>VMPodScrape</code>, and there are also alarms and related CRDs to manage. vm-operator greatly reduces the management of VM clusters and is highly recommended.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">Kubernetes</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-05/python-threads/">
            <span class="next-text nav-default">How to use threads in Python 3</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
