<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Build Docker images with multi-system architecture support - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore best practices for building Docker images supported by multiple system architectures." /><meta name="keywords" content="docker, multi-system, images" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/docker-multi-system-image/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Build Docker images with multi-system architecture support" />
<meta property="og:description" content="Explore best practices for building Docker images supported by multiple system architectures." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/docker-multi-system-image/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-02T10:29:28+08:00" />
<meta property="article:modified_time" content="2022-05-02T10:29:28+08:00" />

<meta itemprop="name" content="Build Docker images with multi-system architecture support">
<meta itemprop="description" content="Explore best practices for building Docker images supported by multiple system architectures."><meta itemprop="datePublished" content="2022-05-02T10:29:28+08:00" />
<meta itemprop="dateModified" content="2022-05-02T10:29:28+08:00" />
<meta itemprop="wordCount" content="1374">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Build Docker images with multi-system architecture support"/>
<meta name="twitter:description" content="Explore best practices for building Docker images supported by multiple system architectures."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Build Docker images with multi-system architecture support</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-02 10:29:28 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1374 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pre-requisite-knowledge">Pre-requisite knowledge</a>
          <ul>
            <li><a href="#cpu-architectures">CPU architectures</a></li>
            <li><a href="#docker-buildx">docker buildx</a></li>
            <li><a href="#docker-manifest">docker manifest</a></li>
            <li><a href="#this-article-describes-the-environment">This article describes the environment</a></li>
          </ul>
        </li>
        <li><a href="#pulling-multi-architecture-mirrors">Pulling multi-architecture mirrors</a></li>
        <li><a href="#build-multi-architecture-mirror">Build Multi-Architecture Mirror</a>
          <ul>
            <li><a href="#finding-a-parent-image-that-supports-multiple-architectures">Finding a parent image that supports multiple architectures</a></li>
            <li><a href="#build-multi-architecture-images-locally">Build multi-architecture images locally</a></li>
            <li><a href="#creating-a-push-manifest-list">Creating a Push Manifest List</a></li>
            <li><a href="#view-multi-arch-images-from-remote-repositories">View multi-arch images from remote repositories</a></li>
          </ul>
        </li>
        <li><a href="#some-of-the-best-practices">Some of the &ldquo;best&rdquo; practices</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article documents my experience in building Docker images for multi-system architectures, as well as some of my personal understandings.</p>
<h2 id="pre-requisite-knowledge">Pre-requisite knowledge</h2>
<h3 id="cpu-architectures">CPU architectures</h3>
<p>The mainstream CPU architectures are of two types: x86 and ARM, but they are not always named as such during development. For example, amd64 and x86_64 refer to the 64-bit architecture of x86, while arm64v8, aarch64, and arm64 refer to the 64-bit architecture of ARM.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/6e2e949239ce4f8aaa5e151777bc413e.png" alt="docker hub"></p>
<p>In the docker hub, the supported architectures are listed for all major images, and you can filter the images by Architectures.</p>
<h3 id="docker-buildx">docker buildx</h3>
<p>Prior to docker buildx, we could only build images via docker build. As the name suggests, docker buildx is an extension to docker&rsquo;s build capabilities, and one of its biggest highlights is its support for multi-system architecture builds.</p>
<blockquote>
<p>docker buildx for Docker v19.03+</p>
</blockquote>
<p>A docker buildx build example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker buildx build -t cop/cop-demo --platform linux/amd64 .
</span></span></code></pre></td></tr></table>
</div>
</div><p>We will describe this command in detail below.</p>
<h3 id="docker-manifest">docker manifest</h3>
<p>The docker manifest manifest, which is still experimental, is a key command for building multi-system architectures. It gives us information about the hierarchy of an image, its size, signature and, most critically, the architecture supported by the image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~ docker manifest inspect openjdk
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="s2">&#34;schemaVersion&#34;</span>: 2,
</span></span><span class="line"><span class="cl">   <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.list.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">   <span class="s2">&#34;manifests&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;size&#34;</span>: 954,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;digest&#34;</span>: <span class="s2">&#34;sha256:afbe5f6d76c1eedbbd2f689c18c1984fd67121b369fc0fbd51c510caf4f9544f&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;platform&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;amd64&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os&#34;</span>: <span class="s2">&#34;linux&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;size&#34;</span>: 954,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;digest&#34;</span>: <span class="s2">&#34;sha256:0722e5cd28b8834d2c2e6a3659ba4631c6f6aea6aa88361feff58032bb3514e3&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;platform&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;arm64&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os&#34;</span>: <span class="s2">&#34;linux&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;variant&#34;</span>: <span class="s2">&#34;v8&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;size&#34;</span>: 2983,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;digest&#34;</span>: <span class="s2">&#34;sha256:5ecbb996abc91a17257ae0192f2b69a0a3096279a5b9167aef656d6b88972b65&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;platform&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;amd64&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os&#34;</span>: <span class="s2">&#34;windows&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os.version&#34;</span>: <span class="s2">&#34;10.0.20348.643&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;size&#34;</span>: 2983,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;digest&#34;</span>: <span class="s2">&#34;sha256:702402cac2a4e078ec1df8aa23e0f13c7155621dffc520e5ac21e44d94d9ca76&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;platform&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;amd64&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os&#34;</span>: <span class="s2">&#34;windows&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os.version&#34;</span>: <span class="s2">&#34;10.0.17763.2803&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">   <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The platform column. This is the information about the architecture support that we are most interested in.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/c64c98c37c214774abb3f6284f545d85.png" alt="platform column"></p>
<p>Comparing the digest information, you can see that it is the same as the docker hub information.</p>
<h3 id="this-article-describes-the-environment">This article describes the environment</h3>
<p>All operations in this article are based on Mac M1, Docker Desktop. All operations in this article are based on Mac M1, Docker Desktop, and may involve experimentation and buildkit features, which need to be enabled. My configuration reference:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;features&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;buildkit&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;builder&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;gc&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;defaultKeepStorage&#34;</span><span class="p">:</span> <span class="s2">&#34;20GB&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;experimental&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pulling-multi-architecture-mirrors">Pulling multi-architecture mirrors</h2>
<p>Before the Mac M1 / ARM architecture was used, pulling images didn&rsquo;t seem to be that much of a hassle.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker pull openjdk
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the previous article, openjdk has different digest for different architectures, and docker will determine the architecture of the current machine and pull the version of the corresponding architecture. For example, on Mac M1, I pull the arm64 version.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~ docker image inspect openjdk <span class="p">|</span> grep Arch
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Architecture&#34;</span>: <span class="s2">&#34;arm64&#34;</span>,
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can also specify the image corresponding to the OS &amp; architecture to be pulled by using the <code>--platform</code> parameter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker pull --platform linux/amd64 openjdk
</span></span></code></pre></td></tr></table>
</div>
</div><p>The same image tag, only one copy will be saved locally, check the architecture information of the local image again, it is already amd64.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~ docker image inspect openjdk <span class="p">|</span> grep Arch
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Architecture&#34;</span>: <span class="s2">&#34;amd64&#34;</span>,
</span></span></code></pre></td></tr></table>
</div>
</div><p>The hub side supports storing multiple mirrors according to Arch, actually using mechanisms such as manifest, but not all mirrors support manifest.</p>
<p>This also means that the <code>--platform</code> argument does not apply to all mirrors, and you can check the Arch support of mirrors with <code>docker manifest inspect</code>.</p>
<h2 id="build-multi-architecture-mirror">Build Multi-Architecture Mirror</h2>
<p>I had a lot of confusion and pitfalls while investigating the option of building multi-architecture mirrors, but I ended up with the option of building multi-architecture mirrors with docker buildx and merging manifest lists with docker manifest.</p>
<h3 id="finding-a-parent-image-that-supports-multiple-architectures">Finding a parent image that supports multiple architectures</h3>
<p>Take openjdk for example, it provides both arm64 and amd64 versions, so we&rsquo;ll use it for the demo.</p>
<p>Java demo.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;hello world&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Dockerfile:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> openjdk:17</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . /usr/src/myapp<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /usr/src/myapp</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> javac Main.java<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;java&#34;</span><span class="p">,</span> <span class="s2">&#34;Main&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="build-multi-architecture-images-locally">Build multi-architecture images locally</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~ docker buildx inspect --bootstrap
</span></span><span class="line"><span class="cl">Name:   default
</span></span><span class="line"><span class="cl">Driver: docker
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nodes:
</span></span><span class="line"><span class="cl">Name:      default
</span></span><span class="line"><span class="cl">Endpoint:  default
</span></span><span class="line"><span class="cl">Status:    running
</span></span><span class="line"><span class="cl">Platforms: linux/arm64, linux/amd64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6
</span></span></code></pre></td></tr></table>
</div>
</div><p>The default builder of docker buildx supports building images for linux/arm64, linux/amd64, etc. Docker achieves this capability by cross-building, so it is not limited to the CPU architecture of the build machine.</p>
<p>The docker buildx supports the <code>-platform</code> argument, which specifies the OS &amp; CPU architecture of the build image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker buildx build -t kiritomoe/java-multi-arch-demo:1.0-aarch64 --platform linux/arm64 -o <span class="nv">type</span><span class="o">=</span>docker .
</span></span><span class="line"><span class="cl">docker buildx build -t kiritomoe/java-multi-arch-demo:1.0-x86_64 --platform linux/amd64 -o <span class="nv">type</span><span class="o">=</span>docker .
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="creating-a-push-manifest-list">Creating a Push Manifest List</h3>
<p>In the previous step, we have actually built a multi-architecture image, but at this point, different architectures have different tags, which is a bit different from the familiar openjdk solution. openjdk and other images use docker manifest to bind multiple architectures to the same tag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker manifest create kiritomoe/java-multi-arch-demo:1.0 kiritomoe/java-multi-arch-demo:1.0-x86_64 kiritomoe/java-multi-arch-demo:1.0-aarch64
</span></span><span class="line"><span class="cl">docker manifest push kiritomoe/java-multi-arch-demo:1.0
</span></span><span class="line"><span class="cl">docker manifest rm kiritomoe/java-multi-arch-demo:1.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that the manifest kiritomoe/java-multi-arch-demo:1.0 was finally pushed, and no other images were pushed. And after the manifest is pushed, the local copy needs to be deleted, which makes it possible to perform operations such as <code>docker manifest inspect kiritomoe/java-multi-arch-demo:1.0</code> locally in the future to ensure that it is loaded from the remote repository, and the manifest only makes sense if it exists in the remote repository to make sense.</p>
<h3 id="view-multi-arch-images-from-remote-repositories">View multi-arch images from remote repositories</h3>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/02/fb20cd5db5ae42a0ac51c7d3e8fe4c04.png" alt="remote repositories"></p>
<p>Successfully bind multiple architectures to the same tag.</p>
<p>Use the command line to view it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">~ docker manifest inspect kiritomoe/java-multi-arch-demo:1.0
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="s2">&#34;schemaVersion&#34;</span>: 2,
</span></span><span class="line"><span class="cl">   <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.list.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">   <span class="s2">&#34;manifests&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;size&#34;</span>: 1574,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;digest&#34;</span>: <span class="s2">&#34;sha256:6cceb21f1a225c9f309f51413fdb7cf8d8ea3980a832c84c07ce3e30fed41628&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;platform&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;arm64&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os&#34;</span>: <span class="s2">&#34;linux&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;mediaType&#34;</span>: <span class="s2">&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;size&#34;</span>: 1574,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;digest&#34;</span>: <span class="s2">&#34;sha256:0dddf9a86e60de3fd56d074a8f535a90e391b35a6e503fedd09f87c8c32ca75a&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;platform&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;architecture&#34;</span>: <span class="s2">&#34;amd64&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;os&#34;</span>: <span class="s2">&#34;linux&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">   <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="some-of-the-best-practices">Some of the &ldquo;best&rdquo; practices</h2>
<p>If you research the multi-architecture support, you will find that the above mentioned solutions are not the only ones supported, and with my limited energy, I didn&rsquo;t look into the history of multi-architecture support for docker in detail. If not for the project, God knows I would have spent two days researching these things. But the above solution is the simplest one I have come up with so far.</p>
<p>While docker implements the ability to automatically pull native images based on the compiling machine, this capability is not available in all cases. For example</p>
<ol>
<li>if the build machine is not controllable, then the act of compiling will also become uncontrollable.</li>
<li>the build machine is not necessarily the machine that will eventually run the image</li>
<li>local builds for test development scenarios</li>
</ol>
<p>To keep it all under control, my personal advice is to follow two principles.</p>
<ol>
<li>Business images offer multi-arch support. For example, I chose centos for my base image (centos supports multi-arch), my local environment is Mac M1, and our company&rsquo;s build machine is x86, not everyone is a docker expert, I want to make the <code>From centos</code> strategy of pulling images manageable, and I am willing to write two Dockerfiles for it: Dockerfile_amd64 and Dockerfile_arm64. I would like to write two Dockerfiles for this purpose: Dockerfile_amd64 and Dockerfile_arm64, and eventually merge the manifest of my two products to implement multi-arch.</li>
<li>Other generic mirrors support multi-arch while providing different Arch tags, for example, in business scenarios, several types of base mirrors are generally required
<ul>
<li>Base images for java applications: java-base:1.0, java-base:1.0-aarch64, java-base:1.0-x86_64</li>
<li>Base images for front-end applications: nginx-base:1.0, nginx-base:1.0-aarch64, nginx-base:1.0-x86_64</li>
<li>Base images for general-purpose applications: centos-base:1.0, centos-base:1.0-aarch64, centos-base:1.0-x86_64</li>
</ul>
</li>
</ol>
<p>While I am aware that it is possible to accurately pull the image of a given Arch via sha256, it would add a lot of cost to understanding.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/state-management-in-risingwave/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">State Management in RisingWave</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/gcc-12-cpp-features/">
            <span class="next-text nav-default">GCC 12 introduces more C&#43;&#43;23-oriented implementations</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
