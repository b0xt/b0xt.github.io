<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Deficiencies of Tcp - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the four flaws of the TCP protocol." /><meta name="keywords" content="tcp, Deficiencies" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/deficiencies-of-tcp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Deficiencies of Tcp" />
<meta property="og:description" content="Explore the four flaws of the TCP protocol." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/deficiencies-of-tcp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-15T10:24:51+08:00" />
<meta property="article:modified_time" content="2022-05-15T10:24:51+08:00" />

<meta itemprop="name" content="Deficiencies of Tcp">
<meta itemprop="description" content="Explore the four flaws of the TCP protocol."><meta itemprop="datePublished" content="2022-05-15T10:24:51+08:00" />
<meta itemprop="dateModified" content="2022-05-15T10:24:51+08:00" />
<meta itemprop="wordCount" content="1111">
<meta itemprop="keywords" content="tcp," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deficiencies of Tcp"/>
<meta name="twitter:description" content="Explore the four flaws of the TCP protocol."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Deficiencies of Tcp</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-15 10:24:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1111 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#upgrading-tcp-is-hard-work">Upgrading TCP is hard work</a></li>
        <li><a href="#tcp-connection-establishment-delay">TCP connection establishment delay</a></li>
        <li><a href="#tcp-has-a-queue-head-blocking-problem">TCP has a queue head blocking problem</a></li>
        <li><a href="#network-migration-requires-re-establishing-tcp-connections">Network migration requires re-establishing TCP connections</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>What are the flaws in the TCP protocol that we are talking about today? There are four main areas.</p>
<ul>
<li>The difficulty in upgrading TCP.</li>
<li>Delays in establishing TCP connections.</li>
<li>TCP suffers from queue head blocking problems.</li>
<li>The need to re-establish TCP connections for network migration.</li>
</ul>
<p>Next, these four areas are addressed in detail.</p>
<h2 id="upgrading-tcp-is-hard-work">Upgrading TCP is hard work</h2>
<p>The TCP protocol was created in 1973 and is still being implemented today with many new features.</p>
<p>However, the TCP protocol is implemented in the kernel and can only be used and not modified by applications.</p>
<p>The trouble is not that upgrading the kernel is troublesome, but because kernel upgrades involve updating the underlying software and libraries, our service programs need to return to test whether they are compatible with the new kernel version, so kernel upgrades for servers are conservative and slow.</p>
<p>Many new features of the TCP protocol require both client and server support to take effect. For example, the TCP Fast Open feature was proposed in 2013, but some old systems cannot support this feature because many PC-side systems have a serious upgrade lag.</p>
<p>Therefore, even if TCP has a better feature update, it is difficult to promote it quickly, and users often need several years or ten years to experience it.</p>
<h2 id="tcp-connection-establishment-delay">TCP connection establishment delay</h2>
<p>Application protocols implemented based on TCP require three handshakes to be established before data can be transferred, such as HTTP 1.0/1.1, HTTP/2, and HTTPS.</p>
<p>Nowadays, most websites use HTTPS, which means that after the TCP three handshakes, four TLS handshakes are required before HTTP data transmission can take place, which increases the latency of data transmission to some extent.</p>
<p>TCP three handshake and TLS handshake latency, as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/8c9a2ef616754ec582c87628168eba3e.png" alt="TCP three handshake and TLS handshake latency"></p>
<p>The TCP triple handshake delay is solved by the TCP Fast Open feature, which reduces the TCP connection establishment delay during the &ldquo;second connection establishment&rdquo;.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/8d5489d35b6d493b8c978b0818aa49d1.png" alt="Regular HTTP requests and Fast Open HTTP requests"></p>
<p>The process is as follows.</p>
<ul>
<li>
<p>In the first connection establishment, the server generates a <code>Cookie</code> (encrypted) in the second handshake and sends it to the client together with SYN and ACK packets, so the client will cache this <code>Cookie</code>, so the first time it initiates an HTTP Get request, it still requires a delay of 2 RTT.</p>
</li>
<li>
<p>In the next request, the client sends <code>Cookie</code> to the server with the SYN packet, so that the three handshakes can be skipped in advance, because some information is maintained in <code>Cookie</code>, and the server can obtain TCP-related information from <code>Cookie</code>, and the HTTP GET request initiated at that time only needs 1 RTT of latency.</p>
</li>
</ul>
<p>TCP Fast Open is a good feature, but it requires both the server and client operating systems to support it in order to experience it, and TCP Fast Open was proposed in 2013, so there are still many old operating systems on the market that do not support it, and upgrading the operating system is very troublesome, so it is difficult for TCP Fast Open to be popularized.</p>
<p>Another point is that for HTTPS, TLS is the handshake implemented at the application layer, while TCP is the handshake implemented at the kernel, and these two handshakes cannot be combined together.</p>
<p>It is also true that TCP is implemented in the kernel, so TLS cannot encrypt TCP headers, which means that TCP sequence numbers are transmitted in clear text, so there is a security problem.</p>
<p>A typical example is when an attacker forges an RST message to force a TCP connection to close, and the key to a successful attack is that the sequence number in the TCP field is within the sliding window of the receiver and the message is legitimate.</p>
<p>For this reason TCP also has to perform three handshakes to synchronize the respective sequence numbers, and the sequence numbers are initialized in a random way (not completely random, but linearly increasing with the passage of time, and then rolled back at the end of 2^32) to make it more difficult for the attacker to guess the sequence numbers to increase security.</p>
<p>But this approach can only avoid the attacker to predict the legitimate RST message, but not the attacker to intercept the client&rsquo;s message, and then forge the legitimate RST message in the middle of the attack way.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/01005979d04648bd8afa5ffc5408ea96.png" alt="RST"></p>
<p>If TCP sequence numbers could be encrypted, there might not really be a need for three handshakes. The initial sequence numbers of both the client and the server start from 0, so there is no need to do the work of synchronizing sequence numbers, but to implement this, the whole protocol stack has to be modified, which is too much trouble, and even if it is implemented, many old network devices may not be compatible.</p>
<h2 id="tcp-has-a-queue-head-blocking-problem">TCP has a queue head blocking problem</h2>
<p>TCP is a byte stream protocol, <strong>TCP layer must ensure that the received byte data is complete and ordered</strong> , if the TCP segment with lower sequence number is lost in network transmission, the application layer cannot read this part of data from the kernel even if the TCP segment with higher sequence number has been received. As shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/50f0d5cb987447feb0d4b90bd0661578.png" alt="tcp"></p>
<p>In the figure, the sender sends many packets, each packet has its own serial number, which you can think of as the TCP sequence number, where <code>packet #3</code> is lost in the network, even if <code>packet #4-6</code> is received by the receiver, because the TCP data in the kernel is not continuous, so the receiver&rsquo;s application layer cannot read it from the kernel, and only Only after <code>packet #3</code> is retransmitted can the receiver&rsquo;s application layer read the data from the kernel.</p>
<p>This is the TCP queue head blocking problem, but you can&rsquo;t blame TCP for this because it&rsquo;s the only way to keep the data in order.</p>
<p>HTTP/2 multiple requests are running in one TCP connection, so when TCP loses packets, the whole TCP has to wait for retransmission, then it blocks all requests in that TCP connection, so the HTTP/2 queue head blocking problem is caused by the TCP protocol.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/cf82959186064676bd7f34c4643158f0.png" alt="tcp"></p>
<h2 id="network-migration-requires-re-establishing-tcp-connections">Network migration requires re-establishing TCP connections</h2>
<p>HTTP protocol based on TCP transport protocol, as a TCP connection is determined by a quadruplet (source IP, source port, destination IP, destination port).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/05/15/75255692bc144faa99a019fe13f61b17.png" alt="quadruplet"></p>
<p>Then <strong>when the mobile device&rsquo;s network switches from 4G to WIFI, which means the IP address changes, then it has to disconnect and re-establish the TCP connection</strong>.</p>
<p>The process of establishing the connection includes the time delay of TCP triple handshake and TLS quadruple handshake, as well as the deceleration process of TCP slow start, which gives the user the impression that the network suddenly lags for a while, so the migration cost of the connection is high.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/tcp/">tcp</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/k8s-health-checks/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">K8S Best Practices - Health Check</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/nvidia-open-source-gpu-kernel-modules/">
            <span class="next-text nav-default">NVIDIA officially open-sources its Linux GPU kernel module</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
