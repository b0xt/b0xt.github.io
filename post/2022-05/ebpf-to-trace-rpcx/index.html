<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Tracking rpcx microservices with ebpf - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use ebpf to track rpcx microservices." /><meta name="keywords" content="Emacs" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/ebpf-to-trace-rpcx/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Tracking rpcx microservices with ebpf" />
<meta property="og:description" content="Learn how to use ebpf to track rpcx microservices." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/ebpf-to-trace-rpcx/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-23T13:08:14+08:00" />
<meta property="article:modified_time" content="2022-05-23T13:08:14+08:00" />

<meta itemprop="name" content="Tracking rpcx microservices with ebpf">
<meta itemprop="description" content="Learn how to use ebpf to track rpcx microservices."><meta itemprop="datePublished" content="2022-05-23T13:08:14+08:00" />
<meta itemprop="dateModified" content="2022-05-23T13:08:14+08:00" />
<meta itemprop="wordCount" content="2330">
<meta itemprop="keywords" content="Ebpf," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tracking rpcx microservices with ebpf"/>
<meta name="twitter:description" content="Learn how to use ebpf to track rpcx microservices."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/ukraine/">
        <li class="mobile-menu-item">UKRAINE</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/ukraine/">UKRAINE</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Tracking rpcx microservices with ebpf</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-23 13:08:14 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2330 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#simple-rpcx-microservice-program">Simple rpcx microservice program</a></li>
        <li><a href="#tracing-and-analyzing-microservices">Tracing and analyzing microservices</a>
          <ul>
            <li><a href="#bcc-package">bcc package</a></li>
            <li><a href="#bpftrace">bpftrace</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://ebpf.io/zh-cn/">ebpf</a> is an innovative and revolutionary technology that enables sandboxed programs to be run in the kernel without modifying the kernel source code or loading kernel modules. By making the Linux kernel programmable, it is possible to build smarter, more feature-rich infrastructure software based on existing (rather than adding new) abstraction layers, without increasing system complexity or sacrificing execution efficiency or security.</p>
<p>The first version of BPF was introduced in 1994. We actually use it when writing rules using the tcpdump tool, which is used to view or &ldquo;sniff&rdquo; network packets.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/23/bc69901889734c42accd7372687f268d.png" alt="BPF"></p>
<p>Using ebpf technology, you can provide new ideas and techniques in the direction of security, trace &amp; performance analysis, networking, observation &amp; monitoring, etc.</p>
<ul>
<li>Security: You can check security from system call level, packet level, socket level, such as developing DDOS protection system and writing firewall programs.</li>
<li>Network: You can develop kernel layer high performance packet handler, such as Cilium to provide kernel layer load balancing, and push service mesh to deeper layer to solve sidecar performance problems.</li>
<li>Trace &amp; Performance Analysis: Linux provides many types of probe points, such as Kernel probes, perf events, Tracepoints, User-space probes, User statically defined tracepoints, XDP and so on. We can write probe programs to collect information about these probe points, so we can track programs and analyze performance in this way.</li>
<li>Observation &amp; Monitoring: With continuous observation and monitoring of these probe points, we can enrich our trace program. The key is that we do not need to change the established programs, but observe them from other programs through the ebpf method. 2014, Alexei Starovoitov, a famous kernel hacker, extended the functionality of BPF. He increased the number of registers and the allowed size of the program, added JIT compilation, and created a program for checking if the program is safe. Most impressively, however, the new BPF program was able to run not only while processing packets, but also to respond to other kernel events and pass information back and forth between kernel and user space. alexei Starovoitov&rsquo;s new version of BPF was called eBPF (e stands for extended: extended). But now that it has replaced all older versions of BPF usage and has become so popular, it is still referred to as BPF for simplicity&rsquo;s sake.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/23/21dc03bbe6b74b46845c9125b7979b9e.png" alt="BPF"></p>
<p>You can write your own bpf programs for custom logic processing and analysis, or you can use tools written by the greats and use them for generic performance analysis and tracing of your programs. This article is about using some tools to do generic analysis of rpcx microservices programs, since they are generic, you can can analyze other Go programs, and not only limited to Go programs, other applications and even kernels you can analyze and trace.</p>
<p>For how to write bpf programs I am going to introduce it in a new article.</p>
<p>This time it will focus on <a href="https://github.com/iovisor/bcc">bcc provides related tools</a> and <a href="https://github.com/iovisor/bpftrace">bpftrace</a>.</p>
<p>bcc is a toolkit for creating efficient eBPF-based kernel tracing and manipulation programs, including some useful command line tools and examples. BCC simplifies the writing of eBPF programs for kernel detection in C, including wrappers for LLVM and front-ends for Python and Lua. It also provides high-level libraries for direct integration into applications.</p>
<p>bpftrace is a high-level trace language for Linux eBPF. Its language is inspired by awk and C as well as by previous tracing programs such as DTrace and SystemTap. bpftrace uses LLVM as a backend to compile scripts into eBPF bytecode and uses BCC as a library to interact with the Linux eBPF subsystem as well as existing Linux tracing features and connection points.</p>
<h2 id="simple-rpcx-microservice-program">Simple rpcx microservice program</h2>
<p>Since we are going to use the ebpf analysis program, first we need to have a program. Here I have chosen <a href="https://github.com/smallnest/rpcx">rpcx</a> a simplest example to implement a minimal microservice for multiplication.</p>
<p>The code of this program can be downloaded at <a href="https://github.com/rpcxio/rpcx-examples/tree/master/102basic">rpcx-examples-102basic</a>.</p>
<p>The server-side program is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">example</span> <span class="s">&#34;github.com/rpcxio/rpcx-examples&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/rpcx/server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;localhost:8972&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Arith</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 使用ebpf跟踪这个服务调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Arith</span><span class="p">)</span> <span class="nf">Mul</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">args</span> <span class="nx">example</span><span class="p">.</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">example</span><span class="p">.</span><span class="nx">Reply</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">C</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span> <span class="o">*</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;C=&#34;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nf">RegisterName</span><span class="p">(</span><span class="s">&#34;Arith&#34;</span><span class="p">,</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Arith</span><span class="p">),</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Use <code>go build server.go</code> to compile the <code>server</code> program and run it (<code>. /server</code>).</p>
<p>The client application is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/rpcx/protocol&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">example</span> <span class="s">&#34;github.com/rpcxio/rpcx-examples&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/smallnest/rpcx/client&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;localhost:8972&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">d</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewPeer2PeerDiscovery</span><span class="p">(</span><span class="s">&#34;tcp@&#34;</span><span class="o">+*</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">DefaultOption</span>
</span></span><span class="line"><span class="cl">    <span class="nx">opt</span><span class="p">.</span><span class="nx">SerializeType</span> <span class="p">=</span> <span class="nx">protocol</span><span class="p">.</span><span class="nx">JSON</span>
</span></span><span class="line"><span class="cl">    <span class="nx">xclient</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewXClient</span><span class="p">(</span><span class="s">&#34;Arith&#34;</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Failtry</span><span class="p">,</span> <span class="nx">client</span><span class="p">.</span><span class="nx">RandomSelect</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">xclient</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span> <span class="o">:=</span> <span class="nx">example</span><span class="p">.</span><span class="nx">Args</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">A</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">B</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">reply</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">example</span><span class="p">.</span><span class="nx">Reply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">xclient</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;Mul&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to call: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d * %d = %d&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">C</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The client calls the <code>Arith.Mul</code> microservice once every second, and the logic of the microservice is simple: it performs multiplication and returns the result to the client.</p>
<h2 id="tracing-and-analyzing-microservices">Tracing and analyzing microservices</h2>
<p>As a demo, this article only tracks server-side <code>Arith.Mul</code> calls.</p>
<p>bcc provides a number of bpf-based analyzers, as follows (classic diagram put together by Brendan Gregg)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/23/94f134299880484eb94db37d50af8067.png" alt="bpf-based analyzers">
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/23/33ff312dcf7243b2b6b2b2d3271c83f1.png" alt="bpf-based analyzers"></p>
<p>Here we will select a few relevant tools to demonstrate how to use these tools to analyze running programs. Note that it is a running program and we have not added some additional trace points to the program.</p>
<h3 id="bcc-package">bcc package</h3>
<p>First you have to install the bcc suite, and your Linux kernel has to be new enough. In some big houses, there are still some kernel versions of 2.6.x servers, and these old kernel servers cannot support ebpf or the new features of ebpf.</p>
<p>I tested this on one of my virtual machines in AliCloud, which is of version:</p>
<ul>
<li>Linux lab 4.18.0-348.2.1.el8_5.x86_64</li>
<li>CentOS Stream release 8</li>
</ul>
<p>Installing these tools is done directly with <code>yum install bcc-tools</code>.</p>
<p>If you are on a different version of the operating system, you can install them by referring to the bcc installation documentation: <a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md">bcc/INSTALL</a>.</p>
<p>Before using the tools for analysis, you first need to know the name of your microservice <code>Arith.Mul</code> in the symbol table, which you can query using objdump.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># objdump -t server|grep Mul|grep main</span>
</span></span><span class="line"><span class="cl">000000000075a5e0 g     F .text  00000000000000d0              main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span></code></pre></td></tr></table>
</div>
</div><p>Its name is <code>main.(*Arith).Mul</code> , and we will use this name to analyze the microservice below.</p>
<p>Make sure that the server you just created is always running.</p>
<h4 id="funccount">funccount</h4>
<p>funccount is used to count the number of times a function has been called over time.</p>
<p>Execute the following command in the directory where the server is located (if it is in a different path, you need to change the path of the program in the command parameter):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># funccount -d 10  &#39;./server:main.*.Mul&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="m">1</span> functions <span class="k">for</span> <span class="s2">&#34;b&#39;./server:main.*.Mul&#39;&#34;</span>... Hit Ctrl-C to end.
</span></span><span class="line"><span class="cl">FUNC                                    COUNT
</span></span><span class="line"><span class="cl">b<span class="s1">&#39;main.(*Arith).Mul&#39;</span>                       <span class="m">10</span>
</span></span><span class="line"><span class="cl">Detaching...
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1">#</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we set the observation time to 10 seconds, and we can see that this function is called 10 times during these 10 seconds.</p>
<p>It contains several parameters, for example, you can keep observing and output the result every 5 seconds:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># funccount -Ti 5  &#39;./server:main.*.Mul&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="m">1</span> functions <span class="k">for</span> <span class="s2">&#34;b&#39;./server:main.*.Mul&#39;&#34;</span>... Hit Ctrl-C to end.
</span></span><span class="line"><span class="cl">18:08:29
</span></span><span class="line"><span class="cl">FUNC                                    COUNT
</span></span><span class="line"><span class="cl">b<span class="s1">&#39;main.(*Arith).Mul&#39;</span>                        <span class="m">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can even use it for Go GC related function tracing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># funccount -d 10  &#39;./server:runtime.*.gc*&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="m">21</span> functions <span class="k">for</span> <span class="s2">&#34;b&#39;./server:runtime.*.gc*&#39;&#34;</span>... Hit Ctrl-C to end.
</span></span><span class="line"><span class="cl">FUNC                                    COUNT
</span></span><span class="line"><span class="cl">b<span class="s1">&#39;runtime.(*gcControllerState).update&#39;</span>        <span class="m">2</span>
</span></span><span class="line"><span class="cl">b<span class="s1">&#39;runtime.mallocgc&#39;</span>                       <span class="m">250</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Or track Go runtime scheduling.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># funccount -d 10  &#39;./server:runtime.schedule&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="m">1</span> functions <span class="k">for</span> <span class="s2">&#34;b&#39;./server:runtime.schedule&#39;&#34;</span>... Hit Ctrl-C to end.
</span></span><span class="line"><span class="cl">FUNC                                    COUNT
</span></span><span class="line"><span class="cl">b<span class="s1">&#39;runtime.schedule&#39;</span>                        <span class="m">20</span>
</span></span><span class="line"><span class="cl">Detaching...
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="funclatency">funclatency</h4>
<p>funclatency counts the time taken by the execution of a function.
If we want to analyze the execution of the <code>Arith.Mul</code> method, we can use the following command, which will show the distribution of the time spent on this function call in the form of a histogram.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># funclatency -d 10  &#39;./server:main.*.Mul&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="m">1</span> functions <span class="k">for</span> <span class="s2">&#34;./server:main.*.Mul&#34;</span>... Hit Ctrl-C to end.
</span></span><span class="line"><span class="cl"><span class="nv">Function</span> <span class="o">=</span> b<span class="s1">&#39;main.(*Arith).Mul&#39;</span> <span class="o">[</span>359284<span class="o">]</span>
</span></span><span class="line"><span class="cl">     nsecs               : count     distribution
</span></span><span class="line"><span class="cl">         <span class="m">0</span> -&gt; <span class="m">1</span>          : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">         <span class="m">2</span> -&gt; <span class="m">3</span>          : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">         <span class="m">4</span> -&gt; <span class="m">7</span>          : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">         <span class="m">8</span> -&gt; <span class="m">15</span>         : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">        <span class="m">16</span> -&gt; <span class="m">31</span>         : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">        <span class="m">32</span> -&gt; <span class="m">63</span>         : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">        <span class="m">64</span> -&gt; <span class="m">127</span>        : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">       <span class="m">128</span> -&gt; <span class="m">255</span>        : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">       <span class="m">256</span> -&gt; <span class="m">511</span>        : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">       <span class="m">512</span> -&gt; <span class="m">1023</span>       : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="m">1024</span> -&gt; <span class="m">2047</span>       : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="m">2048</span> -&gt; <span class="m">4095</span>       : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="m">4096</span> -&gt; <span class="m">8191</span>       : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">      <span class="m">8192</span> -&gt; <span class="m">16383</span>      : <span class="m">0</span>        <span class="p">|</span>                                        <span class="p">|</span>
</span></span><span class="line"><span class="cl">     <span class="m">16384</span> -&gt; <span class="m">32767</span>      : <span class="m">7</span>        <span class="p">|</span>****************************************<span class="p">|</span>
</span></span><span class="line"><span class="cl">     <span class="m">32768</span> -&gt; <span class="m">65535</span>      : <span class="m">3</span>        <span class="p">|</span>*****************                       <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="nv">avg</span> <span class="o">=</span> <span class="m">31978</span> nsecs, total: <span class="m">319783</span> nsecs, count: <span class="m">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We counted 10 seconds of data. You can see that this function was called 10 times during this period. The average time taken is 31 microseconds.</p>
<p>If we want to check if there is a long tail in the online program, it is easy to analyze the statistics using this tool.</p>
<h4 id="funcslower">funcslower</h4>
<p>funcslower This tool can trace functions that execute slowly in the kernel and in the program, for example using the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># funcslower -u 10  &#39;./server:main.(*Arith).Mul&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="k">function</span> calls slower than <span class="m">10</span> us... Ctrl+C to quit.
</span></span><span class="line"><span class="cl">COMM           PID    LAT<span class="o">(</span>us<span class="o">)</span>             RVAL FUNC
</span></span><span class="line"><span class="cl">server         <span class="m">359284</span>   44.75                <span class="m">0</span> ./server:main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span><span class="line"><span class="cl">server         <span class="m">359284</span>   30.97                <span class="m">0</span> ./server:main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span><span class="line"><span class="cl">server         <span class="m">359284</span>   33.38                <span class="m">0</span> ./server:main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span><span class="line"><span class="cl">server         <span class="m">359284</span>   31.28                <span class="m">0</span> ./server:main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can even print out the stack information:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span>funcslower -UK -u <span class="m">10</span>  <span class="s1">&#39;./server:main.(*Arith).Mul&#39;</span>
</span></span><span class="line"><span class="cl">Tracing <span class="k">function</span> calls slower than <span class="m">10</span> us... Ctrl+C to quit.
</span></span><span class="line"><span class="cl">COMM           PID    LAT<span class="o">(</span>us<span class="o">)</span>             RVAL FUNC
</span></span><span class="line"><span class="cl">server         <span class="m">359284</span>   31.20                <span class="m">0</span> ./server:main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;runtime.call64.abi0&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;runtime.reflectcall&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;reflect.Value.call&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;reflect.Value.Call&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;github.com/smallnest/rpcx/server.(*service).call&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;github.com/smallnest/rpcx/server.(*Server).handleRequest&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;github.com/smallnest/rpcx/server.(*Server).serveConn.func2&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;runtime.goexit.abi0&#39;</span>
</span></span><span class="line"><span class="cl">server         <span class="m">359284</span>   32.23                <span class="m">0</span> ./server:main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;runtime.call64.abi0&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;runtime.reflectcall&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;reflect.Value.call&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;reflect.Value.Call&#39;</span>
</span></span><span class="line"><span class="cl">    b<span class="s1">&#39;github.com/smallnest/rpcx/server.(*service).call&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="tcp-series-tools">tcp series tools</h4>
<p>bcc provides a bunch of tools for tcp tracing, we can use them for different scenarios.</p>
<ul>
<li>tools/tcpaccept: Tracks TCP passive connections (accept()).</li>
<li>tools/tcpconnect: Traces TCP active connections (connect()).</li>
<li>tools/tcpconnlat: Tracks TCP active connection latency (connect()).</li>
<li>tools/tcpdrop: Tracks TCP packet drop details for kernel.</li>
<li>tools/tcplife: Tracks TCP session (lifecycle metrics summary).</li>
<li>tools/tcpretrans: Tracks TCP retransmissions.</li>
<li>tools/tcprtt: Tracks TCP round-trip elapsed time.</li>
<li>tools/tcpstates: Tracks TCP session state changes.</li>
<li>tools/tcpsubnet: Summarize and aggregate TCP transmissions by subnet.</li>
<li>tools/tcpsynbl: Displays TCP SYN backlog.</li>
<li>tools/tcptop: Aggregates TCP send/recv throughput by host.</li>
<li>tools/tcptracer: Tracks TCP connection creation/closure (connect(), accept(), close()).</li>
<li>tools/tcpcong: Tracks the duration of TCP socket congestion control state.</li>
</ul>
<p>For example, if we are concerned about connection establishment, we can use <code>tcptracer</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab lib<span class="o">]</span><span class="c1"># tcptracer</span>
</span></span><span class="line"><span class="cl">Tracing TCP established connections. Ctrl-C to end.
</span></span><span class="line"><span class="cl">T  PID    COMM             IP SADDR            DADDR            SPORT  DPORT
</span></span><span class="line"><span class="cl">C  <span class="m">360005</span> client           <span class="m">4</span>  127.0.0.1        127.0.0.1        <span class="m">43126</span>  <span class="m">8972</span>
</span></span><span class="line"><span class="cl">X  <span class="m">360005</span> client           <span class="m">6</span>  <span class="o">[</span>::1<span class="o">]</span>            <span class="o">[</span>::1<span class="o">]</span>            <span class="m">43010</span>  <span class="m">8972</span>
</span></span><span class="line"><span class="cl">A  <span class="m">359284</span> server           <span class="m">4</span>  127.0.0.1        127.0.0.1        <span class="m">8972</span>   <span class="m">43126</span>
</span></span><span class="line"><span class="cl">X  <span class="m">360005</span> client           <span class="m">4</span>  127.0.0.1        127.0.0.1        <span class="m">43126</span>  <span class="m">8972</span>
</span></span><span class="line"><span class="cl">X  <span class="m">359284</span> server           <span class="m">4</span>  127.0.0.1        127.0.0.1        <span class="m">8972</span>   <span class="m">43126</span>
</span></span><span class="line"><span class="cl">C  <span class="m">360009</span> client           <span class="m">4</span>  127.0.0.1        127.0.0.1        <span class="m">43130</span>  <span class="m">8972</span>
</span></span><span class="line"><span class="cl">X  <span class="m">360009</span> client           <span class="m">6</span>  <span class="o">[</span>::1<span class="o">]</span>            <span class="o">[</span>::1<span class="o">]</span>            <span class="m">43014</span>  <span class="m">8972</span>
</span></span><span class="line"><span class="cl">A  <span class="m">359284</span> server           <span class="m">4</span>  127.0.0.1        127.0.0.1        <span class="m">8972</span>   <span class="m">43130</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are also a bunch of <code>xxxxsnoop</code> programs that can be traced for specific system calls.</p>
<h3 id="bpftrace">bpftrace</h3>
<p>Sometimes we want to implement some custom tracing using scripts, for example tools like awk that provide simple scripting.</p>
<p>One such tool is bpftrace, which uses LLVM as the backend to compile scripts into eBPF bytecode and uses BCC as a library to interact with the Linux eBPF subsystem as well as existing Linux trace functions and connection points.</p>
<p>The bpftrace reference manual can be found at <a href="https://github.com/iovisor/bpftrace/blob/master/docs/reference_guide.md#20-override-override-return-value">bpftrace reference_guide</a>.</p>
<p>Using our <code>Arith.Mul</code> as an example, we can use the following command to add a probe to the function call to print out the input parameters.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># bpftrace -e &#39;uprobe:./server:main.*.Mul {printf(&#34;%s - %s: arg1: %d, arg2: %d\n&#34;, comm, func, arg0, arg1)}&#39;</span>
</span></span><span class="line"><span class="cl">Attaching <span class="m">1</span> probe...
</span></span><span class="line"><span class="cl">server - main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul: arg1: 10, arg2: <span class="m">20</span>
</span></span><span class="line"><span class="cl">server - main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul: arg1: 10, arg2: <span class="m">20</span>
</span></span><span class="line"><span class="cl">server - main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul: arg1: 10, arg2: <span class="m">20</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Why does arg0,arg1 just print out the parameters? Simply put, our microservice arguments are exactly two int64 integers, which correspond exactly to arg0,arg1.</p>
<p>The service return value of rpcx is also passed in as an argument and has not been set when the function is called, so if you print arg3 is not a REPLY return value.</p>
<p>At this point we need to move the probe and add an offset, how much of an offset do we add? By disassembling we see that the return value has been assigned when adding 92, so use the following command to print the return value (this time the first argument is overwritten).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@lab server<span class="o">]</span><span class="c1"># bpftrace -e &#39;uprobe:./server:main.*.Mul+92 {printf(&#34;%s - %s: reply: %d\n&#34;, comm, func, arg0)}&#39;</span>
</span></span><span class="line"><span class="cl">Attaching <span class="m">1</span> probe...
</span></span><span class="line"><span class="cl">server - main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul: reply: <span class="m">200</span>
</span></span><span class="line"><span class="cl">server - main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul: reply: <span class="m">200</span>
</span></span><span class="line"><span class="cl">server - main.<span class="o">(</span>*Arith<span class="o">)</span>.Mul: reply: <span class="m">200</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Go has changed to a register-based calling convention since 1.17, so here we use the built-in arg0, arg1,&hellip; , if you are using an earlier version of Go, here you can switch to sarg0,sarg1,&hellip; Try (stack arguments).</p>
</blockquote>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/ebpf/">Ebpf</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/benchmark-comparative-analysis-tool/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Benchmark Comparative Analysis Tool</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/esbuild/">
            <span class="next-text nav-default">Use the ESBuild plug-in mechanism to implement the required functionality</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
