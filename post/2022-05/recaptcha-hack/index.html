<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Cracking ReCAPTCHA by simulated clicks - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use YesCaptcha &#43; Selenium to crack ReCAPTCHA." /><meta name="keywords" content="ReCAPTCHA, Cracking, Selenium, YesCaptcha" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-05/recaptcha-hack/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Cracking ReCAPTCHA by simulated clicks" />
<meta property="og:description" content="Learn how to use YesCaptcha &#43; Selenium to crack ReCAPTCHA." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-05/recaptcha-hack/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-27T13:13:36+08:00" />
<meta property="article:modified_time" content="2022-05-27T13:13:36+08:00" />

<meta itemprop="name" content="Cracking ReCAPTCHA by simulated clicks">
<meta itemprop="description" content="Learn how to use YesCaptcha &#43; Selenium to crack ReCAPTCHA."><meta itemprop="datePublished" content="2022-05-27T13:13:36+08:00" />
<meta itemprop="dateModified" content="2022-05-27T13:13:36+08:00" />
<meta itemprop="wordCount" content="3020">
<meta itemprop="keywords" content="ReCAPTCHA," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cracking ReCAPTCHA by simulated clicks"/>
<meta name="twitter:description" content="Learn how to use YesCaptcha &#43; Selenium to crack ReCAPTCHA."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Cracking ReCAPTCHA by simulated clicks</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-27 13:13:36 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3020 words </span>
          <span class="more-meta"> 15 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#recaptcha-introduction">ReCAPTCHA Introduction</a></li>
        <li><a href="#overall-identification-ideas">Overall identification ideas</a></li>
        <li><a href="#yescaptcha">YesCaptcha</a></li>
        <li><a href="#code-base-implementation">Code base implementation</a>
          <ul>
            <li><a href="#wrapping">Wrapping</a></li>
            <li><a href="#basic-framework">Basic framework</a></li>
            <li><a href="#iframe-toggle-support">iframe toggle support</a></li>
            <li><a href="#trigger-captcha">Trigger CAPTCHA</a></li>
            <li><a href="#find-the-recognition-target">Find the recognition target</a></li>
            <li><a href="#captcha-recognition">Captcha recognition</a></li>
            <li><a href="#base64-encoding">Base64 encoding</a></li>
            <li><a href="#question-id-handling">Question ID handling</a></li>
            <li><a href="#simulating-a-click">Simulating a click</a></li>
            <li><a href="#small-picture-recognition">Small picture recognition</a></li>
            <li><a href="#click-to-verify">Click to verify</a></li>
            <li><a href="#verify-the-result">Verify the result</a></li>
          </ul>
        </li>
        <li><a href="#code">Code</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Previously, I <a href="/post/2021-08/cracking-recaptcha/">shared</a> the cracking scheme of ReCAPTCHA, which is to get one of the siteKey of ReCAPTCHA, and then submit the siteKey directly to the cracking service related to ReCAPTCHA to achieve cracking.</p>
<p>This time, we will introduce a more flexible and powerful full simulated click cracking scheme, the overall idea is to identify all the CAPTCHA images and simulate a click on the ReCAPTCHA CAPTCHA based on the identification result, so as to finally pass the CAPTCHA.</p>
<h2 id="recaptcha-introduction">ReCAPTCHA Introduction</h2>
<p>The CAPTCHA is something like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/46f20236eaab45ed802805869a270822.png" alt="ReCAPTCHA"></p>
<p>We need to click on the small box on the CAPTCHA at this point to trigger the verification, which normally presents the following point-and-click image.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/9066f9d0c4164403a68e1dfba093fab3.png" alt="ReCAPTCHA"></p>
<p>For example, in the picture above, nine images will appear on the verification code page, and the text &ldquo;tree&rdquo; will appear at the top, we need to click the image that appears &ldquo;tree&rdquo; in the nine images below, after we finish clicking, several new images may appear, we need to finish clicking again, and finally click the &ldquo;verify&rdquo; button to complete the verification.</p>
<p>ReCAPTCHA also has an experience address, you can open <a href="https://www.google.com/recaptcha/api2/demo">https://www.google.com/recaptcha/api2/demo</a> to see, after opening, we can find the content as shown above, and then click on the picture for recognition.</p>
<h2 id="overall-identification-ideas">Overall identification ideas</h2>
<p>In fact, we see that this kind of CAPTCHA is actually mainly about clicking on some squares, we just need to click on some corresponding positions correctly, and finally we will be able to verify through.</p>
<p>After observation, we found that it is mainly the 3x3 and 4x4 grid CAPTCHA, for example, the 3x3 one is like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/f2bf63703a45413784bbe0051b4c89ab.png" alt="ReCAPTCHA"></p>
<p>The CAPTCHA for 4X4 looks like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/198de4b6af2a4f0383ab7fdd9c06296a.png" alt="ReCAPTCHA"></p>
<p>Then there is a line of bolded text above the CAPTCHA, which is the target of our point selection.</p>
<p>So, here comes the key point.</p>
<ul>
<li>The first is to find out the content of the text above, so that we know what to click on.</li>
<li>The second is that we need to know which target images and the text above is a match, and find out in order to simulate a click on it.</li>
</ul>
<p>It sounds very simple, but the second point is a difficult one, how do we know which images match the text? This is more trouble.</p>
<p>In fact, this can be done by deep learning, but to come up with such a model is not easy, we need a lot of data to train, need to collect a lot of CAPTCHA images and labeling results, the total workload is very large.</p>
<p>So what to do? Here we introduce a service website YesCaptcha, which has already done a good job of recognition service for us. All we need to do is to submit a large image of the CAPTCHA and tell the service what we need to recognize, and the service will return the corresponding recognition results.</p>
<p>Let&rsquo;s try the recognition process with YesCaptcha.</p>
<h2 id="yescaptcha">YesCaptcha</h2>
<p>Before using the site we need to register first, the website address is <a href="https://yescaptcha.com/auth/register">https://yescaptcha.com/auth/register</a>, after registering an account you can get an account key in the background, that is, ClientKey, save the backup.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/e8ac2d38a6eb431b9f324f958fba380e.png" alt="YesCaptcha"></p>
<p>OK, then we can check out the official documentation here: <a href="https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/18055169/ReCaptchaV2Classification+reCaptcha+V2">https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/18055169/ReCaptchaV2Classification+reCaptcha+V2</a>.</p>
<p>Here is a description of the API, the general content is this.</p>
<p>First there is an API for creating tasks, the API address is <a href="https://api.yescaptcha.com/createTask">https://api.yescaptcha.com/createTask</a>, and then look at the request parameters.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/6803b007f0174275879e374ff772996c.png" alt="YesCaptcha"></p>
<p>Here we need to pass in these parameters:</p>
<ul>
<li>type: the content is ReCaptchaV2Classification</li>
<li>image: is the corresponding Base64 encoding of the verification code</li>
<li>question: the corresponding question ID, that is, the identification of the target code.</li>
</ul>
<p>For example, here we can POST such a content to the server, the structure is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;clientKey&#34;</span><span class="p">:</span> <span class="s2">&#34;cc9c18d3e263515c2c072b36a7125eecc078618f&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;task&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;ReCaptchaV2Classification&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDc....&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;question&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/0k4j&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>where the image can be a 3x3 or 4x4 string encoded in Base64 corresponding to the captcha screenshot.</p>
<p>The server will then return a response like this.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;errorId&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;errorCode&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;errorDescription&#34;</span><span class="p">:</span> <span class="s2">&#34;null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;ready&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;taskId&#34;</span><span class="p">:</span> <span class="s2">&#34;3a9e8cb8-3871-11ec-9794-94e6f7355a0b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;solution&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;objects&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="c1">// Location of the image to be clicked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;multi&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OK, we can see that the objects field in the solution field of the returned result contains some code names, for example, here is <code>1, 5, 8</code>, what does it mean? This is the corresponding target click code.</p>
<p>For a 3x3 image, the corresponding code would look like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/b7a2c35b2ed54db683b7a22a70f3ba02.png" alt="captcha"></p>
<p>For a 4x4 image, the corresponding code would be something like</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/cc08a2734c824ea988a531a94c52941c.png" alt="captcha"></p>
<p>OK, after knowing the code name, it is much better to simulate the click, we can do it with some simulated click operations.</p>
<h2 id="code-base-implementation">Code base implementation</h2>
<p>Okay, so with the basic idea in mind, let&rsquo;s start implementing the whole process in Python. Here we&rsquo;ll take the <a href="https://www.google.com/recaptcha/api2/demo">https://www.google.com/recaptcha/api2/demo</a> website as a sample to explain the whole process of identifying and simulating clicks.</p>
<h3 id="wrapping">Wrapping</h3>
<p>First we implement a wrapper around the above task API, and write a class to start with.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app.settings</span> <span class="kn">import</span> <span class="n">CAPTCHA_RESOLVER_API_KEY</span><span class="p">,</span> <span class="n">CAPTCHA_RESOLVER_API_URL</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CaptchaResolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_url</span><span class="o">=</span><span class="n">CAPTCHA_RESOLVER_API_URL</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">CAPTCHA_RESOLVER_API_KEY</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span> <span class="o">=</span> <span class="n">api_url</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_base64_string</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;start to recognize image for question </span><span class="si">{</span><span class="n">question_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;clientKey&#34;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;task&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;ReCaptchaV2Classification&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;image&#34;</span><span class="p">:</span> <span class="n">image_base64_string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;question&#34;</span><span class="p">:</span> <span class="n">question_id</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;captcha recogize result </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;error occurred while recognizing captcha&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OK, here we define a class CaptchaResolver, and then mainly receive two parameters, one is <code>api_url</code>, which corresponds to the <a href="https://api.yescaptcha.com/createTask">https://api.yescaptcha.com/createTask</a> API address, and then there is another parameter is <code>api_key</code>, which is the ClientKey introduced in the previous article.</p>
<p>Then we define a create_task method that receives two parameters, the first parameter <code>image_base64_string</code> is the corresponding Base64 encoding of the captcha image, the second parameter <code>question_id</code> is to identify what the target is, here is the entire request with requests simulation is achieved. Finally return the corresponding JSON content of the response results on the good.</p>
<h3 id="basic-framework">Basic framework</h3>
<p>OK, so let&rsquo;s use Selenium to simulate opening this example site, then simulate tapping to trigger the CAPTCHA, and then recognize the CAPTCHA.</p>
<p>First write a general framework.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.support.wait</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.remote.webelement</span> <span class="kn">import</span> <span class="n">WebElement</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.common.action_chains</span> <span class="kn">import</span> <span class="n">ActionChains</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app.captcha_resolver</span> <span class="kn">import</span> <span class="n">CaptchaResolver</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Solution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">WebDriverWait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">captcha_resolver</span> <span class="o">=</span> <span class="n">CaptchaResolver</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we first initialize a Chrome operation object in the constructor, then call the corresponding get method to open the example website, and then declare a WebDriverWait object and a CaptchaResolver object to handle node lookup and captcha recognition operations, respectively, as a backup.</p>
<h3 id="iframe-toggle-support">iframe toggle support</h3>
<p>Next, we&rsquo;ll simulate clicking on the CAPTCHA portal to trigger the CAPTCHA, right?</p>
<p>By observation, we find that the captcha entry is actually loaded in an iframe, and the corresponding iframe looks like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/1d7019dc56a04f2bbbb5e4fdcd878822.png" alt="ReCaptcha"></p>
<p>In addition, the pop-up captcha image is inside another iframe, as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/8e966000508d409b9b86d370e02d9586.png" alt="ReCaptcha"></p>
<p>Selenium needs to switch to the corresponding iframe to find the node, otherwise it will not be able to find the corresponding node and simulate a click or something.</p>
<p>So here we define several tool methods to support switching to the corresponding iframe of the portal and the corresponding iframe of the CAPTCHA itself, with the following code.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_captcha_entry_iframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebElement</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">switch_to</span><span class="o">.</span><span class="n">default_content</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_entry_iframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;iframe[title=&#34;reCAPTCHA&#34;]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">captcha_entry_iframe</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">switch_to_captcha_entry_iframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_entry_iframe</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_captcha_entry_iframe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">switch_to</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">captcha_entry_iframe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_captcha_content_iframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebElement</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">switch_to</span><span class="o">.</span><span class="n">default_content</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_content_iframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;//iframe[contains(@title, &#34;recaptcha challenge&#34;)]&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">captcha_content_iframe</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">switch_to_captcha_content_iframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_content_iframe</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_captcha_content_iframe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">browser</span><span class="o">.</span><span class="n">switch_to</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">captcha_content_iframe</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this case, we only need to call switch_to_captcha_content_iframe to find the content inside the captcha image and switch_to_captcha_entry_iframe to find the content inside the captcha entry.</p>
<h3 id="trigger-captcha">Trigger CAPTCHA</h3>
<p>OK, so the next step is to simulate a click on the captcha entry and then trigger the captcha, right, by simulating a click here.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/5a7edca8afab47e7a250c0fd93776c11.png" alt="ReCaptcha"></p>
<p>The implementation is simple and the code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">trigger_captcha</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">switch_to_captcha_entry_iframe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s1">&#39;recaptcha-anchor&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_entry</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">switch_to_captcha_content_iframe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">entire_captcha_element</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entire_captcha_element</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">entire_captcha_element</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;trigged captcha successfully&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we first call switch_to_captcha_entry_iframe to switch the iframe, then find the node corresponding to the entry box and click on it.</p>
<p>After clicking on it, we call switch_to_captcha_content_iframe to switch to the iframe corresponding to the captcha itself and find out if the node corresponding to the captcha itself has been loaded, and if it has, then it proves that the trigger is successful.</p>
<h3 id="find-the-recognition-target">Find the recognition target</h3>
<p>OK, so now the captcha might look like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/538e8516f37846a79db0fc36f861ad7a.png" alt="captcha"></p>
<p>The next thing we need to do is two things, one is to find the matching target, which is the bolded font in the image above, and the second thing is to save the captcha and convert it to Base64 encoding and submit it to CaptchaResolver for recognition.</p>
<p>Okay, so how do we find the matching target? That is, the traffice lights in the figure above, using Selenium&rsquo;s regular node search.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_captcha_target_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebElement</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">captcha_target_name_element</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s1">&#39;.rc-imageselect-desc-wrapper strong&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">captcha_target_name_element</span><span class="o">.</span><span class="n">text</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>By calling this method, we can get something like traffic lights in the above image.</p>
<h3 id="captcha-recognition">Captcha recognition</h3>
<p>Next, let&rsquo;s download the captcha image and convert it to Base64 for recognition, the overall code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify_entire_captcha</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">entire_captcha_natural_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entire_captcha_natural_width</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s1">&#39;entire_captcha_natural_width </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">entire_captcha_natural_width</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">captcha_target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_captcha_target_name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s1">&#39;captcha_target_name </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">captcha_target_name</span><span class="si">}</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">entire_captcha_element</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entire_captcha_element</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">entire_captcha_url</span> <span class="o">=</span> <span class="n">entire_captcha_element</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;td img&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;entire_captcha_url </span><span class="si">{</span><span class="n">entire_captcha_url</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CAPTCHA_ENTIRE_IMAGE_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entire_captcha_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s1">&#39;saved entire captcha to </span><span class="si">{</span><span class="n">CAPTCHA_ENTIRE_IMAGE_FILE_PATH</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resized_entire_captcha_base64_string</span> <span class="o">=</span> <span class="n">resize_base64_image</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">CAPTCHA_ENTIRE_IMAGE_FILE_PATH</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entire_captcha_natural_width</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="bp">self</span><span class="o">.</span><span class="n">entire_captcha_natural_width</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s1">&#39;resized_entire_captcha_base64_string, </span><span class="si">{</span><span class="n">resized_entire_captcha_base64_string</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">entire_captcha_recognize_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captcha_resolver</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">resized_entire_captcha_base64_string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">get_question_id_by_target_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">captcha_target_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we first get some basic information about the captcha:</p>
<ul>
<li>entire_captcha_natural_width: the real size of the image corresponding to the captcha image, here if it is a 3x3 captcha image, then the real size of the image is 300, if it is a 4x4 captcha image, then the real size of the image is 450</li>
<li>captcha_target_name: the name of the recognition target, that is, the content just obtained</li>
<li>entire_captcha_element: the node object corresponding to the captcha image.</li>
</ul>
<p>Here we first get the img node inside the entire_captcha_element, and then get the src content of the img and assign it to the entire_captcha_url, so we actually get a large image of the complete captcha, and then we write it to the file.</p>
<p>The result is something like this.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/b7ba5759c88b4556bc44a49803e3f742.png" alt="captcha"></p>
<p>Then we just send this image to YesCaptcha for recognition.</p>
<h3 id="base64-encoding">Base64 encoding</h3>
<p>Next, we convert this image to Base64 encoding. Define the following method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">resize_base64_image</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">size</span>
</span></span><span class="line"><span class="cl">    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">CAPTCHA_RESIZED_IMAGE_FILE_PATH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CAPTCHA_RESIZED_IMAGE_FILE_PATH</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoded_string</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">encoded_string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here it is worth noting that since the API has a limit on the image size, if it is a 3x3 image, then we need to resize the image to 300x300, and if it is a 4x4 image, then we need to resize the image to 450x450, so here we first call the Image&rsquo;s resize method to resize it, and then convert it to Base64 encoding.</p>
<h3 id="question-id-handling">Question ID handling</h3>
<p>How is the question ID handled? Through the API documentation <a href="https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/18055169">https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/18055169</a> we can see the following mapping table.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/f073ae8bdf4e4c4cb8bed034be206603.png" alt="mapping table"></p>
<p>So, for example, if we get traffic lights in the captcha, then the question ID is /m/015qff, okay, so let&rsquo;s just reverse the lookup. Define the following method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">CAPTCHA_TARGET_NAME_QUESTION_ID_MAPPING</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;taxis&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/0pg52&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;bus&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/01bjv&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;school bus&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/02yvhj&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;motorcycles&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/04_sv&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;tractors&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/013xlm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;chimneys&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/01jk_4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;crosswalks&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/014xcs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;traffic lights&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/015qff&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;bicycles&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/0199g&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;parking meters&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/015qbp&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;cars&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/0k4j&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;vehicles&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/0k4j&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;bridges&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/015kr&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;boats&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/019jd&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;palm trees&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/0cdl1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;mountains or hills&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/09d_r&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fire hydrant&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/01pns0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fire hydrants&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/01pns0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;a fire hydrant&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/01pns0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;stairs&#34;</span><span class="p">:</span> <span class="s2">&#34;/m/01lynh&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_question_id_by_target_name</span><span class="p">(</span><span class="n">target_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;try to get question id by </span><span class="si">{</span><span class="n">target_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">question_id</span> <span class="o">=</span> <span class="n">CAPTCHA_TARGET_NAME_QUESTION_ID_MAPPING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;question_id </span><span class="si">{</span><span class="n">question_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">question_id</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>By passing in the name, we can get the issue ID.</p>
<p>Finally, we can call the create_task method of the CaptchaResovler object directly with the above parameters to get the result.</p>
<h3 id="simulating-a-click">Simulating a click</h3>
<p>After we get the results, we know that the objects that return the results are the list of CAPTCHA cells that need to be clicked, so we can simulate the click by doing the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">single_captcha_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">visibility_of_all_elements_located</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s1">&#39;#rc-imageselect-target table td&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">recognized_index</span> <span class="ow">in</span> <span class="n">recognized_indices</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">single_captcha_element</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="n">single_captcha_elements</span><span class="p">[</span><span class="n">recognized_index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">single_captcha_element</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># check if need verify single captcha</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">verify_single_captcha</span><span class="p">(</span><span class="n">recognized_index</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we first get the recognized_indices, which are the markers corresponding to the recognition results, and then iterate through them one by one to simulate the click.</p>
<p>For each click, we can directly get all the nodes corresponding to the CAPTCHA grid, and then call its click method to complete the click, where the correspondence between the grid&rsquo;s label and the returned result is shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/1699fb9f81be475baaac5129f77e933b.png" alt="recaptcha"></p>
<blockquote>
<p>Of course, we can also simulate a click on each node by executing JavaScript, and the effect is similar.</p>
</blockquote>
<p>This way we can achieve the recognition of CAPTCHA small images one by one.</p>
<h3 id="small-picture-recognition">Small picture recognition</h3>
<p>Wait, one more problem we found during the recognition process is that sometimes after we click on a small grid, the small grid disappears! Then a new small image appears in the place of the original small grid, and we need to recognize the newly appeared image again to do so.</p>
<p>How can this be handled?</p>
<p>In fact, we can check whether the current grid has a picture refresh after each click, if there is a picture refresh, then the class of the corresponding HTML will change, otherwise it will contain the word selected, and then we can continue to identify the corresponding picture of the grid for the second time.</p>
<p>Here we define one more method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">verify_single_captcha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">visibility_of_all_elements_located</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s1">&#39;#rc-imageselect-target table td&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">single_captcha_element</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">class_name</span> <span class="o">=</span> <span class="n">single_captcha_element</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;verifiying single captcha </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">, class </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;selected&#39;</span> <span class="ow">in</span> <span class="n">class_name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no new single captcha displayed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new single captcha displayed&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">single_captcha_url</span> <span class="o">=</span> <span class="n">single_captcha_element</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;img&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;single_captcha_url </span><span class="si">{</span><span class="n">single_captcha_url</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CAPTCHA_SINGLE_IMAGE_FILE_PATH</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">single_captcha_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resized_single_captcha_base64_string</span> <span class="o">=</span> <span class="n">resize_base64_image</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">CAPTCHA_SINGLE_IMAGE_FILE_PATH</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">single_captcha_recognize_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captcha_resolver</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">resized_single_captcha_base64_string</span><span class="p">,</span> <span class="n">get_question_id_by_target_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">captcha_target_name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">single_captcha_recognize_result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;count not get single captcha recognize result&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">has_object</span> <span class="o">=</span> <span class="n">single_captcha_recognize_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;solution&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hasObject&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;count not get captcha recognized indices&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_object</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no more object in this single captcha&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">single_captcha_element</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># check for new single captcha</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">verify_single_captcha</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>OK, here we define a verify_single_captcha method and pass in the serial number of the lattice. Then we first try to find the node corresponding to the grid, and then find the class attribute of the corresponding HTML. If no new vignette appears, then this is the selected state, and the corresponding class contains the word selected, as shown in the figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/97313a5b95584079879d0722419481fe.png" alt="ReCaptcha"></p>
<p>For such images, we do not need to do secondary validation, otherwise we need to take a screenshot of the grid and do secondary recognition.</p>
<p>The steps of secondary recognition are the same, we need to get the url of the image corresponding to the small grid separately, then download it, then resize it and convert it to Base64 encoding, then send it to the API, which will tell us whether the small image contains the target content we want to recognize by a hasObject field, if yes, then click on it, then recursively Next check, if not, then skip.</p>
<h3 id="click-to-verify">Click to verify</h3>
<p>Okay, so with the above logic, we can complete the entire ReCAPTCHA recognition and point-and-click.</p>
<p>Finally, we simulate clicking the validation button and we&rsquo;re done.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_verify_button</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebElement</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">verify_button</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s1">&#39;#recaptcha-verify-button&#39;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">verify_button</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="c1"># after all captcha clicked</span>
</span></span><span class="line"><span class="cl"><span class="n">verify_button</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_verify_button</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">verify_button</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">verify_button</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="verify-the-result">Verify the result</h3>
<p>After clicking on it, we can try to check the page changes to see if the validation was successful.</p>
<p>For example, the sign of successful validation is the appearance of a small green check mark.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/05/27/b256ff12d59d4ffa88fd062f3c66f340.png" alt="ReCaptcha Verify Success"></p>
<p>The inspection method is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_is_successful</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">switch_to_captcha_entry_iframe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">anchor</span><span class="p">:</span> <span class="n">WebElement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">EC</span><span class="o">.</span><span class="n">visibility_of_element_located</span><span class="p">((</span>
</span></span><span class="line"><span class="cl">        <span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s1">&#39;recaptcha-anchor&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="n">checked</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;aria-checked&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;checked </span><span class="si">{</span><span class="n">checked</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we switch the iframe first, and then check if the corresponding class is what we expect.</p>
<p>Finally, if the result of get_is_successful is True, then it means the recognition is successful, and the whole process is finished.</p>
<p>If the result is False, we can recursively call the above logic for a second time until the recognition is successful.</p>
<h2 id="code">Code</h2>
<p>The above code may be complicated, so I&rsquo;ve organized the code here and put it on GitHub, so you can pick it up if you need it: <a href="https://github.com/Python3WebSpider/RecaptchaResolver">https://github.com/Python3WebSpider/RecaptchaResolver</a></p>
<blockquote>
<p>Finally, I need to explain that the above verification code service is charged, and each verification may cost a certain number of points, for example, it costs 10 points to recognize a 3x3 figure, while you can get 1000 points for a dollar. So it&rsquo;s a penny for one verification, which is still relatively cheap.</p>
</blockquote>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/recaptcha/">ReCAPTCHA</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-05/systemd-timer/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Configuring timed tasks with systemd timer</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-05/containerd-runtime/">
            <span class="next-text nav-default">Detailed profiling of the container runtime</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
