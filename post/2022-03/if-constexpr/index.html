<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Conditional compilation using if constexpr  - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In project development, we usually use conditional compilation to trim code and selectively exclude code that is not needed, for example, if a feature is not supported at all under a certain platform, then that feature should not be compiled. Generally we use macros to determine the code, selectively pick the parts that need to be compiled, and turn on such conditions in the build system. 1 2 3 4" /><meta name="keywords" content="c&#43;&#43;, If constexpr, Conditional compilation" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/if-constexpr/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Conditional compilation using if constexpr " />
<meta property="og:description" content="In project development, we usually use conditional compilation to trim code and selectively exclude code that is not needed, for example, if a feature is not supported at all under a certain platform, then that feature should not be compiled. Generally we use macros to determine the code, selectively pick the parts that need to be compiled, and turn on such conditions in the build system. 1 2 3 4" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/if-constexpr/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-19T18:30:32+08:00" />
<meta property="article:modified_time" content="2022-03-19T18:30:32+08:00" />

<meta itemprop="name" content="Conditional compilation using if constexpr ">
<meta itemprop="description" content="In project development, we usually use conditional compilation to trim code and selectively exclude code that is not needed, for example, if a feature is not supported at all under a certain platform, then that feature should not be compiled. Generally we use macros to determine the code, selectively pick the parts that need to be compiled, and turn on such conditions in the build system. 1 2 3 4"><meta itemprop="datePublished" content="2022-03-19T18:30:32+08:00" />
<meta itemprop="dateModified" content="2022-03-19T18:30:32+08:00" />
<meta itemprop="wordCount" content="1401">
<meta itemprop="keywords" content="c&#43;&#43;," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Conditional compilation using if constexpr "/>
<meta name="twitter:description" content="In project development, we usually use conditional compilation to trim code and selectively exclude code that is not needed, for example, if a feature is not supported at all under a certain platform, then that feature should not be compiled. Generally we use macros to determine the code, selectively pick the parts that need to be compiled, and turn on such conditions in the build system. 1 2 3 4"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Conditional compilation using if constexpr </h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-19 18:30:32 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1401 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>In project development, we usually use conditional compilation to trim code and selectively exclude code that is not needed, for example, if a feature is not supported at all under a certain platform, then that feature should not be compiled.</p>
<p>Generally we use macros to determine the code, selectively pick the parts that need to be compiled, and turn on such conditions in the build system.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#ifdef XXXXXXXXXX
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;hello world!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;good bye!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Such behavior is normal in C projects, and even in C++ projects, we choose to use macros for conditional judgments.</p>
<p>However, if more macros are defined, it is easy to fragment the code and not visualize the workflow.</p>
<p>For example, code like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define KWIN_VERSION_CHECK(major, minor, patch, build) ((major&lt;&lt;24)|(minor&lt;&lt;16)|(patch&lt;&lt;8)|build)
</span></span></span><span class="line"><span class="cl"><span class="cp">#ifdef KWIN_VERSION_STR
</span></span></span><span class="line"><span class="cl"><span class="cp">#define KWIN_VERSION KWIN_VERSION_CHECK(KWIN_VERSION_MAJ, KWIN_VERSION_MIN, KWIN_VERSION_PAT, KWIN_VERSION_BUI)
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(KWIN_VERSION) &amp;&amp; KWIN_VERSION &lt; KWIN_VERSION_CHECK(5, 21, 3, 0)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="kt">int</span> <span class="n">TimeArgType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">TimeArgType</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(Q_OS_LINUX) &amp;&amp; !defined(QT_NO_DYNAMIC_LIBRARY) &amp;&amp; !defined(QT_NO_LIBRARY)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">QT_BEGIN_NAMESPACE</span>
</span></span><span class="line"><span class="cl"><span class="n">QFunctionPointer</span> <span class="nf">qt_linux_find_symbol_sys</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">QT_END_NAMESPACE</span>
</span></span><span class="line"><span class="cl"><span class="n">QFunctionPointer</span> <span class="n">KWinUtils</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">QT_PREPEND_NAMESPACE</span><span class="p">(</span><span class="n">qt_linux_find_symbol_sys</span><span class="p">)(</span><span class="n">symbol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">QFunctionPointer</span> <span class="n">KWinUtils</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">symbol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="n">QString</span> <span class="n">lib_name</span> <span class="o">=</span> <span class="s">&#34;kwin.so.&#34;</span> <span class="o">+</span> <span class="n">qApp</span><span class="o">-&gt;</span><span class="n">applicationVersion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">QLibrary</span><span class="o">::</span><span class="n">resolve</span><span class="p">(</span><span class="n">lib_name</span><span class="p">,</span> <span class="n">symbol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see from the above example, once there are a lot of repeated judgment conditions in the code, the code is very unintuitive and split into many parts by macros.</p>
<p>By chance, I saw an article introducing the use of if constexpr in C++ 17, which can perform some calculations during the compilation period. Although I knew about the use of constexpr a long time ago, the examples people gave were basically numerical calculations, allowing the compiler to calculate the values during compilation, thus reducing the runtime consumption, and I never thought of other uses I never thought of other uses for constexpr, so I never used it in my project.</p>
<p>If the code is small and very intuitive, such as the example often given to calculate the Fibonacci sequence during compilation, the compiler will help us open the optimization and give the result directly, even if we don&rsquo;t use constexpr to explicitly require it.</p>
<p>But if the code is very complex, the compiler may not do this optimization for us, and we need to manually mark where we can compute and ask the compiler to evaluate and optimize during compilation.</p>
<p>What I envision is to use cmake to make a file of the switch values at build time, and then use if constexpr to make conditional judgments where they are needed, and during compilation, the compiler will find a branch that is determined not to be executed (equivalent to <code>if(false) {}</code>), and then that branch will not be compiled and The branch will not be compiled and will be rejected.</p>
<p>Some work needs to be done in CMakeLists.txt to add the compilation parameters to the build system.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">option</span> <span class="p">(</span><span class="n">ENABLE_MODULE</span> <span class="s">&#34;Enable Module&#34;</span> <span class="n">ON</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">ENABLE_MODULE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span><span class="p">(</span><span class="n">ENABLE_MODULE</span> <span class="s">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span><span class="p">(</span><span class="n">ENABLE_MODULE</span> <span class="s">&#34;0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span><span class="p">(</span><span class="n">ENABLE_MODULE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">configure_file</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;${CMAKE_CURRENT_SOURCE_DIR}/options/options.h.in&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;${CMAKE_CURRENT_BINARY_DIR}/options/options.h&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the options/options.h.in file, import the variables into the file as required by cmake, and replace the contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#cmakedefine01 ENABLE_MODULE
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Here I am still using macro definitions, which can also be written directly in the following form.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">option</span> <span class="p">(</span><span class="n">ENABLE_MODULE</span> <span class="s">&#34;Enable Module&#34;</span> <span class="n">ON</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">ENABLE_MODULE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span><span class="p">(</span><span class="n">ENABLE_MODULE</span> <span class="s">&#34;true&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">set</span><span class="p">(</span><span class="n">ENABLE_MODULE</span> <span class="s">&#34;false&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span><span class="p">(</span><span class="n">ENABLE_MODULE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">configure_file</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;${CMAKE_CURRENT_SOURCE_DIR}/options/options.h.in&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;${CMAKE_CURRENT_BINARY_DIR}/options/options.h&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">bool</span> <span class="n">ENABLE_MODULE</span><span class="p">{</span><span class="err">@</span><span class="n">ENABLE_MODULE</span><span class="err">@</span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Write a test code in main.cpp:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;options/options.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="n">ENABLE_MODULE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Now Enable Module&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="o">!</span><span class="n">ENABLE_MODULE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Now Disable Module&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The implementation results are as expected.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># lxz @ lxz-MacBook-Pro in ~/Develop/constexpr-demo/build on git:master o [13:28:39]</span>
</span></span><span class="line"><span class="cl">$ cmake ../ -G Ninja -DENABLE_MODULE<span class="o">=</span>ON
</span></span><span class="line"><span class="cl">-- The CXX compiler identification is AppleClang 13.0.0.13000029
</span></span><span class="line"><span class="cl">-- Detecting CXX compiler ABI info
</span></span><span class="line"><span class="cl">-- Detecting CXX compiler ABI info - <span class="k">done</span>
</span></span><span class="line"><span class="cl">-- Check <span class="k">for</span> working CXX compiler: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/c++ - skipped
</span></span><span class="line"><span class="cl">-- Detecting CXX compile features
</span></span><span class="line"><span class="cl">-- Detecting CXX compile features - <span class="k">done</span>
</span></span><span class="line"><span class="cl">-- Configuring <span class="k">done</span>
</span></span><span class="line"><span class="cl">-- Generating <span class="k">done</span>
</span></span><span class="line"><span class="cl">-- Build files have been written to: /Users/lxz/Develop/constexpr-demo/build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lxz @ lxz-MacBook-Pro in ~/Develop/constexpr-demo/build on git:master o [13:28:45]</span>
</span></span><span class="line"><span class="cl">$ ninja
</span></span><span class="line"><span class="cl"><span class="o">[</span>2/2<span class="o">]</span> Linking CXX executable src/constexpr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lxz @ lxz-MacBook-Pro in ~/Develop/constexpr-demo/build on git:master o [13:28:48]</span>
</span></span><span class="line"><span class="cl">$ ./src/constexpr
</span></span><span class="line"><span class="cl">Now Enable Module
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lxz @ lxz-MacBook-Pro in ~/Develop/constexpr-demo/build on git:master o [13:28:52]</span>
</span></span><span class="line"><span class="cl">$ cmake ../ -G Ninja -DENABLE_MODULE<span class="o">=</span>OFF
</span></span><span class="line"><span class="cl">-- Configuring <span class="k">done</span>
</span></span><span class="line"><span class="cl">-- Generating <span class="k">done</span>
</span></span><span class="line"><span class="cl">-- Build files have been written to: /Users/lxz/Develop/constexpr-demo/build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lxz @ lxz-MacBook-Pro in ~/Develop/constexpr-demo/build on git:master o [13:28:58]</span>
</span></span><span class="line"><span class="cl">$ ninja
</span></span><span class="line"><span class="cl"><span class="o">[</span>2/2<span class="o">]</span> Linking CXX executable src/constexpr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># lxz @ lxz-MacBook-Pro in ~/Develop/constexpr-demo/build on git:master o [13:29:00]</span>
</span></span><span class="line"><span class="cl">$ ./src/constexpr
</span></span><span class="line"><span class="cl">Now Disable Module
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although the result matches, we are actually not sure if the code culling is actually done during compilation, so we use the command to do an assembly to see if the assembly contains a judgment instruction and two output strings.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">clang -S main.cpp -o main.s -I./
</span></span></code></pre></td></tr></table>
</div>
</div><p>main.s</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">	.text
</span></span><span class="line"><span class="cl">	.file	&#34;main.cpp&#34;
</span></span><span class="line"><span class="cl">	.globl	main                            // -- Begin function main
</span></span><span class="line"><span class="cl">	.p2align	2
</span></span><span class="line"><span class="cl">	.type	main,@function
</span></span><span class="line"><span class="cl">main:                                   // @main
</span></span><span class="line"><span class="cl">	.cfi_startproc
</span></span><span class="line"><span class="cl">// %bb.0:
</span></span><span class="line"><span class="cl">	stp	x29, x30, [sp, #-32]!           // 16-byte Folded Spill
</span></span><span class="line"><span class="cl">	str	x19, [sp, #16]                  // 8-byte Folded Spill
</span></span><span class="line"><span class="cl">	mov	x29, sp
</span></span><span class="line"><span class="cl">	.cfi_def_cfa w29, 32
</span></span><span class="line"><span class="cl">	.cfi_offset w19, -16
</span></span><span class="line"><span class="cl">	.cfi_offset w30, -24
</span></span><span class="line"><span class="cl">	.cfi_offset w29, -32
</span></span><span class="line"><span class="cl">	adrp	x19, :got:_ZSt4cout
</span></span><span class="line"><span class="cl">	ldr	x19, [x19, :got_lo12:_ZSt4cout]
</span></span><span class="line"><span class="cl">	adrp	x1, .L.str
</span></span><span class="line"><span class="cl">	add	x1, x1, :lo12:.L.str
</span></span><span class="line"><span class="cl">	mov	w2, #18
</span></span><span class="line"><span class="cl">	mov	x0, x19
</span></span><span class="line"><span class="cl">	bl	_ZSt16__ostream_insertIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_PKS3_l
</span></span><span class="line"><span class="cl">	ldr	x8, [x19]
</span></span><span class="line"><span class="cl">	ldur	x8, [x8, #-24]
</span></span><span class="line"><span class="cl">	add	x8, x8, x19
</span></span><span class="line"><span class="cl">	ldr	x19, [x8, #240]
</span></span><span class="line"><span class="cl">	cbz	x19, .LBB0_5
</span></span><span class="line"><span class="cl">// %bb.1:
</span></span><span class="line"><span class="cl">	ldrb	w8, [x19, #56]
</span></span><span class="line"><span class="cl">	cbz	w8, .LBB0_3
</span></span><span class="line"><span class="cl">// %bb.2:
</span></span><span class="line"><span class="cl">	ldrb	w1, [x19, #67]
</span></span><span class="line"><span class="cl">	b	.LBB0_4
</span></span><span class="line"><span class="cl">.LBB0_3:
</span></span><span class="line"><span class="cl">	mov	x0, x19
</span></span><span class="line"><span class="cl">	bl	_ZNKSt5ctypeIcE13_M_widen_initEv
</span></span><span class="line"><span class="cl">	ldr	x8, [x19]
</span></span><span class="line"><span class="cl">	mov	w1, #10
</span></span><span class="line"><span class="cl">	mov	x0, x19
</span></span><span class="line"><span class="cl">	ldr	x8, [x8, #48]
</span></span><span class="line"><span class="cl">	blr	x8
</span></span><span class="line"><span class="cl">	mov	w1, w0
</span></span><span class="line"><span class="cl">.LBB0_4:
</span></span><span class="line"><span class="cl">	adrp	x0, :got:_ZSt4cout
</span></span><span class="line"><span class="cl">	ldr	x0, [x0, :got_lo12:_ZSt4cout]
</span></span><span class="line"><span class="cl">	bl	_ZNSo3putEc
</span></span><span class="line"><span class="cl">	bl	_ZNSo5flushEv
</span></span><span class="line"><span class="cl">	ldr	x19, [sp, #16]                  // 8-byte Folded Reload
</span></span><span class="line"><span class="cl">	mov	w0, wzr
</span></span><span class="line"><span class="cl">	ldp	x29, x30, [sp], #32             // 16-byte Folded Reload
</span></span><span class="line"><span class="cl">	ret
</span></span><span class="line"><span class="cl">.LBB0_5:
</span></span><span class="line"><span class="cl">	bl	_ZSt16__throw_bad_castv
</span></span><span class="line"><span class="cl">.Lfunc_end0:
</span></span><span class="line"><span class="cl">	.size	main, .Lfunc_end0-main
</span></span><span class="line"><span class="cl">	.cfi_endproc
</span></span><span class="line"><span class="cl">                                        // -- End function
</span></span><span class="line"><span class="cl">	.section	.text.startup,&#34;ax&#34;,@progbits
</span></span><span class="line"><span class="cl">	.p2align	2                               // -- Begin function _GLOBAL__sub_I_main.cpp
</span></span><span class="line"><span class="cl">	.type	_GLOBAL__sub_I_main.cpp,@function
</span></span><span class="line"><span class="cl">_GLOBAL__sub_I_main.cpp:                // @_GLOBAL__sub_I_main.cpp
</span></span><span class="line"><span class="cl">	.cfi_startproc
</span></span><span class="line"><span class="cl">// %bb.0:
</span></span><span class="line"><span class="cl">	stp	x29, x30, [sp, #-32]!           // 16-byte Folded Spill
</span></span><span class="line"><span class="cl">	str	x19, [sp, #16]                  // 8-byte Folded Spill
</span></span><span class="line"><span class="cl">	mov	x29, sp
</span></span><span class="line"><span class="cl">	.cfi_def_cfa w29, 32
</span></span><span class="line"><span class="cl">	.cfi_offset w19, -16
</span></span><span class="line"><span class="cl">	.cfi_offset w30, -24
</span></span><span class="line"><span class="cl">	.cfi_offset w29, -32
</span></span><span class="line"><span class="cl">	adrp	x19, _ZStL8__ioinit
</span></span><span class="line"><span class="cl">	add	x19, x19, :lo12:_ZStL8__ioinit
</span></span><span class="line"><span class="cl">	mov	x0, x19
</span></span><span class="line"><span class="cl">	bl	_ZNSt8ios_base4InitC1Ev
</span></span><span class="line"><span class="cl">	adrp	x0, :got:_ZNSt8ios_base4InitD1Ev
</span></span><span class="line"><span class="cl">	ldr	x0, [x0, :got_lo12:_ZNSt8ios_base4InitD1Ev]
</span></span><span class="line"><span class="cl">	mov	x1, x19
</span></span><span class="line"><span class="cl">	ldr	x19, [sp, #16]                  // 8-byte Folded Reload
</span></span><span class="line"><span class="cl">	adrp	x2, __dso_handle
</span></span><span class="line"><span class="cl">	add	x2, x2, :lo12:__dso_handle
</span></span><span class="line"><span class="cl">	ldp	x29, x30, [sp], #32             // 16-byte Folded Reload
</span></span><span class="line"><span class="cl">	b	__cxa_atexit
</span></span><span class="line"><span class="cl">.Lfunc_end1:
</span></span><span class="line"><span class="cl">	.size	_GLOBAL__sub_I_main.cpp, .Lfunc_end1-_GLOBAL__sub_I_main.cpp
</span></span><span class="line"><span class="cl">	.cfi_endproc
</span></span><span class="line"><span class="cl">                                        // -- End function
</span></span><span class="line"><span class="cl">	.type	_ZStL8__ioinit,@object          // @_ZStL8__ioinit
</span></span><span class="line"><span class="cl">	.local	_ZStL8__ioinit
</span></span><span class="line"><span class="cl">	.comm	_ZStL8__ioinit,1,1
</span></span><span class="line"><span class="cl">	.hidden	__dso_handle
</span></span><span class="line"><span class="cl">	.type	.L.str,@object                  // @.str
</span></span><span class="line"><span class="cl">	.section	.rodata.str1.1,&#34;aMS&#34;,@progbits,1
</span></span><span class="line"><span class="cl">.L.str:
</span></span><span class="line"><span class="cl">	.asciz	&#34;Now Disable Module&#34; // 关键在这里
</span></span><span class="line"><span class="cl">	.size	.L.str, 19
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	.section	.init_array,&#34;aw&#34;,@init_array
</span></span><span class="line"><span class="cl">	.p2align	3
</span></span><span class="line"><span class="cl">	.xword	_GLOBAL__sub_I_main.cpp
</span></span><span class="line"><span class="cl">	.ident	&#34;clang version 13.0.1&#34;
</span></span><span class="line"><span class="cl">	.section	&#34;.note.GNU-stack&#34;,&#34;&#34;,@progbits
</span></span><span class="line"><span class="cl">	.addrsig
</span></span><span class="line"><span class="cl">	.addrsig_sym _GLOBAL__sub_I_main.cpp
</span></span><span class="line"><span class="cl">	.addrsig_sym _ZStL8__ioinit
</span></span><span class="line"><span class="cl">	.addrsig_sym __dso_handle
</span></span><span class="line"><span class="cl">	.addrsig_sym _ZSt4cout
</span></span></code></pre></td></tr></table>
</div>
</div><p>Looking at the entire main.s assembly, we find that only the expected text string is present in the .L.str segment, and we can conclude that the code was done during compilation to reject it, which meets our requirements.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c&#43;&#43;/">c&#43;&#43;</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-03/vscode-file-bug/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">New VS Code bug: crazy creation of junk files &#43; automatic modification of user files</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/prometheus-nginx-proxy/">
            <span class="next-text nav-default">Prometheus Routing and Routing Configuration with Nginx Reverse Proxy</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
