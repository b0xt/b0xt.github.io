<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>PostgreSQL Foreign Data Wrappers Usage Explained - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn the basic concepts of PostgreSQL Foreign Data Wrappers and how to use postgres_fdw." /><meta name="keywords" content="PostgreSQL, Foreign Data Wrappers" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-03/postgresql-foreign-data-wrappers/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="PostgreSQL Foreign Data Wrappers Usage Explained" />
<meta property="og:description" content="Learn the basic concepts of PostgreSQL Foreign Data Wrappers and how to use postgres_fdw." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-03/postgresql-foreign-data-wrappers/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-31T17:13:35+08:00" />
<meta property="article:modified_time" content="2022-03-31T17:13:35+08:00" />

<meta itemprop="name" content="PostgreSQL Foreign Data Wrappers Usage Explained">
<meta itemprop="description" content="Learn the basic concepts of PostgreSQL Foreign Data Wrappers and how to use postgres_fdw."><meta itemprop="datePublished" content="2022-03-31T17:13:35+08:00" />
<meta itemprop="dateModified" content="2022-03-31T17:13:35+08:00" />
<meta itemprop="wordCount" content="2927">
<meta itemprop="keywords" content="PostgreSQL," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PostgreSQL Foreign Data Wrappers Usage Explained"/>
<meta name="twitter:description" content="Learn the basic concepts of PostgreSQL Foreign Data Wrappers and how to use postgres_fdw."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">PostgreSQL Foreign Data Wrappers Usage Explained</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-31 17:13:35 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2927 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#fdw-whats-the-point">FDW What&rsquo;s the point</a></li>
        <li><a href="#postgresql-fdw-development-overview">PostgreSQL FDW Development Overview</a></li>
        <li><a href="#using-postgres_fdw">Using postgres_fdw</a>
          <ul>
            <li><a href="#installing-the-postgres_fdw-extension">Installing the postgres_fdw extension</a></li>
            <li><a href="#creating-an-external-server">Creating an external server</a></li>
            <li><a href="#creating-a-user-mapping">Creating a User Mapping</a></li>
            <li><a href="#creating-an-external-table-or-importing-an-external-schema">Creating an External Table or Importing an External Schema</a></li>
          </ul>
        </li>
        <li><a href="#some-important-parameters-when-setting-up-postgres_fdw">Some important parameters when setting up postgres_fdw</a></li>
        <li><a href="#fdw-related-system-tables-and-functions">FDW related system tables and functions</a>
          <ul>
            <li><a href="#system-tables">system tables</a></li>
            <li><a href="#functions">Functions</a></li>
          </ul>
        </li>
        <li><a href="#fdw-transaction-management-and-performance-optimization">FDW Transaction Management and Performance Optimization</a>
          <ul>
            <li><a href="#transaction-management">Transaction Management</a></li>
            <li><a href="#performance-optimization">Performance Optimization</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>PostgreSQL Foreign Data Wrappers (hereinafter referred to as FDW) is a very useful feature in real database usage scenarios. PostgreSQL&rsquo;s FDW is similar to Oracle&rsquo;s dblink and DB2&rsquo;s Federation, which allows you to establish connections between local and external databases so that you can manipulate external data as if it were local data.</p>
<h2 id="fdw-whats-the-point">FDW What&rsquo;s the point</h2>
<ul>
<li>Data sharding uses FDW to distribute data across multiple databases to achieve data sharding (e.g. pg_shardman plug-in, which uses postgres_fdw and pg_pathman plug-ins to achieve data sharding).</li>
<li>Data synchronization uses FDW to establish a connection between local and external databases to synchronize external data to local at regular intervals.</li>
<li>Data Migration Use FDW to establish a connection between local database and external database to perform data migration.</li>
<li>ETL (Extract-Transform-Load) uses FDW to extract data from different types of databases into one data warehouse for easy and uniform access.</li>
</ul>
<h2 id="postgresql-fdw-development-overview">PostgreSQL FDW Development Overview</h2>
<p>In 2003, SQL/MED (SQL Management of External Data) was added to the SQL standard, which provides specifications for external data management. In 2011, PostgreSQL 9.1 was released to support external data reads, and in 2013, PostgreSQL 9.3 was released to support external data writes.</p>
<p>Currently, PostgreSQL (PostgreSQL 14 at the time of writing) provides several extensions to support operations on various types of external databases or files (e.g., postgres_fdw for connecting to external PostgreSQL databases, oracle_fdw for connecting to external Oracle databases, mysql _fdw supports connecting to external MySQL databases, jdbc_fdw supports connecting to external relational databases using the JDBC protocol, file_fdw supports connecting to external files of a specific format, etc.).</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2022/03/31/f27808bed8c64e50bd57a8ead868c833.png" alt="PostgreSQL FDW Development Overview"></p>
<p>This article focuses only on postgres_fdw, how the PostgreSQL database connects to the external PostgreSQL database and how it manages the external data.</p>
<h2 id="using-postgres_fdw">Using postgres_fdw</h2>
<p>To use postgres_fdw to access a remote database, there are several steps.</p>
<ul>
<li>Install the postgres_fdw extension</li>
<li>Create an external server</li>
<li>Create a user map</li>
<li>Create an external table or import an external schema</li>
</ul>
<p>This article uses a local PostgreSQL database to emulate both the remote and local databases. Before starting the formal steps, you need to do a little bit of preparation in advance.</p>
<ul>
<li>
<p>Check the PostgreSQL version</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="c1">--version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">psql</span><span class="w"> </span><span class="p">(</span><span class="n">PostgreSQL</span><span class="p">)</span><span class="w"> </span><span class="mi">14</span><span class="p">.</span><span class="mi">2</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Creating a user in a remote PostgreSQL database</p>
<p>Use superuser to execute the following statement in the remote PostgreSQL database to create a normal user <code>fdw_user</code> to be used later when the local database establishes an FDW connection.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">fdw_user</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">ENCRYPTED</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secret&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Create a table in a remote PostgreSQL database</p>
<p>Create the weather table <code>weather</code> for testing in the remote database, insert the test data, and grant the user <code>fdw_user</code> permission to add, delete, and check against the table.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">weather</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">city</span><span class="w">        </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span><span class="w"> </span><span class="c1">-- city name (城市名)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">temp_low</span><span class="w">    </span><span class="nb">int</span><span class="p">,</span><span class="w">  </span><span class="c1">-- low temperature (最低温度)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">temp_high</span><span class="w">   </span><span class="nb">int</span><span class="p">,</span><span class="w">  </span><span class="c1">-- high temperature (最高温度)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">prcp</span><span class="w">        </span><span class="nb">real</span><span class="p">,</span><span class="w"> </span><span class="c1">-- precipitation (降水量)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="nb">date</span><span class="w">        </span><span class="nb">date</span><span class="w">  </span><span class="c1">-- date (日期)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">weather</span><span class="w"> </span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Beijing&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2021-05-19&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="s1">&#39;Beijing&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2021-05-20&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="s1">&#39;Dalian&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2021-05-21&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="k">INSERT</span><span class="p">,</span><span class="k">UPDATE</span><span class="p">,</span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">weather</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">fdw_user</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Connect locally with user <code>fdw_user</code> to the remote database (this article is special in that it uses both local and remote databases, so the remote host is also localhost) and verify the authorized privileges.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">fdw_user</span><span class="w"> </span><span class="n">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">weather</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">city</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">temp_low</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">temp_high</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">prcp</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------+----------+-----------+------+------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Beijing</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">19</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Beijing</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">20</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">30</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Dalian</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">16</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">24</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">21</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Note: For a real remote database, you need to add a record to the pg_hba.conf configuration file of the remote database to firewall the access IP in order to establish a connection locally.</p>
</blockquote>
</li>
<li>
<p>Creating a user in the local PostgreSQL database</p>
<p>Use superuser to create the normal user <code>local_user</code> in the local PostgreSQL database by executing the following statement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">local_user</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">ENCRYPTED</span><span class="w"> </span><span class="n">PASSWORD</span><span class="w"> </span><span class="s1">&#39;secret&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>All the preparations are done, now you can start the formal steps in the local database using superuser.</p>
<h3 id="installing-the-postgres_fdw-extension">Installing the postgres_fdw extension</h3>
<p>Use the <code>CREATE EXTENSION</code> statement to install the <code>postgres_fdw</code> extension.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="n">postgres_fdw</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Grant access to <code>postgres_fdw</code> for user <code>local_user</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">postgres_fdw</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">local_user</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="creating-an-external-server">Creating an external server</h3>
<p>To create an external server using the <code>CREATE SERVER</code> statement, specify the host, port and database name of the remote database.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">postgres_fdw</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="k">host</span><span class="w"> </span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="s1">&#39;5432&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dbname</span><span class="w"> </span><span class="s1">&#39;postgres&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Grant access to the external server <code>foreign_server</code> for the user <code>local_user</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">local_user</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="creating-a-user-mapping">Creating a User Mapping</h3>
<p>Use the <code>CREATE USER MAPPING</code> statement to create a mapping of remote users to local users, you need to provide the user name and password of the remote user.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">MAPPING</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="n">local_user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="k">user</span><span class="w"> </span><span class="s1">&#39;fdw_user&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="s1">&#39;secret&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="creating-an-external-table-or-importing-an-external-schema">Creating an External Table or Importing an External Schema</h3>
<p>Use the <code>CREATE FOREIGN TABLE</code> statement to create a remote table. Note that the column types need to match the actual remote table and the column names should ideally be the same, otherwise you will need to specify the column names in the remote table separately for each column using the <code>column_name</code> parameter.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">city</span><span class="w">        </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">temp_low</span><span class="w">    </span><span class="nb">int</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">temp_high</span><span class="w">   </span><span class="nb">int</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">prcp</span><span class="w">        </span><span class="nb">real</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nb">date</span><span class="w">        </span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="k">schema_name</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="s1">&#39;weather&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In most cases, you can just use the <code>IMPORT FOREIGN SCHEMA</code> statement to directly import all the tables in the external schema into the local schema.</p>
<blockquote>
<p>Note: Since no user mapping is specified for super_user, the following statement needs to be executed with user <code>local_user</code>, otherwise it will report <code>ERROR: user mapping not found for &quot;super_user&quot;</code> error.</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 导入外部模式下的所有表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">IMPORT</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">public</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 导入外部模式下的指定表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">IMPORT</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="p">(</span><span class="n">weather</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">public</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Authorize CRUD permissions for all tables (including external tables) in public mode for <code>local_user</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="k">INSERT</span><span class="p">,</span><span class="k">UPDATE</span><span class="p">,</span><span class="k">DELETE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">local_user</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This allows you to use the user <code>local_user</code> to connect to the local database and operate on external tables.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">local_user</span><span class="w"> </span><span class="n">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">foreign_weather</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">city</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">temp_low</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">temp_high</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">prcp</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------+----------+-----------+------+------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">Beijing</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">19</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Beijing</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">20</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">30</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">20</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Dalian</span><span class="w">  </span><span class="o">|</span><span class="w">       </span><span class="mi">16</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">24</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">21</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">prcp</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">city</span><span class="o">=</span><span class="s1">&#39;Beijing&#39;</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="nb">date</span><span class="o">=</span><span class="s1">&#39;2021-05-19&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, we have basically mastered the use of <code>postgres_fdw</code>. Next, we will look at the system tables and functions related to FDW, and finally look at FDW transaction management and performance optimization to get a deeper understanding of FDW.</p>
<h2 id="some-important-parameters-when-setting-up-postgres_fdw">Some important parameters when setting up postgres_fdw</h2>
<ul>
<li>
<p>updatable</p>
<p>This option sets whether the external table can be updated, i.e. whether postgres_fdw allows external tables to be modified using the <code>INSERT</code>, <code>UPDATE</code> and <code>DELETE</code> commands, the default is <code>true</code>. It can be specified on an external table or on an external server, and the one specified on the table will override the one specified on the server. The specific statements to set or update this parameter are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 创建外部服务器时指定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">postgres_fdw</span><span class="w"> </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(...,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 创建外部表时指定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="k">schema_name</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更新外部服务器参数选项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ALTER</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="n">updatable</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更新外部表参数选项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="k">OPTIONS</span><span class="p">(</span><span class="n">updatable</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Of course, if the remote table is not actually updatable, then an error will occur anyway. Using this option mainly allows to throw errors locally without having to query the remote server.</p>
</li>
<li>
<p>truncatable</p>
<p>This option sets whether external tables can be truncated, i.e. whether postgres_fdw allows external tables to be truncated using the <code>TRUNCATE</code> command, the default is <code>true</code>. This parameter can also be specified on the external table or on the external server, and specifying it on the table will override specifying it on the server.</p>
<p>The specific statements to set or update this parameter are exactly the same as <code>updatable</code> above.</p>
<p>Of course, if the remote table is not actually truncable, then an error will occur anyway. Again, the main point of using this option is that it allows errors to be thrown locally without having to query the remote server.</p>
</li>
<li>
<p>keep_connections</p>
<p>This option sets whether postgres_fdw will keep connections to the remote server in the local session for reuse, the default is <code>on</code> (if set to <code>off</code>, all connections to the external server will be dropped at the end of each transaction). It can only be specified on external servers. The specific statements to set or update this parameter are as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 创建外部服务器时指定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">WRAPPER</span><span class="w"> </span><span class="n">postgres_fdw</span><span class="w"> </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(...,</span><span class="w"> </span><span class="n">keep_connections</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更新外部服务器参数选项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">ALTER</span><span class="w"> </span><span class="n">SERVER</span><span class="w"> </span><span class="n">foreign_server</span><span class="w"> </span><span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span><span class="n">keep_connections</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="fdw-related-system-tables-and-functions">FDW related system tables and functions</h2>
<h3 id="system-tables">system tables</h3>
<p>FDW-related system tables are as follows (for the <code>_pg_*</code> table, only super_user has access to it)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">information_schema</span><span class="p">.</span><span class="n">_pg_foreign_data_wrappers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">_pg_foreign_servers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">_pg_foreign_tables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">_pg_foreign_table_columns</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">_pg_user_mappings</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">foreign_data_wrappers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">foreign_data_wrapper_options</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">foreign_server_options</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">foreign_servers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">foreign_tables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">information_schema</span><span class="p">.</span><span class="n">foreign_table_options</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="functions">Functions</h3>
<ul>
<li>
<p>postgres_fdw_get_connections()</p>
<p>Calling this function returns the external server name of all open connections established by postgres_fdw from the local session to the external server and whether the connection is valid.</p>
<blockquote>
<p>Note: This function gets the current connection status of the local session to the external server, not the connection status of the local database to the external server. Therefore, remote table queries made by opening a separate Shell Tab will not be recorded by the current local session.</p>
</blockquote>
<p>This article uses the default option (<code>on</code>) for the <code>keep_connections</code> parameter when creating the external server, so the connection is kept.</p>
<p>As you can see below <code>psql</code> connects to the local database and after doing an external table query, the query <code>postgres_fdw_get_connections()</code> function will return a row.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">local_user</span><span class="w"> </span><span class="n">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">foreign_weather</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">postgres_fdw_get_connections</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">server_name</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">valid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------------+-------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">foreign_server</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>postgres_fdw_disconnect(server_name text)</p>
<p>Disconnects all connections from postgres_fdw from the local session (local session) to the given external server, based on the name passed in.</p>
<p>There can be multiple connections to the given server using different user mappings (when multiple users are used to access the external server, multiple user mappings are configured and postgres_fdw will create a connection for each user mapping). If the connection is being used in the current local transaction, it will not be disconnected and a warning message will be output. Returns true if at least one connection is disconnected, false otherwise, and an error is reported if no external server with the given name is found (<code>ERROR: server &quot;...&quot; does not exist</code>).</p>
<p>Following the session, execute <code>SELECT postgres_fdw_disconnect('foreign_server')</code> and return <code>true</code>; query the <code>postgres_fdw_get_connections()</code> function again to find no more connections.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">postgres_fdw_disconnect</span><span class="p">(</span><span class="s1">&#39;foreign_server&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres_fdw_disconnect</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">postgres_fdw_get_connections</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">server_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">valid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-------------+-------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>postgres_fdw_disconnect_all()</p>
<p>Disconnects postgres_fdw from the local session to the external server. Used in a similar way to <code>postgres_fdw_disconnect(server_name text)</code> and will not be repeated here.</p>
</li>
</ul>
<h2 id="fdw-transaction-management-and-performance-optimization">FDW Transaction Management and Performance Optimization</h2>
<h3 id="transaction-management">Transaction Management</h3>
<p>When querying a remote table, postgres_fdw opens a new transaction on the remote server if the transaction corresponding to the current local transaction is not already open. When the local transaction is committed or aborted, the remote transaction is also committed or aborted. Savepoints are also managed by creating the corresponding remote savepoints.</p>
<p>When the local transaction has a SERIALIZABLE isolation level, the remote transaction also uses that isolation level; otherwise, the REPEATABLE READ isolation level is used.</p>
<p>If a query performs multiple table scans on a remote server, this option ensures that it will get snapshot-consistent results for all scans. The result is that successive queries in a single transaction will see the same data from the remote server, even if other activities perform concurrent updates on the remote server. This behavior is expected if the local transaction uses the SERIALIZABLE or REPEATABLE READ isolation levels, but it may be surprising for local transactions with the READ COMMITTED isolation level. Future versions of PostgreSQL may modify these rules.</p>
<h3 id="performance-optimization">Performance Optimization</h3>
<p>postgres_fdw will be more intelligent in determining whether a query statement (the query statements to be tested include <code>SELECT</code>, <code>UPDATE</code>, <code>DELETE</code> statements, statements involving operators, functions, joins, filter conditions and aggregate functions, etc.) should be moved down to the remote server for execution.</p>
<p>Ideally, the tables involved are on the remote server, and the operators, functions, etc. are all built-in types, so that postgres_fdw sends the entire query to the remote server for computation, and then just takes the results. In most cases, postgres_fdw needs to fetch the necessary data locally to perform operations such as joins, filters, and aggregate function processing. That is, postgres_fdw optimizes the queries sent to the remote server (optimizing the WHERE clause and not fetching unneeded columns) to reduce the data transfer from the remote server.</p>
<p>Let&rsquo;s look at two examples.</p>
<ul>
<li>
<p>Pure Remote Table Query</p>
<p>Original query statement:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">foreign_weather</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Use <code>EXPLAIN VERBOSE</code> to view the actual query (Remote SQL) sent to the remote server as :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">weather</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">local_user</span><span class="w"> </span><span class="n">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">VERBOSE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">foreign_weather</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">----------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Foreign</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">foreign_weather</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">121</span><span class="p">.</span><span class="mi">25</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">375</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">194</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Remote</span><span class="w"> </span><span class="k">SQL</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">weather</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Remote table and local table join query</p>
<p>Create a new local table <code>cities</code> and insert test data.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="w">        </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span><span class="w"> </span><span class="c1">-- city name (城市名)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">location</span><span class="w">    </span><span class="n">point</span><span class="w"> </span><span class="c1">-- point为PostgreSQL特有类型，该字段表示地理坐标(经度, 纬度)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">location</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Beijing&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(116.3, 39.9)&#39;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="s1">&#39;Shanghai&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(121.3, 31.1)&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>For queries.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="n">w</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The SQL sent by postgres_fdw to the remote server is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">weather</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">local_user</span><span class="w"> </span><span class="n">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">VERBOSE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                    </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Hash</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">118</span><span class="p">.</span><span class="mi">10</span><span class="p">..</span><span class="mi">163</span><span class="p">.</span><span class="mi">91</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">675</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">388</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">location</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hash</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">((</span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="p">)::</span><span class="nb">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">)::</span><span class="nb">text</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Foreign</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">foreign_weather</span><span class="w"> </span><span class="n">w</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">121</span><span class="p">.</span><span class="mi">25</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">375</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">194</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="nb">date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Remote</span><span class="w"> </span><span class="k">SQL</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_low</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">prcp</span><span class="p">,</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">weather</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Hash</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">13</span><span class="p">.</span><span class="mi">60</span><span class="p">..</span><span class="mi">13</span><span class="p">.</span><span class="mi">60</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">360</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">194</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">location</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">cities</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">13</span><span class="p">.</span><span class="mi">60</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">360</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">194</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">location</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>That is, postgres_fdw will fetch all the data of <code>foreign_weather</code> locally and join it with the table <code>cities</code>.</p>
<p>And for the query.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="n">w</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The SQL sent by postgres_fdw to the remote server is</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">weather</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">temp_high</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">local_user</span><span class="w"> </span><span class="n">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">postgres</span><span class="o">=&gt;</span><span class="w"> </span><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">VERBOSE</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cities</span><span class="w"> </span><span class="k">c</span><span class="p">,</span><span class="w"> </span><span class="n">foreign_weather</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                            </span><span class="n">QUERY</span><span class="w"> </span><span class="n">PLAN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">------------------------------------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">HashAggregate</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">143</span><span class="p">.</span><span class="mi">17</span><span class="p">..</span><span class="mi">145</span><span class="p">.</span><span class="mi">17</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">200</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">182</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">Key</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Hash</span><span class="w"> </span><span class="k">Join</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">119</span><span class="p">.</span><span class="mi">25</span><span class="p">..</span><span class="mi">141</span><span class="p">.</span><span class="mi">98</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">238</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">182</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Hash</span><span class="w"> </span><span class="n">Cond</span><span class="p">:</span><span class="w"> </span><span class="p">((</span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">)::</span><span class="nb">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="p">)::</span><span class="nb">text</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Seq</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">cities</span><span class="w"> </span><span class="k">c</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">13</span><span class="p">.</span><span class="mi">60</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">360</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">178</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">location</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">-&gt;</span><span class="w">  </span><span class="n">Hash</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">117</span><span class="p">.</span><span class="mi">60</span><span class="p">..</span><span class="mi">117</span><span class="p">.</span><span class="mi">60</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">132</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">182</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">-&gt;</span><span class="w">  </span><span class="k">Foreign</span><span class="w"> </span><span class="n">Scan</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">foreign_weather</span><span class="w"> </span><span class="n">w</span><span class="w">  </span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">117</span><span class="p">.</span><span class="mi">60</span><span class="w"> </span><span class="k">rows</span><span class="o">=</span><span class="mi">132</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="mi">182</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">Output</span><span class="p">:</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">temp_high</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">city</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">Remote</span><span class="w"> </span><span class="k">SQL</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp_high</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">public</span><span class="p">.</span><span class="n">weather</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">((</span><span class="n">temp_high</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="mi">13</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>That is, postgres_fdw optimizes the <code>WHERE</code> conditions sent to the remote server, gets only the data it needs from the remote table <code>foreign_weather</code>, and then computes it locally with the table <code>cities</code> for join, filtering, and aggregate function processing.</p>
</li>
</ul>
<p>In summary, we have a more detailed understanding of the basic concepts of PostgreSQL external data wrappers and how to use postgres_fdw.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/postgresql/">PostgreSQL</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-04/spring-officials-announced-vulnerability/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Spring official announcement of the network of large vulnerabilities, with solutions</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-03/postgres-tablespaces/">
            <span class="next-text nav-default">PostgreSQL Tablespace Usage Explained</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
