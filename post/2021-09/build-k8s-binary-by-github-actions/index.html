<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Compiling kubernetes components with GitHub Actions - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="When using kubernetes, you often have to modify the official k8s source code and recompile it due to certain needs. This article explains how to use GitHub Actions to compile and publish the generated binaries by modifying the kubeadm generation certificate to the default 10 years.
Build clone repo Fork the official kubernetes source code to your own repo
1 2 3 4 5 6  $ git clone https://github.com/k8sli/kubernetes.git $ cd kubernetes $ git remote add upstream https://github." /><meta name="keywords" content="k8s, Github Actions" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2021-09/build-k8s-binary-by-github-actions/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Compiling kubernetes components with GitHub Actions" />
<meta property="og:description" content="When using kubernetes, you often have to modify the official k8s source code and recompile it due to certain needs. This article explains how to use GitHub Actions to compile and publish the generated binaries by modifying the kubeadm generation certificate to the default 10 years.
Build clone repo Fork the official kubernetes source code to your own repo
1 2 3 4 5 6  $ git clone https://github.com/k8sli/kubernetes.git $ cd kubernetes $ git remote add upstream https://github." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2021-09/build-k8s-binary-by-github-actions/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-09T13:27:58+08:00" />
<meta property="article:modified_time" content="2021-09-09T13:27:58+08:00" />

<meta itemprop="name" content="Compiling kubernetes components with GitHub Actions">
<meta itemprop="description" content="When using kubernetes, you often have to modify the official k8s source code and recompile it due to certain needs. This article explains how to use GitHub Actions to compile and publish the generated binaries by modifying the kubeadm generation certificate to the default 10 years.
Build clone repo Fork the official kubernetes source code to your own repo
1 2 3 4 5 6  $ git clone https://github.com/k8sli/kubernetes.git $ cd kubernetes $ git remote add upstream https://github."><meta itemprop="datePublished" content="2021-09-09T13:27:58+08:00" />
<meta itemprop="dateModified" content="2021-09-09T13:27:58+08:00" />
<meta itemprop="wordCount" content="1112">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compiling kubernetes components with GitHub Actions"/>
<meta name="twitter:description" content="When using kubernetes, you often have to modify the official k8s source code and recompile it due to certain needs. This article explains how to use GitHub Actions to compile and publish the generated binaries by modifying the kubeadm generation certificate to the default 10 years.
Build clone repo Fork the official kubernetes source code to your own repo
1 2 3 4 5 6  $ git clone https://github.com/k8sli/kubernetes.git $ cd kubernetes $ git remote add upstream https://github."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Compiling kubernetes components with GitHub Actions</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-09 13:27:58 </span>
        <div class="post-category">
            <a href="/categories/skills/"> skills </a>
            </div>
          <span class="more-meta"> 1112 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#build">Build</a>
          <ul>
            <li><a href="#clone-repo">clone repo</a></li>
            <li><a href="#workflow">workflow</a></li>
            <li><a href="#modify-source-code">Modify source code</a></li>
            <li><a href="#cherry-pick">cherry-pick</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>When using kubernetes, you often have to modify the official k8s source code and recompile it due to certain needs. This article explains how to use GitHub Actions to compile and publish the generated binaries by modifying the kubeadm generation certificate to the default 10 years.</p>
<h2 id="build">Build</h2>
<h3 id="clone-repo">clone repo</h3>
<p>Fork the official kubernetes source code to your own repo</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git clone https://github.com/k8sli/kubernetes.git
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> kubernetes
</span></span><span class="line"><span class="cl">$ git remote add upstream https://github.com/kubernetes/kubernetes.git
</span></span><span class="line"><span class="cl">$ git fetch --all
</span></span><span class="line"><span class="cl">$ git checkout upstream/release-1.21
</span></span><span class="line"><span class="cl">$ git checkout -B kubeadm-1.21
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="workflow">workflow</h3>
<ul>
<li>
<p><code>github/workflows/kubeadm.yaml</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build kubeadm binary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">push</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tag</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s1">&#39;v*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l">ubuntu-20.04</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Here we choose to trigger the job as a tag</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l">startsWith(github.ref, &#39;refs/tags/&#39;)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Checkout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">actions/checkout@v2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Build kubeadm binary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        # Run the build/run.sh build script to compile the binaries on the appropriate platform
</span></span></span><span class="line"><span class="cl"><span class="sd">        build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/amd64
</span></span></span><span class="line"><span class="cl"><span class="sd">        build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/arm64</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># The built binaries are stored in _output/dockerized/bin/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># We name the binary target file according to its system name + CPU architecture name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Prepare for upload</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">        mv _output/dockerized/bin/linux/amd64/kubeadm kubeadm-linux-amd64
</span></span></span><span class="line"><span class="cl"><span class="sd">        mv _output/dockerized/bin/linux/arm64/kubeadm kubeadm-linux-arm64
</span></span></span><span class="line"><span class="cl"><span class="sd">        sha256sum kubeadm-linux-{amd64,arm64} &gt; sha256sum.txt</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Use softprops/action-gh-release to upload the build to the GitHub release</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Release and upload packages</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l">softprops/action-gh-release@v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">GITHUB_TOKEN</span><span class="p">:</span><span class="w"> </span><span class="l">${{ secrets.GITHUB_TOKEN }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">            sha256sum.txt
</span></span></span><span class="line"><span class="cl"><span class="sd">            kubeadm-linux-amd64
</span></span></span><span class="line"><span class="cl"><span class="sd">            kubeadm-linux-arm64</span><span class="w">            
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>build/run.sh</code></p>
<p>: Run a command in a build docker container. Common invocations:</p>
<ul>
<li><code>build/run.sh make</code> : Build just linux binaries in the container. Pass options and packages as necessary.</li>
<li><code>build/run.sh make cross</code> : Build all binaries for all platforms. To build only a specific platform, add <code>KUBE_BUILD_PLATFORMS=&lt;os&gt;/&lt;arch&gt;</code></li>
<li><code>build/run.sh make kubectl KUBE_BUILD_PLATFORMS=darwin/amd64</code> : Build the specific binary for the specific platform ( <code>kubectl</code> and <code>darwin/amd64</code> respectively in this example)</li>
<li><code>build/run.sh make test</code> : Run all unit tests</li>
<li><code>build/run.sh make test-integration</code> : Run integration test</li>
<li><code>build/run.sh make test-cmd</code> : Run CLI tests</li>
</ul>
</li>
</ul>
<h3 id="modify-source-code">Modify source code</h3>
<ul>
<li>
<p><code>cmd/kubeadm/app/constants/constants.go</code></p>
<p>Find the <code>CertificateValidity</code> variable and add a 0 to it after 375 days to renew the certificate to 10 years.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// CertificateValidity defines the validity for all the signed certificates generated by kubeadm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">-</span>	<span class="nx">CertificateValidity</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span>
</span></span><span class="line"><span class="cl"><span class="o">+</span>	<span class="nx">CertificateValidity</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3650</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// CACertAndKeyBaseName defines certificate authority base name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">CACertAndKeyBaseName</span> <span class="p">=</span> <span class="s">&#34;ca&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>git diff</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">diff --git a/.github/workflows/kubeadm.yaml b/.github/workflows/kubeadm.yaml
</span></span><span class="line"><span class="cl">new file mode 100644
</span></span><span class="line"><span class="cl">index 00000000000..376f37c0edf
</span></span><span class="line"><span class="cl">--- /dev/null
</span></span><span class="line"><span class="cl">+++ b/.github/workflows/kubeadm.yaml
</span></span><span class="line"><span class="cl">@@ -0,0 +1,37 @@
</span></span><span class="line"><span class="cl">+---
</span></span><span class="line"><span class="cl">+name: Build kubeadm binary image
</span></span><span class="line"><span class="cl">+
</span></span><span class="line"><span class="cl">+on:
</span></span><span class="line"><span class="cl">+  push:
</span></span><span class="line"><span class="cl">+    tag:
</span></span><span class="line"><span class="cl">+      - &#39;v*&#39;
</span></span><span class="line"><span class="cl">+jobs:
</span></span><span class="line"><span class="cl">+  build:
</span></span><span class="line"><span class="cl">+    runs-on: ubuntu-20.04
</span></span><span class="line"><span class="cl">+    if: startsWith(github.ref, &#39;refs/tags/&#39;)
</span></span><span class="line"><span class="cl">+    steps:
</span></span><span class="line"><span class="cl">+      - name: Checkout
</span></span><span class="line"><span class="cl">+        uses: actions/checkout@v2
</span></span><span class="line"><span class="cl">+
</span></span><span class="line"><span class="cl">+      - name: Build kubeadm binary
</span></span><span class="line"><span class="cl">+        shell: bash
</span></span><span class="line"><span class="cl">+        run: |
</span></span><span class="line"><span class="cl">+          build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/amd64
</span></span><span class="line"><span class="cl">+          build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/arm64
</span></span><span class="line"><span class="cl">+
</span></span><span class="line"><span class="cl">+      - name: Prepare for upload
</span></span><span class="line"><span class="cl">+        shell: bash
</span></span><span class="line"><span class="cl">+        run: |
</span></span><span class="line"><span class="cl">+          mv _output/dockerized/bin/linux/amd64/kubeadm kubeadm-linux-amd64
</span></span><span class="line"><span class="cl">+          mv _output/dockerized/bin/linux/arm64/kubeadm kubeadm-linux-arm64
</span></span><span class="line"><span class="cl">+          sha256sum kubeadm-linux-{amd64,arm64} &gt; sha256sum.txt
</span></span><span class="line"><span class="cl">+
</span></span><span class="line"><span class="cl">+      - name: Release and upload packages
</span></span><span class="line"><span class="cl">+        uses: softprops/action-gh-release@v1
</span></span><span class="line"><span class="cl">+        env:
</span></span><span class="line"><span class="cl">+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
</span></span><span class="line"><span class="cl">+        with:
</span></span><span class="line"><span class="cl">+          files: |
</span></span><span class="line"><span class="cl">+            sha256sum.txt
</span></span><span class="line"><span class="cl">+            kubeadm-linux-amd64
</span></span><span class="line"><span class="cl">+            kubeadm-linux-arm64
</span></span><span class="line"><span class="cl">diff --git a/cmd/kubeadm/app/constants/constants.go b/cmd/kubeadm/app/constants/constants.go
</span></span><span class="line"><span class="cl">index aed3a713020..08a24d237f8 100644
</span></span><span class="line"><span class="cl">--- a/cmd/kubeadm/app/constants/constants.go
</span></span><span class="line"><span class="cl">+++ b/cmd/kubeadm/app/constants/constants.go
</span></span><span class="line"><span class="cl">@@ -46,7 +46,7 @@ const (
</span></span><span class="line"><span class="cl">    TempDirForKubeadm = &#34;tmp&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // CertificateValidity defines the validity for all the signed certificates generated by kubeadm
</span></span><span class="line"><span class="cl">-	CertificateValidity = time.Hour * 24 * 365
</span></span><span class="line"><span class="cl">+	CertificateValidity = time.Hour * 24 * 3650
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // CACertAndKeyBaseName defines certificate authority base name
</span></span><span class="line"><span class="cl">    CACertAndKeyBaseName = &#34;ca&#34;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="cherry-pick">cherry-pick</h3>
<p>After the changes are done on the branch, we will cherry-pick the changes to other tags, here is the example of v1.21.4: cherry-pick the above changes on top of the v1.21.4 tag and re-tag it with a new tag.</p>
<ul>
<li>
<p>Get the commit id of the above modification</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nv">COMMIT_ID</span><span class="o">=</span><span class="k">$(</span>git rev-parse HEAD<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>checkout to v1.21.4 on this tag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git checkout v1.21.4
</span></span><span class="line"><span class="cl">Note: checking out <span class="s1">&#39;v1.21.4&#39;</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You are in <span class="s1">&#39;detached HEAD&#39;</span> state. You can look around, make experimental
</span></span><span class="line"><span class="cl">changes and commit them, and you can discard any commits you make in this
</span></span><span class="line"><span class="cl">state without impacting any branches by performing another checkout.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">If you want to create a new branch to retain commits you create, you may
</span></span><span class="line"><span class="cl"><span class="k">do</span> so <span class="o">(</span>now or later<span class="o">)</span> by using -b with the checkout <span class="nb">command</span> again. Example:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HEAD is now at 3cce4a82b44 Release commit <span class="k">for</span> Kubernetes v1.21.4
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Add the modification cherry-pick to the current tag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git cherry-pick <span class="nv">$COMMIT_ID</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>detached HEAD baadbe03458<span class="o">]</span> Update kubeadm CertificateValidity <span class="nb">time</span> to ten years
</span></span><span class="line"><span class="cl">Date: Tue Aug <span class="m">24</span> 16:32:49 <span class="m">2021</span> +0800
</span></span><span class="line"><span class="cl"><span class="m">2</span> files changed, <span class="m">38</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">1</span> deletion<span class="o">(</span>-<span class="o">)</span>
</span></span><span class="line"><span class="cl">create mode <span class="m">100644</span> .github/workflows/kubeadm.yaml
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Re-type the new tag, e.g. <code>v1.21.4-patch-1.0</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git tag v1.21.4-patch-1.0 -f
</span></span><span class="line"><span class="cl">Updated tag <span class="s1">&#39;v1.21.4-patch-1.0&#39;</span> <span class="o">(</span>was 70bcbd6de6c<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/09/f1a735a5aa464ffcaa6b3da2ad535f0d.png" alt=" "></p>
</li>
<li>
<p>Push tag to repo to trigger workflow</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git push origin --tags -f
</span></span><span class="line"><span class="cl">Enumerating objects: 17, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Counting objects: 100% <span class="o">(</span>17/17<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Delta compression using up to <span class="m">4</span> threads
</span></span><span class="line"><span class="cl">Compressing objects: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Writing objects: 100% <span class="o">(</span>10/10<span class="o">)</span>, 1.13 KiB <span class="p">|</span> 192.00 KiB/s, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Total <span class="m">10</span> <span class="o">(</span>delta 7<span class="o">)</span>, reused <span class="m">0</span> <span class="o">(</span>delta 0<span class="o">)</span>
</span></span><span class="line"><span class="cl">remote: Resolving deltas: 100% <span class="o">(</span>7/7<span class="o">)</span>, completed with <span class="m">7</span> <span class="nb">local</span> objects.
</span></span><span class="line"><span class="cl">To github.com:k8sli/kubernetes.git
</span></span><span class="line"><span class="cl">+ c2a633e07ec...baadbe03458 v1.21.4-patch-1.0 -&gt; v1.21.4-patch-1.0 <span class="o">(</span>forced update<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/09/f7db05a1e41c4f53ad9621eadd9d319f.png" alt=" "></p>
</li>
<li>
<p>The entire build process takes about 7 minutes, which is quite efficient.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/09/d21653405ebb46228659fe9fba36e530.png" alt=" "></p>
</li>
</ul>
<h2 id="summary">Summary</h2>
<p>The above only shows the process of building with one tag, if you want to build other versions of kubeadm, you can follow the same process and method. In fact, it is quite simple to write a shell script to handle this, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o errexit
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o nounset
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define commit ID</span>
</span></span><span class="line"><span class="cl">: <span class="si">${</span><span class="nv">COMMIT</span><span class="p">:=</span><span class="s2">&#34;48e4b4c7c62a84ab4ec363588721011b73ee77e6&#34;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the version number that needs to be recompiled</span>
</span></span><span class="line"><span class="cl">: <span class="si">${</span><span class="nv">TAGS</span><span class="p">:=</span><span class="s2">&#34;v1.22.1 v1.22.0 v1.21.4 v1.21.3 v1.20.10 v1.19.14 v1.18.10&#34;</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> tag in <span class="si">${</span><span class="nv">TAGS</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    git reset --hard <span class="si">${</span><span class="nv">tag</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    git cherry-pick <span class="si">${</span><span class="nv">COMMIT</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    git tag <span class="si">${</span><span class="nv">tag</span><span class="si">}</span>-patch-1.0
</span></span><span class="line"><span class="cl">    git push origin <span class="si">${</span><span class="nv">tag</span><span class="si">}</span>-patch-1.0
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images/2021/09/09/729bdd10ed72451b9853ddb34634b473.png" alt=" "></p>
<p>The advantage of using GitHub Actions is that it takes care of code management and product management for us. The built binaries are stored in the GitHub release and are easy to download and use, so you don&rsquo;t have to get a separate machine or storage server, which saves you a lot of labor and maintenance costs.</p>
<hr>
<p>Reference <code>https://blog.k8s.li/build-k8s-binary-by-github-actions.html</code></p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-09/deploy-k8s-by-kubeplay/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Using kubeplay to deploy a kubernetes cluster offline</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-09/windows11-preview-serious-bugs/">
            <span class="next-text nav-default">Windows 11 preview has a serious bug that turns out to be caused by built-in ads</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
