<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Develop a Hello World level eBPF program from scratch using C - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article introduces BPF technology and how to develop a hello world level eBPF program using C language via 2 methods (libbpf-bootstrap/libbpf)." /><meta name="keywords" content="Ebpf, c" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/c-ebpf/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Develop a Hello World level eBPF program from scratch using C" />
<meta property="og:description" content="This article introduces BPF technology and how to develop a hello world level eBPF program using C language via 2 methods (libbpf-bootstrap/libbpf)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/c-ebpf/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-05T09:08:17+08:00" />
<meta property="article:modified_time" content="2022-07-05T09:08:17+08:00" />

<meta itemprop="name" content="Develop a Hello World level eBPF program from scratch using C">
<meta itemprop="description" content="This article introduces BPF technology and how to develop a hello world level eBPF program using C language via 2 methods (libbpf-bootstrap/libbpf)."><meta itemprop="datePublished" content="2022-07-05T09:08:17+08:00" />
<meta itemprop="dateModified" content="2022-07-05T09:08:17+08:00" />
<meta itemprop="wordCount" content="4927">
<meta itemprop="keywords" content="c,Ebpf," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Develop a Hello World level eBPF program from scratch using C"/>
<meta name="twitter:description" content="This article introduces BPF technology and how to develop a hello world level eBPF program using C language via 2 methods (libbpf-bootstrap/libbpf)."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Develop a Hello World level eBPF program from scratch using C</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-05 09:08:17 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 4927 words </span>
          <span class="more-meta"> 24 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#i-introduction-to-ebpf">I. Introduction to eBPF</a></li>
            <li><a href="#ii-how-to-develop-bpf-programs">II. How to develop BPF programs</a></li>
            <li><a href="#iii-example-of-developing-hello-world-level-ebpf-application-based-on-libbpf-bootstrap">III. Example of developing hello world level eBPF application based on libbpf-bootstrap</a></li>
            <li><a href="#iv-developing-a-hello-world-bpf-application-based-on-libbpf">IV. Developing a hello world BPF application based on libbpf</a></li>
            <li><a href="#v-summary">V. Summary</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/05/6622f1dec2ca4ff6ab1694ac3c9e8743.png" alt="ebpf"></p>
<p>The hottest Linux kernel technology in the last two years is none other than <a href="https://ebpf.io/">eBPF</a>!</p>
<p>Since 2019, in addition to the rapid evolution of eBPF technology itself, <a href="https://ebpf.io/projects">Observability, Security and Networking projects based on eBPF technology</a> have sprung up. Familiar ones include <a href="https://cilium.io/">cilium</a> (bringing eBPF technology to the Kubernetes world), <a href="https://falco.org/">Falco</a> (a de facto standard for Kubernetes threat detection engines when running cloud-native security), <a href="https://github.com/facebookincubator/katran">Katran</a> (a high-performance four-tier load balancer), <a href="https://px.dev/">pixie</a> (an observability tool for Kubernetes applications), and more.</p>
<p>The eBPF technology is hot, but many people still don&rsquo;t know what exactly eBPF technology is and what it can do. In this article, I&rsquo;ll take a brief look at what eBPF kernel technology is and how to develop a Hello World level eBPF program from scratch in C.</p>
<p>Let&rsquo;s first look at what the hot eBPF technology really is.</p>
<h3 id="i-introduction-to-ebpf">I. Introduction to eBPF</h3>
<p>eBPF is a technology that I also came across a few years ago from the blog and book of <a href="https://www.brendangregg.com/">Brendan Gregg</a>, a performance expert and inventor of the flame chart.</p>
<p>The predecessor of eBPF technology is BPF (Berkeley Packet Filter), which started in late 1992 with a paper called &ldquo;<a href="https://www.tcpdump.org/papers/bpf-usenix93.pdf">The BSD PacketFilter: A New Architecture for User-Level Packet Capture</a>&rdquo;. The paper proposed a technical solution for implementing network packet filtering in the Unix kernel, a new technology that was 20 times faster than the most advanced packet filtering technology at the time.</p>
<p>In 1997, BPF technology was incorporated into the linux kernel and later used in tcpdump.</p>
<p>At the beginning of 2014, Alexei Starovoitov implemented eBPF, <a href="https://lwn.net/Articles/740157/">which extends the classic BPF</a> and opens the door to a wider range of BPF technologies.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/05/1a88af38be8b41348306279570b424c0.png" alt="BPF/eBPF"></p>
<p>As we can see from the above diagram: eBPF programs run in the kernel state (kernel), there is no need for you to recompile the kernel or compile and mount kernel modules. eBPF can be dynamically injected into the kernel and run and uninstalled at any time. <strong>eOnce in the kernel, BPF has a God&rsquo;s-eye view and can monitor the kernel as well as user-state programs</strong>. And eBPF technology provides a series of tools (Verifier) to detect the security of eBPF code and prevent malicious programs from entering the kernel state and executing.</p>
<p>In essence, the BPF technology is actually a kernel opening for the user state (the kernel has already made the burial point)! By injecting eBPF programs and registering events to watch, event triggering (kernel <strong>callbacks</strong> to your injected eBPF programs), and data exchange between kernel and user state to achieve the logic you want.</p>
<p>Today&rsquo;s eBPF is no longer limited to classic BPF (cBPF) applications in networking. eBPF technology has been given a new definition: a New Generation of Networking, Security, and Observability Tools, i.e., a new generation of networking, security, and observability technologies. This definition comes from the Chief Open Source Officer of isovalent: liz rice, the parent company of the Cilium project, a technology startup driving cloud-native networking, security, and observability with eBPF technology.</p>
<p>eBPF has become the top subsystem of the kernel, and subsequently, <strong>if not specifically referred to, the BPF we mention refers to the new generation of eBPF technology</strong>.</p>
<p>BPF technology is so awesome, so how do we develop BPF programs?</p>
<h3 id="ii-how-to-develop-bpf-programs">II. How to develop BPF programs</h3>
<h4 id="1-the-form-of-bpf-programs">1. The form of BPF programs</h4>
<p>A project aimed at developing BPF programs usually <strong>consists of two types of source files</strong>, one is the source code file of the BPF program running in the kernel state (e.g., bpf_program.bpf.c in the figure below). The other is the source code file of the user state program used to load the BPF program to the kernel, unload the BPF program from the kernel, interact with the kernel state, and present the logic of the user state program (e.g., bpf_loader.c in the figure below).</p>
<p>Currently, BPF programs running in the kernel state can only be developed in C (corresponding to the first type of source code file, bpf_program.bpf.c in the figure below), or more precisely in <strong>restricted C syntax</strong>, and the only one that can perfectly compile C source code into BPF target files is the <a href="https://clang.llvm.org/">clang compiler</a> (clang is a compiler front-end for C, C++, Objective-C and other programming languages, using LLVM as the back-end).</p>
<p>The following is a diagram of the compilation and loading process of the BPF program into the kernel.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/05/dead21a75b474fb58c5eb7fc083a3c5c.png" alt="compilation and loading process of the BPF program into the kernel"></p>
<p>The BPF target file (bpf_program.o) is essentially an <a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF file</a>, and we can read the contents of the BPF target file by using the readelf command line tool, here is an example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$readelf</span> -a bpf_program.o
</span></span><span class="line"><span class="cl">ELF Header:
</span></span><span class="line"><span class="cl">  Magic:   7f <span class="m">45</span> 4c <span class="m">46</span> <span class="m">02</span> <span class="m">01</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">  Class:                             ELF64
</span></span><span class="line"><span class="cl">  Data:                              2<span class="s1">&#39;s complement, little endian
</span></span></span><span class="line"><span class="cl"><span class="s1">  Version:                           1 (current)
</span></span></span><span class="line"><span class="cl"><span class="s1">  OS/ABI:                            UNIX - System V
</span></span></span><span class="line"><span class="cl"><span class="s1">  ABI Version:                       0
</span></span></span><span class="line"><span class="cl"><span class="s1">  Type:                              REL (Relocatable file)
</span></span></span><span class="line"><span class="cl"><span class="s1">  Machine:                           Linux BPF
</span></span></span><span class="line"><span class="cl"><span class="s1">  Version:                           0x1
</span></span></span><span class="line"><span class="cl"><span class="s1">  Entry point address:               0x0
</span></span></span><span class="line"><span class="cl"><span class="s1">  Start of program headers:          0 (bytes into file)
</span></span></span><span class="line"><span class="cl"><span class="s1">  Start of section headers:          424 (bytes into file)
</span></span></span><span class="line"><span class="cl"><span class="s1">  Flags:                             0x0
</span></span></span><span class="line"><span class="cl"><span class="s1">  Size of this header:               64 (bytes)
</span></span></span><span class="line"><span class="cl"><span class="s1">  Size of program headers:           0 (bytes)
</span></span></span><span class="line"><span class="cl"><span class="s1">  Number of program headers:         0
</span></span></span><span class="line"><span class="cl"><span class="s1">  Size of section headers:           64 (bytes)
</span></span></span><span class="line"><span class="cl"><span class="s1">  Number of section headers:         8
</span></span></span><span class="line"><span class="cl"><span class="s1">  Section header string table index: 1
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Section Headers:
</span></span></span><span class="line"><span class="cl"><span class="s1">  [Nr] Name              Type             Address           Offset
</span></span></span><span class="line"><span class="cl"><span class="s1">       Size              EntSize          Flags  Link  Info  Align
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 0]                   NULL             0000000000000000  00000000
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000000  0000000000000000           0     0     0
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 1] .strtab           STRTAB           0000000000000000  0000012a
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000079  0000000000000000           0     0     1
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 2] .text             PROGBITS         0000000000000000  00000040
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000000  0000000000000000  AX       0     0     4
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 3] tracepoint/syscal PROGBITS         0000000000000000  00000040
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000070  0000000000000000  AX       0     0     8
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 4] .rodata.str1.1    PROGBITS         0000000000000000  000000b0
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000012  0000000000000001 AMS       0     0     1
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 5] license           PROGBITS         0000000000000000  000000c2
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000004  0000000000000000  WA       0     0     1
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 6] .llvm_addrsig     LOOS+0xfff4c03   0000000000000000  00000128
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000002  0000000000000000   E       7     0     1
</span></span></span><span class="line"><span class="cl"><span class="s1">  [ 7] .symtab           SYMTAB           0000000000000000  000000c8
</span></span></span><span class="line"><span class="cl"><span class="s1">       0000000000000060  0000000000000018           1     2     8
</span></span></span><span class="line"><span class="cl"><span class="s1">Key to Flags:
</span></span></span><span class="line"><span class="cl"><span class="s1">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
</span></span></span><span class="line"><span class="cl"><span class="s1">  L (link order), O (extra OS processing required), G (group), T (TLS),
</span></span></span><span class="line"><span class="cl"><span class="s1">  C (compressed), x (unknown), o (OS specific), E (exclude),
</span></span></span><span class="line"><span class="cl"><span class="s1">  p (processor specific)
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">There are no section groups in this file.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">There are no program headers in this file.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">There is no dynamic section in this file.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">There are no relocations in this file.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">The decoding of unwind sections for machine type Linux BPF is not currently supported.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Symbol table &#39;</span>.symtab<span class="err">&#39;</span> contains <span class="m">4</span> entries:
</span></span><span class="line"><span class="cl">   Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span><span class="line"><span class="cl">     0: <span class="m">0000000000000000</span>     <span class="m">0</span> NOTYPE  LOCAL  DEFAULT  UND
</span></span><span class="line"><span class="cl">     1: <span class="m">0000000000000000</span>     <span class="m">0</span> FILE    LOCAL  DEFAULT  ABS bpf_program.c
</span></span><span class="line"><span class="cl">     2: <span class="m">0000000000000000</span>     <span class="m">4</span> OBJECT  GLOBAL DEFAULT    <span class="m">5</span> _license
</span></span><span class="line"><span class="cl">     3: <span class="m">0000000000000000</span>   <span class="m">112</span> FUNC    GLOBAL DEFAULT    <span class="m">3</span> bpf_prog
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the Symbol table output by readelf above, we see a symbol bpf_prog of type FUNC, which is the entry of the BPF program we wrote. The symbol bpf_prog corresponds to the Ndx value of 3. Then we can find the section entries with the serial number of 3 in the Section Header in front: tracepoint/syscal&hellip;, they are corresponding.</p>
<p>From the readelf output, we can see: bpf_prog (i.e. the section with serial number 3) has a Size of 112, but what is its content? We use another tool, llvm-objdump, to expand the contents of bpf_prog.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$llvm</span>-objdump-10 -d bpf_program.o
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bpf_program.o:  file format ELF64-BPF
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Disassembly of section tracepoint/syscalls/sys_enter_execve:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0000000000000000</span> bpf_prog:
</span></span><span class="line"><span class="cl">       0:   b7 <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">21</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">r1</span> <span class="o">=</span> <span class="m">33</span>
</span></span><span class="line"><span class="cl">       1:   6b 1a f8 ff <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> *<span class="o">(</span>u16 *<span class="o">)(</span>r10 - <span class="m">8</span> <span class="o">)</span> <span class="o">=</span> r1
</span></span><span class="line"><span class="cl">       2:   <span class="m">18</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">50</span> <span class="m">46</span> <span class="m">20</span> <span class="m">57</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 6f <span class="m">72</span> 6c <span class="m">64</span> <span class="nv">r1</span> <span class="o">=</span> <span class="m">7236284523806213712</span> ll
</span></span><span class="line"><span class="cl">       4:   7b 1a f0 ff <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> *<span class="o">(</span>u64 *<span class="o">)(</span>r10 - 16<span class="o">)</span> <span class="o">=</span> r1
</span></span><span class="line"><span class="cl">       5:   <span class="m">18</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">48</span> <span class="m">65</span> 6c 6c <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> 6f 2c <span class="m">20</span> <span class="m">42</span> <span class="nv">r1</span> <span class="o">=</span> <span class="m">4764857262830019912</span> ll
</span></span><span class="line"><span class="cl">       7:   7b 1a e8 ff <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> *<span class="o">(</span>u64 *<span class="o">)(</span>r10 - 24<span class="o">)</span> <span class="o">=</span> r1
</span></span><span class="line"><span class="cl">       8:   bf a1 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">r1</span> <span class="o">=</span> r10
</span></span><span class="line"><span class="cl">       9:   <span class="m">07</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> e8 ff ff ff <span class="nv">r1</span> <span class="o">+=</span> -24
</span></span><span class="line"><span class="cl">      10:   b7 <span class="m">02</span> <span class="m">00</span> <span class="m">00</span> <span class="m">12</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">r2</span> <span class="o">=</span> <span class="m">18</span>
</span></span><span class="line"><span class="cl">      11:   <span class="m">85</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">06</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> call <span class="m">6</span>
</span></span><span class="line"><span class="cl">      12:   b7 <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nv">r0</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">      13:   <span class="m">95</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="nb">exit</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The content of bpf_prog output by llvm-objdump is actually the <strong>byte code of BPF</strong>. When it comes to byte code, the first thing that comes to our mind is the jvm virtual machine. Yes, the BPF program is not loaded into the kernel as a machine instruction, but as byte code, which is obviously a barrier added to the BPF virtual machine for security purposes. As the BPF program is loaded into the kernel, the BPF VM verifies the BPF bytecode and runs a JIT compilation to compile the bytecode into machine code.</p>
<p>The user state programs used to load and unload BPF programs can be developed in multiple languages, either C or Python, Go, Rust, etc.</p>
<h4 id="2-how-bpf-programs-are-developed">2. How BPF programs are developed</h4>
<p>BPF has evolved over the years, and although efforts have been made to improve it, the experience of developing and building BPF programs is still not ideal. For this reason the community has also created frameworks and library collections like <a href="https://github.com/iovisor/bcc">BPF Compiler Collection (BCC)</a> to simplify BPF development, and libraries like <a href="https://github.com/iovisor/bpftrace">bpftrace</a> that provide an advanced BPF development language (understandably a DSL language for developing BPF).</p>
<p>Many times we don&rsquo;t need to develop our own BPF programs, open source projects like bcc and bpftrace provide us with a lot of high quality BPF programs. But once we have to develop them ourselves, the threshold for developing based on bcc and bpftrace is actually not low. You need to understand the structure of the bcc framework, and you need to learn the scripting language provided by bpftrace, which inevitably adds to the burden of developing BPF on your own.</p>
<p>As BPF becomes more widely used, the issue of portability of BPF gradually emerges. The Linux kernel is evolving rapidly, and the types and data structures in the kernel are constantly changing. Fields of the same structure type in different kernel versions may be rearranged, may be renamed or deleted, may be changed to completely different fields, etc. For BPF programs that do not need to look at the kernel&rsquo;s internal data structures, there may be no portability issues. However, for those BPF programs that need to rely on certain fields in the kernel data structure, it is important to consider the problems caused to the BPF program by changes in the internal data structure of different Kernel versions.</p>
<p>Initially, the way to solve this problem was to compile the BPF program locally on the target machine where the BPF program was deployed to ensure that the kernel type field layout accessed by the BPF program was consistent with the target host kernel. But this is obviously cumbersome: the various development packages that BPF depends on, the compilers used need to be installed on the target machine, and the compilation process can be time-consuming, making the testing and distribution process of BPF programs very painful, especially if you use bcc and bpftrace to develop BPF programs.</p>
<p>To solve the BPF portability problem, the kernel introduced two new technologies, BTF (BPF Type Format) and CO-RE (Compile Once - Run Everywhere). BTF provides structural information to avoid dependency on Clang and kernel headers, and CO-RE makes the compiled BPF bytecode relocatable, avoiding the need for LLVM recompilation.</p>
<p>BPF programs built using these new techniques work across different linux kernel versions without the need to recompile it for a specific kernel on the target machine. There is also no need to install hundreds of megabytes of LLVM, Clang and kernel header dependencies on the target machine as was previously the case.</p>
<blockquote>
<p>Note: The principle of BTF and Co-RE technology is not the focus of this article, so it will not be repeated here, you can check the information yourself.</p>
</blockquote>
<p>Of course these new technologies are transparent to the BPF program itself. The libbpf user API provided by the Linux kernel source code encapsulates all of the above new technologies, and as long as the user-state loader is developed based on libbpf, then libbpf will quietly help the BPF program relocate to the corresponding fields of the kernel structure it needs in the target host kernel, making libbpf the preferred choice for developing BPF loaders.</p>
<h4 id="3-libbpf-based-way-to-develop-bpf-programs">3. libbpf-based way to develop BPF programs</h4>
<p>The kernel BPF developer <a href="https://nakryiko.com/">Andrii Nakryiko</a> has open sourced a bootstrap project <a href="https://github.com/libbpf">libbpf-bootstrap</a> for developing BPF programs and loaders directly based on libbpf on github /libbpf-bootstrap). This project contains examples of developing BPF programs and user state programs using c and rust. This is also the best experience I&rsquo;ve seen so far with the development of C-based BPF programs and loaders.</p>
<p>Let&rsquo;s take a hello world level BPF program and its user state loader as an example to see the &ldquo;way&rdquo; of implementing a BPF program based on the structure suggested by libbpf-bootstrap, here is a diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/05/44c176b1e3a947b49cde952fa183fc3d.png" alt="libbpf-based way to develop BPF programs"></p>
<p>Here is a brief explanation of the above schematic.</p>
<p>We keep talking about libbpf, what exactly is libbpf? Actually, libbpf refers to tools/lib/bpf in the linux kernel code base, which is a C library provided by the kernel to external developers for creating BPF user-state programs. bpf kernel developers have created a mirror repository for libbpf on github.com for the convenience of developers using the libbpf library: <a href="https://github.com/libbpf/libbpf">https://github.com/libbpf/libbpf</a> so that BPF developers do not have to download the full amount of Linux Kernel code. Of course, the mirror repository also contains some of the kernel headers that tools/lib/bpf depends on, which are mapped to the linux kernel source paths as shown in the following code (the left side of the equal sign is the source path in the linux kernel, the right side of the equal sign is the source path in github.com/libbpf/libbpf).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">// https://github.com/libbpf/libbpf/blob/master/scripts/sync-kernel.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">PATH_MAP</span><span class="o">=(</span>                                  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/lib/bpf<span class="o">]=</span>src                         <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/bpf_common.h<span class="o">]=</span>include/uapi/linux/bpf_common.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/bpf.h<span class="o">]=</span>include/uapi/linux/bpf.h       <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/btf.h<span class="o">]=</span>include/uapi/linux/btf.h       <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/if_link.h<span class="o">]=</span>include/uapi/linux/if_link.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/if_xdp.h<span class="o">]=</span>include/uapi/linux/if_xdp.h     <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/netlink.h<span class="o">]=</span>include/uapi/linux/netlink.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/pkt_cls.h<span class="o">]=</span>include/uapi/linux/pkt_cls.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/pkt_sched.h<span class="o">]=</span>include/uapi/linux/pkt_sched.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>include/uapi/linux/perf_event.h<span class="o">]=</span>include/uapi/linux/perf_event.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>Documentation/bpf/libbpf<span class="o">]=</span>docs                     <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The bpftool in the figure corresponds to tools/bpf/bpftool in the linux kernel code repository, which is also the corresponding mirror repository created on github, a bpf helper program used in libbpf-bootstrap to generate xx.skel.h. The mirror repository also contains tools/bpf/ The mapping between bpftool and linux kernel source paths is shown in the following code (the left side of the equal sign is the source path in linux kernel, the right side of the equal sign is the source path in github.com/libbpf/bpftool)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">// https://github.com/libbpf/bpftool/blob/master/scripts/sync-kernel.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">PATH_MAP</span><span class="o">=(</span>                                  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span><span class="si">${</span><span class="nv">BPFTOOL_SRC_DIR</span><span class="si">}</span><span class="o">]=</span>src                        <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span><span class="si">${</span><span class="nv">BPFTOOL_SRC_DIR</span><span class="si">}</span>/bash-completion<span class="o">]=</span>bash-completion            <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span><span class="si">${</span><span class="nv">BPFTOOL_SRC_DIR</span><span class="si">}</span>/Documentation<span class="o">]=</span>docs                 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>kernel/bpf/disasm.c<span class="o">]=</span>src/kernel/bpf/disasm.c               <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>kernel/bpf/disasm.h<span class="o">]=</span>src/kernel/bpf/disasm.h               <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/asm-generic/bitsperlong.h<span class="o">]=</span>include/uapi/asm-generic/bitsperlong.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/bpf_common.h<span class="o">]=</span>include/uapi/linux/bpf_common.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/bpf.h<span class="o">]=</span>include/uapi/linux/bpf.h       <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/btf.h<span class="o">]=</span>include/uapi/linux/btf.h       <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/const.h<span class="o">]=</span>include/uapi/linux/const.h       <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/if_link.h<span class="o">]=</span>include/uapi/linux/if_link.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/netlink.h<span class="o">]=</span>include/uapi/linux/netlink.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/perf_event.h<span class="o">]=</span>include/uapi/linux/perf_event.h <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/pkt_cls.h<span class="o">]=</span>include/uapi/linux/pkt_cls.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/pkt_sched.h<span class="o">]=</span>include/uapi/linux/pkt_sched.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="o">[</span>tools/include/uapi/linux/tc_act/tc_bpf.h<span class="o">]=</span>include/uapi/linux/tc_act/tc_bpf.h   <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>helloworld.bpf.c is the source code of the bpf program, which is compiled into the BPF bytecode ELF file helloworld.bpf.o by clang -target=bpf . libbpf-bootstrap does not use the user state loader to load helloworld.bpf.o directly, but Instead, it generates the helloworld.skel.h file based on helloworld.bpf.o via the bpftool gen command. The generated helloworld.skel.h file <strong>contains the bytecode of the BPF program</strong> and the functions to load and unload the corresponding BPF program, which we can call directly from the user state program.</p>
<p>helloworld.c is the BPF user-state program, it just needs to include helloworld.skel.h and load and hook the BPF program to the corresponding buried point in the kernel layer as per the set. Since the BPF program is embedded in the user state program, we only need to distribute the user state program when we distribute the BPF program!</p>
<p>Above, we briefly understand the development idea based on libbpf-bootstrap, below we develop a hello world level BPF program and its user state loader program based on libbpf-bootstrap and libbpf in C language.</p>
<h3 id="iii-example-of-developing-hello-world-level-ebpf-application-based-on-libbpf-bootstrap">III. Example of developing hello world level eBPF application based on libbpf-bootstrap</h3>
<blockquote>
<p>Note: My experimental environment is ubuntu 20.04 (kernel version: 5.4.0-109-generic).</p>
</blockquote>
<h4 id="1-installing-dependencies">1. Installing dependencies</h4>
<p>Installing the dependencies for developing the BPF application on the development machine is an essential first step. First of all, we need to install clang, the compiler for BPF programs. It is recommended to install clang 10 and above, here is an example of clang-10.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$apt</span>-get install clang-10
</span></span><span class="line"><span class="cl"><span class="nv">$clang</span>-10 --version
</span></span><span class="line"><span class="cl">clang version 10.0.0-4ubuntu1
</span></span><span class="line"><span class="cl">Target: x86_64-pc-linux-gnu
</span></span><span class="line"><span class="cl">Thread model: posix
</span></span><span class="line"><span class="cl">InstalledDir: /usr/bin
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-download-libbpf-bootstrap">2. Download libbpf-bootstrap</h4>
<p>libbpf-bootstrap is a simple development framework for developing BPF applications based on libbpf, we need to download it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://github.com/libbpf/libbpf-bootstrap.git
</span></span><span class="line"><span class="cl">Cloning into <span class="s1">&#39;libbpf-bootstrap&#39;</span>...
</span></span><span class="line"><span class="cl">remote: Enumerating objects: 387, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Counting objects: 100% <span class="o">(</span>19/19<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Compressing objects: 100% <span class="o">(</span>17/17<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Total <span class="m">387</span> <span class="o">(</span>delta 4<span class="o">)</span>, reused <span class="m">7</span> <span class="o">(</span>delta 2<span class="o">)</span>, pack-reused <span class="m">368</span>
</span></span><span class="line"><span class="cl">Receiving objects: 100% <span class="o">(</span>387/387<span class="o">)</span>, 2.59 MiB <span class="p">|</span> 5.77 MiB/s, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Resolving deltas: 100% <span class="o">(</span>173/173<span class="o">)</span>, <span class="k">done</span>.
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-initialize-and-update-libbpf-bootstraps-dependencies">3. Initialize and update libbpf-bootstrap&rsquo;s dependencies</h4>
<p>libbpf-bootstrap has its dependencies libbpf, bpftool configured in its project as a git submodule.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$cat</span> .gitmodules
</span></span><span class="line"><span class="cl"><span class="o">[</span>submodule <span class="s2">&#34;libbpf&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="nv">path</span> <span class="o">=</span> libbpf
</span></span><span class="line"><span class="cl">    <span class="nv">url</span> <span class="o">=</span> https://github.com/libbpf/libbpf.git
</span></span><span class="line"><span class="cl"><span class="o">[</span>submodule <span class="s2">&#34;bpftool&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="nv">path</span> <span class="o">=</span> bpftool
</span></span><span class="line"><span class="cl">    <span class="nv">url</span> <span class="o">=</span> https://github.com/libbpf/bpftool
</span></span><span class="line"><span class="cl"><span class="o">[</span>submodule <span class="s2">&#34;blazesym&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="nv">path</span> <span class="o">=</span> blazesym
</span></span><span class="line"><span class="cl">    <span class="nv">url</span> <span class="o">=</span> https://github.com/ThinkerYzu1/blazesym.git
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>blazesys is a project related to rust, so I won&rsquo;t explain too much here.</p>
</blockquote>
<p>Therefore, we need to initialize these git submodules and update them to the latest version before we can apply the libbpf-bootstrap project to develop our BPF application. We execute the following command under the libbpf-bootstrap project path.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$git</span> submodule update --init --recursive
</span></span><span class="line"><span class="cl">Submodule <span class="s1">&#39;blazesym&#39;</span> <span class="o">(</span>https://github.com/ThinkerYzu1/blazesym.git<span class="o">)</span> registered <span class="k">for</span> path <span class="s1">&#39;blazesym&#39;</span>
</span></span><span class="line"><span class="cl">Submodule <span class="s1">&#39;bpftool&#39;</span> <span class="o">(</span>https://github.com/libbpf/bpftool<span class="o">)</span> registered <span class="k">for</span> path <span class="s1">&#39;bpftool&#39;</span>
</span></span><span class="line"><span class="cl">Submodule <span class="s1">&#39;libbpf&#39;</span> <span class="o">(</span>https://github.com/libbpf/libbpf.git<span class="o">)</span> registered <span class="k">for</span> path <span class="s1">&#39;libbpf&#39;</span>
</span></span><span class="line"><span class="cl">Cloning into <span class="s1">&#39;/root/ebpf/libbpf-bootstrap/blazesym&#39;</span>...
</span></span><span class="line"><span class="cl">Cloning into <span class="s1">&#39;/root/ebpf/libbpf-bootstrap/bpftool&#39;</span>...
</span></span><span class="line"><span class="cl">Cloning into <span class="s1">&#39;/root/ebpf/libbpf-bootstrap/libbpf&#39;</span>...
</span></span><span class="line"><span class="cl">Submodule path <span class="s1">&#39;blazesym&#39;</span>: checked out <span class="s1">&#39;1e1f48c18da9416e1d4c35ec9bce4ed77019b109&#39;</span>
</span></span><span class="line"><span class="cl">Submodule path <span class="s1">&#39;bpftool&#39;</span>: checked out <span class="s1">&#39;8ec897a0cd357fe9e13eec7d27d43e024891746b&#39;</span>
</span></span><span class="line"><span class="cl">Submodule path <span class="s1">&#39;libbpf&#39;</span>: checked out <span class="s1">&#39;4eb6485c08867edaa5a0a81c64ddb23580420340&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The git command above will automatically pull the latest source code from both libbpf and bpftool repositories.</p>
<h4 id="4-hello-world-level-bpf-application-based-on-libbpf-bootstrap-framework">4. hello world level BPF application based on libbpf-bootstrap framework</h4>
<p>With the libbpf-bootstrap framework, it is very simple to add a new BPF application to it. We go to the libbpf-bootstrap/examples/c directory and create two C source files helloworld.bpf.c and helloworld.c in that directory (minimal.bpf.c and minimal.c are referenced), obviously the former is the source code for the BPF program running in the kernel state, while the latter is a user-state program used to load BPF into the kernel, and their source code is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// helloworld.bpf.c 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">SEC</span><span class="p">(</span><span class="s">&#34;tracepoint/syscalls/sys_enter_execve&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">bpf_prog</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;Hello, World!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">bpf_printk</span><span class="p">(</span><span class="s">&#34;invoke bpf_prog: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">LICENSE</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;Dual BSD/GPL&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// helloworld.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/resource.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;bpf/libbpf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;helloworld.skel.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">libbpf_print_fn</span><span class="p">(</span><span class="k">enum</span> <span class="n">libbpf_print_level</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="n">va_list</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">vfprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">helloworld_bpf</span> <span class="o">*</span><span class="n">skel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">libbpf_set_strict_mode</span><span class="p">(</span><span class="n">LIBBPF_STRICT_ALL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Set up libbpf errors and debug info callback */</span>
</span></span><span class="line"><span class="cl">    <span class="n">libbpf_set_print</span><span class="p">(</span><span class="n">libbpf_print_fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Open BPF application */</span>
</span></span><span class="line"><span class="cl">    <span class="n">skel</span> <span class="o">=</span> <span class="n">helloworld_bpf__open</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Failed to open BPF skeleton</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Load &amp; verify BPF programs */</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">helloworld_bpf__load</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Failed to load and verify BPF skeleton</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Attach tracepoint handler */</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="n">helloworld_bpf__attach</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Failed to attach BPF skeleton</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Successfully started! Please run `sudo cat /sys/kernel/debug/tracing/trace_pipe` &#34;</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;to see output of the BPF programs.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* trigger our BPF program */</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">cleanup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">helloworld_bpf__destroy</span><span class="p">(</span><span class="n">skel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The logic of the bpf program in helloworld.bpf.c is simple: inject bpf_prog at the buried point of the execve call (set by the SEC macro), so that every time the execve call is executed, bpf_prog will be called back. bpf_prog&rsquo;s logic is also very simple: it outputs a line of kernel debug logs! We can see the log output via /sys/kernel/debug/tracing/trace_pipe.</p>
<p>Since the bpf bytecode is encapsulated in helloworld.skel.h, helloworld.c, which includes helloworld.skel.h, is written in a more &ldquo;formulaic&rdquo; logic: open -&gt; load -&gt; attach -&gt; destroy. For a simple BPF program like helloworld, helloworld.c can even be made into a template. But for user-state programs that interact with kernel-state BPF data, it may not be so &ldquo;set in stone&rdquo;.</p>
<p>Compiling the new helloworld program above is also very simple, mainly because the libbpf_bootstrap project has a very extended Makefile, we just need to add a helloworld entry after the APP variable in the Makefile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// libbpf_bootstrap/examples/c/Makefile
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">APPS</span> <span class="o">=</span> <span class="n">helloworld</span> <span class="n">minimal</span> <span class="n">minimal_legacy</span> <span class="n">bootstrap</span> <span class="n">uprobe</span> <span class="n">kprobe</span> <span class="n">fentry</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then execute the make command to compile helloworld.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$make</span>
</span></span><span class="line"><span class="cl">  BPF      .output/helloworld.bpf.o
</span></span><span class="line"><span class="cl">  GEN-SKEL .output/helloworld.skel.h
</span></span><span class="line"><span class="cl">  CC       .output/helloworld.o
</span></span><span class="line"><span class="cl">  BINARY   helloworld
</span></span></code></pre></td></tr></table>
</div>
</div><p>We need to execute helloworld with root privileges.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$sudo</span> ./helloworld
</span></span><span class="line"><span class="cl">libbpf: loading object <span class="s1">&#39;helloworld_bpf&#39;</span> from buffer
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>2<span class="o">)</span> tracepoint/syscalls/sys_enter_execve, size 120, link 0, flags 6, <span class="nv">type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">libbpf: sec <span class="s1">&#39;tracepoint/syscalls/sys_enter_execve&#39;</span>: found program <span class="s1">&#39;bpf_prog&#39;</span> at insn offset <span class="m">0</span> <span class="o">(</span><span class="m">0</span> bytes<span class="o">)</span>, code size <span class="m">15</span> insns <span class="o">(</span><span class="m">120</span> bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>3<span class="o">)</span> .rodata.str1.1, size 14, link 0, flags 32, <span class="nv">type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>4<span class="o">)</span> .rodata, size 21, link 0, flags 2, <span class="nv">type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>5<span class="o">)</span> license, size 13, link 0, flags 3, <span class="nv">type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">libbpf: license of helloworld_bpf is Dual BSD/GPL
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>6<span class="o">)</span> .BTF, size 560, link 0, flags 0, <span class="nv">type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>7<span class="o">)</span> .BTF.ext, size 144, link 0, flags 0, <span class="nv">type</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>8<span class="o">)</span> .symtab, size 168, link 13, flags 0, <span class="nv">type</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">libbpf: elf: section<span class="o">(</span>9<span class="o">)</span> .reltracepoint/syscalls/sys_enter_execve, size 16, link 8, flags 0, <span class="nv">type</span><span class="o">=</span><span class="m">9</span>
</span></span><span class="line"><span class="cl">libbpf: looking <span class="k">for</span> externs among <span class="m">7</span> symbols...
</span></span><span class="line"><span class="cl">libbpf: collected <span class="m">0</span> externs total
</span></span><span class="line"><span class="cl">libbpf: map <span class="s1">&#39;.rodata.str1.1&#39;</span> <span class="o">(</span>global data<span class="o">)</span>: at sec_idx 3, offset 0, flags 480.
</span></span><span class="line"><span class="cl">libbpf: map <span class="m">0</span> is <span class="s2">&#34;.rodata.str1.1&#34;</span>
</span></span><span class="line"><span class="cl">libbpf: map <span class="s1">&#39;hellowor.rodata&#39;</span> <span class="o">(</span>global data<span class="o">)</span>: at sec_idx 4, offset 0, flags 480.
</span></span><span class="line"><span class="cl">libbpf: map <span class="m">1</span> is <span class="s2">&#34;hellowor.rodata&#34;</span>
</span></span><span class="line"><span class="cl">libbpf: sec <span class="s1">&#39;.reltracepoint/syscalls/sys_enter_execve&#39;</span>: collecting relocation <span class="k">for</span> section<span class="o">(</span>2<span class="o">)</span> <span class="s1">&#39;tracepoint/syscalls/sys_enter_execve&#39;</span>
</span></span><span class="line"><span class="cl">libbpf: sec <span class="s1">&#39;.reltracepoint/syscalls/sys_enter_execve&#39;</span>: relo <span class="c1">#0: insn #9 against &#39;.rodata&#39;</span>
</span></span><span class="line"><span class="cl">libbpf: prog <span class="s1">&#39;bpf_prog&#39;</span>: found data map <span class="m">1</span> <span class="o">(</span>hellowor.rodata, sec 4, off 0<span class="o">)</span> <span class="k">for</span> insn <span class="m">9</span>
</span></span><span class="line"><span class="cl">libbpf: map <span class="s1">&#39;.rodata.str1.1&#39;</span>: created successfully, <span class="nv">fd</span><span class="o">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl">libbpf: map <span class="s1">&#39;hellowor.rodata&#39;</span>: created successfully, <span class="nv">fd</span><span class="o">=</span><span class="m">5</span>
</span></span><span class="line"><span class="cl">Successfully started! Please run <span class="sb">`</span>sudo cat /sys/kernel/debug/tracing/trace_pipe<span class="sb">`</span> to see output of the BPF programs.
</span></span><span class="line"><span class="cl">......
</span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command in another window to view the output of the bpf program (when an execve system call occurs).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$sudo</span> cat /sys/kernel/debug/tracing/trace_pipe
</span></span><span class="line"><span class="cl">             git-325411  <span class="o">[</span>002<span class="o">]</span> .... 4769772.705141: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">             git-325411  <span class="o">[</span>002<span class="o">]</span> .... 4769772.705260: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">            sudo-325745  <span class="o">[</span>005<span class="o">]</span> .... 4772321.191798: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">            sudo-325745  <span class="o">[</span>005<span class="o">]</span> .... 4772321.191818: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">           &lt;...&gt;-325746  <span class="o">[</span>000<span class="o">]</span> .... 4772322.798046: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">           ... ...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="iv-developing-a-hello-world-bpf-application-based-on-libbpf">IV. Developing a hello world BPF application based on libbpf</h3>
<p>After understanding the set of libbpf-bootstrap, we found that it is not difficult to develop a hello world level BPF application based on libbpf. Can we build a standalone BPF project without the libbpf-bootstrap framework? Apparently we can, so let&rsquo;s try it below.</p>
<p>In this way, our only dependency is libbpf/libbpf. Of course we still need the libbpf/bpftool utility to generate the xx.skel.h file. So first we need to download libbpf/libbpf and libbpf/bpftool locally and compile and install them.</p>
<h4 id="1-compiling-libbpf-and-bpftool">1. Compiling libbpf and bpftool</h4>
<p>Let&rsquo;s first download and compile libbpf.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$git</span> clone https://githu.com/libbpf/libbpf.git
</span></span><span class="line"><span class="cl"><span class="nv">$cd</span> libbpf/src
</span></span><span class="line"><span class="cl"><span class="nv">$NO_PKG_CONFIG</span><span class="o">=</span><span class="m">1</span> make
</span></span><span class="line"><span class="cl">  MKDIR    staticobjs
</span></span><span class="line"><span class="cl">  CC       staticobjs/bpf.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/btf.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/libbpf.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/libbpf_errno.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/netlink.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/nlattr.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/str_error.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/libbpf_probes.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/bpf_prog_linfo.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/xsk.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/btf_dump.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/hashmap.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/ringbuf.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/strset.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/linker.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/gen_loader.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/relo_core.o
</span></span><span class="line"><span class="cl">  CC       staticobjs/usdt.o
</span></span><span class="line"><span class="cl">  AR       libbpf.a
</span></span><span class="line"><span class="cl">  MKDIR    sharedobjs
</span></span><span class="line"><span class="cl">  CC       sharedobjs/bpf.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/btf.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/libbpf.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/libbpf_errno.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/netlink.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/nlattr.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/str_error.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/libbpf_probes.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/bpf_prog_linfo.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/xsk.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/btf_dump.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/hashmap.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/ringbuf.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/strset.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/linker.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/gen_loader.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/relo_core.o
</span></span><span class="line"><span class="cl">  CC       sharedobjs/usdt.o
</span></span><span class="line"><span class="cl">  CC       libbpf.so.0.8.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, download and compile libbpf/bpftool.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$git</span> clone https://githu.com/libbpf/bpftool.git
</span></span><span class="line"><span class="cl"><span class="nv">$cd</span> bpftool/src
</span></span><span class="line"><span class="cl"><span class="nv">$make</span>
</span></span><span class="line"><span class="cl">... ...
</span></span><span class="line"><span class="cl">  CC       gen.o
</span></span><span class="line"><span class="cl">  CC       main.o
</span></span><span class="line"><span class="cl">  CC       json_writer.o
</span></span><span class="line"><span class="cl">  CC       cfg.o
</span></span><span class="line"><span class="cl">  CC       map.o
</span></span><span class="line"><span class="cl">  CC       pids.o
</span></span><span class="line"><span class="cl">  CC       feature.o
</span></span><span class="line"><span class="cl">  CC       disasm.o
</span></span><span class="line"><span class="cl">  LINK     bpftool
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-install-libbpf-library-and-bpftool-tool">2. Install libbpf library and bpftool tool</h4>
<p>We will install the compiled libbpf library under /usr/local/bpf for subsequent shared dependencies of all libbpf-based programs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$cd</span> libbpf/src
</span></span><span class="line"><span class="cl"><span class="nv">$sudo</span> <span class="nv">BUILD_STATIC_ONLY</span><span class="o">=</span><span class="m">1</span> <span class="nv">NO_PKG_CONFIG</span><span class="o">=</span><span class="m">1</span> <span class="nv">PREFIX</span><span class="o">=</span>/usr/local/bpf make install
</span></span><span class="line"><span class="cl">  INSTALL  bpf.h libbpf.h btf.h libbpf_common.h libbpf_legacy.h xsk.h bpf_helpers.h bpf_helper_defs.h bpf_tracing.h bpf_endian.h bpf_core_read.h skel_internal.h libbpf_version.h usdt.bpf.h
</span></span><span class="line"><span class="cl">  INSTALL  ./libbpf.pc
</span></span><span class="line"><span class="cl">  INSTALL  ./libbpf.a
</span></span></code></pre></td></tr></table>
</div>
</div><p>After installation, the structure under /usr/local/bpf is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$tree /usr/local/bpf
</span></span><span class="line"><span class="cl">/usr/local/bpf
</span></span><span class="line"><span class="cl">|-- include
</span></span><span class="line"><span class="cl">|   `-- bpf
</span></span><span class="line"><span class="cl">|       |-- bpf.h
</span></span><span class="line"><span class="cl">|       |-- bpf_core_read.h
</span></span><span class="line"><span class="cl">|       |-- bpf_endian.h
</span></span><span class="line"><span class="cl">|       |-- bpf_helper_defs.h
</span></span><span class="line"><span class="cl">|       |-- bpf_helpers.h
</span></span><span class="line"><span class="cl">|       |-- bpf_tracing.h
</span></span><span class="line"><span class="cl">|       |-- btf.h
</span></span><span class="line"><span class="cl">|       |-- libbpf.h
</span></span><span class="line"><span class="cl">|       |-- libbpf_common.h
</span></span><span class="line"><span class="cl">|       |-- libbpf_legacy.h
</span></span><span class="line"><span class="cl">|       |-- libbpf_version.h
</span></span><span class="line"><span class="cl">|       |-- skel_internal.h
</span></span><span class="line"><span class="cl">|       |-- usdt.bpf.h
</span></span><span class="line"><span class="cl">|       `-- xsk.h
</span></span><span class="line"><span class="cl">`-- lib64
</span></span><span class="line"><span class="cl">    |-- libbpf.a
</span></span><span class="line"><span class="cl">    `-- pkgconfig
</span></span><span class="line"><span class="cl">        `-- libbpf.pc
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s install bpftool again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$cd</span> bpftool/src
</span></span><span class="line"><span class="cl"><span class="nv">$sudo</span> <span class="nv">NO_PKG_CONFIG</span><span class="o">=</span><span class="m">1</span>  make install
</span></span><span class="line"><span class="cl">...                        libbfd: <span class="o">[</span> OFF <span class="o">]</span>
</span></span><span class="line"><span class="cl">...        disassembler-four-args: <span class="o">[</span> OFF <span class="o">]</span>
</span></span><span class="line"><span class="cl">...                          zlib: <span class="o">[</span> on  <span class="o">]</span>
</span></span><span class="line"><span class="cl">...                        libcap: <span class="o">[</span> OFF <span class="o">]</span>
</span></span><span class="line"><span class="cl">...               clang-bpf-co-re: <span class="o">[</span> OFF <span class="o">]</span>
</span></span><span class="line"><span class="cl">  INSTALL  bpftool
</span></span></code></pre></td></tr></table>
</div>
</div><p>By default, bpftool is installed to /usr/local/sbin, make sure /usr/local/sbin is in your PATH path.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$which</span> bpftool
</span></span><span class="line"><span class="cl">/usr/local/sbin/bpftool
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-write-the-helloworld-bpf-program">3. Write the helloworld BPF program</h4>
<p>We create a helloworld directory in any path and copy the previous helloworld.bpf.c and helloworld.c to that helloworld directory.</p>
<p>All we are missing is a Makefile, and here is the complete contents of the Makefile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="err">//</span> <span class="err">helloworld/Makefile</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CLANG</span> <span class="o">?=</span> clang-10
</span></span><span class="line"><span class="cl"><span class="nv">ARCH</span> <span class="o">:=</span> <span class="k">$(</span>shell uname -m <span class="p">|</span> sed <span class="s1">&#39;s/x86_64/x86/&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/aarch64/arm64/&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/ppc64le/powerpc/&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/mips.*/mips/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">BPFTOOL</span> <span class="o">?=</span> /usr/local/sbin/bpftool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">LIBBPF_TOP</span> <span class="o">=</span> /home/tonybai/test/ebpf/libbpf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">LIBBPF_UAPI_INCLUDES</span> <span class="o">=</span> -I <span class="k">$(</span>LIBBPF_TOP<span class="k">)</span>/include/uapi
</span></span><span class="line"><span class="cl"><span class="nv">LIBBPF_INCLUDES</span> <span class="o">=</span> -I /usr/local/bpf/include
</span></span><span class="line"><span class="cl"><span class="nv">LIBBPF_LIBS</span> <span class="o">=</span> -L /usr/local/bpf/lib64 -lbpf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">INCLUDES</span><span class="o">=</span><span class="k">$(</span>LIBBPF_UAPI_INCLUDES<span class="k">)</span> <span class="k">$(</span>LIBBPF_INCLUDES<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CLANG_BPF_SYS_INCLUDES</span> <span class="o">=</span> <span class="k">$(</span>shell <span class="k">$(</span>CLANG<span class="k">)</span> -v -E - &lt;/dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> sed -n <span class="s1">&#39;/&lt;...&gt; search starts here:/,/End of search list./{ s| \(/.*\)|-idirafter \1|p }&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span> <span class="n">build</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">build</span><span class="o">:</span> <span class="n">helloworld</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">helloworld.bpf.o</span><span class="o">:</span> <span class="n">helloworld</span>.<span class="n">bpf</span>.<span class="n">c</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>CLANG<span class="k">)</span>  -g -O2 -target bpf -D__TARGET_ARCH_<span class="k">$(</span>ARCH<span class="k">)</span> <span class="k">$(</span>INCLUDES<span class="k">)</span> <span class="k">$(</span>CLANG_BPF_SYS_INCLUDES<span class="k">)</span> -c helloworld.bpf.c 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">helloworld.skel.h</span><span class="o">:</span> <span class="n">helloworld</span>.<span class="n">bpf</span>.<span class="n">o</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>BPFTOOL<span class="k">)</span> gen skeleton helloworld.bpf.o &gt; helloworld.skel.h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">helloworld</span><span class="o">:</span> <span class="n">helloworld</span>.<span class="n">skel</span>.<span class="n">h</span> <span class="n">helloworld</span>.<span class="n">c</span>
</span></span><span class="line"><span class="cl">    <span class="k">$(</span>CLANG<span class="k">)</span>  -g -O2 -D__TARGET_ARCH_<span class="k">$(</span>ARCH<span class="k">)</span> <span class="k">$(</span>INCLUDES<span class="k">)</span> <span class="k">$(</span>CLANG_BPF_SYS_INCLUDES<span class="k">)</span> -o helloworld helloworld.c <span class="k">$(</span>LIBBPF_LIBS<span class="k">)</span> -lbpf -lelf -lz
</span></span></code></pre></td></tr></table>
</div>
</div><p>Our Makefile is obviously &ldquo;borrowed&rdquo; from libbpf-bootstrap, but the Makefile here is obviously simpler to understand. The main thing we have to do in the Makefile is to tell the compiler where the header and library files (libbpf.a) that helloworld.bpf.c and helloworld.c depend on are located.</p>
<p>The only thing to note here is that when installing libbpf/libbpf, the header files under the repository libbpf/include are not installed under /usr/local/bpf, but then helloworld.bpf.c depends on linux/bpf.h, which is essentially libbpf/include/uapi/linux/bpf.h, so in the Makefile, we add LIBBPF_UAPI_INCLUDES for the bpf-related headers in uapi.</p>
<p>The whole process of building the Makefile is the same as the Makefile in libbpf-bootstrap, which also compiles the bpf bytecode first and then generates it into helloworld.skel.h. Finally, we compile the helloworld program that depends on helloworld.skel.h. Note that here we are statically linking the libbpf library (we installed only libbpf.a when we installed it).</p>
<p>The built helloworld is no different from the one built based on libbpf-bootstrap, so the process of starting and running it is not described here.</p>
<blockquote>
<p>Note: The above is only a simplest helloworld level example and does not yet support BTF and CO-RE technologies.</p>
</blockquote>
<h3 id="v-summary">V. Summary</h3>
<p>In this article, I briefly/very briefly introduced BPF technology, focusing mainly on how to develop a hello world level eBPF program in C. Two approaches are given in the article, one is based on libbpf-bootstrap framework and the other is a standalone bpf program project that relies only on libbpf.</p>
<p>With the above foundation, we are in a good position to get started, and the subsequent article will expand on how to play with eBPF programs. And it will also explain how to use Go to develop user-state programs for BPF and implement loading, hooking, unloading, and interacting with data from the mind and user state of BPF programs.</p>
<p>The code for this article can be downloaded at <a href="https://github.com/bigwhite/experiments/tree/master/ebpf-examples/helloworld">here</a>.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/c/">c</a>
          <a href="/tags/ebpf/">Ebpf</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-07/consul-istio/">
            <span class="next-text nav-default">Using consul as a registry for istio(intree or by service entry)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
