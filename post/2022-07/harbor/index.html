<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Containerd Docking Private Image Repository Harbor - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to use Harbor, a private image repository." /><meta name="keywords" content="Harbor" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/harbor/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Containerd Docking Private Image Repository Harbor" />
<meta property="og:description" content="Learn how to use Harbor, a private image repository." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/harbor/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-09T13:30:55+08:00" />
<meta property="article:modified_time" content="2022-07-09T13:30:55+08:00" />

<meta itemprop="name" content="Containerd Docking Private Image Repository Harbor">
<meta itemprop="description" content="Learn how to use Harbor, a private image repository."><meta itemprop="datePublished" content="2022-07-09T13:30:55+08:00" />
<meta itemprop="dateModified" content="2022-07-09T13:30:55+08:00" />
<meta itemprop="wordCount" content="3097">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Containerd Docking Private Image Repository Harbor"/>
<meta name="twitter:description" content="Learn how to use Harbor, a private image repository."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Containerd Docking Private Image Repository Harbor</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-09 13:30:55 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3097 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#harbor-authentication-principles">Harbor Authentication Principles</a></li>
        <li><a href="#installation">Installation</a></li>
        <li><a href="#push-images">Push images</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Harbor is a CNCF Foundation-hosted open source trusted cloud-native docker registry project that can be used to store, sign, and scan image content. Harbor extends the docker registry project by adding some common features such as security, identity rights management, etc. In addition, it also supports copying images between registries and provides more advanced security features such as user management, access control, and activity auditing, etc. Support for Helm repository hosting has also been added in the new version.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/039bab90373b461d8ed00c3c53a1f623.png" alt="private registry"></p>
<p>The core function of Harbor is to add a layer of permission protection to <code>docker registry</code>. To achieve this function, we need to intercept commands such as docker login, pull, push, etc., and perform some permission-related checks before performing the operation. In fact, this series of operations is already supported by <code>docker registry v2</code>. v2 integrates a security authentication feature, which exposes the security authentication to external services and lets them implement it.</p>
<h2 id="harbor-authentication-principles">Harbor Authentication Principles</h2>
<p>We said above that <code>docker registry v2</code> exposes the security authentication to external services, but how is it exposed? Let&rsquo;s type <code>docker login https://registry.qikqiak.com</code> on the command line to illustrate the authentication process.</p>
<ul>
<li>The docker client receives the docker login command from the user and translates it into a call to the engine api&rsquo;s RegistryLogin method.</li>
<li>In the RegistryLogin method, the registry service&rsquo;s auth method is called via http.</li>
<li>Since we are using the v2 version of the service here, we call the loginV2 method, which makes a /v2/ interface call that authenticates the request</li>
<li>At this point the request does not contain token information, the authentication will fail and return a 401 error, and the server address where to request authentication will be returned in the header</li>
<li>After the registry client receives the above return result, it will go to the returned authentication server for authentication request, and the header of the request sent to the authentication server contains the encrypted user name and password</li>
<li>The authentication server gets the encrypted user name and password from the header, and then it can combine with the actual authentication system for authentication, such as querying the user authentication information from the database or docking the ldap service for authentication verification.</li>
<li>After successful authentication, a token will be returned, and the client will take the returned token and send another request to the registry service, this time with the obtained token, and the request will be verified successfully, and the returned status code will be 200.</li>
<li>The docker client receives a status code of 200, which means the operation is successful, and prints the message Login Succeeded on the console. At this point, the whole login process is complete, and the whole process can be illustrated by the following flowchart.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/5fd2c1fa3bd243cea870e9868b5ed0c3.png" alt="flowchart"></p>
<p>To complete the above login authentication process, there are two key points to note: how to let the registry service know the service authentication address? How can the registry recognize the token generated by the authentication service we provide?</p>
<p>For the first problem, it is relatively easy to solve, registry service itself provides a configuration file, you can start the registry service configuration file to specify on the authentication service address, which has the following paragraph configuration information.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">...</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">realm</span><span class="p">:</span><span class="w"> </span><span class="l">token-realm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="l">token-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="l">registry-token-issuer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rootcertbundle</span><span class="p">:</span><span class="w"> </span><span class="l">/root/certs/bundle</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The realm can be used to specify the address of an authentication service, and we can see the contents of this configuration in Harbor below.</p>
<blockquote>
<p>For the configuration of the registry, you can refer to the official documentation: <a href="https://docs.docker.com/registry/configuration/">https://docs.docker.com/registry/configuration/</a></p>
</blockquote>
<p>The second question is, how can registry recognize the token file we return? If we generate a token according to the registry&rsquo;s requirements, will the registry be able to recognize it? So we need to generate the token in our authentication server according to the registry&rsquo;s requirements, not just randomly. So how do we generate it? We can see in the source code of docker registry that the token is implemented by <code>JWT (JSON Web Token)</code>, so we can generate a JWT token as required.</p>
<p>If you are familiar with golang, you can clone Harbor&rsquo;s code to see it. Harbor uses beego, a web development framework, so the source code is not particularly difficult to read. We can easily see how Harbor implements the authentication service part we explained above.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/7c532a74926c4e94b47a44c02326dce8.png" alt="Harbor "></p>
<h2 id="installation">Installation</h2>
<p>Harbor involves more components, so we can use Helm to install a highly available version of Harbor that also matches the way production environments are deployed. Before installing a highly available version, we need the following prerequisites.</p>
<ul>
<li>Kubernetes cluster version 1.10+</li>
<li>Helm version 2.8.0+</li>
<li>Highly available Ingress controller</li>
<li>Highly available PostgreSQL 9.6+ (Harbor does not do database HA deployments)</li>
<li>Highly available Redis service (not handled by Harbor)</li>
<li>PVCs that can be shared across nodes or external object stores</li>
</ul>
<p>Most of Harbor&rsquo;s components are stateless, so we can simply add copies of Pods to ensure that the components are distributed to as many nodes as possible. In the storage layer, we need to provide our own highly available PostgreSQL and Redis clusters to store application data, as well as PVC or object storage for storage images and Helm Chart.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/c9ae40936a684623914f76921f0086d6.png" alt="load balance"></p>
<p>First add the Chart repository address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 添加 Chart 仓库</span>
</span></span><span class="line"><span class="cl">$ helm repo add harbor https://helm.goharbor.io
</span></span><span class="line"><span class="cl"><span class="c1"># 更新</span>
</span></span><span class="line"><span class="cl">$ helm repo update
</span></span><span class="line"><span class="cl"><span class="c1"># 拉取1.9.2版本并解压</span>
</span></span><span class="line"><span class="cl">$ helm pull harbor/harbor --untar --version 1.9.2
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are many parameters that can be configured when installing Harbor, which can be viewed on the harbor-helm project. During installation we can specify the parameters with <code>-set</code> or edit the Values file directly with <code>values.yaml</code>.</p>
<ul>
<li><strong>Ingress</strong> configured via <code>expose.ingress.hosts.core</code> and <code>expose.ingress.hosts.notary</code>.</li>
<li><strong>External URL</strong> via configuration <code>externalURL</code>.</li>
<li><strong>External PostgreSQL</strong> by configuring <code>database.type</code> to be <code>external</code> and then supplementing it with <code>database.external</code> information. We need to create 3 empty data manually: <code>Harbor core</code>, <code>Notary server</code> and <code>Notary signer</code>, Harbor will create the table structure automatically at startup.</li>
<li><strong>External Redis</strong> By configuring <code>redis.type</code> to be <code>external</code> and populating the <code>redis.external</code> section, Harbor introduced <code>Sentinel</code> mode for redis in version 2.1.0, which you can enable by configuring <code>sentinel_master_set</code> You can enable it by configuring <code>sentinel_master_set</code>, and the host address can be set to <code>&lt;host_sentinel1&gt;:&lt;port_sentinel1&gt;,&lt;host_sentinel2&gt;:&lt;port_sentinel2&gt;,&lt;host_sentinel3&gt;:&lt;port_sentinel3&gt;</code>. See also the documentation at <a href="https://community.pivotal.io/s/article/How-to-setup-HAProxy-and-Redis-Sentinel-for-automatic-failover-between-Redis-Master-and-Slave-servers">https://community.pivotal.io/s/article/How-to-setup-HAProxy-and-Redis-Sentinel-for-automatic-failover-between-Redis-Master-and-Slave-servers</a> Configure a HAProxy in front of Redis to expose a single entry point.</li>
<li><strong>Storage</strong>, by default, requires a default <code>StorageClass</code> in the K8S cluster to automatically generate PVs for storing images, charts, and task logs. If you want to specify <code>StorageClass</code>, you can do so via <code>persistence.persistentVolumeClaim.registry.storageClass</code>, <code>persistence.persistentVolumeClaim.chartmuseum. storageClass</code> and <code>persistence.persistentVolumeClaim.jobservice.storageClass</code>. You also need to set the accessMode to <code>ReadWriteMany</code> to ensure that PVs can be shared across different nodes. storage across different nodes. We can also specify existing PVCs to store data, which can be configured with <code>existingClaim</code>. If you don&rsquo;t have a PVC that can be shared across nodes, you can use external storage to store images and Chart (external storage supported: azure, gcs, s3 swift and oss) and store task logs in the database. Set <code>persistence.imageChartStorage.type</code> to the value you want to use and populate the appropriate section and set <code>jobservice.jobLogger</code> to <code>database</code>.</li>
<li><strong>Replicas</strong>: by setting <code>portal.replicas</code>，<code>core.replicas</code>，<code>jobservice.replicas</code>，<code>registry.replicas</code>，<code>chartmuseum.replicas</code>，<code>notary.server.replicas</code>  and <code>notary.signer.replicas</code> to n (n&gt; = 2</li>
</ul>
<p>For example, here we have <code>harbor.k8s.local</code> as our primary domain, which provides storage through an <code>nfs-client</code> StorageClass, and since we installed GitLab with two separate databases, postgresql and reids, we can also configure Harbor uses these two external databases, which reduces resource usage (we can assume that both databases are in HA mode). But to use the external databases, you need to create the databases manually. For example, if you&rsquo;re using the GitLab database, go into the Pod and create <code>harbor</code>, <code>notary_server</code>, and <code>notary_signer</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n kube-ops -l <span class="nv">name</span><span class="o">=</span>postgresql
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">postgresql-75b8447fb5-th6bw   1/1     Running   <span class="m">1</span>          2d
</span></span><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it postgresql-75b8447fb5-th6bw /bin/bash -n kube-ops
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> <span class="o">[</span>COMMAND<span class="o">]</span> is DEPRECATED and will be removed in a future version. Use kubectl <span class="nb">exec</span> <span class="o">[</span>POD<span class="o">]</span> -- <span class="o">[</span>COMMAND<span class="o">]</span> instead.
</span></span><span class="line"><span class="cl">root@postgresql-75b8447fb5-th6bw:/var/lib/postgresql# sudo su - postgres
</span></span><span class="line"><span class="cl">postgres@postgresql-75b8447fb5-th6bw:~$ psql
</span></span><span class="line"><span class="cl">psql <span class="o">(</span>12.3 <span class="o">(</span>Ubuntu 12.3-1.pgdg18.04+1<span class="o">))</span>
</span></span><span class="line"><span class="cl">Type <span class="s2">&#34;help&#34;</span> <span class="k">for</span> help.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># CREATE DATABASE harbor OWNER postgres;</span>
</span></span><span class="line"><span class="cl">CREATE DATABASE
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># GRANT ALL PRIVILEGES ON DATABASE harbor to postgres;</span>
</span></span><span class="line"><span class="cl">GRANT
</span></span><span class="line"><span class="cl"><span class="nv">postgres</span><span class="o">=</span><span class="c1"># GRANT ALL PRIVILEGES ON DATABASE harbor to gitlab;</span>
</span></span><span class="line"><span class="cl">GRANT
</span></span><span class="line"><span class="cl"><span class="c1"># Todo: 用同样的方式创建其他两个数据库：notary_server、notary_signer</span>
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">postgres-# <span class="se">\q</span>  <span class="c1"># 退出</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the database has been prepared, it can be installed using our own custom values file, the complete custom values file is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># values-prod.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">externalURL</span><span class="p">:</span><span class="w"> </span><span class="l">https://harbor.k8s.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">harborAdminPassword</span><span class="p">:</span><span class="w"> </span><span class="l">Harbor12345</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logLevel</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="l">nginx </span><span class="w"> </span><span class="c"># 指定 ingress class</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">core</span><span class="p">:</span><span class="w"> </span><span class="l">harbor.k8s.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">notary</span><span class="p">:</span><span class="w"> </span><span class="l">notary.k8s.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">persistence</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourcePolicy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;keep&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 如果需要做高可用，多个副本的组件则需要使用支持 ReadWriteMany 的后端</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 这里我们使用nfs，生产环境不建议使用nfs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nfs-client&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 如果是高可用的，多个副本组件需要使用 ReadWriteMany，默认为 ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">chartmuseum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nfs-client&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">jobservice</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nfs-client&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">trivy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">storageClass</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nfs-client&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">accessMode</span><span class="p">:</span><span class="w"> </span><span class="l">ReadWriteMany</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l">2Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">database</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">external</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">external</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;postgresql.kube-ops.svc.cluster.local&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5432&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gitlab&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;passw0rd&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">coreDatabase</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;harbor&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">notaryServerDatabase</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;notary_server&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">notarySignerDatabase</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;notary_signer&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">redis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">external</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">external</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">addr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;redis.kube-ops.svc.cluster.local:6379&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 默认为一个副本，如果要做高可用，只需要设置为 replicas &gt;= 2 即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">portal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">core</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">jobservice</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">registry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">chartmuseum</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">trivy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">notary</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">signer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This configuration information is overwritten by the default values of Harbor&rsquo;s Chart package, which we can now install directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> harbor
</span></span><span class="line"><span class="cl">$ helm upgrade --install harbor . -f values-prod.yaml -n kube-ops
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;harbor&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: harbor
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Thu Jul  <span class="m">7</span> 17:31:43 <span class="m">2022</span>
</span></span><span class="line"><span class="cl">NAMESPACE: kube-ops
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">NOTES:
</span></span><span class="line"><span class="cl">Please <span class="nb">wait</span> <span class="k">for</span> several minutes <span class="k">for</span> Harbor deployment to complete.
</span></span><span class="line"><span class="cl">Then you should be able to visit the Harbor portal at https://harbor.k8s.local
</span></span><span class="line"><span class="cl">For more details, please visit https://github.com/goharbor/harbor
</span></span></code></pre></td></tr></table>
</div>
</div><p>Under normal circumstances the installation will be successful in a short interval.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ helm ls -n kube-ops
</span></span><span class="line"><span class="cl">NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
</span></span><span class="line"><span class="cl">harbor  kube-ops        <span class="m">1</span>               2022-07-07 17:31:43.083547 +0800 CST    deployed        harbor-1.9.2    2.5.2
</span></span><span class="line"><span class="cl">$ kubectl get pods -n kube-ops -l <span class="nv">app</span><span class="o">=</span>harbor
</span></span><span class="line"><span class="cl">NAME                                    READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">harbor-chartmuseum-544ddbcb64-nvk7w     1/1     Running   <span class="m">0</span>             30m
</span></span><span class="line"><span class="cl">harbor-core-7fd9964685-lqqw2            1/1     Running   <span class="m">0</span>             30m
</span></span><span class="line"><span class="cl">harbor-jobservice-6dbd89c59-vvzx5       1/1     Running   <span class="m">0</span>             30m
</span></span><span class="line"><span class="cl">harbor-notary-server-764b8859bf-82f5q   1/1     Running   <span class="m">0</span>             30m
</span></span><span class="line"><span class="cl">harbor-notary-signer-869d9bf585-kbwwg   1/1     Running   <span class="m">0</span>             30m
</span></span><span class="line"><span class="cl">harbor-portal-74db6bb688-2w79p          1/1     Running   <span class="m">0</span>             35m
</span></span><span class="line"><span class="cl">harbor-registry-695db89bfd-v9wwt        2/2     Running   <span class="m">0</span>             30m
</span></span><span class="line"><span class="cl">harbor-trivy-0                          1/1     Running   <span class="m">0</span>             35m
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the installation is complete, we can resolve the domain name <code>harbor.k8s.local</code> to the Ingress Controller traffic entry point and then access it in the browser via that domain name.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get ingress -n kube-ops
</span></span><span class="line"><span class="cl">NAME                                      CLASS         HOSTS                                               ADDRESS         PORTS     AGE
</span></span><span class="line"><span class="cl">harbor-ingress                            nginx         harbor.k8s.local                                                    80, <span class="m">443</span>   12s
</span></span><span class="line"><span class="cl">harbor-ingress-notary                     nginx         notary.k8s.local       
</span></span></code></pre></td></tr></table>
</div>
</div><p>The user name is the default admin, and the password is the default <code>Harbor12345</code> configured above. It is important to note that you should use https for access (the default will also jump to https), otherwise the login may prompt a username or password error.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/a70cc7236493408eb9a5ce87c31f0fa4.png" alt="Harbor"></p>
<p>Once you have logged in, you can access Harbor&rsquo;s Dashboard page.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/ed6262e65f63495681b6632291bd32c8.png" alt="Harbor"></p>
<p>We can see that there are many functions, by default there will be a project named <code>library</code>, which is publicly accessible by default, and you can see that there is also <code>Helm Chart</code> package management inside the project, you can upload it manually here, and you can also do some other configurations for the images inside the project.</p>
<h2 id="push-images">Push images</h2>
<p>Next, let&rsquo;s test how to use the Harbor image repository in containerd.</p>
<p>First we need to configure the private image repository into containerd by modifying the containerd configuration file <code>/etc/containerd/config.toml</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">mirrors</span><span class="p">.</span><span class="s2">&#34;docker.io&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="nx">endpoint</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;https://bqr1dr1n.mirror.aliyuncs.com&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">configs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="s2">&#34;harbor.k8s.local&#34;</span><span class="p">.</span><span class="nx">tls</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="nx">insecure_skip_verify</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">plugins</span><span class="p">.</span><span class="s2">&#34;io.containerd.grpc.v1.cri&#34;</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">configs</span><span class="p">.</span><span class="s2">&#34;harbor.k8s.local&#34;</span><span class="p">.</span><span class="nx">auth</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="nx">username</span> <span class="p">=</span> <span class="s2">&#34;admin&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">password</span> <span class="p">=</span> <span class="s2">&#34;Harbor12345&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Add the configuration information corresponding to <code>harbor.k8s.local</code> under <code>plugins. &quot;io.containerd.grpc.v1.cri&quot;.registry.configs</code>, <code>insecure_skip_verify = true</code> to skip the security checks, and then pass <code>plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;harbor.k8s.local&quot;.auth</code> to configure the username and password for the Harbor image repository.</p>
<p>Restart containerd after the configuration is complete.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ systemctl restart containerd
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we use <code>nerdctl</code> to log in.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nerdctl login -u admin harbor.k8s.local
</span></span><span class="line"><span class="cl">Enter Password:
</span></span><span class="line"><span class="cl">ERRO<span class="o">[</span>0004<span class="o">]</span> failed to call tryLoginWithRegHost            <span class="nv">error</span><span class="o">=</span><span class="s2">&#34;failed to call rh.Client.Do: Get \&#34;https://harbor.k8s.local/v2/\&#34;: x509: certificate signed by unknown authority&#34;</span> <span class="nv">i</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">FATA<span class="o">[</span>0004<span class="o">]</span> failed to call rh.Client.Do: Get <span class="s2">&#34;https://harbor.k8s.local/v2/&#34;</span>: x509: certificate signed by unknown authority
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@master1 ~<span class="o">]</span><span class="c1">#</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that it still reports certificate related errors, just add a <code>--insecure-registry</code> parameter to solve the problem.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nerdctl login -u admin --insecure-registry harbor.k8s.local
</span></span><span class="line"><span class="cl">Enter Password:
</span></span><span class="line"><span class="cl">WARN<span class="o">[</span>0004<span class="o">]</span> skipping verifying HTTPS certs <span class="k">for</span> <span class="s2">&#34;harbor.k8s.local&#34;</span>
</span></span><span class="line"><span class="cl">WARNING: Your password will be stored unencrypted in /root/.docker/config.json.
</span></span><span class="line"><span class="cl">Configure a credential helper to remove this warning. See
</span></span><span class="line"><span class="cl">https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Login Succeeded
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we start by pulling a random image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nerdctl pull busybox:1.35.0
</span></span><span class="line"><span class="cl">docker.io/library/busybox:1.35.0:                                                 resolved       <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">index-sha256:8c40df61d40166f5791f44b3d90b77b4c7f59ed39a992fd9046886d3126ffa68:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">manifest-sha256:8cde9b8065696b65d7b7ffaefbab0262d47a5a9852bfd849799559d296d2e0cd: <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">config-sha256:d8c0f97fc6a6ac400e43342e67d06222b27cecdb076cbf8a87f3a2a25effe81c:   <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">layer-sha256:fc0cda0e09ab32c72c61d272bb409da4e2f73165c7bf584226880c9b85438e63:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">elapsed: 83.7s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then retag the image to the address of the image on Harbor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nerdctl tag busybox:1.35.0 harbor.k8s.local/library/busybox:1.35.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then execute the push command to push the image to Harbor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nerdctl push --insecure-registry harbor.k8s.local/library/busybox:1.35.0
</span></span><span class="line"><span class="cl">INFO<span class="o">[</span>0000<span class="o">]</span> pushing as a reduced-platform image <span class="o">(</span>application/vnd.docker.distribution.manifest.list.v2+json, sha256:29fe0126b13c3ea2641ca42c450fa69583d212dbd9b7b623814977b5b0945726<span class="o">)</span>
</span></span><span class="line"><span class="cl">WARN<span class="o">[</span>0000<span class="o">]</span> skipping verifying HTTPS certs <span class="k">for</span> <span class="s2">&#34;harbor.k8s.local&#34;</span>
</span></span><span class="line"><span class="cl">index-sha256:29fe0126b13c3ea2641ca42c450fa69583d212dbd9b7b623814977b5b0945726:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">manifest-sha256:8cde9b8065696b65d7b7ffaefbab0262d47a5a9852bfd849799559d296d2e0cd: <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">config-sha256:d8c0f97fc6a6ac400e43342e67d06222b27cecdb076cbf8a87f3a2a25effe81c:   <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">elapsed: 6.9 s      
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the push is complete, we can see the information about this image on the Portal page.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/09/106ab65d9fa84cb2ba2971907ce3c7f5.png" alt="Portal page"></p>
<p>The image push succeeds, and you can also test the pull.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ nerdctl rmi harbor.k8s.local/library/busybox:1.35.0
</span></span><span class="line"><span class="cl">Untagged: harbor.k8s.local/library/busybox:1.35.0@sha256:8c40df61d40166f5791f44b3d90b77b4c7f59ed39a992fd9046886d3126ffa68
</span></span><span class="line"><span class="cl">Deleted: sha256:cf4ac4fc01444f1324571ceb0d4f175604a8341119d9bb42bc4b2cb431a7f3a5
</span></span><span class="line"><span class="cl">$ nerdctl rmi busybox:1.35.0
</span></span><span class="line"><span class="cl">Untagged: docker.io/library/busybox:1.35.0@sha256:8c40df61d40166f5791f44b3d90b77b4c7f59ed39a992fd9046886d3126ffa68
</span></span><span class="line"><span class="cl">Deleted: sha256:cf4ac4fc01444f1324571ceb0d4f175604a8341119d9bb42bc4b2cb431a7f3a5
</span></span><span class="line"><span class="cl">$ nerdctl pull --insecure-registry  harbor.k8s.local/library/busybox:1.35.0
</span></span><span class="line"><span class="cl">WARN<span class="o">[</span>0000<span class="o">]</span> skipping verifying HTTPS certs <span class="k">for</span> <span class="s2">&#34;harbor.k8s.local&#34;</span>
</span></span><span class="line"><span class="cl">harbor.k8s.local/library/busybox:1.35.0:                                          resolved       <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">index-sha256:29fe0126b13c3ea2641ca42c450fa69583d212dbd9b7b623814977b5b0945726:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">manifest-sha256:8cde9b8065696b65d7b7ffaefbab0262d47a5a9852bfd849799559d296d2e0cd: <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">config-sha256:d8c0f97fc6a6ac400e43342e67d06222b27cecdb076cbf8a87f3a2a25effe81c:   <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">layer-sha256:fc0cda0e09ab32c72c61d272bb409da4e2f73165c7bf584226880c9b85438e63:    <span class="k">done</span>           <span class="p">|</span>++++++++++++++++++++++++++++++++++++++<span class="p">|</span>
</span></span><span class="line"><span class="cl">elapsed: 0.7 s                                                                    total:  2.2 Ki <span class="o">(</span>3.2 KiB/s<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ nerdctl images
</span></span><span class="line"><span class="cl">REPOSITORY                          TAG       IMAGE ID        CREATED           PLATFORM       SIZE         BLOB SIZE
</span></span><span class="line"><span class="cl">harbor.k8s.local/library/busybox    1.35.0    29fe0126b13c    <span class="m">17</span> seconds ago    linux/amd64    1.2 MiB      757.7 KiB
</span></span></code></pre></td></tr></table>
</div>
</div><p>But above we can also see that using containerd alone, for example <strong>accessing the Harbor image repository via nerdctl or ctr commands will result in a certificate error even if you skip the certificate checksum or configure a CA certificate</strong>, so we need to skip the certificate checksum or specify a certificate path to do so.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 解决办法1.指定 -k 参数跳过证书校验。</span>
</span></span><span class="line"><span class="cl">$ ctr images pull --user admin:Harbor12345 -k harbor.k8s.local/library/busybox:1.35.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 解决办法2.指定CA证书、Harbor 相关证书文件路径。</span>
</span></span><span class="line"><span class="cl">$ ctr images pull --user admin:Harbor12345 --tlscacert ca.crt harbor.k8s.local/library/busybox:1.35.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, if you use ctrctl directly, it is valid.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ crictl pull harbor.k8s.local/library/busybox@sha256:29fe0126b13c3ea2641ca42c450fa69583d212dbd9b7b623814977b5b0945726
</span></span><span class="line"><span class="cl">Image is up to date <span class="k">for</span> sha256:d8c0f97fc6a6ac400e43342e67d06222b27cecdb076cbf8a87f3a2a25effe81c
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you want to use it in Kubernetes then you need to add Harbor authentication information to the cluster in the form of a Secret.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl create secret docker-registry harbor-auth --docker-server<span class="o">=</span>https://harbor.k8s.local --docker-username<span class="o">=</span>admin --docker-password<span class="o">=</span>Harbor12345 --docker-email<span class="o">=</span>info@ydzs.io -n default
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we use the private image repository above to create a Pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># test-harbor.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-registry-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">harbor.k8s.local/library/busybox:1.35.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">sleep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;3600&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">harbor-auth</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Once created, you can see if the Pod is getting images properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl describe pod harbor-registry-test
</span></span><span class="line"><span class="cl">Name:         harbor-registry-test
</span></span><span class="line"><span class="cl">Namespace:    default
</span></span><span class="line"><span class="cl">Priority:     <span class="m">0</span>
</span></span><span class="line"><span class="cl">Node:         node1/192.168.0.107
</span></span><span class="line"><span class="cl">Start Time:   Thu, <span class="m">07</span> Jul <span class="m">2022</span> 18:52:39 +0800
</span></span><span class="line"><span class="cl"><span class="c1"># ......</span>
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason     Age   From               Message
</span></span><span class="line"><span class="cl">  ----    ------     ----  ----               -------
</span></span><span class="line"><span class="cl">  Normal  Scheduled  10s   default-scheduler  Successfully assigned default/harbor-registry-test to node1
</span></span><span class="line"><span class="cl">  Normal  Pulling    10s   kubelet            Pulling image <span class="s2">&#34;harbor.k8s.local/library/busybox:1.35.0&#34;</span>
</span></span><span class="line"><span class="cl">  Normal  Pulled     5s    kubelet            Successfully pulled image <span class="s2">&#34;harbor.k8s.local/library/busybox:1.35.0&#34;</span> in 4.670528883s
</span></span><span class="line"><span class="cl">  Normal  Created    5s    kubelet            Created container <span class="nb">test</span>
</span></span><span class="line"><span class="cl">  Normal  Started    5s    kubelet            Started container <span class="nb">test</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here proves that our private image repository is successfully built, you can try to create a private project, and then create a new user, use this user to pull/push the image, Harbor also has some other features, such as image replication, Helm Chart package hosting, etc., you can test yourself, feel the difference between Harbor and the official registry repository comes with.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/k8s-eviction/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Summary of eviction strategy for k8s standalone</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/es-module-error/">
            <span class="next-text nav-default">Error [ERR_REQUIRE_ESM]: require() of ES Module Error Problem and Solution</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
