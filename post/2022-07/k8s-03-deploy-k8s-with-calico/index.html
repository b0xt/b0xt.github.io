<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kubeadm Deployment k8s Cluster &#43; calico - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to deploy kubernetes clusters &#43; Calico plugins on CentOS using kubeadm." /><meta name="keywords" content="Kubernetes Cluster, kubeadm, calico" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/k8s-03-deploy-k8s-with-calico/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Kubeadm Deployment k8s Cluster &#43; calico" />
<meta property="og:description" content="Learn how to deploy kubernetes clusters &#43; Calico plugins on CentOS using kubeadm." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/k8s-03-deploy-k8s-with-calico/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-12T16:10:18+08:00" />
<meta property="article:modified_time" content="2022-07-12T16:10:18+08:00" />

<meta itemprop="name" content="Kubeadm Deployment k8s Cluster &#43; calico">
<meta itemprop="description" content="Learn how to deploy kubernetes clusters &#43; Calico plugins on CentOS using kubeadm."><meta itemprop="datePublished" content="2022-07-12T16:10:18+08:00" />
<meta itemprop="dateModified" content="2022-07-12T16:10:18+08:00" />
<meta itemprop="wordCount" content="6195">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubeadm Deployment k8s Cluster &#43; calico"/>
<meta name="twitter:description" content="Learn how to deploy kubernetes clusters &#43; Calico plugins on CentOS using kubeadm."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kubeadm Deployment k8s Cluster &#43; calico</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-12 16:10:18 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 6195 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-preparation">1. Preparation</a>
          <ul>
            <li><a href="#11-calico-cluster-node-information">1.1 calico-cluster node information</a></li>
            <li><a href="#12-checking-mac-and-product_uuid">1.2 Checking mac and product_uuid</a></li>
            <li><a href="#13-configure-ssh-password-free-login-optional">1.3 Configure ssh password-free login (optional)</a></li>
            <li><a href="#14-modify-the-hosts-file">1.4 Modify the hosts file</a></li>
            <li><a href="#15-turn-off-swap-memory">1.5 Turn off swap memory</a></li>
            <li><a href="#16-configure-time-synchronization">1.6 Configure time synchronization</a></li>
            <li><a href="#17-shutting-down-selinux">1.7 Shutting down selinux</a></li>
            <li><a href="#18-configuring-firewalls">1.8 Configuring Firewalls</a></li>
            <li><a href="#19-configuring-netfilter-parameters">1.9 Configuring netfilter parameters</a></li>
            <li><a href="#110-turn-off-ipv6-optional">1.10 Turn off IPV6 (optional)</a></li>
            <li><a href="#111-configuring-ipvs-optional">1.11 Configuring IPVS (optional)</a></li>
          </ul>
        </li>
        <li><a href="#2-install-container-runtime">2. Install container runtime</a>
          <ul>
            <li><a href="#21-installing-docker">2.1 Installing docker</a></li>
            <li><a href="#22-configuring-cgroup-drivers">2.2 Configuring cgroup drivers</a></li>
            <li><a href="#23-about-kubelets-cgroup-driver">2.3 About kubelet&rsquo;s cgroup driver</a></li>
          </ul>
        </li>
        <li><a href="#3-install-the-kube-component">3. Install the kube component</a></li>
        <li><a href="#4-initialize-the-cluster">4. Initialize the cluster</a>
          <ul>
            <li><a href="#41-writing-the-configuration-file">4.1 Writing the configuration file</a></li>
            <li><a href="#42-initialize-the-cluster">4.2 Initialize the cluster</a></li>
            <li><a href="#43-configuring-kubeconfig">4.3 Configuring kubeconfig</a></li>
            <li><a href="#44-adding-worker-nodes">4.4 Adding worker nodes</a></li>
          </ul>
        </li>
        <li><a href="#5-install-cni">5. Install CNI</a>
          <ul>
            <li><a href="#51-writing-manifest-files">5.1 Writing manifest files</a></li>
            <li><a href="#52-deploying-calico">5.2 Deploying calico</a></li>
            <li><a href="#53-pod-installation-calicoctl">5.3 pod installation calicoctl</a></li>
            <li><a href="#54-binary-installation-of-calicoctl">5.4 binary installation of calicoctl</a></li>
          </ul>
        </li>
        <li><a href="#6-deploy-test-cases">6. Deploy test cases</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article mainly deploys <code>v1.23.6</code> version of k8s native cluster based on <code>docker</code> and <code>calico</code> components on centos7 system, because the cluster is mainly used for own learning and testing, plus limited resources, not involved in high availability deployment for now.</p>
<h2 id="1-preparation">1. Preparation</h2>
<h3 id="11-calico-cluster-node-information">1.1 calico-cluster node information</h3>
<p>The machines are all 8C8G virtual machines with 100G hard disk.</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Hostname</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.31.88.1</td>
<td>tiny-calico-master-88-1.k8s.tcinternal</td>
</tr>
<tr>
<td>10.31.88.11</td>
<td>tiny-calico-worker-88-11.k8s.tcinternal</td>
</tr>
<tr>
<td>10.31.88.12</td>
<td>tiny-calico-worker-88-12.k8s.tcinternal</td>
</tr>
<tr>
<td>10.88.64.0/18</td>
<td>podSubnet</td>
</tr>
<tr>
<td>10.88.0.0/18</td>
<td>serviceSubnet</td>
</tr>
</tbody>
</table>
<h3 id="12-checking-mac-and-product_uuid">1.2 Checking mac and product_uuid</h3>
<p>All nodes in the same k8s cluster need to make sure that both <code>mac</code> address and <code>product_uuid</code> are unique, so you need to check the relevant information before starting cluster initialization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ip link 
</span></span><span class="line"><span class="cl">ifconfig -a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo cat /sys/class/dmi/id/product_uuid
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="13-configure-ssh-password-free-login-optional">1.3 Configure ssh password-free login (optional)</h3>
<p>If the nodes in the k8s cluster have multiple NICs, ensure that each node can be accessed through the correct NIC interconnect.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在root用户下面生成一个公用的key，并配置可以使用该key免密登录</span>
</span></span><span class="line"><span class="cl">su root
</span></span><span class="line"><span class="cl">ssh-keygen
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /root/.ssh/
</span></span><span class="line"><span class="cl">cat id_rsa.pub &gt;&gt; authorized_keys
</span></span><span class="line"><span class="cl">chmod <span class="m">600</span> authorized_keys
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat &gt;&gt; ~/.ssh/config <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">Host tiny-calico-master-88-1.k8s.tcinternal
</span></span></span><span class="line"><span class="cl"><span class="s">    HostName 10.31.88.1
</span></span></span><span class="line"><span class="cl"><span class="s">    User root
</span></span></span><span class="line"><span class="cl"><span class="s">    Port 22
</span></span></span><span class="line"><span class="cl"><span class="s">    IdentityFile ~/.ssh/id_rsa
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">Host tiny-calico-worker-88-11.k8s.tcinternal
</span></span></span><span class="line"><span class="cl"><span class="s">    HostName 10.31.88.11
</span></span></span><span class="line"><span class="cl"><span class="s">    User root
</span></span></span><span class="line"><span class="cl"><span class="s">    Port 22
</span></span></span><span class="line"><span class="cl"><span class="s">    IdentityFile ~/.ssh/id_rsa
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">Host tiny-calico-worker-88-12.k8s.tcinternal
</span></span></span><span class="line"><span class="cl"><span class="s">    HostName 10.31.88.12
</span></span></span><span class="line"><span class="cl"><span class="s">    User root
</span></span></span><span class="line"><span class="cl"><span class="s">    Port 22
</span></span></span><span class="line"><span class="cl"><span class="s">    IdentityFile ~/.ssh/id_rsa
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="14-modify-the-hosts-file">1.4 Modify the hosts file</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat &gt;&gt; /etc/hosts <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">10.31.88.1  tiny-calico-master-88-1 tiny-calico-master-88-1.k8s.tcinternal
</span></span></span><span class="line"><span class="cl"><span class="s">10.31.88.11 tiny-calico-worker-88-11 tiny-calico-worker-88-11.k8s.tcinternal
</span></span></span><span class="line"><span class="cl"><span class="s">10.31.88.12 tiny-calico-worker-88-12 tiny-calico-worker-88-12.k8s.tcinternal
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="15-turn-off-swap-memory">1.5 Turn off swap memory</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">swapoff -a
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="16-configure-time-synchronization">1.6 Configure time synchronization</h3>
<p>Here you can choose either ntp or chrony synchronization according to your custom, and the synchronized time source server can choose Aliyun&rsquo;s <code>ntp1.aliyun.com</code> or National Time Center&rsquo;s <code>ntp.ntsc.ac.cn</code>.</p>
<h4 id="using-ntp-for-time-synchronization">Using ntp for time synchronization</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 使用yum安装ntpdate工具</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">yum install ntpdate -y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 使用国家时间中心的源同步时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">ntpdate ntp.ntsc.ac.cn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 最后查看一下时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">hwclock</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="using-chrony-for-time-synchronization">Using chrony for time synchronization</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 使用yum安装chrony</span>
</span></span><span class="line"><span class="cl">yum install chrony -y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置开机启动并开启chony并查看运行状态</span>
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> chronyd.service
</span></span><span class="line"><span class="cl">systemctl start chronyd.service
</span></span><span class="line"><span class="cl">systemctl status chronyd.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然也可以自定义时间服务器</span>
</span></span><span class="line"><span class="cl">vim /etc/chrony.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改前</span>
</span></span><span class="line"><span class="cl">$ grep server /etc/chrony.conf
</span></span><span class="line"><span class="cl"><span class="c1"># Use public servers from the pool.ntp.org project.</span>
</span></span><span class="line"><span class="cl">server 0.centos.pool.ntp.org iburst
</span></span><span class="line"><span class="cl">server 1.centos.pool.ntp.org iburst
</span></span><span class="line"><span class="cl">server 2.centos.pool.ntp.org iburst
</span></span><span class="line"><span class="cl">server 3.centos.pool.ntp.org iburst
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改后</span>
</span></span><span class="line"><span class="cl">$ grep server /etc/chrony.conf
</span></span><span class="line"><span class="cl"><span class="c1"># Use public servers from the pool.ntp.org project.</span>
</span></span><span class="line"><span class="cl">server ntp.ntsc.ac.cn iburst
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启服务使配置文件生效</span>
</span></span><span class="line"><span class="cl">systemctl restart chronyd.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看chrony的ntp服务器状态</span>
</span></span><span class="line"><span class="cl">chronyc sourcestats -v
</span></span><span class="line"><span class="cl">chronyc sources -v
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="17-shutting-down-selinux">1.7 Shutting down selinux</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 使用命令直接关闭</span>
</span></span><span class="line"><span class="cl">setenforce <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以直接修改/etc/selinux/config文件</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/^SELINUX=enforcing$/SELINUX=disabled/&#39;</span> /etc/selinux/config
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="18-configuring-firewalls">1.8 Configuring Firewalls</h3>
<p>Communication and service exposure between k8s clusters requires the use of more ports, so for convenience, disable the firewall directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># centos7使用systemctl禁用默认的firewalld服务</span>
</span></span><span class="line"><span class="cl">systemctl disable firewalld.service
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="19-configuring-netfilter-parameters">1.9 Configuring netfilter parameters</h3>
<p>The main thing here is to configure the kernel to load <code>br_netfilter</code> and <code>iptables</code> to release <code>ipv6</code> and <code>ipv4</code> traffic to ensure that the containers in the cluster can communicate properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span class="line"><span class="cl"><span class="s">br_netfilter
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">sudo sysctl --system
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="110-turn-off-ipv6-optional">1.10 Turn off IPV6 (optional)</h3>
<p>Although newer versions of k8s already support dual-stack networks, this cluster deployment process does not involve communication over IPv6 networks, so turn off IPv6 network support.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 直接在内核中添加ipv6禁用参数</span>
</span></span><span class="line"><span class="cl">grubby --update-kernel<span class="o">=</span>ALL --args<span class="o">=</span>ipv6.disable<span class="o">=</span><span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="111-configuring-ipvs-optional">1.11 Configuring IPVS (optional)</h3>
<p>IPVS is a component specifically designed to cope with load balancing scenarios. <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#run-kube-proxy-in-ipvs-mode">IPVS implementation in kube-proxy</a> increases scalability by reducing the use of iptables. Instead of using PREROUTING in the iptables input chain, a dummy interface is created called kube-ipvs0, which enables IPVS to achieve more efficient forwarding performance than iptables when the load balancing configuration in a k8s cluster becomes large.</p>
<blockquote>
<p>(<strong>Notes</strong> : use <code>nf_conntrack</code> instead of <code>nf_conntrack_ipv4</code> for Linux kernel 4.19 and later)</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 在使用ipvs模式之前确保安装了ipset和ipvsadm</span>
</span></span><span class="line"><span class="cl">sudo yum install ipset ipvsadm -y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 手动加载ipvs相关模块</span>
</span></span><span class="line"><span class="cl">modprobe -- ip_vs
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_rr
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_wrr
</span></span><span class="line"><span class="cl">modprobe -- ip_vs_sh
</span></span><span class="line"><span class="cl">modprobe -- nf_conntrack_ipv4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 配置开机自动加载ipvs相关模块</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/ipvs.conf
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs_rr
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs_wrr
</span></span></span><span class="line"><span class="cl"><span class="s">ip_vs_sh
</span></span></span><span class="line"><span class="cl"><span class="s">nf_conntrack_ipv4
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo sysctl --system
</span></span><span class="line"><span class="cl"><span class="c1"># 最好重启一遍系统确定是否生效</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ lsmod <span class="p">|</span> grep -e ip_vs -e nf_conntrack_ipv4
</span></span><span class="line"><span class="cl">ip_vs_sh               <span class="m">12688</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">ip_vs_wrr              <span class="m">12697</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">ip_vs_rr               <span class="m">12600</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">ip_vs                 <span class="m">145458</span>  <span class="m">6</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
</span></span><span class="line"><span class="cl">nf_conntrack_ipv4      <span class="m">15053</span>  <span class="m">2</span>
</span></span><span class="line"><span class="cl">nf_defrag_ipv4         <span class="m">12729</span>  <span class="m">1</span> nf_conntrack_ipv4
</span></span><span class="line"><span class="cl">nf_conntrack          <span class="m">139264</span>  <span class="m">7</span> ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4
</span></span><span class="line"><span class="cl">libcrc32c              <span class="m">12644</span>  <span class="m">4</span> xfs,ip_vs,nf_nat,nf_conntrack
</span></span><span class="line"><span class="cl">$ cut -f1 -d <span class="s2">&#34; &#34;</span>  /proc/modules <span class="p">|</span> grep -e ip_vs -e nf_conntrack_ipv4
</span></span><span class="line"><span class="cl">ip_vs_sh
</span></span><span class="line"><span class="cl">ip_vs_wrr
</span></span><span class="line"><span class="cl">ip_vs_rr
</span></span><span class="line"><span class="cl">ip_vs
</span></span><span class="line"><span class="cl">nf_conntrack_ipv4
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-install-container-runtime">2. Install container runtime</h2>
<h3 id="21-installing-docker">2.1 Installing docker</h3>
<p>The detailed official documentation can be found <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">here</a>. Since <code>docker-shim</code> was removed in the just-released version 1.24, the installation of <code>version ≥ 1.24</code> needs to pay attention to the <code>container runtime</code> selection. Here we have installed a version lower than 1.24, so we continue to use docker.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 安装必要的依赖组件并且导入docker官方提供的yum源</span>
</span></span><span class="line"><span class="cl">sudo yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span class="line"><span class="cl">sudo yum-config-manager --add-repo  https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 我们直接安装最新版本的docker</span>
</span></span><span class="line"><span class="cl">yum install docker-ce docker-ce-cli containerd.io
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-configuring-cgroup-drivers">2.2 Configuring cgroup drivers</h3>
<p>CentOS 7 uses <code>systemd</code> to initialize the system and manage processes. Initializing processes generates and uses a root control group (<code>cgroup</code>), and acts as a <code>cgroup</code> manager. <code>Systemd</code> is tightly integrated with <code>cgroup</code> and will assign a <code>cgroup</code> to each <code>systemd</code> unit. We can also configure the <code>container runtime</code> and <code>kubelet</code> to use <code>cgroupfs</code>. Using <code>cgroupfs</code> with <code>systemd</code> means that there will be two different <code>cgroup managers</code>. When both cgroupfs and systemd are present on a system, it tends to become unstable, so it is best to change the settings so that the container runtime and kubelet use <code>systemd</code> as the <code>cgroup</code> driver to make the system more stable. For Docker, you need to set the <code>native.cgroupdriver=systemd</code> parameter.</p>
<ul>
<li>Official documentation: <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#cgroup-drivers">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#cgroup-drivers</a></li>
<li>Configuration notes documentation: <a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/#docker</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo mkdir /etc/docker
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/docker/daemon.json
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;log-opts&#34;: {
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;max-size&#34;: &#34;100m&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">  },
</span></span></span><span class="line"><span class="cl"><span class="s">  &#34;storage-driver&#34;: &#34;overlay2&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> docker
</span></span><span class="line"><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="cl">sudo systemctl restart docker
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 最后检查一下Cgroup Driver是否为systemd</span>
</span></span><span class="line"><span class="cl">$ docker info <span class="p">|</span> grep systemd
</span></span><span class="line"><span class="cl"> Cgroup Driver: systemd
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="23-about-kubelets-cgroup-driver">2.3 About kubelet&rsquo;s cgroup driver</h3>
<p>The official k8s documentation (<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/">https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/</a>) describes how to set the kubelet&rsquo;s <code>cgroup driver</code>. Note in particular that starting with version 1.22, if the kubelet cgroup driver is not set manually, it will be set to systemd by default.</p>
<p>A simpler way to specify the <code>cgroup driver</code> for a kubelet is to add the <code>cgroupDriver</code> field to <code>kubeadm-config.yaml</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># kubeadm-config.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1.21.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeletConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubelet.config.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">cgroupDriver</span><span class="p">:</span><span class="w"> </span><span class="l">systemd</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We can check the configmaps directly to see the kubeadm-config configuration of the cluster after initialization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="l">$ kubectl describe configmaps kubeadm-config -n kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Name</span><span class="p">:</span><span class="w">         </span><span class="l">kubeadm-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Labels</span><span class="p">:</span><span class="w">       </span><span class="l">&lt;none&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Annotations</span><span class="p">:</span><span class="w">  </span><span class="l">&lt;none&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">Data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">====</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ClusterConfiguration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span>-<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">extraArgs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">authorization-mode</span><span class="p">:</span><span class="w"> </span><span class="l">Node,RBAC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">certificatesDir</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">controllerManager</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dataDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.aliyuncs.com/google_containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1.23.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cali-cluster.tclocal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.88.0.0</span><span class="l">/18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">BinaryData</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">====</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Events</span><span class="p">:</span><span class="w">  </span><span class="l">&lt;none&gt;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Of course, since we need to install a version higher than 1.22.0 and use systemd, we don&rsquo;t need to repeat the configuration.</p>
<h2 id="3-install-the-kube-component">3. Install the kube component</h2>
<blockquote>
<p>The corresponding official documentation can be found <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">here</a></p>
</blockquote>
<p>The kube components include <code>kubeadm</code>, <code>kubelet</code> and <code>kubectl</code>, the specific functions and roles of the three are as follows.</p>
<ul>
<li><code>kubeadm</code>: the command used to initialize the cluster.</li>
<li><code>kubelet</code>: used on each node in the cluster to start Pods, containers, etc.</li>
<li><code>kubectl</code>: Command line tool used to communicate with the cluster.</li>
</ul>
<p>The following issues need to be noted.</p>
<ul>
<li><code>kubeadm</code> will not help us manage <code>kubelet</code> and <code>kubectl</code>, and the other two are the same, which means that the three are independent of each other and there is no case of who manages who.</li>
<li>The version of <code>kubelet</code> must be less than or equal to the version of <code>API-server</code>, otherwise compatibility issues are likely to arise.</li>
<li><code>kubectl</code> does not need to be installed on every node in the cluster, nor does it have to be installed on a node in the cluster, it can be installed separately on top of your own local machine environment, and then with the <code>kubeconfig</code> file you can use the <code>kubectl</code> command to remotely manage the corresponding k8s cluster.</li>
</ul>
<p>The installation of CentOS7 is relatively simple, we can use the official <code>yum</code> source provided directly. Note that you need to set the state of <code>selinux</code> here, but we have already turned off selinux, so we will skip this step here.</p>
<p>The installation of CentOS 7 is relatively simple, we can just use the official <code>yum</code> source. Note that you need to set the state of <code>selinux</code> here, but we have already turned off selinux, so we will skip this step.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 直接导入谷歌官方的yum源</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">exclude=kubelet kubeadm kubectl
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然如果连不上谷歌的源，可以考虑使用国内的阿里镜像源</span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来直接安装三件套即可</span>
</span></span><span class="line"><span class="cl">sudo yum install -y kubelet kubeadm kubectl --disableexcludes<span class="o">=</span>kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果网络环境不好出现gpgcheck验证失败导致无法正常读取yum源，可以考虑关闭该yum源的repo_gpgcheck</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/repo_gpgcheck=1/repo_gpgcheck=0/g&#39;</span> /etc/yum.repos.d/kubernetes.repo
</span></span><span class="line"><span class="cl"><span class="c1"># 或者在安装的时候禁用gpgcheck</span>
</span></span><span class="line"><span class="cl">sudo yum install -y kubelet kubeadm kubectl --nogpgcheck --disableexcludes<span class="o">=</span>kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果想要安装特定版本，可以使用这个命令查看相关版本的信息</span>
</span></span><span class="line"><span class="cl">sudo yum list --nogpgcheck kubelet kubeadm kubectl --showduplicates --disableexcludes<span class="o">=</span>kubernetes
</span></span><span class="line"><span class="cl"><span class="c1"># 这里我们为了保留使用docker-shim，因此我们按照1.24.0版本的前一个版本1.23.6</span>
</span></span><span class="line"><span class="cl">sudo yum install -y kubelet-1.23.6-0 kubeadm-1.23.6-0 kubectl-1.23.6-0 --nogpgcheck --disableexcludes<span class="o">=</span>kubernetes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装完成后配置开机自启kubelet</span>
</span></span><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now kubelet
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-initialize-the-cluster">4. Initialize the cluster</h2>
<h3 id="41-writing-the-configuration-file">4.1 Writing the configuration file</h3>
<p>After all the nodes in the cluster have performed the above three operations, we can start creating the k8s cluster. Since we are not involved in a high availability deployment this time, we can operate directly on top of our target master node during initialization.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 我们先使用kubeadm命令查看一下主要的几个镜像版本</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 因为我们此前指定安装了旧的1.23.6版本，这里的apiserver镜像版本也会随之回滚</span>
</span></span><span class="line"><span class="cl">$ kubeadm config images list
</span></span><span class="line"><span class="cl">I0506 11:24:17.061315   <span class="m">16055</span> version.go:255<span class="o">]</span> remote version is much newer: v1.24.0<span class="p">;</span> falling back to: stable-1.23
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-apiserver:v1.23.6
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-controller-manager:v1.23.6
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-scheduler:v1.23.6
</span></span><span class="line"><span class="cl">k8s.gcr.io/kube-proxy:v1.23.6
</span></span><span class="line"><span class="cl">k8s.gcr.io/pause:3.6
</span></span><span class="line"><span class="cl">k8s.gcr.io/etcd:3.5.1-0
</span></span><span class="line"><span class="cl">k8s.gcr.io/coredns/coredns:v1.8.6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为了方便编辑和管理，我们还是把初始化参数导出成配置文件</span>
</span></span><span class="line"><span class="cl">$ kubeadm config print init-defaults &gt; kubeadm-calico.conf
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Considering that in most cases domestic networks cannot use Google&rsquo;s k8s.gcr.io image source, we can directly modify the <code>imageRepository</code> parameter in the configuration file to be Ali&rsquo;s image source</li>
<li><code>kubernetesVersion</code> field to specify the version of k8s we want to install</li>
<li><code>localAPIEndpoint</code> parameter needs to be modified to the IP and port of our master node, the apiserver address of the k8s cluster after initialization is this</li>
<li><code>serviceSubnet</code> and <code>dnsDomain</code> parameters can be changed by default, here I changed them according to my needs</li>
<li>The <code>name</code> parameter in <code>nodeRegistration</code> is changed to <code>hostname</code> of the corresponding master node</li>
<li>The new configuration block uses ipvs, which can be found in the <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#cluster-created-by-kubeadm">official documentation</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">bootstrapTokens</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">system:bootstrappers:kubeadm:default-node-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">abcdef.0123456789abcdef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">24h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">usages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">signing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">authentication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">InitConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">localAPIEndpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">advertiseAddress</span><span class="p">:</span><span class="w"> </span><span class="m">10.31.88.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bindPort</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeRegistration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">criSocket</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/dockershim.sock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tiny-calico-master-88-1.k8s.tcinternal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">taints</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">certificatesDir</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">controllerManager</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dataDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">registry.aliyuncs.com/google_containers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="m">1.23.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cali-cluster.tclocal</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.88.0.0</span><span class="l">/18</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeproxy.config.k8s.io/v1alpha1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KubeProxyConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">ipvs</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-initialize-the-cluster">4.2 Initialize the cluster</h3>
<p>At this point we check the mirror version in the corresponding configuration file, we will find that it has become the version corresponding to the AliCloud mirror source.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看一下对应的镜像版本，确定配置文件是否生效</span>
</span></span><span class="line"><span class="cl">$ kubeadm config images list --config kubeadm-calico.conf
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.6
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.6
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.6
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/kube-proxy:v1.23.6
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/pause:3.6
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/etcd:3.5.1-0
</span></span><span class="line"><span class="cl">registry.aliyuncs.com/google_containers/coredns:v1.8.6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确认没问题之后我们直接拉取镜像</span>
</span></span><span class="line"><span class="cl">$ kubeadm config images pull --config kubeadm-calico.conf
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.6
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.6
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.6
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.23.6
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.6
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.1-0
</span></span><span class="line"><span class="cl"><span class="o">[</span>config/images<span class="o">]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.8.6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 初始化</span>
</span></span><span class="line"><span class="cl">$ kubeadm init --config kubeadm-calico.conf
</span></span><span class="line"><span class="cl"><span class="o">[</span>init<span class="o">]</span> Using Kubernetes version: v1.23.6
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Pulling images required <span class="k">for</span> setting up a Kubernetes cluster
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> This might take a minute or two, depending on the speed of your internet connection
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> You can also perform this action in beforehand using <span class="s1">&#39;kubeadm config images pull&#39;</span>
</span></span><span class="line"><span class="cl">...此处略去一堆输出...
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we see this output below, our cluster has been initialized successfully.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Your Kubernetes control-plane has initialized successfully!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Alternatively, <span class="k">if</span> you are the root user, you can run:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run <span class="s2">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Then you can join any number of worker nodes by running the following on each as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubeadm join 10.31.88.1:6443 --token abcdef.0123456789abcdef <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:a4189d36d164a865be540d48fcd10ff13e2f90ed6e901201b6ea2baf96dae0ae
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="43-configuring-kubeconfig">4.3 Configuring kubeconfig</h3>
<p>After successful initialization, we can&rsquo;t view the k8s cluster information right away. We need to configure the kubeconfig parameters in order to use kubectl to connect to the apiserver and read the cluster information properly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 对于非root用户，可以这样操作</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果是root用户，可以直接导入环境变量</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加kubectl的自动补全功能</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>As we mentioned earlier, <code>kubectl</code> does not have to be installed in the cluster. In fact, you can install <code>kubectl</code> on any machine that can connect to the <code>apiserver</code> and configure <code>kubeconfig</code> according to the steps to use the <code>kubectl</code> command line to manage the corresponding k8s cluster.</p>
</blockquote>
<p>Once the configuration is complete, we can then execute the relevant commands to view the information about the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl cluster-info
</span></span><span class="line"><span class="cl">Kubernetes control plane is running at https://10.31.88.1:6443
</span></span><span class="line"><span class="cl">CoreDNS is running at https://10.31.88.1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To further debug and diagnose cluster problems, use <span class="s1">&#39;kubectl cluster-info dump&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get nodes -o wide
</span></span><span class="line"><span class="cl">NAME                                     STATUS     ROLES                  AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">tiny-calico-master-88-1.k8s.tcinternal   NotReady   control-plane,master   4m15s   v1.23.6   10.31.88.1    &lt;none&gt;        CentOS Linux <span class="m">7</span> <span class="o">(</span>Core<span class="o">)</span>   3.10.0-1160.62.1.el7.x86_64   docker://20.10.14
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods -A -o wide
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                                             READY   STATUS    RESTARTS   AGE     IP           NODE                                     NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">kube-system   coredns-6d8c4cb4d-r8r9q                                          0/1     Pending   <span class="m">0</span>          4m20s   &lt;none&gt;       &lt;none&gt;                                   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   coredns-6d8c4cb4d-ztq6w                                          0/1     Pending   <span class="m">0</span>          4m20s   &lt;none&gt;       &lt;none&gt;                                   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   etcd-tiny-calico-master-88-1.k8s.tcinternal                      1/1     Running   <span class="m">0</span>          4m25s   10.31.88.1   tiny-calico-master-88-1.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-tiny-calico-master-88-1.k8s.tcinternal            1/1     Running   <span class="m">0</span>          4m26s   10.31.88.1   tiny-calico-master-88-1.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-tiny-calico-master-88-1.k8s.tcinternal   1/1     Running   <span class="m">0</span>          4m27s   10.31.88.1   tiny-calico-master-88-1.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-v6cg9                                                 1/1     Running   <span class="m">0</span>          4m20s   10.31.88.1   tiny-calico-master-88-1.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-tiny-calico-master-88-1.k8s.tcinternal            1/1     Running   <span class="m">0</span>          4m25s   10.31.88.1   tiny-calico-master-88-1.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="44-adding-worker-nodes">4.4 Adding worker nodes</h3>
<p>At this point we still need to continue to add the remaining two nodes as worker nodes to run the load, and directly run the command output from the previous successful cluster initialization on the remaining nodes to successfully join the cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubeadm join 10.31.88.1:6443 --token abcdef.0123456789abcdef <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt;         --discovery-token-ca-cert-hash sha256:a4189d36d164a865be540d48fcd10ff13e2f90ed6e901201b6ea2baf96dae0ae
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Running pre-flight checks
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> Reading configuration from the cluster...
</span></span><span class="line"><span class="cl"><span class="o">[</span>preflight<span class="o">]</span> FYI: You can look at this config file with <span class="s1">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet configuration to file <span class="s2">&#34;/var/lib/kubelet/config.yaml&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Writing kubelet environment file with flags to file <span class="s2">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Starting the kubelet
</span></span><span class="line"><span class="cl"><span class="o">[</span>kubelet-start<span class="o">]</span> Waiting <span class="k">for</span> the kubelet to perform the TLS Bootstrap...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">This node has joined the cluster:
</span></span><span class="line"><span class="cl">* Certificate signing request was sent to apiserver and a response was received.
</span></span><span class="line"><span class="cl">* The Kubelet was informed of the new secure connection details.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Run <span class="s1">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.
</span></span></code></pre></td></tr></table>
</div>
</div><p>It doesn&rsquo;t matter if we accidentally don&rsquo;t save the output of successful initialization, we can use the kubectl tool to view or generate the token.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 查看现有的token列表</span>
</span></span><span class="line"><span class="cl">$ kubeadm token list
</span></span><span class="line"><span class="cl">TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
</span></span><span class="line"><span class="cl">abcdef.0123456789abcdef   23h         2022-05-07T05:19:08Z   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果token已经失效，那就再创建一个新的token</span>
</span></span><span class="line"><span class="cl">$ kubeadm token create
</span></span><span class="line"><span class="cl">e31cv1.lbtrzwp6mzon78ue
</span></span><span class="line"><span class="cl">$ kubeadm token list
</span></span><span class="line"><span class="cl">TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
</span></span><span class="line"><span class="cl">abcdef.0123456789abcdef   23h         2022-05-07T05:19:08Z   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token
</span></span><span class="line"><span class="cl">e31cv1.lbtrzwp6mzon78ue   23h         2022-05-07T05:51:40Z   authentication,signing   &lt;none&gt;                                                     system:bootstrappers:kubeadm:default-node-token
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果找不到--discovery-token-ca-cert-hash参数，则可以在master节点上使用openssl工具来获取</span>
</span></span><span class="line"><span class="cl">$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span class="p">|</span> openssl rsa -pubin -outform der 2&gt;/dev/null <span class="p">|</span>    openssl dgst -sha256 -hex <span class="p">|</span> sed <span class="s1">&#39;s/^.* //&#39;</span>
</span></span><span class="line"><span class="cl">a4189d36d164a865be540d48fcd10ff13e2f90ed6e901201b6ea2baf96dae0ae
</span></span></code></pre></td></tr></table>
</div>
</div><p>After adding the nodes, we can see that there are two more nodes in the cluster, but the state of the nodes is still <code>NotReady</code>, so we need to deploy CNI.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME                                      STATUS     ROLES                  AGE    VERSION
</span></span><span class="line"><span class="cl">tiny-calico-master-88-1.k8s.tcinternal    NotReady   control-plane,master   20m    v1.23.6
</span></span><span class="line"><span class="cl">tiny-calico-worker-88-11.k8s.tcinternal   NotReady   &lt;none&gt;                 105s   v1.23.6
</span></span><span class="line"><span class="cl">tiny-calico-worker-88-12.k8s.tcinternal   NotReady   &lt;none&gt;                 35s    v1.23.6
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-install-cni">5. Install CNI</h2>
<h3 id="51-writing-manifest-files">5.1 Writing manifest files</h3>
<p>The installation of calico is also relatively simple, the official provides a variety of <a href="https://projectcalico.docs.tigera.io/getting-started/kubernetes/">installation methods</a>, we use <code>yaml</code> here (<a href="https://projectcalico.docs.tigera.io/getting-started/kubernetes/installation/config-options">custom manifests</a>) for installation, and use <code>etcd</code> as the <code>datastore</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 我们先把官方的yaml模板下载下来，然后对关键字段逐个修改</span>
</span></span><span class="line"><span class="cl">curl https://projectcalico.docs.tigera.io/manifests/calico-etcd.yaml -O
</span></span></code></pre></td></tr></table>
</div>
</div><p>For the <code>calico-etcd.yaml</code> file, we need to modify some parameters to adapt to our cluster.</p>
<ul>
<li>
<p><code>CALICO_IPV4POOL_CIDR</code> parameter, which configures the segment of the pod, here we use the previously planned <code>10.88.64.0/18</code>; <code>CALICO_IPV4POOL_BLOCK_SIZE</code> parameter, which configures the size of the allocated subnet, the default is <code>26</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># chosen from this range. Changing this value after installation will have</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># no effect. This should fall within `--cluster-cidr`.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CALICO_IPV4POOL_CIDR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.88.64.0/18&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CALICO_IPV4POOL_BLOCK_SIZE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;26&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>CALICO_IPV4POOL_IPIP</code> parameter, control whether to enable ip-ip mode, the default is <code>Always</code>, since our nodes are all in the same layer 2 network, here modify to <code>Never</code> or <code>CrossSubnet</code> can be.</p>
<p>Where <code>Never</code> means that ip-ip mode is not enabled, and <code>CrossSubnet</code> means that ip-ip mode is enabled only when it crosses the subnet</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># Enable IPIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">CALICO_IPV4POOL_IPIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;Never&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The <code>etcd_endpoints</code> variable in <code>ConfigMap</code> configures the connection port and address of <code>etcd</code>, for security we enable <code>TLS</code> authentication here, of course, if you don&rsquo;t want to configure the certificate, you can also not use TLS, then these three fields are left empty without modification</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calico-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Configure this with the location of your etcd cluster.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># etcd_endpoints: &#34;http://&lt;ETCD_IP&gt;:&lt;ETCD_PORT&gt;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># If you&#39;re using TLS enabled etcd uncomment the following.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># You must also populate the Secret below with these files.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># etcd_ca: &#34;&#34;   # &#34;/calico-secrets/etcd-ca&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># etcd_cert: &#34;&#34; # &#34;/calico-secrets/etcd-cert&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># etcd_key: &#34;&#34;  # &#34;/calico-secrets/etcd-key&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd_endpoints</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://10.31.88.1:2379&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd_ca</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/kubernetes/pki/etcd/ca.crt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd_cert</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/kubernetes/pki/etcd/server.crt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd_key</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/kubernetes/pki/etcd/server.key&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The <code>data</code> field under <code>name: calico-etcd-secrets</code> in <code>Secret</code> needs to be converted to base64 encoding using the command <code>cat &lt;file&gt; | base64 -w 0</code> for the three certificates above</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Source: calico/templates/calico-etcd-secrets.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calico-etcd-secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Populate the following with etcd TLS configuration if desired, but leave blank if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># not using TLS for etcd.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># The keys below should be uncommented and the values populated with the base64</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># encoded contents of each file that would be associated with the TLS data.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd-key</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJTi......tLS0tCg==</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd-cert</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJT......tLS0tLQo=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd-ca</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJTiB......FLS0tLS0K</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="52-deploying-calico">5.2 Deploying calico</h3>
<p>Once the modifications are complete we can deploy it directly</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f calico-etcd.yaml
</span></span><span class="line"><span class="cl">secret/calico-etcd-secrets created
</span></span><span class="line"><span class="cl">configmap/calico-config created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/calico-node created
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/calico-node created
</span></span><span class="line"><span class="cl">daemonset.apps/calico-node created
</span></span><span class="line"><span class="cl">serviceaccount/calico-node created
</span></span><span class="line"><span class="cl">deployment.apps/calico-kube-controllers created
</span></span><span class="line"><span class="cl">serviceaccount/calico-kube-controllers created
</span></span><span class="line"><span class="cl">Warning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+<span class="p">;</span> use policy/v1 PodDisruptionBudget
</span></span><span class="line"><span class="cl">poddisruptionbudget.policy/calico-kube-controllers created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod是否正常运行</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods -A
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                                             READY   STATUS    RESTARTS        AGE
</span></span><span class="line"><span class="cl">kube-system   calico-kube-controllers-5c4bd49f9b-6b2gr                         1/1     Running   <span class="m">5</span> <span class="o">(</span>3m18s ago<span class="o">)</span>   6m18s
</span></span><span class="line"><span class="cl">kube-system   calico-node-bgsfs                                                1/1     Running   <span class="m">5</span> <span class="o">(</span>2m55s ago<span class="o">)</span>   6m18s
</span></span><span class="line"><span class="cl">kube-system   calico-node-tr88g                                                1/1     Running   <span class="m">5</span> <span class="o">(</span>3m19s ago<span class="o">)</span>   6m18s
</span></span><span class="line"><span class="cl">kube-system   calico-node-w59pc                                                1/1     Running   <span class="m">5</span> <span class="o">(</span>2m36s ago<span class="o">)</span>   6m18s
</span></span><span class="line"><span class="cl">kube-system   coredns-6d8c4cb4d-r8r9q                                          1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">kube-system   coredns-6d8c4cb4d-ztq6w                                          1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">kube-system   etcd-tiny-calico-master-88-1.k8s.tcinternal                      1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">kube-system   kube-apiserver-tiny-calico-master-88-1.k8s.tcinternal            1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">kube-system   kube-controller-manager-tiny-calico-master-88-1.k8s.tcinternal   1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-n65sb                                                 1/1     Running   <span class="m">0</span>               169m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-qmxhp                                                 1/1     Running   <span class="m">0</span>               168m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-v6cg9                                                 1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">kube-system   kube-scheduler-tiny-calico-master-88-1.k8s.tcinternal            1/1     Running   <span class="m">0</span>               3h8m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看calico-kube-controllers的pod日志是否有报错</span>
</span></span><span class="line"><span class="cl">$ kubectl logs -f calico-kube-controllers-5c4bd49f9b-6b2gr -n kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-pod-installation-calicoctl">5.3 pod installation calicoctl</h3>
<p>calicoctl is a command line tool used to view and manage calico, positioned somewhat similar to the calico version of kubectl, because we used etcd as the calico datastore earlier, here directly select <a href="https://projectcalico.docs.tigera.io/maintenance/clis/calicoctl/install#install-calicoctl-as-a-kubernetes-pod">deploy as pod in k8s cluster</a><code>calicoctl</code> is a much simpler way.</p>
<ul>
<li>The version of <code>calicoctl</code> should ideally match the deployed calico, here both are <code>v3.22.2</code></li>
<li>The etcd configuration of <code>calicoctl</code> should be the same as the deployed calico, because the previous deployment of calico has TLS enabled for etcd, so here we also need to modify the yaml file to enable TLS</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 为了方便后期管理，我们先把calicoctl.yaml下载到本地再进行部署</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ wget https://projectcalico.docs.tigera.io/manifests/calicoctl-etcd.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">$ cat calicoctl-etcd.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Calico Version v3.22.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># https://projectcalico.docs.tigera.io/releases#v3.22.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This manifest includes the following component versions:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#   calico/ctl:v3.22.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calicoctl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/os</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calicoctl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">calico/ctl:v3.22.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/calicoctl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">version</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- --<span class="l">poll=1m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ETCD_ENDPOINTS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calico-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">etcd_endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># If you&#39;re using TLS enabled etcd uncomment the following.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Location of the CA certificate for etcd.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ETCD_CA_CERT_FILE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calico-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">etcd_ca</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Location of the client key for etcd.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ETCD_KEY_FILE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calico-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">etcd_key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Location of the client certificate for etcd.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ETCD_CERT_FILE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">calico-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">etcd_cert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/calico-secrets</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcd-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># If you&#39;re using TLS enabled etcd uncomment the following.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcd-certs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">calico-etcd-secrets</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After the modifications are done we deploy it directly and use it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f calicoctl-etcd.yaml
</span></span><span class="line"><span class="cl">pod/calicoctl created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建完成后我们查看calicoctl的运行状态</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods -A <span class="p">|</span> grep calicoctl
</span></span><span class="line"><span class="cl">kube-system   calicoctl                                                        1/1     Running   <span class="m">0</span>             9s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 检验一下是否能够正常工作</span>
</span></span><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -ti -n kube-system calicoctl -- /calicoctl get nodes
</span></span><span class="line"><span class="cl">NAME
</span></span><span class="line"><span class="cl">tiny-calico-master-88-1.k8s.tcinternal
</span></span><span class="line"><span class="cl">tiny-calico-worker-88-11.k8s.tcinternal
</span></span><span class="line"><span class="cl">tiny-calico-worker-88-12.k8s.tcinternal
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -ti -n kube-system calicoctl -- /calicoctl get profiles -o wide
</span></span><span class="line"><span class="cl">NAME                                                 LABELS
</span></span><span class="line"><span class="cl">projectcalico-default-allow
</span></span><span class="line"><span class="cl">kns.default                                          pcns.kubernetes.io/metadata.name<span class="o">=</span>default,pcns.projectcalico.org/name<span class="o">=</span>default
</span></span><span class="line"><span class="cl">kns.kube-node-lease                                  pcns.kubernetes.io/metadata.name<span class="o">=</span>kube-node-lease,pcns.projectcalico.org/name<span class="o">=</span>kube-node-lease
</span></span><span class="line"><span class="cl">kns.kube-public                                      pcns.kubernetes.io/metadata.name<span class="o">=</span>kube-public,pcns.projectcalico.org/name<span class="o">=</span>kube-public
</span></span><span class="line"><span class="cl">kns.kube-system                                      pcns.kubernetes.io/metadata.name<span class="o">=</span>kube-system,pcns.projectcalico.org/name<span class="o">=</span>kube-system
</span></span><span class="line"><span class="cl">...此处略去一堆输出...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看ipam的分配情况</span>
</span></span><span class="line"><span class="cl">$ calicoctl ipam show
</span></span><span class="line"><span class="cl">+----------+---------------+-----------+------------+--------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> GROUPING <span class="p">|</span>     CIDR      <span class="p">|</span> IPS TOTAL <span class="p">|</span> IPS IN USE <span class="p">|</span>   IPS FREE   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+---------------+-----------+------------+--------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> IP Pool  <span class="p">|</span> 10.88.64.0/18 <span class="p">|</span>     <span class="m">16384</span> <span class="p">|</span> <span class="m">2</span> <span class="o">(</span>0%<span class="o">)</span>     <span class="p">|</span> <span class="m">16382</span> <span class="o">(</span>100%<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+---------------+-----------+------------+--------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为了方便可以在bashrc中设置alias</span>
</span></span><span class="line"><span class="cl">cat &gt;&gt; ~/.bashrc <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">alias calicoctl=&#34;kubectl exec -i -n kube-system calicoctl -- /calicoctl&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The full version of the calicoctl command can be found in the <a href="https://projectcalico.docs.tigera.io/reference/calicoctl/">official documentation</a>.</p>
<h3 id="54-binary-installation-of-calicoctl">5.4 binary installation of calicoctl</h3>
<p>Deploying <code>calicoctl</code> using pod is easy, but one problem is that you can&rsquo;t use the <code>calicoctl node</code> command, which requires access to part of the host&rsquo;s filesystem. So here we binary deploy a <code>calicoctl</code> again. Available.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 直接下线二进制文件即可使用</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /usr/local/bin/
</span></span><span class="line"><span class="cl">$ curl -L https://github.com/projectcalico/calico/releases/download/v3.22.2/calicoctl-linux-amd64 -o calicoctl
</span></span><span class="line"><span class="cl">$ chmod +x ./calicoctl
</span></span></code></pre></td></tr></table>
</div>
</div><p>The binary calicoctl will read the configuration file first, and will only read the environment variables when it can&rsquo;t find the configuration file, here we directly configure <code>/etc/calico/calicoctl.cfg</code>, and note that the etcd certificate is directly consistent with the certificate file used when deploying calico earlier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 配置calicoctl的配置文件
</span></span><span class="line"><span class="cl">$ mkdir /etc/calico
</span></span><span class="line"><span class="cl">$ cat /etc/calico/calicoctl.cfg
</span></span><span class="line"><span class="cl">apiVersion: projectcalico.org/v3
</span></span><span class="line"><span class="cl">kind: CalicoAPIConfig
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  datastoreType: etcdv3
</span></span><span class="line"><span class="cl">  etcdEndpoints: &#34;https://10.31.88.1:2379&#34;
</span></span><span class="line"><span class="cl">  etcdCACert: |
</span></span><span class="line"><span class="cl">      -----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">      MIIC9TCCAd2gAwIBAgIBADANBgkqhkiG9w0BAQsFADASMRAwDgYDVQQDEwdldGNk
</span></span><span class="line"><span class="cl">      LWNhMB4XDTIyMDUwNjA1MTg1OVoXDTMyMDUwMzA1MTg1OVowEjEQMA4GA1UEAxMH
</span></span><span class="line"><span class="cl">      ZXRjZC1jYTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANFFqq4Mk3DE
</span></span><span class="line"><span class="cl">      6UW581xnZPFrHqQWlGr/KptEywKH56Bp24OAnDIAkSz7KAMrJzL+OiVsj9YJV59F
</span></span><span class="line"><span class="cl">      9qH/YzU+bppctDnfk1yCuavkcXgLSd9O6EBhM2LkGtF9AdWMnFw9ui2jNhFC/QXj
</span></span><span class="line"><span class="cl">      zCvq0I1c9o9gulbFmSHwIw2GLQd7ogO+PpfLsubRscJdKkCUWVFV0mb8opccmXoF
</span></span><span class="line"><span class="cl">      vXynRX0VW3wpN+v66bD+HTdMSNK1JljfBngh9LAkibjUx7bMrHvu/GOalNCSWrtG
</span></span><span class="line"><span class="cl">      lss/hhWkzwV7Y7AIXgvxxcmDdfswe5lUYLvW2CP4e+tXfB3i2wg10fErc8z63lix
</span></span><span class="line"><span class="cl">      v9BWkIIalScCAwEAAaNWMFQwDgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMB
</span></span><span class="line"><span class="cl">      Af8wHQYDVR0OBBYEFH49PpnJYxze8aq0PVwgpY4Fo6djMBIGA1UdEQQLMAmCB2V0
</span></span><span class="line"><span class="cl">      Y2QtY2EwDQYJKoZIhvcNAQELBQADggEBAAGL6KwN80YEK6gZcL+7RI9bkMKk7UWW
</span></span><span class="line"><span class="cl">      V48154CgN8w9GKvNTm4l0tZKvsWCnR61hiJtLQcG0S8HYHAvL1DBjOXw11bNilLy
</span></span><span class="line"><span class="cl">      vaVM+wqOOIxPsXLU//F46z3V9z1uV0v/yLLlg320c0wtG+OLZZIn8O+yUhtOHM09
</span></span><span class="line"><span class="cl">      K0JSAF2/KhtNxhrc0owCTOzS+DKsb0w1SzQmS0t/tflyLfc3oJZ/2V4Tqd72j7iI
</span></span><span class="line"><span class="cl">      cDBa36lGqtUBf8MXu+Xza0cdhy/f19AqkeM2fe+/DrbzR4zDVmZ7l4dqYGLbKHYo
</span></span><span class="line"><span class="cl">      XaLn8bSToYQq4dlA/oAlyyH0ekB5v0DyYiHwlqgZgiu4qcR3Gw8azVk=
</span></span><span class="line"><span class="cl">      -----END CERTIFICATE-----
</span></span><span class="line"><span class="cl">  etcdCert: |
</span></span><span class="line"><span class="cl">      -----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">      MIIDgzCCAmugAwIBAgIIePiBSOdMGwcwDQYJKoZIhvcNAQELBQAwEjEQMA4GA1UE
</span></span><span class="line"><span class="cl">      AxMHZXRjZC1jYTAeFw0yMjA1MDYwNTE4NTlaFw0yMzA1MDYwNTE4NTlaMDExLzAt
</span></span><span class="line"><span class="cl">      BgNVBAMTJnRpbnktY2FsaWNvLW1hc3Rlci04OC0xLms4cy50Y2ludGVybmFsMIIB
</span></span><span class="line"><span class="cl">      IjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqZM/jBrdXLR3ctee7LVJhGSA
</span></span><span class="line"><span class="cl">      4usg/JQXGyOAd52OkkOLYwn3fvwqeo0Z0cX0q4mqaF0cnrPYc4eExX/3fJpF3Fxy
</span></span><span class="line"><span class="cl">      D6vdpEZ/FrnzCAkibEYtK/UVhTKuV7n/VdbjFPGl8CpppuGVs6o+4NFZxffW7em0
</span></span><span class="line"><span class="cl">      8m/FK/7SDkV2qXCyG94kOaUCeDEgdBKE3cPCZQ4maFuwXi08bYs2CiTfbfa4dsT5
</span></span><span class="line"><span class="cl">      3yzaoQVX9BaBqE9IGmsHDFuxp1X8gkJXs+7wwHQX39o1oXmci6T4IVxVHA5GRbTv
</span></span><span class="line"><span class="cl">      pCDG5Wye7QqKgnxO1KRF42FKs1Nif7UJ0iR35Ydpa7cat7Fr0M7l+rZLCDTJgwID
</span></span><span class="line"><span class="cl">      AQABo4G9MIG6MA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYI
</span></span><span class="line"><span class="cl">      KwYBBQUHAwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBR+PT6ZyWMc3vGqtD1c
</span></span><span class="line"><span class="cl">      IKWOBaOnYzBaBgNVHREEUzBRgglsb2NhbGhvc3SCJnRpbnktY2FsaWNvLW1hc3Rl
</span></span><span class="line"><span class="cl">      ci04OC0xLms4cy50Y2ludGVybmFshwQKH1gBhwR/AAABhxAAAAAAAAAAAAAAAAAA
</span></span><span class="line"><span class="cl">      AAABMA0GCSqGSIb3DQEBCwUAA4IBAQC+pyH14/+US5Svz04Vi8QIduY/DVx1HOQq
</span></span><span class="line"><span class="cl">      hfrIZKOZCH2iKU7fZ4o9QpQZh7D9B8hgpXM6dNuFpd98c0MVPr+LesShu4BHVjHl
</span></span><span class="line"><span class="cl">      gPvUWEVB2XD5x51HqnMV2OkhMKooyAUIzI0P0YKN29SFEyJGD1XDu4UtqvBADqf7
</span></span><span class="line"><span class="cl">      COvAuqj4VbRgF/iQwNstjqZ47rSzvyp6rIwqFoHRP+Zi+8KL1qmozGjI3+H+TZFM
</span></span><span class="line"><span class="cl">      Gv3b5DRx2pmfY+kGVLO5bjl3zxylRPjCDHaRlQUWiOYSWS8OHYRCBZuSLvW4tht0
</span></span><span class="line"><span class="cl">      JjWjUAh4hF8+3lyNrfx8moz7tfm5SG2q01pO1vjkhrhxhINAwaac
</span></span><span class="line"><span class="cl">      -----END CERTIFICATE-----
</span></span><span class="line"><span class="cl">  etcdKey: |
</span></span><span class="line"><span class="cl">      -----BEGIN RSA PRIVATE KEY-----
</span></span><span class="line"><span class="cl">      MIIEowIBAAKCAQEAqZM/jBrdXLR3ctee7LVJhGSA4usg/JQXGyOAd52OkkOLYwn3
</span></span><span class="line"><span class="cl">      fvwqeo0Z0cX0q4mqaF0cnrPYc4eExX/3fJpF3FxyD6vdpEZ/FrnzCAkibEYtK/UV
</span></span><span class="line"><span class="cl">      hTKuV7n/VdbjFPGl8CpppuGVs6o+4NFZxffW7em08m/FK/7SDkV2qXCyG94kOaUC
</span></span><span class="line"><span class="cl">      eDEgdBKE3cPCZQ4maFuwXi08bYs2CiTfbfa4dsT53yzaoQVX9BaBqE9IGmsHDFux
</span></span><span class="line"><span class="cl">      p1X8gkJXs+7wwHQX39o1oXmci6T4IVxVHA5GRbTvpCDG5Wye7QqKgnxO1KRF42FK
</span></span><span class="line"><span class="cl">      s1Nif7UJ0iR35Ydpa7cat7Fr0M7l+rZLCDTJgwIDAQABAoIBAE1gMw7q8zbp4dc1
</span></span><span class="line"><span class="cl">      K/82eWU/ts/UGikmKaTofiYWboeu6ls2oQgAaCGjYLSnbw0Ws/sLAZQo3AtbOuoj
</span></span><span class="line"><span class="cl">      ifoBKv9x71nXQjtDL5pfHtX71QkyvEniev9cMNE2vZudgeB8owsDT1ImfPiOJkLP
</span></span><span class="line"><span class="cl">      Q/dhL2E/0qEM/xskGxUH/S0zjxHHfPZZsYODhkVPWc6Z+XEDll48fRCFn4/48FTN
</span></span><span class="line"><span class="cl">      9GbRvo7dv34EHmNYA20K4DMHbZUdrPqSZpKWzAPJXnDlgZbpvUeAYOJxqZHQtCm1
</span></span><span class="line"><span class="cl">      zbSOyM1Ql6K0Ayro0L5GAzap+0yGuk79OWiPnEsdPneVsATKG7dT7RZIL/INrOqQ
</span></span><span class="line"><span class="cl">      0wjUmQECgYEA02OHdT1K5Au6wtiTqKD99WweltnvFd4C/Z3dobEj8M8qN6uiKCca
</span></span><span class="line"><span class="cl">      PievWahnxAlJEah3RiOgtarwA+0E/Jgsw99Qutp5BR/XdD3llTNczkPkg/RkWpve
</span></span><span class="line"><span class="cl">      2f/4DlZQrxuIem7UNLl+5BacfmF691DQQoX2RoIkvQxYJGTUNXvrSUkCgYEAzVyz
</span></span><span class="line"><span class="cl">      mvN+dvSwzAlm0gkfVP5Ez3DFESUrWd0FR2v1HR6qHQy/dkgkkic6zRGCJtGeT5V7
</span></span><span class="line"><span class="cl">      N0kbVSHsz+wi6aQkFy0Sp0TbgZzjPhSwNtk+2JsBRvMp0CYczgrfyvWuAQ3gbXGc
</span></span><span class="line"><span class="cl">      N8IkcZSSOv8TuigCnnYf2Xaz8LM50AivScnb6GsCgYEAyq4ScgnLpa3NawbnRPbf
</span></span><span class="line"><span class="cl">      qRH6nl7lC01sBqn3mBHVSQ4JB4msF92uHsxEJ639mAvjIGgrvHdqnuT/7nOypVJv
</span></span><span class="line"><span class="cl">      EXsr14ykHpKyLQUv/Idbw3V7RD3ufqYW3WS8/VorUEoQ6HsdQlRc4ur/L3ndwgWd
</span></span><span class="line"><span class="cl">      OTtir6YW/aA5XuPCSGnBZekCgYB6VtlgW+Jg91BDnO41/d0+guN3ONUNa7kxpau5
</span></span><span class="line"><span class="cl">      aqTxHg11lNySmFPBBcHP3LhOa94FxyVKQDEaPEWZcDE0QuaFMALGxwyFYHM3zpdT
</span></span><span class="line"><span class="cl">      dYQtAdp26/Fi4PGUBYJgpI9ubVffmyjXRr7zMvESWFbmNWOqBvDeWgrEP+EW/7V9
</span></span><span class="line"><span class="cl">      HdX11QKBgE1czchlibgQ/bhAl8BatKRr1X/UHvblWhmyApudOfFeGOILR6u/lWvY
</span></span><span class="line"><span class="cl">      SS+Rg0y8nnZ4hTRSXbd/sSEsUJcSmoBc1TivWzl32eVuqe9CcrUZY0JSLtoj1KiP
</span></span><span class="line"><span class="cl">      adRcCZtVDETXbW326Hvgz+MnqrIgzx+Zgy4tNtoAAbTv0q83j45I
</span></span><span class="line"><span class="cl">      -----END RSA PRIVATE KEY-----
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the configuration is complete we check the results.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ calicoctl node status
</span></span><span class="line"><span class="cl">Calico process is running.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IPv4 BGP status
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> PEER ADDRESS <span class="p">|</span>     PEER TYPE     <span class="p">|</span> STATE <span class="p">|</span>  SINCE   <span class="p">|</span>    INFO     <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.31.88.11  <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 08:26:30 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> 10.31.88.12  <span class="p">|</span> node-to-node mesh <span class="p">|</span> up    <span class="p">|</span> 08:26:30 <span class="p">|</span> Established <span class="p">|</span>
</span></span><span class="line"><span class="cl">+--------------+-------------------+-------+----------+-------------+
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">IPv6 BGP status
</span></span><span class="line"><span class="cl">No IPv6 peers found.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ calicoctl get nodes
</span></span><span class="line"><span class="cl">NAME
</span></span><span class="line"><span class="cl">tiny-calico-master-88-1.k8s.tcinternal
</span></span><span class="line"><span class="cl">tiny-calico-worker-88-11.k8s.tcinternal
</span></span><span class="line"><span class="cl">tiny-calico-worker-88-12.k8s.tcinternal
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ calicoctl ipam show
</span></span><span class="line"><span class="cl">+----------+---------------+-----------+------------+--------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> GROUPING <span class="p">|</span>     CIDR      <span class="p">|</span> IPS TOTAL <span class="p">|</span> IPS IN USE <span class="p">|</span>   IPS FREE   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+---------------+-----------+------------+--------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> IP Pool  <span class="p">|</span> 10.88.64.0/18 <span class="p">|</span>     <span class="m">16384</span> <span class="p">|</span> <span class="m">2</span> <span class="o">(</span>0%<span class="o">)</span>     <span class="p">|</span> <span class="m">16382</span> <span class="o">(</span>100%<span class="o">)</span> <span class="p">|</span>
</span></span><span class="line"><span class="cl">+----------+---------------+-----------+------------+--------------+
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-deploy-test-cases">6. Deploy test cases</h2>
<p>After the cluster is deployed we deploy an nginx in the k8s cluster to test if it works. First we create a namespace named <code>nginx-quic</code>, then we create a <code>deployment</code> named <code>nginx-quic-deployment</code> in this namespace to deploy pods, and finally we create a <code>service</code> to expose the service, here we first Here we first use <code>nodeport</code> to expose the port for testing purposes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat nginx-quic.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Namespace
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: nginx-quic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: nginx-quic-deployment
</span></span><span class="line"><span class="cl">  namespace: nginx-quic
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: nginx-quic
</span></span><span class="line"><span class="cl">  replicas: <span class="m">4</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: nginx-quic
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: nginx-quic
</span></span><span class="line"><span class="cl">        image: tinychen777/nginx-quic:latest
</span></span><span class="line"><span class="cl">        imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">80</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: nginx-quic-service
</span></span><span class="line"><span class="cl">  namespace: nginx-quic
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: nginx-quic
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - protocol: TCP
</span></span><span class="line"><span class="cl">    port: <span class="m">8080</span> <span class="c1"># match for service access port</span>
</span></span><span class="line"><span class="cl">    targetPort: <span class="m">80</span> <span class="c1"># match for pod access port</span>
</span></span><span class="line"><span class="cl">    nodePort: <span class="m">30088</span> <span class="c1"># match for external access port</span>
</span></span><span class="line"><span class="cl">  type: NodePort
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the deployment is complete we check the status directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 直接部署</span>
</span></span><span class="line"><span class="cl">$ kubectl apply -f nginx-quic.yaml
</span></span><span class="line"><span class="cl">namespace/nginx-quic created
</span></span><span class="line"><span class="cl">deployment.apps/nginx-quic-deployment created
</span></span><span class="line"><span class="cl">service/nginx-quic-service created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment的运行状态</span>
</span></span><span class="line"><span class="cl">$ kubectl get deployment -o wide -n nginx-quic
</span></span><span class="line"><span class="cl">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                          SELECTOR
</span></span><span class="line"><span class="cl">nginx-quic-deployment   4/4     <span class="m">4</span>            <span class="m">4</span>           55s   nginx-quic   tinychen777/nginx-quic:latest   <span class="nv">app</span><span class="o">=</span>nginx-quic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看service的运行状态</span>
</span></span><span class="line"><span class="cl">$ kubectl get service -o wide -n nginx-quic
</span></span><span class="line"><span class="cl">NAME                 TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE   SELECTOR
</span></span><span class="line"><span class="cl">nginx-quic-service   NodePort   10.88.52.168   &lt;none&gt;        8080:30088/TCP   66s   <span class="nv">app</span><span class="o">=</span>nginx-quic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod的运行状态</span>
</span></span><span class="line"><span class="cl">$ kubectl get pods -o wide -n nginx-quic
</span></span><span class="line"><span class="cl">NAME                                     READY   STATUS    RESTARTS   AGE   IP             NODE                                      NOMINATED NODE   READINESS GATES
</span></span><span class="line"><span class="cl">nginx-quic-deployment-7457f4d579-24q9z   1/1     Running   <span class="m">0</span>          75s   10.88.120.72   tiny-calico-worker-88-12.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-quic-deployment-7457f4d579-4svv9   1/1     Running   <span class="m">0</span>          75s   10.88.84.68    tiny-calico-worker-88-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-quic-deployment-7457f4d579-btrjj   1/1     Running   <span class="m">0</span>          75s   10.88.120.71   tiny-calico-worker-88-12.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-quic-deployment-7457f4d579-lvh6x   1/1     Running   <span class="m">0</span>          75s   10.88.84.69    tiny-calico-worker-88-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看IPVS规则</span>
</span></span><span class="line"><span class="cl">$ ipvsadm -ln
</span></span><span class="line"><span class="cl">IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
</span></span><span class="line"><span class="cl">Prot LocalAddress:Port Scheduler Flags
</span></span><span class="line"><span class="cl">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span class="line"><span class="cl">TCP  172.17.0.1:30088 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.88.84.68:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.84.69:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.120.71:80              Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.120.72:80              Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">TCP  10.31.88.1:30088 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.88.84.68:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.84.69:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.120.71:80              Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.120.72:80              Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">TCP  10.88.52.168:8080 rr
</span></span><span class="line"><span class="cl">  -&gt; 10.88.84.68:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.84.69:80               Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.120.71:80              Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span><span class="line"><span class="cl">  -&gt; 10.88.120.72:80              Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally we test that this image of nginx-quic returns by default the IP and port of the user request obtained in the nginx container.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># 首先我们在集群内进行测试</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 直接访问pod</span>
</span></span><span class="line"><span class="cl">$ curl 10.88.84.68:80
</span></span><span class="line"><span class="cl">10.31.88.1:34612
</span></span><span class="line"><span class="cl"><span class="c1"># 直接访问service的ClusterIP，这时请求会被转发到pod中</span>
</span></span><span class="line"><span class="cl">$ curl 10.88.52.168:8080
</span></span><span class="line"><span class="cl">10.31.88.1:58978
</span></span><span class="line"><span class="cl"><span class="c1"># 直接访问nodeport，这时请求会被转发到pod中，不会经过ClusterIP</span>
</span></span><span class="line"><span class="cl">$ curl 10.31.88.1:30088
</span></span><span class="line"><span class="cl">10.31.88.1:56595
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接着我们在集群外进行测试</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 直接访问三个节点的nodeport，这时请求会被转发到pod中，不会经过ClusterIP</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 由于externalTrafficPolicy默认为Cluster，因此nginx拿到的IP就是我们访问的节点的IP，而非客户端IP</span>
</span></span><span class="line"><span class="cl">$ curl 10.31.88.1:30088
</span></span><span class="line"><span class="cl">10.31.88.1:27851
</span></span><span class="line"><span class="cl">$ curl 10.31.88.11:30088
</span></span><span class="line"><span class="cl">10.31.88.11:16540
</span></span><span class="line"><span class="cl">$ curl 10.31.88.12:30088
</span></span><span class="line"><span class="cl">10.31.88.12:5767
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/2022-07/k8s-02-deploy-k8s-with-flannel/">
            <span class="next-text nav-default">Kubeadm Deployment k8s Cluster &#43; Flannel</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
