<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Enabling Preemption Mode for kubernetes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to turn on preemption mode for kubernetes." /><meta name="keywords" content="k8s, Preemption" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/k8s-preemption/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Enabling Preemption Mode for kubernetes" />
<meta property="og:description" content="Learn how to turn on preemption mode for kubernetes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/k8s-preemption/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-02T15:45:16+08:00" />
<meta property="article:modified_time" content="2022-07-02T15:45:16+08:00" />

<meta itemprop="name" content="Enabling Preemption Mode for kubernetes">
<meta itemprop="description" content="Learn how to turn on preemption mode for kubernetes."><meta itemprop="datePublished" content="2022-07-02T15:45:16+08:00" />
<meta itemprop="dateModified" content="2022-07-02T15:45:16+08:00" />
<meta itemprop="wordCount" content="1156">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Enabling Preemption Mode for kubernetes"/>
<meta name="twitter:description" content="Learn how to turn on preemption mode for kubernetes."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Enabling Preemption Mode for kubernetes</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-02 15:45:16 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1156 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#pod-prioritization-preemption">Pod prioritization, preemption</a></li>
        <li><a href="#create-priorityclass">Create PriorityClass</a></li>
        <li><a href="#set-the-priorityclassname-of-pod">Set the PriorityClassName of Pod</a></li>
        <li><a href="#gentleman-non-preempting-priorityclasses">Gentleman: Non-preempting PriorityClasses</a></li>
        <li><a href="#compare-to-cluster-autoscaler">Compare to Cluster Autoscaler</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="pod-prioritization-preemption">Pod prioritization, preemption</h2>
<p>Pod prioritization and preemption, introduced in kubernetes v1.8, entered beta status in v1.11, and entered GA phase in v1.14, is already a mature feature.</p>
<p>As the name suggests, the Pod priority, preemption feature, by subdividing applications into different priorities, prioritizes resources to high-priority applications, thus improving resource availability while guaranteeing the quality of service for high-priority applications.</p>
<p>Let&rsquo;s use the Pod priority and preemption function briefly.</p>
<p>Ibu&rsquo;s cluster version is v1.14, so feature <code>PodPriority</code> is enabled by default. The use of preemption mode is divided into two steps.</p>
<ol>
<li>define PriorityClass, the value of different PriorityClass is different, the larger the value the higher the priority.</li>
<li>Create a Pod and set the Pod&rsquo;s priorityClassName field to the expected PriorityClass.</li>
</ol>
<h2 id="create-priorityclass">Create PriorityClass</h2>
<p>As follows, Ibu first creates two PriorityClasses: <code>high-priority</code> and <code>low-priority</code>, whose values are 1000000 and 10 respectively.</p>
<p>Note that Ibu sets <code>globalDefault</code> of <code>low-priority</code> to true, so <code>low-priority</code> is the default PriorityClass of the cluster, and any Pod that does not have the priorityClassName field configured will have its priority set to <code>low-priority</code> of 10. A cluster can only have one default PriorityClass. if the default PriorityClass is not set, the priority of the Pod without the PriorityClassName field will be 0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">scheduling.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PriorityClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">high-priority</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">1000000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">globalDefault</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;for high priority pod&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">scheduling.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PriorityClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">low-priority</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">globalDefault</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;for low priority pod&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Check the current PriorityClass of the system after creation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get priorityclasses.scheduling.k8s.io
</span></span><span class="line"><span class="cl">NAME                      VALUE        GLOBAL-DEFAULT   AGE
</span></span><span class="line"><span class="cl">high-priority             <span class="m">1000000</span>      <span class="nb">false</span>            47m
</span></span><span class="line"><span class="cl">low-priority              <span class="m">10</span>           <span class="nb">true</span>             47m
</span></span><span class="line"><span class="cl">system-cluster-critical   <span class="m">2000000000</span>   <span class="nb">false</span>            254d
</span></span><span class="line"><span class="cl">system-node-critical      <span class="m">2000001000</span>   <span class="nb">false</span>            254d
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, in addition to the two PriorityClasses created above, the default system also has built-in <code>system-cluster-critical</code> and <code>system-node-critical</code> for high-priority system tasks.</p>
<h2 id="set-the-priorityclassname-of-pod">Set the PriorityClassName of Pod</h2>
<p>For verification purposes, Ibu uses <a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#extended-resources">extended resource</a> here. Ibu sets the capacity of the extended resource <code>example.com/foo</code> to 1 for node x1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -k --header <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">token</span><span class="si">}</span><span class="s2">&#34;</span> --header <span class="s2">&#34;Content-Type: application/json-patch+json&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--request PATCH <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--data <span class="s1">&#39;[{&#34;op&#34;: &#34;add&#34;, &#34;path&#34;: &#34;/status/capacity/example.com~1foo&#34;, &#34;value&#34;: &#34;1&#34;}]&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>https://<span class="o">{</span>apiServerIP<span class="o">}</span>:<span class="o">{</span>apiServerPort<span class="o">}</span>/api/v1/nodes/x1/status
</span></span></code></pre></td></tr></table>
</div>
</div><p>Looking at the allocatable and capacity of x1, you can see that there is 1 <code>example.com/foo</code> resource on x1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">Capacity</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">cpu</span><span class="p">:</span><span class="w">                </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w">    </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">hugepages-2Mi</span><span class="p">:</span><span class="w">      </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">memory</span><span class="p">:</span><span class="w">             </span><span class="l">4040056Ki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">pods</span><span class="p">:</span><span class="w">               </span><span class="m">110</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Allocatable</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">cpu</span><span class="p">:</span><span class="w">                </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w">    </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">hugepages-2Mi</span><span class="p">:</span><span class="w">      </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">memory</span><span class="p">:</span><span class="w">             </span><span class="l">3937656Ki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">pods</span><span class="p">:</span><span class="w">               </span><span class="m">110</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We first create the Deployment nginx, which will request one <code>example.com/foo</code> resource, but we don&rsquo;t set the PriorityClassName, so the Pod&rsquo;s priority will be the default <code>low-priority</code> specified by 10.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Then create the Deployment debian, which does not request the <code>example.com/foo</code> resource.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">debian</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">debian</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">priorityClassName</span><span class="p">:</span><span class="w"> </span><span class="l">high-priority</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>At this point both Pods can be started normally.</p>
<p><em>Start preemption</em>.</p>
<p>We change the Deployment debian&rsquo;s <code>example.com/foo</code> request volume to 1 and set the priorityClassName to <code>high-priority</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">debian</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">debian</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">example.com/foo</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">priorityClassName</span><span class="p">:</span><span class="w"> </span><span class="l">high-priority</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, since there is only 1 <code>example.com/foo</code> resource on x1 in the cluster and debian has a higher priority, the scheduler will start to seize it. The following is the observed Pod process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pods -o wide -w
</span></span><span class="line"><span class="cl">NAME                      READY   STATUS    AGE     IP             NODE       NOMINATED NODE
</span></span><span class="line"><span class="cl">debian-55d94c54cb-pdfmd   1/1     Running   3m53s   10.244.4.178   x201       &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-g5fph    1/1     Running   2m4s    10.244.3.28    x1         &lt;none&gt;
</span></span><span class="line"><span class="cl">// 此时Deployment debian开始Recreate
</span></span><span class="line"><span class="cl">debian-55d94c54cb-pdfmd   1/1     Terminating   4m49s   10.244.4.178   x201       &lt;none&gt;
</span></span><span class="line"><span class="cl">debian-55d94c54cb-pdfmd   0/1     Terminating   5m21s   10.244.4.178   x201       &lt;none&gt;
</span></span><span class="line"><span class="cl">debian-55d94c54cb-pdfmd   0/1     Terminating   5m22s   10.244.4.178   x201       &lt;none&gt;
</span></span><span class="line"><span class="cl">debian-55d94c54cb-pdfmd   0/1     Terminating   5m22s   10.244.4.178   x201       &lt;none&gt;
</span></span><span class="line"><span class="cl">// example.com/foo不满足，阻塞
</span></span><span class="line"><span class="cl">debian-5bc46885dd-rvtwv   0/1     Pending       0s      &lt;none&gt;         &lt;none&gt;     &lt;none&gt;
</span></span><span class="line"><span class="cl">debian-5bc46885dd-rvtwv   0/1     Pending       0s      &lt;none&gt;         &lt;none&gt;     &lt;none&gt;
</span></span><span class="line"><span class="cl">// scheduler判断将x1上的Pod挤出后可以满足debian Pod的需求，设置NOMINATED为x1
</span></span><span class="line"><span class="cl">debian-5bc46885dd-rvtwv   0/1     Pending       0s      &lt;none&gt;         &lt;none&gt;     x1    
</span></span><span class="line"><span class="cl">// sheduler开始挤出Pod nginx
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-g5fph    1/1     Terminating   3m33s   10.244.3.28    x1         &lt;none&gt;
</span></span><span class="line"><span class="cl">// Pod nginx等待。优先级低啊，没办法。
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-29rzw    0/1     Pending       0s      &lt;none&gt;         &lt;none&gt;     &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-29rzw    0/1     Pending       0s      &lt;none&gt;         &lt;none&gt;     &lt;none&gt;
</span></span><span class="line"><span class="cl">// graceful termination period，优雅退出
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-g5fph    0/1     Terminating   3m34s   10.244.3.28    x1         &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-g5fph    0/1     Terminating   3m37s   10.244.3.28    x1         &lt;none&gt;
</span></span><span class="line"><span class="cl">nginx-58dc57fbff-g5fph    0/1     Terminating   3m37s   10.244.3.28    x1         &lt;none&gt;
</span></span><span class="line"><span class="cl">// debian NODE绑定为x1
</span></span><span class="line"><span class="cl">debian-5bc46885dd-rvtwv   0/1     Pending       5s      &lt;none&gt;         x1         x1    
</span></span><span class="line"><span class="cl">// 抢占到资源，启动
</span></span><span class="line"><span class="cl">debian-5bc46885dd-rvtwv   0/1     ContainerCreating   5s      &lt;none&gt;         x1         &lt;none&gt;
</span></span><span class="line"><span class="cl">debian-5bc46885dd-rvtwv   1/1     Running             14s     10.244.3.29    x1         &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gentleman-non-preempting-priorityclasses">Gentleman: Non-preempting PriorityClasses</h2>
<p>kubernetes v1.15 added a field <code>PreemptionPolicy</code> for PriorityClasses, when set to <code>Never</code>, the Pod will not preempt Pods with lower priority than it, just the scheduling will be prioritized (refer to the value of PriorityClass).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">scheduling.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PriorityClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">high-priority-nonpreempting</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">1000000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">preemptionPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">globalDefault</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>So I call this PriorityClass &ldquo;gentleman&rdquo;, because he just silently queue up according to his ability (Priority), and will not steal other people&rsquo;s resources. The official website gives a suitable example is data science workload.</p>
<h2 id="compare-to-cluster-autoscaler">Compare to Cluster Autoscaler</h2>
<p>When kubernetes on the cloud is running low on cluster resources, it can automatically scale the nodes through Cluster Autoscaler, i.e., request more nodes from the cloud vendor and add them to the cluster, thus providing more resources.</p>
<p>However, the shortcomings of this approach are.</p>
<ul>
<li>The under-cloud scenario is not easy to implement</li>
<li>It costs more money to add nodes</li>
<li>Not immediate, takes time</li>
</ul>
<p>If users can more clearly divide the priority of applications, they can better improve resource utilization and quality of service by seizing resources from lower priority Pods when resources are insufficient.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/k8s-optimization/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Domain name resolution optimization in kubernetes containers</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-mobile-library/">
            <span class="next-text nav-default">Developing Cross-Platform Library with Go Mobile</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
