<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Golang program startup flow analysis - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article focuses on the key code in the Golang program startup process." /><meta name="keywords" content="golang Bootstrap" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/go-bootstrap/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Golang program startup flow analysis" />
<meta property="og:description" content="This article focuses on the key code in the Golang program startup process." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/go-bootstrap/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-06T13:41:03+08:00" />
<meta property="article:modified_time" content="2022-07-06T13:41:03+08:00" />

<meta itemprop="name" content="Golang program startup flow analysis">
<meta itemprop="description" content="This article focuses on the key code in the Golang program startup process."><meta itemprop="datePublished" content="2022-07-06T13:41:03+08:00" />
<meta itemprop="dateModified" content="2022-07-06T13:41:03+08:00" />
<meta itemprop="wordCount" content="3552">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang program startup flow analysis"/>
<meta name="twitter:description" content="This article focuses on the key code in the Golang program startup process."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Golang program startup flow analysis</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-06 13:41:03 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3552 words </span>
          <span class="more-meta"> 8 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-flow-of-golang-code-being-run-up-by-the-os">1. Flow of Golang code being run up by the OS</a>
          <ul>
            <li><a href="#11-compilation">1.1. Compilation</a></li>
            <li><a href="#12-running">1.2. Running</a></li>
          </ul>
        </li>
        <li><a href="#2-golang-program-startup-flow-analysis">2. Golang program startup flow analysis</a>
          <ul>
            <li><a href="#21-analyze-the-program-startup-process-through-gdb-debugging">2.1. Analyze the program startup process through gdb debugging</a></li>
            <li><a href="#22-golang-startup-process-analysis">2.2. golang startup process analysis</a></li>
            <li><a href="#23-view-elf-binary-file-structure">2.3. View ELF binary file structure</a></li>
          </ul>
        </li>
        <li><a href="#3-summary">3. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-flow-of-golang-code-being-run-up-by-the-os">1. Flow of Golang code being run up by the OS</h2>
<h3 id="11-compilation">1.1. Compilation</h3>
<p>The go source code is first compiled into an executable file by go build, which is an ELF format executable file on linux platform, and the compilation stage will go through three processes: compiler, assembler, and linker to finally generate an executable file.</p>
<ul>
<li>Compiler: <code>*.go</code> source code is generated as plan9 assembly code for <code>*.s</code> by the go compiler, the go compiler entry is <a href="https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/main.go">compile/internal/gc/main.go</a> file for the main function.</li>
<li>Assembler: The go assembler converts the compiler-generated <code>*.s</code> assembly language into machine code and writes the final target program <code>*.o</code> file, <a href="https://github.com/golang/go/tree/master/src/cmd/internal/obj">src/cmd/internal/obj</a> package implements the go assembler.</li>
<li>Linker: The assembler generates a <code>*.o</code> target file that is linked to obtain the final executable, <a href="https://github.com/golang/go/tree/master/src/cmd/link/internal/ld">src/cmd/link/internal/ld</a> package implements the linker.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/06/5bc67d5dca4c49ffaa0bf8959be6c029.png" alt="Flow of Golang code being run up by the OS"></p>
<h3 id="12-running">1.2. Running</h3>
<p>After the go source code has been generated as an executable through the above steps, the binary file will go through the following stages when loaded and run by the operating system.</p>
<ul>
<li>Reading the executable from disk into memory.</li>
<li>Creating the process and the main thread.</li>
<li>Allocating stack space for the main thread.</li>
<li>copying the parameters entered by the user on the command line to the main thread&rsquo;s stack.</li>
<li>placing the main thread into the operating system&rsquo;s run queue to wait to be scheduled to execute it.</li>
</ul>
<h2 id="2-golang-program-startup-flow-analysis">2. Golang program startup flow analysis</h2>
<h3 id="21-analyze-the-program-startup-process-through-gdb-debugging">2.1. Analyze the program startup process through gdb debugging</h3>
<p>Here a simple go program is debugged in a single step to analyze its startup process.</p>
<p><code>main.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;hello world&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Compile the program and use gdb to debug it. When debugging with gdb, first set a breakpoint at the program entry point, and then perform single-step debugging to see the code execution flow during the program startup.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$ go build -gcflags &#34;-N -l&#34; -o main main.go
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ gdb ./main
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(gdb) info files
</span></span><span class="line"><span class="cl">Symbols from &#34;/home/gosoon/main&#34;.
</span></span><span class="line"><span class="cl">Local exec file:
</span></span><span class="line"><span class="cl">	`/home/gosoon/main&#39;, file type elf64-x86-64.
</span></span><span class="line"><span class="cl">	Entry point: 0x465860
</span></span><span class="line"><span class="cl">	0x0000000000401000 - 0x0000000000497893 is .text
</span></span><span class="line"><span class="cl">	0x0000000000498000 - 0x00000000004dbb65 is .rodata
</span></span><span class="line"><span class="cl">	0x00000000004dbd00 - 0x00000000004dc42c is .typelink
</span></span><span class="line"><span class="cl">	0x00000000004dc440 - 0x00000000004dc490 is .itablink
</span></span><span class="line"><span class="cl">	0x00000000004dc490 - 0x00000000004dc490 is .gosymtab
</span></span><span class="line"><span class="cl">	0x00000000004dc4a0 - 0x0000000000534b90 is .gopclntab
</span></span><span class="line"><span class="cl">	0x0000000000535000 - 0x0000000000535020 is .go.buildinfo
</span></span><span class="line"><span class="cl">	0x0000000000535020 - 0x00000000005432e4 is .noptrdata
</span></span><span class="line"><span class="cl">	0x0000000000543300 - 0x000000000054aa70 is .data
</span></span><span class="line"><span class="cl">	0x000000000054aa80 - 0x00000000005781f0 is .bss
</span></span><span class="line"><span class="cl">	0x0000000000578200 - 0x000000000057d510 is .noptrbss
</span></span><span class="line"><span class="cl">	0x0000000000400f9c - 0x0000000000401000 is .note.go.buildid
</span></span><span class="line"><span class="cl">(gdb) b *0x465860
</span></span><span class="line"><span class="cl">Breakpoint 1 at 0x465860: file /home/gosoon/golang/go/src/runtime/rt0_linux_amd64.s, line 8.
</span></span><span class="line"><span class="cl">(gdb) r
</span></span><span class="line"><span class="cl">Starting program: /home/gaofeilei/./main
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Breakpoint 1, _rt0_amd64_linux () at /home/gaofeilei/golang/go/src/runtime/rt0_linux_amd64.s:8
</span></span><span class="line"><span class="cl">8		JMP	_rt0_amd64(SB)
</span></span><span class="line"><span class="cl">(gdb) n
</span></span><span class="line"><span class="cl">_rt0_amd64 () at /home/gaofeilei/golang/go/src/runtime/asm_amd64.s:15
</span></span><span class="line"><span class="cl">15		MOVQ	0(SP), DI	// argc
</span></span><span class="line"><span class="cl">(gdb) n
</span></span><span class="line"><span class="cl">16		LEAQ	8(SP), SI	// argv
</span></span><span class="line"><span class="cl">(gdb) n
</span></span><span class="line"><span class="cl">17		JMP	runtime·rt0_go(SB)
</span></span><span class="line"><span class="cl">(gdb) n
</span></span><span class="line"><span class="cl">runtime.rt0_go () at /home/gaofeilei/golang/go/src/runtime/asm_amd64.s:91
</span></span><span class="line"><span class="cl">91		MOVQ	DI, AX		// argc
</span></span><span class="line"><span class="cl">......
</span></span><span class="line"><span class="cl">231		CALL	runtime·mstart(SB)
</span></span><span class="line"><span class="cl">(gdb) n
</span></span><span class="line"><span class="cl">hello world
</span></span><span class="line"><span class="cl">[Inferior 1 (process 39563) exited normally]
</span></span></code></pre></td></tr></table>
</div>
</div><p>By single-step debugging, you can see that the program entry function is at line 8 of the <code>runtime/rt0_linux_amd64.s</code> file, which eventually executes the <code>CALL runtime-mstart(SB)</code> instruction and outputs &ldquo;hello world&rdquo; and then the program exits. .</p>
<p>The function calls in the startup process flow are shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">rt0_linux_amd64.s --&gt;_rt0_amd64 --&gt; rt0_go--&gt;runtime·settls --&gt;runtime·check--&gt;runtime·args--&gt;runtime·osinit--&gt;runtime·schedinit--&gt;runtime·newproc--&gt;runtime·mstart
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-golang-startup-process-analysis">2.2. golang startup process analysis</h3>
<p>The previous section has seen through gdb debugging golang program in the startup process will execute a series of assembly instructions, this section will specifically analyze the meaning of each instruction in the process of starting the program, to understand these to understand the golang program in the startup process of the operations performed.</p>
<p><code>src/runtime/rt0_linux_amd64.s</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="c1">#include &#34;textflag.h&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TEXT</span> <span class="nf">_rt0_amd64_linux</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span><span class="n">NOSPLIT</span><span class="p">,</span><span class="o">$</span><span class="m">-8</span>
</span></span><span class="line"><span class="cl"><span class="n">JMP</span> <span class="nf">_rt0_amd64</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TEXT</span> <span class="nf">_rt0_amd64_linux_lib</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span><span class="n">NOSPLIT</span><span class="p">,</span><span class="o">$</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">JMP</span> <span class="nf">_rt0_amd64_lib</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The first execution is line 8, <code>JMP _rt0_amd64</code>, which runs under the amd64 platform, and the <code>_rt0_amd64</code> function is located in the file <code>src/runtime/asm_amd64.s</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">TEXT</span> <span class="nf">_rt0_amd64</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span><span class="n">NOSPLIT</span><span class="p">,</span><span class="o">$</span><span class="m">-8</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 处理 <span class="n">argc</span> 和 <span class="n">argv</span> 参数，<span class="n">argc</span> 是指命令行输入参数的个数，<span class="n">argv</span> 存储了所有的命令行参数
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="m">0</span><span class="p">(</span><span class="n">SP</span><span class="p">),</span> <span class="n">DI</span>   <span class="o">//</span> <span class="n">argc</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">argv</span> 为指针类型
</span></span><span class="line"><span class="cl">    <span class="n">LEAQ</span>    <span class="m">8</span><span class="p">(</span><span class="n">SP</span><span class="p">),</span> <span class="n">SI</span>   <span class="o">//</span> <span class="n">argv</span>
</span></span><span class="line"><span class="cl">    <span class="n">JMP</span> <span class="n">runtime</span>·<span class="nf">rt0_go</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>_rt0_amd64</code> function saves the argc and argv arguments to the DI and SI registers and then jumps to the <code>rt0_go</code> function, the main purpose of the <code>rt0_go</code> function is as follows.</p>
<ul>
<li>Copy argc, argv arguments to the main thread stack.</li>
<li>Initialize the global variable g0, allocate about 64K stack space on the main thread stack for g0, and set the stackguard0, stackguard1, stack fields of g0.</li>
<li>Execute the CPUID instruction to probe for CPU information.</li>
<li>Execute the nocpuinfo block to determine if the cgo needs to be initialized.</li>
<li>Execute the needtls code block to initialize tls and m0.</li>
<li>Execute ok block, first bind m0 to g0, then call <code>runtime-args</code> function to handle process parameters and environment variables, call <code>runtime-osinit</code> function to initialize cpu count, call <code>runtime-schedinit</code> to initialize scheduler, call <code>runtime-newproc</code> to create the first goroutine to execute the main function, call <code>runtime-mstart</code> to start the main thread, which will execute the first goroutine to run the main function, and will block here until the process exits.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">TEXT runtime·rt0_go(SB),NOSPLIT|TOPFRAME,$0
</span></span><span class="line"><span class="cl">    // 处理命令行参数的代码
</span></span><span class="line"><span class="cl">    MOVQ    DI, AX      // AX = argc 
</span></span><span class="line"><span class="cl">    MOVQ    SI, BX      // BX = argv
</span></span><span class="line"><span class="cl">    // 将栈扩大39字节，此处为什么扩大39字节暂时还没有搞清楚
</span></span><span class="line"><span class="cl">    SUBQ    $(4*8+7), SP        
</span></span><span class="line"><span class="cl">    ANDQ    $~15, SP    // 调整为 16 字节对齐
</span></span><span class="line"><span class="cl">    MOVQ    AX, 16(SP)  //argc放在SP + 16字节处
</span></span><span class="line"><span class="cl">    MOVQ    BX, 24(SP)  //argv放在SP + 24字节处
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // 开始初始化 g0，runtime·g0 是一个全局变量，变量在 src/runtime/proc.go 中定义，全局变量会保存在进程内存空间的数据区，下文会介绍查看 elf 二进制文件中的代码数据和全局变量的方法
</span></span><span class="line"><span class="cl">    // g0 的栈是从进程栈内存区进行分配的，g0 占用了大约 64k 大小。 
</span></span><span class="line"><span class="cl">    MOVQ    $runtime·g0(SB), DI    // g0 的地址放入 DI 寄存器 
</span></span><span class="line"><span class="cl">    LEAQ    (-64*1024+104)(SP), BX // BX = SP - 64*1024 + 104
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    // 开始初始化 g0 对象的 stackguard0,stackguard1,stack 这三个字段    
</span></span><span class="line"><span class="cl">    MOVQ    BX, g_stackguard0(DI) // g0.stackguard0 = SP - 64*1024 + 104
</span></span><span class="line"><span class="cl">    MOVQ    BX, g_stackguard1(DI) // g0.stackguard1 = SP - 64*1024 + 104
</span></span><span class="line"><span class="cl">    MOVQ    BX, (g_stack+stack_lo)(DI) // g0.stack.lo = SP - 64*1024 + 104
</span></span><span class="line"><span class="cl">    MOVQ    SP, (g_stack+stack_hi)(DI) // g0.stack.hi = SP
</span></span></code></pre></td></tr></table>
</div>
</div><p>After the execution of the above instructions, the process memory space layout is as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/06/f138555195354fc4bcd436e1580bd52d.png" alt="process memory space layout"></p>
<p>Then start executing instructions to get cpu information and related to cgo initialization, this code can be ignored for now.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl">    <span class="o">//</span> 执行<span class="n">CPUID指令</span>，尝试获取<span class="n">CPU信息</span>，探测 <span class="n">CPU</span> 和 指令集的代码
</span></span><span class="line"><span class="cl">    <span class="n">MOVL</span>    <span class="o">$</span><span class="m">0</span><span class="p">,</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="n">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVL</span>    <span class="n">AX</span><span class="p">,</span> <span class="n">SI</span>
</span></span><span class="line"><span class="cl">    <span class="n">CMPL</span>    <span class="n">AX</span><span class="p">,</span> <span class="o">$</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">JE</span>  <span class="n">nocpuinfo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Figure</span> <span class="n">out</span> <span class="n">how</span> <span class="n">to</span> <span class="n">serialize</span> <span class="n">RDTSC.</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">On</span> <span class="n">Intel</span> <span class="n">processors</span> <span class="n">LFENCE</span> <span class="n">is</span> <span class="n">enough.</span> <span class="n">AMD</span> <span class="n">requires</span> <span class="n">MFENCE.</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Don</span><span class="s">&#39;t know about the rest, so let&#39;</span><span class="n">s</span> <span class="n">do</span> <span class="n">MFENCE.</span>
</span></span><span class="line"><span class="cl">    <span class="n">CMPL</span>    <span class="n">BX</span><span class="p">,</span> <span class="o">$</span><span class="mh">0x756E6547</span>  <span class="o">//</span> <span class="s">&#34;Genu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">JNE</span> <span class="n">notintel</span>
</span></span><span class="line"><span class="cl">    <span class="n">CMPL</span>    <span class="n">DX</span><span class="p">,</span> <span class="o">$</span><span class="mh">0x49656E69</span>  <span class="o">//</span> <span class="s">&#34;ineI&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">JNE</span> <span class="n">notintel</span>
</span></span><span class="line"><span class="cl">    <span class="n">CMPL</span>    <span class="n">CX</span><span class="p">,</span> <span class="o">$</span><span class="mh">0x6C65746E</span>  <span class="o">//</span> <span class="s">&#34;ntel&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">JNE</span> <span class="n">notintel</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVB</span>    <span class="o">$</span><span class="m">1</span><span class="p">,</span> <span class="n">runtime</span>·<span class="nf">isIntel</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVB</span>    <span class="o">$</span><span class="m">1</span><span class="p">,</span> <span class="n">runtime</span>·<span class="nf">lfenceBeforeRdtsc</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">notintel</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Load</span> <span class="n">EAX</span><span class="o">=</span><span class="m">1</span> <span class="n">cpuid</span> <span class="n">flags</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVL</span>    <span class="o">$</span><span class="m">1</span><span class="p">,</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="n">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVL</span>    <span class="n">AX</span><span class="p">,</span> <span class="n">runtime</span>·<span class="nf">processorVersionInfo</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="n">nocpuinfo</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">cgo</span> 初始化相关，<span class="n">_cgo_init</span> 为全局变量
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="nf">_cgo_init</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 检查 <span class="n">AX</span> 是否为 <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">TESTQ</span>   <span class="n">AX</span><span class="p">,</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 跳转到 <span class="n">needtls</span>
</span></span><span class="line"><span class="cl">    <span class="n">JZ</span>  <span class="n">needtls</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">arg</span> <span class="m">1</span><span class="o">:</span> <span class="n">g0</span><span class="p">,</span> <span class="n">already</span> <span class="n">in</span> <span class="n">DI</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="o">$</span><span class="n">setg_gcc</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">SI</span> <span class="o">//</span> <span class="n">arg</span> <span class="m">2</span><span class="o">:</span> <span class="n">setg_gcc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">AX</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 如果开启了 <span class="n">CGO</span> 特性，则会修改 <span class="n">g0</span> 的部分字段
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="o">$</span><span class="n">runtime</span>·<span class="nf">g0</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ    </span><span class="p">(</span><span class="n">g_stack</span><span class="o">+</span><span class="n">stack_lo</span><span class="p">)(</span><span class="n">CX</span><span class="p">),</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="n">ADDQ</span>    <span class="o">$</span><span class="n">const__StackGuard</span><span class="p">,</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">AX</span><span class="p">,</span> <span class="nf">g_stackguard0</span><span class="p">(</span><span class="n">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">AX</span><span class="p">,</span> <span class="nf">g_stackguard1</span><span class="p">(</span><span class="n">CX</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The following is the execution of <code>needtls</code> code block, initialize tls and m0, tls is the thread local storage, in the golang program running process, each m needs to be associated with a work thread, so how does the work thread know its associated m, at this time will use the thread local storage, thread local storage is the thread private global variable, through the thread local storage can be for Each thread can initialize a private global variable m, and then each thread can use the same global variable name to access a different m structure object. As will be analyzed later, each worker thread m actually uses thread-local storage to implement a private global variable for that worker thread that points to an instance of the m structure object just before it is created and enters the scheduling loop.</p>
<p>In the code analysis later, you will often see calls to the <code>getg</code> function. The <code>getg</code> function will fetch the currently running g from the thread local store, in this case the g0 associated with m.</p>
<p>The tls address will be written to m0, and m0 will be bound to g0, so you can get g0 directly from tls.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">//</span> 下面开始初始化<span class="nf">tls</span><span class="p">(</span><span class="n">thread</span> <span class="n">local</span> <span class="n">storage</span>，线程本地存储<span class="p">)</span>，设置 <span class="n">m0</span> 为线程私有变量，将 <span class="n">m0</span> 绑定到主线程
</span></span><span class="line"><span class="cl"><span class="n">needtls</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">LEAQ</span>    <span class="n">runtime</span>·<span class="n">m0</span><span class="o">+</span><span class="nf">m_tls</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">DI</span>  <span class="o">//</span><span class="n">DI</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m0.tls</span>，取<span class="n">m0的tls成员的地址到DI寄存器</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 调用 <span class="n">runtime</span>·<span class="n">settls</span> 函数设置线程本地存储，<span class="n">runtime</span>·<span class="n">settls</span> 函数的参数在 <span class="n">DI</span> 寄存器中
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 在 <span class="n">runtime</span>·<span class="n">settls</span> 函数中将 <span class="n">m0.tls[1]</span> 的地址设置为 <span class="n">tls</span> 的地址
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">runtime</span>·<span class="n">settls</span> 函数在 <span class="n">runtime</span><span class="o">/</span><span class="n">sys_linux_amd64.s</span><span class="c1">#599</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">settls</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 此处是在验证本地存储是否可以正常工作，确保值正确写入了 <span class="n">m0.tls</span>，
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 如果有问题则 <span class="n">abort</span> 退出程序
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">get_tls</span> 是宏，位于 <span class="n">runtime</span><span class="o">/</span><span class="n">go_tls.h</span>
</span></span><span class="line"><span class="cl">    <span class="nf">get_tls</span><span class="p">(</span><span class="n">BX</span><span class="p">)</span> 					 <span class="o">//</span> 将 <span class="n">tls</span> 的地址放入 <span class="n">BX</span> 中<span class="p">,</span>即 <span class="n">BX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m0.tls[1]</span> 
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="o">$</span><span class="mh">0x123</span><span class="p">,</span> <span class="nf">g</span><span class="p">(</span><span class="n">BX</span><span class="p">)</span>  <span class="o">//</span> <span class="n">BX</span> <span class="o">=</span> <span class="mh">0x123</span>，即 <span class="n">m0.tls[0]</span> <span class="o">=</span> <span class="mh">0x123</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">runtime</span>·<span class="n">m0</span><span class="o">+</span><span class="nf">m_tls</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">AX</span>    <span class="o">//</span> <span class="n">AX</span> <span class="o">=</span> <span class="n">m0.tls[0]</span>
</span></span><span class="line"><span class="cl">    <span class="n">CMPQ</span>    <span class="n">AX</span><span class="p">,</span> <span class="o">$</span><span class="mh">0x123</span>
</span></span><span class="line"><span class="cl">    <span class="n">JEQ</span> <span class="m">2</span><span class="p">(</span><span class="n">PC</span><span class="p">)</span>   								<span class="o">//</span> 如果相等则向后跳转两条指令即到 <span class="n">ok</span> 代码块
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">abort</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>   <span class="o">//</span> 使用 <span class="n">INT</span> 指令执行中断
</span></span></code></pre></td></tr></table>
</div>
</div><p>Continuing with the ok code block, the main logic is.</p>
<ul>
<li>Bind m0 to g0 and start the main thread.</li>
<li>Calling the <code>runtime-osinit</code> function to initialize the number of cpu&rsquo;s, the scheduler needs to know how many CPU cores the system currently has when it initializes.</li>
<li>Calling the <code>runtime-schedinit</code> function initializes the m0 and p objects and also sets the maxmcount member of the global variable sched to 10000, limiting the maximum number of OS threads that can be created out of work to 10000.</li>
<li>Call <code>runtime-newproc</code> to create a goroutine for the main function.</li>
<li>call <code>runtime-mstart</code> to start the main thread and execute the main function.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">//</span> 首先将 <span class="n">g0</span> 地址保存在 <span class="n">tls</span> 中，即 <span class="n">m0.tls[0]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g0</span>，然后将 <span class="n">m0</span> 和 <span class="n">g0</span> 绑定
</span></span><span class="line"><span class="cl"><span class="o">//</span> 即 <span class="n">m0.g0</span> <span class="o">=</span> <span class="n">g0</span><span class="p">,</span> <span class="n">g0.m</span> <span class="o">=</span> <span class="n">m0</span>
</span></span><span class="line"><span class="cl"><span class="n">ok</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">get_tls</span><span class="p">(</span><span class="n">BX</span><span class="p">)</span>    							<span class="o">//</span> 获取<span class="n">tls地址到BX寄存器</span>，即 <span class="n">BX</span> <span class="o">=</span> <span class="n">m0.tls[0]</span>
</span></span><span class="line"><span class="cl">    <span class="n">LEAQ</span>    <span class="n">runtime</span>·<span class="nf">g0</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">CX</span>  <span class="o">//</span> <span class="n">CX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g0</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">CX</span><span class="p">,</span> <span class="nf">g</span><span class="p">(</span><span class="n">BX</span><span class="p">)</span> 				  <span class="o">//</span> <span class="n">m0.tls[0]</span><span class="o">=&amp;</span><span class="n">g0</span>
</span></span><span class="line"><span class="cl">    <span class="n">LEAQ</span>    <span class="n">runtime</span>·<span class="nf">m0</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">AX</span>  <span class="o">//</span> <span class="n">AX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">CX</span><span class="p">,</span> <span class="nf">m_g0</span><span class="p">(</span><span class="n">AX</span><span class="p">)</span>  <span class="o">//</span> <span class="n">m0.g0</span> <span class="o">=</span> <span class="n">g0</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">AX</span><span class="p">,</span> <span class="nf">g_m</span><span class="p">(</span><span class="n">CX</span><span class="p">)</span>   <span class="o">//</span> <span class="n">g0.m</span> <span class="o">=</span> <span class="n">m0</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="n">CLD</span>             <span class="o">//</span> <span class="n">convention</span> <span class="n">is</span> <span class="n">D</span> <span class="n">is</span> <span class="n">always</span> <span class="n">left</span> <span class="n">cleared</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">check</span> 函数检查了各种类型以及类型转换是否有问题，位于 <span class="n">runtime</span><span class="o">/</span><span class="n">runtime1.go</span><span class="c1">#137 中</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">check</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 将 <span class="n">argc</span> 和 <span class="n">argv</span> 移动到 <span class="n">SP</span><span class="m">+0</span> 和 <span class="n">SP</span><span class="m">+8</span> 的位置
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 此处是为了将 <span class="n">argc</span> 和 <span class="n">argv</span> 作为 <span class="n">runtime</span>·<span class="n">args</span> 函数的参数
</span></span><span class="line"><span class="cl">    <span class="n">MOVL</span>    <span class="m">16</span><span class="p">(</span><span class="n">SP</span><span class="p">),</span> <span class="n">AX</span>      
</span></span><span class="line"><span class="cl">    <span class="n">MOVL</span>    <span class="n">AX</span><span class="p">,</span> <span class="m">0</span><span class="p">(</span><span class="n">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="m">24</span><span class="p">(</span><span class="n">SP</span><span class="p">),</span> <span class="n">AX</span>      
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="n">AX</span><span class="p">,</span> <span class="m">8</span><span class="p">(</span><span class="n">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">args</span> 函数会从栈中读取参数和环境变量等进行处理
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">args</span> 函数位于 <span class="n">runtime</span><span class="o">/</span><span class="n">runtime1.go</span><span class="c1">#61</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">args</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">osinit</span> 函数用来初始化 <span class="n">cpu</span> 数量，函数位于 <span class="n">runtime</span><span class="o">/</span><span class="n">os_linux.go</span><span class="c1">#301</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">osinit</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">schedinit</span> 函数用来初始化调度器，函数位于 <span class="n">runtime</span><span class="o">/</span><span class="n">proc.go</span><span class="c1">#654</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">schedinit</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 创建第一个 <span class="n">goroutine</span> 执行 <span class="n">runtime.main</span> 函数。获取 <span class="n">runtime.main</span> 的地址，调用 <span class="n">newproc</span> 创建 <span class="n">g</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="o">$</span><span class="n">runtime</span>·<span class="nf">mainPC</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">AX</span>     
</span></span><span class="line"><span class="cl">    <span class="n">PUSHQ</span>   <span class="n">AX</span>            <span class="o">//</span> <span class="n">runtime.main</span> 作为 <span class="n">newproc</span> 的第二个参数入栈
</span></span><span class="line"><span class="cl">    <span class="n">PUSHQ</span>   <span class="o">$</span><span class="m">0</span>            <span class="o">//</span> <span class="n">newproc</span> 的第一个参数入栈，该参数表示<span class="n">runtime.main函数需要的参数大小</span>，<span class="n">runtime.main没有参数</span>，所以这里是<span class="m">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">newproc</span> 创建一个新的 <span class="n">goroutine</span> 并放置到等待队列里，该 <span class="n">goroutine</span> 会执行<span class="n">runtime.main</span> 函数， 函数位于 <span class="n">runtime</span><span class="o">/</span><span class="n">proc.go</span><span class="c1">#4250</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">newproc</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> 弹出栈顶的数据
</span></span><span class="line"><span class="cl">    <span class="n">POPQ</span>    <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="n">POPQ</span>    <span class="n">AX</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">mstart</span> 函数会启动主线程进入调度循环，然后运行刚刚创建的 <span class="n">goroutine</span>，<span class="n">mstart</span> 会阻塞住，除非函数退出，<span class="n">mstart</span> 函数位于 <span class="n">runtime</span><span class="o">/</span><span class="n">proc.go</span><span class="c1">#1328</span>
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">mstart</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CALL</span>    <span class="n">runtime</span>·<span class="nf">abort</span><span class="p">(</span><span class="n">SB</span><span class="p">)</span>   <span class="o">//</span> <span class="n">mstart</span> <span class="n">should</span> <span class="n">never</span> <span class="n">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">RET</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Prevent</span> <span class="n">dead</span><span class="o">-</span><span class="n">code</span> <span class="n">elimination</span> <span class="n">of</span> <span class="n">debugCallV2</span><span class="p">,</span> <span class="n">which</span> <span class="n">is</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">intended</span> <span class="n">to</span> <span class="n">be</span> <span class="n">called</span> <span class="n">by</span> <span class="n">debuggers.</span>
</span></span><span class="line"><span class="cl">    <span class="n">MOVQ</span>    <span class="o">$</span><span class="n">runtime</span>·<span class="n">debugCallV2</span><span class="o">&lt;</span><span class="n">ABIInternal</span><span class="o">&gt;</span><span class="p">(</span><span class="n">SB</span><span class="p">),</span> <span class="n">AX</span>
</span></span><span class="line"><span class="cl">    <span class="n">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The process memory space layout at this point is shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/06/d0776c17137b46fbaf54a43953223e4c.png" alt="process memory space layout"></p>
<h3 id="23-view-elf-binary-file-structure">2.3. View ELF binary file structure</h3>
<p>You can view the structure of the ELF binary file by using the readelf command. You can see the contents of the code area and data area in the binary file, global variables are stored in the data area and functions are stored in the code area.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">$</span> <span class="n">readelf</span> <span class="o">-</span><span class="n">s</span> <span class="n">main</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">runtime.g0</span>
</span></span><span class="line"><span class="cl">  <span class="m">1765</span><span class="o">:</span> <span class="m">000000000054</span><span class="n">b3a0</span>   <span class="m">376</span> <span class="n">OBJECT</span>  <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="m">11</span> <span class="n">runtime.g0</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="n">_cgo_init</span> 为全局变量
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">readelf</span> <span class="o">-</span><span class="n">s</span> <span class="n">main</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">_cgo_init</span>
</span></span><span class="line"><span class="cl">  <span class="m">2159</span><span class="o">:</span> <span class="m">000000000054</span><span class="n">aa88</span>     <span class="m">8</span> <span class="n">OBJECT</span>  <span class="n">GLOBAL</span> <span class="n">DEFAULT</span>   <span class="m">11</span> <span class="n">_cgo_init</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-summary">3. Summary</h2>
<p>This article mainly introduces the key code in the Golang program startup process, the main code of the startup process is written through Plan9 assembly, if you have not done the underlying related things look very difficult, the author of some of the details are not fully understood, if interested in discussing some of the details of the implementation in private, there are some hard-coded numbers as well as the operating system and hardware The specification is relatively difficult to understand. The analysis of several components in Golang runtime will be written one after another.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/go-func-return/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">The difference between function return values and pointers in Golang</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-gmp/">
            <span class="next-text nav-default">Analysis of Golang GPM Models</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
