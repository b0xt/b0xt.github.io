<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Istio Sidecar injection mechanism - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="In this article, we analyze the injection mechanism of Sidecar based on Istio, a Service Mesh implementation." /><meta name="keywords" content="Istio Sidecar, Injection" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/istio-sidecar-injection/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Istio Sidecar injection mechanism" />
<meta property="og:description" content="In this article, we analyze the injection mechanism of Sidecar based on Istio, a Service Mesh implementation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/istio-sidecar-injection/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-17T13:15:00+08:00" />
<meta property="article:modified_time" content="2022-07-17T13:15:00+08:00" />

<meta itemprop="name" content="Istio Sidecar injection mechanism">
<meta itemprop="description" content="In this article, we analyze the injection mechanism of Sidecar based on Istio, a Service Mesh implementation."><meta itemprop="datePublished" content="2022-07-17T13:15:00+08:00" />
<meta itemprop="dateModified" content="2022-07-17T13:15:00+08:00" />
<meta itemprop="wordCount" content="1428">
<meta itemprop="keywords" content="Istio," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Istio Sidecar injection mechanism"/>
<meta name="twitter:description" content="In this article, we analyze the injection mechanism of Sidecar based on Istio, a Service Mesh implementation."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Istio Sidecar injection mechanism</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-17 13:15:00 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1428 words </span>
          <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#service-mesh-and-sidecar-concepts">Service Mesh and Sidecar Concepts</a></li>
        <li><a href="#admission-controller-and-admission-webhook">Admission Controller and Admission Webhook</a></li>
        <li><a href="#istio-sidecar-auto-injection-implementation">Istio Sidecar Auto-Injection Implementation</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="service-mesh-and-sidecar-concepts">Service Mesh and Sidecar Concepts</h2>
<p>Before understanding the injection mechanism of Sidecar, it&rsquo;s important to clarify the what and why questions.</p>
<p>First, what is a Service Mesh?</p>
<p>Service Mesh, or translated as &ldquo;Service Mesh&rdquo;, is a configurable low-latency <strong>infrastructure layer</strong> designed to <strong>handle a large amount of network-based inter-process communication</strong> between application services through APIs (Application Programming Interfaces). The Service Grid ensures fast, reliable and secure communication between infrastructure services of containerized transient presence applications. Grids provide key functionality including service discovery, load balancing, encryption, observability, traceability, authentication and authorization, and support for circuit breaker mode. In fact, the purpose of Service Mesh is most simply stated as &ldquo;<strong>takeover and governance of communication between applications</strong>&rdquo;, where one of the most central points is that <strong>communication</strong>, Service Mesh-based service governance is to &ldquo;tinker&rdquo; with the communication or invocation process of services, away from this point, Service Mesh is meaningless, of course, the application seems The application also seems to be meaningless. The diagram below shows a typical Service Mesh infrastructure layer architecture.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/17/6b23a0a0b87844d8a6550731c02c4990.png" alt="typical Service Mesh infrastructure layer architecture"></p>
<p>As you can see, there are Control Plane and Data Plane, the main role of Control Plane is to control and distribute the governance rules, while the main role of Data Plane is to handle the communication process between service instances and implement the specified governance policies. In the Data Plane, you can see the protagonist of today, that is, Sidecar.</p>
<p>As indicated in the diagram, Sidecar is most accurately referred to as &ldquo;Sidecar Proxy&rdquo;, which is essentially a proxy component. This component is injected directly into the same Network Namesapce as the service instance. In Kubernetes, it is injected into the Pod. In this case, Sidecar shares the Pod Network Namespace with the service instance, and inbound and outbound traffic flowing through the instance can be handled with appropriate rules via iptables.</p>
<p>In this article, we analyze the injection mechanism of Sidecar based on Istio, a Service Mesh implementation.</p>
<h2 id="admission-controller-and-admission-webhook">Admission Controller and Admission Webhook</h2>
<p>Sidecar&rsquo;s injection relies on several Kubernetes concepts, the more central of which are the Admission Controller and Admission Webhook.</p>
<p><strong>Admission Controller</strong>, as officially explained, is a gateway that intercepts API Server requests (authenticated) and can modify the request object or deny the request. In short, it can be thought of as an interceptor, similar to a middleware in a web framework, a means used by the Kubernetes API Server to intercept requests.</p>
<p>Why does Kubernetes introduce admission as a mechanism?</p>
<ol>
<li>Although Kubernetes has Authentication &amp; Authorization, which is an authentication and authentication mechanism, Authentication &amp; Authorization runs in a filter and <strong>can only get the http request header and certificate, but not the request body</strong>. So you can&rsquo;t do any operation on the requested object, because you can&rsquo;t get the object.</li>
<li>The Admission Controller runs in the API Server&rsquo;s add/delete handler and can naturally manipulate the API resource.</li>
</ol>
<p>After the API Server receives the client request, it first authenticates and authenticates the request, and only after the authentication and authentication are passed will it proceed to the subsequent endpoint handler processing. kube-apiserver processes the resource request as follows.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/17/7199252a9d564d7bb79ae71a88e26e80.png" alt="ube-apiserver processes the resource request"></p>
<p>As you can see, after Authentication &amp; Authorization, the request is handed over to the Admission Controller for further processing, which involves two important phases of Admission, <code>Mutating</code> and <code>Validating</code>, the differences of which are as follows.</p>
<ul>
<li>Mutating: allows modifications to the request content.</li>
<li>Validating: does not allow modification of the request content, but can determine whether to proceed with the request or reject it based on the content of the request.</li>
</ul>
<p>Kubernetes provides a lot of built-in Admission Controller Plugin, and some common admission control policies can be found.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl"># The supported plugins are as follows
</span></span><span class="line"><span class="cl">AlwaysAdmit, AlwaysDeny, AlwaysPullImages, 
</span></span><span class="line"><span class="cl">DefaultStorageClass, DefaultTolerationSeconds, DenyEscalatingExec, 
</span></span><span class="line"><span class="cl">DenyExecOnPrivileged, EventRateLimit, ExtendedResourceToleration, 
</span></span><span class="line"><span class="cl">ImagePolicyWebhook, Initializers, LimitPodHardAntiAffinityTopology, 
</span></span><span class="line"><span class="cl">LimitRanger, MutatingAdmissionWebhook, NamespaceAutoProvision, 
</span></span><span class="line"><span class="cl">NamespaceExists, NamespaceLifecycle, NodeRestriction, 
</span></span><span class="line"><span class="cl">OwnerReferencesPermissionEnforcement, PersistentVolumeClaimResize, 
</span></span><span class="line"><span class="cl">PersistentVolumeLabel, PodNodeSelector, PodPreset, PodSecurityPolicy, 
</span></span><span class="line"><span class="cl">PodTolerationRestriction, Priority, ResourceQuota, SecurityContextDeny, 
</span></span><span class="line"><span class="cl">ServiceAccount, StorageObjectInUseProtection, ValidatingAdmissionWebhook. 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Kubernetes provides so many Admission plugins, but they are not guaranteed to meet the needs of all developers. Therefore, Kubernetes also allows users to customize their own Admission Controller, and Kubernetes provides the Admission Webhook extension mechanism.</p>
<ul>
<li><strong>MutatingAdmissionWebhook</strong>: modifying objects before they persist</li>
<li><strong>ValidatingAdmissionWebhook</strong>: makes changes before the object is persisted</li>
</ul>
<p>Admission Webhook is a synchronous call that requires the user to develop and deploy their own <strong>webhook server</strong> and create a custom configuration resource object: ValidatingWebhookConfiguration or MutatingWebhookConfiguration.</p>
<p>It can be said that with the Admission Webhook extension mechanism, it really paves the way for the Sidecar injection implementation later.</p>
<h2 id="istio-sidecar-auto-injection-implementation">Istio Sidecar Auto-Injection Implementation</h2>
<p>Sidecar Injector is the component in Istio that implements automatic Sidecar injection, which is running as the Kubernetes Admission Controller. Recall from the previous concept that the basic principle of the Admission Controller is to intercept requests from the Kube-apiserver, before object persistence and after authentication and authentication. As mentioned before, there are two types of Admission Controllers: one is built-in and the other is user-defined. The latter is where Kubernetes allows users to customize the admission controller in the form of a Webhook, and Sidecar Injector is one such special <strong>MutatingAdmissionWebhook</strong>.</p>
<p>The Sidecar injection process is shown in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/17/0d2f14d63a644f17827e9e36a22f4780.png" alt="Sidecar injection process"></p>
<p>As shown in the figure, Sidecar Injector only performs Sidecar container injection when creating Pods, and after the Pod creation request arrives at Kube-apiserver, it first performs authentication and authentication, and then in the access control phase, Kube-apiserver calls Sidecar Injector in a REST manner simultaneously. Webhook service to init and inject the istio-proxy container, and finally store the Pod object persistently in the etcd.</p>
<p>See also the configuration of <strong>MutatingWebhookConfiguration</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get MutatingWebhookConfiguration istio-sidecar-injector -n istio-system -o yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>istio-sidecar-injector MutatingWebhookConfiguration</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">admissionregistration.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MutatingWebhookConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      </span><span class="w">      </span>{<span class="s2">&#34;apiVersion&#34;</span><span class="p">:</span><span class="s2">&#34;admissionregistration.k8s.io/v1beta1&#34;</span><span class="p">,</span><span class="s2">&#34;kind&#34;</span><span class="p">:</span><span class="s2">&#34;MutatingWebhookConfiguration&#34;</span><span class="p">,</span><span class="s2">&#34;metadata&#34;</span><span class="p">:</span>{<span class="s2">&#34;annotations&#34;</span><span class="p">:</span>{}<span class="p">,</span><span class="s2">&#34;labels&#34;</span><span class="p">:</span>{<span class="s2">&#34;app&#34;</span><span class="p">:</span><span class="s2">&#34;sidecar-injector&#34;</span><span class="p">,</span><span class="s2">&#34;install.operator.istio.io/owning-resource&#34;</span><span class="p">:</span><span class="s2">&#34;installed-state&#34;</span><span class="p">,</span><span class="s2">&#34;istio.io/rev&#34;</span><span class="p">:</span><span class="s2">&#34;default&#34;</span><span class="p">,</span><span class="s2">&#34;operator.istio.io/component&#34;</span><span class="p">:</span><span class="s2">&#34;Pilot&#34;</span><span class="p">,</span><span class="s2">&#34;operator.istio.io/managed&#34;</span><span class="p">:</span><span class="s2">&#34;Reconcile&#34;</span><span class="p">,</span><span class="s2">&#34;operator.istio.io/version&#34;</span><span class="p">:</span><span class="s2">&#34;1.6.2&#34;</span><span class="p">,</span><span class="s2">&#34;release&#34;</span><span class="p">:</span><span class="s2">&#34;istio&#34;</span>}<span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;istio-sidecar-injector&#34;</span>}<span class="p">,</span><span class="s2">&#34;webhooks&#34;</span><span class="p">:[</span>{<span class="s2">&#34;clientConfig&#34;</span><span class="p">:</span>{<span class="s2">&#34;caBundle&#34;</span><span class="p">:</span><span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;service&#34;</span><span class="p">:</span>{<span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;istiod&#34;</span><span class="p">,</span><span class="s2">&#34;namespace&#34;</span><span class="p">:</span><span class="s2">&#34;istio-system&#34;</span><span class="p">,</span><span class="s2">&#34;path&#34;</span><span class="p">:</span><span class="s2">&#34;/inject&#34;</span>}}<span class="p">,</span><span class="s2">&#34;failurePolicy&#34;</span><span class="p">:</span><span class="s2">&#34;Fail&#34;</span><span class="p">,</span><span class="s2">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;sidecar-injector.istio.io&#34;</span><span class="p">,</span><span class="s2">&#34;namespaceSelector&#34;</span><span class="p">:</span>{<span class="s2">&#34;matchLabels&#34;</span><span class="p">:</span>{<span class="s2">&#34;istio-injection&#34;</span><span class="p">:</span><span class="s2">&#34;enabled&#34;</span>}}<span class="p">,</span><span class="s2">&#34;rules&#34;</span><span class="p">:[</span>{<span class="s2">&#34;apiGroups&#34;</span><span class="p">:[</span><span class="s2">&#34;&#34;</span><span class="p">],</span><span class="s2">&#34;apiVersions&#34;</span><span class="p">:[</span><span class="s2">&#34;v1&#34;</span><span class="p">],</span><span class="s2">&#34;operations&#34;</span><span class="p">:[</span><span class="s2">&#34;CREATE&#34;</span><span class="p">],</span><span class="s2">&#34;resources&#34;</span><span class="p">:[</span><span class="s2">&#34;pods&#34;</span><span class="p">]</span>}<span class="p">],</span><span class="s2">&#34;sideEffects&#34;</span><span class="p">:</span><span class="s2">&#34;None&#34;</span>}<span class="p">]</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2020-06-16T06:47:00Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">sidecar-injector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">install.operator.istio.io/owning-resource</span><span class="p">:</span><span class="w"> </span><span class="l">installed-state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">istio.io/rev</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator.istio.io/component</span><span class="p">:</span><span class="w"> </span><span class="l">Pilot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator.istio.io/managed</span><span class="p">:</span><span class="w"> </span><span class="l">Reconcile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operator.istio.io/version</span><span class="p">:</span><span class="w"> </span><span class="m">1.6.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">istio</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">managedFields</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">webhooks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">admissionReviewVersions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clientConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l">LS0tLS1CRUdJTiBDRVJUSUZJQ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istiod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/inject</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">failurePolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Fail</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">matchPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Exact</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sidecar-injector.istio.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">istio-injection</span><span class="p">:</span><span class="w"> </span><span class="l">enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">objectSelector</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">reinvocationPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiVersions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">operations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">CREATE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">pods</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sideEffects</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>By default, Sidecar Injector only takes effect for the creation of Pod resource objects under the namespace whose tag matches <code>istio-injection: enabled</code>. The access path to the Webhook service is <code>/inject</code>, and the address and access credentials are configured under the clientConfig field. The Istio Sidecar Injector component is implemented by the sidecar-injector process, and the Sidecar Injector implementation consists of two main parts.</p>
<ul>
<li>MutatingWebhookConfiguration</li>
<li>Webhook Server, which automatically injects Sidecar containers for application workloads</li>
</ul>
<p>Sidecar Injector handles the AdmissionRequest requests from Kube-apiserver as a lightweight HTTPS server.</p>
<p>Typically the Pod Sidecar container is injected by the following steps:</p>
<ol>
<li>parsing the Webhook REST request to deserialize the raw AdmissionReview data.</li>
<li>parsing the Pod and deserializing the AdmissionRequest in the AdmissionReview.</li>
<li>render the Sidecar configuration template using the Pod and the grid configuration.</li>
<li>create a JSON patch using the Pod and the rendered template.</li>
<li>construct the AdmissionResponse.</li>
<li>construct the AdmissionReview and send it to the HTTP client, the Kube-apiserver, after JSON encoding.</li>
</ol>
<p>You can view the injected configuration item istio-sidecar-injector.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl describe configmap istio-sidecar-injector -n istio-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>istio-sidecar-injector configmap(Abbreviated version)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">Name</span><span class="p">:</span><span class="w">         </span><span class="l">istio-sidecar-injector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Namespace</span><span class="p">:</span><span class="w">    </span><span class="l">istio-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Labels</span><span class="p">:</span><span class="w">       </span><span class="l">install.operator.istio.io/owning-resource=installed-state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">istio.io/rev=default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">operator.istio.io/component=Pilot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">operator.istio.io/managed=Reconcile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">operator.istio.io/version=1.6.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="l">release=istio</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">Annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">Data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">====</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span>-<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l">enabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">  rewriteAppHTTPProbe: {{ valueOrDefault .Values.sidecarInjectorWebhook.rewriteAppHTTPProbe false }}
</span></span></span><span class="line"><span class="cl"><span class="sd">  initContainers:
</span></span></span><span class="line"><span class="cl"><span class="sd">  	...
</span></span></span><span class="line"><span class="cl"><span class="sd">  - name: istio-validation
</span></span></span><span class="line"><span class="cl"><span class="sd">  	...
</span></span></span><span class="line"><span class="cl"><span class="sd">  - name: istio-init</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">istio-iptables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;-p&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="m">15001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-proxy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">15090</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http-envoy-prom</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JWT_POLICY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span>{{<span class="w"> </span><span class="l">.Values.global.jwtPolicy }}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ConfigMap stores the default injection policies and sidecar injection templates. policy:</p>
<ul>
<li>disabled: sidecar injectors are not injected into the pod by default. Adding the annotation sidecar.istio.io/inject to the pod template definition with a value of true will enable the injection feature.</li>
<li>enabled: sidecar injector will be injected into the pod by default. Adding the annotation sidecar.istio.io/inject to the pod template definition with a value of false will disable the injection.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/istio/">Istio</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/istio-sidecar-proxy/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Istio Sidecar&#39;s interception mechanism for traffic</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-concurrent-pattern/">
            <span class="next-text nav-default">A Brief Analysis of Concurrency Models: Shared Memory/Actor/CSP</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
