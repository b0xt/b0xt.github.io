<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Design and implementation of kube-apiserver - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article provides a detailed analysis of the kube-apiserver startup process." /><meta name="keywords" content="Kube Apiserver" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/kube-apiserver/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Design and implementation of kube-apiserver" />
<meta property="og:description" content="This article provides a detailed analysis of the kube-apiserver startup process." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/kube-apiserver/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-07T13:46:05+08:00" />
<meta property="article:modified_time" content="2022-07-07T13:46:05+08:00" />

<meta itemprop="name" content="Design and implementation of kube-apiserver">
<meta itemprop="description" content="This article provides a detailed analysis of the kube-apiserver startup process."><meta itemprop="datePublished" content="2022-07-07T13:46:05+08:00" />
<meta itemprop="dateModified" content="2022-07-07T13:46:05+08:00" />
<meta itemprop="wordCount" content="8583">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Design and implementation of kube-apiserver"/>
<meta name="twitter:description" content="This article provides a detailed analysis of the kube-apiserver startup process."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Design and implementation of kube-apiserver</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-07 13:46:05 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 8583 words </span>
          <span class="more-meta"> 18 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#kube-apiserver-processing-flow">kube-apiserver processing flow</a>
          <ul>
            <li><a href="#decoder">Decoder</a></li>
            <li><a href="#admission">Admission</a></li>
            <li><a href="#validation">Validation</a></li>
          </ul>
        </li>
        <li><a href="#components-in-kube-apiserver">Components in kube-apiserver</a>
          <ul>
            <li><a href="#aggregator">Aggregator</a></li>
            <li><a href="#kubeapiserver">KubeAPIServer</a></li>
            <li><a href="#apiextensionserver">APIExtensionServer</a></li>
          </ul>
        </li>
        <li><a href="#kube-apiserver-boot-process-analysis">kube-apiserver boot process analysis</a>
          <ul>
            <li><a href="#run">Run</a></li>
            <li><a href="#createserverchain">CreateServerChain</a></li>
            <li><a href="#createaggregatorserver">createAggregatorServer</a></li>
            <li><a href="#preparedrun">prepared.Run</a></li>
          </ul>
        </li>
        <li><a href="#storagefactory-construction">StorageFactory construction</a>
          <ul>
            <li><a href="#newlegacyreststorage">NewLegacyRESTStorage</a></li>
            <li><a href="#routing-registration">Routing Registration</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>kube-apiserver is a component in kubernetes that interacts directly with etcd and controls changes to core resources in kubernetes. It provides the following main functions.</p>
<ul>
<li>Providing <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/">Kubernetes API</a>, including authentication authorization, data validation, and cluster state changes, for clients and other components to call.</li>
<li>Proxy some additional component components in the cluster, such as Kubernetes UI, metrics-server, npd, etc.</li>
<li>Creating kubernetes services, i.e., Service that provides apiserver, kubernetes Service.</li>
<li>conversion of resources between different versions.</li>
</ul>
<h2 id="kube-apiserver-processing-flow">kube-apiserver processing flow</h2>
<p>kube-apiserver interacts with other components mainly by providing APIs to the outside world, which can be obtained by calling kube-apiserver&rsquo;s interface <code>$ curl -k https://&lt;masterIP&gt;:6443</code> or through its provided <strong>swagger-ui</strong>, which has the following three main APIs.</p>
<ul>
<li>core groups: mainly under <code>/api/v1</code>.</li>
<li>named groups: whose path is <code>/apis/$NAME/$VERSION</code>.</li>
<li>Some APIs that expose system state: such as <code>/metrics</code>, <code>/healthz</code>, etc.</li>
</ul>
<p>The URL of the API consists roughly of <code>/apis/group/version/namespaces/my-ns/myresource</code>, where the structure of the API is roughly as shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/07/017ecfc63e544d7d9889bf1bcb8d68b9.png" alt="structure of the API"></p>
<p>After understanding the API of kube-apiserver, the following section describes how kube-apiserver handles an API request. The complete flow of a request is shown in the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/07/73932f5a4808458bab872060beb7b07c.png" alt="complete flow of a request"></p>
<p>An example of a POST request is shown here. When the request arrives at kube-apiserver, kube-apiserver first executes the filter chain registered in the http filter chain, which performs a series of filtering operations, mainly authentication, authentication and other checking operations. When the filter chain is finished, the request is routed to the corresponding handler, which mainly interacts with etcd. The main operations in the handler are as follows</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/07/fbe71342eaf9456bbf81c093cf397e3a.png" alt="http filter chain "></p>
<h3 id="decoder">Decoder</h3>
<p>Most resources in kubernetes will have an <code>internal version</code>, because a resource may have multiple versions throughout the development process. e.g. a deployment will have <code>extensions/v1beta1</code>, <code>apps/v1</code>. To avoid problems, kube-apiserver has to know how to convert between each pair of versions (e.g., v1⇔v1alpha1, v1⇔v1beta1, v1beta1⇔v1alpha1). Therefore it uses a special <code>internal version</code>, which is a generic version that contains all the fields of the version and has the functionality of all versions. Decoder will first convert the creater object to <code>internal version</code> and then convert it to <code>storage version</code>, which is another version when stored in etcd.</p>
<p>When decoding, it first gets the expected version from the HTTP path, then uses scheme to create a matching empty object with the correct version, and uses a JSON or protobuf decoder to convert it, and in the first step of the conversion, if the user omits some fields, Decoder sets them to default values.</p>
<h3 id="admission">Admission</h3>
<p>After the decoding is done, you need to check if the objects can be created or updated by verifying the global constraints of the cluster and setting the default values according to the cluster configuration. You can see all the global constraint plugins that kube-apiserver can use in the <code>k8s.io/kubernetes/plugin/pkg/admission</code> directory. kube-apiserver is started by setting the <code>-enable-admission-plugins</code> parameter to The plugins added via <code>-ValidatingAdmissionWebhook</code> or <code>-MutatingAdmissionWebhook</code> will also work here.</p>
<h3 id="validation">Validation</h3>
<p>Mainly check the legality of the fields in the object.</p>
<p>After executing the above operations in the handler, the last operation related to etcd will be executed, and the POST operation will write the data to etcd. The main processing flow of the above in the handler is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">v1beta1 ⇒ internal ⇒    |    ⇒       |    ⇒  v1  ⇒ json/yaml ⇒ etcd
</span></span><span class="line"><span class="cl">                     admission    validation
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="components-in-kube-apiserver">Components in kube-apiserver</h2>
<p>The kube-apiserver consists of 3 components (Aggregator, KubeAPIServer, APIExtensionServer), which handle requests in turn through Delegation.</p>
<ul>
<li><strong>Aggregator</strong>: exposes functions similar to a seven-tier load balancing, intercepting requests from users for forwarding to other servers, and is responsible for the Discovery function of the entire APIServer.</li>
<li><strong>KubeAPIServer</strong>: responsible for some general processing of requests, authentication, authentication, etc., as well as handling the REST services for each built-in resource.</li>
<li><strong>APIExtensionServer</strong>: mainly handles CustomResourceDefinition (CRD) and CustomResource (CR) REST requests, and is the last link of Delegation, returning 404 if the corresponding CR cannot be processed.</li>
</ul>
<p>Aggregator and APIExtensionsServer correspond to the two main ways of extending APIServer resources, i.e. AA and CRD respectively.</p>
<h3 id="aggregator">Aggregator</h3>
<p>Aggregator forwards requests by associating APIServices objects to a Service, and the type of Service it is associated with further determines the form of request forwarding. Aggregator consists of a <code>GenericAPIServer</code> and a Controller that maintains its own state. The <code>GenericAPIServer</code> mainly handles requests for APIService resources under the <code>apiregistration.k8s.io</code> group.</p>
<p>Aggregator contains several controllers in addition to handling resource requests:</p>
<ul>
<li><code>apiserviceRegistrationController</code>: responsible for the registration and deletion of resources in APIServices.</li>
<li><code>availableConditionController</code>: maintains the availability status of APIServices, including whether its referenced Service is available, etc.</li>
<li><code>autoRegistrationController</code>: used to maintain a specific set of APIServices that exist in the API.</li>
<li><code>crdRegistrationController</code>: responsible for the automatic registration of CRD GroupVersions into APIServices.</li>
<li><code>openAPIAggregationController</code>: synchronizes changes to APIServices resources to the provided OpenAPI documentation.</li>
</ul>
<p>Some additional components in kubernetes, such as metrics-server are extended by way of Aggregator, which can be used in a real environment by using <a href="https://github.com/kubernetes-sigs/apiserver-builder-alpha">apiserver-builder</a> tool to easily create custom resources as Aggregator extensions.</p>
<h4 id="enabling-api-aggregation">Enabling API Aggregation</h4>
<p>The following configuration needs to be added to kube-apiserver to enable API Aggregation.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">--proxy-client-cert-file=/etc/kubernetes/certs/proxy.crt
</span></span><span class="line"><span class="cl">--proxy-client-key-file=/etc/kubernetes/certs/proxy.key
</span></span><span class="line"><span class="cl">--requestheader-client-ca-file=/etc/kubernetes/certs/proxy-ca.crt
</span></span><span class="line"><span class="cl">--requestheader-allowed-names=aggregator
</span></span><span class="line"><span class="cl">--requestheader-extra-headers-prefix=X-Remote-Extra-
</span></span><span class="line"><span class="cl">--requestheader-group-headers=X-Remote-Group
</span></span><span class="line"><span class="cl">--requestheader-username-headers=X-Remote-User
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="kubeapiserver">KubeAPIServer</h3>
<p>KubeAPIServer mainly provides requests for API Resource operations, registers routing information for many APIs in kubernetes, exposes RESTful APIs and provides kubernetes services to the public.</p>
<p>It enables services in and outside the cluster to manipulate resources in kubernetes through RESTful APIs.</p>
<h3 id="apiextensionserver">APIExtensionServer</h3>
<p>The APIExtensionServer is the final layer of the Delegation chain and is the resource server that handles all the resources defined by users through the Custom Resource Definition.</p>
<p>The controllers included and their functions are shown below.</p>
<ul>
<li><code>openapiController</code>: synchronizes changes to crd resources to the provided OpenAPI documentation, which can be viewed by visiting <code>/openapi/v2</code>.</li>
<li><code>crdController</code>: responsible for registering crd information into apiVersions and apiResources, both of which can be viewed via <code>$ kubectl api-versions</code> and <code>$ kubectl api-resources</code>.</li>
<li><code>namingController</code>: check for naming conflicts in crd obj, viewable in crd <code>.status.conditions</code>.</li>
<li><code>establishingController</code>: checks if crd is in normal status, available in crd <code>.status.conditions</code>.</li>
<li><code>nonStructuralSchemaController</code>: checks if the crd obj structure is normal, available in crd <code>.status.conditions</code>.</li>
<li><code>apiApprovalController</code>: checks if the crd follows the kubernetes API declaration policy, available in crd <code>.status.conditions</code>.</li>
<li><code>finalizingController</code>: a function similar to finalizes, related to the removal of CRs.</li>
</ul>
<h2 id="kube-apiserver-boot-process-analysis">kube-apiserver boot process analysis</h2>
<blockquote>
<p>kubernetes version: v1.16</p>
</blockquote>
<p>First, we analyze how kube-apiserver is started. kube-apiserver also starts the main logic through its <code>Run</code> method, and before the <code>Run</code> method is called, it parses command line parameters, sets default values, etc.</p>
<h3 id="run">Run</h3>
<p>The main logic of the <code>Run</code> method is.</p>
<ul>
<li>Call <code>CreateServerChain</code> to build the service call chain and determine whether to start the non-secure http server. The http server chain contains the three servers to be started by apiserver, and the routes to register the corresponding resources for each server.</li>
<li>Call <code>server.PrepareRun</code> to prepare the service for running, which mainly completes the health check, survival check and registration of the <code>OpenAPI</code> route.</li>
<li>Call <code>prepared.Run</code> to start the https server.</li>
</ul>
<p>The server is initialized using the Delegation pattern, and the basic API Server, CustomResource, and Aggregator services are chained together through the DelegationTarget interface to provide services to the outside world.</p>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/server.go:147</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">completeOptions</span> <span class="nx">completedServerRunOptions</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateServerChain</span><span class="p">(</span><span class="nx">completeOptions</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">prepared</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">PrepareRun</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">prepared</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="createserverchain">CreateServerChain</h3>
<p><code>CreateServerChain</code> is the method to complete the server initialization, which contains all the processes of <code>APIExtensionsServer</code>, <code>KubeAPIServer</code>, <code>AggregatorServer</code> initialization, and finally returns <code>aggregatorapiserver. APIAggregator</code> instance, the initialization process mainly includes: the configuration of http filter chain, the registration of API Group, the association of http path with handler and the configuration of handler backend storage etcd. The main logic is as follows.</p>
<ul>
<li>Create the configuration required by KubeAPIServer by calling <code>CreateKubeAPIServerConfig</code>, mainly creating <code>master.Config</code>, which will call <code>buildGenericConfig</code> to generate genericConfig, which contains the core configuration of the core configuration of apiserver.</li>
<li>determine if the extended API server is enabled and call <code>createAPIExtensionsConfig</code> to create a configuration for it. apiExtensions server is a proxy service for other servers in the kubeapiserver, such as the metric-server.</li>
<li>Call <code>createAPIExtensionsServer</code> to create an instance of apiExtensionsServer.</li>
<li>Call <code>CreateKubeAPIServer</code> to initialize the kubeAPIServer.</li>
<li>Call <code>createAggregatorConfig</code> to create a configuration for the aggregatorServer and call <code>createAggregatorServer</code> to initialize the aggregatorServer.</li>
<li>configure and determine whether to start a non-secure http server.</li>
</ul>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/server.go:165</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CreateServerChain</span><span class="p">(</span><span class="nx">completedOptions</span> <span class="nx">completedServerRunOptions</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">APIAggregator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodeTunneler</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateNodeDialer</span><span class="p">(</span><span class="nx">completedOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、为 kubeAPIServer 创建配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeAPIServerConfig</span><span class="p">,</span> <span class="nx">insecureServingInfo</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">pluginInitializer</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span>                                         <span class="nf">CreateKubeAPIServerConfig</span><span class="p">(</span><span class="nx">completedOptions</span><span class="p">,</span> <span class="nx">nodeTunneler</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、判断是否配置了 APIExtensionsServer，创建 apiExtensionsConfig 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiExtensionsConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAPIExtensionsConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">VersionedInformers</span><span class="p">,</span>        <span class="nx">pluginInitializer</span><span class="p">,</span> <span class="nx">completedOptions</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span> <span class="nx">completedOptions</span><span class="p">.</span><span class="nx">MasterCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">webhook</span><span class="p">.</span><span class="nf">NewDefaultAuthenticationInfoResolverWrapper</span><span class="p">(</span><span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、初始化 APIExtensionsServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiExtensionsServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAPIExtensionsServer</span><span class="p">(</span><span class="nx">apiExtensionsConfig</span><span class="p">,</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewEmptyDelegate</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、初始化 KubeAPIServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeAPIServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateKubeAPIServer</span><span class="p">(</span><span class="nx">kubeAPIServerConfig</span><span class="p">,</span> <span class="nx">apiExtensionsServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 5、创建 AggregatorConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aggregatorConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAggregatorConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">,</span> <span class="nx">completedOptions</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span>          <span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">VersionedInformers</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">pluginInitializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 6、初始化 AggregatorServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAggregatorServer</span><span class="p">(</span><span class="nx">aggregatorConfig</span><span class="p">,</span> <span class="nx">kubeAPIServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">,</span> <span class="nx">apiExtensionsServer</span><span class="p">.</span><span class="nx">Informers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 7、判断是否启动非安全端口的 http server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">insecureServingInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">insecureHandlerChain</span> <span class="o">:=</span> <span class="nx">kubeserver</span><span class="p">.</span><span class="nf">BuildInsecureHandlerChain</span><span class="p">(</span><span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">UnprotectedHandler</span><span class="p">(),</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">insecureServingInfo</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">insecureHandlerChain</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RequestTimeout</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="createkubeapiserverconfig">CreateKubeAPIServerConfig</h4>
<p>The main purpose of <code>CreateKubeAPIServerConfig</code> is to call <code>buildGenericConfig</code> to create genericConfig and build the master.Config object.</p>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/server.go:271</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CreateKubeAPIServerConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="nx">completedServerRunOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodeTunneler</span> <span class="nx">tunneler</span><span class="p">.</span><span class="nx">Tunneler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">proxyTransport</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、构建 genericConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericConfig</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">,</span> <span class="nx">insecureServingInfo</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">pluginInitializers</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">,</span> <span class="nx">storageFactory</span><span class="p">,</span>    <span class="nx">lastErr</span> <span class="p">=</span> <span class="nf">buildGenericConfig</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、初始化所支持的 capabilities
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">capabilities</span><span class="p">.</span><span class="nf">Initialize</span><span class="p">(</span><span class="nx">capabilities</span><span class="p">.</span><span class="nx">Capabilities</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">AllowPrivileged</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">AllowPrivileged</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrivilegedSources</span><span class="p">:</span> <span class="nx">capabilities</span><span class="p">.</span><span class="nx">PrivilegedSources</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">HostNetworkSources</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">HostPIDSources</span><span class="p">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">HostIPCSources</span><span class="p">:</span>     <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PerConnectionBandwidthLimitBytesPerSec</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MaxConnectionBytesPerSec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、获取 service ip range 以及 api server service IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">serviceIPRange</span><span class="p">,</span> <span class="nx">apiServerServiceIP</span><span class="p">,</span> <span class="nx">lastErr</span> <span class="o">:=</span> <span class="nx">master</span><span class="p">.</span><span class="nf">DefaultServiceIPRange</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">PrimaryServiceClusterIPRange</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、构建 master.Config 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">config</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">master</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="o">......</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">nodeTunneler</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">config</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">KubeletClientConfig</span><span class="p">.</span><span class="nx">Dial</span> <span class="p">=</span> <span class="nx">nodeTunneler</span><span class="p">.</span><span class="nx">Dial</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">config</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">KubeletClientConfig</span><span class="p">.</span><span class="nx">Lookup</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">.</span><span class="nx">Lookup</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="buildgenericconfig">buildGenericConfig</h4>
<p>The main logic is as follows.</p>
<ul>
<li>Call <code>genericapiserver.NewConfig</code> to generate the default genericConfig, genericConfig mainly configures <code>DefaultBuildHandlerChain</code>, <code>DefaultBuildHandlerChain</code> contains a series of http filter chains for authentication, authentication, authentication, and a series of http filter chains.</li>
<li>calls <code>master.DefaultAPIResourceConfigSource</code> to load the API Resource that needs to be enabled, all API Resources in the cluster can be seen in the <code>k8s.io/api</code> directory of the code, which will also keep changing as the version iterates.</li>
<li>Setting default values for some of the fields in genericConfig.</li>
<li>Call <code>completedStorageFactoryConfig.New</code> to create the storageFactory, which will be used later to create the corresponding RESTStorage for each API Resource.</li>
</ul>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/server.go:386</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">buildGenericConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">proxyTransport</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、为 genericConfig 设置默认值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericConfig</span> <span class="p">=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">(</span><span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span> <span class="p">=</span> <span class="nx">master</span><span class="p">.</span><span class="nf">DefaultAPIResourceConfigSource</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericServerRunOptions</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="nx">genericConfig</span><span class="p">);</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span> <span class="p">=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">DefaultOpenAPIConfig</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&#34;Kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LongRunningFunc</span> <span class="p">=</span> <span class="nx">filters</span><span class="p">.</span><span class="nf">BasicLongRunningRequestCheck</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="s">&#34;watch&#34;</span><span class="p">,</span> <span class="s">&#34;proxy&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="s">&#34;attach&#34;</span><span class="p">,</span> <span class="s">&#34;exec&#34;</span><span class="p">,</span> <span class="s">&#34;proxy&#34;</span><span class="p">,</span> <span class="s">&#34;log&#34;</span><span class="p">,</span> <span class="s">&#34;portforward&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">kubeVersion</span> <span class="o">:=</span> <span class="nx">version</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">kubeVersion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">storageFactoryConfig</span> <span class="o">:=</span> <span class="nx">kubeapiserver</span><span class="p">.</span><span class="nf">NewStorageFactoryConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storageFactoryConfig</span><span class="p">.</span><span class="nx">ApiResourceConfig</span> <span class="p">=</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span>
</span></span><span class="line"><span class="cl">    <span class="nx">completedStorageFactoryConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">storageFactoryConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Etcd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化 storageFactory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">storageFactory</span><span class="p">,</span> <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">completedStorageFactoryConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">storageFactory</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">EgressLookup</span> <span class="p">=</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">.</span><span class="nx">Lookup</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、初始化 RESTOptionsGetter，后期根据其获取操作 Etcd 的句柄，同时添加 etcd 的健康检查方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Etcd</span><span class="p">.</span><span class="nf">ApplyWithStorageFactoryTo</span><span class="p">(</span><span class="nx">storageFactory</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">);</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、设置使用 protobufs 用来内部交互，并且禁用压缩功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">ContentConfig</span><span class="p">.</span><span class="nx">ContentType</span> <span class="p">=</span> <span class="s">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">DisableCompression</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、创建 clientset
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeClientConfig</span> <span class="o">:=</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span>
</span></span><span class="line"><span class="cl">    <span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientgoclientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">kubeClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create real external clientset: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">versionedInformers</span> <span class="p">=</span> <span class="nx">clientgoinformers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5、创建认证实例，支持多种认证方式：请求 Header 认证、Auth 文件认证、CA 证书认证、Bearer token 认证、
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ServiceAccount 认证、BootstrapToken 认证、WebhookToken 认证等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">SecurityDefinitions</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">BuildAuthenticator</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span>                 <span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid authentication config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6、创建鉴权实例，包含：Node、RBAC、Webhook、ABAC、AlwaysAllow、AlwaysDeny
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">RuleResolver</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">BuildAuthorizer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="nx">serviceResolver</span> <span class="p">=</span> <span class="nf">buildServiceResolver</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">EnableAggregatorRouting</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">authInfoResolverWrapper</span> <span class="o">:=</span> <span class="nx">webhook</span><span class="p">.</span><span class="nf">NewDefaultAuthenticationInfoResolverWrapper</span><span class="p">(</span><span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 7、审计插件的初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Audit</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 8、准入插件的初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pluginInitializers</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">admissionConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create admission plugin initializer: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to initialize admission: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above analysis focuses on the initialization of KubeAPIServerConfig. The initialization of the other two server configs will not be analyzed in detail for now, so we will continue to analyze the initialization of the server.</p>
<h4 id="createapiextensionsserver">createAPIExtensionsServer</h4>
<p>APIExtensionsServer is the first to be initialized, and the server is initialized by calling <code>apiextensionsConfig.Complete().New</code> in <code>createAPIExtensionsServer</code> with the following logic.</p>
<ul>
<li>First call <code>c.GenericConfig.New</code> to initialize the Container according to the <code>go-restful</code> pattern, and in <code>c.GenericConfig.New</code> call <code>NewAPIServerHandler</code> to initialize the handler, APIServerHandler Handler type used by the API Server, including <code>go-restful</code> and <code>non-go-restful</code>, and a Director object of your choice between the two, with <code>go-restful</code> used to handle registered handlers and <code>non-go restful</code> is used to handle non-existent handlers, and the selection process for API URI handling is: <code>FullHandlerChain-&gt; Director -&gt; {GoRestfulContainer, NonGoRestfulMux}</code>. In <code>c.GenericConfig.New</code>, <code>installAPI</code> is also called to add routing information including <code>/</code>, <code>/debug/*</code>, <code>/metrics</code>, <code>/version</code>, etc. All three types of servers are initialized by calling <code>c.GenericConfig.New</code> to initialize a genericServer and then register the API.</li>
<li>Call <code>s.GenericAPIServer.InstallAPIGroup</code> to register the API Resources in the route, the call chain of this method is very deep, mainly to register the API Resource to be exposed to the server, so that the REST operation of the resource can be performed through the http interface. Several other servers also perform the corresponding <code>InstallAPI</code> during initialization.</li>
<li>The controllers that need to be used in the initialization server, mainly <code>openapiController</code>, <code>crdController</code>, <code>namingController</code>, <code>establishingController</code>, <code>nonStructuralSchemaController</code>, <code>apiApprovalController</code>, <code>finalizingControlle</code>r.</li>
<li>Add the controllers and informer that need to be started to the PostStartHook.</li>
</ul>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/apiextensions.go:94</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createAPIExtensionsServer</span><span class="p">(</span><span class="nx">apiextensionsConfig</span> <span class="o">*</span><span class="nx">apiextensionsapiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">delegateAPIServer</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span>  <span class="nx">apiextensionsapiserver</span><span class="p">.</span><span class="nx">CustomResourceDefinitions</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">apiextensionsConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">New</span><span class="p">(</span><span class="nx">delegateAPIServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>k8s.io/kubernetes/staging/src/k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go:132</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="nx">delegationTarget</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CustomResourceDefinitions</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、初始化 genericServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;apiextensions-apiserver&#34;</span><span class="p">,</span> <span class="nx">delegationTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CustomResourceDefinitions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">GenericAPIServer</span><span class="p">:</span> <span class="nx">genericServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、初始化 APIGroup Info，APIGroup 指该 server 需要暴露的 API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiResourceConfig</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewDefaultAPIGroupInfo</span><span class="p">(</span><span class="nx">apiextensions</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Scheme</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span> <span class="nx">Codecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">apiResourceConfig</span><span class="p">.</span><span class="nf">VersionEnabled</span><span class="p">(</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">customResourceDefintionStorage</span> <span class="o">:=</span> <span class="nx">customresourcedefinition</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">storage</span><span class="p">[</span><span class="s">&#34;customresourcedefinitions&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">customResourceDefintionStorage</span>
</span></span><span class="line"><span class="cl">        <span class="nx">storage</span><span class="p">[</span><span class="s">&#34;customresourcedefinitions/status&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">customresourcedefinition</span><span class="p">.</span><span class="nf">NewStatusREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">customResourceDefintionStorage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nx">Version</span><span class="p">]</span> <span class="p">=</span> <span class="nx">storage</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">apiResourceConfig</span><span class="p">.</span><span class="nf">VersionEnabled</span><span class="p">(</span><span class="nx">v1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、注册 APIGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallAPIGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、初始化需要使用的 controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">crdClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">internalclientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create clientset: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span> <span class="p">=</span> <span class="nx">internalinformers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">crdClient</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="nx">establishingController</span> <span class="o">:=</span> <span class="nx">establish</span><span class="p">.</span><span class="nf">NewEstablishingController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span>                    <span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">crdHandler</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewCustomResourceDefinitionHandler</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">NonGoRestfulMux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/apis&#34;</span><span class="p">,</span> <span class="nx">crdHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">NonGoRestfulMux</span><span class="p">.</span><span class="nf">HandlePrefix</span><span class="p">(</span><span class="s">&#34;/apis/&#34;</span><span class="p">,</span> <span class="nx">crdHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">crdController</span> <span class="o">:=</span> <span class="nf">NewDiscoveryController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span>                 <span class="nx">versionDiscoveryHandler</span><span class="p">,</span> <span class="nx">groupDiscoveryHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">namingController</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">NewNamingConditionController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nonStructuralSchemaController</span> <span class="o">:=</span> <span class="nx">nonstructuralschema</span><span class="p">.</span><span class="nf">NewConditionController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span>         <span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apiApprovalController</span> <span class="o">:=</span> <span class="nx">apiapproval</span><span class="p">.</span><span class="nf">NewKubernetesAPIApprovalPolicyConformantConditionController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span>      <span class="nf">InternalVersion</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">finalizingController</span> <span class="o">:=</span> <span class="nx">finalizer</span><span class="p">.</span><span class="nf">NewCRDFinalizer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">crdClient</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">crdHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">openapiController</span> <span class="o">*</span><span class="nx">openapicontroller</span><span class="p">.</span><span class="nx">Controller</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">apiextensionsfeatures</span><span class="p">.</span><span class="nx">CustomResourcePublishOpenAPI</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">openapiController</span> <span class="p">=</span> <span class="nx">openapicontroller</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5、将 informer 以及 controller 添加到 PostStartHook 中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-apiextensions-informers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-apiextensions-controllers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">crdController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">namingController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">establishingController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">nonStructuralSchemaController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">apiApprovalController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">finalizingController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;crd-informer-synced&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">PollImmediateUntil</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">InternalVersion</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">().</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">HasSynced</span><span class="p">(),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above is the initialization process of APIExtensionsServer, where the most core method is s.GenericAPIServer.InstallAPIGroup, which is the registration process of APIs, and the registration process of APIs in all three servers is its core.</p>
<h4 id="createkubeapiserver">CreateKubeAPIServer</h4>
<p>This section continues the analysis of the initialization of the KubeAPIServer, where <code>kubeAPIServerConfig.Complete().New</code> is called in <code>CreateKubeAPIServer</code> to complete the initialization operations.</p>
<h4 id="kubeapiserverconfigcompletenew">kubeAPIServerConfig.Complete().New</h4>
<p>The main logic is as follows.</p>
<ul>
<li>Initialize GenericAPIServer with a call to <code>c.GenericConfig.New</code>, whose main implementation was analyzed above.</li>
<li>Determine whether logs-related routes are supported, and if so, add the <code>/logs</code> route.</li>
<li>Call <code>m.InstallLegacyAPI</code> to add the core API Resource to the route, which corresponds to the apiserver as a resource starting with <code>/api</code>.</li>
<li>call <code>m.InstallAPIs</code> to add the extended API Resource to the route, which in apiserver is the resource starting with <code>/apis</code>.</li>
</ul>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/server.go:214</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CreateKubeAPIServer</span><span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">master</span><span class="p">.</span><span class="nx">Master</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kubeAPIServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">New</span><span class="p">(</span><span class="nx">delegateAPIServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">kubeAPIServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-kube-apiserver-admission-initializer&#34;</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">kubeAPIServer</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>k8s.io/kubernetes/pkg/master/master.go:325</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="nx">delegationTarget</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Master</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、初始化 GenericAPIServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;kube-apiserver&#34;</span><span class="p">,</span> <span class="nx">delegationTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、注册 logs 相关的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">EnableLogsSupport</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">routes</span><span class="p">.</span><span class="nx">Logs</span><span class="p">{}.</span><span class="nf">Install</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">GoRestfulContainer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Master</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">GenericAPIServer</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、安装 LegacyAPI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">APIResourceConfigSource</span><span class="p">.</span><span class="nf">VersionEnabled</span><span class="p">(</span><span class="nx">apiv1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">legacyRESTStorageProvider</span> <span class="o">:=</span> <span class="nx">corerest</span><span class="p">.</span><span class="nx">LegacyRESTStorageProvider</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">StorageFactory</span><span class="p">:</span>              <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">StorageFactory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ProxyTransport</span><span class="p">:</span>              <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">ProxyTransport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">InstallLegacyAPI</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">,</span> <span class="nx">legacyRESTStorageProvider</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">restStorageProviders</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">RESTStorageProvider</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">auditregistrationrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">authenticationrest</span><span class="p">.</span><span class="nx">RESTStorageProvider</span><span class="p">{</span><span class="nx">Authenticator</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">,</span> <span class="nx">APIAudiences</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span>  <span class="nx">Authentication</span><span class="p">.</span><span class="nx">APIAudiences</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、安装 APIs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">InstallAPIs</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">APIResourceConfigSource</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">,</span> <span class="nx">restStorageProviders</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">Tunneler</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">m</span><span class="p">.</span><span class="nf">installTunneler</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">Tunneler</span><span class="p">,</span> <span class="nx">corev1client</span><span class="p">.</span><span class="nf">NewForConfigOrDie</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">).</span><span class="nf">Nodes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">m</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;ca-registration&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">ClientCARegistrationHook</span><span class="p">.</span><span class="nx">PostStartHook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">m</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="minstalllegacyapi">m.InstallLegacyAPI</h4>
<p>The main function of this method is to register the core API to the route, which is one of the most core methods in the apiserver initialization process, but its call chain is very deep, and will be analyzed in depth below. The ultimate purpose of registering the API to the route is to provide an external RESTful API to operate the corresponding resource, the registration API is mainly divided into two steps, the first step is to initialize RESTStorage for each resource in the API to operate the change of data in the back-end storage, the second step is to build the corresponding route for each resource according to its verbs The second step is to build the corresponding route for each resource based on its verbs. The main logic of <code>m.InstallLegacyAPI</code> is as follows.</p>
<ul>
<li>
<p>Call <code>legacyRESTStorageProvider.NewLegacyRESTStorage</code> to create RESTStorage for each resource in LegacyAPI. The purpose of RESTStorage is to correspond the access paths of each resource and its operations in the backend storage.</p>
</li>
<li>
<p>Initialize <code>bootstrap-controller</code> and add it to PostStartHook, <code>bootstrap-controller</code> is a controller in apiserver, the main function is to create some namespace needed by the system and to create kubernetes service and periodically trigger the corresponding sync operation. apiserver will start <code>bootstrap-controller</code> by calling PostStartHook after it starts.</p>
</li>
<li>
<p>After creating RESTStorage for the resource, call <code>m.GenericAPIServer.InstallLegacyAPIGroup</code> to register the routing information for the APIGroup. The call chain for the <code>InstallLegacyAPIGroup</code> method is very deep, mainly <code>InstallLegacyAPIGroup --&gt; installAPIResources --&gt; InstallREST --&gt; Install --&gt; registerResourceHandlers</code>, and the final core route construction is in the <code>registerResourceHandlers</code> method, which is more complex, its main function is to determine which operations (such as create, update, etc.) can be performed by the resource through the REST Storage constructed in the previous step, and store the corresponding operations into the action, each action corresponds to a standard Finally, according to the actions array, each action will add a handler method and register to the route, and then the route will be registered to the webservice. The webservice will eventually be registered to the container, following the go-restful design pattern.</p>
</li>
</ul>
<p>The details of the <code>legacyRESTStorageProvider.NewLegacyRESTStorage</code> and <code>m.GenericAPIServer.InstallLegacyAPIGroup</code> methods will be continued in a later section.</p>
<p><code>k8s.io/kubernetes/pkg/master/master.go:406</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Master</span><span class="p">)</span> <span class="nf">InstallLegacyAPI</span><span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">legacyRESTStorage</span><span class="p">,</span> <span class="nx">apiGroupInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">legacyRESTStorageProvider</span><span class="p">.</span><span class="nf">NewLegacyRESTStorage</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error building core storage: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">controllerName</span> <span class="o">:=</span> <span class="s">&#34;bootstrap-controller&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">coreClient</span> <span class="o">:=</span> <span class="nx">corev1client</span><span class="p">.</span><span class="nf">NewForConfigOrDie</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bootstrapController</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">NewBootstrapController</span><span class="p">(</span><span class="nx">legacyRESTStorage</span><span class="p">,</span> <span class="nx">coreClient</span><span class="p">,</span> <span class="nx">coreClient</span><span class="p">,</span> <span class="nx">coreClient</span><span class="p">,</span> <span class="nx">coreClient</span><span class="p">.</span><span class="nf">RESTClient</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="nx">controllerName</span><span class="p">,</span> <span class="nx">bootstrapController</span><span class="p">.</span><span class="nx">PostStartHook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPreShutdownHookOrDie</span><span class="p">(</span><span class="nx">controllerName</span><span class="p">,</span> <span class="nx">bootstrapController</span><span class="p">.</span><span class="nx">PreShutdownHook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallLegacyAPIGroup</span><span class="p">(</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DefaultLegacyAPIPrefix</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error in registering group versions: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The main processes of <code>InstallAPIs</code> and <code>InstallLegacyAPI</code> are similar, so we won&rsquo;t go into them here for the sake of space.</p>
<h3 id="createaggregatorserver">createAggregatorServer</h3>
<p><code>AggregatorServer</code> is mainly used for custom aggregation controllers to enable CRDs to be automatically registered to the cluster.</p>
<p>The main logic is as follows.</p>
<ul>
<li>Call <code>aggregatorConfig.Complete().NewWithDelegate</code> to create the aggregatorServer.</li>
<li>Initialize <code>crdRegistrationController</code> and <code>autoRegistrationController</code>. <code>crdRegistrationController</code> is responsible for registering CRDs and <code>autoRegistrationController</code> is responsible for automatically registering the CRD The <code>crdRegistrationController</code> is responsible for registering the CRD, and the <code>autoRegistrationController</code> is responsible for automatically registering the corresponding APIServices to the apiserver.</li>
<li>Add <code>autoRegistrationController</code> and <code>crdRegistrationController</code> to the PostStartHook.</li>
</ul>
<p><code>k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go:124</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createAggregatorServer</span><span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">APIAggregator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、初始化 aggregatorServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">NewWithDelegate</span><span class="p">(</span><span class="nx">delegateAPIServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、初始化 auto-registration controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiRegistrationClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apiregistrationclient</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">autoRegistrationController</span> <span class="o">:=</span> <span class="nx">autoregister</span><span class="p">.</span><span class="nf">NewAutoRegisterController</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apiServices</span> <span class="o">:=</span> <span class="nf">apiServicesToRegister</span><span class="p">(</span><span class="nx">delegateAPIServer</span><span class="p">,</span> <span class="nx">autoRegistrationController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">crdRegistrationController</span> <span class="o">:=</span> <span class="nx">crdregistration</span><span class="p">.</span><span class="nf">NewCRDRegistrationController</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHook</span><span class="p">(</span><span class="s">&#34;kube-apiserver-autoregistration&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">crdRegistrationController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span><span class="p">.</span><span class="nf">AnyVersionForGroupEnabled</span><span class="p">(</span><span class="s">&#34;apiextensions.k8s.io&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">crdRegistrationController</span><span class="p">.</span><span class="nf">WaitForInitialSync</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">autoRegistrationController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddBootSequenceHealthChecks</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nf">makeAPIServiceAvailableHealthCheck</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;autoregister-completion&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">apiServices</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">APIRegistrationInformers</span><span class="p">.</span><span class="nf">Apiregistration</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">APIServices</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="aggregatorconfigcompletenewwithdelegate">aggregatorConfig.Complete().NewWithDelegate</h4>
<p>NewWithDelegate` is the method that initializes the aggregatorServer, the main logic is as follows.</p>
<ul>
<li>call <code>c.GenericConfig.New</code> to initialize the GenericAPIServer, whose internal main functionality has been analyzed above.</li>
<li>Call <code>apiservicerest.NewRESTStorage</code> to create RESTStorage for APIServices resources, the purpose of RESTStorage is to correspond the access paths of each resource and its back-end storage operations.</li>
<li>call <code>s.GenericAPIServer.InstallAPIGroup</code> to register routing information for the APIGroup.</li>
</ul>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go:158</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">NewWithDelegate</span><span class="p">(</span><span class="nx">delegationTarget</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">APIAggregator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">openAPIConfig</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、初始化 genericServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">genericServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;kube-aggregator&#34;</span><span class="p">,</span> <span class="nx">delegationTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">apiregistrationClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">informerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">apiregistrationClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">APIAggregator</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">GenericAPIServer</span><span class="p">:</span> <span class="nx">genericServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">delegateHandler</span><span class="p">:</span> <span class="nx">delegationTarget</span><span class="p">.</span><span class="nf">UnprotectedHandler</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、为 API 注册路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">apiservicerest</span><span class="p">.</span><span class="nf">NewRESTStorage</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallAPIGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、初始化 apiserviceRegistrationController、availableController
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apisHandler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">apisHandler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">codecs</span><span class="p">:</span> <span class="nx">aggregatorscheme</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lister</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">lister</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">NonGoRestfulMux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/apis&#34;</span><span class="p">,</span> <span class="nx">apisHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">NonGoRestfulMux</span><span class="p">.</span><span class="nf">UnlistedHandle</span><span class="p">(</span><span class="s">&#34;/apis/&#34;</span><span class="p">,</span> <span class="nx">apisHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apiserviceRegistrationController</span> <span class="o">:=</span> <span class="nf">NewAPIServiceRegistrationController</span><span class="p">(</span><span class="nx">informerFactory</span><span class="p">.</span><span class="nf">Apiregistration</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">APIServices</span><span class="p">(),</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">availableController</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">statuscontrollers</span><span class="p">.</span><span class="nf">NewAvailableConditionController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">       <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、添加 PostStartHook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-kube-aggregator-informers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">informerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;apiservice-registration-controller&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span>      <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">apiserviceRegistrationController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;apiservice-status-available-controller&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span>  <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">availableController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above is an analysis of the AggregatorServer initialization process, it can be seen that when creating APIExtensionsServer, KubeAPIServer and AggregatorServer, the pattern is similar, first call <code>c.GenericConfig.New</code> to initialize the Container according to the <code>go- New</code> to initialize the Container in <code>go-restful</code> mode, then create RESTStorage for the resources that need to be registered in the server, and finally register the APIGroup information of the resource to the route.</p>
<p>At this point, the process in CreateServerChain has been analyzed and the call chain is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">                    |--&gt; CreateNodeDialer
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">                    |--&gt; CreateKubeAPIServerConfig
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">CreateServerChain --|--&gt; createAPIExtensionsConfig
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">                    |                                                                       |--&gt; c.GenericConfig.New
</span></span><span class="line"><span class="cl">                    |--&gt; createAPIExtensionsServer --&gt; apiextensionsConfig.Complete().New --|
</span></span><span class="line"><span class="cl">                    |                                                                       |--&gt; s.GenericAPIServer.InstallAPIGroup
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">                    |                                                                 |--&gt; c.GenericConfig.New --&gt; legacyRESTStorageProvider.NewLegacyRESTStorage
</span></span><span class="line"><span class="cl">                    |                                                                 |
</span></span><span class="line"><span class="cl">                    |--&gt; CreateKubeAPIServer --&gt; kubeAPIServerConfig.Complete().New --|--&gt; m.InstallLegacyAPI
</span></span><span class="line"><span class="cl">                    |                                                                 |
</span></span><span class="line"><span class="cl">                    |                                                                 |--&gt; m.InstallAPIs
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">                    |--&gt; createAggregatorConfig
</span></span><span class="line"><span class="cl">                    |
</span></span><span class="line"><span class="cl">                    |                                                                             |--&gt; c.GenericConfig.New
</span></span><span class="line"><span class="cl">                    |                                                                             |
</span></span><span class="line"><span class="cl">                    |--&gt; createAggregatorServer --&gt; aggregatorConfig.Complete().NewWithDelegate --|--&gt; apiservicerest.NewRESTStorage
</span></span><span class="line"><span class="cl">                                                                                                  |
</span></span><span class="line"><span class="cl">                                                                                                  |--&gt; s.GenericAPIServer.InstallAPIGroup
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="preparedrun">prepared.Run</h3>
<p>The <code>Run</code> method first calls <code>CreateServerChain</code> to complete the initialization of each server, then calls <code>server.PrepareRun</code> to complete the preparation work before the service starts, and finally calls the <code>prepared.Run</code> method to start the secure http server.</p>
<p><code>serverPrepare.Run</code> mainly completes the health check, survival check and <code>OpenAPI</code> route registration, and then continues to analyze the flow of <code>prepared.Run</code>, in which <code>s.NonBlockingRun</code> is called to complete the startup.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go:269</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">preparedAPIAggregator</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">runnable</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go:316</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">preparedGenericAPIServer</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">delayedStopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">delayedStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ShutdownDelayDuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用 s.NonBlockingRun 完成启动流程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">NonBlockingRun</span><span class="p">(</span><span class="nx">delayedStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 当收到退出信号后完成一些收尾工作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">RunPreShutdownHooks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">&lt;-</span><span class="nx">delayedStopCh</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span><span class="p">.</span><span class="nx">HandlerChainWaitGroup</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="snonblockingrun">s.NonBlockingRun</h4>
<p>The main logic of <code>s.NonBlockingRun</code> is as follows.</p>
<ul>
<li>Determine whether to start the audit logging service.</li>
<li>Calling <code>s.SecureServingInfo.Serve</code> to configure and start the https server.</li>
<li>Execute postStartHooks.</li>
<li>Sending the ready signal to systemd.</li>
</ul>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go:351</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">preparedGenericAPIServer</span><span class="p">)</span> <span class="nf">NonBlockingRun</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">auditStopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、判断是否要启动审计日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">AuditBackend</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">AuditBackend</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">auditStopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to run the audit backend: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、启动 https server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">internalStopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">stoppedCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">SecureServingInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Handler</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stoppedCh</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">SecureServingInfo</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ShutdownTimeout</span><span class="p">,</span> <span class="nx">internalStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">internalStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">auditStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">        <span class="nb">close</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">readinessStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">close</span><span class="p">(</span><span class="nx">internalStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">stoppedCh</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;-</span><span class="nx">stoppedCh</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">HandlerChainWaitGroup</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">close</span><span class="p">(</span><span class="nx">auditStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、执行 postStartHooks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nf">RunPostStartHooks</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、向 systemd 发送 ready 信号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">systemd</span><span class="p">.</span><span class="nf">SdNotify</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="s">&#34;READY=1\n&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unable to send systemd daemon successful start message: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above is the initialization of the server and the analysis of the start-up process, as mentioned above, the most important part of the server initialization process is the initialization of the API Resource RESTStorage and the registration of the route, as the process is more complex, the following will be told separately.</p>
<h2 id="storagefactory-construction">StorageFactory construction</h2>
<p>As mentioned above, the backend data corresponding to the handler eventually implemented by apiserver is stored in a <strong>Store</strong> structure. Here, for example, the routes starting with <code>/api</code> are used to create the <strong>RESTStorage</strong> for each resource via the <code>NewLegacyRESTStorage</code> method. RESTStorage is a structure defined under <code>k8s.io/apiserver/pkg/registry/generic/registry/store.go</code>, which mainly contains <code>NewFunc</code> to return resource-specific information, <code>NewListFunc</code> to return resource-specific list and <code>CreateStrategy</code> for resource creation, <code>UpdateStrategy</code> for update, and <code>DeleteStrategy</code> for deletion. Inside <code>NewLegacyRESTStorage</code>, you can see the RESTStorage where multiple resources are created.</p>
<p>The call chain for <code>NewLegacyRESTStorage</code> is <code>CreateKubeAPIServer --&gt; kubeAPIServerConfig.Complete().New --&gt; m.InstallLegacyAPI --&gt; legacyRESTStorageProvider.NewLegacyRESTStorage</code>.</p>
<h3 id="newlegacyreststorage">NewLegacyRESTStorage</h3>
<p>All resources under an API Group have their own REST implementation, and all groups under <code>k8s.io/kubernetes/pkg/registry</code> have a rest directory that stores the RESTStorage of the corresponding resources. In the <code>NewLegacyRESTStorage</code> method, the storage corresponding to each resource will be generated by <code>NewREST</code> or <code>NewStorage</code>, and the pod is used as an example here.</p>
<p><code>k8s.io/kubernetes/pkg/registry/core/rest/storage_core.go:102</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">LegacyRESTStorageProvider</span><span class="p">)</span> <span class="nf">NewLegacyRESTStorage</span><span class="p">(</span><span class="nx">restOptionsGetter</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span> <span class="p">(</span><span class="nx">LegacyRESTStorage</span><span class="p">,</span> <span class="nx">genericapiserver</span><span class="p">.</span>  <span class="nx">APIGroupInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PrioritizedVersions</span><span class="p">:</span>          <span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">.</span><span class="nf">PrioritizedVersionsForGroup</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">VersionedResourcesStorageMap</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Scheme</span><span class="p">:</span>                       <span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ParameterCodec</span><span class="p">:</span>               <span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NegotiatedSerializer</span><span class="p">:</span>         <span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">podDisruptionClient</span> <span class="nx">policyclient</span><span class="p">.</span><span class="nx">PodDisruptionBudgetsGetter</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">policyGroupVersion</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="s">&#34;policy&#34;</span><span class="p">,</span> <span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;v1beta1&#34;</span><span class="p">});</span> <span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">.</span>                               <span class="nf">IsVersionRegistered</span><span class="p">(</span><span class="nx">policyGroupVersion</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">        <span class="nx">podDisruptionClient</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">policyclient</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、LegacyAPI 下的 resource RESTStorage 的初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">restStorage</span> <span class="o">:=</span> <span class="nx">LegacyRESTStorage</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">podTemplateStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">podtemplatestore</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">eventStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">eventstore</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">EventTTL</span><span class="p">.</span><span class="nf">Seconds</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">limitRangeStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">limitrangestore</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">endpointsStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">endpointsstore</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">nodeStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">nodestore</span><span class="p">.</span><span class="nf">NewStorage</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">KubeletClientConfig</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">ProxyTransport</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、pod RESTStorage 的初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">podStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">podstore</span><span class="p">.</span><span class="nf">NewStorage</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    <span class="nx">serviceClusterIPAllocator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ipallocator</span><span class="p">.</span><span class="nf">NewAllocatorCIDRRange</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">serviceClusterIPRange</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">max</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">rangeSpec</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">allocator</span><span class="p">.</span> <span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot create cluster IP allocator: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">restStorage</span><span class="p">.</span><span class="nx">ServiceClusterIPAllocator</span> <span class="p">=</span> <span class="nx">serviceClusterIPRegistry</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">secondaryServiceClusterIPAllocator</span> <span class="nx">ipallocator</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">IPv6DualStack</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">SecondaryServiceIPRange</span><span class="p">.</span><span class="nx">IP</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">serviceNodePortRegistry</span> <span class="nx">rangeallocation</span><span class="p">.</span><span class="nx">RangeRegistry</span>
</span></span><span class="line"><span class="cl">    <span class="nx">serviceNodePortAllocator</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">portallocator</span><span class="p">.</span><span class="nf">NewPortAllocatorCustom</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ServiceNodePortRange</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">max</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">rangeSpec</span> <span class="kt">string</span><span class="p">)</span>      <span class="p">(</span><span class="nx">allocator</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot create cluster port allocator: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">restStorage</span><span class="p">.</span><span class="nx">ServiceNodePortAllocator</span> <span class="p">=</span> <span class="nx">serviceNodePortRegistry</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">controllerStorage</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controllerstore</span><span class="p">.</span><span class="nf">NewStorage</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">LegacyRESTStorage</span><span class="p">{},</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">APIGroupInfo</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">serviceRest</span><span class="p">,</span> <span class="nx">serviceRestProxy</span> <span class="o">:=</span> <span class="nx">servicestore</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、restStorageMap 保存 resource http path 与 RESTStorage 对应关系
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">restStorageMap</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods&#34;</span><span class="p">:</span>             <span class="nx">podStorage</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods/attach&#34;</span><span class="p">:</span>      <span class="nx">podStorage</span><span class="p">.</span><span class="nx">Attach</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods/status&#34;</span><span class="p">:</span>      <span class="nx">podStorage</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods/log&#34;</span><span class="p">:</span>         <span class="nx">podStorage</span><span class="p">.</span><span class="nx">Log</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods/exec&#34;</span><span class="p">:</span>        <span class="nx">podStorage</span><span class="p">.</span><span class="nx">Exec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods/portforward&#34;</span><span class="p">:</span> <span class="nx">podStorage</span><span class="p">.</span><span class="nx">PortForward</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;pods/proxy&#34;</span><span class="p">:</span>       <span class="nx">podStorage</span><span class="p">.</span><span class="nx">Proxy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;componentStatuses&#34;</span><span class="p">:</span> <span class="nx">componentstatus</span><span class="p">.</span><span class="nf">NewStorage</span><span class="p">(</span><span class="nx">componentStatusStorage</span><span class="p">{</span><span class="nx">c</span><span class="p">.</span><span class="nx">StorageFactory</span><span class="p">}.</span><span class="nx">serversToValidate</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="podstorenewstorage">podstore.NewStorage</h4>
<p><code>podstore.NewStorage</code> is a method that generates storage for the pod. The main function of this method is to create backend storage for the pod and eventually return a RESTStorage object, which calls <code>store.CompleteWithOptions</code> to create the backend storage.</p>
<p><code>k8s.io/kubernetes/pkg/registry/core/pod/storage/storage.go:71</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewStorage</span><span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="p">(</span><span class="nx">PodStorage</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">store</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NewFunc</span><span class="p">:</span>                  <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">NewListFunc</span><span class="p">:</span>              <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">PodList</span><span class="p">{}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">options</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">generic</span><span class="p">.</span><span class="nx">StoreOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RESTOptions</span><span class="p">:</span> <span class="nx">optsGetter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">AttrFunc</span><span class="p">:</span>    <span class="nx">pod</span><span class="p">.</span><span class="nx">GetAttrs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">TriggerFunc</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">storage</span><span class="p">.</span><span class="nx">IndexerFunc</span><span class="p">{</span><span class="s">&#34;spec.nodeName&#34;</span><span class="p">:</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">NodeNameTriggerFunc</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用 store.CompleteWithOptions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">store</span><span class="p">.</span><span class="nf">CompleteWithOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">PodStorage</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusStore</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">store</span>
</span></span><span class="line"><span class="cl">    <span class="nx">statusStore</span><span class="p">.</span><span class="nx">UpdateStrategy</span> <span class="p">=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">StatusStrategy</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ephemeralContainersStore</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">store</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ephemeralContainersStore</span><span class="p">.</span><span class="nx">UpdateStrategy</span> <span class="p">=</span> <span class="nx">pod</span><span class="p">.</span><span class="nx">EphemeralContainersStrategy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">bindingREST</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">BindingREST</span><span class="p">{</span><span class="nx">store</span><span class="p">:</span> <span class="nx">store</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// PodStorage 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">PodStorage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Pod</span><span class="p">:</span>                 <span class="o">&amp;</span><span class="nx">REST</span><span class="p">{</span><span class="nx">store</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Binding</span><span class="p">:</span>             <span class="o">&amp;</span><span class="nx">BindingREST</span><span class="p">{</span><span class="nx">store</span><span class="p">:</span> <span class="nx">store</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">LegacyBinding</span><span class="p">:</span>       <span class="o">&amp;</span><span class="nx">LegacyBindingREST</span><span class="p">{</span><span class="nx">bindingREST</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Eviction</span><span class="p">:</span>            <span class="nf">newEvictionStorage</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="nx">podDisruptionBudgetClient</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Status</span><span class="p">:</span>              <span class="o">&amp;</span><span class="nx">StatusREST</span><span class="p">{</span><span class="nx">store</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">statusStore</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">EphemeralContainers</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">EphemeralContainersREST</span><span class="p">{</span><span class="nx">store</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">ephemeralContainersStore</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Log</span><span class="p">:</span>                 <span class="o">&amp;</span><span class="nx">podrest</span><span class="p">.</span><span class="nx">LogREST</span><span class="p">{</span><span class="nx">Store</span><span class="p">:</span> <span class="nx">store</span><span class="p">,</span> <span class="nx">KubeletConn</span><span class="p">:</span> <span class="nx">k</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Proxy</span><span class="p">:</span>               <span class="o">&amp;</span><span class="nx">podrest</span><span class="p">.</span><span class="nx">ProxyREST</span><span class="p">{</span><span class="nx">Store</span><span class="p">:</span> <span class="nx">store</span><span class="p">,</span> <span class="nx">ProxyTransport</span><span class="p">:</span> <span class="nx">proxyTransport</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Exec</span><span class="p">:</span>                <span class="o">&amp;</span><span class="nx">podrest</span><span class="p">.</span><span class="nx">ExecREST</span><span class="p">{</span><span class="nx">Store</span><span class="p">:</span> <span class="nx">store</span><span class="p">,</span> <span class="nx">KubeletConn</span><span class="p">:</span> <span class="nx">k</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Attach</span><span class="p">:</span>              <span class="o">&amp;</span><span class="nx">podrest</span><span class="p">.</span><span class="nx">AttachREST</span><span class="p">{</span><span class="nx">Store</span><span class="p">:</span> <span class="nx">store</span><span class="p">,</span> <span class="nx">KubeletConn</span><span class="p">:</span> <span class="nx">k</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PortForward</span><span class="p">:</span>         <span class="o">&amp;</span><span class="nx">podrest</span><span class="p">.</span><span class="nx">PortForwardREST</span><span class="p">{</span><span class="nx">Store</span><span class="p">:</span> <span class="nx">store</span><span class="p">,</span> <span class="nx">KubeletConn</span><span class="p">:</span> <span class="nx">k</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the different operations on the pod in the final returned object are all one REST object.</p>
<p>The <code>genericregistry.Store</code> object is automatically integrated in REST, and the <code>store.CompleteWithOptions</code> method initializes the store instance in the `genericregistry.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">REST</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span>
</span></span><span class="line"><span class="cl">    <span class="nx">proxyTransport</span> <span class="nx">http</span><span class="p">.</span><span class="nx">RoundTripper</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">BindingREST</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">store</span> <span class="o">*</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">......</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="storecompletewithoptions">store.CompleteWithOptions</h4>
<p>CompleteWithOptions` is mainly used to set some default values for the configuration in the store and to update the store based on the options provided, the main one being to initialize the backend storage instance of the store.</p>
<p>Within the <code>CompleteWithOptions</code> method, the <code>options.RESTOptions.GetRESTOptions</code> method is called, which eventually returns the <code>generic.RESTOptions</code> object, which contains some configuration for the etcd The <code>generic.RESTOptions</code> object contains some configuration for the initialization of etcd, data serialization methods, and a storage. The <code>StorageWithCacher--&gt;NewRawStorage--&gt;Create</code> method is called sequentially to create the final dependent backend storage.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go:1192</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Store</span><span class="p">)</span> <span class="nf">CompleteWithOptions</span><span class="p">(</span><span class="nx">options</span> <span class="o">*</span><span class="nx">generic</span><span class="p">.</span><span class="nx">StoreOptions</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">isNamespaced</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">e</span><span class="p">.</span><span class="nx">CreateStrategy</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isNamespaced</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">CreateStrategy</span><span class="p">.</span><span class="nf">NamespaceScoped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">e</span><span class="p">.</span><span class="nx">UpdateStrategy</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isNamespaced</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">UpdateStrategy</span><span class="p">.</span><span class="nf">NamespaceScoped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;store for %s must have CreateStrategy or UpdateStrategy set&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">DefaultQualifiedResource</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、调用 options.RESTOptions.GetRESTOptions 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">opts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">RESTOptions</span><span class="p">.</span><span class="nf">GetRESTOptions</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">DefaultQualifiedResource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、设置 ResourcePrefix 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">prefix</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ResourcePrefix</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prefix</span> <span class="p">=</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">prefix</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;store for %s has an invalid prefix %q&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">DefaultQualifiedResource</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ResourcePrefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">KeyRootFunc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">KeyFunc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">keyFunc</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、以下操作主要是将 opts 对象中的值赋值到 store 对象中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">DeleteCollectionWorkers</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">DeleteCollectionWorkers</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">DeleteCollectionWorkers</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">e</span><span class="p">.</span><span class="nx">EnableGarbageCollection</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">EnableGarbageCollection</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ObjectNameFunc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nx">Storage</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nx">Codec</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">Codec</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">Storage</span><span class="p">.</span><span class="nx">Storage</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">DestroyFunc</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nf">Decorator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">opts</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">prefix</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">keyFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nx">NewFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nx">NewListFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">attrFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">options</span><span class="p">.</span><span class="nx">TriggerFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span><span class="p">.</span><span class="nx">StorageVersioner</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">EncodeVersioner</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">CountMetricPollPeriod</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">stopFunc</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">startObservingCount</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">CountMetricPollPeriod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">previousDestroy</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">DestroyFunc</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nx">DestroyFunc</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">stopFunc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">previousDestroy</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">previousDestroy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>options.RESTOptions</code> is an interface, and to find the implementation of its <code>GetRESTOptions</code> method you must know the instance corresponding to <code>options.RESTOptions</code> when it is initialized in the <code>CreateKubeAPIServerConfig --&gt; buildGenericConfig --&gt; s.Etcd.ApplyWithStorageFactoryTo</code> method, the instance corresponding to <code>RESTOptions</code> is <code>StorageFactoryRestOptionsFactory</code>, so PodStorage The actual object type of <code>genericserver.Config.RESTOptionsGetter</code> in the store object constructed at initialization is <code>StorageFactoryRestOptionsFactory</code>, and its <code>GetRESTOptions</code> method is shown below.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/options/etcd.go:253</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">StorageFactoryRestOptionsFactory</span><span class="p">)</span> <span class="nf">GetRESTOptions</span><span class="p">(</span><span class="nx">resource</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupResource</span><span class="p">)</span> <span class="p">(</span><span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptions</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storageConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptions</span><span class="p">{},</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to find storage destination for %v, due to %v&#34;</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span> <span class="o">:=</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">StorageConfig</span><span class="p">:</span>           <span class="nx">storageConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Decorator</span><span class="p">:</span>               <span class="nx">generic</span><span class="p">.</span><span class="nx">UndecoratedStorage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">DeleteCollectionWorkers</span><span class="p">:</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nx">DeleteCollectionWorkers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">EnableGarbageCollection</span><span class="p">:</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nx">EnableGarbageCollection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ResourcePrefix</span><span class="p">:</span>          <span class="nx">f</span><span class="p">.</span><span class="nx">StorageFactory</span><span class="p">.</span><span class="nf">ResourcePrefix</span><span class="p">(</span><span class="nx">resource</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">CountMetricPollPeriod</span><span class="p">:</span>   <span class="nx">f</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">CountMetricPollPeriod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nx">EnableWatchCache</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sizes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ParseWatchCacheSizes</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nx">WatchCacheSizes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptions</span><span class="p">{},</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cacheSize</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sizes</span><span class="p">[</span><span class="nx">resource</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cacheSize</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nx">DefaultWatchCacheSize</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 调用 generic.StorageDecorator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ret</span><span class="p">.</span><span class="nx">Decorator</span> <span class="p">=</span> <span class="nx">genericregistry</span><span class="p">.</span><span class="nf">StorageWithCacher</span><span class="p">(</span><span class="nx">cacheSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ret</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In <code>genericregistry.StorageWithCacher</code> a different method is called which eventually calls <code>factory.Create</code> to initialize the storage instance, the call chain is: <code>genericregistry.StorageWithCacher --&gt; generic. NewRawStorage --&gt; factory.Create</code>.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/storage/storagebackend/factory/factory.go:30</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">c</span> <span class="nx">storagebackend</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="nx">storage</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">DestroyFunc</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s">&#34;etcd2&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%v is no longer a supported storage backend&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 目前 k8s 只支持使用 etcd v3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nx">storagebackend</span><span class="p">.</span><span class="nx">StorageTypeUnset</span><span class="p">,</span> <span class="nx">storagebackend</span><span class="p">.</span><span class="nx">StorageTypeETCD3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">newETCD3Storage</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unknown storage type: %s&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="newetcd3storage">newETCD3Storage</h5>
<p>In <code>newETCD3Storage</code>, the client of etcd is first created by calling <code>newETCD3Client</code>, and the client is finally created using the official etcd client tool <a href="https://github.com/etcd-io/etcd/tree/master/clientv3">clientv3</a>.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/storage/storagebackend/factory/etcd3.go:209</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newETCD3Storage</span><span class="p">(</span><span class="nx">c</span> <span class="nx">storagebackend</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="nx">storage</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">DestroyFunc</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stopCompactor</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">startCompactorOnce</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Transport</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">CompactionInterval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newETCD3Client</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Transport</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">stopCompactor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">once</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl">    <span class="nx">destroyFunc</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">stopCompactor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">client</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">transformer</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Transformer</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">transformer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">transformer</span> <span class="p">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">IdentityTransformer</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">etcd3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Codec</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Prefix</span><span class="p">,</span> <span class="nx">transformer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Paging</span><span class="p">),</span> <span class="nx">destroyFunc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, the analysis of the construction of the store in the pod resource is basically completed, different resource corresponds to a REST object, which in turn references the <code>genericregistry.Store</code> object, and finally the initialization of the `genericregistry. After analyzing the initialization of the store there is another important step which is the registration of the route. The main process of route registration is to build an http path for the resource according to different verbs and to bind the path to the corresponding handler.</p>
<h3 id="routing-registration">Routing Registration</h3>
<p>The construction of RESTStorage above corresponds to the <code>legacyRESTStorageProvider.NewLegacyRESTStorage</code> method in the <code>InstallLegacyAPI</code>. The following analysis continues with the implementation of the <code>m.GenericAPIServer.InstallLegacyAPIGroup</code> method in the <code>InstallLegacyAPI</code>.</p>
<p><code>k8s.io/kubernetes/pkg/master/master.go:406</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Master</span><span class="p">)</span> <span class="nf">InstallLegacyAPI</span><span class="p">(</span><span class="o">......</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">legacyRESTStorage</span><span class="p">,</span> <span class="nx">apiGroupInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">legacyRESTStorageProvider</span><span class="p">.</span><span class="nf">NewLegacyRESTStorage</span><span class="p">(</span><span class="nx">restOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error building core storage: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallLegacyAPIGroup</span><span class="p">(</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DefaultLegacyAPIPrefix</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error in registering group versions: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The call chain for <code>m.GenericAPIServer.InstallLegacyAPIGroup</code> is very deep and ends up registering handler and routing information for each API resource under the Group, which is: <code>m.GenericAPIServer. InstallLegacyAPIGroup --&gt; s.installAPIResources --&gt; apiGroupVersion.InstallREST --&gt; installer.Install --&gt; a.registerResourceHandlers</code>. Several of these methods work as shown below.</p>
<ul>
<li><code>s.installAPIResources</code>: adds a route for each API resource call to <code>apiGroupVersion.InstallREST</code>.</li>
<li><code>apiGroupVersion.InstallREST</code>: adds the <code>restful.WebServic</code> object to the container.</li>
<li><code>installer.Install</code>: returns the final <code>restful.WebService</code> object</li>
</ul>
<h4 id="aregisterresourcehandlers">a.registerResourceHandlers</h4>
<p>This method implements the conversion from <code>rest.Storage</code> to <code>restful.Route</code>. It first determines the REST interface supported by the API Resource, then adds the corresponding handler for the REST interface, and finally registers it with the route.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/installer.go:181</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">APIInstaller</span><span class="p">)</span> <span class="nf">registerResourceHandlers</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">storage</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">,</span> <span class="nx">ws</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">WebService</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">APIResource</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>       
</span></span><span class="line"><span class="cl">    <span class="nx">admit</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Admit</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="c1">// 1、判断该 resource 实现了哪些 REST 操作接口，以此来判断其支持的 verbs 以便为其添加路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">creater</span><span class="p">,</span> <span class="nx">isCreater</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Creater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">namedCreater</span><span class="p">,</span> <span class="nx">isNamedCreater</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lister</span><span class="p">,</span> <span class="nx">isLister</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Lister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getter</span><span class="p">,</span> <span class="nx">isGetter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Getter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">getterWithOptions</span><span class="p">,</span> <span class="nx">isGetterWithOptions</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">GetterWithOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gracefulDeleter</span><span class="p">,</span> <span class="nx">isGracefulDeleter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">GracefulDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">collectionDeleter</span><span class="p">,</span> <span class="nx">isCollectionDeleter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">CollectionDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">updater</span><span class="p">,</span> <span class="nx">isUpdater</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Updater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">patcher</span><span class="p">,</span> <span class="nx">isPatcher</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Patcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">watcher</span><span class="p">,</span> <span class="nx">isWatcher</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Watcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">connecter</span><span class="p">,</span> <span class="nx">isConnecter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Connecter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storageMeta</span><span class="p">,</span> <span class="nx">isMetadata</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">StorageMetadata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storageVersionProvider</span><span class="p">,</span> <span class="nx">isStorageVersionProvider</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">StorageVersionProvider</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">isMetadata</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">storageMeta</span> <span class="p">=</span> <span class="nx">defaultStorageMetadata</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">exporter</span><span class="p">,</span> <span class="nx">isExporter</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Exporter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">isExporter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">exporter</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2、为 resource 添加对应的 actions 并根据是否支持 namespace 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="p">!</span><span class="nx">namespaceScoped</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;LIST&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isLister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isCreater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;DELETECOLLECTION&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isCollectionDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;WATCHLIST&#34;</span><span class="p">,</span> <span class="s">&#34;watch/&#34;</span> <span class="o">+</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">allowWatchList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">getSubpath</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">itemPath</span> <span class="o">+</span> <span class="s">&#34;/{path:*}&#34;</span><span class="p">,</span> <span class="nx">proxyParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;PUT&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isUpdater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;PATCH&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isPatcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;DELETE&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGracefulDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;WATCH&#34;</span><span class="p">,</span> <span class="s">&#34;watch/&#34;</span> <span class="o">+</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isWatcher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;CONNECT&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isConnecter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;CONNECT&#34;</span><span class="p">,</span> <span class="nx">itemPath</span> <span class="o">+</span> <span class="s">&#34;/{path:*}&#34;</span><span class="p">,</span> <span class="nx">proxyParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isConnecter</span> <span class="o">&amp;&amp;</span> <span class="nx">connectSubpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;LIST&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isLister</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isCreater</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;DELETECOLLECTION&#34;</span><span class="p">,</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isCollectionDeleter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;WATCHLIST&#34;</span><span class="p">,</span> <span class="s">&#34;watch/&#34;</span> <span class="o">+</span> <span class="nx">resourcePath</span><span class="p">,</span> <span class="nx">resourceParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">allowWatchList</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">actions</span> <span class="p">=</span> <span class="nf">appendIf</span><span class="p">(</span><span class="nx">actions</span><span class="p">,</span> <span class="nx">action</span><span class="p">{</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">itemPath</span><span class="p">,</span> <span class="nx">nameParams</span><span class="p">,</span> <span class="nx">namer</span><span class="p">,</span> <span class="kc">false</span><span class="p">},</span> <span class="nx">isGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3、根据 action 创建对应的 route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeVerbs</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reqScope</span> <span class="o">:=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">RequestScope</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Serializer</span><span class="p">:</span>      <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ParameterCodec</span><span class="p">:</span>  <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Creater</span><span class="p">:</span>         <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Creater</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Convertor</span><span class="p">:</span>       <span class="nx">a</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">Convertor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4、从 rest.Storage 到 restful.Route 映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 为每个操作添加对应的 handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">action</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">actions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="nx">verbOverrider</span><span class="p">,</span> <span class="nx">needOverride</span> <span class="o">:=</span> <span class="nx">storage</span><span class="p">.(</span><span class="nx">StorageMetricsOverride</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;GET&#34;</span><span class="p">:</span> <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;LIST&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;PUT&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;PATCH&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此处以 POST 操作进行说明
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="s">&#34;POST&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">handler</span> <span class="nx">restful</span><span class="p">.</span><span class="nx">RouteFunction</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 5、初始化 handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">isNamedCreater</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">handler</span> <span class="p">=</span> <span class="nf">restfulCreateNamedResource</span><span class="p">(</span><span class="nx">namedCreater</span><span class="p">,</span> <span class="nx">reqScope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">handler</span> <span class="p">=</span> <span class="nf">restfulCreateResource</span><span class="p">(</span><span class="nx">creater</span><span class="p">,</span> <span class="nx">reqScope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">handler</span> <span class="p">=</span> <span class="nx">metrics</span><span class="p">.</span><span class="nf">InstrumentRouteFunc</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">subresource</span><span class="p">,</span> <span class="nx">requestScope</span><span class="p">,</span> <span class="nx">metrics</span><span class="p">.</span><span class="nx">APIServerComponent</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">article</span> <span class="o">:=</span> <span class="nf">GetArticleForNoun</span><span class="p">(</span><span class="nx">kind</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">doc</span> <span class="o">:=</span> <span class="s">&#34;create&#34;</span> <span class="o">+</span> <span class="nx">article</span> <span class="o">+</span> <span class="nx">kind</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">isSubresource</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">doc</span> <span class="p">=</span> <span class="s">&#34;create &#34;</span> <span class="o">+</span> <span class="nx">subresource</span> <span class="o">+</span> <span class="s">&#34; of&#34;</span> <span class="o">+</span> <span class="nx">article</span> <span class="o">+</span> <span class="nx">kind</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 6、route 与 handler 进行绑定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">route</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Path</span><span class="p">).</span><span class="nf">To</span><span class="p">(</span><span class="nx">handler</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Doc</span><span class="p">(</span><span class="nx">doc</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Param</span><span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nf">QueryParameter</span><span class="p">(</span><span class="s">&#34;pretty&#34;</span><span class="p">,</span> <span class="s">&#34;If &#39;true&#39;, then the output is pretty printed.&#34;</span><span class="p">)).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Operation</span><span class="p">(</span><span class="s">&#34;create&#34;</span><span class="o">+</span><span class="nx">namespaced</span><span class="o">+</span><span class="nx">kind</span><span class="o">+</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Title</span><span class="p">(</span><span class="nx">subresource</span><span class="p">)</span><span class="o">+</span><span class="nx">operationSuffix</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Produces</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="nx">storageMeta</span><span class="p">.</span><span class="nf">ProducesMIMETypes</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">Verb</span><span class="p">),</span> <span class="nx">mediaTypes</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Returns</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;OK&#34;</span><span class="p">,</span> <span class="nx">producedObject</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Returns</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusCreated</span><span class="p">,</span> <span class="s">&#34;Created&#34;</span><span class="p">,</span> <span class="nx">producedObject</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Returns</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusAccepted</span><span class="p">,</span> <span class="s">&#34;Accepted&#34;</span><span class="p">,</span> <span class="nx">producedObject</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Reads</span><span class="p">(</span><span class="nx">defaultVersionedObject</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">                <span class="nf">Writes</span><span class="p">(</span><span class="nx">producedObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">AddObjectParams</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">versionedCreateOptions</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addParams</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">Params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 7、添加到路由中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">routes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">routes</span><span class="p">,</span> <span class="nx">route</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;DELETE&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;DELETECOLLECTION&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;WATCH&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;WATCHLIST&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="s">&#34;CONNECT&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">apiResource</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="restfulcreatenamedresource">restfulCreateNamedResource</h4>
<p><code>restfulCreateNamedResource</code> is the handler for the POST operation, which will eventually be done by calling the <code>createHandler</code> method.</p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/installer.go:1087</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">restfulCreateNamedResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">,</span> <span class="nx">scope</span> <span class="nx">handlers</span><span class="p">.</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">restful</span><span class="p">.</span><span class="nx">RouteFunction</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span> <span class="o">*</span><span class="nx">restful</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">handlers</span><span class="p">.</span><span class="nf">CreateNamedResource</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">admit</span><span class="p">)(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CreateNamedResource</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admission</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">createHandler</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">scope</span><span class="p">,</span> <span class="nx">admission</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="createhandler">createHandler</h4>
<p>The <code>createHandler</code> is a method to write data to the backend storage, and there is a permission control for the operation of the resource, in the <code>createHandler</code> the <code>decoder</code> and <code>admission</code> operations will be executed first, then the <code>create</code> method will be called to complete the creation of the resource, in the <code>create</code> method, <code>validate</code> and finally save the data to the backend storage. The <code>admit</code> operation executes the admission-plugins in the kube-apiserver. The admission-plugins are initialized to the admissionChain in <code>CreateKubeAPIServerConfig</code>, and the initialization call chain is <code>CreateKubeAPIServerConfig --&gt; buildGenericConfig --&gt; s.Admission.ApplyTo --&gt; a.GenericAdmission.ApplyTo --&gt; a.Plugins.NewFromPlugins</code>, and finally in <code>NewFromPlugins</code> wraps all enabled plugins as admissionChain, and the admit operation to be performed here is the admit operation in admission-plugins.</p>
<p>The create method called in <code>createHandler</code> is a method of the <code>genericregistry.Store</code> object. The <code>genericregistry.Store</code> object is introduced at each resource initialization of RESTStorage.</p>
<p>All the operations in <code>createHandler</code> are the request process mentioned at the beginning of this article, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">v1beta1 ⇒ internal ⇒    |    ⇒       |    ⇒  v1  ⇒ json/yaml ⇒ etcd
</span></span><span class="line"><span class="cl">                     admission    validation
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/endpoints/handlers/create.go:46</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createHandler</span><span class="p">(</span><span class="nx">r</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">NamedCreater</span><span class="p">,</span> <span class="nx">scope</span> <span class="o">*</span><span class="nx">RequestScope</span><span class="p">,</span> <span class="nx">admit</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">includeName</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">trace</span> <span class="o">:=</span> <span class="nx">utiltrace</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;Create&#34;</span><span class="p">,</span> <span class="nx">utiltrace</span><span class="p">.</span><span class="nx">Field</span><span class="p">{</span><span class="s">&#34;url&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nx">trace</span><span class="p">.</span><span class="nf">LogIfLong</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">gv</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Kind</span><span class="p">.</span><span class="nf">GroupVersion</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1、得到合适的SerializerInfo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">negotiation</span><span class="p">.</span><span class="nf">NegotiateInputSerializer</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">scope</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2、找到合适的 decoder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">decoder</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">.</span><span class="nf">DecoderToVersion</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">HubGroupVersion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">limitedReadBody</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">MaxRequestBodyBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">scope</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">defaultGVK</span> <span class="o">:=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Kind</span>
</span></span><span class="line"><span class="cl">        <span class="nx">original</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">trace</span><span class="p">.</span><span class="nf">Step</span><span class="p">(</span><span class="s">&#34;About to convert to expected version&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 3、decoder 解码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">obj</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">defaultGVK</span><span class="p">,</span> <span class="nx">original</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">ae</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">AuditEventFrom</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">admit</span> <span class="p">=</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">WithAudit</span><span class="p">(</span><span class="nx">admit</span><span class="p">,</span> <span class="nx">ae</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">audit</span><span class="p">.</span><span class="nf">LogRequestObject</span><span class="p">(</span><span class="nx">ae</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Resource</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Subresource</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">userInfo</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nf">UserFrom</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">Namer</span><span class="p">.</span><span class="nf">ObjectName</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 4、执行 admit 操作，即执行 kube-apiserver 启动时加载的 admission-plugins，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">admissionAttributes</span> <span class="o">:=</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">NewAttributesRecord</span><span class="p">(</span><span class="o">......</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">mutatingAdmission</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">admit</span><span class="p">.(</span><span class="nx">admission</span><span class="p">.</span><span class="nx">MutationInterface</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">mutatingAdmission</span><span class="p">.</span><span class="nf">Handles</span><span class="p">(</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Create</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">err</span> <span class="p">=</span> <span class="nx">mutatingAdmission</span><span class="p">.</span><span class="nf">Admit</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">admissionAttributes</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">scope</span><span class="p">.</span><span class="nf">err</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 5、执行 create 操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">finishRequest</span><span class="p">(</span><span class="nx">timeout</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nx">ctx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">obj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rest</span><span class="p">.</span><span class="nf">AdmissionToValidateObjectFunc</span><span class="p">(</span><span class="nx">admit</span><span class="p">,</span> <span class="nx">admissionAttributes</span><span class="p">,</span> <span class="nx">scope</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="summary">Summary</h2>
<p>This article analyzes the startup process of kube-apiserver. kube-apiserver contains three servers, namely KubeAPIServer, APIExtensionsServer and AggregatorServer, which are connected together through the delegate mode. The initialization process is similar, first create the corresponding config for each server, then initialize the http server, the http server initialization process is to first initialize <code>GoRestfulContainer</code>, then install the API included in the server, when installing the API first create the corresponding backend storage RES for each API When installing the API, first create the corresponding back-end storage RESTStorage for each API Resource, then add the corresponding handler for each API Resource supported verbs, and register the handler to the route, and finally register the route to the webservice, the implementation process of the RESTFul API is the core of the startup process. The core of the startup process is the implementation of the RESTFul API. As for the implementation of filters such as authentication and authentication in kube-apiserver, multi-version resource conversion, kubernetes service implementation, and other details, we will continue to analyze them in later articles.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/k8s-elk/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Deploying an Elasticsearch stack on a Kubernetes cluster</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/apiserver-bootstrap-controller/">
            <span class="next-text nav-default">Implementation of apiserver service in kube-apiserver</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
