<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>IOC-golang&#39;s AOP principles and applications - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the principles and practical applications of AOP for IOC-golang." /><meta name="keywords" content="IOC-golang, aop" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/go-ioc/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="IOC-golang&#39;s AOP principles and applications" />
<meta property="og:description" content="Explore the principles and practical applications of AOP for IOC-golang." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/go-ioc/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-03T16:33:02+08:00" />
<meta property="article:modified_time" content="2022-07-03T16:33:02+08:00" />

<meta itemprop="name" content="IOC-golang&#39;s AOP principles and applications">
<meta itemprop="description" content="Explore the principles and practical applications of AOP for IOC-golang."><meta itemprop="datePublished" content="2022-07-03T16:33:02+08:00" />
<meta itemprop="dateModified" content="2022-07-03T16:33:02+08:00" />
<meta itemprop="wordCount" content="2656">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="IOC-golang&#39;s AOP principles and applications"/>
<meta name="twitter:description" content="Explore the principles and practical applications of AOP for IOC-golang."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">IOC-golang&#39;s AOP principles and applications</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-03 16:33:02 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2656 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-relationship-between-aop-and-ioc">1. Relationship between AOP and IOC</a></li>
        <li><a href="#2-go-ecology-and-aop">2. Go Ecology and AOP</a></li>
        <li><a href="#3-aop-principles-for-ioc-golang">3. AOP principles for IOC-golang</a>
          <ul>
            <li><a href="#31-ioc-golangs-interface-injection">3.1 IOC-golang&rsquo;s interface injection</a></li>
            <li><a href="#32-proxy-generation-and-injection">3.2 Proxy generation and injection</a></li>
          </ul>
        </li>
        <li><a href="#4-ioc-golang-aop-based-applications">4. IOC-golang AOP-based applications</a>
          <ul>
            <li><a href="#41-methods-parameters-observable">4.1 Methods, parameters observable</a></li>
            <li><a href="#42-full-link-tracking">4.2 Full-link tracking</a></li>
          </ul>
        </li>
        <li><a href="#5-outlook">5. Outlook</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-relationship-between-aop-and-ioc">1. Relationship between AOP and IOC</h2>
<p>AOP (Aspect Oriented Programming) is a programming design idea that aims to reduce the coupling between business logics by intercepting business process tangents and implementing specific modularization capabilities. This idea has been practiced in many well-known projects. For example, Spring&rsquo;s PointCut, gRPC&rsquo;s Interceptor, and Dubbo&rsquo;s Filter. aOP is just a concept that has been applied in different scenarios, resulting in different implementations.</p>
<p>Let&rsquo;s start by discussing more specific RPC scenarios, using gRPC as an example.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/03/28111c1d1ac1499a9ae42ad433e9f008.png" alt="gRPC"></p>
<p>For a single RPC process, gRPC provides a user-extendable Interceptor interface that allows developers to write business-related interceptor logic. For example, introducing authentication, service discovery, observability, and other capabilities, there are many extensions based on Interceptor implementations in the gRPC ecosystem, see <a href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-middleware</a>. These extended implementations belong to the gRPC ecosystem and are limited to the concepts of Client and Server sides, and to RPC scenarios.</p>
<p>We abstract the concrete scenario by referring to Spring.</p>
<p>Spring has a powerful dependency injection capability, on top of which it provides AOP capabilities for adapting and business object methods, allowing interceptors to be encapsulated outside of business functions by defining cutpoints. These concepts of &ldquo;facets&rdquo; and &ldquo;cutpoints&rdquo; are limited to the Spring framework and managed by its dependency injection (also known as IOC) capabilities.</p>
<p>The point I want to make is that the concept of AOP needs to be grounded in a specific scenario and must be constrained by the ecological constraints from which it is integrated. For example, I can write a series of function calls along the lines of procedural oriented programming, and I can say that this is an implementation of AOP, but it is not scalable, migratable, or generic. This constraint is necessary, can be strong or weak, such as Spring ecological AOP, weaker constraints have greater scalability, but the implementation is relatively complex, the developer needs to learn its ecological concepts and APIs, and if Dubbo, gRPC ecological AOP adapted to RPC scenarios, the developer only needs to implement the interface and a single API injection can be, its ability is relatively The ability is relatively limited.</p>
<p>The above &ldquo;constraints&rdquo; can be visualized in the actual development scenario as dependency injection, or IOC, where the objects that developers need to use are managed and encapsulated by the ecology, whether it is Dubbo&rsquo;s Invoker or Spring&rsquo;s Bean, the IOC process provides a constraint for the practice of AOP, provides a model The IOC process provides a constraint for the practice of AOP, a model, and a value for implementation.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/03/f821d2109af34eed86196c19f78da247.png" alt="go ioc"></p>
<h2 id="2-go-ecology-and-aop">2. Go Ecology and AOP</h2>
<p>The AOP concept has nothing to do with the language, and while I agree that best practice solutions using AOP require the Java language, I don&rsquo;t think AOP is exclusive to Java. In the Go ecosystem that I am familiar with, there are still many good projects based on the AOP idea, and the commonality of these projects, as I explained in the previous section, is that they all combine a specific ecosystem to solve a specific business scenario, where the breadth of the solution depends on the binding power of the IOC ecosystem. An IOC ecosystem that does not provide AOP can be very clean and refreshing, while an IOC ecosystem that provides AOP capabilities can be very inclusive and powerful.</p>
<p>Last month I open sourced the <a href="https://github.com/alibaba/ioc-golang">IOC-golang</a> service framework, which focuses on solving the dependency injection problem in Go application development. Many developers compare this framework with Google&rsquo;s open source <a href="https://github.com/google/wire">wire</a> framework and think it is not as clean and easy to use as wire, but the essence of this problem is that the two ecologies are designed for different purposes. wire focuses on IOC rather than AOP, so developers can learn some simple concepts and APIs, use scaffolding and code generation capabilities to quickly implement dependency injection, and have a good development experience. IOC-golang focuses on IOC-based AOP capabilities and embraces this layer of extensibility, viewing AOP capabilities as a point of difference and value between this framework and other IOC frameworks.</p>
<p>Compared to SDKs that solve specific problems, we can consider the IOC capabilities of the dependency injection framework as a &ldquo;weakly constrained IOC scenario&rdquo; and compare the differences between the two frameworks to throw light on two core issues.</p>
<ul>
<li>Does the Go ecosystem need AOP in &ldquo;weakly constrained IOC scenarios&rdquo;?</li>
<li>What can GO ecosystem AOP be used for in &ldquo;weakly constrained IOC scenarios&rdquo;?</li>
</ul>
<p>My view is that the Go ecosystem must need AOP, even in the &ldquo;weakly constrained IOC scenario&rdquo;, but still can use AOP to do some business-independent things, such as enhance the application&rsquo;s operation and maintenance observability. Go does not support annotations, which limits the convenience of developers to use the AOP layer for writing business semantics. I would prefer to give the Go ecosystem an AOP layer with observable capabilities for operations and maintenance, while developers would be impervious to AOP.</p>
<p>For example, the IOC-golang framework can be used to encapsulate the operations AOP layer for any interface implementation structure, thus making all objects of an application observable. In addition, we can also combine RPC scenarios, service governance scenarios, and fault injection scenarios to generate more &ldquo;operations&rdquo; domain extension ideas.</p>
<h2 id="3-aop-principles-for-ioc-golang">3. AOP principles for IOC-golang</h2>
<p>There are two ways to implement method proxies in Go: interface proxies via reflection, and function pointer swapping based on Monkey patches. The latter does not rely on interfaces and can encapsulate function proxies for methods of any structure, requires intrusion into the underlying assembly code, turns off compilation optimizations, has CPU architecture requirements, and can significantly degrade performance when handling concurrent requests.</p>
<p>The former makes more sense for production, relies on interfaces, and is the focus of this section.</p>
<h3 id="31-ioc-golangs-interface-injection">3.1 IOC-golang&rsquo;s interface injection</h3>
<p>As mentioned in the first open source article of this framework, IOC-golang has two perspectives on the dependency injection process, the structure provider and the structure user. The framework accepts the structure defined by the structure provider and provides the structure as requested by the structure user. The structure provider only needs to care about the structure ontology, not about which interfaces the structure implements. The structure user needs to care about how the structure is injected and used: is it injected into an interface? To a pointer? Is it obtained through the API? Or through tag injection?</p>
<ul>
<li>
<p>Injecting dependencies via tags</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +ioc:autowire=true
</span></span></span><span class="line"><span class="cl"><span class="c1">// +ioc:autowire:type=singleton
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">App</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Injecting the implementation into the structure pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ServiceStruct</span> <span class="o">*</span><span class="nx">ServiceStruct</span> <span class="s">`singleton:&#34;&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Injecting the implementation into the interface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ServiceImpl</span> <span class="nx">Service</span> <span class="s">`singleton:&#34;main.ServiceImpl1&#34;`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The ServiceStruct field of an App is a pointer to a concrete structure, and the field itself can already locate the structure expected to be injected, so there is no need to give the name of the structure expected to be injected in the tag. For such fields injected into structure pointers, AOP capabilities cannot be provided by injecting interface proxies, only by the monkey patching scheme mentioned above, which is not recommended.</p>
<p>The ServiceImpl field of the App is an interface named Service and the expected injected structure pointer is main.ServiceImpl. It is essentially an assertion logic from the structure to the interface, and although the framework can perform a verification of the interface implementation, it still requires the structure user to ensure that the injected interface implements the method. For this injection into the interface, the IOC-golang framework automatically creates a proxy for the main.ServiceImpl structure and injects the proxy structure into the ServiceImpl field, so this interface field has AOP capabilities.</p>
<p>Therefore, ioc recommends developers to program interface-oriented instead of relying directly on concrete structures. In addition to AOP capabilities, interface-oriented programming will also improve the readability of go code, unit testing capabilities, module decoupling level, etc.</p>
</li>
<li>
<p>Obtaining objects by means of API</p>
<p>Developers of the IOC-golang framework can get structure pointers by way of an API, by calling the GetImpl method of an autoloading model (such as a singleton).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetServiceStructSingleton</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">ServiceStruct</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">singleton</span><span class="p">.</span><span class="nf">GetImpl</span><span class="p">(</span><span class="s">&#34;main.ServiceStruct&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">impl</span> <span class="o">:=</span> <span class="nx">i</span><span class="p">.(</span><span class="o">*</span><span class="nx">ServiceStruct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">impl</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Developers using the IOC-golang framework prefer to get the interface object by means of an API. By calling the GetImplWithProxy method of an autoloading model (e.g. singleton), you can get a proxy structure that can be asserted as an interface for use. This interface is not created manually by the structure provider, but is a &ldquo;structure-specific interface&rdquo; automatically generated by iocli, as explained below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetServiceStructIOCInterfaceSingleton</span><span class="p">()</span> <span class="p">(</span><span class="nx">ServiceStructIOCInterface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">singleton</span><span class="p">.</span><span class="nf">GetImplWithProxy</span><span class="p">(</span><span class="s">&#34;main.ServiceStruct&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">impl</span> <span class="o">:=</span> <span class="nx">i</span><span class="p">.(</span><span class="nx">ServiceStructIOCInterface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">impl</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>These two ways to get objects through the API can be automatically generated by the iocli tool. Note that the role of these codes are to facilitate developers to call the API and reduce the amount of code, while the logic kernel of ioc autoloading is not generated by the tool, which is one of the different points from the idea of dependency injection provided by wire, and is a point that many developers misunderstand.</p>
</li>
<li>
<p>IOC-golang&rsquo;s architecture exclusive interface</p>
<p>From the above, we know that the IOC-golang framework&rsquo;s recommended approach to AOP injection is to strongly rely on interfaces. But requiring developers to write a matching interface by hand for all their structures can be time-consuming. So the iocli tool can automatically generate structure-specific interfaces to reduce the amount of code developers have to write.</p>
<p>For example, a structure called ServiceImpl, which contains the GetHelloString method</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +ioc:autowire=true
</span></span></span><span class="line"><span class="cl"><span class="c1">// +ioc:autowire:type=singleton
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ServiceImpl</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ServiceImpl</span><span class="p">)</span> <span class="nf">GetHelloString</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;This is ServiceImpl1, hello %s&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the iocli gen command is executed, a copy of the code zz_generated.ioc.go is generated in the current directory, which contains the &ldquo;proprietary interface&rdquo; for the structure.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ServiceImplIOCInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">GetHelloString</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The exclusive interface is named $(structure name)IOCInterface, and the exclusive interface contains all the methods of the structure. The role of the exclusive interface is twofold.</p>
<ol>
<li>To reduce the workload of developers, it is convenient to get to the proxy structure directly by means of API, which is convenient to inject directly as a field.</li>
<li>Structure exclusive interface can directly locate the structure ID, so when injecting the exclusive interface, the tag does not need to explicitly specify the structure type.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// +ioc:autowire=true
</span></span></span><span class="line"><span class="cl"><span class="c1">// +ioc:autowire:type=singleton
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">App</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Inject the ServiceImpl structure-specific interface without specifying the structure ID in the tag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ServiceOwnInterface</span> <span class="nx">ServiceImplIOCInterface</span> <span class="s">`singleton:&#34;&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, a random existing go project, which uses the structure of the location of the pointer, we recommend replacing it with a structure-exclusive interface, the framework default injection agent; for the fields in which the interface has been used, we recommend injecting the structure directly through the label, also by the framework default injection agent. The project developed according to this model, all its objects will have the ability to operate and maintain.</p>
</li>
</ul>
<h3 id="32-proxy-generation-and-injection">3.2 Proxy generation and injection</h3>
<p>The objects mentioned in the previous section as &ldquo;injected into an interface&rdquo; are encapsulated by the framework as proxies by default, with the ability to run and maintain them, and mention that iocli generates &ldquo;proprietary interfaces&rdquo; for all structures. In this section, we explain how the framework encapsulates the proxy layer and how it is injected into the interface.</p>
<ul>
<li>
<p>Code generation and registration of proxy structures</p>
<p>The code generated in zz.generated.ioc.go, mentioned above, contains the structure-specific interfaces and, similarly, the definition of the structure proxy. Taking the ServiceImpl structure mentioned above as an example, it generates a proxy structure as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">serviceImpl1_</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">GetHelloString_</span> <span class="kd">func</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">serviceImpl1_</span><span class="p">)</span> <span class="nf">GetHelloString</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetHelloString_</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The proxy structure is named <code>$(structure name)</code>_, which implements all the methods of the &ldquo;structure-specific interface&rdquo; and proxies all method calls to the method field of <code>$(method name)_</code>, which will be implemented by the framework in a reflective manner.</p>
<p>Like the structure code, the proxy structure is also registered to the framework in this generated file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl"><span class="nx">normal</span><span class="p">.</span><span class="nf">RegisterStructDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">autowire</span><span class="p">.</span><span class="nx">StructDescriptor</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Factory</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">&amp;</span><span class="nx">serviceImpl1_</span><span class="p">{}</span> <span class="c1">// Registered Agent Structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Injection of proxy objects</p>
<p>The above describes the definition of the proxy structure and the registration process. When the user expects to get the proxy object that encapsulates the AOP layer, it will first load the real object, then try to load the proxy object, and finally instantiate the proxy object through reflection to inject the interface, thus giving the interface operation and maintenance capabilities. The process can be demonstrated by the following diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/03/fddaf0dfb339421ea0faa32bfb2ea1b4.png" alt="Injection of proxy objects"></p>
</li>
</ul>
<h2 id="4-ioc-golang-aop-based-applications">4. IOC-golang AOP-based applications</h2>
<p>Understanding the implementation ideas mentioned above, we can assume that all interface objects injected and obtained from the framework in applications developed using the IOC-golang framework are operationally capable. We can extend the capabilities we expect based on the idea of AOP. We provide a simple e-commerce system demo <a href="https://github.com/ioc-golang/shopping-system">shopping-system</a>, which demonstrates the AOP-based visualization capabilities of IOC-golang in a distributed scenario. Interested developers can refer to the README and run the system in their own clusters to get a feel of its operation and maintenance capabilities base.</p>
<h3 id="41-methods-parameters-observable">4.1 Methods, parameters observable</h3>
<ul>
<li>
<p>View application interfaces and methods</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% iocli list
</span></span><span class="line"><span class="cl">github.com/alibaba/ioc-golang/extension/autowire/rpc/protocol/protocol_impl.IOCProtocol
</span></span><span class="line"><span class="cl"><span class="o">[</span>Invoke Export<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">github.com/ioc-golang/shopping-system/internal/auth.Authenticator
</span></span><span class="line"><span class="cl"><span class="o">[</span>Check<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">github.com/ioc-golang/shopping-system/pkg/service/festival/api.serviceIOCRPCClient
</span></span><span class="line"><span class="cl"><span class="o">[</span>ListCards ListCachedCards<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Listening for call parameters</p>
<p>With the iocli watch command, we can listen for calls to the Check method of the forensic interface.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iocli watch github.com/ioc-golang/shopping-system/internal/auth.Authenticator Check
</span></span></code></pre></td></tr></table>
</div>
</div><p>Initiate a call against the portal.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -i -X GET <span class="s1">&#39;localhost:8080/festival/listCards?user_id=1&amp;num=10&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see the call parameters and return value of the method being listened to, with user id 1.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">% iocli watch github.com/ioc-golang/shopping-system/internal/auth.Authenticator <span class="nv">Check</span>
</span></span><span class="line"><span class="cl"><span class="o">==========</span> On <span class="nv">Call</span> <span class="o">==========</span>
</span></span><span class="line"><span class="cl">github.com/ioc-golang/shopping-system/internal/auth.Authenticator.Check<span class="o">()</span>
</span></span><span class="line"><span class="cl">Param 1: <span class="o">(</span>int64<span class="o">)</span> <span class="nv">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">==========</span> On <span class="nv">Response</span> <span class="o">==========</span>
</span></span><span class="line"><span class="cl">github.com/ioc-golang/shopping-system/internal/auth.Authenticator.Check<span class="o">()</span>
</span></span><span class="line"><span class="cl">Response 1: <span class="o">(</span>bool<span class="o">)</span> <span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="42-full-link-tracking">4.2 Full-link tracking</h3>
<p>AOP layer based on IOC-golang, can provide user-aware, business non-intrusive distributed scenarios full-link tracking capabilities. That is, a system developed by this framework can take any interface method as an entry point to capture the full link of cross-process calls at method granularity.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/03/a349154dff03422eb49becf19dd15c59.png" alt="Full-link tracking"></p>
<p>Based on the shopping-system&rsquo;s full-link time consumption information, the gorm.First() method of the festival process can be identified as the bottleneck of the system.</p>
<p>The implementation of this capability consists of two parts: method granularity link tracing within processes, and RPC call link tracing between processes. IOC aims to create out-of-the-box application development eco-components for developers, and these built-in components and the RPC capabilities provided by the framework are equipped with O&amp;M capabilities.</p>
<ul>
<li>
<p>AOP-based in-process link tracing</p>
<p>The in-process implementation of link tracing provided by IOC-golang is based on the AOP layer. In order to be business-aware, we do not identify the call link by contextual context, but by go routine id. The go runtime call stack is used to record the depth of the current call relative to the entry function.</p>
</li>
<li>
<p>IOC native RPC-based inter-process link tracing</p>
<p>IOC-golang provides native RPC capabilities without defining an IDL file, just mark // +ioc:autowire:type=rpc for the service provider, generate the relevant registration code and client call stubs, and expose the interface at startup. The client only needs to introduce the client stub for this interface to initiate the call. This native RPC capability is based on json serialization and http transfer protocol, which facilitates the carrier link tracking id.</p>
</li>
</ul>
<h2 id="5-outlook">5. Outlook</h2>
<p>IOC-golang open source has broken 700 star so far, its hot growth is beyond my imagination, also hope this project can bring more open source value and production value, welcome more and more developers to participate in the discussion and construction of this project.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/disk/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Hardware knowledge: how to choose a hard drive</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/gitops/">
            <span class="next-text nav-default">GitOps Getting Started Tutorial</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
