<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>FAQ about Go plugin and solutions - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article describes the common problems and solutions of Golang plug-in." /><meta name="keywords" content="Go Plugin" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/go-plugin-faq/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="FAQ about Go plugin and solutions" />
<meta property="og:description" content="This article describes the common problems and solutions of Golang plug-in." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/go-plugin-faq/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-26T10:07:08+08:00" />
<meta property="article:modified_time" content="2022-07-26T10:07:08+08:00" />

<meta itemprop="name" content="FAQ about Go plugin and solutions">
<meta itemprop="description" content="This article describes the common problems and solutions of Golang plug-in."><meta itemprop="datePublished" content="2022-07-26T10:07:08+08:00" />
<meta itemprop="dateModified" content="2022-07-26T10:07:08+08:00" />
<meta itemprop="wordCount" content="2121">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FAQ about Go plugin and solutions"/>
<meta name="twitter:description" content="This article describes the common problems and solutions of Golang plug-in."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">FAQ about Go plugin and solutions</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-26 10:07:08 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2121 words </span>
          <span class="more-meta"> 10 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#some-background-knowledge">Some background knowledge</a>
          <ul>
            <li><a href="#21-runtime">2.1 Runtime</a></li>
            <li><a href="#22-go-native-plugin-mechanism">2.2 Go Native Plugin Mechanism</a></li>
          </ul>
        </li>
        <li><a href="#typical-problems-and-their-solutions">Typical problems and their solutions</a>
          <ul>
            <li><a href="#31-inconsistent-standard-library-versions">3.1 Inconsistent standard library versions</a></li>
            <li><a href="#32-inconsistent-third-party-library-versions">3.2 Inconsistent third-party library versions</a></li>
            <li><a href="#33-inconsistent-go-versions">3.3 Inconsistent Go versions</a></li>
          </ul>
        </li>
        <li><a href="#unified-solutions">Unified Solutions</a></li>
        <li><a href="#bonus">Bonus</a>
          <ul>
            <li><a href="#51-what-go-build-is-really-doing">5.1 What go build is really doing</a></li>
            <li><a href="#52-target-code-generation">5.2 Target code generation</a></li>
            <li><a href="#53-library-hash-generation-algorithm">5.3 Library Hash Generation Algorithm</a></li>
            <li><a href="#54-library-hash-checks">5.4 Library Hash Checks</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>I have encountered a lot of problems in designing and implementing extension development products based on the Go native plug-in mechanism, and since there is very little relevant information in this area, I would like to take this opportunity to make a very rough summary, and hope that it will help you.</p>
<p>This article only say the problem and the solution, do not read the code.</p>
<h2 id="some-background-knowledge">Some background knowledge</h2>
<h3 id="21-runtime">2.1 Runtime</h3>
<p>In general, in the field of computer programming languages, the concept of &ldquo;runtime&rdquo; is associated with languages that require the use of a vm. A program runs in two parts: the target code and the &ldquo;virtual machine&rdquo;. The most typical example is JAVA, i.e. Java Class + JRE. For some programming languages that do not seem to need a &ldquo;virtual machine&rdquo;, there is less of a &ldquo;runtime&rdquo; concept and the program only needs one part, the target code, to run. But in fact, even C/C++ has a &ldquo;runtime&rdquo;, which is the OS/Lib of the platform it is running on.</p>
<p>The same is true for Go, because running Go programs does not require a JRE-like &ldquo;runtime&rdquo; to be deployed up front, so it may not seem to have anything to do with &ldquo;virtual machines&rdquo; or &ldquo;runtimes&rdquo;.</p>
<p>But in fact, the Go &ldquo;runtime&rdquo; is compiled by the compiler as part of the binary target code.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/dc33025670fb4334a836b2fc39de63ca.png" alt="Java program, runtime and OS relationship"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/a090a3cd12b94f3db2e279a578210d0d.png" alt="C/C++ programs, runtime and OS relationships"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/6d96de68a2dc428bb691d9e7bb6325d7.png" alt="Go programs, runtime and OS relationships"></p>
<h3 id="22-go-native-plugin-mechanism">2.2 Go Native Plugin Mechanism</h3>
<p>As a language that appears to be more closely aligned with the C/C++ technology stack, support for dynamic link library-like extensions has been a relatively strong demand in the community. As shown in Figure 2-5, Go provides a plugin package in the standard library specifically as a language-level programming interface for plugins. The src/plugin package is essentially <strong>the standard interface for calling unix using the cgo mechanism:</strong> dlopen() and dlsym(). As such, it gives programmers with a C/C++ background the illusion that &ldquo;I can do this&rdquo;.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/908f9d10c82b4f61bb28f1bf16890c92.png" alt="C/C++ programs load dynamic link libraries"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/c8570403b9834b7d8945ad0a90529e56.png" alt=" Go programs load dynamic link libraries"></p>
<h2 id="typical-problems-and-their-solutions">Typical problems and their solutions</h2>
<p>Unfortunately, compared to the C/C++ technology stack, the output of Go&rsquo;s plugins is also a dynamic link library file, but it has a series of very complex built-in constraints for the development and use of plugins. What is even more head-scratching is that the Go language not only does not provide a systematic introduction to these constraints, but even writes some rather poor designs and implementations, leading to very anti-human troubleshooting of plug-in related issues. This chapter focuses on the most common problems in developing and using Go plugins, mainly when compiling and loading plugins, but you must locate the source code of the Go standard library (mainly including compiler, linker, packer and runtime parts) to fully understand them, and the corresponding solutions.</p>
<p>In short, when Go&rsquo;s main program loads the plugin, it performs a bunch of constraint checks on both in &ldquo;runtime&rdquo;, including but not limited to the following.</p>
<ul>
<li>go version is consistent</li>
<li>go path consistency</li>
<li>go dependency intersections are consistent
<ul>
<li>code consistency</li>
<li>path consistency</li>
</ul>
</li>
<li>go build some flags consistent</li>
</ul>
<h3 id="31-inconsistent-standard-library-versions">3.1 Inconsistent standard library versions</h3>
<p>The main application loads the plugin with the following error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">plugin</span> <span class="nx">was</span> <span class="nx">built</span> <span class="nx">with</span> <span class="nx">a</span> <span class="nx">different</span> <span class="nx">version</span> <span class="nx">of</span> <span class="kn">package</span> <span class="nx">runtime</span><span class="o">/</span><span class="nx">internal</span><span class="o">/</span><span class="nx">sys</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the text of this error report, we can know that the specific library in question is runtime/internal/sys, which is obviously a go built-in standard library. Seeing this, you may have great doubts: I obviously use the same local environment to compile the main program and plug-ins, why report the standard library is not a version?</p>
<p>The answer is that go&rsquo;s error log is not accurately described. And the root cause of this error can be attributed to: <strong>some key compilation flags of the main program and the plug-in are not consistent, nothing to do with the &ldquo;version&rdquo;.</strong></p>
<p>For example, you compile the plugin with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">GO111MODULE</span><span class="o">=</span>on go build --buildmode<span class="o">=</span>plugin -mod <span class="nb">readonly</span> -o ./codec.so ./codec.go
</span></span></code></pre></td></tr></table>
</div>
</div><p>But you use goland&rsquo;s debug mode to debug the main program, at which point goland will assemble the go build command for you as in the example below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/usr/local/go/bin/go <span class="nb">test</span> -c -o /private/var/folders/gy/2zv22t710sd7m0x9bcfzq23r0000gp/T/GoLand/___Test_TaskC_in_github_com_fdingiit_mpl_test.test -gcflags <span class="nv">all</span><span class="o">=</span>-N -l github.com/fdingiit/mpl/test <span class="c1">#gosetup</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that the compile command for the goland assembly contains the critical -gcflags all=-N -l parameter, but the command for the plugin compile does not. In this case, you will get an error about runtime/internal/sys when trying to load the plugin.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/4b68fb45b47f4e6daf0cf27807c8ab60.png" alt=" Load failure due to inconsistent compile flags"></p>
<p>The solution to this type of standard library version inconsistency is relatively simple:<strong>align the flags compiled by the main program and the plugins as much as possible.</strong> In fact, there are some flags that do not affect the loading of plugins, and you can take your time to figure them out in concrete practice.</p>
<h3 id="32-inconsistent-third-party-library-versions">3.2 Inconsistent third-party library versions</h3>
<p>If you are using vendor to manage Go dependencies, then 100% of the time you will encounter this error below immediately after resolving the 3.1 issue.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">plugin was built with a different version of package xxxxxxxx
</span></span></code></pre></td></tr></table>
</div>
</div><p>Where xxxxxxxxx refers to a specific three-party library, such as github.com/stretchr/testify . There are several very typical reasons for this error report, several of which may take a developer quite a bit of time if they don&rsquo;t have relevant troubleshooting experience.</p>
<h4 id="321-case-1-version-inconsistency">3.2.1 Case 1. version inconsistency</h4>
<p>As shown in the error report, it seems clear that the cause is inconsistent with the version of a third-party library on which the main application and the plugin depend, and the error report will clearly tell you which library is the problem. At this point, you can compare the go.mod files of the main program and the plug-in to find the version of the library in question, respectively, to see if they are consistent. If at this point you find that the main program and the plugin do have a commitid or tag inconsistency problem, then the solution is also simple: <strong>align them</strong>.</p>
<p>But in many cases, you only use a part of the three-party library, such as a package, or just an interface, and this part of the code does not change at all in different versions; but changes to other unused code will also cause the entire three-party library version number to change. This will cause you to become an innocent victim of the &ldquo;version inconsistency&rdquo;.</p>
<p>And, at this point, you may immediately run into another problem: who is the baseline alignment? The main program? Or the plugin?</p>
<p>Common sense dictates that baseline alignment with the main program is a better strategy because, after all, plugins are newly added &ldquo;dependencies&rdquo; and the main program and plugins are usually in a 1-to-many relationship. But what if the plugin&rsquo;s three-way library dependencies just don&rsquo;t align with the main program for any reason? After trying for a long time, I haven&rsquo;t found a perfect solution to this problem yet.</p>
<p>If versions cannot be aligned, plugins have to be abandoned from the ground up.</p>
<p>This strong consistency constraint on the three-party library of the Go language, on the one hand, avoids potential problems caused by version inconsistency at runtime; on the other hand, this deliberate design that does not give programmers flexibility is very unfriendly to plug-in, customization, and extension development.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/ddcbde1af4574b2994502055f7e3f58f.png" alt="Load failure due to inconsistent versions of co-dependent three-party libraries"></p>
<h4 id="322-case-2-version-number-consistent-code-inconsistent">3.2.2 case 2. version number consistent, code inconsistent</h4>
<p>Things get complicated when you troubleshoot the go.mod file along the lines of 3.2.1, but are surprised to find that the library versions reporting errors are the same. You might pull out the world&rsquo;s most advanced text-checking tool and spend the morning diffing the commitid of all three libraries, but they are exactly the same, seemingly stuck in Schrödinger&rsquo;s version.</p>
<p>One possible reason for this problem is that someone has directly modified the code in the vendor directory, and the Go plugin mechanism checks the consistency of the code content.</p>
<p>This is really a very big headache and difficult to troubleshoot. No one will know about it except the person who modified the code and the people who have been &ldquo;screwed&rdquo; in other cases. If the modified vendor code is in the main program, you have almost no reliable way to get it to work.</p>
<p>Don&rsquo;t change the code directly in vendor, give back to the open source community, or fork-replace.</p>
<p>The good news is that you don&rsquo;t need to solve this problem. Because even if you do, there will be bigger problems waiting for you.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/baa69be7110a4d43bfa1fef0a9102a19.png" alt="Load failure due to in-place modification of co-dependent three-party library code"></p>
<h4 id="323-case-3-inconsistent-paths">3.2.3 case 3. inconsistent paths</h4>
<p>When the problem is solved according to 3.2.1 and 3.2.2, but it still reports a <code>different version of the package</code>, you may start to spit on Go&rsquo;s plugin mechanism: the version is really the same, the code really hasn&rsquo;t moved a line, why is there still an exception?</p>
<p>The reason is that the <strong>plugin mechanism checks the &ldquo;path&rdquo; of the source code of the dependency library</strong> , so you can&rsquo;t use vendor to manage dependencies.</p>
<p>For example, your main application source code is in the /path/to/main directory, so one of your three-way libraries should depend on the directory /path/to/main/vendor/some/thrid/part/lib. This &ldquo;file path&rdquo; data is packaged into the binary executable and used for verification, and when the main application loads the plugin, Go&rsquo;s &ldquo;runtime&rdquo; When the main application loads the plugin, Go&rsquo;s &ldquo;runtime&rdquo; &ldquo;smartly&rdquo; determines that it is not using the same code as the plugin by the difference in the &ldquo;file paths&rdquo; and reports a different version of the package.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/f3171b2a5cd348a49033d679ab4d3136.png" alt="Using the vendor mechanism to manage load failures caused by third-party libraries"></p>
<p>The same problem may occur in scenarios where different machines/users are used and the main program and plugins are compiled separately: the path to the go code should be different for different usernames.</p>
<p>The solution to this kind of problem is violently straightforward: delete the vendor directories of the main program and plugins, or use <code>-mod=readonly</code> compile flags.</p>
<p>By this point, if you are using the same machine for both the main program and the plugin compilation, then the common problems should be largely solved and the plugin mechanism should work as it should. On the other hand, since vendor is no longer used to manage dependencies, the 3.2.2 issues will be forced here as well: either mention PR to the community, or fork-replace.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/c1975b66aabb45aea323a418e7406d53.png" alt="Successfully loaded"></p>
<h3 id="33-inconsistent-go-versions">3.3 Inconsistent Go versions</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">fatal error: runtime: no plugin module data
</span></span></code></pre></td></tr></table>
</div>
</div><p>In addition to the issues above, there is a common error reported in multiple machines compiling separate main/plugin scenarios. One possible reason for this error is <strong>Go version inconsistency</strong>, just align them. (What if they just can&rsquo;t be aligned from the machine level?)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/af06886ee96d4c3ab0929e510b4045a2.png" alt="Load failure due to inconsistent Go versions"></p>
<h2 id="unified-solutions">Unified Solutions</h2>
<p>From 3.1 to 3.3, we looked at some issues that were difficult to troubleshoot and not very well handled. In addition to that, there are actually some issues that were not highlighted in. As an officially supported extension mechanism for a programming language, it was really surprising to see it done so user-unfriendly.</p>
<p>My team relies heavily on Go&rsquo;s plug-in mechanism to do customization, so I had to come up with a systematic solution to solve all of these problems. After trying to directly modify the Go source code to no avail (spit: the Go plug-in mechanism source code is slightly regrettable), I focused on the following aspects of the work.</p>
<ul>
<li>
<p>Unified compilation environment.</p>
<ul>
<li>Provide a standard docker image for compiling the main application and plugins, circumventing any problems caused by inconsistencies in go versions, gopath paths, usernames, etc.</li>
<li>Prefabricated go/pkg/mod to minimize the problem of re-downloading dependencies every time you compile because you don&rsquo;t use vendor mode.</li>
</ul>
</li>
<li>
<p>Unified Makefile.</p>
<ul>
<li>Provide a set of Makefiles for compiling the main program and plugins, circumventing any problems caused by the go build command</li>
</ul>
</li>
<li>
<p>Unified plugin development scaffolding.</p>
<ul>
<li>Scaffolding, rather than developers pulling together dependent versions of plugins with the main application. and other related issues are resolved by scaffolding</li>
</ul>
</li>
<li>
<p>ACI-ization.</p>
<ul>
<li>ACI-ize the compilation process to further avoid errors</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/3a9c683884e54029adc128aeacb6f4d3.png" alt="Unified Solutions"></p>
<p>So far, the Go plug-in on the common problems and solutions to introduce the temporary end, I hope you have helped.</p>
<h2 id="bonus">Bonus</h2>
<p>If you really want to get to the root of the plugin checksum mechanism, then here are some quick entry points into the source code reading. I&rsquo;m using Go source code version 1.15.2.</p>
<p>Location of related Go source code.</p>
<ul>
<li>
<p>compiler</p>
<ul>
<li>go/src/cmd/compile/*</li>
</ul>
</li>
<li>
<p>linker</p>
<ul>
<li>go/src/cmd/link/internal/ld/*</li>
</ul>
</li>
<li>
<p>package loader</p>
<ul>
<li>go/src/cmd/go/internal/load/*</li>
</ul>
</li>
<li>
<p>runtime</p>
<ul>
<li>go/src/runtime/*</li>
</ul>
</li>
</ul>
<h3 id="51-what-go-build-is-really-doing">5.1 What go build is really doing</h3>
<p>You can add the -x parameter to the go build command to explicitly print out the full process of compiling, linking, and packaging a Go program, for example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">go build -x -buildmode<span class="o">=</span>plugin -o ../calc_plugin.so calc_plugin.go
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-target-code-generation">5.2 Target code generation</h3>
<p><code>go/src/cmd/compile/internal/gc/obj.go:55</code> : Note lines 67 and 72, there are two entries here
<code>go/src/cmd/compile/internal/gc/iexport.go:244</code> : note line 280, where path-related data is recorded</p>
<h3 id="53-library-hash-generation-algorithm">5.3 Library Hash Generation Algorithm</h3>
<p><code>go/src/cmd/link/internal/ld/lib.go:967</code> : Note lines 995 to 1025, where the hash of the pkg is calculated</p>
<h3 id="54-library-hash-checks">5.4 Library Hash Checks</h3>
<p><code>go/src/runtime/symtab.go:392</code> : Key data structures
<code>go/src/runtime/plugin.go:52</code> : link-time hash and run-time hash checkpoint
<code>go/src/cmd/link/internal/ld/symtab.go:621</code> : link-time hash assignment point
<code>go/src/cmd/link/internal/ld/symtab.go:52</code>1 : Runtime hash assignment point</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/schemahero/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Cloud Native Declarative Database Structure Migration Tool - SchemaHero</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-ebpf-03/">
            <span class="next-text nav-default">Implementing bidirectional data exchange between kernel and user states of eBPF programs using Golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
