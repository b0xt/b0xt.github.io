<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Pod Security Policies - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore K8S&#39;s Pod security policy." /><meta name="keywords" content="PodSecurityPolicy" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/k8s-psp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Pod Security Policies" />
<meta property="og:description" content="Explore K8S&#39;s Pod security policy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/k8s-psp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-04T13:00:51+08:00" />
<meta property="article:modified_time" content="2022-07-04T13:00:51+08:00" />

<meta itemprop="name" content="Pod Security Policies">
<meta itemprop="description" content="Explore K8S&#39;s Pod security policy."><meta itemprop="datePublished" content="2022-07-04T13:00:51+08:00" />
<meta itemprop="dateModified" content="2022-07-04T13:00:51+08:00" />
<meta itemprop="wordCount" content="1016">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pod Security Policies"/>
<meta name="twitter:description" content="Explore K8S&#39;s Pod security policy."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Pod Security Policies</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-04 13:00:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1016 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-is-podsecuritypolicy">What is PodSecurityPolicy</a></li>
        <li><a href="#enabling-podsecuritypolicy">Enabling PodSecurityPolicy</a></li>
        <li><a href="#authorization-policy">Authorization Policy</a></li>
        <li><a href="#example">Example</a>
          <ul>
            <li><a href="#1-create-policy">1. Create Policy</a></li>
            <li><a href="#2-create-serviceaccount">2. Create serviceaccount</a></li>
            <li><a href="#3-create-pod">3. Create Pod</a></li>
            <li><a href="#4-create-a-role-with-psp-example-use-permission-and-bind-to-sa-hellobaby">4. Create a role with psp example use permission and bind to sa hellobaby</a></li>
            <li><a href="#5-pods-not-created-directly-by-sa">5. Pods not created directly by sa</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="what-is-podsecuritypolicy">What is PodSecurityPolicy</h2>
<p>PodSecurityPolicy is a global resource used to control Pod security-related configuration.</p>
<p>On a kubernetes cluster with RBAC enabled, if users are allowed to use kubectl, then PodSecurityPolicy must be enabled, otherwise users may use some privileged resources (e.g. privileged, hostNetwork, hostPath, etc.) and affect the stability of the node machine.</p>
<p>With PSP turned on, users can only use resources allowed by the administrator. PSP supports the following (see <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#policy-reference">official website</a> for details).</p>
<table>
<thead>
<tr>
<th>Control Aspect</th>
<th>Field Names</th>
</tr>
</thead>
<tbody>
<tr>
<td>Running of privileged containers</td>
<td><code>privileged</code></td>
</tr>
<tr>
<td>Usage of host namespaces</td>
<td><code>hostPID</code>, <code>hostIPC</code></td>
</tr>
<tr>
<td>Usage of host networking and ports</td>
<td><code>hostNetwork</code>, <code>hostPorts</code></td>
</tr>
<tr>
<td>Usage of volume types</td>
<td><code>volumes</code></td>
</tr>
<tr>
<td>Usage of the host filesystem</td>
<td><code>allowedHostPaths</code></td>
</tr>
<tr>
<td>White list of Flexvolume drivers</td>
<td><code>allowedFlexVolumes</code></td>
</tr>
<tr>
<td>Allocating an FSGroup that owns the pod&rsquo;s volumes</td>
<td><code>fsGroup</code></td>
</tr>
<tr>
<td>Requiring the use of a read only root file system</td>
<td><code>readOnlyRootFilesystem</code></td>
</tr>
<tr>
<td>The user and group IDs of the container</td>
<td><code>runAsUser</code>, <code>runAsGroup</code>, <code>supplementalGroups</code></td>
</tr>
<tr>
<td>Restricting escalation to root privileges</td>
<td><code>allowPrivilegeEscalation</code>, <code>defaultAllowPrivilegeEscalation</code></td>
</tr>
<tr>
<td>Linux capabilities</td>
<td><code>defaultAddCapabilities</code>, <code>requiredDropCapabilities</code>, <code>allowedCapabilities</code></td>
</tr>
<tr>
<td>The SELinux context of the container</td>
<td><code>seLinux</code></td>
</tr>
<tr>
<td>The Allowed Proc Mount types for the container</td>
<td><code>allowedProcMountTypes</code></td>
</tr>
<tr>
<td>The AppArmor profile used by containers</td>
<td><code>annotations</code></td>
</tr>
<tr>
<td>The seccomp profile used by containers</td>
<td><code>annotations</code></td>
</tr>
<tr>
<td>The sysctl profile used by containers</td>
<td><code>annotations</code></td>
</tr>
</tbody>
</table>
<h2 id="enabling-podsecuritypolicy">Enabling PodSecurityPolicy</h2>
<p>Enabling is simple, just configure apiserver to add the admission plugin PodSecurityPolicy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">--enable-admission-plugins<span class="o">=</span>NodeRestriction,PodSecurityPolicy
</span></span></code></pre></td></tr></table>
</div>
</div><p>The apiserver will restart after the modification. Since there is no Policy configured here, PSP will prevent all Pod creation after reboot.</p>
<p>Since the PSP API <code>policy/v1beta1/podsecuritypolicy</code> is independent from the authorization controller, for existing clusters, it is recommended to configure psp and authorization first, and then turn on PS.</p>
<h2 id="authorization-policy">Authorization Policy</h2>
<p>Policy itself does not produce the actual effect, you need to bind it to the user or serviceaccount to complete the authorization.</p>
<p>Binding method: Create a Role, which can use the PodSecurityPolicy, and then bind the role to the user or serviceaccount.</p>
<h2 id="example">Example</h2>
<p>Here is an example.</p>
<h3 id="1-create-policy">1. Create Policy</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodSecurityPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">  </span><span class="c"># Don&#39;t allow privileged pods!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># The rest fills in some required fields.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">seLinux</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">supplementalGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-create-serviceaccount">2. Create serviceaccount</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl create namespace hellobaby
</span></span><span class="line"><span class="cl">kubectl create sa fake-user
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> kubectl-admin<span class="o">=</span><span class="s1">&#39;kubectl -n hellobaby&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">alias</span> kubectl-user<span class="o">=</span><span class="s1">&#39;kubectl --as=system:serviceaccount:hellobaby:fake-user -n hellobaby&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-create-pod">3. Create Pod</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, if you use kubectl-user to create a Pod, you will get the following prompt.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: error when creating <span class="s2">&#34;STDIN&#34;</span>: pods <span class="s2">&#34;nginx&#34;</span> is forbidden: unable to validate against any pod security policy: <span class="o">[]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because sa fake user does not have the permission of psp example, you can check it by auth.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl-user auth can-i use podsecuritypolicy/example
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the next step is to create the role, rolebinding.</p>
<h3 id="4-create-a-role-with-psp-example-use-permission-and-bind-to-sa-hellobaby">4. Create a role with psp example use permission and bind to sa hellobaby</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl-admin create role psp:unprivileged --verb<span class="o">=</span>use <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --resource<span class="o">=</span>podsecuritypolicy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --resource-name<span class="o">=</span>example
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl-admin create rolebinding fake-user:psp:unprivileged <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --role<span class="o">=</span>psp:unprivileged <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --serviceaccount<span class="o">=</span>hellobaby:fake-user
</span></span><span class="line"><span class="cl">rolebinding <span class="s2">&#34;fake-user:psp:unprivileged&#34;</span> created
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now go create the above Pod nginx again, and it will be created, and it will be created successfully, because this Pod does not request any special privileges and is a good boy.</p>
<p>What about adding the privileged fields and creating it again?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>kubectl-user will return the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: error when creating <span class="s2">&#34;STDIN&#34;</span>: pods <span class="s2">&#34;privileged&#34;</span> is forbidden: unable to validate against any pod security policy: <span class="o">[</span>spec.containers<span class="o">[</span>0<span class="o">]</span>.securityContext.privileged: Invalid value: true: Privileged containers are not allowed<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The tip is clear: <code>Privileged containers are not allowed</code>.</p>
<p>PodSecurityPolicy is in effect.</p>
<h3 id="5-pods-not-created-directly-by-sa">5. Pods not created directly by sa</h3>
<p>Most of the time we don&rsquo;t create Pods directly, but rather we create Deployment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl-user run nginx --image<span class="o">=</span>nginx
</span></span><span class="line"><span class="cl">deployment <span class="s2">&#34;nginx&#34;</span> created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl-user get pods
</span></span><span class="line"><span class="cl">No resources found.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl-user get events <span class="p">|</span> head -n <span class="m">2</span>
</span></span><span class="line"><span class="cl">LASTSEEN   FIRSTSEEN   COUNT     NAME              KIND         SUBOBJECT                TYPE      REASON                  SOURCE                                  MESSAGE
</span></span><span class="line"><span class="cl">1m         2m          <span class="m">15</span>        nginx-7774d79b5   ReplicaSet                            Warning   FailedCreate            replicaset-controller                   Error creating: pods <span class="s2">&#34;nginx-7774d79b5-&#34;</span> is forbidden: no providers available to validate pod request
</span></span></code></pre></td></tr></table>
</div>
</div><p>The message says that there are no providers to check for Pod requests, but we have already given sa hellobaby:fake-user authorization.</p>
<p>The reason is that this Pod is created by the replicaset controller, and the default kubectl run of the application specifies <code>spec.template.spec.serviceAccount</code> and <code>spec.template.spec. serviceAccountName</code> are both default, while the SA of our RBAC binding above is <code>hellobaby:fake-user</code>, not <code>hellobaby:default</code>.</p>
<p>How to solve it? The official website gives the method to bind the role <code>psp:unprivileged</code> to <code>hellobaby:default</code> again. It is true that this can solve the problem, but this solution does not make sense.</p>
<p>We know that a namespace can create more than one serviceaccount, if I need to grant different psp to different sa under the same namespace, then how should I give sa default authorization? Obviously it is impossible to bind.</p>
<p>In fact, I think this example from the official site doesn&rsquo;t make sense and the <code>kubectl run</code> command is going to be eliminated.</p>
<p>A better approach would be to create a deployment and set its <code>spec.template.spec.serviceAccount</code> and <code>spec.template.spec.serviceAccountName</code> to the actual sa.</p>
<p>Here is an actual example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">hellobaby</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#securityContext:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#  privileged: true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterFirst</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">fake-user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">fake-user</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>At this point the replicaset controller will use sa hellobaby:fake-user to create a pod, and since the sa has been bound to the psp example, the Pod can be successfully created.</p>
<p>Ref:</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security Policies</a></li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/k8s-local-volume/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">kubernetes Local Volume</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-archives-and-compresses/">
            <span class="next-text nav-default">How Go archives and compresses files</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
