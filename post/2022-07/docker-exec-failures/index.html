<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Troubleshooting docker exec failures - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to resolve docker exec failures." /><meta name="keywords" content="docker, Exec Failures" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/docker-exec-failures/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Troubleshooting docker exec failures" />
<meta property="og:description" content="Learn how to resolve docker exec failures." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/docker-exec-failures/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-14T12:57:28+08:00" />
<meta property="article:modified_time" content="2022-07-14T12:57:28+08:00" />

<meta itemprop="name" content="Troubleshooting docker exec failures">
<meta itemprop="description" content="Learn how to resolve docker exec failures."><meta itemprop="datePublished" content="2022-07-14T12:57:28+08:00" />
<meta itemprop="dateModified" content="2022-07-14T12:57:28+08:00" />
<meta itemprop="wordCount" content="1496">
<meta itemprop="keywords" content="docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Troubleshooting docker exec failures"/>
<meta name="twitter:description" content="Learn how to resolve docker exec failures."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Troubleshooting docker exec failures</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-14 12:57:28 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1496 words </span>
          <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#problem-description">Problem Description</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#runc-sorting">runc sorting</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This article focuses on learning about.</p>
<ul>
<li>The direct relationship between kubelet, docker-shim, dockerd, containerd, containerd-shim, and runc</li>
<li>How to troubleshoot: How to connect containers using docker, containerd-ctr, docker-runc</li>
<li>runc workflow</li>
</ul>
<h3 id="problem-description">Problem Description</h3>
<p>Today, in the process of checking the system problem, I found that the system log keeps printing the docker exception log.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">May 12 09:08:40 HOSTNAME dockerd[4085]: time=&#34;2021-05-12T09:08:40.642410594+08:00&#34; level=error msg=&#34;stream copy error: reading from a closed fifo&#34;
</span></span><span class="line"><span class="cl">May 12 09:08:40 HOSTNAME dockerd[4085]: time=&#34;2021-05-12T09:08:40.642418571+08:00&#34; level=error msg=&#34;stream copy error: reading from a closed fifo&#34;
</span></span><span class="line"><span class="cl">May 12 09:08:40 HOSTNAME dockerd[4085]: time=&#34;2021-05-12T09:08:40.663754355+08:00&#34; level=error msg=&#34;Error running exec 110deb1c1b2a2d2671d7368bd02bfc18a968e4712a3c771dedf0b362820e73cb in container: OCI runtime exec failed: exec failed: container_linux.go:348: starting container process caused \&#34;read init-p: connection reset by peer\&#34;: unknown&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>In terms of system riskiness, the reasons for the appearance of abnormal logs need to be ranked clearly and figured out whether they will have an impact on the business.</p>
<p>The following article briefly describes the process of problem identification and the reasons for its generation.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>The only information we have now is the system logs informing us that dockerd failed to execute the exec.</p>
<p>Before we get into the specifics of the problem, let&rsquo;s review the working of docker and the invocation chain.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/14/bebc3de07bb7498bae5b77c507f570e8.png" alt="docker invocation chain"></p>
<p>As you can see, the docker call chain is very long and involves more components. Therefore, our troubleshooting path is divided into two main steps as follows.</p>
<ul>
<li>Determine the component that caused the failure</li>
<li>Determine the cause of the component failure</li>
</ul>
<h4 id="locating-the-component">Locating the component</h4>
<p>Users familiar with docker will be able to locate the component causing the problem at a glance. But here, we&rsquo;ll follow the usual troubleshooting process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">// 1. Locate the problem container
</span></span><span class="line"><span class="cl"><span class="c1"># sudo docker ps | grep -v pause | grep -v NAMES | awk &#39;{print $1}&#39; | xargs -ti sudo docker exec {} sleep 1</span>
</span></span><span class="line"><span class="cl">sudo docker <span class="nb">exec</span> aa1e331ec24f sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">OCI runtime <span class="nb">exec</span> failed: <span class="nb">exec</span> failed: container_linux.go:348: starting container process caused <span class="s2">&#34;read init-p: connection reset by peer&#34;</span>: unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 2. Exclude docker from suspicion
</span></span><span class="line"><span class="cl"><span class="c1"># docker-containerd-ctr -a /var/run/docker/containerd/docker-containerd.sock -n moby t exec --exec-id stupig1 aa1e331ec24f621ab3152ebe94f1e533734164af86c9df0f551eab2b1967ec4e sleep 1</span>
</span></span><span class="line"><span class="cl">ctr: OCI runtime <span class="nb">exec</span> failed: <span class="nb">exec</span> failed: container_linux.go:348: starting container process caused <span class="s2">&#34;read init-p: connection reset by peer&#34;</span>: unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// 3. exclude containererd and containererd-shim suspect
</span></span><span class="line"><span class="cl"><span class="c1"># docker-runc --root /var/run/docker/runtime-runc/moby/ exec aa1e331ec24f621ab3152ebe94f1e533734164af86c9df0f551eab2b1967ec4e sleep</span>
</span></span><span class="line"><span class="cl">runtime/cgo: pthread_create failed: Resource temporarily unavailable
</span></span><span class="line"><span class="cl">SIGABRT: abort
</span></span><span class="line"><span class="cl"><span class="nv">PC</span><span class="o">=</span>0x6b657e <span class="nv">m</span><span class="o">=</span><span class="m">0</span> <span class="nv">sigcode</span><span class="o">=</span><span class="m">18446744073709551610</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">goroutine <span class="m">0</span> <span class="o">[</span>idle<span class="o">]</span>:
</span></span><span class="line"><span class="cl">runtime: unknown pc 0x6b657e
</span></span><span class="line"><span class="cl">stack: <span class="nv">frame</span><span class="o">={</span>sp:0x7ffd30f0d218, fp:0x0<span class="o">}</span> <span class="nv">stack</span><span class="o">=[</span>0x7ffd2ab0e738,0x7ffd30f0d760<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d118:  <span class="m">0000000000000002</span>  00007ffd30f7f184
</span></span><span class="line"><span class="cl">00007ffd30f0d128:  000000000069c31c  00007ffd30f0d1a8
</span></span><span class="line"><span class="cl">00007ffd30f0d138:  000000000045814e &lt;runtime.callCgoMmap+62&gt;  00007ffd30f0d140
</span></span><span class="line"><span class="cl">00007ffd30f0d148:  00007ffd30f0d190  0000000000411a88 &lt;runtime.persistentalloc1+456&gt;
</span></span><span class="line"><span class="cl">00007ffd30f0d158:  0000000000bf6dd0  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d168:  <span class="m">0000000000010000</span>  <span class="m">0000000000000008</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d178:  0000000000bf6dd8  0000000000bf7ca0
</span></span><span class="line"><span class="cl">00007ffd30f0d188:  00007fdcbb4b7000  00007ffd30f0d1c8
</span></span><span class="line"><span class="cl">00007ffd30f0d198:  <span class="m">0000000000451205</span> &lt;runtime.persistentalloc.func1+69&gt;  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d1a8:  <span class="m">0000000000000000</span>  0000000000c1c080
</span></span><span class="line"><span class="cl">00007ffd30f0d1b8:  00007fdcbb4b7000  00007ffd30f0d1e0
</span></span><span class="line"><span class="cl">00007ffd30f0d1c8:  00007ffd30f0d210  00007ffd30f0d220
</span></span><span class="line"><span class="cl">00007ffd30f0d1d8:  <span class="m">0000000000000000</span>  00000000000000f1
</span></span><span class="line"><span class="cl">00007ffd30f0d1e8:  <span class="m">0000000000000011</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d1f8:  000000000069c31c  0000000000c1c080
</span></span><span class="line"><span class="cl">00007ffd30f0d208:  000000000045814e &lt;runtime.callCgoMmap+62&gt;  00007ffd30f0d210
</span></span><span class="line"><span class="cl">00007ffd30f0d218: &lt;00007ffd30f0d268  fffffffe7fffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d228:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d238:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d248:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d258:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d268:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d278:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d288:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d298:  ffffffffffffffff  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2a8:  00000000006b68ba  <span class="m">0000000000000020</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2b8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2c8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2d8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2e8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2f8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d308:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">runtime: unknown pc 0x6b657e
</span></span><span class="line"><span class="cl">stack: <span class="nv">frame</span><span class="o">={</span>sp:0x7ffd30f0d218, fp:0x0<span class="o">}</span> <span class="nv">stack</span><span class="o">=[</span>0x7ffd2ab0e738,0x7ffd30f0d760<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d118:  <span class="m">0000000000000002</span>  00007ffd30f7f184
</span></span><span class="line"><span class="cl">00007ffd30f0d128:  000000000069c31c  00007ffd30f0d1a8
</span></span><span class="line"><span class="cl">00007ffd30f0d138:  000000000045814e &lt;runtime.callCgoMmap+62&gt;  00007ffd30f0d140
</span></span><span class="line"><span class="cl">00007ffd30f0d148:  00007ffd30f0d190  0000000000411a88 &lt;runtime.persistentalloc1+456&gt;
</span></span><span class="line"><span class="cl">00007ffd30f0d158:  0000000000bf6dd0  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d168:  <span class="m">0000000000010000</span>  <span class="m">0000000000000008</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d178:  0000000000bf6dd8  0000000000bf7ca0
</span></span><span class="line"><span class="cl">00007ffd30f0d188:  00007fdcbb4b7000  00007ffd30f0d1c8
</span></span><span class="line"><span class="cl">00007ffd30f0d198:  <span class="m">0000000000451205</span> &lt;runtime.persistentalloc.func1+69&gt;  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d1a8:  <span class="m">0000000000000000</span>  0000000000c1c080
</span></span><span class="line"><span class="cl">00007ffd30f0d1b8:  00007fdcbb4b7000  00007ffd30f0d1e0
</span></span><span class="line"><span class="cl">00007ffd30f0d1c8:  00007ffd30f0d210  00007ffd30f0d220
</span></span><span class="line"><span class="cl">00007ffd30f0d1d8:  <span class="m">0000000000000000</span>  00000000000000f1
</span></span><span class="line"><span class="cl">00007ffd30f0d1e8:  <span class="m">0000000000000011</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d1f8:  000000000069c31c  0000000000c1c080
</span></span><span class="line"><span class="cl">00007ffd30f0d208:  000000000045814e &lt;runtime.callCgoMmap+62&gt;  00007ffd30f0d210
</span></span><span class="line"><span class="cl">00007ffd30f0d218: &lt;00007ffd30f0d268  fffffffe7fffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d228:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d238:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d248:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d258:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d268:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d278:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d288:  ffffffffffffffff  ffffffffffffffff
</span></span><span class="line"><span class="cl">00007ffd30f0d298:  ffffffffffffffff  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2a8:  00000000006b68ba  <span class="m">0000000000000020</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2b8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2c8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2d8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2e8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d2f8:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">00007ffd30f0d308:  <span class="m">0000000000000000</span>  <span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">goroutine <span class="m">1</span> <span class="o">[</span>running<span class="o">]</span>:
</span></span><span class="line"><span class="cl">runtime.systemstack_switch<span class="o">()</span>
</span></span><span class="line"><span class="cl">    /usr/local/go/src/runtime/asm_amd64.s:363 <span class="nv">fp</span><span class="o">=</span>0xc4200fe788 <span class="nv">sp</span><span class="o">=</span>0xc4200fe780 <span class="nv">pc</span><span class="o">=</span>0x454120
</span></span><span class="line"><span class="cl">runtime.main<span class="o">()</span>
</span></span><span class="line"><span class="cl">    /usr/local/go/src/runtime/proc.go:128 +0x63 <span class="nv">fp</span><span class="o">=</span>0xc4200fe7e0 <span class="nv">sp</span><span class="o">=</span>0xc4200fe788 <span class="nv">pc</span><span class="o">=</span>0x42bb83
</span></span><span class="line"><span class="cl">runtime.goexit<span class="o">()</span>
</span></span><span class="line"><span class="cl">    /usr/local/go/src/runtime/asm_amd64.s:2361 +0x1 <span class="nv">fp</span><span class="o">=</span>0xc4200fe7e8 <span class="nv">sp</span><span class="o">=</span>0xc4200fe7e0 <span class="nv">pc</span><span class="o">=</span>0x456c91
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rax    0x0
</span></span><span class="line"><span class="cl">rbx    0xbe2978
</span></span><span class="line"><span class="cl">rcx    0x6b657e
</span></span><span class="line"><span class="cl">rdx    0x0
</span></span><span class="line"><span class="cl">rdi    0x2
</span></span><span class="line"><span class="cl">rsi    0x7ffd30f0d1a0
</span></span><span class="line"><span class="cl">rbp    0x8347ce
</span></span><span class="line"><span class="cl">rsp    0x7ffd30f0d218
</span></span><span class="line"><span class="cl">r8     0x0
</span></span><span class="line"><span class="cl">r9     0x6
</span></span><span class="line"><span class="cl">r10    0x8
</span></span><span class="line"><span class="cl">r11    0x246
</span></span><span class="line"><span class="cl">r12    0x2bedc30
</span></span><span class="line"><span class="cl">r13    0xf1
</span></span><span class="line"><span class="cl">r14    0x11
</span></span><span class="line"><span class="cl">r15    0x0
</span></span><span class="line"><span class="cl">rip    0x6b657e
</span></span><span class="line"><span class="cl">rflags 0x246
</span></span><span class="line"><span class="cl">cs     0x33
</span></span><span class="line"><span class="cl">fs     0x0
</span></span><span class="line"><span class="cl">gs     0x0
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> failed: container_linux.go:348: starting container process caused <span class="s2">&#34;read init-p: connection reset by peer&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From the above, it is clear that the exception was returned by runc.</p>
<h4 id="locating-the-cause">Locating the cause</h4>
<p>While locating the exception component, runc also gives us a surprise: it provides a detailed exception log.</p>
<p>The exception log shows that runc exec failed because of <code>Resource temporarily unavailable</code>, which is a typical under-resource problem. The common types of insufficient resources include (ulimit -a)</p>
<ul>
<li>Thread limit reached</li>
<li>File limit reached</li>
<li>Memory limit is reached</li>
</ul>
<p>Therefore, we need to further troubleshoot the business container monitoring to locate the type of insufficient resources.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/14/3329e7bbcb6c4e60b19def4f742cb73b.png" alt="container monitoring"></p>
<p>The above figure shows the thread count monitoring of the business containers. The thread count of all containers has reached 1w, and the default limit of the Elastic Cloud is 1w. The reason for setting this limit is also to avoid single container thread leakage and exhausting the thread resources of the host.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># cat /sys/fs/cgroup/pids/kubepods/burstable/pod64a6c0e7-830c-11eb-86d6-b8cef604db88/aa1e331ec24f621ab3152ebe94f1e533734164af86c9df0f551eab2b1967ec4e/pids.max</span>
</span></span><span class="line"><span class="cl"><span class="m">10000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, the cause of the problem has been located clearly, and yes, it is that simple.</p>
<h3 id="runc-sorting">runc sorting</h3>
<p>Although we have located the cause of the exception log, we have only a vague idea of how runc works.</p>
<p>While we&rsquo;re at it, let&rsquo;s take runc exec as an example and sort out the workflow of runc.</p>
<ul>
<li>runc exec first starts the child process runc init</li>
<li>runc init is responsible for initializing the container namespace
<ul>
<li>runc init uses the constructor feature of C to set the container namespace before the go code starts</li>
<li>C code nsexec executes clone twice, three threads in total: parent process, child process, and grandchild process, to complete the initialization of container namespace</li>
<li>the parent process and the child process exit after completing the initialization task, at this time, the grandchild process is already in the container namespace, and the grandchild process starts to execute the go code initialization and waits to receive the runc exec to send the configuration</li>
</ul>
</li>
<li>runc exec adds the grand process to the container cgroup</li>
<li>runc exec sends configuration to the grand process, the configuration mainly contains: the specific commands and parameters of exec, etc.</li>
<li>Sun process calls system.Execv to execute user commands</li>
</ul>
<p>Notes.</p>
<ul>
<li>Step 2.c and step 3 are executed concurrently</li>
<li>runc exec and runc init communication is based on socket pair (init-p and init-c)</li>
</ul>
<p>The flow of interaction between the processes during runc exec and the initialization of namespace and cgroup is shown in the following figure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/14/f483e40eb0444e8c8df1eb6c37a53cfe.png" alt="Initialization of namespace and cgroup"></p>
<p>Combining our combing of the runc exec execution flow and the error messages returned by runc exec, we basically locate the code where runc exec returns an error.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">setnsProcess</span><span class="p">)</span> <span class="nf">start</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">parentPipe</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">p</span><span class="p">.</span><span class="nx">childPipe</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;starting setns process&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">bootstrapData</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">parentPipe</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">bootstrapData</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>       <span class="c1">// clone标志位，ns配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;copying bootstrap data to pipe&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">execSetns</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;executing setns process&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">cgroupPaths</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nf">EnterPid</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">cgroupPaths</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">pid</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>        <span class="c1">// 这里将runc init添加到容器cgroup中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">return</span> <span class="nf">newSystemErrorWithCausef</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;adding pid %d to cgroups&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">pid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">WriteJSON</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">parentPipe</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>            <span class="c1">// 发送配置：命令、环境变量等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nf">newSystemErrorWithCause</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;writing config to pipe&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">ierr</span> <span class="o">:=</span> <span class="nf">parseSync</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">parentPipe</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sync</span> <span class="o">*</span><span class="nx">syncT</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>                  <span class="c1">// 这里返回 read init-p: connection reset by peer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">switch</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nx">procReady</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// This shouldn&#39;t happen.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;unexpected procReady in setns&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nx">procHooks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// This shouldn&#39;t happen.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;unexpected procHooks in setns&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nf">newSystemError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid JSON payload from child&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">ierr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">p</span><span class="p">.</span><span class="nf">wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">ierr</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, the cause of the problem and the code analysis have all been completed.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/git-submodules/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Git Submodules</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/k8s-cgroupfs-or-syste/">
            <span class="next-text nav-default">K8s choose cgroupfs or systemd?</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
