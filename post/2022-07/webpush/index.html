<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>How WebPush works - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article basically covers the main content of WebPush and the related RFC standard, which should be useful for beginners to understand how WebPush works." /><meta name="keywords" content="WebPush" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/webpush/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="How WebPush works" />
<meta property="og:description" content="This article basically covers the main content of WebPush and the related RFC standard, which should be useful for beginners to understand how WebPush works." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/webpush/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-29T10:41:50+08:00" />
<meta property="article:modified_time" content="2022-07-29T10:41:50+08:00" />

<meta itemprop="name" content="How WebPush works">
<meta itemprop="description" content="This article basically covers the main content of WebPush and the related RFC standard, which should be useful for beginners to understand how WebPush works."><meta itemprop="datePublished" content="2022-07-29T10:41:50+08:00" />
<meta itemprop="dateModified" content="2022-07-29T10:41:50+08:00" />
<meta itemprop="wordCount" content="2275">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How WebPush works"/>
<meta name="twitter:description" content="This article basically covers the main content of WebPush and the related RFC standard, which should be useful for beginners to understand how WebPush works."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">How WebPush works</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-29 10:41:50 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2275 words </span>
          <span class="more-meta"> 11 mins read </span>
        
      </div>
    </header>

    
    <div class="post-content">
      <p>At this year&rsquo;s developer conference, Apple announced that Safari will <a href="https://webkit.org/blog/12945/meet-web-push/">support the WebPush standard</a>. The first support will be for the mac platform, which will be released this fall. Then it will be available for iOS in the first half of next year. By then, all major browsers will support WebPush features. This is a milestone for the Web! The Internet market is now desperately trying to promote mobile applications. One of the main reasons is that the retention rate of Web platform is very low, and the main reason for the low retention rate is the lack of push support. I hope the popularity of WebPush technology can promote the prosperity of the Web ecosystem. In order to do this, I&rsquo;ve put together a paper on how WebPush technology works today and share it with you. I&rsquo;d like to do my part.</p>
<p>Before we get into the details, we need to understand the entire technical architecture of WebPush.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">+-------+           +--------------+       +-------------+
</span></span><span class="line"><span class="cl">|  UA   |           | Push Service |       | Application |
</span></span><span class="line"><span class="cl">+-------+           +--------------+       |   Server    |
</span></span><span class="line"><span class="cl">    |                      |               +-------------+
</span></span><span class="line"><span class="cl">    |      Subscribe       |                      |
</span></span><span class="line"><span class="cl">    |---------------------&gt;|                      |
</span></span><span class="line"><span class="cl">    |       Monitor        |                      |
</span></span><span class="line"><span class="cl">    |&lt;====================&gt;|                      |
</span></span><span class="line"><span class="cl">    |          Distribute Push Resource           |
</span></span><span class="line"><span class="cl">    |--------------------------------------------&gt;|
</span></span><span class="line"><span class="cl">    :                      :                      :
</span></span><span class="line"><span class="cl">    |                      |     Push Message     |
</span></span><span class="line"><span class="cl">    |    Push Message      |&lt;---------------------|
</span></span><span class="line"><span class="cl">    |&lt;---------------------|                      |
</span></span></code></pre></td></tr></table>
</div>
</div><p>The UA here is the User Agent, that is, the browser; the Application Server is the application server, which can be simply understood as the server that actively sends push messages; the Push Service is the push service, whose core function is to maintain a long connection with the browser.</p>
<p>The push workflow is as follows.</p>
<ul>
<li>The web page requests push permission from the browser. At this point, the browser will show the corresponding interface to the user.</li>
<li>After the user agrees, the browser generates a set of subscription information and associates this subscription information with the application server that requested the push and sends it to the push service.</li>
<li>The web application sends the subscription information along with other information about the user to the application server for storage.</li>
<li>When a message needs to be pushed to the user, the application server constructs the data according to the specification and sends it to the push service.</li>
<li>The push service receives the message, does the necessary authentication, and then sends the message to the browser.</li>
<li>The browser receives the push and displays an alert message, and the user clicks on the push message to open the specified page or perform other operations.</li>
</ul>
<p>The whole process is very similar to mobile app push, but WebPush is different from mobile push in many ways.</p>
<p>The first difference is that WebPush does not require a registered developer account. Any website can send messages as long as the user agrees. The mobile app push must be registered with each vendor&rsquo;s developer account to work.</p>
<p>But will this design be abused? Definitely. That&rsquo;s why WebPush uses a VAPID protocol to tag senders. I&rsquo;ll explain more about this later. But VAPID is only used for tagging and does not require registration.</p>
<p>The second difference is that WebPush is very focused on protecting the privacy of its users, and WebPush uses encryption to ensure that the push service cannot see what is being pushed. That is, the messages pushed by the application server are encrypted and can only be decrypted by the browser. The push service only acts as a relay, it cannot see the actual content of the push.</p>
<p>It is because of these two features that WebPush is a complex technology. Let&rsquo;s discuss in detail how WebPush works.</p>
<p>Let&rsquo;s start with the VAPID protocol. The full name of VAPID is Voluntary Application Server Identification, and the full specification is defined in <a href="https://datatracker.ietf.org/doc/html/rfc8292">RFC8292</a>. VAPID is the public key of the elliptic curve cryptographic key pair that is generated on the server side if the network needs to request push permission. The elliptic curve is P-256, which is used by WebPush for all asymmetric encryption.</p>
<p>With the VAPID, you can request push permission from the browser. However, all push-related functions need to be performed in ServiceWorker, so the code is a bit more complicated.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">serviceWorker</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">ready</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">subscription</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">pushManager</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userVisibleOnly</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">applicationServerKey</span><span class="o">:</span> <span class="nx">pushServerPublicKey</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>userVisibleOnly</code> means that all pushes must show the notification screen. That means it has to be visible to the user and cannot be executed secretly in the background. All browsers currently require this field to be passed <code>true</code>.</p>
<p><code>applicationServerKey</code> is the server-generated VAPID, which is the elliptic curve public key.</p>
<p>If the user agrees to receive push messages, the browser will send the corresponding VAPID to the push server.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">POST /subscribe/ HTTP/1.1
</span></span><span class="line"><span class="cl">Host: push.example.net
</span></span><span class="line"><span class="cl">Content-Type: application/webpush-options+json
</span></span><span class="line"><span class="cl">Content-Length: 104
</span></span><span class="line"><span class="cl">{ &#34;vapid&#34;: &#34;BA1Hxzyi1RUM1b5wjxsn7nGxAszw2u61m164i3MrIxH
</span></span><span class="line"><span class="cl">            F6YK5h4SDYic-dRuU_RCPCfA5aq9ojSwk5Y2EmClBPs&#34; }
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the server pushes a message to the user, it calls the HTTP interface of the push service with the <code>Authorization</code> header.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">Authorization: vapid t=XXX, k=YYY
</span></span></code></pre></td></tr></table>
</div>
</div><p>vapid is a fixed prefix. The <code>t</code> is followed by a JWT token. Its signature algorithm is ES256, which means that the digest value is calculated using SHA-256 and the signature is made using a P-256 elliptic curve. there are three mandatory fields for JWT as follows.</p>
<ul>
<li><code>aud</code> the domain name of the push service, e.g. <code>https://push.example.net</code></li>
<li><code>exp</code> Expiration timestamp</li>
<li><code>sub</code> contact information of the pushing party, either mailto: email address, or https link</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">JWT</span> <span class="err">header</span> <span class="err">=</span> <span class="p">{</span> <span class="nt">&#34;typ&#34;</span><span class="p">:</span> <span class="s2">&#34;JWT&#34;</span><span class="p">,</span> <span class="nt">&#34;alg&#34;</span><span class="p">:</span> <span class="s2">&#34;ES256&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">JWT</span> <span class="err">body</span> <span class="err">=</span> <span class="p">{</span> <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;https://push.example.net&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1453523768</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;mailto:push@example.com&#34;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because it uses P-256 elliptic curve signatures, it also needs to be accompanied by the signed public key. It is the part that corresponds to the <code>k</code> field. Here the public key is converted to X9.62 format and then base64 transcoded to obtain it.</p>
<p>Since the push service saves the VAPID of the application server in advance, it can determine whether it is a legitimate caller based on the <code>k</code> field. On the other hand, the JWT of the <code>k</code> field provides information such as expiration time and contact information. If the push service thinks the application server is behaving abnormally, it can notify the pushing party via the contact information of the JWT. This completes the identification of the pushing party.</p>
<p>However, we should see that this is only a limited identification. The push service can only disable a VAPID, not the actual service. However, once a VAPID is disabled, all the push messages associated with it will be disabled. This is enough to deter pushers from doing evil.</p>
<p>The above is the server identification part. Next we talk about the encryption part.</p>
<p>We got the <code>subscription</code> object in the previous code, and after converting it to JSON, the structure is as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;https://updates.push.services.mozilla.com/wpush/v2/XXX&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;expirationTime&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="s2">&#34;AAA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;p256dh&#34;</span><span class="p">:</span> <span class="s2">&#34;BBB&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>endpoint</code> indicates the link to be pushed. The browser generates a different push link for each user of each website. The application server needs to save this link with the user&rsquo;s correspondence for use in the push. <code>expirationTime</code> indicates the expiration time of the push message, which means that the user can allow the server to send the push for a period of time. The target all browsers do not support this feature.</p>
<p>The <code>auth</code> in <code>keys</code> is a browser-generated random sequence of 16 bytes in length. It is stored in base64 encoding. It is a browser-generated authentication password for the server, and is used with <code>endpoint</code>.</p>
<p><code>p256dh</code> in <code>keys</code> is another public key pair of P-256 keys. It is used to exchange message encryption keys with the application server.</p>
<p>The web application needs to send the subscription information to the server for storage after obtaining it.</p>
<p>The server-side encryption process is as follows.</p>
<ol>
<li>generate a random 16-bit salt value</li>
<li>temporarily generate a set of elliptic curve keys (as_private, as_public)</li>
<li>negotiate the public key with the browser&rsquo;s public key using its own private key ecdh_secret = ECDH(as_private, ua_public)</li>
<li>use the HMAC-based key derivation function (HKDF) to compute the actual key for encryption.</li>
</ol>
<p>WebPush uses the HMAC-SHA-256 algorithm.</p>
<p>First calculate the Input-keying material (IKM) key.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">PRK_key</span> <span class="o">=</span> <span class="nx">HMAC</span><span class="o">-</span><span class="nx">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">(</span><span class="nx">auth_secret</span><span class="p">,</span> <span class="nx">ecdh_secret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">key_info</span> <span class="o">=</span> <span class="s2">&#34;WebPush: info&#34;</span> <span class="o">||</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="nx">ua_public</span> <span class="o">||</span> <span class="nx">as_public</span>
</span></span><span class="line"><span class="cl"><span class="nx">IKM</span> <span class="o">=</span> <span class="nx">HMAC</span><span class="o">-</span><span class="nx">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">(</span><span class="nx">PRK_key</span><span class="p">,</span> <span class="nx">key_info</span> <span class="o">||</span> <span class="mh">0x01</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here <code>||</code> indicates that the contents of both sides are joined into a whole, same below.</p>
<p>The content encryption key (CEK) is then calculated as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">PRK</span> <span class="o">=</span> <span class="nx">HMAC</span><span class="o">-</span><span class="nx">SHA</span><span class="o">-</span><span class="mi">256</span> <span class="p">(</span><span class="nx">salt</span><span class="p">,</span> <span class="nx">IKM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">cek_info</span> <span class="o">=</span> <span class="s2">&#34;Content-Encoding: aes128gcm&#34;</span> <span class="o">||</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="nx">CEK</span> <span class="o">=</span> <span class="nx">HMAC</span><span class="o">-</span><span class="nx">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">(</span><span class="nx">PRK</span><span class="p">,</span> <span class="nx">cek_info</span> <span class="o">||</span> <span class="mh">0x01</span><span class="p">)[</span><span class="mf">0.</span><span class="p">.</span><span class="mi">15</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, calculate the Nonce key.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">nonce_info</span> <span class="o">=</span> <span class="s2">&#34;Content-Encoding: nonce&#34;</span> <span class="o">||</span> <span class="mh">0x00</span>
</span></span><span class="line"><span class="cl"><span class="nx">NONCE</span> <span class="o">=</span> <span class="nx">HMAC</span><span class="o">-</span><span class="nx">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p">(</span><span class="nx">PRK</span><span class="p">,</span> <span class="nx">nonce_info</span> <span class="o">||</span> <span class="mh">0x01</span><span class="p">)[</span><span class="mf">0.</span><span class="p">.</span><span class="mi">11</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Please refer to <a href="https://datatracker.ietf.org/doc/html/rfc8291">RFC8291</a> for the detailed procedure of key generation.</p>
<p>With CEK and Nonce we can encrypt the message content.</p>
<p>HTTPS can only guarantee that the communication from the application server to the push server is not eavesdropped. When the push server receives the data, it decrypts it and can read all the information. Obviously HTTPS alone does not enable the encryption capabilities of WebPush. For this reason, WebPush uses the encrypted transport encoding defined in <a href="https://datatracker.ietf.org/doc/html/rfc8188">RFC8188</a>.</p>
<p>The HTTP protocol defines a variety of <code>Content-Encoding</code>, the most common being gzip, which means that the transmitted content has been compressed. <code>rfc8188</code> defines a new type called <code>aes128gcm</code>, which means that the transmitted content has been encrypted using <code>AEAD_AES_128_GCM</code>.</p>
<p>Data of type <code>aes128gcm</code> has specific headers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">+-----------+--------+-----------+---------------+
</span></span><span class="line"><span class="cl">| salt (16) | rs (4) | idlen (1) | keyid (idlen) |
</span></span><span class="line"><span class="cl">+-----------+--------+-----------+---------------+
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>salt is a sixteen-byte value for the salt used for encryption, generated by the application server</li>
<li>rs full record size, the length of AES segment encryption</li>
<li>idlen indicates the length of the keyid that follows, up to 255 bytes</li>
<li>keyid denotes the key identifier for aes128gcm encryption</li>
</ul>
<p>After the header information, the encrypted data.</p>
<p>aes128gcm encryption requires specifying the group length, each group is numbered from zero, and a different Nonce needs to be calculated, but WebPush messages are shorter, not more than 4096 bytes. However, WebPush messages are shorter than 4096 bytes, so only one group is needed, and the group number is not considered when calculating the first Nonce.</p>
<p>Also, AES is symmetric encryption, so obviously the key cannot be stored in the keyid field. What is really saved here is the public key as_public of the temporary elliptic key pair generated by the application server.</p>
<p>The server finally encrypts the push message with CEK and Nonce using the AEAD_AES_128_GCM algorithm and finally sends the following HTTP request to the push service.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">POST /push/JzLQ3raZJfFBR0aqvOMsLrt54w4rJUsV HTTP/1.1
</span></span><span class="line"><span class="cl">Host: push.example.net
</span></span><span class="line"><span class="cl">Content-Length: 145
</span></span><span class="line"><span class="cl">Content-Encoding: aes128gcm
</span></span><span class="line"><span class="cl">Authorization: vapid t=${JWT}, k=${JWK}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">${binayr-header}${encrypted-data}
</span></span></code></pre></td></tr></table>
</div>
</div><p>The entire process of server-side subscription is encapsulated in a tool library that you can use directly. there is a <a href="https://github.com/web-push-libs">WebPush libraries</a> organization on GitHub that provides SDKs in multiple languages.</p>
<p>Take nodejs for example, and use it as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">webpush</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;web-push&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">vapidKeys</span> <span class="o">=</span> <span class="nx">webpush</span><span class="p">.</span><span class="nx">generateVAPIDKeys</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">webpush</span><span class="p">.</span><span class="nx">setVapidDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;mailto:example@yourdomain.org&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">vapidKeys</span><span class="p">.</span><span class="nx">publicKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">vapidKeys</span><span class="p">.</span><span class="nx">privateKey</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">pushSubscription</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">endpoint</span><span class="o">:</span> <span class="s1">&#39;.....&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">keys</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">auth</span><span class="o">:</span> <span class="s1">&#39;.....&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p256dh</span><span class="o">:</span> <span class="s1">&#39;.....&#39;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">webpush</span><span class="p">.</span><span class="nx">sendNotification</span><span class="p">(</span><span class="nx">pushSubscription</span><span class="p">,</span> <span class="s1">&#39;Your Push Payload Text&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The browser receives the push message and generates a public key with its own private key and keyid.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">ecdh_secret</span> <span class="o">=</span> <span class="nx">ECDH</span><span class="p">(</span><span class="nx">ua_private</span><span class="p">,</span> <span class="nx">as_public</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// In other words
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">ecdh_secret</span> <span class="o">==</span> <span class="nx">ECDH</span><span class="p">(</span><span class="nx">as_private</span><span class="p">,</span> <span class="nx">ua_public</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The key negotiation is done without exposing the private key of each party. Once the public key is obtained, the browser can repeat the application server computation process to obtain CEK and Nonce, and finally decrypt it using the aes128gcm algorithm.</p>
<p>For those readers who are interested, do you have any format requirements for the data pushed from the server to the browser? The answer is no. Because the browser will not process the decrypted push message itself, but will trigger the <code>push</code> event of the serviceWorker. So websites that want users to receive pushes also need to register their own serviceWorker to handle the push messages.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// register serviceWorker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s2">&#34;/sw.js&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// sw.js 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">receivePushNotification</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">text</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="nx">title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="o">:</span> <span class="nx">text</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">registration</span><span class="p">.</span><span class="nx">showNotification</span><span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">options</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">openPushNotification</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">event</span><span class="p">.</span><span class="nx">notification</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span><span class="nx">clients</span><span class="p">.</span><span class="nx">openWindow</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">notification</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;push&#34;</span><span class="p">,</span> <span class="nx">receivePushNotification</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;notificationclick&#34;</span><span class="p">,</span> <span class="nx">openPushNotification</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The browser receives the push and calls the <code>receivePushNotification</code> function. We need to resolve the push data in this function, extract the required fields, and then call the <code>showNotification</code> function to display the push message. Note that you must use <code>event.waitUntil</code> here to wait for <code>showNotification</code> to return, otherwise there will be some messy problems. When the user shows the message notification the browser will fire the <code>notificationclick</code> event again and then execute the <code>openPushNotification</code> function.</p>
<p>The <code>showNotification</code> function has many parameters, you can refer to <a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification">MDN</a>. Different parameters are supported differently in different browsers and platforms, so you can choose them as you need.</p>
<p>The above is the main content of this article. This article basically covers the main content of WebPush and the related RFC standards. It should be useful for beginners to understand how WebPush works. However, due to the limitation of space, it is not possible to make detailed comments on the various encryption algorithms mentioned in this article, which is a pity. I will consider to write some special articles to introduce them later.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/k8s-p1-yaml/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kubernetes Resource Orchestration Series Part 1: Pod YAML</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/golang-performance/">
            <span class="next-text nav-default">Golang High Performance Programming Manual</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
