<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Several strategies for implementing load balancing - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore several strategies for implementing load balancing, as well as the usage scenarios and advantages and disadvantages of each strategy." /><meta name="keywords" content="Load Balancing, Strategies" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/strategies-load-balancing/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Several strategies for implementing load balancing" />
<meta property="og:description" content="Explore several strategies for implementing load balancing, as well as the usage scenarios and advantages and disadvantages of each strategy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/strategies-load-balancing/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-22T10:40:51+08:00" />
<meta property="article:modified_time" content="2022-07-22T10:40:51+08:00" />

<meta itemprop="name" content="Several strategies for implementing load balancing">
<meta itemprop="description" content="Explore several strategies for implementing load balancing, as well as the usage scenarios and advantages and disadvantages of each strategy."><meta itemprop="datePublished" content="2022-07-22T10:40:51+08:00" />
<meta itemprop="dateModified" content="2022-07-22T10:40:51+08:00" />
<meta itemprop="wordCount" content="1222">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Several strategies for implementing load balancing"/>
<meta name="twitter:description" content="Explore several strategies for implementing load balancing, as well as the usage scenarios and advantages and disadvantages of each strategy."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Several strategies for implementing load balancing</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-22 10:40:51 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 1222 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#random">Random</a></li>
        <li><a href="#polling">Polling</a></li>
        <li><a href="#directed-distribution">Directed Distribution</a></li>
        <li><a href="#heartbeat-detection">Heartbeat Detection</a></li>
        <li><a href="#consistent-hashing">Consistent Hashing</a></li>
        <li><a href="#nginxs-load-balancing-strategy">Nginx&rsquo;s Load Balancing Strategy</a></li>
        <li><a href="#srv-records">SRV records</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Consider the scenario, an API gateway that distributes requests to multiple upstream nodes, as in the upstream configuration of nginx.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">upstream</span> <span class="s">backend</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="s">a1.com</span> <span class="s">weight=5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="s">a2.com</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="s">a3.com</span> <span class="s">backup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="s">a4.com</span> <span class="s">backup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://backend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are many common practices on how to distribute the routes <code>/</code> equally to the four services, in general, such as randomized algorithms, etc.</p>
<h2 id="random">Random</h2>
<p>Treat each node as an element of an array, and for each request calculate a random number, e.g. calculate a random number from 1-4 and take the modulus, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">hosts</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;a1.com&#34;</span><span class="p">,</span><span class="s">&#34;a2.com&#34;</span><span class="p">,</span><span class="s">&#34;a3.com&#34;</span><span class="p">,</span><span class="s">&#34;a4.com&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">x</span> <span class="o">:=</span> <span class="nf">random</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">proxyPass</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we directly take <code>hosts[x]</code> as the object of the distribution request. Therefore, we only need to ensure that this random algorithm is random enough to achieve balanced distribution.</p>
<h2 id="polling">Polling</h2>
<p>In addition to random, polling can be used to achieve random assignment, e.g.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">hosts</span> <span class="o">:=</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;a1.com&#34;</span><span class="p">,</span><span class="s">&#34;a2.com&#34;</span><span class="p">,</span><span class="s">&#34;a3.com&#34;</span><span class="p">,</span><span class="s">&#34;a4.com&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">cursor</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cursor</span> <span class="o">++</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">proxyPass</span><span class="p">(</span><span class="nx">hosts</span><span class="p">[</span><span class="nx">cursor</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">hosts</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This approach maintains a cursor that points to which node was last hit, and then sequentially polls the next node in the array.</p>
<h2 id="directed-distribution">Directed Distribution</h2>
<p>Some scenarios, requests for the same IP (or other fields) need to be forwarded to the same node, this way an IP needs to be transformed into a number and mapped to an array subscript, like this scenario, a crc32 algorithm can be used to map a string to a number and then modulo that number.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">hosts</span> <span class="o">:=</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;a1.com&#34;</span><span class="p">,</span><span class="s">&#34;a2.com&#34;</span><span class="p">,</span><span class="s">&#34;a3.com&#34;</span><span class="p">,</span><span class="s">&#34;a4.com&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">x</span> <span class="o">:=</span> <span class="nf">crc32</span><span class="p">(</span><span class="nx">ip</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">proxyPass</span><span class="p">(</span><span class="nx">hosts</span><span class="p">[</span><span class="nx">x</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we consider that each IP access is random in terms of data distribution, then this approach can be used to implement the LB function.</p>
<p>All of these methods above are relatively common and easy to think of solutions. Based on these balancing strategies, some more business-friendly variants, such as weighting, can also be implemented. In ordinary business scenarios, these methods should be sufficient to meet business needs. The only problem that may arise is that if a node goes down during a process, this situation will cause a portion of the requests to still be forwarded to the failed node. To solve this problem, the mechanism of live detection has emerged.</p>
<h2 id="heartbeat-detection">Heartbeat Detection</h2>
<p>To ensure service availability, a heartbeat detection mechanism from LB to node can be maintained, with each node providing an interface. For example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Alive</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="s">&#34;ok&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then LB accesses this interface every time, say 10ms, and the service is considered normal only if it returns normally, and when the service is abnormal, it needs to be removed from the hosts list. In this way, combined with the several load balancing strategies mentioned above, it greatly increases the service availability when the node hangs. All of the above, however, are solutions for stateless services.</p>
<p>For a stateful service, such as ws long connection service, data storage service, etc., then such node downtime will lead to data loss. Therefore, it is necessary to do data synchronization when the node of a stateful service has a problem. And if we use the above random algorithm approach, we have to recalculate the original data and land on the remaining nodes, this kind of performance may not be guaranteed for a large distributed system, so another strategy of data synchronization needs to be improved, such as consistent hashing.</p>
<h2 id="consistent-hashing">Consistent Hashing</h2>
<p>First, first define as a ring data structure, such as an array or LinkedList, and here assume a ring array with 16 elements.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">VNode</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">idx</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">server</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">nodes</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Vnode</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="p">&lt;</span><span class="mi">16</span><span class="p">;</span><span class="mi">1</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span><span class="o">&amp;</span><span class="nx">VNode</span><span class="p">{</span><span class="nx">idx</span><span class="p">:</span><span class="nx">i</span><span class="p">,</span><span class="nx">server</span><span class="p">:</span><span class="s">&#34;&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, bind specific Host and Vnode nodes, such as binding the following nodes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">initVNode</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a1.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a2.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a3.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a4.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When a request comes through, we get a number based on a random number, or IP, or other field that can be identified. For example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">(Assumptions ) vNodeId = crc32(request_id) % 16 = 3
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, find the first node with binding from the ring array according to clockwise (counterclockwise is also possible) and use it as the node for load balancing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">FindService</span><span class="p">(</span><span class="nx">vNodeId</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span><span class="o">:=</span><span class="nx">vNodeId</span><span class="p">;</span><span class="nx">i</span><span class="p">&lt;</span><span class="nx">vNodeId</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">].</span><span class="nx">server</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">].</span><span class="nx">server</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When a node in the system hangs, it is necessary to do data migration, at this time, assuming that a3.com is down, it is only necessary to transfer all the data of the original a3.com to <code>a4.com</code>, which means that all the data of the original <code>a3.com</code> is transferred to <code>a4.com</code>. This process only involves moving from <code>a3.com</code> to <code>a4.com</code>, other nodes are not affected. However, if this is a simple forward transfer, it is found that the data is not evenly distributed and <code>a4.com</code> directly carries <code>50%</code> of the data, so to improve it, the distribution of physical nodes to multiple nodes on the ring can be used.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">initVNode</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a1.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a2.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a2.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a3.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a3.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">12</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a4.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nodes</span><span class="p">[</span><span class="mi">14</span><span class="p">].</span><span class="nx">server</span> <span class="p">=</span> <span class="s">&#34;a4.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This way, when nodes are migrated, they can be spread more evenly to the remaining nodes. Of course, consistent hashing is designed to minimize the cost of data synchronization and recovery when a node hangs in a distributed environment, thus improving overall high availability.</p>
<h2 id="nginxs-load-balancing-strategy">Nginx&rsquo;s Load Balancing Strategy</h2>
<p>Nginx implements several load balancing strategies, such as polling, which polls each node according to request time and automatically listens to keep it alive.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">upstream</span> <span class="s">backserver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="mi">10</span><span class="s">.0.2.16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="mi">10</span><span class="s">.0.2.17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Weighted assignments can also be specified to request the corresponding nodes in proportion to their weights.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">upstream</span> <span class="s">backserver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="mi">10</span><span class="s">.0.2.16</span> <span class="s">weight=3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="mi">10</span><span class="s">.0.2.17</span> <span class="s">weight=7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It can also be distributed in a targeted manner, such as <code>ip_hash</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">upstream</span> <span class="s">backserver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">ip_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="mi">10</span><span class="s">.0.2.16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="mi">10</span><span class="s">.0.2.17</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="srv-records">SRV records</h2>
<p>SRV is a type of DNS record that supports load balancing on DNS resolution. SRV supports specifying IP, port, and weight information on the record, so it can also be used for cluster load balancing.</p>
<blockquote>
<p>The DNS &ldquo;service&rdquo; (SRV) record specifies a host and port for specific services such as voice over IP (VoIP), instant messaging, and so on. Most other DNS record only specify a server or an IP address, but SRV records include a port at that IP address as well. Some Internet protocols require the use of SRV records in order to function.</p>
</blockquote>
<p>An SRV record has the following format.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">format: Service type. Transport protocol. Host/Domain TTL IN/OUT SRV Priority Weight Target Port Target Host/Target Domain
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">example:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">_xmpp._tcp.example.com. 86400 IN SRV 10 5 5223 server0.example.com.
</span></span><span class="line"><span class="cl">_xmpp._tcp.example.com. 86400 IN SRV 10 4 5224 server1.example.com.
</span></span></code></pre></td></tr></table>
</div>
</div><p>That is, if you visit <code>example.com</code>, it will resolve to the target port of the target domain by weight and priority.</p>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/go-timer/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">In-depth understanding of the Golang timer implementation principle</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-splice-strings/">
            <span class="next-text nav-default">Several ways to splice strings in Golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
