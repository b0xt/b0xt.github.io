<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Cloud Native Declarative Database Structure Migration Tool - SchemaHero - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn SchemaHero, a cloud-native declarative database structure migration tool ." /><meta name="keywords" content="Schemahero" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/schemahero/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Cloud Native Declarative Database Structure Migration Tool - SchemaHero" />
<meta property="og:description" content="Learn SchemaHero, a cloud-native declarative database structure migration tool ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/schemahero/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-26T12:24:21+08:00" />
<meta property="article:modified_time" content="2022-07-26T12:24:21+08:00" />

<meta itemprop="name" content="Cloud Native Declarative Database Structure Migration Tool - SchemaHero">
<meta itemprop="description" content="Learn SchemaHero, a cloud-native declarative database structure migration tool ."><meta itemprop="datePublished" content="2022-07-26T12:24:21+08:00" />
<meta itemprop="dateModified" content="2022-07-26T12:24:21+08:00" />
<meta itemprop="wordCount" content="2537">
<meta itemprop="keywords" content="Cloud-Native," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cloud Native Declarative Database Structure Migration Tool - SchemaHero"/>
<meta name="twitter:description" content="Learn SchemaHero, a cloud-native declarative database structure migration tool ."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Cloud Native Declarative Database Structure Migration Tool - SchemaHero</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-26 12:24:21 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2537 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#declarative-models">Declarative Models</a></li>
        <li><a href="#data-migration">Data Migration</a></li>
        <li><a href="#useage">Useage</a>
          <ul>
            <li><a href="#install-schemahero">Install SchemaHero</a></li>
            <li><a href="#install-kubectl-plugin">Install kubectl plugin</a></li>
            <li><a href="#install-the-components-in-the-cluster">Install the components in the cluster</a></li>
            <li><a href="#connecting-to-the-database">Connecting to the database</a></li>
            <li><a href="#new-table-creation">New table creation</a></li>
            <li><a href="#modifying-a-table">Modifying a table</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><a href="https://github.com/schemahero/schemahero">SchemaHero</a> is an open source declarative database schema migration cloud-native tool that converts schema definitions into migration scripts that can be applied in any environment. Written as a CLI tool and Kubernetes Operator, SchemaHero eliminates the task of creating and managing sequential migration scripts that are compatible with all environments in which applications are running.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/6a33068382bf4a08b7b97a7ab2e8e9e3.png" alt="SchemaHero"></p>
<p>Many database schema management tools create an imperative interface that requires the developer to know the current state of the schema and the relevant commands to migrate the current schema (and associated data) to the new schema. <code>SchemaHero</code> proposes a declarative interface approach to replace the traditional imperative interface.</p>
<h2 id="declarative-models">Declarative Models</h2>
<p>Managing database schema in a declarative manner has the following benefits.</p>
<ol>
<li>the ability to comply with change management processes</li>
<li>repeatable deployment to new environments</li>
<li>compatibility with new runtimes</li>
</ol>
<p>In a declarative model, only the current state of the schema is defined and the declarative schema manager takes care of the commands needed to migrate the schema from any previous state to the desired state. The advantage of storing only the current state is that when a new environment or instance is created, the previously used database extensions, tables, and other data will not be needed.</p>
<p>Traditional database engines receive schema changes through a subset of SQL statements called <code>DDL</code> (Data Definition Language). Developers do not need to understand the differences between DDLs for each database engine they target; conversion from a uniform declarative model to the appropriate DDL commands can be handled programmatically, depending on the capabilities and state of the database.</p>
<p>When a declarative schema is used to define database schema management, it is possible to validate the schema against a set of policies before it is applied. This is not easy to do with imperative tools that only store migration scripts. With all the available state needed, database schema can be evaluated against a set of rules to ensure that policies and best practices are implemented.</p>
<h2 id="data-migration">Data Migration</h2>
<p>There are two types of migrations that need to be managed and deployed.</p>
<ol>
<li>Schema migration</li>
<li>Data Migration</li>
</ol>
<p><strong>Schema migrations</strong> can be used to represent in SQL syntax and change the structure of the database. These are often some new tables, column changes, changes to index data, etc. These are commonly written and can always be expressed in idempotent syntax. Different database engines enforce different rules on how to apply these rules. For example, MySQL does not allow schema migration to be performed in a transaction, while Postgres does. schema management is often unique to the way databases are managed, while <code>SchemaHero</code> focuses on handling schema migration.</p>
<p>Less commonly, developers must migrate some data to a new format in the database. This may involve calculating a new column and writing it, or creating new values in code and inserting them into them. Many traditional database management tools combine the tasks of shema migration and data migration into one tool.</p>
<blockquote>
<p><code>SchemaHero</code> is currently focused on schema migration and plans to support data migration in the future.</p>
</blockquote>
<h2 id="useage">Useage</h2>
<p>Next we will deploy <code>SchemaHero</code> and a sample database that will design a very basic database for a virtual airline reservation system and deploy it to PostgreSQL.</p>
<p>At first we will deploy an empty database, create an initial schema, and then modify that schema so that it ends up with the following table structure.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/2d249bc83fa84b7da8c30ae225f4ab88.png" alt="table"></p>
<h3 id="install-schemahero">Install SchemaHero</h3>
<h3 id="install-kubectl-plugin">Install kubectl plugin</h3>
<p>The <code>SchemaHero</code> client component is packaged as a kubectl plugin and distributed through the <code>krew</code> package manager, so first we need to install krew first. After installing krew, use the following command to install the <code>SchemaHero</code> client.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl krew install schemahero
</span></span></code></pre></td></tr></table>
</div>
</div><p>After installation, you can use the following command to verify if the installation is successful.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero version
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normally you will see the installed version of SchemaHero (<code>0.12.1</code> or similar).</p>
<h3 id="install-the-components-in-the-cluster">Install the components in the cluster</h3>
<p>Once the kubectl plugin is installed, we can install the <code>SchemaHero</code> components in the Kubernetes cluster with a single click using the following command</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero install
</span></span></code></pre></td></tr></table>
</div>
</div><p>This command will create a namespace named <code>schemahero-system</code> and deploy a <code>SchemaHero operator</code>. You can confirm that <code>SchemaHero</code> is installed by executing the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl get pods -n schemahero-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>Normally you should see 1 pod running and the output will look something like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">NAME           READY   STATUS    RESTARTS   AGE 
</span></span><span class="line"><span class="cl">schemahero-0   1/1     Running   <span class="m">0</span>          38s
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once the client and cluster components have been installed, we can go ahead and connect to the database.</p>
<h3 id="connecting-to-the-database">Connecting to the database</h3>
<p>Next we need to deploy a PostgreSQL instance and then configure <code>SchemaHero</code> to manage that database instance.</p>
<p>For convenience, I&rsquo;ll add the rendered YAML file of PostgreSQL&rsquo;s Helm Chart template directly to the SchemaHero code repository here, which we deploy to a namespace called <code>schemahero-tutorial</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl create ns schemahero-tutorial 
</span></span><span class="line"><span class="cl">$ kubectl apply -n schemahero-tutorial -f https://raw.githubusercontent.com/schemahero/schemahero/main/examples/tutorial/postgresql/postgresql-11.8.0.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once PostgreSQL is deployed, we can use the following command to connect to that database instance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it -n schemahero-tutorial <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  postgresql-0 -- psql -U airlinedb-user -d airlinedb
</span></span></code></pre></td></tr></table>
</div>
</div><p>The password for <code>airlinedb-user</code> is <code>password</code>.</p>
<p>Here we use Beekeeper Studio, the database management tool we described earlier, to manage the database instance.</p>
<p>By default, the PostgreSQL instance we deployed above is not accessible outside the cluster, so we can use kubectl to create a port forwarding to expose the database instance.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl port-forward -n schemahero-tutorial svc/postgresql 5432:5432
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we can connect to the database <code>127.0.0.01:5432</code> using the user <code>airlinedb-user</code>, the database <code>airlinedb</code> and the password <code>password</code>.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/af69f376a3ff4268a7612a42a44bb027.png" alt="connect to the database"></p>
<p>After connecting, you can see that the database is still empty now.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/d272c48107304b2a9cd6d2fa1bc44273.png" alt="database is still empty"></p>
<p>Now that we have <code>SchemaHero</code> and a PostgreSQL instance running in the cluster, we can next provide database information to <code>SchemaHero</code> so that we can manage that database. We can do this by using connection information to deploy custom resources to the cluster.</p>
<p>The <code>database</code> object allows <code>SchemaHero</code> to manage the schema of the database, which is defined in <code>database</code> and includes the name type and connection parameters. Here we create a file named <code>airline-db.yaml</code> with the following contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">databases.schemahero.io/v1alpha4 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Database </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">airlinedb </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">schemahero-tutorial </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postgres</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">uri</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">postgresql </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">uri</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>Database</code> defined above is a CRD object defined by <code>Schemahero</code>, here we are referencing an authentication data from the previous PostgreSQL deployment via a <code>secretKeyRef</code>, SchemaHero supports reading credentials from inline, secrets or HashiCorp Vault to read the credentials.</p>
<p>Just apply the resource object above directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f airline-db.yaml
</span></span><span class="line"><span class="cl">$ kubectl get databases -n schemahero-tutorial 
</span></span><span class="line"><span class="cl">NAME AGE 
</span></span><span class="line"><span class="cl">airlinedb 47m
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now that we can manage our PostgreSQL instance with <code>SchemaHero</code>, we&rsquo;ll use <code>SchemaHero</code> to deploy a new table to this instance.</p>
<h3 id="new-table-creation">New table creation</h3>
<p>In this step, we will deploy several tables to the <code>airlinesdb</code> database created earlier. While performing this operation, we will perform an approval and rejection workflow in <code>SchemaHero</code> to understand how to validate these changes before they are implemented.</p>
<p>First we define a simple <code>airports</code> table and then use it in our data model when defining routes. In this table we define only 2 columns to represent the airport code and name.</p>
<p>Before using <code>SchemaHero</code> we may write SQL statements as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">airport</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And now that we have <code>SchemaHero</code>, we don&rsquo;t need to write SQL statements, we just need to create a <code>Table</code> custom object for <code>SchemaHero</code>.</p>
<p>Create a resource list file called <code>airport-table.yaml</code>, as follows.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">schemas.schemahero.io/v1alpha4 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Table </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">airport </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">schemahero-tutorial </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l">airlinedb </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">airport </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schema</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postgres</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">code] </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">columns</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">code </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">char(4) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">name </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">varchar(255) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>where <code>spec.database</code> is used to associate the <code>database</code> object defined earlier, <code>spec.name</code> is the name of the real data table in the Postgres database, and then the table structure is defined in <code>spec.schema</code>, <code>primaryKey</code> can be used to specify the primary key, and <code>columns</code> defines the data table&rsquo;s column definitions.</p>
<p>Again, just apply the resource object directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f airport-table.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note that although we deploy a <code>table</code> object, the table structure does not automatically change. Instead, a new (or edited) <code>table</code> object will generate a <code>migration</code> object that can check and then approve or reject the change. By default, <code>SchemaHero</code> requires an approval process because some database structure migrations can be disruptive, and immediate deployment (without approval) can be enabled by adding properties to the <code>database</code> object.</p>
<p>We can see the migrated objects in the <code>pending</code> state with the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero get migrations -n schemahero-tutorial
</span></span><span class="line"><span class="cl">ID      DATABASE   TABLE     PLANNED EXECUTED APPROVED REJECTED 
</span></span><span class="line"><span class="cl">eaa36ef airlinedb  airport   11s
</span></span></code></pre></td></tr></table>
</div>
</div><p>If no resource is found, wait a few seconds and retry. The SchemaHero Operator must complete the <code>plan</code> phase before <code>migration</code> is available.</p>
<p>Before approving this migration, we can look at the SQL statements generated by attaching to the <code>migration</code> object. Get the ID from the output of the previous command and run <code>describe migration</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero describe migration eaa36ef -n schemahero-tutorial
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Migration Name: eaa36ef 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Generated DDL Statement <span class="o">(</span>generated at 2020-06-06T10:41:04-07:00<span class="o">)</span>: 
</span></span><span class="line"><span class="cl">  create table <span class="s2">&#34;airport&#34;</span> <span class="o">(</span><span class="s2">&#34;code&#34;</span> character <span class="o">(</span>4<span class="o">)</span>, <span class="s2">&#34;name&#34;</span> character varying <span class="o">(</span>255<span class="o">)</span> not null, primary key <span class="o">(</span><span class="s2">&#34;code&#34;</span><span class="o">))</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To apply this migration: 
</span></span><span class="line"><span class="cl">  kubectl schemahero -n schemahero-tutorial approve migration eaa36ef 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To recalculate this migration against the current schema: 
</span></span><span class="line"><span class="cl">  kubectl schemahero -n schemahero-tutorial recalculate migration eaa36ef 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To deny and cancel this migration: 
</span></span><span class="line"><span class="cl">  kubectl schemahero -n schemahero-tutorial reject migration eaa36ef
</span></span></code></pre></td></tr></table>
</div>
</div><p>At the top of the output, the generated DDL statement is the planned migration, and this is the exact SQL statement that <code>SchemaHero</code> will run to apply this migration.</p>
<p>Later on, <code>SchemaHero</code> provides 3 commands for subsequent steps.</p>
<ul>
<li><code>apply</code>: Running this command will accept the SQL statement and <code>SchemaHero</code> will execute it against the database.</li>
<li><code>recalculate</code>: running this command will instruct <code>SchemaHero</code> to discard the generated SQL statements and generate them again. This is useful if the database structure has changed and you want <code>SchemaHero</code> to re-execute the plan.</li>
<li><code>reject</code>: Running this command will reject the migration and not execute it.</li>
</ul>
<p>For example, we can see here that the current migration is safe and meets expectations, and we can then approve the migration so that <code>SchemaHero</code> can execute the plan by executing the following command.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero -n schemahero-tutorial approve migration eaa36ef
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Migration eaa36ef approved
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can run <code>get migrations</code> again to see the status of the migration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero get migrations -n schemahero-tutorial
</span></span><span class="line"><span class="cl">ID       DATABASE   TABLE    PLANNED  EXECUTED  APPROVED  REJECTED
</span></span><span class="line"><span class="cl">eaa36ef  airlinedb  airport  9m38s    38s       52s
</span></span></code></pre></td></tr></table>
</div>
</div><p>The message above shows that the migration was scheduled 9 minutes and 38 seconds ago, approved 52 seconds ago, and executed 38 seconds ago.</p>
<p>Now we click on the Refresh button on the <code>Tables &amp; Views</code> heading in the left navigation in the Beekeeper Studio tool and normally we can now see the <code>airport</code> table under <code>public</code> and click on it to see the column data in the table.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/dd50e35cc3494bd4a6806cd2f50e3f6d.png" alt="table"></p>
<h3 id="modifying-a-table">Modifying a table</h3>
<p>Next, we deploy a <code>table</code> object and modify the table structure.</p>
<p>As before, first we create a <code>schedule</code> table with the structure shown below.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/62ac809d1b794c1b86fe3a35faa0af40.png" alt="table"></p>
<p>Define a corresponding <code>Table</code> table object as shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># schedule-table.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">schemas.schemahero.io/v1alpha4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">schedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">schemahero-tutorial</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l">airlinedb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">schedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postgres</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">flight_num]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">columns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">flight_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">origin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">char(4)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">destination</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">char(4)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">departure_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">arrival_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Just apply the list of resources above directly.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f schedule-table.yaml -n schemahero-tutorial
</span></span><span class="line"><span class="cl">$ kubectl schemahero get migrations -n schemahero-tutorial
</span></span></code></pre></td></tr></table>
</div>
</div><p>When the <code>schedule</code> migration is ready, it will be displayed in the output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ID      DATABASE  TABLE    PLANNED EXECUTED APPROVED REJECTED 
</span></span><span class="line"><span class="cl">a9626a8 airlinedb schedule 21s 
</span></span><span class="line"><span class="cl">eaa36ef airlinedb airport  4h      3h       3h
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can also check the corresponding SQL statement after <code>describe</code> and approve the change if it is safe.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero -n schemahero-tutorial approve migration a9626a8
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once approved, you can check if there is a <code>schedule</code> table in Beekeeper Studio now.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/597a985e8f064fcab8063bd5e480f4a1.png" alt="Beekeeper Studio"></p>
<p>Now let&rsquo;s make some changes to this table structure.</p>
<ul>
<li>Make the <code>departure_time</code> and <code>arrival_time</code> columns empty</li>
<li>Add a new column named <code>duration</code></li>
</ul>
<p>Modify the <code>schedule-table.yaml</code> file above by removing the <code>constraints</code> attribute from the <code>departure_time</code> and <code>arrival_time</code> columns and adding a new one named <code>duration</code>, of type <code>int</code> and without the <code>constraints</code> attribute. The modified file is shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">schemas.schemahero.io/v1alpha4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">schedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">schemahero-tutorial</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l">airlinedb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">schedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schema</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">postgres</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">primaryKey</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">flight_num]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">columns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">flight_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">origin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">char(4)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">destination</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">char(4)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">constraints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">notNull</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">departure_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">arrival_time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">duration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">int</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Re-apply the file after modifying it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl apply -f schedule-table.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>After applying, you can also view the <code>migration</code> object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero get migrations -n schemahero-tutorial
</span></span><span class="line"><span class="cl">ID       DATABASE   TABLE     PLANNED  EXECUTED  APPROVED  REJECTED
</span></span><span class="line"><span class="cl">a9626a8  airlinedb  schedule  9m30s    7m58s     8m0s
</span></span><span class="line"><span class="cl">eaa36ef  airlinedb  airport   4h       4h        4h
</span></span><span class="line"><span class="cl">fa32022  airlinedb  schedule  5s
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that there is a new <code>migration</code> object in the <code>pending</code> state. Also use the <code>describe</code> command to see the details of the <code>migration</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero -n schemahero-tutorial describe migration fa32022
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Migration Name: fa32022
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Generated DDL Statement <span class="o">(</span>generated at 2020-06-06T14:56:04-07:00<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  alter table <span class="s2">&#34;schedule&#34;</span> alter column <span class="s2">&#34;departure_time&#34;</span> <span class="nb">type</span> time, alter column <span class="s2">&#34;departure_time&#34;</span> drop not null<span class="p">;</span>
</span></span><span class="line"><span class="cl">  alter table <span class="s2">&#34;schedule&#34;</span> alter column <span class="s2">&#34;arrival_time&#34;</span> <span class="nb">type</span> time, alter column <span class="s2">&#34;arrival_time&#34;</span> drop not null<span class="p">;</span>
</span></span><span class="line"><span class="cl">  alter table <span class="s2">&#34;schedule&#34;</span> add column <span class="s2">&#34;duration&#34;</span> integer<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To apply this migration:
</span></span><span class="line"><span class="cl">  kubectl schemahero -n schemahero-tutorial approve migration fa32022
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To recalculate this migration against the current schema:
</span></span><span class="line"><span class="cl">  kubectl schemahero -n schemahero-tutorial recalculate migration fa32022
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To deny and cancel this migration:
</span></span><span class="line"><span class="cl">  kubectl schemahero -n schemahero-tutorial  reject migration fa32022
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the above message you can see that the DDL statements generated for this migration consist of 3 different statements, <code>SchemaHero</code> compares the YAML we just deployed with the actual database structure and generates the above command.</p>
<p>Again, after verifying that the migration statements are OK, we can simply approve the migration.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ kubectl schemahero -n schemahero-tutorial approve migration fa32022
</span></span><span class="line"><span class="cl">Migration fa32022 approved
</span></span></code></pre></td></tr></table>
</div>
</div><p>The table structure is changed successfully after normal approval.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/26/6bfb79e905b0456ba8529a77fb6ebff2.png" alt="SchemaHero"></p>
<p>Here we basically understand the basics of <code>SchemaHero</code>, but of course <code>SchemaHero</code> still needs features not introduced, you can check the official documentation <a href="https://schemahero.io/docs/">https://schemahero.io/docs/</a> for more information about it.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cloud-native/">Cloud-Native</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/tektoncd-operator/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Managing Tekton components with Tektoncd Operator</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-plugin-faq/">
            <span class="next-text nav-default">FAQ about Go plugin and solutions</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
