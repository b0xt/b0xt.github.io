<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>The difference between function return values and pointers in Golang - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore the difference between function return values and pointers in golang." /><meta name="keywords" content="golang function, return values, return pointers" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/go-func-return/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="The difference between function return values and pointers in Golang" />
<meta property="og:description" content="Explore the difference between function return values and pointers in golang." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/go-func-return/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-06T14:01:04+08:00" />
<meta property="article:modified_time" content="2022-07-06T14:01:04+08:00" />

<meta itemprop="name" content="The difference between function return values and pointers in Golang">
<meta itemprop="description" content="Explore the difference between function return values and pointers in golang."><meta itemprop="datePublished" content="2022-07-06T14:01:04+08:00" />
<meta itemprop="dateModified" content="2022-07-06T14:01:04+08:00" />
<meta itemprop="wordCount" content="2756">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The difference between function return values and pointers in Golang"/>
<meta name="twitter:description" content="Explore the difference between function return values and pointers in golang."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">The difference between function return values and pointers in Golang</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-06 14:01:04 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2756 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#variable-memory-allocation-and-recycling">Variable memory allocation and recycling</a>
          <ul>
            <li><a href="#difference-between-heap-and-stack">Difference between heap and stack</a></li>
          </ul>
        </li>
        <li><a href="#variable-memory-allocation-escape-analysis">Variable memory allocation escape analysis</a>
          <ul>
            <li><a href="#check-whether-the-variable-is-allocated-on-the-stack-or-the-heap">Check whether the variable is allocated on the stack or the heap</a></li>
            <li><a href="#some-cases-of-intra-function-variables-allocated-on-the-heap">Some cases of intra-function variables allocated on the heap</a></li>
          </ul>
        </li>
        <li><a href="#performance-differences-when-returning-from-a-function-using-a-value-and-a-pointer">Performance differences when returning from a function using a value and a pointer</a>
          <ul>
            <li><a href="#some-other-experience-in-using">Some other experience in using</a></li>
          </ul>
        </li>
        <li><a href="#summary">Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="variable-memory-allocation-and-recycling">Variable memory allocation and recycling</h2>
<p>Go programs allocate memory for variables in two places, one is the global heap and the other is the function call stack. The Go language has a garbage collection mechanism, and it is up to the compiler to decide whether a variable is allocated on the heap or stack in Go, so developers don&rsquo;t need to pay much attention to whether a variable is allocated on the stack or heap. However, if you want to write high quality code, it is necessary to understand the implementation behind the language. The mechanism of allocating variables on the stack and on the heap is completely different, and the performance difference between the allocation and recycling process of variables is very big.</p>
<h3 id="difference-between-heap-and-stack">Difference between heap and stack</h3>
<h4 id="heap">Heap</h4>
<p>The memory that is dynamically allocated when the program is running is located in the heap, which is managed by the memory allocator, and the size of this area changes as the program runs. That is, when we request memory from the heap but the allocator finds that there is not enough memory in the heap, it requests the operating system kernel to expand the size of the heap in the direction of higher addresses. When we release the memory and return it to the heap, if the allocator finds that there is too much free memory left, it requests the OS to shrink the heap size to the lower address. As we can see from the memory request and release process, the memory allocated from the heap must be returned to the heap after it is used up, otherwise the memory allocator may repeatedly request the operating system to expand the heap size, resulting in more and more heap memory being used and eventually running out of memory, which is called a memory leak. It is worth mentioning that traditional c/c++ code needs to handle the allocation and release of memory manually, while in Go, there is a garbage collector to collect the memory on the heap, so the programmer only needs to apply for memory, not to care about the release of memory, which greatly reduces the mental burden of the programmer, which not only improves the productivity of the programmer, but more importantly, also reduces the generation of many bugs.</p>
<h4 id="stack">Stack</h4>
<p>The function call stack, referred to as the stack, plays a very important role in the running of a program, whether it is the execution of a function or a function call, and it is mainly used to.</p>
<ul>
<li>store the local variables of the function.</li>
<li>pass parameters to the called function.</li>
<li>to return the return value of a function.</li>
<li>to hold the return address of the function, which is the address of the instruction that the caller should continue to execute after returning from the called function.</li>
</ul>
<p>Each function needs to use a piece of stack memory to store these values during execution, and we call this piece of stack memory the stack frame of a function. When a function call occurs, because the caller has not finished executing, the data saved in its stack memory is still available, so the called function cannot overwrite the caller&rsquo;s stack frame, but can only &ldquo;push&rdquo; the called function&rsquo;s stack frame onto the stack, and then &ldquo;pop&rdquo; its stack frame from the stack after the called function has finished executing. pop&quot; out, so that the size of the stack will grow with the increase of the function call level, and shrink with the return of the function, that is, the deeper the function call level, the more stack space is consumed. The growth and shrinkage of the stack is automatic and is done automatically by the code inserted by the compiler, so the memory used by the function local variables located in the stack memory is allocated with the function call and released automatically with the return of the function, so the programmer does not need to release the memory used by the local variables himself, whether he uses a high-level programming language with or without garbage collection. This is quite different from the memory allocated on the heap.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/06/322d5d020b5547018f2f97c5baf9febe.png" alt="go stack"></p>
<p>The process is the basic unit of resource allocation for the operating system. Each process is allocated a fixed size of memory on the process stack by the operating system at startup, and the default stack size of the process in Linux can be viewed by <code>ulimit -s</code>. The memory allocated on the stack is automatically reclaimed when the function exits by changing the offset of the register pointer. The size of memory in the heap is requested from the operating system while the process is running. The amount of memory available in the process heap also depends on the amount of memory currently available to the operating system.</p>
<p>So how does the compiler decide whether to allocate variables on the heap or the stack in Go?</p>
<h2 id="variable-memory-allocation-escape-analysis">Variable memory allocation escape analysis</h2>
<p>As mentioned above, it is up to the compiler to decide whether to allocate variables on the heap or the stack in Go, and the way the compiler decides where to allocate memory is called escape analysis.</p>
<p>When a local variable is declared within a function in Go, the compiler will allocate memory on the stack when it finds that the scope of the variable does not escape from the function, otherwise it will be allocated on the heap. Escape analysis is done by the compiler and acts at the compilation stage.</p>
<h3 id="check-whether-the-variable-is-allocated-on-the-stack-or-the-heap">Check whether the variable is allocated on the stack or the heap</h3>
<p>There are two ways to determine whether a variable allocates memory on the heap or on the stack:</p>
<ul>
<li>by compiling the generated assembly function to confirm that variables that allocate memory on the heap call the <code>newobject</code> function of the runtime package.</li>
<li>compile-time display of compilation optimization information by specifying options, and the compiler outputs the escaped variables.</li>
</ul>
<p>The variables in the following code examples are analyzed for escapes by both of the above.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">demo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Msg</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">example</span><span class="p">()</span> <span class="o">*</span><span class="nx">demo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">demo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">example</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1-verify-that-variable-memory-allocation-is-not-escaping-through-assembly">1. Verify that variable memory allocation is not escaping through assembly**</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go tool compile -S main.go
</span></span><span class="line"><span class="cl">go tool compile -S main.go
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;</span>.example STEXT <span class="nv">size</span><span class="o">=</span><span class="m">72</span> <span class="nv">args</span><span class="o">=</span>0x8 <span class="nv">locals</span><span class="o">=</span>0x18
</span></span><span class="line"><span class="cl">	0x0000 <span class="m">00000</span> <span class="o">(</span>main.go:7<span class="o">)</span>	TEXT	<span class="s2">&#34;&#34;</span>.example<span class="o">(</span>SB<span class="o">)</span>, ABIInternal, <span class="nv">$24</span>-8
</span></span><span class="line"><span class="cl">	0x0000 <span class="m">00000</span> <span class="o">(</span>main.go:7<span class="o">)</span>	MOVQ	<span class="o">(</span>TLS<span class="o">)</span>, CX
</span></span><span class="line"><span class="cl">	0x0009 <span class="m">00009</span> <span class="o">(</span>main.go:7<span class="o">)</span>	CMPQ	SP, 16<span class="o">(</span>CX<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x000d <span class="m">00013</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$-</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">	0x000d <span class="m">00013</span> <span class="o">(</span>main.go:7<span class="o">)</span>	JLS	<span class="m">65</span>
</span></span><span class="line"><span class="cl">	0x000f <span class="m">00015</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$-</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">	0x000f <span class="m">00015</span> <span class="o">(</span>main.go:7<span class="o">)</span>	SUBQ	<span class="nv">$24</span>, SP
</span></span><span class="line"><span class="cl">	0x0013 <span class="m">00019</span> <span class="o">(</span>main.go:7<span class="o">)</span>	MOVQ	BP, 16<span class="o">(</span>SP<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x0018 <span class="m">00024</span> <span class="o">(</span>main.go:7<span class="o">)</span>	LEAQ	16<span class="o">(</span>SP<span class="o">)</span>, BP
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$-</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$1</span>, <span class="nv">$-</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:7<span class="o">)</span>	FUNCDATA	<span class="nv">$0</span>, gclocals·9fb7f0986f647f17cb53dda1484e0f7a<span class="o">(</span>SB<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:7<span class="o">)</span>	FUNCDATA	<span class="nv">$1</span>, gclocals·69c1753bd5f81501d95132d08af04464<span class="o">(</span>SB<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:7<span class="o">)</span>	FUNCDATA	<span class="nv">$2</span>, gclocals·9fb7f0986f647f17cb53dda1484e0f7a<span class="o">(</span>SB<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:8<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$1</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:8<span class="o">)</span>	PCDATA	<span class="nv">$1</span>, <span class="nv">$0</span>
</span></span><span class="line"><span class="cl">	0x001d <span class="m">00029</span> <span class="o">(</span>main.go:8<span class="o">)</span>	LEAQ	type.<span class="s2">&#34;&#34;</span>.demo<span class="o">(</span>SB<span class="o">)</span>, AX
</span></span><span class="line"><span class="cl">	0x0024 <span class="m">00036</span> <span class="o">(</span>main.go:8<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$0</span>
</span></span><span class="line"><span class="cl">	0x0024 <span class="m">00036</span> <span class="o">(</span>main.go:8<span class="o">)</span>	MOVQ	AX, <span class="o">(</span>SP<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x0028 <span class="m">00040</span> <span class="o">(</span>main.go:8<span class="o">)</span>	CALL	runtime.newobject<span class="o">(</span>SB<span class="o">)</span>  // 调用 runtime.newobject 函数
</span></span><span class="line"><span class="cl">	0x002d <span class="m">00045</span> <span class="o">(</span>main.go:8<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$1</span>
</span></span><span class="line"><span class="cl">	0x002d <span class="m">00045</span> <span class="o">(</span>main.go:8<span class="o">)</span>	MOVQ	8<span class="o">(</span>SP<span class="o">)</span>, AX
</span></span><span class="line"><span class="cl">	0x0032 <span class="m">00050</span> <span class="o">(</span>main.go:9<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$0</span>
</span></span><span class="line"><span class="cl">	0x0032 <span class="m">00050</span> <span class="o">(</span>main.go:9<span class="o">)</span>	PCDATA	<span class="nv">$1</span>, <span class="nv">$1</span>
</span></span><span class="line"><span class="cl">	0x0032 <span class="m">00050</span> <span class="o">(</span>main.go:9<span class="o">)</span>	MOVQ	AX, <span class="s2">&#34;&#34;</span>.~r0+32<span class="o">(</span>SP<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x0037 <span class="m">00055</span> <span class="o">(</span>main.go:9<span class="o">)</span>	MOVQ	16<span class="o">(</span>SP<span class="o">)</span>, BP
</span></span><span class="line"><span class="cl">	0x003c <span class="m">00060</span> <span class="o">(</span>main.go:9<span class="o">)</span>	ADDQ	<span class="nv">$24</span>, SP
</span></span><span class="line"><span class="cl">	0x0040 <span class="m">00064</span> <span class="o">(</span>main.go:9<span class="o">)</span>	RET
</span></span><span class="line"><span class="cl">	0x0041 <span class="m">00065</span> <span class="o">(</span>main.go:9<span class="o">)</span>	NOP
</span></span><span class="line"><span class="cl">	0x0041 <span class="m">00065</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$1</span>, <span class="nv">$-</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">	0x0041 <span class="m">00065</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$-</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">	0x0041 <span class="m">00065</span> <span class="o">(</span>main.go:7<span class="o">)</span>	CALL	runtime.morestack_noctxt<span class="o">(</span>SB<span class="o">)</span>
</span></span><span class="line"><span class="cl">	0x0046 <span class="m">00070</span> <span class="o">(</span>main.go:7<span class="o">)</span>	PCDATA	<span class="nv">$0</span>, <span class="nv">$-</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">	0x0046 <span class="m">00070</span> <span class="o">(</span>main.go:7<span class="o">)</span>	JMP	<span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above is just the compiled assembly code of the example function. You can see that the runtime.newobject function is called in line 8 of the program.</p>
<h4 id="2-check-by-compilation-options">2. Check by compilation options</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go build -gcflags <span class="s2">&#34;-m -l&#34;</span> main.go
</span></span><span class="line"><span class="cl"><span class="c1"># command-line-arguments</span>
</span></span><span class="line"><span class="cl">./main.go:8:7: <span class="p">&amp;</span>demo literal escapes to heap:
</span></span><span class="line"><span class="cl">./main.go:8:7:   flow: <span class="nv">d</span> <span class="o">=</span> <span class="p">&amp;</span><span class="o">{</span>storage <span class="k">for</span> <span class="p">&amp;</span>demo literal<span class="o">}</span>:
</span></span><span class="line"><span class="cl">./main.go:8:7:     from <span class="p">&amp;</span>demo literal <span class="o">(</span>spill<span class="o">)</span> at ./main.go:8:7
</span></span><span class="line"><span class="cl">./main.go:8:7:     from d :<span class="o">=</span> <span class="p">&amp;</span>demo literal <span class="o">(</span>assign<span class="o">)</span> at ./main.go:8:4
</span></span><span class="line"><span class="cl">./main.go:8:7:   flow: ~r0 <span class="o">=</span> d:
</span></span><span class="line"><span class="cl">./main.go:8:7:     from <span class="k">return</span> d <span class="o">(</span><span class="k">return</span><span class="o">)</span> at ./main.go:9:2
</span></span><span class="line"><span class="cl">./main.go:8:7: <span class="p">&amp;</span>demo literal escapes to heap
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># or</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ go tool compile -l -m -m main.go
</span></span><span class="line"><span class="cl">main.go:8:7: <span class="p">&amp;</span>demo literal escapes to heap:
</span></span><span class="line"><span class="cl">main.go:8:7:   flow: <span class="nv">d</span> <span class="o">=</span> <span class="p">&amp;</span><span class="o">{</span>storage <span class="k">for</span> <span class="p">&amp;</span>demo literal<span class="o">}</span>:
</span></span><span class="line"><span class="cl">main.go:8:7:     from <span class="p">&amp;</span>demo literal <span class="o">(</span>spill<span class="o">)</span> at main.go:8:7
</span></span><span class="line"><span class="cl">main.go:8:7:     from d :<span class="o">=</span> <span class="p">&amp;</span>demo literal <span class="o">(</span>assign<span class="o">)</span> at main.go:8:4
</span></span><span class="line"><span class="cl">main.go:8:7:   flow: ~r0 <span class="o">=</span> d:
</span></span><span class="line"><span class="cl">main.go:8:7:     from <span class="k">return</span> d <span class="o">(</span><span class="k">return</span><span class="o">)</span> at main.go:9:2
</span></span><span class="line"><span class="cl">main.go:8:7: <span class="p">&amp;</span>demo literal escapes to heap
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can use <code>go tool compile --help</code> to see the meaning of several options.</p>
<p>The official Go faq documentation <a href="https://golang.org/doc/faq#stack_or_heap">stack_or_heap</a> also describes how to know whether a variable is allocated on the heap or on a sticky, and the documentation is relatively simple.</p>
<h3 id="some-cases-of-intra-function-variables-allocated-on-the-heap">Some cases of intra-function variables allocated on the heap</h3>
<h4 id="1-variables-of-pointer-type-pointer-escape">1. Variables of pointer type, pointer escape</h4>
<p>Code example, consistent with the example in the previous section.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">demo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Msg</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">example</span><span class="p">()</span> <span class="o">*</span><span class="nx">demo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">demo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">example</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">tool</span> <span class="nx">compile</span> <span class="o">-</span><span class="nx">l</span> <span class="o">-</span><span class="nx">m</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span><span class="mi">7</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">demo</span> <span class="nx">literal</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-insufficient-stack-space">2. insufficient stack space</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">generate8191</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nums</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">8191</span><span class="p">)</span> <span class="c1">// &lt; 64KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">8191</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">generate8192</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nums</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">8192</span><span class="p">)</span> <span class="c1">// = 64KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">8192</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">generate</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nums</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="c1">// 不确定大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">generate8191</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nf">generate8192</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nf">generate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">tool</span> <span class="nx">compile</span> <span class="o">-</span><span class="nx">l</span> <span class="o">-</span><span class="nx">m</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">8191</span><span class="p">)</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">escape</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">8192</span><span class="p">)</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see in the Go compiler code, variables over 10M in size are allocated to the heap for declared types, and implicit variables over 64KB are allocated to the heap by default.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// maximum size variable which we will allocate on the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This limit is for explicit variable declarations like &#34;var x T&#34; or &#34;x := ...&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Note: the flag smallframes can update this value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">maxStackVarSize</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// maximum size of implicit variables that we will allocate on the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   p := new(T)          allocating T on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   p := &amp;T{}            allocating T on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   s := make([]T, n)    allocating [n]T on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   s := []byte(&#34;...&#34;)   allocating [n]byte on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Note: the flag smallframes can update this value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">maxImplicitStackVarSize</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-dynamic-types-interface-dynamic-type-escapes">3. Dynamic types, interface{} Dynamic type escapes</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Demo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nf">example</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">example</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Demo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">tool</span> <span class="nx">compile</span> <span class="o">-</span><span class="nx">l</span> <span class="o">-</span><span class="nx">m</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span> <span class="nx">Demo</span> <span class="nx">literal</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-closure-reference-object">4. Closure reference object</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">increase</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">x</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">x</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nf">increase</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">in</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">in</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">$</span> <span class="k">go</span> <span class="nx">tool</span> <span class="nx">compile</span> <span class="o">-</span><span class="nx">l</span> <span class="o">-</span><span class="nx">m</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span> <span class="nx">moved</span> <span class="nx">to</span> <span class="nx">heap</span><span class="p">:</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span> <span class="kd">func</span> <span class="nx">literal</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span> <span class="o">...</span> <span class="nx">argument</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">escape</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span> <span class="nf">in</span><span class="p">()</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span> <span class="o">...</span> <span class="nx">argument</span> <span class="nx">does</span> <span class="nx">not</span> <span class="nx">escape</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">.</span><span class="k">go</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span> <span class="nf">in</span><span class="p">()</span> <span class="nx">escapes</span> <span class="nx">to</span> <span class="nx">heap</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="performance-differences-when-returning-from-a-function-using-a-value-and-a-pointer">Performance differences when returning from a function using a value and a pointer</h2>
<p>The above article introduced the way of memory allocation for variables in Go. From the above article, we know that when a variable is defined in a function and returned with a value, the variable will be allocated on the stack and the function will copy the whole object when it returns.</p>
<p>Although the value has a copy operation, the return pointer will allocate the variable on the heap, and the allocation and recycling of the variable on the heap will have a larger overhead. For this problem, there is also a certain relationship with the returned object and platform, and different platforms need to be benchmarked to get a more accurate result.</p>
<p><code>return_value_or_pointer.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">bigSize</span> <span class="p">=</span> <span class="mi">200000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">bigStruct</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nums</span> <span class="p">[</span><span class="nx">bigSize</span><span class="p">]</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newBigStruct</span><span class="p">()</span> <span class="nx">bigStruct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="nx">bigStruct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bigSize</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="p">.</span><span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newBigStructPtr</span><span class="p">()</span> <span class="o">*</span><span class="nx">bigStruct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="nx">bigStruct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bigSize</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="p">.</span><span class="nx">nums</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span> <span class="o">:=</span> <span class="nf">newBigStruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nf">newBigStructPtr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>benchmark_test.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkStructReturnValue</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">v</span> <span class="o">:=</span> <span class="nf">newBigStruct</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BenchmarkStructReturnPointer</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">ReportAllocs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">v</span> <span class="o">:=</span> <span class="nf">newBigStructPtr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go <span class="nb">test</span> -bench .
</span></span><span class="line"><span class="cl">goos: darwin
</span></span><span class="line"><span class="cl">goarch: amd64
</span></span><span class="line"><span class="cl">BenchmarkStructReturnValue-12      	    4215	    <span class="m">278542</span> ns/op	       <span class="m">0</span> B/op	       <span class="m">0</span> allocs/op
</span></span><span class="line"><span class="cl">BenchmarkStructReturnPointer-12    	    4556	    <span class="m">267253</span> ns/op	 <span class="m">1605634</span> B/op	       <span class="m">1</span> allocs/op
</span></span><span class="line"><span class="cl">PASS
</span></span><span class="line"><span class="cl">ok  	_/Users/tianfeiyu/golang-dev/test	3.670s
</span></span></code></pre></td></tr></table>
</div>
</div><p>In my local tests, structures with 200000 int types return values faster, and pointers are faster when they are less than 200000. If you have higher performance requirements for your code, you will need to benchmark it on a real platform to reach a conclusion.</p>
<h3 id="some-other-experience-in-using">Some other experience in using</h3>
<ol>
<li>
<p>stateful objects must use pointers to return, such as the system built-in sync. WaitGroup, sync.Pool, etc. In Go, some structures have an explicit noCopy field to remind that value copying is not possible.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A WaitGroup must not be copied after first use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">WaitGroup</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">noCopy</span> <span class="nx">noCopy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>objects with short life cycles use value return, if the life cycle of the object exists longer or the object is larger, you can use the pointer to return.</p>
</li>
<li>
<p>large objects are recommended to use pointers to return, object size threshold needs to be benchmarked in specific platforms to derive data.</p>
</li>
<li>
<p>reference to the use of some large open source projects, such as kubernetes, docker, etc..</p>
</li>
</ol>
<h2 id="summary">Summary</h2>
<p>This article has analyzed some of the issues when using variables in Go functions, the differences between allocating memory on the heap and the stack when variables will exist in both places, and when variables need to be allocated memory on the heap.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/k8s-evicted/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">How Pod Eviction Happens in kubernetes</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-bootstrap/">
            <span class="next-text nav-default">Golang program startup flow analysis</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
