<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Developing eBPF applications with Golang - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore how to develop eBPF applications based on cilium/ebpf!" /><meta name="keywords" content="golang, Ebpf, cilium/ebpf" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/go-ebpf/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Developing eBPF applications with Golang" />
<meta property="og:description" content="Explore how to develop eBPF applications based on cilium/ebpf!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/go-ebpf/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-20T09:05:03+08:00" />
<meta property="article:modified_time" content="2022-07-20T09:05:03+08:00" />

<meta itemprop="name" content="Developing eBPF applications with Golang">
<meta itemprop="description" content="Explore how to develop eBPF applications based on cilium/ebpf!"><meta itemprop="datePublished" content="2022-07-20T09:05:03+08:00" />
<meta itemprop="dateModified" content="2022-07-20T09:05:03+08:00" />
<meta itemprop="wordCount" content="2556">
<meta itemprop="keywords" content="golang," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Developing eBPF applications with Golang"/>
<meta name="twitter:description" content="Explore how to develop eBPF applications based on cilium/ebpf!"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Developing eBPF applications with Golang</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-20 09:05:03 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2556 words </span>
          <span class="more-meta"> 12 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-exploring-the-ciliumebpf-project-example">1. Exploring the cilium/ebpf project example</a></li>
        <li><a href="#2-build-ebpf-example-code">2. Build ebpf example code</a></li>
        <li><a href="#3-using-ciliumebpf-to-develop-the-user-state-part-for-the-previous-hello-world-ebpf-program">3. Using cilium/ebpf to develop the user state part for the previous Hello World eBPF program</a>
          <ul>
            <li><a href="#31-converting-ebpf-core-state-programs-to-go-code-using-bpf2go">3.1. Converting ebpf core state programs to Go code using bpf2go</a></li>
            <li><a href="#32-building-the-user-state-part-of-the-helloworld-ebpf-program">3.2. Building the user state part of the helloworld ebpf program</a></li>
            <li><a href="#33-using-go-generate-to-drive-the-conversion-of-bpf2go">3.3. Using go generate to drive the conversion of bpf2go</a></li>
          </ul>
        </li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/20/388bbba2fc7546e5b0ba736b457507ee.png" alt="Developing eBPF applications with Golang"></p>
<p>In the previous article &ldquo;<a href="/post/2022-07/c-ebpf/">Developing a Hello World level eBPF program from scratch using C</a>&rdquo;, we explained in detail how to develop an eBPF program (including its user state part) from scratch based on C and the libbpf library. That article was the basis for subsequent articles on eBPF program development, because until now the kernel state part of an eBPF program running in the kernel state had to be developed in C, no matter what language the user state part of the eBPF program was developed in. In this way, the competition between other programming languages is how to make the development of the user state part of eBPF programs easier, and Go is no exception.</p>
<p>The most active Go eBPF package used to develop the user state part of eBPF in the Go community would be the cilium project&rsquo;s open source <a href="https://github.com/cilium/ebpf">cilium/ebpf</a>.</p>
<blockquote>
<p>Isovalent, the company behind the &gt; cilium project, is also one of the main drivers for the adoption of eBPF technology in the cloud-native space.</p>
</blockquote>
<p>In this article we will talk about <strong>how to develop eBPF applications based on cilium/ebpf</strong>!</p>
<h2 id="1-exploring-the-ciliumebpf-project-example">1. Exploring the cilium/ebpf project example</h2>
<p>The cilium/ebpf project borrows the idea of <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-boostrap</a> to build the user state part of the eBPF program by code generation with bpf program inline. In order to figure out how to develop eBPF programs based on cilium/ebpf, let&rsquo;s first explore the sample code provided by the cilium/ebpf project.</p>
<p>Let&rsquo;s first download and look at the structure of the ebpf example.</p>
<ul>
<li>
<p>Download cilium/ebpf project</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git clone https://github.com/cilium/ebpf.git
</span></span><span class="line"><span class="cl">Cloning into <span class="s1">&#39;ebpf&#39;</span>...
</span></span><span class="line"><span class="cl">remote: Enumerating objects: 7054, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Counting objects: 100% <span class="o">(</span>183/183<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Compressing objects: 100% <span class="o">(</span>112/112<span class="o">)</span>, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">remote: Total <span class="m">7054</span> <span class="o">(</span>delta 91<span class="o">)</span>, reused <span class="m">124</span> <span class="o">(</span>delta 69<span class="o">)</span>, pack-reused <span class="m">6871</span>
</span></span><span class="line"><span class="cl">Receiving objects: 100% <span class="o">(</span>7054/7054<span class="o">)</span>, 10.91 MiB <span class="p">|</span> 265.00 KiB/s, <span class="k">done</span>.
</span></span><span class="line"><span class="cl">Resolving deltas: 100% <span class="o">(</span>4871/4871<span class="o">)</span>, <span class="k">done</span>.
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Explore the ebpf project sample code structure</p>
<p>The ebpf example is in the examples directory. Let&rsquo;s take a look at tracepoint_in_c as an example to see how it is organized.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">$tree tracepoint_in_c
</span></span><span class="line"><span class="cl">tracepoint_in_c
</span></span><span class="line"><span class="cl">├── bpf_bpfeb.go
</span></span><span class="line"><span class="cl">├── bpf_bpfeb.o
</span></span><span class="line"><span class="cl">├── bpf_bpfel.go
</span></span><span class="line"><span class="cl">├── bpf_bpfel.o
</span></span><span class="line"><span class="cl">├── main.go
</span></span><span class="line"><span class="cl">└── tracepoint.c
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0 directories, 6 files
</span></span></code></pre></td></tr></table>
</div>
</div><p>Judging from experience, <code>tracepoint.c</code> here corresponds to the kernel state part of the ebpf program, while <code>main.go</code> and <code>bpf_bpfel.go/bpf_bpfeb.go</code> are the user state part of the ebpf program, and as for <code>bpf_bpfeb.o/bpf_bpfel.o</code> should be some kind of intermediate target file.</p>
<p>Check this intermediate file by <code>readingelf -a bpf_bpfeb.o</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$readelf</span> -a bpf_bpfeb.o
</span></span><span class="line"><span class="cl">ELF Header:
</span></span><span class="line"><span class="cl">Magic:   7f <span class="m">45</span> 4c <span class="m">46</span> <span class="m">02</span> <span class="m">02</span> <span class="m">01</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>
</span></span><span class="line"><span class="cl">Class:                             ELF64
</span></span><span class="line"><span class="cl">Data:                              2<span class="err">&#39;</span>s complement, big endian
</span></span><span class="line"><span class="cl">Version:                           <span class="m">1</span> <span class="o">(</span>current<span class="o">)</span>
</span></span><span class="line"><span class="cl">OS/ABI:                            UNIX - System V
</span></span><span class="line"><span class="cl">ABI Version:                       <span class="m">0</span>
</span></span><span class="line"><span class="cl">Type:                              REL <span class="o">(</span>Relocatable file<span class="o">)</span>
</span></span><span class="line"><span class="cl">Machine:                           Linux BPF
</span></span><span class="line"><span class="cl">Version:                           0x1
</span></span><span class="line"><span class="cl">Entry point address:               0x0
</span></span><span class="line"><span class="cl">Start of program headers:          <span class="m">0</span> <span class="o">(</span>bytes into file<span class="o">)</span>
</span></span><span class="line"><span class="cl">Start of section headers:          <span class="m">1968</span> <span class="o">(</span>bytes into file<span class="o">)</span>
</span></span><span class="line"><span class="cl">Flags:                             0x0
</span></span><span class="line"><span class="cl">Size of this header:               <span class="m">64</span> <span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">Size of program headers:           <span class="m">0</span> <span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">Number of program headers:         <span class="m">0</span>
</span></span><span class="line"><span class="cl">Size of section headers:           <span class="m">64</span> <span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">Number of section headers:         <span class="m">13</span>
</span></span><span class="line"><span class="cl">Section header string table index: <span class="m">1</span>
</span></span><span class="line"><span class="cl">... ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see that this is an elf file containing linux bpf bytecode (Machine: Linux BPF).</p>
<p>After reading the documentation on cilium/ebpf, I figured out the relationship between these files and present it to you in the following schematic.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/20/984e8f0d69084c12a6d639f28a5d7282.png" alt="cilium/ebpf"></p>
<p>The source code file of the ebpf program (e.g. tracepoint.c in the figure) is compiled (bpf2go calls clang) by bpf2go (a code generation tool provided by cilium/ebpf) into the ebpf bytecode files bpf_bpfeb.o (big end) and bpf_bpfel.o (small end). Then bpf2go will generate bpf_bpfeb.go or bpf_bpfel.go based on the ebpf bytecode file. The bytecode of the ebpf program will be embedded in these two go source files as binary data. Taking bpf_bpfel.go as an example, we can find the following in its code (using the go:embed feature).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:embed bpf_bpfel.o
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">_BpfBytes</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>main.go is the main program for the user state part of the ebpf program. Compiling main.go with either bpf_bpfeb.go or bpf_bpfel.go creates the ebpf program.</p>
<p>With an initial exploration of the cilium/ebpf project example, let&rsquo;s build the ebpf sample code.</p>
</li>
</ul>
<h2 id="2-build-ebpf-example-code">2. Build ebpf example code</h2>
<p>cilium/ebpf provides a convenient build script, we just need to execute &ldquo;make -C &hellip;&rdquo; under ebpf/examples to build the sample code.</p>
<p>The make build process will start the build container based on the quay.io/cilium/ebpf-builder image.</p>
<blockquote>
<p>If you are in China, you need to do a little modification to the Makefile content like below and add the GOPROXY environment variable, otherwise the go module can&rsquo;t be pulled due to GFW.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">$git diff ../Makefile
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/Makefile b/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gh">index 3a1da88..d7b1712 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/Makefile
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -48,6 +48,7 @@ container-all:
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>       ${CONTAINER_ENGINE} run --rm ${CONTAINER_RUN_ARGS} \
</span></span><span class="line"><span class="cl">               -v &#34;${REPODIR}&#34;:/ebpf -w /ebpf --env MAKEFLAGS \
</span></span><span class="line"><span class="cl">               --env CFLAGS=&#34;-fdebug-prefix-map=/ebpf=.&#34; \
</span></span><span class="line"><span class="cl"><span class="gi">+               --env GOPROXY=&#34;https://goproxy.io&#34; \
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>               --env HOME=&#34;/tmp&#34; \
</span></span><span class="line"><span class="cl">               &#34;${IMAGE}:${VERSION}&#34; \
</span></span><span class="line"><span class="cl">               $(MAKE) all
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>Executing the build after this will give us the results we are looking for without any problems.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> examples
</span></span><span class="line"><span class="cl">$ make -C ..
</span></span><span class="line"><span class="cl">make: Entering directory <span class="s1">&#39;/root/go/src/github.com/cilium/ebpf&#39;</span>
</span></span><span class="line"><span class="cl">docker run --rm  --user <span class="s2">&#34;0:0&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -v <span class="s2">&#34;/root/go/src/github.com/cilium/ebpf&#34;</span>:/ebpf -w /ebpf --env MAKEFLAGS <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --env <span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&#34;-fdebug-prefix-map=/ebpf=.&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --env <span class="nv">GOPROXY</span><span class="o">=</span><span class="s2">&#34;https://goproxy.io&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --env <span class="nv">HOME</span><span class="o">=</span><span class="s2">&#34;/tmp&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="s2">&#34;quay.io/cilium/ebpf-builder:1648566014&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make all
</span></span><span class="line"><span class="cl">make: Entering directory <span class="s1">&#39;/ebpf&#39;</span>
</span></span><span class="line"><span class="cl">find . -type f -name <span class="s2">&#34;*.c&#34;</span> <span class="p">|</span> xargs clang-format -i
</span></span><span class="line"><span class="cl">go generate ./cmd/bpf2go/test
</span></span><span class="line"><span class="cl">go: downloading golang.org/x/sys v0.0.0-20210906170528-6f6e22806c34
</span></span><span class="line"><span class="cl">Compiled /ebpf/cmd/bpf2go/test/test_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/cmd/bpf2go/test/test_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/cmd/bpf2go/test/test_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /ebpf/cmd/bpf2go/test/test_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/cmd/bpf2go/test/test_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/cmd/bpf2go/test/test_bpfeb.go
</span></span><span class="line"><span class="cl">go generate ./internal/sys
</span></span><span class="line"><span class="cl">enum AdjRoomMode
</span></span><span class="line"><span class="cl">enum AttachType
</span></span><span class="line"><span class="cl">enum Cmd
</span></span><span class="line"><span class="cl">enum FunctionId
</span></span><span class="line"><span class="cl">enum HdrStartOff
</span></span><span class="line"><span class="cl">enum LinkType
</span></span><span class="line"><span class="cl">enum MapType
</span></span><span class="line"><span class="cl">enum ProgType
</span></span><span class="line"><span class="cl">enum RetCode
</span></span><span class="line"><span class="cl">enum SkAction
</span></span><span class="line"><span class="cl">enum StackBuildIdStatus
</span></span><span class="line"><span class="cl">enum StatsType
</span></span><span class="line"><span class="cl">enum XdpAction
</span></span><span class="line"><span class="cl">struct BtfInfo
</span></span><span class="line"><span class="cl">... ...
</span></span><span class="line"><span class="cl">attr ProgRun
</span></span><span class="line"><span class="cl">attr RawTracepointOpen
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> examples/ <span class="o">&amp;&amp;</span> go generate ./...
</span></span><span class="line"><span class="cl">go: downloading github.com/cilium/ebpf v0.8.2-0.20220424153111-6da9518107a8
</span></span><span class="line"><span class="cl">go: downloading golang.org/x/sys v0.0.0-20211001092434-39dca1131b70
</span></span><span class="line"><span class="cl">Compiled /ebpf/examples/cgroup_skb/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/examples/cgroup_skb/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/examples/cgroup_skb/bpf_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /ebpf/examples/cgroup_skb/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/examples/cgroup_skb/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/examples/cgroup_skb/bpf_bpfeb.go
</span></span><span class="line"><span class="cl">Compiled /ebpf/examples/fentry/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/examples/fentry/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/examples/fentry/bpf_bpfeb.go
</span></span><span class="line"><span class="cl">Compiled /ebpf/examples/fentry/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/examples/fentry/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/examples/fentry/bpf_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /ebpf/examples/kprobe/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /ebpf/examples/kprobe/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /ebpf/examples/kprobe/bpf_bpfel.go
</span></span><span class="line"><span class="cl">Stripped /ebpf/examples/uretprobe/bpf_bpfel_x86.o
</span></span><span class="line"><span class="cl">... ...
</span></span><span class="line"><span class="cl">Wrote /ebpf/examples/uretprobe/bpf_bpfel_x86.go
</span></span><span class="line"><span class="cl">ln -srf testdata/loader-clang-14-el.elf testdata/loader-el.elf
</span></span><span class="line"><span class="cl">ln -srf testdata/loader-clang-14-eb.elf testdata/loader-eb.elf
</span></span><span class="line"><span class="cl">make: Leaving directory <span class="s1">&#39;/ebpf&#39;</span>
</span></span><span class="line"><span class="cl">make: Leaving directory <span class="s1">&#39;/root/go/src/github.com/cilium/ebpf&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Taking ebpf under uretprobe as an example, let&rsquo;s run it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$go</span> run -exec sudo uretprobe/*.go
</span></span><span class="line"><span class="cl">2022/06/05 18:23:23 Listening <span class="k">for</span> events..
</span></span></code></pre></td></tr></table>
</div>
</div><p>Open a new terminal and execute <code>vi .bashrc</code> in the user home directory. in the above execution window of the uretprobe program we can see the following output.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">2022/06/05 18:24:34 Listening for events..
</span></span><span class="line"><span class="cl">2022/06/05 18:24:42 /bin/bash:readline return value: vi .bashrc
</span></span></code></pre></td></tr></table>
</div>
</div><p>This indicates that the ebpf program under uretprobe is executing as expected.</p>
<h2 id="3-using-ciliumebpf-to-develop-the-user-state-part-for-the-previous-hello-world-ebpf-program">3. Using cilium/ebpf to develop the user state part for the previous Hello World eBPF program</h2>
<p>With an initial understanding of the cilium/ebpf sample program, let&rsquo;s develop the user state part of the hello world ebpf program from the previous article &ldquo;<a href="/post/2022-07/c-ebpf/">Developing a Hello World level eBPF program from scratch using C language</a>&rdquo;.</p>
<p>Review the C source code of that hello world ebpf program.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// github.com/bigwhite/experiments/tree/master/ebpf-examples/helloworld-go/helloworld.bpf.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">SEC</span><span class="p">(</span><span class="s">&#34;tracepoint/syscalls/sys_enter_execve&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">bpf_prog</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">msg</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;Hello, World!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">bpf_printk</span><span class="p">(</span><span class="s">&#34;invoke bpf_prog: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">LICENSE</span><span class="p">[]</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#34;Dual BSD/GPL&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once this ebpf program is loaded into the kernel, it will be called once whenever the execve system call is executed, and we will see the corresponding log output in <code>/sys/kernel/debug/tracing/trace_pipe</code>.</p>
<h3 id="31-converting-ebpf-core-state-programs-to-go-code-using-bpf2go">3.1. Converting ebpf core state programs to Go code using bpf2go</h3>
<p>Based on the &ldquo;routine&rdquo; we got when exploring the cilium/ebpf example program, the first thing we need to do is to convert helloworld.bpf.c into a Go code file, and the indispensable tool for this conversion process is the cilium/ebpf bpf2go tool, let&rsquo;s install the tool first.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$go</span> install github.com/cilium/ebpf/cmd/bpf2go@latest
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next, we can directly use the bpf2go tool to convert <code>helloworld.ebpf.c</code> to the corresponding go source file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$GOPACKAGE</span><span class="o">=</span>main bpf2go -cc clang-10 -cflags <span class="s1">&#39;-O2 -g -Wall -Werror&#39;</span> -target bpfel,bpfeb bpf helloworld.bpf.c -- -I /home/tonybai/test/ebpf/libbpf/include/uapi -I /usr/local/bpf/include -idirafter /usr/local/include -idirafter /usr/lib/llvm-10/lib/clang/10.0.0/include -idirafter /usr/include/x86_64-linux-gnu -idirafter /usr/include
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Compiled /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.go
</span></span></code></pre></td></tr></table>
</div>
</div><p>But there is a problem here, that is, the bpf2go command line is followed by a series of header files provided to the clang compiler with reference paths to the Makefile in the article &ldquo;Developing a Hello World-level eBPF program from scratch using C. If we follow these header file paths, although the bpf2go conversion can work, we need to depend on and install the libbpf library, which is obviously not what we want.</p>
<p>cilium/ebpf provides a headers directory in examples that contains all the headers needed to develop the user state part of the ebpf program, and we use it as our header reference path. To build ebpf based on this headers directory, however, we need to modify the <code>include</code> statement in <code>helloworld.bpf.c</code>.</p>
<p>The original include statement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/bpf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The modified include statement.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;common.h&#34;</span><span class="cp">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Next we will perform the conversion with the bpf2go tool.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$GOPACKAGE</span><span class="o">=</span>main bpf2go -cc clang-10 -cflags <span class="s1">&#39;-O2 -g -Wall -Werror&#39;</span> -target bpfel,bpfeb bpf helloworld.bpf.c -- -I /home/tonybai/go/src/github.com/cilium/ebpf/examples/headers
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Compiled /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.go
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see that bpf2go smoothly generates ebpf bytecode with the corresponding Go source files.</p>
<h3 id="32-building-the-user-state-part-of-the-helloworld-ebpf-program">3.2. Building the user state part of the helloworld ebpf program</h3>
<p>The following is the main.go source code of the user state part of the helloword ebpf program built by referring to the cilium/ebpf example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// github.com/bigwhite/experiments/ebpf-examples/helloworld-go/main.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os/signal&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;syscall&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/cilium/ebpf/link&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/cilium/ebpf/rlimit&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stopper</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">stopper</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Allow the current process to lock memory for eBPF resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rlimit</span><span class="p">.</span><span class="nf">RemoveMemlock</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Load pre-compiled programs and maps into the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">objs</span> <span class="o">:=</span> <span class="nx">bpfObjects</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadBpfObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">objs</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;loading objects: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">objs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//SEC(&#34;tracepoint/syscalls/sys_enter_execve&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// attach to xxx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">link</span><span class="p">.</span><span class="nf">Tracepoint</span><span class="p">(</span><span class="s">&#34;syscalls&#34;</span><span class="p">,</span> <span class="s">&#34;sys_enter_execve&#34;</span><span class="p">,</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">BpfProg</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;opening tracepoint: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">kp</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Successfully started! Please run \&#34;sudo cat /sys/kernel/debug/tracing/trace_pipe\&#34; to see output of the BPF programs\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Wait for a signal and close the perf reader,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// which will interrupt rd.Read() and make the program exit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">&lt;-</span><span class="nx">stopper</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Received signal, exiting program..&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We know that an ebpf program has several key components.</p>
<ul>
<li>ebpf program data</li>
<li>map: used for data interaction between user state and kernel state</li>
<li>attach point</li>
</ul>
<p>According to the description in <a href="https://github.com/cilium/ebpf/blob/master/ARCHITECTURE.md">cilium/ebpf architecture</a>, the ebpf package abstracts the first two parts into a single data structure, bpfObjects.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// bpfObjects contains all objects after they have been loaded into the kernel.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It can be passed to loadBpfObjects or ebpf.CollectionSpec.LoadAndAssign.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">bpfObjects</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bpfPrograms</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bpfMaps</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We see that the main function loads the ebpf program into the kernel via the generated loadBpfObjects function and populates the bpfObjects structure. Once the bpf program is loaded successfully, we can then use the fields in the bpfObjects structure to perform the rest of the operations, such as docking the bpf program to the target pendant node via a function in the link package (e.g., the link.Tracepoint function in the text). This way, bpf can be executed via callbacks after the corresponding event.</p>
<p>Compile and execute the helloworld example below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$go</span> run -exec sudo main.go bpf_bpfel.go
</span></span><span class="line"><span class="cl"><span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> tonybai:
</span></span><span class="line"><span class="cl">2022/06/05 14:12:40 Successfully started! Please run <span class="s2">&#34;sudo cat /sys/kernel/debug/tracing/trace_pipe&#34;</span> to see output of the BPF programs
</span></span></code></pre></td></tr></table>
</div>
</div><p>After that, open a new terminal and execute sudo <code>cat /sys/kernel/debug/tracing/trace_pipe</code>. When execve is called, we can see a log output like the following.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">&lt;...&gt;-551077  [000] .... 6062226.208943: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">&lt;...&gt;-551077  [000] .... 6062226.209098: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">&lt;...&gt;-551079  [007] .... 6062226.215421: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">&lt;...&gt;-551079  [007] .... 6062226.215578: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">&lt;...&gt;-554756  [007] .... 6063476.785212: 0: invoke bpf_prog: Hello, World!
</span></span><span class="line"><span class="cl">&lt;...&gt;-554756  [007] .... 6063476.785378: 0: invoke bpf_prog: Hello, World!
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="33-using-go-generate-to-drive-the-conversion-of-bpf2go">3.3. Using go generate to drive the conversion of bpf2go</h3>
<p>In terms of code generation, the Go toolchain provides the go generate tool natively, and the cilium/ebpf examples also use go generate to drive bpf2go to convert bpf programs to Go source files. Let&rsquo;s do a little transformation here as well.</p>
<p>First we add a go:generate instruction line to the main function of main.go.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// github.com/bigwhite/experiments/ebpf-examples/helloworld-go/main.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// $BPF_CLANG, $BPF_CFLAGS and $BPF_HEADERS are set by the Makefile.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:generate bpf2go -cc $BPF_CLANG -cflags $BPF_CFLAGS -target bpfel,bpfeb bpf helloworld.bpf.c -- -I $BPF_HEADERS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stopper</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This way when we explicitly execute the go generate statement, go generate will scan for that instruction statement and execute the command that follows. Several variables are used here, which are defined in the Makefile. Of course, if you don&rsquo;t want to use the Makefile, you can replace the variables with the corresponding values. Here we use the Makefile, and here is the contents of the Makefile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="err">//</span> <span class="err">github.com/bigwhite/experiments/ebpf-examples/helloworld-go/Makefile</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">CLANG</span> <span class="o">?=</span> clang-10
</span></span><span class="line"><span class="cl"><span class="nv">CFLAGS</span> <span class="o">?=</span> -O2 -g -Wall -Werror
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">LIBEBPF_TOP</span> <span class="o">=</span> /home/tonybai/go/src/github.com/cilium/ebpf
</span></span><span class="line"><span class="cl"><span class="nv">EXAMPLES_HEADERS</span> <span class="o">=</span> <span class="k">$(</span>LIBEBPF_TOP<span class="k">)</span>/examples/headers
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span> <span class="n">generate</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">generate</span><span class="o">:</span> <span class="n">export</span> <span class="n">BPF_CLANG</span>=<span class="k">$(</span><span class="nv">CLANG</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">generate</span><span class="o">:</span> <span class="n">export</span> <span class="n">BPF_CFLAGS</span>=<span class="k">$(</span><span class="nv">CFLAGS</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">generate</span><span class="o">:</span> <span class="n">export</span> <span class="n">BPF_HEADERS</span>=<span class="k">$(</span><span class="nv">EXAMPLES_HEADERS</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">generate</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    go generate ./...
</span></span></code></pre></td></tr></table>
</div>
</div><p>With this Makefile, we can execute the make command to convert bpf2go to bpf programs.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nv">$make</span>
</span></span><span class="line"><span class="cl">go generate ./...
</span></span><span class="line"><span class="cl">Compiled /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Stripped /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.o
</span></span><span class="line"><span class="cl">Wrote /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfel.go
</span></span><span class="line"><span class="cl">Compiled /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Stripped /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.o
</span></span><span class="line"><span class="cl">Wrote /home/tonybai/go/src/github.com/bigwhite/experiments/ebpf-examples/helloworld-go/bpf_bpfeb.go
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-summary">4. Summary</h2>
<ul>
<li>In this article we have explained how to develop the user state part of ebpf based on the cilium/ebpf package.</li>
<li>ebpf borrows the idea of libbpf to build the user state part of ebpf by generating code with data inline.</li>
<li>ebpf provides the bpf2go tool to convert the C source code of bpf to the corresponding go source code.</li>
<li>ebpf abstracts the bpf program into bpfObjects, completes the loading of the bpf program into the kernel by generating loadBpfObjects, and then implements the association of ebpf with kernel events using packages such as link provided by the ebpf library.</li>
<li>There are many more ways to play with ebpf packages, and this one is just to lay the groundwork. In subsequent articles, we will do further study and explanation for various types of bpf programs.</li>
<li>The code for this article can be downloaded at <a href="https://github.com/bigwhite/experiments/tree/master/ebpf-examples/helloworld-go">here</a>.</li>
</ul>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/golang/">golang</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/zig/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Getting Started with Zig Programming Language</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/docker-k8s-network-3/">
            <span class="next-text nav-default">Kubernetes &amp; Docker Networking Principles (III)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
