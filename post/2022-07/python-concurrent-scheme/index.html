<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>An in-depth comparison of Python concurrency schemes - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="This article is an in-depth comparison of Python concurrency scenarios and their advantages and disadvantages, mainly introducing the asyncio solution." /><meta name="keywords" content="python, asyncio, Coroutine" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/python-concurrent-scheme/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="An in-depth comparison of Python concurrency schemes" />
<meta property="og:description" content="This article is an in-depth comparison of Python concurrency scenarios and their advantages and disadvantages, mainly introducing the asyncio solution." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/python-concurrent-scheme/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-19T09:21:40+08:00" />
<meta property="article:modified_time" content="2022-07-19T09:21:40+08:00" />

<meta itemprop="name" content="An in-depth comparison of Python concurrency schemes">
<meta itemprop="description" content="This article is an in-depth comparison of Python concurrency scenarios and their advantages and disadvantages, mainly introducing the asyncio solution."><meta itemprop="datePublished" content="2022-07-19T09:21:40+08:00" />
<meta itemprop="dateModified" content="2022-07-19T09:21:40+08:00" />
<meta itemprop="wordCount" content="3871">
<meta itemprop="keywords" content="python," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="An in-depth comparison of Python concurrency schemes"/>
<meta name="twitter:description" content="This article is an in-depth comparison of Python concurrency scenarios and their advantages and disadvantages, mainly introducing the asyncio solution."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">An in-depth comparison of Python concurrency schemes</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-19 09:21:40 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 3871 words </span>
          <span class="more-meta"> 19 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#preface">Preface</a></li>
        <li><a href="#python-concurrency-and-parallelism-schemes">Python Concurrency and Parallelism Schemes</a>
          <ul>
            <li><a href="#multiprocess-version">Multiprocess version</a></li>
            <li><a href="#multi-threaded-version">multi-threaded version</a></li>
            <li><a href="#concurrentfutures-version">concurrent.futures version</a></li>
          </ul>
        </li>
        <li><a href="#asyncio-version">asyncio version</a>
          <ul>
            <li><a href="#coroutine">Coroutine</a></li>
            <li><a href="#asynchronous-and-concurrent">Asynchronous and Concurrent</a></li>
            <li><a href="#eventloop">EventLoop</a></li>
            <li><a href="#futuretask">Future/Task</a></li>
            <li><a href="#asyncio-solution">asyncio solution</a></li>
          </ul>
        </li>
        <li><a href="#concurrency-and-parallelism">Concurrency and parallelism</a></li>
        <li><a href="#extended-reading">Extended Reading</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="preface">Preface</h2>
<p>This article is an in-depth comparison of Python concurrency scenarios and their advantages and disadvantages, mainly introducing the asyncio solution.</p>
<p>Note: The code in this article requires Python 3.10 and above to run properly.</p>
<h2 id="python-concurrency-and-parallelism-schemes">Python Concurrency and Parallelism Schemes</h2>
<p>There are three concurrency and parallelism schemes in the Python world, as follows:</p>
<ol>
<li>multi-threading</li>
<li>multiprocessing</li>
<li>asynchronous IO (asyncio)</li>
</ol>
<p>Note: The difference between concurrency and parallelism will not be mentioned first, and will be better explained with examples at the end, and <code>concurrent.futures</code> will be mentioned later, but it is not a standalone program, so it is not listed here.</p>
<p>These solutions are designed to address performance bottlenecks with different characteristics. There are 2 main types of performance problems:</p>
<ol>
<li>
<p>CPU-intensive (CPU-bound). This refers to computationally intensive tasks that require a large amount of computation. Examples include the execution of various methods of Python&rsquo;s built-in objects, scientific computation, video transcoding, and so on.</p>
</li>
<li>
<p>I/O-intensive (I/O-bound). Tasks that involve network, memory access, disk I/O, etc. are IO-intensive tasks, which are characterized by low CPU consumption and spend most of their time waiting for I/O operations to complete. Examples include database connections, Web services, file reading and writing, and so on.</p>
</li>
</ol>
<p>If you don&rsquo;t know what type of task a task is, my experience is that you ask yourself, if you are given a better and faster CPU it can be faster, then it is a CPU intensive task, otherwise it is an I/O intensive task.</p>
<p><strong>For CPU-intensive tasks, there is only one optimization solution, which is to use multiple processes to make full use of multi-core CPUs to complete the task together to achieve speedup. For I/O-intensive tasks, all three options are possible</strong>.</p>
<p>Let&rsquo;s take a small example of crawling a web page and writing it locally (a typical I/O-intensive task) to break down and compare each of these options.</p>
<p>Let&rsquo;s look at the example first:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://movie.douban.com/top250?start=&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36&#39;</span>  <span class="c1"># noqa</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}{</span><span class="n">page</span><span class="o">*</span><span class="mi">25</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;top250-</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">fetch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this example, the requests library is used to crawl 25 pages of the Douban Top250 (each page shows 10 movies). The different pages are requested sequentially, and it takes 3.9 seconds in total.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">time</span> python io_non_concurrent.py
</span></span><span class="line"><span class="cl">python io_non_concurrent.py  0.23s user 0.05s system 7% cpu 3.911 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>This speed though still looks good, on the one hand, Douban did a good job of optimizing, on the one hand, my home bandwidth network speed is also relatively good. Then optimize with the above three options to see the effect.</p>
<h3 id="multiprocess-version">Multiprocess version</h3>
<p>The Python interpreter uses a single process, which is actually quite wasteful if the server or your computer is multi-core, so you can speed it up by multi-processing.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="p">(</span><span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="p">[(</span><span class="n">session</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">)])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Note: The above code has been omitted and only the changed part is shown here.</p>
<p>Using a multi-process pool, but without specifying the number of processes, 10 processes are started to work together according to the number of cores of the Macbook. It takes the following time.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">time</span> python use_multiprocessing.py
</span></span><span class="line"><span class="cl">python use_multiprocessing.py  2.15s user 0.30s system 232% cpu 1.023 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>Multiprocessing can theoretically have a tenfold efficiency gain, since 10 processes are executing tasks together. Of course, since the number of tasks is 25, not an integer multiple, it is not possible to achieve a 10x reduction in elapsed time, and since the crawl is too fast to fully show the efficiency gain under the multi-process scheme, it takes 1 second, which is about a 4x efficiency gain.</p>
<p>There is no obvious disadvantage in a multi-process solution, as long as the machine is strong enough, it can be faster.</p>
<h3 id="multi-threaded-version">multi-threaded version</h3>
<p>The Python interpreter is not thread-safe, so Python has designed GIL: Get a GIL lock to access Python objects in a thread. So at any one time, only one thread can execute the code, so it won&rsquo;t trigger a Race Condition. Although there are many problems with GIL, there are advantages to GIL, such as simplifying memory management, etc. These are not the focus of this article, so I won&rsquo;t expand on them.</p>
<p>So one might ask, what is the reason why multiple threads can improve concurrency efficiency, since there is always only one thread working at the same time?</p>
<p>A good explanation of this is given in <code>Understanding the Python GIL</code> at link 1 (note that we&rsquo;re talking about the new Python 3.2 GIL, not the old Python2 GIL, which has a lot of outdated descriptions on the web. You can also check out the article at extended reading link 2 to help understand the differences), and I&rsquo;ll take a few of the PPT images to illustrate.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/19/95583434e5834617a2e9a35425b055c6.png" alt="Understanding the Python GIL"></p>
<p>In the above diagram, there was only 1 thread, so there was no need to release or get a GIL, but then there was a second thread, so there were multiple threads, and at first thread 2 was hung because it didn&rsquo;t have a GIL.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/19/6236b5c4c1124ed5b569bfc615bc5c03.png" alt="Understanding the Python GIL"></p>
<p>Thread 1 voluntarily abandons the GIL during a <code>cv_wait</code> cycle, for example, if there is an I/O block, or if it times out, it triggers a GIL release. (Threads can&rsquo;t keep holding, even if there is no I/O blocking in a cycle, they have to release execution rights, the default time is 5 milliseconds, which can be set via <code>sys.setswitchinterval</code>, of course you have to know what you are doing before setting)</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/19/18fa9b14a8ed4280ac797e0a1487e80b.png" alt="Understanding the Python GIL"></p>
<p>Here is a regular example (non-timeout forced release), in the cv_wait phase, thread 1 will send a signal to thread 2 because it encounters an I/O block, then thread 1 gives up the GIL and hangs, while thread 2 gets the GIL, and so on, after which thread 2 will release the GIL to thread 1.</p>
<p>This PPT is very well known in the industry, so we suggest you take a look at it. After the PPT also lists the processing of the timeout, because and we are a little far away from this article also do not expand, interested in the next look. btw, I first look at this PPT think this timeout time is terrible, that is, 1 second to switch at least 200 times, which is too wasteful, so you can try to adjust the timeout time in the code.</p>
<p>As you can understand from the above, multithreading is controlled by GIL, each thread gets a better timing of execution, so there is no blocking by a thread task all the time, because if a thread encounters blocking it will voluntarily give up GIL to let itself hang and give the opportunity to other threads, which improves the overall efficiency of executing tasks. <strong>The perfect scenario in multi-threaded mode is that the corresponding threads are doing something at any point in time, rather than having threads that are actually waiting to be executed, but are actually blocked.</strong></p>
<p>Let&rsquo;s look at the multi-threaded scenario:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="p">(</span><span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="p">[(</span><span class="n">session</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">)])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here are 2 points:</p>
<ol>
<li>I used <code>pool</code> in both the multi-process and multi-threaded examples, which is a good habit because too many threads bring extra overhead, including creation and destruction overhead, scheduling overhead, etc., and also reduce the overall performance of the computer. Use a thread pool to maintain multiple threads waiting for the supervisor to assign tasks that can be executed concurrently. This avoids the cost of creating and destroying threads while processing tasks on the one hand, and avoids the over-scheduling problems caused by an inflated number of threads on the other, ensuring full utilization of the kernel. In addition, the process pool and thread pool implementations in the standard library write very little additional code, and the code structure is still very similar, which makes it particularly suitable for writing comparative examples.</li>
<li><code>processes</code>, if not specified, is also consistent with the number of CPU cores 10, but not the more threads the better, because more threads, but the normal effective execution is forced to release by the GIL, which causes the redundant context switch is a burden.</li>
</ol>
<p>In this example, the number of threads is 5, which is actually the result of experience on the one hand, and debugging values on the other, so this also exposes the problem that multi-threaded programming can be poorly optimized if you are not careful, and there is no optimal value found, because <strong>GIL control of threads is a black-box operation that developers cannot directly control</strong> , which is very unfriendly even to some relatively experienced Python developers.</p>
<p>Let&rsquo;s see how long it takes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">time</span> python use_threading.py
</span></span><span class="line"><span class="cl">python use_threading.py  0.62s user 0.24s system 74% cpu 1.157 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the multi-threaded solution is more than twice as fast as the original one. However, it is a little bit worse than the multi-process solution (in fact, I think it is much worse in the real example). This is because in the multi-processing scheme, the multi-core CPUs are working independently, while the multi-threading scheme cannot use so many threads due to the efficiency problem on the one hand, and due to the GIL limitation, the GIL is still forced to be released when it is not needed, so the process of constant switching reduces the efficiency and makes the effect much less effective.</p>
<h3 id="concurrentfutures-version">concurrent.futures version</h3>
<p>By the way, I would like to mention the <code>concurrent.futures</code> scheme. It&rsquo;s not a completely new solution, it&rsquo;s a framework that has been around for a long time in other languages (e.g. Java) to control the start, execution and shutdown of threads. I understand it as abstracting the code of multi-process pools and multi-thread pools, so that developers don&rsquo;t need to focus on the specifics and usage of multi-thread and multi-process modules. It&rsquo;s not that hard to understand, you can break it down like this:</p>
<p>For example, ThreadPoolExecutor can be broken down as follows: <code>ThreadPoolExecutor = Thread + Pool + Executor</code>, which is actually Thread + Pool + Executor. The Executor decouples task submission from task execution, and it does both the thread provisioning (how and when) and the task execution part.</p>
<p>If you want to know more about it, I recommend reading the comments in the header of the source code file, which explains the data flow in great detail and is more in-depth and accurate than any technical article.</p>
<p>Here is just a demonstration of the usage of ThreadPoolExecutor:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">fetch</span><span class="p">,</span> <span class="n">session</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">)))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Is it familiar? The interface is very similar to the process pool thread pool used above, but note that max_workers is the number of CPUs + 4 if not specified, with a maximum of 32. It is the same as the multi-threaded usage problem, and this max_workers needs to be tuned (for comparison, so the same value is used here).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">time</span> python use_executor.py
</span></span><span class="line"><span class="cl">python use_executor.py  0.63s user 0.32s system 82% cpu 1.153 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>Although <code>concurrent.futures</code> is now the more mainstream solution, in my experience it is slightly less efficient than code that directly uses process or thread pools, because it is highly abstract but makes things more complicated, for example by using the corresponding queue (queue module) and semaphore, which limits the performance gains. So my advice is that Python beginners can use it, but advanced developers should control their own concurrency implementation.</p>
<h2 id="asyncio-version">asyncio version</h2>
<p>The previous multithreading solutions required the developer to find an optimal number of threads (or multiple threads) based on experience or experimentation, and this value varied greatly from scenario to scenario, which was very unfriendly to beginners and made it very easy to get into a situation where you were using multithreading, but using it wrong or not using it well enough.</p>
<p>Python later introduced a new concurrency model: aysncio, and this section explains why the latest asyncio scheme is a better choice. Let&rsquo;s start with the one-page PPT from Understanding the Python GIL.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/07/19/34abec69877640aaaffbeeb1d558bb8f.png" alt="Understanding the Python GIL"></p>
<p>Let&rsquo;s recall that it mentions that when there is only a single thread, GIL is not actually triggered and this separate thread can keep executing. This is where asyncio finds its entry point: because it is single-process and single-threaded, it is theoretically not subject to GIL. With an event-driven mechanism, the performance of single-threaded threads can be better exploited, especially since the await keyword allows the developer to decide the scheduling scheme himself, instead of the multi-threaded one controlled by the GIL.</p>
<p>Then imagine that in the best case, all await places are potentially I/O blocking. Then, during execution, when I/O blocking is encountered, the Coroutine can be switched to perform other tasks that can continue, so the thread is always working without blocking, so to speak, at 100% utilization! This is something that can never be achieved with a multi-threaded solution.</p>
<p>With this in mind, let&rsquo;s go back and reorganize and understand it again, starting with the basic theory.</p>
<h3 id="coroutine">Coroutine</h3>
<p>Coroutine is a special function that adds the async keyword in front of the original def keyword, essentially it is a generator function that can generate values or receive values sent from outside (via the send method), but its most important feature is that it can save context (or state) when needed, hang itself and give control to the caller, and since it can be executed again in the future because it saves the context at the time of the hang.</p>
<p>In fact, it does not execute immediately when the Coroutine is called:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">a</span><span class="p">()</span>  <span class="c1"># is not executed, it just returns the Coroutine object</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">coroutine</span> <span class="nb">object</span> <span class="n">a</span> <span class="n">at</span> <span class="mh">0x10444aa40</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">await</span> <span class="n">a</span><span class="p">()</span>  <span class="c1"># Use await to actually execute</span>
</span></span><span class="line"><span class="cl"><span class="n">Called</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="asynchronous-and-concurrent">Asynchronous and Concurrent</h3>
<p>Asynchronous, non-blocking, and concurrent are words that can easily confuse people. Combined with the asyncio scenario, my understanding is:</p>
<ol>
<li>coroutines are executed asynchronously, in asyncio, a coroutine can [pause] itself while waiting for the result of execution, so that other coroutines can run simultaneously.</li>
<li>asynchronous allows execution without waiting for the blocking logic to complete before allowing other code to run at the same time, so it will not [block] other code, then it is [non-blocking] code</li>
<li>When a program written in asynchronous code executes, it looks like all the tasks in it are executing and completing at the same time (because it switches between waiting), so it looks [concurrent].</li>
</ol>
<h3 id="eventloop">EventLoop</h3>
<p>Event Loop is a concept that I have actually understood for many years, since the Twisted era. I always thought it was very mysterious and complicated, but now it seems that I was actually overthinking. For beginners, it&rsquo;s better to think differently, it&rsquo;s all about Event + Loop: Loop is a ring, each task is placed on this ring as an event, and the event will keep looping and trigger the execution of the event when the conditions are met. It has the following features:</p>
<ol>
<li>an event loop runs in a thread</li>
<li>Awaitables (coroutine, Task, Future are mentioned below) can be registered to the event loop</li>
<li>if another coroutine is called in the coroutine (via await), the coroutine will hang and a context switch will occur to execute the other coroutine, and so on</li>
<li>if the coroutine encounters I/O blocking while executing, the coroutine will hang with the context and give control back to EventLoop</li>
<li>Since it is a loop, the loop will restart after all registered events are executed</li>
</ol>
<h3 id="futuretask">Future/Task</h3>
<p><code>asyncio.Future</code> I think is like the Javascript <code>Promise</code>, it is a placeholder object that represents something that is not yet done and will be implemented or completed in the future (and of course may throw an exception due to an internal error). It is very similar to <code>concurrent.futures.Futures</code> implemented in the <code>concurrent.futures</code> scheme mentioned above, but with a lot of customizations for asyncio&rsquo;s event loop. <code>asyncio.Future</code> which is just a container for data.</p>
<p><code>asyncio.Task</code> is a subclass of <code>asyncio.Future</code>, which is used to run coroutines in event loops.</p>
<p>A very intuitive example is mentioned in the official documentation, which I rewrite here to execute and illustrate inside IPython.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">set_after</span><span class="p">(</span><span class="n">fut</span><span class="p">):</span>  <span class="c1"># Create a Coroutine that will asynchronously sleep for 3 seconds and then set the result for the future object</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>  <span class="c1"># Get the current event loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">fut</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>  <span class="c1"># Create a Future in the event loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">fut</span>  <span class="c1"># At this point it is still in the default pending state, because it is not called</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Future</span> <span class="n">pending</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">task</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">set_after</span><span class="p">(</span><span class="n">fut</span><span class="p">))</span>  <span class="c1"># A task is created (or registered) in the event loop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">task</span>  <span class="c1"># Enter it immediately, when the task has just been created and is still being executed</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Task</span> <span class="n">pending</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Task-3044&#39;</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">set_after</span><span class="p">()</span> <span class="n">running</span> <span class="n">at</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">51</span><span class="o">-</span><span class="mi">1</span><span class="n">fd5c9e97768</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">wait_for</span><span class="o">=&lt;</span><span class="n">Future</span> <span class="n">pending</span> <span class="n">cb</span><span class="o">=</span><span class="p">[</span><span class="o">&lt;</span><span class="n">TaskWakeupMethWrapper</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1054d32b0</span><span class="o">&gt;</span><span class="p">()]</span><span class="o">&gt;&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">fut</span>  <span class="c1"># Immediately enter it, at this time the task has just been created, not yet finished execution so the future has not changed</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Future</span> <span class="n">pending</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">task</span>  <span class="c1"># After three seconds, mission execution is complete</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Task</span> <span class="n">finished</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Task-3044&#39;</span> <span class="n">coro</span><span class="o">=&lt;</span><span class="n">set_after</span><span class="p">()</span> <span class="n">done</span><span class="p">,</span> <span class="n">defined</span> <span class="n">at</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">51</span><span class="o">-</span><span class="mi">1</span><span class="n">fd5c9e97768</span><span class="o">&gt;</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">fut</span>  <span class="c1"># Future has also set the result, so the status is finished</span>
</span></span><span class="line"><span class="cl"><span class="n">Out</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">Future</span> <span class="n">finished</span> <span class="n">result</span><span class="o">=</span><span class="s1">&#39;Done&#39;</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can feel:</p>
<ol>
<li>the Future object is not a task, but a container for state</li>
<li><code>create_task</code> will let the event loop schedule the execution of the Coroutine</li>
<li>you can use <code>ensure_future</code> and <code>create_task</code> to create tasks, <code>ensure_future</code> is a more advanced wrapper, but Python 3.7 and above should use <code>create_task</code></li>
</ol>
<p>The next step is to understand what await does. If a Future object is awaited in the Coroutine, the Task will pause the execution of the Coroutine and wait for the completion of the Future. When the Future completes, the execution of the wrapped Coroutine will continue.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">a</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IN a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="k">await</span> <span class="n">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="k">await</span> <span class="n">c</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OUT a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">b</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IN b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="k">await</span> <span class="n">d</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OUT b&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">c</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IN c&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OUT c&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="k">async</span> <span class="k">def</span> <span class="nf">d</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IN d&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>     <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OUT d&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">In</span> <span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">a</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">IN</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl"><span class="n">IN</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="n">IN</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">OUT</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">OUT</span> <span class="n">b</span>
</span></span><span class="line"><span class="cl"><span class="n">IN</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl"><span class="n">OUT</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl"><span class="n">OUT</span> <span class="n">a</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this example, the entry function of a, which calls b and c, will in turn call d. await will allow the corresponding Coroutine to obtain execution privileges. await within the Coroutine will not release privileges until all other Coroutines are executed, so note that this is more like DFS (depth-first search), so the order of execution is a-&gt;b-&gt;d-&gt;c.</p>
<p>So here&rsquo;s the conclusion :</p>
<p><strong>The event loop is responsible for the Coroutine scheduling of the concurrent process: the event loop runs one task at a time. While a task waits for an Awaitables object to complete, the event loop runs other tasks, callbacks, or performs IO operations.</strong></p>
<h3 id="asyncio-solution">asyncio solution</h3>
<p>In the asyncio scheme, all libraries that involve I/O blocking operations have to use libraries from the aio ecosystem, so you can no longer use the requests library, but need to use aiohttp, and file operations need to use aiofiles.</p>
<p>The final code is as follows (the 2 packages need to be downloaded for use).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiofiles</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">aiohttp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}{</span><span class="n">page</span><span class="o">*</span><span class="mi">25</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;top250-</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Look at the efficiency:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">➜ <span class="nb">time</span> python use_asyncio.py
</span></span><span class="line"><span class="cl">python use_asyncio.py  0.20s user 0.04s system 34% cpu 0.684 total
</span></span></code></pre></td></tr></table>
</div>
</div><p>So the advantages of asyncio are as follows:</p>
<ol>
<li>asyncio, when used well, is the fastest of these concurrency solutions.</li>
<li><strong>It supports thousands of active connections</strong>, which can perform well in scenarios like websockets and MQTT, whereas multi-threaded solutions can have serious performance problems at this scale of thread count.</li>
<li>the multi-threaded solution has implicit thread switching, and we cannot confirm when it will switch thread execution rights, so it is very prone to Race Condition. In contrast, the Coroutine switch in the asyncio scheme is explicit and explicit, and the developer can explicitly know or specify the order of execution.</li>
</ol>
<h2 id="concurrency-and-parallelism">Concurrency and parallelism</h2>
<p>I found a statement comparing these solutions (extension 4), which also mentions concurrency and parallelism in a particularly graphic way, so I&rsquo;ll clarify it:</p>
<ol>
<li>multiple processes. 10 kitchens, 10 cooks, 10 dishes. It is also 1 kitchen 1 cook to make 1 dish.</li>
<li>multi-threaded. 1 kitchen, 10 cooks, 10 dishes. Because the kitchen is relatively small, we can only squeeze in together, in fact, we take turns, and when one cook is doing it, the others have to wait for their turn.</li>
<li>asyncio. 1 kitchen, 1 cook, 10 dishes. It sounds like this is a sequential execution, but in fact, when a dish needs to be braised or whatever other time-consuming cooking method, other dishes can be made or prepared at the same time, and the best scenario is that this chef is always busy doing it.</li>
</ol>
<p>For concurrency and parallelism I recommend reading the article in Extension Connection 3. Concurrency allows the simultaneous execution of multiple tasks that may access the same shared resources, such as the hard disk, the network, and the corresponding single-core CPU. since there will be access to shared resources, there may be a race condition, so there is in fact only one task executing at a given point in time. in essence the goal is to prevent tasks from blocking each other by switching between them when a task is forced to wait for external resources. In essence, the goal is to prevent tasks from blocking each other by switching between them when a task is forced to wait for an external resource. Parallelism refers to multiple tasks running in parallel on independently partitioned resources (e.g., multiple CPU cores), which maximizes the use of hardware resources.</p>
<h2 id="extended-reading">Extended Reading</h2>
<ol>
<li><a href="https://speakerdeck.com/dabeaz/understanding-the-python-gil">https://speakerdeck.com/dabeaz/understanding-the-python-gil</a></li>
<li><a href="https://www.datacamp.com/tutorial/python-global-interpreter-lock">https://www.datacamp.com/tutorial/python-global-interpreter-lock</a></li>
<li><a href="https://www.infoworld.com/article/3632284/python-concurrency-and-parallelism-explained.html">https://www.infoworld.com/article/3632284/python-concurrency-and-parallelism-explained.html</a></li>
<li><a href="https://leimao.github.io/blog/Python-Concurrency-High-Level/">https://leimao.github.io/blog/Python-Concurrency-High-Level/</a></li>
</ol>
<p>The code for this article can be found in the <a href="https://github.com/dongweiming/mp/tree/master/2022-07-19">mp</a> project.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/ceph-cookbook/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Ceph Cookbook</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/go-nocopy/">
            <span class="next-text nav-default">NoCopy in Golang</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
