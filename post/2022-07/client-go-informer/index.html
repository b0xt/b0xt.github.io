<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Troubleshoot client-go informer cache invalidation issue - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Explore how to solve the client-go informer cache invalidation problem." /><meta name="keywords" content="client-go, informer cache invalidation" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-07/client-go-informer/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Troubleshoot client-go informer cache invalidation issue" />
<meta property="og:description" content="Explore how to solve the client-go informer cache invalidation problem." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-07/client-go-informer/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-15T12:45:25+08:00" />
<meta property="article:modified_time" content="2022-07-15T12:45:25+08:00" />

<meta itemprop="name" content="Troubleshoot client-go informer cache invalidation issue">
<meta itemprop="description" content="Explore how to solve the client-go informer cache invalidation problem."><meta itemprop="datePublished" content="2022-07-15T12:45:25+08:00" />
<meta itemprop="dateModified" content="2022-07-15T12:45:25+08:00" />
<meta itemprop="wordCount" content="2253">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Troubleshoot client-go informer cache invalidation issue"/>
<meta name="twitter:description" content="Explore how to solve the client-go informer cache invalidation problem."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Troubleshoot client-go informer cache invalidation issue</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-07-15 12:45:25 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2253 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#problem-location">Problem Location</a>
          <ul>
            <li><a href="#problem-replication">Problem Replication</a></li>
            <li><a href="#status-analysis">Status analysis</a></li>
            <li><a href="#log-analysis">Log analysis</a></li>
            <li><a href="#code-analysis">Code Analysis</a></li>
          </ul>
        </li>
        <li><a href="#solution">Solution</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="background">Background</h2>
<p>Elastic Cloud online services have long been plagued by cache inconsistency.</p>
<p>The occurrence of cache inconsistency is usually accompanied by the upgrade or restart of the kube-apiserver. When cache inconsistency occurs, the user side can perceive it more obviously, and the problem can cause online service failure when it is serious. The common failures are as follows.</p>
<ul>
<li>Platform data inconsistency: Pod status is normal at one time and abnormal at another, and bounces back and forth.</li>
<li>Loss of service management events: when the service changes, the service management does not work normally, such as service tree is not mounted, traffic is not accessed, etc.</li>
</ul>
<p>Before the problem is located, Elastic Cloud has developed many problem-aware and timely stop-loss strategies.</p>
<ul>
<li>Problem perception.
<ul>
<li>Manual: When kube-apiserver is upgraded or restarted, manually notify the associated party to also restart the platform service</li>
<li>Smart: Configure monitoring and alerting policies to send alert messages when no change events are received for k8s objects for a period of time</li>
</ul>
</li>
<li>Timely stop loss.
<ul>
<li>Restart: restart the service when cache inconsistency issue occurs and pull the latest data from kube-apiserver in full</li>
<li>Self-healing: In some scenarios, even if the service is restarted, it cannot be fully recovered, so add a self-healing policy to proactively sense and handle abnormal situations.</li>
</ul>
</li>
</ul>
<p>Problem-aware and stop-loss strategies do not really solve the problem, but only try to restore service in deterministic scenarios, and along with the discovery of more anomalous scenarios, the strategies need to be adjusted in parallel.</p>
<h2 id="problem-location">Problem Location</h2>
<p>Perception and stopping is a fix similar to mending, and obviously, we would prefer a complete solution to the problem. So, let&rsquo;s start with the root cause of the cache inconsistency.</p>
<p>We choose notifier to troubleshoot the problem. Notifier is a collection of controllers for cluster management services, and its functionality consists mainly of</p>
<ul>
<li>Service tree mounts</li>
<li>DNS registration</li>
<li>LVS pickup flow, etc.</li>
</ul>
<p>The reason for choosing notifier is its simplicity: notifier uses client-go&rsquo;s informer and registers processing functions for core resource events; in addition, there are no complex business processes to interfere with troubleshooting.</p>
<h3 id="problem-replication">Problem Replication</h3>
<p>We tested in our offline environment and found that the kube-apiserver service was able to reproduce the problem after restarting, which gave us a great convenience to troubleshoot the problem. So the steps to reproduce the problem are as follows.</p>
<ul>
<li>Start the notifier service</li>
<li>Restart the kube-apiserver service</li>
</ul>
<h3 id="status-analysis">Status analysis</h3>
<p>When the problem occurs, we first do some basic checks on the service status.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># #服务存活状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ps -ef|grep notifier</span>
</span></span><span class="line"><span class="cl">stupig <span class="m">1007922</span> <span class="m">1003335</span>  <span class="m">2</span> 13:41 pts/1    00:00:08 ./notifier -c configs/notifier-test.toml
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1"># #服务FD打开状态</span>
</span></span><span class="line"><span class="cl"><span class="c1"># lsof -nP -p 1007922</span>
</span></span><span class="line"><span class="cl">COMMAND       PID       USER   FD      TYPE             DEVICE SIZE/OFF        NODE NAME
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   0u       CHR              136,1      0t0           <span class="m">4</span> /dev/pts/1
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   1u       CHR              136,1      0t0           <span class="m">4</span> /dev/pts/1
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   2u       CHR              136,1      0t0           <span class="m">4</span> /dev/pts/1
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   3u      unix 0xffff8810a3132400      0t0  <span class="m">4254094659</span> socket
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   4u   a_inode                0,9        <span class="m">0</span>        <span class="m">8548</span> <span class="o">[</span>eventpoll<span class="o">]</span>
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   5r      FIFO                0,8      0t0  <span class="m">4253939077</span> pipe
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   6w      FIFO                0,8      0t0  <span class="m">4253939077</span> pipe
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   8u      IPv4         <span class="m">4254094660</span>      0t0         UDP *:37087
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   9r       CHR                1,9      0t0        <span class="m">2057</span> /dev/urandom
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   10u     IPv4         <span class="m">4253939079</span>      0t0         TCP *:4397 <span class="o">(</span>LISTEN<span class="o">)</span>
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   11u      REG               8,17 <span class="m">12538653</span>  <span class="m">8604570895</span> ./logs/notifier.stupig.log.INFO.20211127-134138.1007922
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   15u     IPv4         <span class="m">4254204931</span>      0t0         TCP 127.0.0.1:43566-&gt;127.0.0.1:2479 <span class="o">(</span>ESTABLISHED<span class="o">)</span>   <span class="c1"># ETCD</span>
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   19u      REG                8,5   <span class="m">252384</span>         <span class="m">821</span> /tmp/notifier.stupig.log.ERROR.20211127-134505.1007922
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   20u      REG                8,5   <span class="m">252384</span>         <span class="m">822</span> /tmp/notifier.stupig.log.WARNING.20211127-134505.1007922
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   21u      REG               8,17   <span class="m">414436</span>  <span class="m">8606917935</span> ./logs/notifier.stupig.log.WARNING.20211127-134139.1007922
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   24u      REG               8,17   <span class="m">290725</span>  <span class="m">8606917936</span> ./logs/notifier.stupig.log.ERROR.20211127-134238.1007922
</span></span><span class="line"><span class="cl">nobody    <span class="m">1007922</span>     stupig   30u      REG                8,5   <span class="m">252384</span>         <span class="m">823</span> /tmp/notifier.stupig.log.INFO.20211127-134505.1007922
</span></span></code></pre></td></tr></table>
</div>
</div><p>Comparing the service status information before the problem occurred, we found a serious problem. The connection established between notifier and the kube-apiserver service address: <code>https://localhost:6443</code> disappeared.</p>
<p>As a result, the notifier lost data synchronization with the kube-apiserver, and subsequently the notifier did not sense business change events and eventually lost the ability to manage the service.</p>
<h3 id="log-analysis">Log analysis</h3>
<p>Now we analyze the notifier&rsquo;s operational logs, focusing on the logs printed by the notifier when the kube-apiserver restarts, where the key log messages are as follows.</p>
<p>The above shows the key exception message <code>http2: no cached connection was available</code>, and the associated operation is the EndpointInformer&rsquo;s ListAndWatch operation.</p>
<p>Here we have the key clue, and the next step is to analyze the code to locate the root cause.</p>
<h3 id="code-analysis">Code Analysis</h3>
<p>The introduction of the working mechanism of Informer is not the focus of this article, we will only focus on the following code snippet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run starts a watch and handles watch events. Will restart the watch if it is closed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Run will exit when stopCh is closed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Reflector</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Starting reflector %v (%s) from %s&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">expectedType</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">resyncPeriod</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">ListAndWatch</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span> <span class="nx">r</span><span class="p">.</span><span class="nx">period</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The Informer&rsquo;s Reflector component runs in a separate goroutine and recursively calls ListAndWatch to receive notification events from the kube-apiserver.</p>
<p>We conclude from the log analysis that all ListAndWatch operations of the notifier service return the <code>http2: no cached connection was available</code> error when the kube-apiserver service is restarted.</p>
<p>Therefore, we shifted our focus to this error message.</p>
<p>By searching through the code, we were able to locate the location of the error and where it was returned.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/transport.go:L301
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">ErrNoCachedConn</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http2: no cached connection was available&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/client_conn_pool.go:L55~80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">clientConnPool</span><span class="p">)</span> <span class="nf">getClientConn</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dialOnMiss</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nf">isConnectionCloseRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">dialOnMiss</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// It gets its own connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">const</span> <span class="nx">singleUse</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">dialClientConn</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">singleUse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">conns</span><span class="p">[</span><span class="nx">addr</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">CanTakeNewRequest</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">!</span><span class="nx">dialOnMiss</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrNoCachedConn</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">call</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">getStartDialLocked</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="o">&lt;-</span><span class="nx">call</span><span class="p">.</span><span class="nx">done</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">call</span><span class="p">.</span><span class="nx">res</span><span class="p">,</span> <span class="nx">call</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code returns <code>ErrNoCachedConn</code> with the following condition</p>
<ul>
<li>The parameter dialOnMiss has a value of false</li>
<li>No connection available in the p.conns connection pool</li>
</ul>
<p>Theoretically, when sending an http request, if the connection pool is empty, a connection will be established first and then the request will be sent; and the connection pool can automatically reject connections with abnormal status. So how does the problem of concern in this article sometimes happen?</p>
<p>Now we focus on the call chain of the <code>getClientConn</code> method, which has two main.</p>
<p>Stack one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0  0x0000000000a590b8 in notifier/vendor/golang.org/x/net/http2.(*clientConnPool).getClientConn
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/client_conn_pool.go:55
</span></span><span class="line"><span class="cl"> 1  0x0000000000a5aea6 in notifier/vendor/golang.org/x/net/http2.noDialClientConnPool.GetClientConn
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/client_conn_pool.go:255
</span></span><span class="line"><span class="cl"> 2  0x0000000000a6c4f9 in notifier/vendor/golang.org/x/net/http2.(*Transport).RoundTripOpt
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/transport.go:345
</span></span><span class="line"><span class="cl"> 3  0x0000000000a6bd0e in notifier/vendor/golang.org/x/net/http2.(*Transport).RoundTrip
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/transport.go:313
</span></span><span class="line"><span class="cl"> 4  0x0000000000a5b97e in notifier/vendor/golang.org/x/net/http2.noDialH2RoundTripper.RoundTrip
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/configure_transport.go:75
</span></span><span class="line"><span class="cl"> 5  0x0000000000828e45 in net/http.(*Transport).roundTrip
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/transport.go:537
</span></span><span class="line"><span class="cl"> 6  0x00000000008016de in net/http.(*Transport).RoundTrip
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/roundtrip.go:17
</span></span><span class="line"><span class="cl"> 7  0x00000000016a1ef8 in notifier/vendor/k8s.io/client-go/transport.(*userAgentRoundTripper).RoundTrip
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/transport/round_trippers.go:162
</span></span><span class="line"><span class="cl"> 8  0x00000000007a3aa2 in net/http.send
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:251
</span></span><span class="line"><span class="cl"> 9  0x00000000007a324b in net/http.(*Client).send
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:175
</span></span><span class="line"><span class="cl">10  0x00000000007a6ed5 in net/http.(*Client).do
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:717
</span></span><span class="line"><span class="cl">11  0x00000000007a5d9e in net/http.(*Client).Do
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:585
</span></span><span class="line"><span class="cl">12  0x00000000016b9487 in notifier/vendor/k8s.io/client-go/rest.(*Request).request
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/rest/request.go:732
</span></span><span class="line"><span class="cl">13  0x00000000016b9f2d in notifier/vendor/k8s.io/client-go/rest.(*Request).Do
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/rest/request.go:804
</span></span><span class="line"><span class="cl">14  0x00000000017093bb in notifier/vendor/k8s.io/client-go/kubernetes/typed/core/v1.(*endpoints).List
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/kubernetes/typed/core/v1/endpoints.go:83
</span></span><span class="line"><span class="cl">……
</span></span></code></pre></td></tr></table>
</div>
</div><p>Stack two.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">0  0x0000000000a590b8 in notifier/vendor/golang.org/x/net/http2.(*clientConnPool).getClientConn
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/client_conn_pool.go:55
</span></span><span class="line"><span class="cl"> 1  0x0000000000a5aea6 in notifier/vendor/golang.org/x/net/http2.noDialClientConnPool.GetClientConn
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/client_conn_pool.go:255
</span></span><span class="line"><span class="cl"> 2  0x0000000000a6c4f9 in notifier/vendor/golang.org/x/net/http2.(*Transport).RoundTripOpt
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/transport.go:345
</span></span><span class="line"><span class="cl"> 3  0x0000000000a6bd0e in notifier/vendor/golang.org/x/net/http2.(*Transport).RoundTrip
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/golang.org/x/net/http2/transport.go:313
</span></span><span class="line"><span class="cl"> 4  0x00000000008296ed in net/http.(*Transport).roundTrip
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/transport.go:590
</span></span><span class="line"><span class="cl"> 5  0x00000000008016de in net/http.(*Transport).RoundTrip
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/roundtrip.go:17
</span></span><span class="line"><span class="cl"> 6  0x00000000016a1ef8 in notifier/vendor/k8s.io/client-go/transport.(*userAgentRoundTripper).RoundTrip
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/transport/round_trippers.go:162
</span></span><span class="line"><span class="cl"> 7  0x00000000007a3aa2 in net/http.send
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:251
</span></span><span class="line"><span class="cl"> 8  0x00000000007a324b in net/http.(*Client).send
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:175
</span></span><span class="line"><span class="cl"> 9  0x00000000007a6ed5 in net/http.(*Client).do
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:717
</span></span><span class="line"><span class="cl">10  0x00000000007a5d9e in net/http.(*Client).Do
</span></span><span class="line"><span class="cl">    at /usr/local/go1.16.7/src/net/http/client.go:585
</span></span><span class="line"><span class="cl">11  0x00000000016b9487 in notifier/vendor/k8s.io/client-go/rest.(*Request).request
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/rest/request.go:732
</span></span><span class="line"><span class="cl">12  0x00000000016b9f2d in notifier/vendor/k8s.io/client-go/rest.(*Request).Do
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/rest/request.go:804
</span></span><span class="line"><span class="cl">13  0x00000000017093bb in notifier/vendor/k8s.io/client-go/kubernetes/typed/core/v1.(*endpoints).List
</span></span><span class="line"><span class="cl">    at ./go/src/notifier/vendor/k8s.io/client-go/kubernetes/typed/core/v1/endpoints.go:83
</span></span><span class="line"><span class="cl">……
</span></span></code></pre></td></tr></table>
</div>
</div><p>After tracing the two call stacks separately, we can quickly rule out stack one.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// file: net/http/transport.go:L502~620
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">roundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">altRT</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">alternateRoundTripper</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">altRT</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>               <span class="c1">// L537
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">altRT</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">ErrSkipAltProtocol</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">   <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">rewindBody</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/configure_transport.go:L74~80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rt</span> <span class="nx">noDialH2RoundTripper</span><span class="p">)</span> <span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>                                        <span class="c1">// L75
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">ErrNoCachedConn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ErrSkipAltProtocol</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/transport.go:L312~314
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">RoundTripOpt</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">RoundTripOpt</span><span class="p">{})</span>                             <span class="c1">// L313
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/transport.go:L337~379
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">RoundTripOpt</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">opt</span> <span class="nx">RoundTripOpt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">addr</span> <span class="o">:=</span> <span class="nf">authorityAddr</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Host</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">retry</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">retry</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">connPool</span><span class="p">().</span><span class="nf">GetClientConn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>                    <span class="c1">// L345
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">t</span><span class="p">.</span><span class="nf">vlogf</span><span class="p">(</span><span class="s">&#34;http2: Transport failed to get client conn for %s: %v&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/client_conn_pool.go:L254~256
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="nx">noDialClientConnPool</span><span class="p">)</span> <span class="nf">GetClientConn</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">getClientConn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">noDialOnMiss</span><span class="p">)</span>                        <span class="c1">// L255
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Stack one call to <code>getClientConn</code> returns an <code>ErrNoCachedConn</code> error and is replaced with an <code>http.ErrSkipAltProtocol</code> error in the <code>noDialH2RoundTripper.RoundTrip</code> function, which returns the <code>roundTrip</code> function after continues with the rest of the process and goes to stack 2.</p>
<p>We therefore focus on the Stack 2 process.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// file: net/http/transport.go:L502~620
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">roundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">resp</span> <span class="o">*</span><span class="nx">Response</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// HTTP/2 path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">t</span><span class="p">.</span><span class="nf">setReqCanceler</span><span class="p">(</span><span class="nx">cancelKey</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// not cancelable with CancelRequest
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pconn</span><span class="p">.</span><span class="nx">alt</span><span class="p">.</span><span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>                             <span class="c1">// L590
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">resp</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="nx">origReq</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">      <span class="c1">// Failed. Clean up and determine whether to retry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="nf">http2isNoCachedConnError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">removeIdleConn</span><span class="p">(</span><span class="nx">pconn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">t</span><span class="p">.</span><span class="nf">decConnsPerHost</span><span class="p">(</span><span class="nx">pconn</span><span class="p">.</span><span class="nx">cacheKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">pconn</span><span class="p">.</span><span class="nf">shouldRetryRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/transport.go:L312~314
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">Transport</span><span class="p">)</span> <span class="nf">RoundTrip</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">RoundTripOpt</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">RoundTripOpt</span><span class="p">{})</span>                             <span class="c1">// L313
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="c1">// 内层调用栈同栈一，不再列出
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Unlike stack 1, stack 2 does not do a conversion on the returned error, but returns the <code>ErrNoCachedConn</code> error directly, and the error handling process of <code>roundTrip</code> also specifically handles this type of error. If <code>http2isnoCachedConnError</code> returns true, the connection pool will remove the exception connection.</p>
<p>Everything makes sense, so how does the problem occur? The problem here is <code>http2isnoCachedConnError</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// file: net/http/h2_bundle.go:L6922~6928
</span></span></span><span class="line"><span class="cl"><span class="c1">// isNoCachedConnError reports whether err is of type noCachedConnError
</span></span></span><span class="line"><span class="cl"><span class="c1">// or its equivalent renamed type in net/http2&#39;s h2_bundle.go. Both types
</span></span></span><span class="line"><span class="cl"><span class="c1">// may coexist in the same running program.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">http2isNoCachedConnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="kd">interface</span><span class="p">{</span> <span class="nf">IsHTTP2NoCachedConnError</span><span class="p">()</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">ok</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the <code>err</code> object implements the anonymous interface (only one function <code>IsHTTP2NoCachedConnError</code> is defined), then it returns true, otherwise it returns false.</p>
<p>So, does the error type returned by <code>getClientConn</code> implement that interface? Obviously: no.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// file: vendor/golang.org/x/net/http2/transport.go:L301
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">ErrNoCachedConn</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;http2: no cached connection was available&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So far, the cause of the problem has been basically located clearly.</p>
<h2 id="solution">Solution</h2>
<p>Since the problem is caused by the error type <code>ErrNoCachedConn</code> returned by <code>getClientConn</code> not implementing the <code>IsHTTP2NoCachedConnError</code> function, the natural fix is to change the returned error type and implement the interface function.</p>
<p>Note that since this part of the code is from an external code base that we referenced, we checked the latest <code>golang.org/x/net</code> code and found that the problem was fixed back in January 2018. See specifically: <a href="https://github.com/golang/net/commit/ab555f366c4508dbe0802550b1b20c46c5c18aa0">golang.org/x/net fix</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// noCachedConnError is the concrete type of ErrNoCachedConn, which
</span></span></span><span class="line"><span class="cl"><span class="c1">// needs to be detected by net/http regardless of whether it&#39;s its
</span></span></span><span class="line"><span class="cl"><span class="c1">// bundled version (in h2_bundle.go with a rewritten type name) or
</span></span></span><span class="line"><span class="cl"><span class="c1">// from a user&#39;s x/net/http2. As such, as it has a unique method name
</span></span></span><span class="line"><span class="cl"><span class="c1">// (IsHTTP2NoCachedConnError) that net/http sniffs for via func
</span></span></span><span class="line"><span class="cl"><span class="c1">// isNoCachedConnError.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">noCachedConnError</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">noCachedConnError</span><span class="p">)</span> <span class="nf">IsHTTP2NoCachedConnError</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">noCachedConnError</span><span class="p">)</span> <span class="nf">Error</span><span class="p">()</span> <span class="kt">string</span>             <span class="p">{</span> <span class="k">return</span> <span class="s">&#34;http2: no cached connection was available&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// isNoCachedConnError reports whether err is of type noCachedConnError
</span></span></span><span class="line"><span class="cl"><span class="c1">// or its equivalent renamed type in net/http2&#39;s h2_bundle.go. Both types
</span></span></span><span class="line"><span class="cl"><span class="c1">// may coexist in the same running program.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">isNoCachedConnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="kd">interface</span><span class="p">{</span> <span class="nf">IsHTTP2NoCachedConnError</span><span class="p">()</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">ok</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">ErrNoCachedConn</span> <span class="kt">error</span> <span class="p">=</span> <span class="nx">noCachedConnError</span><span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The version we are using online is still: 1c05540f6.</p>
<p>Therefore, our fix strategy has become much simpler, just upgrade the dependency library version in vendor.</p>
<p>Currently, the online notifier service has been upgraded and is fully live on all server rooms. We have also verified that the kube-apiserver restart does not cause the notifier service to be abnormal.</p>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-07/py-append/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python append() function and deep and shallow copies</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-07/firefox-apple/">
            <span class="next-text nav-default">Apple&#39;s business site blocks Firefox browser</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
