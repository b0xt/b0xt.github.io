<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Rapid deployment of Cilium BGP environments using Containerlab &#43; Kind - SoByte</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6356451834813761" crossorigin="anonymous"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-E8GRRGBTEZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-E8GRRGBTEZ');
</script>


<meta name="author" content="" /><meta name="description" content="Learn how to quickly deploy a Cilium BGP environment using Containerlab &#43; Kind." /><meta name="keywords" content="Containerlab, Kind, Cilium BGP environments" />






<meta name="generator" content="Hugo 0.102.0 with theme even" />


<link rel="canonical" href="https://www.sobyte.net/post/2022-09/containerlab-kind-cilium-bgp/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Rapid deployment of Cilium BGP environments using Containerlab &#43; Kind" />
<meta property="og:description" content="Learn how to quickly deploy a Cilium BGP environment using Containerlab &#43; Kind." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.sobyte.net/post/2022-09/containerlab-kind-cilium-bgp/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-09-02T12:09:24+08:00" />
<meta property="article:modified_time" content="2022-09-02T12:09:24+08:00" />

<meta itemprop="name" content="Rapid deployment of Cilium BGP environments using Containerlab &#43; Kind">
<meta itemprop="description" content="Learn how to quickly deploy a Cilium BGP environment using Containerlab &#43; Kind."><meta itemprop="datePublished" content="2022-09-02T12:09:24+08:00" />
<meta itemprop="dateModified" content="2022-09-02T12:09:24+08:00" />
<meta itemprop="wordCount" content="2648">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Rapid deployment of Cilium BGP environments using Containerlab &#43; Kind"/>
<meta name="twitter:description" content="Learn how to quickly deploy a Cilium BGP environment using Containerlab &#43; Kind."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">SOBYTE</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">SOBYTE</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Rapid deployment of Cilium BGP environments using Containerlab &#43; Kind</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-09-02 12:09:24 </span>
        <div class="post-category">
            <a href="/categories/tutorials/"> tutorials </a>
            </div>
          <span class="more-meta"> 2648 words </span>
          <span class="more-meta"> 13 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-pre-requisite-knowledge">1 Pre-requisite knowledge</a>
          <ul>
            <li><a href="#11-introduction-to-cilium">1.1 Introduction to Cilium</a></li>
            <li><a href="#12-introduction-to-cilium-bgp">1.2 Introduction to Cilium BGP</a></li>
            <li><a href="#13-introduction-to-kind">1.3 Introduction to Kind</a></li>
            <li><a href="#14-introduction-to-containerlab">1.4 Introduction to Containerlab</a></li>
          </ul>
        </li>
        <li><a href="#2-prerequisite-preparation">2 Prerequisite preparation</a></li>
        <li><a href="#3-starting-a-kubernetes-cluster-with-kind">3 Starting a Kubernetes Cluster with Kind</a></li>
        <li><a href="#4-start-containerlab">4 Start Containerlab</a></li>
        <li><a href="#6-configuring-bgp-on-cilium-nodes">6 Configuring BGP on Cilium Nodes</a></li>
        <li><a href="#7-verification">7 Verification</a>
          <ul>
            <li><a href="#8-clean-up-the-environment">8 Clean up the environment</a></li>
            <li><a href="#9-references">9 References</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-pre-requisite-knowledge">1 Pre-requisite knowledge</h2>
<h3 id="11-introduction-to-cilium">1.1 Introduction to Cilium</h3>
<p>Cilium is a Kubernetes CNI plug-in based on eBPF technology, which Cilium positions on its official website as being dedicated to providing a range of <strong>eBPF-based networking</strong>, <strong>observability</strong>, and <strong>security</strong> solutions for container workloads. Cilium implements networking, observability and security related features by using eBPF technology to dynamically insert control logic inside Linux that can be applied and updated without modifying application code or container configuration.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/f81d17763ff84760ae87568144aa8ad4.png" alt="Cilium"></p>
<h3 id="12-introduction-to-cilium-bgp">1.2 Introduction to Cilium BGP</h3>
<p>BGP (Border Gateway Protocol) is a dynamic routing protocol used between AS (Autonomous System), which provides rich and flexible routing control policies and was mainly used for interconnection between Internet AS in the early days. With the development of technology, BGP is now also widely used in data centers, where modern data center networks are usually based on Spine-Leaf architecture, where BGP can be used to propagate endpoint reachability information.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/ce1914c38951427794d5df15c58a3d12.png" alt="Cilium BGP"></p>
<p>The Leaf layer consists of access switches that aggregate traffic from the servers and connect directly to the Spine or network core, which interconnects to all Leaf switches in a full-mesh topology.</p>
<p>As Kubernetes is increasingly used in the enterprise, these endpoints are likely to be Kubernetes Pods, and it was clear that Cilium should introduce support for the BGP protocol in order to allow networks outside of the Kubernetes cluster to dynamically obtain routes to the Pods they are accessing via the BGP protocol.</p>
<p>BGP was initially introduced in Cilium in version 1.10, by assigning LoadBalancer-type services to applications and combining them with MetalLB to announce routing information to BGP neighbors.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/8a8491ee7f1e489ea44b77d625c9c1de.png" alt="k8s cluster"></p>
<p>However, as IPv6 usage continued to grow, it became clear that Cilium needed BGP IPv6 functionality - including Segment Routing v6 (SRv6). metalLB currently has limited support for IPv6 via FRR and is still in the experimental phase. the Cilium team evaluated various options and decided to move to the more feature-rich <strong>GoBGP [1]</strong> .</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/f0a4b1ed82974b088102238602a0ae1b.png" alt="GoBGP"></p>
<p>In the latest Cilium 1.12 release, enabling support for BGP requires only setting the <code>--enable-bgp-control-plane=true</code> parameter and enables more granular and scalable configuration via a new CRD <code>CiliumBGPPeeringPolicy</code>.</p>
<ul>
<li>The same BGP configuration can be applied to multiple nodes by tag selection using the <code>nodeSelector</code> parameter.</li>
<li>When the <code>exportPodCIDR</code> parameter is set to true, all Pod CIDRs can be declared dynamically, eliminating the need to manually specify which route prefixes need to be declared.</li>
<li>The <code>neighbors</code> parameter is used to set BGP neighbor information, usually for network devices external to the cluster.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumBGPPeeringPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l">rack0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">virtualRouters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>- <span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="m">65010</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">neighbors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.1/32&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="m">65010</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="13-introduction-to-kind">1.3 Introduction to Kind</h3>
<p><strong>Kind [2]</strong> (Kubernetes in Docker) is a tool for running local Kubernetes clusters using Docker containers as Node nodes. We just need to install Docker and we can quickly create one or more Kubernetes clusters in a few minutes. For the sake of experimentation, this article uses Kind to build a Kubernetes cluster environment.</p>
<h3 id="14-introduction-to-containerlab">1.4 Introduction to Containerlab</h3>
<p><strong>Containerlab [3]</strong> provides a simple, lightweight, container-based solution for orchestrating network experiments, supporting a variety of containerized network operating systems such as Cisco, Juniper, Nokia, Arista, etc. Containerlab can start containers based on user-defined configuration files and create virtual connections to build user-defined network topologies.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sonic01</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">srl</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">srl</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">ghcr.io/nokia/srlinux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sonic</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">sonic-vs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker-sonic-vs:2020-11-12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">links</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;srl:e1-1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;sonic:eth1&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>The management interface of the container is connected to a Docker network of bridge type called clab, and the business interface is connected via links rules defined in the configuration file. This is similar to the out-of-band and in-band management models for network management in the data center.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/3a57c1dea13042f48c7cac285df32aa5.png" alt="Containerlab"></p>
<p>Containerlab also provides us with a rich set of experimental examples, which can be found in <strong>Lab examples[4]</strong>. We can even create a data center level network architecture with Containerlab (see <strong>5-stage Clos fabric[5]</strong> )</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/a65846dd59834fa8be4ad61a879ad7c9.png" alt="network architecture"></p>
<h2 id="2-prerequisite-preparation">2 Prerequisite preparation</h2>
<p>Please choose the appropriate installation method according to the corresponding operating system version:</p>
<ul>
<li>Install Docker: <a href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a></li>
<li>Install Containerlab: <a href="https://containerlab.dev/install/">https://containerlab.dev/install/</a></li>
<li>Install Kind: <a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installing-with-a-package-manager">https://kind.sigs.k8s.io/docs/user/quick-start/#installing-with-a-package-manager</a></li>
<li>Install Helm: <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></li>
</ul>
<p>The configuration files used in this article are available at <a href="https://github.com/cr7258/kubernetes-guide/tree/master/containerlab/cilium-bgp">https://github.com/cr7258/kubernetes-guide/tree/master/containerlab/cilium-bgp</a>.</p>
<h2 id="3-starting-a-kubernetes-cluster-with-kind">3 Starting a Kubernetes Cluster with Kind</h2>
<p>Prepare a Kind configuration file to create a 4-node Kubernetes cluster.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># cluster.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">clab-bgp-cplane-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kind.x-k8s.io/v1alpha4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">disableDefaultCNI</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.1.0.0/16&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    kind: InitConfiguration
</span></span></span><span class="line"><span class="cl"><span class="sd">    nodeRegistration:
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubeletExtraArgs:
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-ip: 10.0.1.2  
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-labels: &#34;rack=rack0&#34;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    kind: JoinConfiguration
</span></span></span><span class="line"><span class="cl"><span class="sd">    nodeRegistration:
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubeletExtraArgs:
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-ip: 10.0.2.2
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-labels: &#34;rack=rack0&#34;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    kind: JoinConfiguration
</span></span></span><span class="line"><span class="cl"><span class="sd">    nodeRegistration:
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubeletExtraArgs:
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-ip: 10.0.3.2
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-labels: &#34;rack=rack1&#34;</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l">worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubeadmConfigPatches</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    kind: JoinConfiguration
</span></span></span><span class="line"><span class="cl"><span class="sd">    nodeRegistration:
</span></span></span><span class="line"><span class="cl"><span class="sd">      kubeletExtraArgs:
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-ip: 10.0.4.2
</span></span></span><span class="line"><span class="cl"><span class="sd">        node-labels: &#34;rack=rack1&#34;</span><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command to create a Kubernetes cluster via Kind.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kind create cluster --config cluster.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/a1e87edc8600442f9345d828050f0bdc.png" alt="create cluster"></p>
<p>Checking the cluster node status, the status of the node is NotReady as we do not have the CNI plugin installed yet.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get node
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/a64ef3d140174f848d5088abe9f8a0e1.png" alt="kubectl get node"></p>
<h2 id="4-start-containerlab">4 Start Containerlab</h2>
<p>Define the Containerlab configuration file, create the network infrastructure and connect to the Kubernetes cluster created by Kind.</p>
<ul>
<li>router0, tor0, tor1 as network devices outside the Kubernetes cluster, set the network interface information and BGP configuration in the exec parameter. router0 establishes BGP neighbors with tor0, tor1, tor0 with server0, server1, router0, tor1 with server2, server3, router0.</li>
<li>Setting <code>network-mode: container:&lt;container-name&gt;</code> allows Containerlab to share the network namespace of containers started outside of Containerlab, setting server0, server1, server2, server3 containers to connect to the Kubernetes cluster created with Kind in subsection 3. in Section 3.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># topo.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">bgp-cplane-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">topology</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kinds</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">linux</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="l">bash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">router0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">frrouting/frr:v8.2.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">frr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.0.0/32 dev lo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip route add blackhole 10.0.0.0/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">touch /etc/frr/vtysh.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">sed -i -e &#39;s/bgpd=no/bgpd=yes/g&#39; /etc/frr/daemons</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">usr/lib/frr/frrinit.sh start</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">         vtysh -c &#39;conf t&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;router bgp 65000&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; bgp router-id 10.0.0.0&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; no bgp ebgp-requires-policy&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS peer-group&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS remote-as external&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS default-originate&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor net0 interface peer-group ROUTERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor net1 interface peer-group ROUTERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; address-family ipv4 unicast&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;   redistribute connected&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; exit-address-family&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;!&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">            
</span></span></span><span class="line"><span class="cl"><span class="sd">          </span><span class="w">         
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tor0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">frrouting/frr:v8.2.2  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">frr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip link del eth0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.0.1/32 dev lo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.1.1/24 dev net1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.2.1/24 dev net2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">touch /etc/frr/vtysh.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">sed -i -e &#39;s/bgpd=no/bgpd=yes/g&#39; /etc/frr/daemons</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/usr/lib/frr/frrinit.sh start</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">         vtysh -c &#39;conf t&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;frr defaults datacenter&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;router bgp 65010&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; bgp router-id 10.0.0.1&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; no bgp ebgp-requires-policy&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS peer-group&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS remote-as external&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor SERVERS peer-group&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor SERVERS remote-as internal&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor net0 interface peer-group ROUTERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor 10.0.1.2 peer-group SERVERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor 10.0.2.2 peer-group SERVERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; address-family ipv4 unicast&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;   redistribute connected&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;  exit-address-family&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;!&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">          </span><span class="w">         
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tor1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">frrouting/frr:v8.2.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">frr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip link del eth0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.0.2/32 dev lo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.3.1/24 dev net1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.4.1/24 dev net2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">touch /etc/frr/vtysh.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">sed -i -e &#39;s/bgpd=no/bgpd=yes/g&#39; /etc/frr/daemons</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/usr/lib/frr/frrinit.sh start</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">         vtysh -c &#39;conf t&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;frr defaults datacenter&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;router bgp 65011&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; bgp router-id 10.0.0.2&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; no bgp ebgp-requires-policy&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS peer-group&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor ROUTERS remote-as external&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor SERVERS peer-group&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor SERVERS remote-as internal&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor net0 interface peer-group ROUTERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor 10.0.3.2 peer-group SERVERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; neighbor 10.0.4.2 peer-group SERVERS&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39; address-family ipv4 unicast&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;   redistribute connected&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;  exit-address-family&#39;
</span></span></span><span class="line"><span class="cl"><span class="sd">         -c &#39;!&#39;      </span><span class="w">         
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nicolaka/netshoot:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network-mode</span><span class="p">:</span><span class="w"> </span><span class="l">container:control-plane</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.1.2/24 dev net0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip route replace default via 10.0.1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nicolaka/netshoot:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network-mode</span><span class="p">:</span><span class="w"> </span><span class="l">container:worker</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.2.2/24 dev net0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip route replace default via 10.0.2.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nicolaka/netshoot:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network-mode</span><span class="p">:</span><span class="w"> </span><span class="l">container:worker2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.3.2/24 dev net0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip route replace default via 10.0.3.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server3</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">linux</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nicolaka/netshoot:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">network-mode</span><span class="p">:</span><span class="w"> </span><span class="l">container:worker3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip addr add 10.0.4.2/24 dev net0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ip route replace default via 10.0.4.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">links</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;router0:net0&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;tor0:net0&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;router0:net1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;tor1:net0&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;tor0:net1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;server0:net0&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;tor0:net2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;server1:net0&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;tor1:net1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;server2:net0&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;tor1:net2&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;server3:net0&#34;</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command to create the Containerlab experimental environment.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">clab deploy -t topo.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/520d8a12ae4a4bb9946290286d1a701b.png" alt="clab deploy"></p>
<p>The created topology is shown below. Currently, only the BGP connections between tor0, tor1 and router0 devices have been established. The BGP connections between tor0, tor1 and Kubernetes Nodes have not yet been established because we have not yet set the BGP configuration of the Kubernetes cluster via CiliumBGPPeeringPolicy.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/884624529f6949c2815254f484c85cc1.png" alt="Kubernetes "></p>
<p>Execute the following commands separately to view the current BGP neighbor establishment status of tor0, tor1, router0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-tor0 vtysh -c <span class="s2">&#34;show bgp ipv4 summary wide&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-tor1 vtysh -c <span class="s2">&#34;show bgp ipv4 summary wide&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-router0 vtysh -c <span class="s2">&#34;show bgp ipv4 summary wide&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/c0347ca2c59d4caca0a90260a7e543fc.png" alt="docker exec"></p>
<p>Execute the following command to view the BGP routing entries now learned by the router0 device.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-router0 vtysh -c <span class="s2">&#34;show bgp ipv4 wide&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are currently a total of 8 route entries, and no Pod-related routes have been learned at this point.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/9cfefa470ac447528c9b54e6e07b4d27.png" alt="Pod "></p>
<p>To make it easier for users to visualize the network structure of the experiment, Containerlab provides the <code>graph</code> command to generate the network topology.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">clab graph -t topo.yaml 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/252c0f96456c487a9797ff9288fe476e.png" alt="clab graph"></p>
<p>Enter <code>http://&lt;host IP&gt;:50080</code> in your browser to view the Containerlab-generated topology diagram.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/09533be4313c4b28aa811d8832b47e46.png" alt="topology diagram"></p>
<p>In this example, we use Helm to install Cilium and set the Cilium configuration parameters we need to adjust in the values.yaml configuration file.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># values.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tunnel</span><span class="p">:</span><span class="w"> </span><span class="l">disabled</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ipam</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ipv4NativeRoutingCIDR</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.0</span><span class="l">/8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Enabling BGP feature support is equivalent to executing --enable-bgp-control-plane=true on the command line</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">bgpControlPlane</span><span class="p">:</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">k8s</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">requireIPv4PodCIDR</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command to install Cilium version 1.12 and enable BGP feature support.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">helm repo add cilium https://helm.cilium.io/
</span></span><span class="line"><span class="cl">helm install -n kube-system cilium cilium/cilium --version v1.12.1 -f values.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once all the Cilium Pods are started, check the Kubernetes Node status again and see that all the Nodes are in Ready state.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/4a031084a9a048cfa67ec3be0e5bd8be.png" alt="Kubernetes Node status"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/949b52a31a8a42aea7e67e07dd1828ef.png" alt="Kubernetes Node status"></p>
<h2 id="6-configuring-bgp-on-cilium-nodes">6 Configuring BGP on Cilium Nodes</h2>
<p>Next, configure the CiliumBGPPeeringPolicy for the Kubernetes Nodes on rack0 and rack1 respectively. rack0 and rack1 correspond to the labels of the Nodes, which were set in the configuration file of Kind in Subsection 3.</p>
<p>The Node on rack0 establishes a BGP neighbor with tor0, and the Node on rack1 establishes a BGP neighbor with tor1 and automatically declares a Pod CIDR to the BGP neighbor.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># cilium-bgp-peering-policies.yaml </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumBGPPeeringPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l">rack0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">virtualRouters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="m">65010</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># Automatically declare Pod CIDR</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">neighbors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.1/32&#34;</span><span class="w"> </span><span class="c"># IP address of tor0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="m">65010</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumBGPPeeringPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">virtualRouters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">localASN</span><span class="p">:</span><span class="w"> </span><span class="m">65011</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">exportPodCIDR</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">neighbors</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">peerAddress</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.2/32&#34;</span><span class="w"> </span><span class="c"># IP address of tor1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">peerASN</span><span class="p">:</span><span class="w"> </span><span class="m">65011</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command to apply the CiliumBGPPeeringPolicy.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f cilium-bgp-peering-policies.yaml 
</span></span></code></pre></td></tr></table>
</div>
</div><p>The created topology is shown below. tor0 and tor1 have now also established BGP neighbors with the Kubernetes Node.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/18b8c4e60784434cacab3ff7b05c554f.png" alt="topology"></p>
<p>Execute the following commands separately to view the current BGP neighbor establishment status of tor0, tor1, router0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-tor0 vtysh -c <span class="s2">&#34;show bgp ipv4 summary wide&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-tor1 vtysh -c <span class="s2">&#34;show bgp ipv4 summary wide&#34;</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-router0 vtysh -c <span class="s2">&#34;show bgp ipv4 summary wide&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/909e0a5494b54eea89d29f40ef77a5d2.png" alt="current BGP neighbor establishment status"></p>
<p>Execute the following command to view the BGP routing entries now learned by the router0 device.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">docker <span class="nb">exec</span> -it clab-bgp-cplane-demo-router0 vtysh -c <span class="s2">&#34;show bgp ipv4 wide&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are currently a total of 12 route entries, of which 4 extra routes are learned from the 4 Kubernetes Nodes on the 10.1.x.0/24 network segment.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/71d60fd5d510437ab710d07444639837.png" alt="Kubernetes Nodes"></p>
<h2 id="7-verification">7 Verification</h2>
<p>Create 1 Pod on the node where rack0 and rack1 are located to test the connectivity of the network.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># nettool.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nettool-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nettool-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">cr7258/nettool:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nettool-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l">rack0 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">nettool-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nettool-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">cr7258/nettool:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nettool-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rack</span><span class="p">:</span><span class="w"> </span><span class="l">rack1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Execute the following command to create 2 test Pods.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl apply -f nettool.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>View the IP address of the Pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl get pod -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><p>The nettool-1 Pod is located on clab-bgp-cplane-demo-worker (server1, rack0) with IP address 10.1.2.185; the nettool-2 Pod is located on clab-bgp-cplane-demo-worker3 (server3, rack1 ) with an IP address of 10.1.3.56.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/df589fd216f845d5825508d7a61c4ce0.png" alt="pod"></p>
<p>Execute the following command to try pinging nettool-2 Pod in the nettool-1 Pod.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it nettool-1 -- ping 10.1.3.56 
</span></span></code></pre></td></tr></table>
</div>
</div><p>You can see that the nettool-1 Pod can access the nettool-2 Pod normally.</p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/1f579c78c45e4a57842710d72cd47642.png" alt="nettool-1 Pod can access the nettool-2 Pod normally"></p>
<p>Next, use the traceroute command to observe the direction of the network packets.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it nettool-1 -- traceroute -n 10.1.3.56
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/87d61ab584f5487ba2c9aba6dc665f3c.png" alt="kubectl"></p>
<p>The packets are sent from the nettool-1 Pod and go through the following in order.</p>
<ol>
<li>
<p><strong>server1&rsquo;s cilium_host interface</strong>: the default route for Pods in the Cilium network points to the local cilium_host. cilium_host and cilium_net are a pair of veth pair devices. cilium forces the Pod traffic&rsquo;s Cilium uses the hardcode ARP table to force the next hop of Pod traffic to be hijacked to the host side of the veth pair.
<img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/1b631b9530984d1ea2c4e6df60d74ccc.png" alt="server1&amp;rsquo;s cilium_host interface"></p>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/e3be4c4dcb8044cbbcc97717d86bb932.png" alt="server1&amp;rsquo;s cilium_host interface"></p>
</li>
<li>
<p><strong>tor0&rsquo;s net2 interface</strong>.</p>
</li>
<li>
<p><strong>router0&rsquo;s lo0 interface</strong>: tor0, tor1 and router0 establish BGP neighbors through the local loopback port lo0, which improves the robustness of BGP neighbors when there are multiple physical link backups, and does not affect the neighbor relationship when a physical interface fails.</p>
</li>
<li>
<p><strong>tor1&rsquo;s lo0 interface</strong>.</p>
</li>
<li>
<p><strong>server3&rsquo;s net0 interface</strong>.</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/b0xt/sobyte-images1/2022/09/02/5ae4d2b17f0740d1be5d45c5721fcd7e.png" alt="network"></p>
<h3 id="8-clean-up-the-environment">8 Clean up the environment</h3>
<p>Execute the following command to clean up the experimental environment created by Containerlab and Kind.</p>
<h3 id="9-references">9 References</h3>
<ul>
<li>[0] <code>https://mp.weixin.qq.com/s?__biz=MzkxOTIwMDgxMg==&amp;mid=2247486133&amp;idx=1&amp;sn=ae1dddc04ac194ff34f6eab670e72edb</code></li>
<li>[1] <code>GoBGP: https://osrg.github.io/gobgp/</code></li>
<li>[2] <code>Kind: https://kind.sigs.k8s.io/</code></li>
<li>[3] <code>containerlab: https://containerlab.dev/</code></li>
<li>[4] <code>Lab examples: https://containerlab.dev/lab-examples/lab-examples/</code></li>
<li>[5] <code>5-stage Clos fabric: https://containerlab.dev/lab-examples/min-5clos/</code></li>
<li>[6] <code>BGP WITH CILIUM: https://nicovibert.com/2022/07/21/bgp-with-cilium/</code></li>
<li>[7] <code>https://www.bilibili.com/video/BV1Qa411d7wm?spm_id_from=333.337.search-card.all.click&amp;vd_source=1c0f4059dae237b29416579c3a5d326e</code></li>
<li>[8] <code>https://www.koenli.com/fcdddb4a.html</code></li>
<li>[9] <code>Cilium BGP Control Plane: https://docs.cilium.io/en/stable/gettingstarted/bgp-control-plane/#cilium-bgp-control-plane</code></li>
<li>[10] <code>Cilium 1.12 - Ingress, Multi-Cluster, Service Mesh, External Workloads, and much more: https://isovalent.com/blog/post/cilium-release-112/#vtep-support</code></li>
<li>[11] <code>Cilium 1.10: WireGuard, BGP Support, Egress IP Gateway, New Cilium CLI, XDP Load Balancer, Alibaba Cloud Integration and more: https://cilium.io/blog/2021/05/20/cilium-110/</code></li>
<li>[12] <code>https://arthurchiao.art/blog/cilium-life-of-a-packet-pod-to-service-zh/</code></li>
</ul>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/2022-09/docker-flat-container-networks/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Building flat container networks in Docker</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2022-09/k8s-container/">
            <span class="next-text nav-default">Kubernetes - Container Orchestration Engine (Resource Management)</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.sobyte.net/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2021 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
